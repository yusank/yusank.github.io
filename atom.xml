<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="zh-CN"><title type="text">Yusank`s Site</title><subtitle type="html">åˆ†äº«æŠ€æœ¯æ–‡ç« å’Œä¸ªäººåšå®¢ã€‚</subtitle><updated>2021-09-18T06:24:57+00:00</updated><id>https://yusank.github.io/</id><link rel="alternate" type="text/html" href="https://yusank.github.io/"/><link rel="self" type="application/atom+xml" href="https://yusank.github.io/atom.xml"/><author><name>yusank</name><uri>https://yusank.github.io/</uri><email>yusankurban@gmail.com</email></author><generator uri="https://gohugo.io/" version="0.88.1">Hugo</generator><entry><title type="text">nginx ä¸­ä½¿ç”¨ lua åŠ¨æ€åŠ è½½æœåŠ¡é…ç½®</title><link rel="alternate" type="text/html" href="https://yusank.github.io/posts/nginx-lua-plugins/"/><id>https://yusank.github.io/posts/nginx-lua-plugins/</id><updated>2021-09-18T06:24:55+00:00</updated><published>2021-09-17T12:22:33+08:00</published><author><name>yusank</name><uri>https://yusank.github.io/</uri><email>yusankurban@gmail.com</email></author><summary type="html">æœ¬æ–‡ç®€å•ä»‹ç»å¦‚ä½•é€šè¿‡ lua è„šæœ¬å’Œ ngx_shared_dict åœ¨ nginx ä¸­åŠ¨æ€åŠ è½½åç«¯æœåŠ¡é…ç½®ä»¥åŠåŠ¨æ€æ›´æ–°æœåŠ¡é…ç½®. nginxâ€¦â€¦</summary><content type="html">&lt;blockquote>
&lt;p>æœ¬æ–‡ç®€å•ä»‹ç»å¦‚ä½•é€šè¿‡ lua è„šæœ¬å’Œ ngx_shared_dict åœ¨ nginx ä¸­åŠ¨æ€åŠ è½½åç«¯æœåŠ¡é…ç½®ä»¥åŠåŠ¨æ€æ›´æ–°æœåŠ¡é…ç½®.&lt;/p>
&lt;/blockquote>
&lt;h2 id="nginx">nginx&lt;/h2>
&lt;h3 id="åŠ è½½-lua-è„šæœ¬">åŠ è½½ lua è„šæœ¬&lt;/h3>
&lt;p>åœ¨ Nginx ä¸­éœ€è¦å¼•å…¥å’ŒåŠ è½½ lua è„šæœ¬ï¼Œä»è€Œåœ¨è·¯ç”±è½¬å‘æ—¶è¿è¡Œ lua è„šæœ¬è¿›è¡Œæˆ‘ä»¬çš„é€»è¾‘ã€‚åˆå§‹åŒ–ä»£ç å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">http {
lua_shared_dict endpoints_data 5m; #å®šä¹‰upstreamå…±äº«å†…å­˜ç©ºé—´
lua_shared_dict cache 1m; #å®šä¹‰è®¡æ•°å…±äº«ç©ºé—´
access_log nginx_access.log;
lua_package_path &amp;#34;/etc/nginx/lua/?.lua;;&amp;#34;;
init_by_lua_block {
collectgarbage(&amp;#34;collect&amp;#34;)
local ok, res
# åŠ è½½è„šæœ¬ configuration.lua
ok, res = pcall(require, &amp;#34;configuration&amp;#34;)
if not ok then
error(&amp;#34;require failed: &amp;#34; .. tostring(res))
else
configuration = res
end
}
# æ‰§è¡Œè„šæœ¬å†…åˆå§‹åŒ–æ–¹æ³•ï¼Œè¿™é‡Œä¸ºå¯é€‰é¡¹ï¼Œå¦‚æœæ²¡æœ‰å¯åˆå§‹åŒ–çš„ä»£ç éƒ¨åˆ† è¿™é‡Œå¯ä»¥ä¸è¦
init_worker_by_lua_block {
configuration.prepare()
}
}
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="æ‰§è¡Œ-lua-è„šæœ¬">æ‰§è¡Œ lua è„šæœ¬&lt;/h3>
&lt;p>å¦‚ä½•åœ¨ Nginx é…ç½®ä¸­æ‰§è¡Œ lua è„šæœ¬ï¼Œä»è€Œå®ç°ä¸€äº›ç‰¹æ®Šé€»è¾‘ï¼Ÿè¿™é‡Œç»™å‡ºä¸€ä¸ªç®€å•çš„ç¤ºä¾‹:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">server {
# æ‰§è¡Œæœ€ç®€å•çš„ lua è„šæœ¬
location /hello {
default_type &amp;#39;text/plain&amp;#39;;
content_by_lua &amp;#39;ngx.say(&amp;#34;hello, lua&amp;#34;)&amp;#39;;
}
# é…ç½®æ¥å£
# è¿™é‡Œæ˜¯æ‰§è¡ŒåŠ è½½çš„ lua è„šæœ¬ä¸­æ–¹æ³•
location /configuration {
client_max_body_size 5m;
client_body_buffer_size 1m;
proxy_buffering off;
content_by_lua_block {
configuration.call() # è°ƒç”¨ call() æ–¹æ³•
}
}
# æ‰§è¡Œè¾ƒä¸ºå¤æ‚çš„ lua é€»è¾‘
location /lua {
default_type &amp;#39;text/plain&amp;#39;;
# è¯»å–è¯·æ±‚ä¸­çš„ path å‚æ•° å¹¶ä»å…±äº« dict ä¸­æŸ¥è¯¢è¿™ä¸ªå€¼ï¼Œ
# è¿”å›æŸ¥è¯¢åˆ°çš„ç»“æœ
content_by_lua &amp;#39;
local path = ngx.req.get_uri_args()[&amp;#34;path&amp;#34;]
if path == nil then
ngx.say(&amp;#34;path not found&amp;#34;)
return
end
local data = ngx.shared.endpoints_data:get(&amp;#34;/&amp;#34;..path)
if not data then
ngx.say(&amp;#34;unkonw path&amp;#34;)
return
end
ngx.say(&amp;#34;paths: &amp;#34;..data)
&amp;#39;;
}
}
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>lua&lt;/code> çš„è¯­æ³•ç›¸å¯¹ç®€å•å¥½ä¸Šæ‰‹ï¼Œå®ç°ä¸€äº›ç®€å•çš„é€»è¾‘ä¹Ÿå¾ˆæ–¹ä¾¿ï¼Œéå¸¸å€¼å¾—å­¦ä¹ ã€‚&lt;/p>
&lt;h3 id="å®Œæ•´é…ç½®">å®Œæ•´é…ç½®&lt;/h3>
&lt;p>å…ˆç»™å‡º Nginx çš„å®Œæ•´é…ç½®ï¼Œé‡Œé¢åŒ…æ‹¬åŠ¨æ€é…ç½®åç«¯æœåŠ¡åˆ—è¡¨å’ŒåŠ¨æ€åŠ è½½æœåŠ¡è½¬å‘çš„é€»è¾‘ï¼Œç„¶åå†ç»™å‡º lua éƒ¨åˆ†è¯¦ç»†å®ç°çš„ä»£ç ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;span class="lnt">70
&lt;/span>&lt;span class="lnt">71
&lt;/span>&lt;span class="lnt">72
&lt;/span>&lt;span class="lnt">73
&lt;/span>&lt;span class="lnt">74
&lt;/span>&lt;span class="lnt">75
&lt;/span>&lt;span class="lnt">76
&lt;/span>&lt;span class="lnt">77
&lt;/span>&lt;span class="lnt">78
&lt;/span>&lt;span class="lnt">79
&lt;/span>&lt;span class="lnt">80
&lt;/span>&lt;span class="lnt">81
&lt;/span>&lt;span class="lnt">82
&lt;/span>&lt;span class="lnt">83
&lt;/span>&lt;span class="lnt">84
&lt;/span>&lt;span class="lnt">85
&lt;/span>&lt;span class="lnt">86
&lt;/span>&lt;span class="lnt">87
&lt;/span>&lt;span class="lnt">88
&lt;/span>&lt;span class="lnt">89
&lt;/span>&lt;span class="lnt">90
&lt;/span>&lt;span class="lnt">91
&lt;/span>&lt;span class="lnt">92
&lt;/span>&lt;span class="lnt">93
&lt;/span>&lt;span class="lnt">94
&lt;/span>&lt;span class="lnt">95
&lt;/span>&lt;span class="lnt">96
&lt;/span>&lt;span class="lnt">97
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">user nginx;
worker_processes 1;
pid /var/run/nginx.pid;
error_log nginx_error.log;
events {
worker_connections 1024;
}
http {
lua_shared_dict endpoints_data 5m; #å®šä¹‰upstreamå…±äº«å†…å­˜ç©ºé—´
lua_shared_dict cache 1m; #å®šä¹‰è®¡æ•°å…±äº«ç©ºé—´
access_log nginx_access.log;
lua_package_path &amp;#34;/etc/nginx/lua/?.lua;;&amp;#34;;
init_by_lua_block {
collectgarbage(&amp;#34;collect&amp;#34;)
local ok, res
ok, res = pcall(require, &amp;#34;configuration&amp;#34;)
if not ok then
error(&amp;#34;require failed: &amp;#34; .. tostring(res))
else
configuration = res
end
}
# æ‰§è¡Œè„šæœ¬å†…åˆå§‹åŒ–æ–¹æ³•ï¼Œè¿™é‡Œä¸ºå¯é€‰é¡¹ï¼Œå¦‚æœæ²¡æœ‰å¯åˆå§‹åŒ–çš„ä»£ç éƒ¨åˆ† è¿™é‡Œå¯ä»¥ä¸è¦
init_worker_by_lua_block {
configuration.prepare()
}
include /etc/nginx/mime.types;
default_type application/octet-stream;
sendfile on;
#tcp_nopush on;
keepalive_timeout 65;
#gzip on;
server {
# æ‰§è¡Œæœ€ç®€å•çš„ lua è„šæœ¬
location /hello {
default_type &amp;#39;text/plain&amp;#39;;
content_by_lua &amp;#39;ngx.say(&amp;#34;hello, lua&amp;#34;)&amp;#39;;
}
# é…ç½®æ¥å£
# è¿™é‡Œæ˜¯æ‰§è¡ŒåŠ è½½çš„ lua è„šæœ¬ä¸­æ–¹æ³•
location /configuration {
client_max_body_size 5m;
client_body_buffer_size 1m;
proxy_buffering off;
content_by_lua_block {
configuration.call() # è°ƒç”¨ call() æ–¹æ³•
}
}
# æ‰§è¡Œè¾ƒä¸ºå¤æ‚çš„ lua é€»è¾‘
location /lua {
default_type &amp;#39;text/plain&amp;#39;;
# è¯»å–è¯·æ±‚ä¸­çš„ path å‚æ•° å¹¶ä»å…±äº« dict ä¸­æŸ¥è¯¢è¿™ä¸ªå€¼ï¼Œ
# è¿”å›æŸ¥è¯¢åˆ°çš„ç»“æœ
content_by_lua &amp;#39;
local path = ngx.req.get_uri_args()[&amp;#34;path&amp;#34;]
if path == nil then
ngx.say(&amp;#34;path not found&amp;#34;)
return
end
local data = ngx.shared.endpoints_data:get(&amp;#34;/&amp;#34;..path)
if not data then
ngx.say(&amp;#34;unkonw path&amp;#34;)
return
end
ngx.say(&amp;#34;paths: &amp;#34;..data)
&amp;#39;;
}
# other path
location / {
set $load_ups &amp;#34;&amp;#34;;
# åŠ¨æ€è®¾ç½®å½“å‰ upstream, æœªæ‰¾åˆ°è¿”å›404
rewrite_by_lua &amp;#39;
local ups = configuration.getEndpoints()
if ups ~= nil then
ngx.log(ngx.ERR,&amp;#34;got upstream&amp;#34;, ups)
ngx.var.load_ups = ups
return
end
ngx.status = ngx.HTTP_NOT_FOUND
ngx.exit(ngx.status)
&amp;#39;;
proxy_pass http://$load_ups$uri;
add_header X-Upstream $upstream_addr always; # æ·»åŠ  backend ip
}
}
}
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="lua">lua&lt;/h2>
&lt;h3 id="å®šä¹‰å˜é‡">å®šä¹‰å˜é‡&lt;/h3>
&lt;p>å› ä¸ºéœ€è¦ç”¨åˆ° shared_dict ç‰¹æ€§ï¼Œåœ¨ lua å’Œ Nginx ä¹‹é—´å…¬ç”¨å†…å­˜å— ä»è€Œå®ç°æ•°æ®çš„åŒæ­¥å…±äº«ï¼Œæ‰€ä»¥éœ€è¦é¢„å®šä¹‰ä¸€äº›å˜é‡ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="c1">-- å¼•å…¥å˜é‡&lt;/span>
&lt;span class="kd">local&lt;/span> &lt;span class="n">io&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">io&lt;/span>
&lt;span class="kd">local&lt;/span> &lt;span class="n">ngx&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ngx&lt;/span>
&lt;span class="kd">local&lt;/span> &lt;span class="n">table&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">table&lt;/span>
&lt;span class="c1">-- å½“å‰åŒ…çš„å¯¹è±¡ï¼Œç±»ä¼¼ go è¯­è¨€çš„å®šä¹‰ç»“æ„ä½“ è®©ç»™è¿™ä¸ªç»“æ„ä½“å®ç°æ–¹æ³•&lt;/span>
&lt;span class="kd">local&lt;/span> &lt;span class="n">_M&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;span class="c1">-- ä¸ Nginx å…±äº«çš„ç©ºé—´ å¯è¯»å†™&lt;/span>
&lt;span class="kd">local&lt;/span> &lt;span class="n">Endpoints&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ngx.shared&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">endpoints_data&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="åŠ¨æ€æ›´æ–°æœåŠ¡åˆ—è¡¨">åŠ¨æ€æ›´æ–°æœåŠ¡åˆ—è¡¨&lt;/h3>
&lt;p>æœåŠ¡åˆ—è¡¨æ˜¯é€šè¿‡è¢«è°ƒæ¥å£å®ç°ï¼Œå³æœ‰åˆ«çš„æœåŠ¡åŒºç›‘å¬æœåŠ¡èŠ‚ç‚¹(endpoint)çš„å˜åŒ–,ç„¶åè°ƒç”¨&lt;code>/configuration/backends&lt;/code> æ¥å£ï¼Œè¢« Nginx é…ç½®çš„ &lt;code>/configuration&lt;/code> è§„åˆ™å‘½ä¸­åè°ƒç”¨ &lt;code>configuration.call()&lt;/code> æ–¹æ³•ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™ä¸ª &lt;code>call&lt;/code> æ–¹æ³•çš„å®ç°ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="c1">-- call called by ngx&lt;/span>
&lt;span class="kr">function&lt;/span> &lt;span class="nc">_M&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">call&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="c1">-- åªå¤„ç† GET å’Œ POST&lt;/span>
&lt;span class="kr">if&lt;/span> &lt;span class="n">ngx.var&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">request_method&lt;/span> &lt;span class="o">~=&lt;/span> &lt;span class="s2">&amp;#34;POST&amp;#34;&lt;/span> &lt;span class="ow">and&lt;/span> &lt;span class="n">ngx.var&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">request_method&lt;/span> &lt;span class="o">~=&lt;/span> &lt;span class="s2">&amp;#34;GET&amp;#34;&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;span class="n">ngx.status&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ngx.HTTP_BAD_REQUEST&lt;/span>
&lt;span class="n">ngx.print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Only POST and GET requests are allowed!&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="kr">return&lt;/span>
&lt;span class="kr">end&lt;/span>
&lt;span class="c1">-- ç›®å‰åªå¤„ç†åç«¯æœåŠ¡çš„é…ç½® æ‰€ä»¥åˆ¤æ–­è·¯ç”±&lt;/span>
&lt;span class="kr">if&lt;/span> &lt;span class="n">ngx.var&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">request_uri&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;/configuration/backends&amp;#34;&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;span class="c1">-- è°ƒç”¨å†…éƒ¨æ–¹æ³•&lt;/span>
&lt;span class="n">handle_backends&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="kr">return&lt;/span>
&lt;span class="kr">end&lt;/span>
&lt;span class="c1">-- éæ³•è¯·æ±‚ è¿”å› 404&lt;/span>
&lt;span class="n">ngx.status&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ngx.HTTP_NOT_FOUND&lt;/span>
&lt;span class="n">ngx.print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Not found!&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="kr">end&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¤šè¯´ä¸€å¥ï¼Œè°ƒç”¨ &lt;code>/configuration/backends&lt;/code> æ—¶ä¼ å‚æ˜¯åœ¨è¯·æ±‚ body é‡Œï¼Œæ ¼å¼ä¸º &lt;code>json&lt;/code> æ‰€ä»¥éœ€è¦å¼•å…¥ç¬¬ä¸‰æ–¹çš„ json è§£æåŒ…ã€‚&lt;code>handle_backends&lt;/code> æ–¹æ³•çš„å®ç°ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="c1">-- handle_backends .&lt;/span>
&lt;span class="kd">local&lt;/span> &lt;span class="kr">function&lt;/span> &lt;span class="nf">handle_backends&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="kr">if&lt;/span> &lt;span class="n">ngx.var&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">request_method&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;GET&amp;#34;&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;span class="n">ngx.status&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ngx.HTTP_OK&lt;/span>
&lt;span class="c1">-- è¿”å›æŸ¥è¯¢çš„æœåŠ¡åˆ—è¡¨&lt;/span>
&lt;span class="kd">local&lt;/span> &lt;span class="n">path&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ngx.req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">get_uri_args&lt;/span>&lt;span class="p">()[&lt;/span>&lt;span class="s2">&amp;#34;path&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="n">ngx.print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Endpoints&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;path&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="kr">return&lt;/span>
&lt;span class="kr">end&lt;/span>
&lt;span class="c1">-- è¯»å–è¯·æ±‚ body&lt;/span>
&lt;span class="kd">local&lt;/span> &lt;span class="n">obj&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">fetch_request_body&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="kr">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">obj&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;span class="n">ngx.log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ngx.ERR&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;dynamic-configuration: unable to read valid request body&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">ngx.status&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ngx.HTTP_BAD_REQUEST&lt;/span>
&lt;span class="kr">return&lt;/span>
&lt;span class="kr">end&lt;/span>
&lt;span class="c1">-- é€šè¿‡ ç¬¬ä¸‰æ–¹åŒ… json è§£æ bodyåˆ° lua table&lt;/span>
&lt;span class="kd">local&lt;/span> &lt;span class="n">rule&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">err&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">json.decode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">obj&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="kr">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">rule&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;span class="n">ngx.log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ngx.ERR&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;could not parse backends data: &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="kr">return&lt;/span>
&lt;span class="kr">end&lt;/span>
&lt;span class="n">ngx.log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ngx.ERR&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;decoed rule&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">obj&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">-- æ¸…ç©ºå…±äº«ç©ºé—´&lt;/span>
&lt;span class="n">Endpoints&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">flush_all&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="c1">-- éå†å¹¶å†™å…¥&lt;/span>
&lt;span class="kr">for&lt;/span> &lt;span class="n">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">new_rule&lt;/span> &lt;span class="kr">in&lt;/span> &lt;span class="n">ipairs&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">rule.rules&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kr">do&lt;/span>
&lt;span class="c1">-- æ›´æ–°&lt;/span>
&lt;span class="c1">-- å°†æ•°ç»„åˆå¹¶&lt;/span>
&lt;span class="kd">local&lt;/span> &lt;span class="n">succ&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">err1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">forcible&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Endpoints&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">new_rule.path&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">table.concat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">new_rule.upstreams&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="n">ngx.log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ngx.ERR&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;set result&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">succ&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">err1&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">forcible&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="kr">end&lt;/span>
&lt;span class="n">ngx.status&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ngx.HTTP_CREATED&lt;/span>
&lt;span class="n">ngx.say&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;ok&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="kr">end&lt;/span>
&lt;span class="c1">-- è¯»å–è¯·æ±‚ body éƒ¨åˆ†&lt;/span>
&lt;span class="kd">local&lt;/span> &lt;span class="kr">function&lt;/span> &lt;span class="nf">fetch_request_body&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="n">ngx.req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">read_body&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="kd">local&lt;/span> &lt;span class="n">body&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ngx.req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">get_body_data&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="kr">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">body&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;span class="c1">-- request body might&amp;#39;ve been written to tmp file if body &amp;gt; client_body_buffer_size&lt;/span>
&lt;span class="kd">local&lt;/span> &lt;span class="n">file_name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ngx.req&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">get_body_file&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="kd">local&lt;/span> &lt;span class="n">file&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">io.open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">file_name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;rb&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="kr">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">file&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;span class="kr">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="kr">end&lt;/span>
&lt;span class="n">body&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">file&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">read&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;*all&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">file&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="kr">end&lt;/span>
&lt;span class="kr">return&lt;/span> &lt;span class="n">body&lt;/span>
&lt;span class="kr">end&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¯·æ±‚ body çš„ json ç»“æ„å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">NginxRuleConf&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">Rules&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kd">struct&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">Path&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="s">`json:&amp;#34;path&amp;#34;`&lt;/span>
&lt;span class="nx">ServiceName&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="s">`json:&amp;#34;serviceName&amp;#34;`&lt;/span>
&lt;span class="nx">Port&lt;/span> &lt;span class="kt">int32&lt;/span> &lt;span class="s">`json:&amp;#34;-&amp;#34;`&lt;/span>
&lt;span class="nx">Upstreams&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span> &lt;span class="s">`json:&amp;#34;upstreams&amp;#34;`&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="s">`json:&amp;#34;rules&amp;#34;`&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="åŠ¨æ€è¯»å–åç«¯æœåŠ¡">åŠ¨æ€è¯»å–åç«¯æœåŠ¡&lt;/h3>
&lt;p>ä¸Šé¢å·²ç»é€šè¿‡æ¥å£çš„æ–¹å¼åŠ¨æ€æ›´æ–°æœåŠ¡èŠ‚ç‚¹åˆ—è¡¨å¹¶å†™å…¥åˆ°å…±äº«ç©ºé—´ &lt;code>endpoints_data&lt;/code> å†…ï¼Œæˆ‘ä»¬ç°åœ¨å®ç°è¯»å–æœåŠ¡åˆ—è¡¨å¹¶é€‰æ‹©å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹è¿›è¡Œæ¥å£è½¬å‘ã€‚&lt;/p>
&lt;p>ä»£ç å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-lua" data-lang="lua">&lt;span class="c1">-- è½®é¡ºçš„æ–¹å¼å–èŠ‚ç‚¹&lt;/span>
&lt;span class="kr">function&lt;/span> &lt;span class="nc">_M&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">getEndpoints&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="kd">local&lt;/span> &lt;span class="n">cache&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ngx.shared&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">cache&lt;/span>
&lt;span class="kd">local&lt;/span> &lt;span class="n">path&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ngx.var&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">request_uri&lt;/span>
&lt;span class="kd">local&lt;/span> &lt;span class="n">eps&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Endpoints&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="kr">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">eps&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;span class="kr">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="kr">end&lt;/span>
&lt;span class="kd">local&lt;/span> &lt;span class="n">tab&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">split&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">eps&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;,&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="kd">local&lt;/span> &lt;span class="n">index&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">cache&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="kr">if&lt;/span> &lt;span class="n">index&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="ow">or&lt;/span> &lt;span class="n">index&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="o">#&lt;/span>&lt;span class="n">tab&lt;/span> &lt;span class="kr">then&lt;/span>
&lt;span class="n">index&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;span class="kr">end&lt;/span>
&lt;span class="c1">-- åŠ ä¸€&lt;/span>
&lt;span class="n">cache&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">index&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="kr">return&lt;/span> &lt;span class="n">tab&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">index&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="kr">end&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="ç»“è®º">ç»“è®º&lt;/h2>
&lt;p>è‡³æ­¤å®ç°çš„æ•ˆæœæ˜¯ï¼Œå¯ä»¥åŠ¨æ€é…ç½®å¤šä¸ªåç«¯æœåŠ¡å’Œåç«¯æœåŠ¡èŠ‚ç‚¹åˆ—è¡¨ï¼Œå¤–éƒ¨æœåŠ¡è¯·æ±‚ Nginx æ—¶ï¼Œä¼šå°è¯•ä»å·²æœ‰çš„æœåŠ¡ä¸­åŒ¹é…è½¬å‘ï¼Œå¦‚æœæœåŠ¡æœ‰å¤šä¸ªèŠ‚ç‚¹åˆ™è½®é¡ºçš„æ–¹æ³•å»è½¬å‘ã€‚å¦‚æœ‰æœåŠ¡ä¿¡æ¯å‘ç”Ÿå˜åŒ–ï¼Œåˆ™é€šè¿‡è°ƒç”¨ Nginx ä¸­é…ç½®çš„ &lt;code>configuration&lt;/code> æ¥å£æ›´æ–°å³å¯ï¼Œæ— éœ€ä¿®æ”¹ Nginx é…ç½®ã€‚&lt;/p></content><category scheme="https://yusank.github.io/categories/%E6%8A%80%E6%9C%AF/" term="æŠ€æœ¯" label="æŠ€æœ¯"/><category scheme="https://yusank.github.io/tags/nginx/" term="nginx" label="nginx"/><category scheme="https://yusank.github.io/tags/lua/" term="lua" label="lua"/></entry><entry><title type="text">éƒ¨ç½²å•æœº k8s é›†ç¾¤</title><link rel="alternate" type="text/html" href="https://yusank.github.io/posts/deploy-k8s-cluster/"/><id>https://yusank.github.io/posts/deploy-k8s-cluster/</id><updated>2021-09-18T06:24:55+00:00</updated><published>2021-09-07T12:22:33+08:00</published><author><name>yusank</name><uri>https://yusank.github.io/</uri><email>yusankurban@gmail.com</email></author><summary type="html">æœ¬æ–‡ä»‹ç»æœ¬åœ°æˆ–æœåŠ¡å™¨ä¸Šæ­å»ºå•èŠ‚ç‚¹çš„ k8s é›†ç¾¤å’Œ webUI ä»¥åŠå¯ç”¨ingressï¼Œå¯ä»¥ç”¨ä½œå¼€å‘â€¦â€¦</summary><content type="html">&lt;p>æœ¬æ–‡ä»‹ç»æœ¬åœ°æˆ–æœåŠ¡å™¨ä¸Šæ­å»ºå•èŠ‚ç‚¹çš„ k8s é›†ç¾¤å’Œ webUI ä»¥åŠå¯ç”¨ingressï¼Œå¯ä»¥ç”¨ä½œå¼€å‘å’Œæµ‹è¯•ç¯å¢ƒã€‚&lt;/p>
&lt;h2 id="å‡†å¤‡å·¥ä½œ">å‡†å¤‡å·¥ä½œ&lt;/h2>
&lt;p>æ‰€éœ€å·¥å…·ï¼š&lt;/p>
&lt;ul>
&lt;li>docker&lt;/li>
&lt;li>minkube&lt;/li>
&lt;li>kubectl&lt;/li>
&lt;/ul>
&lt;p>å¦‚ä½•å®‰è£… docker å°±ä¸å†è¿™é‡Œæ’°è¿°ã€‚&lt;/p>
&lt;h3 id="å®‰è£…-minikube">å®‰è£… minikube&lt;/h3>
&lt;p>&lt;a href="https://v1-18.docs.kubernetes.io/zh/docs/tasks/tools/install-minikube/">å®˜æ–¹æ–‡æ¡£&lt;/a>&lt;/p>
&lt;p>&lt;strong>Mac&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ brew install minkube
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>linux&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ curl -Lo minikube https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64 &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> chmod +x minikube
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å°† Minikube å¯æ‰§è¡Œæ–‡ä»¶æ·»åŠ è‡³ PATHï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">sudo mkdir -p /usr/local/bin/
sudo install minikube /usr/local/bin/
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¹Ÿå¯ä»¥åœ¨ &lt;a href="https://github.com/kubernetes/minikube">GitHub&lt;/a> ä¸Šä¸‹è½½ç³»ç»Ÿå¯¹åº”çš„äºŒçº§åˆ¶æ–‡ä»¶&lt;/p>
&lt;h3 id="å®‰è£…-kubectl">å®‰è£… kubectl&lt;/h3>
&lt;p>&lt;a href="https://v1-18.docs.kubernetes.io/zh/docs/tasks/tools/install-kubectl/#install-kubectl-on-linux">å®˜æ–¹æ–‡æ¡£&lt;/a>&lt;/p>
&lt;p>&lt;strong>Mac&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ brew install kubernetes-cli
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>Linux&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ sudo apt-get update &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> sudo apt-get install -y apt-transport-https
$ curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg &lt;span class="p">|&lt;/span> sudo apt-key add -
$ &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;deb https://apt.kubernetes.io/ kubernetes-xenial main&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> sudo tee -a /etc/apt/sources.list.d/kubernetes.list
$ sudo apt-get update
$ sudo apt-get install -y kubectl
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="å¯åŠ¨æ£€æŸ¥">å¯åŠ¨&amp;amp;æ£€æŸ¥&lt;/h2>
&lt;p>&lt;strong>å¯åŠ¨&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ minikube start --vm-driver&lt;span class="o">=&lt;/span>docker
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>æ£€æŸ¥&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ minikube status
minikube
type: Control Plane
host: Running
kubelet: Running
apiserver: Running
kubeconfig: Configured
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è‡³æ­¤é›†ç¾¤å·²ç»éƒ¨ç½²æˆåŠŸï¼Œå¯ä»¥é€šè¿‡ &lt;code>kubectl&lt;/code> å‘½ä»¤æŸ¥çœ‹çŠ¶æ€&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl cluster-info
Kubernetes control plane is running at https://xxx.xxx.xx.xx:8443
CoreDNS is running at https://xxx.xxx.xx.xx:8443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="åœæ­¢æ¸…ç†">åœæ­¢&amp;amp;æ¸…ç†&lt;/h2>
&lt;p>&lt;strong>åœæ­¢&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ minkube stop
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>æ¸…ç†&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ minikube delete
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="webui">webUI&lt;/h2>
&lt;p>å®‰è£… k8s ç®¡ç† dashboardã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ minikube dashboard --url
ğŸ¤” Verifying dashboard health ...
ğŸš€ Launching proxy ...
ğŸ¤” Verifying proxy health ...
http://127.0.0.1:35983/api/v1/namespaces/kubernetes-dashboard/services/http:kubernetes-dashboard:/proxy/
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>minikube&lt;/code> ä¼šå®‰è£… dashboard å¹¶è¿”å›å¯è®¿é—®çš„ url, å¦‚æœæ˜¯æœ¬åœ°åˆ™ç›´æ¥è®¿é—®å³å¯ã€‚&lt;/p>
&lt;p>å¦‚æœæ˜¯æœåŠ¡å™¨ä¸Šï¼Œåˆ™éœ€è¦æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl proxy --address&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;0.0.0.0&amp;#39;&lt;/span> --disable-filter&lt;span class="o">=&lt;/span>&lt;span class="nb">true&lt;/span>
W0907 17:47:12.246841 &lt;span class="m">591818&lt;/span> proxy.go:162&lt;span class="o">]&lt;/span> Request filter disabled, your proxy is vulnerable to XSRF attacks, please be cautious
Starting to serve on &lt;span class="o">[&lt;/span>::&lt;span class="o">]&lt;/span>:8001
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¹¶é€šè¿‡&lt;code>http://serverIP:8001/api/v1/namespaces/kubernetes-dashboard/services/http:kubernetes-dashboard:/proxy/&lt;/code>è®¿é—® dashboard ã€‚&lt;/p>
&lt;h2 id="ingress">Ingress&lt;/h2>
&lt;p>å¯åŠ¨ ingress ä¹Ÿæ˜¯éœ€è¦é€šè¿‡ &lt;code>minikube&lt;/code> å‘½ä»¤æ‰§è¡Œã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ minikube addons &lt;span class="nb">enable&lt;/span> ingress
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>minikube&lt;/code> ä¼šå¼€å¯ ingress å¹¶å®‰è£… &lt;code>ingress-nginx&lt;/code>, æˆ‘ä»¬åªéœ€è¦å†™ &lt;code>ingress&lt;/code> è§„åˆ™å³å¯ã€‚ç„¶åé€šè¿‡ &lt;code>kubectl&lt;/code> å‘½ä»¤æŸ¥çœ‹å¯è®¿é—®çš„è™šæ‹Ÿ ipã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ kubectl get ingress
NAME CLASS HOSTS ADDRESS PORTS AGE
goapp-ingress &amp;lt;none&amp;gt; * 192.168.49.2 &lt;span class="m">80&lt;/span> 2d
$ curl 192.168.49.2/ping
&lt;span class="s2">&amp;#34;pong&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯ä»¥è®¿é—®çš„é€šçš„ã€‚&lt;/p>
&lt;blockquote>
&lt;p>ç›¸å…³è¿æ¥:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;a href="https://v1-18.docs.kubernetes.io/zh/docs/tasks/tools/install-minikube/">https://v1-18.docs.kubernetes.io/zh/docs/tasks/tools/install-minikube/&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://kubernetes.io/zh/docs/tasks/access-application-cluster/ingress-minikube/">https://kubernetes.io/zh/docs/tasks/access-application-cluster/ingress-minikube/&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://stackoverflow.com/questions/47173463/how-to-access-local-kubernetes-minikube-dashboard-remotely">https://stackoverflow.com/questions/47173463/how-to-access-local-kubernetes-minikube-dashboard-remotely&lt;/a>&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/blockquote></content><category scheme="https://yusank.github.io/categories/k8s/" term="k8s" label="k8s"/><category scheme="https://yusank.github.io/tags/k8s/" term="k8s" label="k8s"/><category scheme="https://yusank.github.io/tags/docker/" term="docker" label="docker"/></entry><entry><title type="text">å¦‚ä½•åœ¨ docker ç¯å¢ƒä¸‹è¿›è¡Œè¿œç¨‹ dlv è°ƒè¯•</title><link rel="alternate" type="text/html" href="https://yusank.github.io/posts/docker-dlv-debugging/"/><id>https://yusank.github.io/posts/docker-dlv-debugging/</id><updated>2021-09-18T06:24:55+00:00</updated><published>2021-09-06T14:02:03+08:00</published><author><name>yusank</name><uri>https://yusank.github.io/</uri><email>yusankurban@gmail.com</email></author><summary type="html">dlv ä½œä¸ºç¨‹åºè°ƒè¯•å·¥å…·åŠŸèƒ½éå¸¸å¼ºå¤§ï¼Œæ—¥å¸¸å¼€å‘å’Œæµ‹è¯•ä¸­å‡ ä¹ç¦»ä¸å¼€ debug è°ƒè¯•ã€‚ä½†æ˜¯æœ‰çš„æ—¶å€™ç”±â€¦â€¦</summary><content type="html">&lt;p>&lt;code>dlv&lt;/code> ä½œä¸ºç¨‹åºè°ƒè¯•å·¥å…·åŠŸèƒ½éå¸¸å¼ºå¤§ï¼Œæ—¥å¸¸å¼€å‘å’Œæµ‹è¯•ä¸­å‡ ä¹ç¦»ä¸å¼€ debug è°ƒè¯•ã€‚ä½†æ˜¯æœ‰çš„æ—¶å€™ç”±äºæœ¬åœ°ç¯å¢ƒä¸çº¿ä¸Šç¯å¢ƒä¸ä¸€è‡´æˆ–æœ‰äº›é—®é¢˜åœ¨æœ¬åœ°æ— æ³•å¤ç°çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦åœ¨çº¿ä¸Š/æµ‹è¯•ç¯å¢ƒåš debugï¼ŒåŒæ—¶å¸Œæœ› debug ä½“éªŒèƒ½ä¸æœ¬åœ° debug ä½“éªŒä¸€è‡´ã€‚&lt;code>dlv&lt;/code> å…¶å®æ˜¯æ”¯æŒè¿™ç§éœ€æ±‚çš„ï¼Œçº¿ä¸Šè¿è¡Œçº¿æœ¬åœ° debugã€‚ä»¥ä¸‹æ˜¯åŸºäº docker ç¯å¢ƒçš„è¿œç¨‹è°ƒè¯•æ­¥éª¤ï¼Œå¸Œæœ›èƒ½å¯¹é‡åˆ°è¿™ç§æƒ…å†µçš„ç å‹ä»¬å‹å¸®åŠ©ã€‚&lt;/p>
&lt;p>æ‰€éœ€å·¥å…·ï¼š&lt;/p>
&lt;ul>
&lt;li>docker&lt;/li>
&lt;li>goland&lt;/li>
&lt;li>dlv&lt;/li>
&lt;/ul>
&lt;h2 id="docker-file">docker file&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-dockerfile" data-lang="dockerfile">&lt;span class="c"># Compile stage&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="s"> golang:1.13.8 AS build-env&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="c"># Build Delve&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">RUN&lt;/span> go get github.com/go-delve/delve/cmd/dlv&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">ADD&lt;/span> . /dockerdev&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">WORKDIR&lt;/span>&lt;span class="s"> /dockerdev&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="c"># ç¼–è¯‘éœ€è¦ debug çš„ç¨‹åº&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">RUN&lt;/span> go build -gcflags&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;all=-N -l&amp;#34;&lt;/span> -o /server&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="c"># Final stage&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="s"> debian:buster&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="c"># åˆ†åˆ«æš´éœ² server å’Œ dlv ç«¯å£&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">EXPOSE&lt;/span>&lt;span class="s"> 8000 40000&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">WORKDIR&lt;/span>&lt;span class="s"> /&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">COPY&lt;/span> --from&lt;span class="o">=&lt;/span>build-env /go/bin/dlv /&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">COPY&lt;/span> --from&lt;span class="o">=&lt;/span>build-env /server /&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">CMD&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;/dlv&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;--listen=:40000&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;--headless=true&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;--api-version=2&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;--accept-multiclient&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;exec&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;/server&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="err">
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="å¯åŠ¨-docker-é•œåƒ">å¯åŠ¨ docker é•œåƒ&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ docker run -d -p 8000:8000 -p 40000:40000 --privileged --name&lt;span class="o">=&lt;/span>dlv-debug &lt;span class="k">$(&lt;/span>ImageName&lt;span class="k">)&lt;/span>:&lt;span class="k">$(&lt;/span>ImageVersion&lt;span class="k">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="goland-é…ç½®">goland é…ç½®&lt;/h2>
&lt;p>åœ¨ &lt;code>Goland -&amp;gt; Run -&amp;gt; Edit Configuration&lt;/code> æ·»åŠ  &lt;code>Go Remote&lt;/code> é…ç½® docker é•œåƒçš„ ip:port, æœ¬åœ°çš„ docker ç¯å¢ƒåˆ™ &lt;code>localhost:40000&lt;/code> å³å¯ã€‚&lt;/p>
&lt;p>ç°åœ¨å°±å¯ä»¥åœ¨æœ¬åœ° Goland ç¯å¢ƒä¸‹å¯åŠ¨é…ç½® debug å°±å¯ä»¥ï¼Œæœ¬åœ° debug è¿œç¨‹ç¨‹åºï¼Œä¸æœ¬åœ° debug æ¯«æ— åŒºåˆ«ã€‚&lt;/p>
&lt;p>è¿™ç§æ–¹å¼åœ¨ä¸€äº›ç‰¹å®šç¯å¢ƒï¼ˆtest ç¯å¢ƒã€è¿œç¨‹åŠå…¬ç­‰ï¼‰éå¸¸æ–¹ä¾¿ã€‚&lt;/p>
&lt;p>&lt;strong>å‚è€ƒæ–‡çŒ®ï¼š&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://blog.jetbrains.com/go/2020/05/06/debugging-a-go-application-inside-a-docker-container/">https://blog.jetbrains.com/go/2020/05/06/debugging-a-go-application-inside-a-docker-container/&lt;/a>&lt;/li>
&lt;/ul></content><category scheme="https://yusank.github.io/categories/%E6%8A%80%E6%9C%AF/" term="æŠ€æœ¯" label="æŠ€æœ¯"/><category scheme="https://yusank.github.io/tags/go/" term="go" label="go"/><category scheme="https://yusank.github.io/tags/docker/" term="docker" label="docker"/></entry><entry><title type="text">å¦‚ä½•è‡ªå®šä¹‰ protoc æ’ä»¶</title><link rel="alternate" type="text/html" href="https://yusank.github.io/posts/go-protoc-http/"/><id>https://yusank.github.io/posts/go-protoc-http/</id><updated>2021-09-18T06:24:55+00:00</updated><published>2021-07-08T18:22:00+08:00</published><author><name>yusank</name><uri>https://yusank.github.io/</uri><email>yusankurban@gmail.com</email></author><summary type="html">å‰è¨€ å¦‚æœå¤§å®¶æ¥è§¦è¿‡ grpc å’Œ protobuf ï¼Œé‚£å¯¹ protoc è¿™ä¸ªå‘½ä»¤åº”è¯¥ä¸é™Œç”Ÿã€‚ protoc ä¸ºåŸºäº proto buffer æ–‡ä»¶ç”Ÿæˆä¸åŒè¯­è¨€â€¦â€¦</summary><content type="html">&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>å¦‚æœå¤§å®¶æ¥è§¦è¿‡ grpc å’Œ protobuf ï¼Œé‚£å¯¹ &lt;code>protoc&lt;/code> è¿™ä¸ªå‘½ä»¤åº”è¯¥ä¸é™Œç”Ÿã€‚&lt;/p>
&lt;p>&lt;code>protoc&lt;/code> ä¸ºåŸºäº proto buffer æ–‡ä»¶ç”Ÿæˆä¸åŒè¯­è¨€ä»£ç çš„å·¥å…·ï¼Œåœ¨æ—¥å¸¸ä¸šåŠ¡å¼€å‘ä¸­èƒ½ç»å¸¸ç”¨åˆ°ã€‚é‚£å…ˆæŠ›å‡ºä¸€ä¸ªé—®é¢˜ï¼Œä½ æœ‰æ²¡æœ‰åŸºäº pb æ–‡ä»¶ç”Ÿæˆæ»¡è¶³è‡ªå·±ç‰¹æ®Šè¦æ±‚çš„éœ€æ±‚ï¼Ÿæ¯”å¦‚ç”Ÿæˆå¯¹åº”çš„ http ä»£ç æˆ–æ ¡éªŒå‚æ•°ç­‰ã€‚&lt;/p>
&lt;p>æˆ‘ä¸ªäººéœ€æ±‚ä¸ºï¼Œé™¤äº†ç”Ÿæˆæ­£å¸¸çš„ &lt;code>grpc&lt;/code> ä»£ç å¤–ï¼Œéœ€è¦ç”Ÿæˆä¸€å¥—å¯¹åº”çš„ &lt;code>http&lt;/code> ä»£ç ï¼Œè€Œä¸”æœ€å¥½æ˜¯èƒ½ç›´æ¥åœ¨ gin/iris è¿™ç§ä¸»æµ web æ¡†æ¶å†…æ³¨å†Œä½¿ç”¨ã€‚&lt;/p>
&lt;p>å…¶å® &lt;code>golang/protobuf&lt;/code> åŒ…æ”¯æŒè‡ªå®šä¹‰æ’ä»¶çš„ï¼Œè€Œä¸”è¿˜æä¾›å¾ˆå¤šå¥½ç”¨çš„æ–¹æ³•ï¼Œæ–¹ä¾¿æˆ‘ä»¬è¯»å†™ pb æ–‡ä»¶ã€‚æˆ‘ä»¬å†™å¥½è‡ªå·±çš„æ’ä»¶å®‰è£…åˆ° &lt;code>$GOPATH/bin&lt;/code> ä¸‹ï¼Œç„¶ååœ¨è°ƒç”¨ &lt;code>protoc&lt;/code> å‘½ä»¤æ—¶ï¼ŒæŒ‡å®šæˆ‘ä»¬è‡ªå·±çš„æ’ä»¶åå’Œè¾“å‡ºä½ç½®å³å¯ã€‚&lt;/p>
&lt;p>&lt;strong>å…³äºè¿™ä¸ªæ’ä»¶ï¼šæˆ‘ç°æœ‰çš„éœ€æ±‚ç„¶åä¸€ç›´æ‰¾ä¸åˆ°æ¯”è¾ƒå¥½çš„è§£å†³æ–¹æ¡ˆï¼Œç›´åˆ°çœ‹åˆ° &lt;a href="https://github.com/go-kratos/kratos">kratos&lt;/a> é¡¹ç›®çš„ http ä»£ç ç”Ÿæˆæ’ä»¶åè±ç„¶å¼€æœ—ï¼ŒåŸºäº &lt;code>kratos&lt;/code> çš„é€»è¾‘å®ç°çš„è‡ªå·±éœ€æ±‚ï¼Œæ„Ÿè°¢ &lt;code>kratos&lt;/code> ä½œè€…ä»¬ã€‚&lt;/strong>&lt;/p>
&lt;h2 id="æ•ˆæœ">æ•ˆæœ&lt;/h2>
&lt;p>å…ˆçœ‹åŸå§‹ pb æ–‡ä»¶ã€‚&lt;/p>
&lt;p>test.proto&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-protobuf" data-lang="protobuf">&lt;span class="n">syntax&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;proto3&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="kn">package&lt;/span> &lt;span class="nn">hello&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">service.v1&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="k">option&lt;/span> &lt;span class="n">go_package&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;api/hello/service/v1;v1&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="c1">// ä¸‹è½½ `github.com/googleapis/googleapis` è‡³`GOPATH`, ç”Ÿæˆ http ä»£ç éœ€è¦ã€‚
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="k">import&lt;/span> &lt;span class="s">&amp;#34;google/api/annotations.proto&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="kd">service&lt;/span> &lt;span class="n">Hello&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span> &lt;span class="k">rpc&lt;/span> &lt;span class="n">Add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">AddRequest&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">AddResponse&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span> &lt;span class="k">option&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">google.api.http&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span> &lt;span class="n">post&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s">&amp;#34;/api/hello/service/v1/add&amp;#34;&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span> &lt;span class="n">body&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s">&amp;#34;*&amp;#34;&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span> &lt;span class="p">};&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span> &lt;span class="p">}&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span> &lt;span class="k">rpc&lt;/span> &lt;span class="n">Get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">GetRequest&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">GetResponse&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span> &lt;span class="k">option&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">google.api.http&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span> &lt;span class="n">get&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="s">&amp;#34;/api/hello/service/v1/get&amp;#34;&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span> &lt;span class="p">};&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span> &lt;span class="p">}&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="kd">message&lt;/span> &lt;span class="nc">AddRequest&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span> &lt;span class="kt">uint32&lt;/span> &lt;span class="n">id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="n">name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="kd">message&lt;/span> &lt;span class="nc">AddResponse&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span> &lt;span class="kt">uint32&lt;/span> &lt;span class="n">id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="n">name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="kd">message&lt;/span> &lt;span class="nc">GetRequest&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span> &lt;span class="kt">uint32&lt;/span> &lt;span class="n">id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="kd">message&lt;/span> &lt;span class="nc">GetResponse&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span> &lt;span class="kt">uint32&lt;/span> &lt;span class="n">id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="n">name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span> &lt;span class="kt">float&lt;/span> &lt;span class="n">score&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span> &lt;span class="kt">bytes&lt;/span> &lt;span class="n">bs&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span> &lt;span class="n">map&lt;/span>&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">&amp;gt;&lt;/span> &lt;span class="n">m&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="err">
&lt;/span>&lt;span class="err">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="err">
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å› ä¸ºæˆ‘éœ€è¦ç”Ÿæˆ http ä»£ç ï¼Œæ‰€ä»¥å®šä¹‰ rpc æ—¶ï¼Œhttp è·¯ç”±å’Œmethod éœ€è¦åœ¨ pb æ–‡ä»¶æŒ‡å®šã€‚&lt;/p>
&lt;p>æˆ‘å®ç°çš„æ’ä»¶èµ·ç å« &lt;code>protoc-gen-go-http&lt;/code>, å¿…é¡»ä»¥ &lt;code>protoc-gen&lt;/code> å¼€å¤´å¦åˆ™ protoc ä¸è®¤ã€‚&lt;/p>
&lt;p>æ‰§è¡Œå‘½ä»¤ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># --go-http ä¸ºæˆ‘è‡ªå·±çš„æ’ä»¶&lt;/span>
&lt;span class="c1"># å…¶ä¸­å‚æ•°æ˜¯ key=v,key2=v2 æ–¹å¼ä¼ ï¼Œæœ€åå†’å·åé¢å†™è¾“å‡ºç›®å½•&lt;/span>
protoc -I&lt;span class="nv">$GOPATH&lt;/span>/src/github.com/googleapis/googleapis --proto_path&lt;span class="o">=&lt;/span>&lt;span class="nv">$GOPATH&lt;/span>/src:. --go_out&lt;span class="o">=&lt;/span>. --go-http_out&lt;span class="o">=&lt;/span>&lt;span class="nv">router&lt;/span>&lt;span class="o">=&lt;/span>gin:. --micro_out&lt;span class="o">=&lt;/span>. test.proto
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ‰§è¡Œå®Œå‘½ä»¤åï¼Œä¼šç”Ÿæˆä¸‰ä¸ªæ–‡ä»¶åˆ†åˆ«ä¸º &lt;code>test.pb.go&lt;/code>,&lt;code>test.pb.micro.go&lt;/code>å’Œ&lt;code>test.http.pb.go&lt;/code>ï¼Œ ç”Ÿæˆçš„æ–‡ä»¶åæ˜¯å¯ä»¥è‡ªå®šä¹‰çš„ã€‚&lt;/p>
&lt;p>&lt;code>test.pb.micro.go&lt;/code> æ–‡ä»¶æ˜¯ç”± go-micro æä¾›çš„å·¥å…·ç”Ÿæˆ grpc ä»£ç æ–‡ä»¶ã€‚&lt;/p>
&lt;p>çœ‹ä¸€ä¸‹ &lt;code>test.http.pb.go&lt;/code> æ–‡ä»¶&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;span class="lnt">70
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// Code generated by protoc-gen-go-http. DO NOT EDIT.
&lt;/span>&lt;span class="c1">// versions:
&lt;/span>&lt;span class="c1">// protoc-gen-go-http v0.0.9
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="kn">package&lt;/span> &lt;span class="nx">v1&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="nx">context&lt;/span> &lt;span class="s">&amp;#34;context&amp;#34;&lt;/span>
&lt;span class="nx">gin&lt;/span> &lt;span class="s">&amp;#34;github.com/gin-gonic/gin&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="c1">// This is a compile-time assertion to ensure that this generated file
&lt;/span>&lt;span class="c1">// is compatible with the galaxy package it is being compiled against.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">var&lt;/span> &lt;span class="nx">_&lt;/span> &lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>
&lt;span class="kd">const&lt;/span> &lt;span class="nx">_&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">gin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Version&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">HelloHTTPHandler&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">Add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">AddRequest&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">AddResponse&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="nf">Get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">GetRequest&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">GetResponse&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// RegisterHelloHTTPHandler define http router handle by gin.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">RegisterHelloHTTPHandler&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">g&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">gin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RouterGroup&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">srv&lt;/span> &lt;span class="nx">HelloHTTPHandler&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">POST&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/api/hello/service/v1/add&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nf">_Hello_Add0_HTTP_Handler&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">srv&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GET&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/api/hello/service/v1/get&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nf">_Hello_Get0_HTTP_Handler&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">srv&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">_Hello_Add0_HTTP_Handler&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">srv&lt;/span> &lt;span class="nx">HelloHTTPHandler&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">gin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">gin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="nx">in&lt;/span> &lt;span class="nx">AddRequest&lt;/span>
&lt;span class="nx">out&lt;/span> &lt;span class="nx">AddResponse&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ShouldBind&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">in&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">AbortWithStatusJSON&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">400&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">gin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">H&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="s">&amp;#34;err&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">()})&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">srv&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Background&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">in&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">out&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">AbortWithStatusJSON&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">500&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">gin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">H&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="s">&amp;#34;err&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">()})&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">JSON&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">200&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">out&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">_Hello_Get0_HTTP_Handler&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">srv&lt;/span> &lt;span class="nx">HelloHTTPHandler&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">gin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">gin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="nx">in&lt;/span> &lt;span class="nx">GetRequest&lt;/span>
&lt;span class="nx">out&lt;/span> &lt;span class="nx">GetResponse&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ShouldBind&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">in&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">AbortWithStatusJSON&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">400&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">gin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">H&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="s">&amp;#34;err&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">()})&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">srv&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Background&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">in&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">out&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">AbortWithStatusJSON&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">500&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">gin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">H&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="s">&amp;#34;err&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">()})&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">JSON&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">200&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">out&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é‡ç‚¹æ˜¯ &lt;code>RegisterHelloHTTPHandler&lt;/code> æ–¹æ³•ï¼Œè¿™æ ·æˆ‘å°±æ³¨å†Œä¸€ä¸ª gin.RouterGroup å’Œ HelloHTTPHandler å°±å¯ä»¥ç›´æ¥æä¾›ä¸€ä¸ª http æœåŠ¡ &lt;code>HelloHTTPHandler&lt;/code> æ¥å£é‡Œæ–¹æ³•çš„ç­¾åä¸&lt;code>go-micro&lt;/code>ç”Ÿæˆçš„ grpc æ–¹æ³•ä¿æŒäº†ä¸€è‡´ï¼Œ è¿™æ ·æˆ‘åªéœ€è¦å®ç° grpc çš„ä»£ç é‡Œå¯¹åº”çš„ Interface{} æ¥å£ï¼Œå°±å¯ä»¥æœç”¨ï¼Œå®Œå…¨ä¸ä¼šäº§ç”Ÿå¤šä½™ä»£ç ã€‚&lt;/p>
&lt;p>go-micro ç”Ÿæˆçš„ pb ä»£ç ç‰‡æ®µï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">HelloHandler&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">Add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">AddRequest&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">AddResponse&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="nf">Get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">GetRequest&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">GetResponse&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">RegisterHelloHandler&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="nx">server&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Server&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">hdlr&lt;/span> &lt;span class="nx">HelloHandler&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">opts&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="nx">server&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HandlerOption&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æˆ‘åœ¨ main å‡½æ•°æ³¨å†Œçš„æ—¶å€™ä¹Ÿåªéœ€è¦å¤šæ³¨å†Œä¸€æ¬¡ http handler å³å¯ï¼Œ&lt;/p>
&lt;p>main.go&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">
&lt;span class="c1">// å®ƒå®ç°äº† HelloHandler
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">implHello&lt;/span> &lt;span class="kd">struct&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="nf">RegisterHelloHandler&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">micro&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Server&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">implHello&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">g&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">gin&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="c1">// implHello å®ç°HelloHandler é‚£å°±æ˜¯å®ç°äº†HelloHTTPHandler
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nf">RegisterHelloHTTPHandler&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Group&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">implHello&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ‰€ä»¥æˆ‘å°±å¾ˆå®¹æ˜“é€šè¿‡ http æ¥å£è°ƒè¯• grpc æ–¹æ³•ï¼Œç”šè‡³å¯ä»¥å¯¹å¤–æä¾›æœåŠ¡ï¼Œä¸€ä¸¾ä¸¤å¾—ã€‚&lt;/p>
&lt;h2 id="å¦‚ä½•å®ç°">å¦‚ä½•å®ç°&lt;/h2>
&lt;h3 id="ç¨‹åºå…¥å£">ç¨‹åºå…¥å£&lt;/h3>
&lt;p>main.go&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;flag&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;google.golang.org/protobuf/compiler/protogen&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;google.golang.org/protobuf/types/pluginpb&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="c1">// protoc-gen-go-http å·¥å…·ç‰ˆæœ¬
&lt;/span>&lt;span class="c1">// ä¸ GalaxyMicroVersion ä¿æŒä¸€è‡´
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">const&lt;/span> &lt;span class="nx">version&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">&amp;#34;v0.0.12&amp;#34;&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// 1. ä¼ å‚å®šä¹‰
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// å³ æ’ä»¶æ˜¯æ”¯æŒè‡ªå®šä¹‰å‚æ•°çš„ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥æ›´åŠ çµæ´»ï¼Œé’ˆå¯¹ä¸åŒçš„åœºæ™¯ç”Ÿæˆä¸åŒçš„ä»£ç 
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">var&lt;/span> &lt;span class="nx">flags&lt;/span> &lt;span class="nx">flag&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">FlagSet&lt;/span>
&lt;span class="c1">// æ˜¯å¦å¿½ç•¥æ²¡æœ‰æŒ‡å®š google.api çš„æ–¹æ³•
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">omitempty&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">flags&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Bool&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;omitempty&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;omit if google.api is empty&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// æˆ‘è¿™é‡ŒåŒæ—¶æ”¯æŒäº† gin å’Œ iris å¯ä»¥é€šè¿‡å‚æ•°æŒ‡å®šç”Ÿæˆ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">routerEngine&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">flags&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">String&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;router&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;gin&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;http router engine, choose between gin and iris&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// æ˜¯å¦ç”Ÿæ ¡éªŒä»£ç å—
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// å‘ç°äº†ä¸€ä¸ªå¾ˆæœ‰ç”¨çš„æ’ä»¶ github.com/envoyproxy/protoc-gen-validate
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// å¯ä»¥åœ¨ pb çš„ message ä¸­è®¾ç½®å‚æ•°è§„åˆ™ï¼Œç„¶åä¼šç”Ÿæˆä¸€ä¸ª validate.go çš„æ–‡ä»¶ é’ˆå¯¹æ¯ä¸ª message ç”Ÿæˆä¸€ä¸ª Validate() æ–¹æ³•
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// æˆ‘åœ¨æ¯ä¸ª handler å¤„ç†ä¸šåŠ¡å‰åšäº†ä¸€æ¬¡å‚æ•°æ ¡éªŒåˆ¤æ–­ï¼Œé€šè¿‡è¿™ä¸ª flag æ§åˆ¶æ˜¯å¦ç”Ÿæˆè¿™æ®µæ ¡éªŒä»£ç 
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">genValidateCode&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">flags&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Bool&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;validate&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;add validate request params in handler&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// ç”Ÿæˆä»£ç æ—¶å‚æ•° è¿™ä¹ˆä¼ ï¼š--go-http_out=router=iris,validate=true:.
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="nx">gp&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">GenParam&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">Omitempty&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">omitempty&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">RouterEngine&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">routerEngine&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">GenValidateCode&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">genValidateCode&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// è¿™é‡Œå°±æ˜¯å…¥å£ï¼ŒæŒ‡å®š option åæ‰§è¡Œ Run æ–¹æ³• ï¼Œæˆ‘ä»¬çš„ä¸»é€»è¾‘å°±æ˜¯åœ¨ Run æ–¹æ³•
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">protogen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Options&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">ParamFunc&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">flags&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Set&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}.&lt;/span>&lt;span class="nf">Run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">gen&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">protogen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Plugin&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">gen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">SupportedFeatures&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">uint64&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">pluginpb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">CodeGeneratorResponse_FEATURE_PROTO3_OPTIONAL&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">f&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">gen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Files&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">f&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Generate&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">continue&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// è¿™é‡Œæ˜¯æˆ‘ä»¬çš„ç”Ÿæˆä»£ç æ–¹æ³•
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">generateFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">gen&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">f&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">gp&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">})&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">GenParam&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">Omitempty&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="kt">bool&lt;/span>
&lt;span class="nx">RouterEngine&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="kt">string&lt;/span>
&lt;span class="nx">GenValidateCode&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="kt">bool&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="è¯»å–-pb-æ–‡ä»¶å®šä¹‰">è¯»å– pb æ–‡ä»¶å®šä¹‰&lt;/h3>
&lt;p>http.go&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt"> 10
&lt;/span>&lt;span class="lnt"> 11
&lt;/span>&lt;span class="lnt"> 12
&lt;/span>&lt;span class="lnt"> 13
&lt;/span>&lt;span class="lnt"> 14
&lt;/span>&lt;span class="lnt"> 15
&lt;/span>&lt;span class="lnt"> 16
&lt;/span>&lt;span class="lnt"> 17
&lt;/span>&lt;span class="lnt"> 18
&lt;/span>&lt;span class="lnt"> 19
&lt;/span>&lt;span class="lnt"> 20
&lt;/span>&lt;span class="lnt"> 21
&lt;/span>&lt;span class="lnt"> 22
&lt;/span>&lt;span class="lnt"> 23
&lt;/span>&lt;span class="lnt"> 24
&lt;/span>&lt;span class="lnt"> 25
&lt;/span>&lt;span class="lnt"> 26
&lt;/span>&lt;span class="lnt"> 27
&lt;/span>&lt;span class="lnt"> 28
&lt;/span>&lt;span class="lnt"> 29
&lt;/span>&lt;span class="lnt"> 30
&lt;/span>&lt;span class="lnt"> 31
&lt;/span>&lt;span class="lnt"> 32
&lt;/span>&lt;span class="lnt"> 33
&lt;/span>&lt;span class="lnt"> 34
&lt;/span>&lt;span class="lnt"> 35
&lt;/span>&lt;span class="lnt"> 36
&lt;/span>&lt;span class="lnt"> 37
&lt;/span>&lt;span class="lnt"> 38
&lt;/span>&lt;span class="lnt"> 39
&lt;/span>&lt;span class="lnt"> 40
&lt;/span>&lt;span class="lnt"> 41
&lt;/span>&lt;span class="lnt"> 42
&lt;/span>&lt;span class="lnt"> 43
&lt;/span>&lt;span class="lnt"> 44
&lt;/span>&lt;span class="lnt"> 45
&lt;/span>&lt;span class="lnt"> 46
&lt;/span>&lt;span class="lnt"> 47
&lt;/span>&lt;span class="lnt"> 48
&lt;/span>&lt;span class="lnt"> 49
&lt;/span>&lt;span class="lnt"> 50
&lt;/span>&lt;span class="lnt"> 51
&lt;/span>&lt;span class="lnt"> 52
&lt;/span>&lt;span class="lnt"> 53
&lt;/span>&lt;span class="lnt"> 54
&lt;/span>&lt;span class="lnt"> 55
&lt;/span>&lt;span class="lnt"> 56
&lt;/span>&lt;span class="lnt"> 57
&lt;/span>&lt;span class="lnt"> 58
&lt;/span>&lt;span class="lnt"> 59
&lt;/span>&lt;span class="lnt"> 60
&lt;/span>&lt;span class="lnt"> 61
&lt;/span>&lt;span class="lnt"> 62
&lt;/span>&lt;span class="lnt"> 63
&lt;/span>&lt;span class="lnt"> 64
&lt;/span>&lt;span class="lnt"> 65
&lt;/span>&lt;span class="lnt"> 66
&lt;/span>&lt;span class="lnt"> 67
&lt;/span>&lt;span class="lnt"> 68
&lt;/span>&lt;span class="lnt"> 69
&lt;/span>&lt;span class="lnt"> 70
&lt;/span>&lt;span class="lnt"> 71
&lt;/span>&lt;span class="lnt"> 72
&lt;/span>&lt;span class="lnt"> 73
&lt;/span>&lt;span class="lnt"> 74
&lt;/span>&lt;span class="lnt"> 75
&lt;/span>&lt;span class="lnt"> 76
&lt;/span>&lt;span class="lnt"> 77
&lt;/span>&lt;span class="lnt"> 78
&lt;/span>&lt;span class="lnt"> 79
&lt;/span>&lt;span class="lnt"> 80
&lt;/span>&lt;span class="lnt"> 81
&lt;/span>&lt;span class="lnt"> 82
&lt;/span>&lt;span class="lnt"> 83
&lt;/span>&lt;span class="lnt"> 84
&lt;/span>&lt;span class="lnt"> 85
&lt;/span>&lt;span class="lnt"> 86
&lt;/span>&lt;span class="lnt"> 87
&lt;/span>&lt;span class="lnt"> 88
&lt;/span>&lt;span class="lnt"> 89
&lt;/span>&lt;span class="lnt"> 90
&lt;/span>&lt;span class="lnt"> 91
&lt;/span>&lt;span class="lnt"> 92
&lt;/span>&lt;span class="lnt"> 93
&lt;/span>&lt;span class="lnt"> 94
&lt;/span>&lt;span class="lnt"> 95
&lt;/span>&lt;span class="lnt"> 96
&lt;/span>&lt;span class="lnt"> 97
&lt;/span>&lt;span class="lnt"> 98
&lt;/span>&lt;span class="lnt"> 99
&lt;/span>&lt;span class="lnt">100
&lt;/span>&lt;span class="lnt">101
&lt;/span>&lt;span class="lnt">102
&lt;/span>&lt;span class="lnt">103
&lt;/span>&lt;span class="lnt">104
&lt;/span>&lt;span class="lnt">105
&lt;/span>&lt;span class="lnt">106
&lt;/span>&lt;span class="lnt">107
&lt;/span>&lt;span class="lnt">108
&lt;/span>&lt;span class="lnt">109
&lt;/span>&lt;span class="lnt">110
&lt;/span>&lt;span class="lnt">111
&lt;/span>&lt;span class="lnt">112
&lt;/span>&lt;span class="lnt">113
&lt;/span>&lt;span class="lnt">114
&lt;/span>&lt;span class="lnt">115
&lt;/span>&lt;span class="lnt">116
&lt;/span>&lt;span class="lnt">117
&lt;/span>&lt;span class="lnt">118
&lt;/span>&lt;span class="lnt">119
&lt;/span>&lt;span class="lnt">120
&lt;/span>&lt;span class="lnt">121
&lt;/span>&lt;span class="lnt">122
&lt;/span>&lt;span class="lnt">123
&lt;/span>&lt;span class="lnt">124
&lt;/span>&lt;span class="lnt">125
&lt;/span>&lt;span class="lnt">126
&lt;/span>&lt;span class="lnt">127
&lt;/span>&lt;span class="lnt">128
&lt;/span>&lt;span class="lnt">129
&lt;/span>&lt;span class="lnt">130
&lt;/span>&lt;span class="lnt">131
&lt;/span>&lt;span class="lnt">132
&lt;/span>&lt;span class="lnt">133
&lt;/span>&lt;span class="lnt">134
&lt;/span>&lt;span class="lnt">135
&lt;/span>&lt;span class="lnt">136
&lt;/span>&lt;span class="lnt">137
&lt;/span>&lt;span class="lnt">138
&lt;/span>&lt;span class="lnt">139
&lt;/span>&lt;span class="lnt">140
&lt;/span>&lt;span class="lnt">141
&lt;/span>&lt;span class="lnt">142
&lt;/span>&lt;span class="lnt">143
&lt;/span>&lt;span class="lnt">144
&lt;/span>&lt;span class="lnt">145
&lt;/span>&lt;span class="lnt">146
&lt;/span>&lt;span class="lnt">147
&lt;/span>&lt;span class="lnt">148
&lt;/span>&lt;span class="lnt">149
&lt;/span>&lt;span class="lnt">150
&lt;/span>&lt;span class="lnt">151
&lt;/span>&lt;span class="lnt">152
&lt;/span>&lt;span class="lnt">153
&lt;/span>&lt;span class="lnt">154
&lt;/span>&lt;span class="lnt">155
&lt;/span>&lt;span class="lnt">156
&lt;/span>&lt;span class="lnt">157
&lt;/span>&lt;span class="lnt">158
&lt;/span>&lt;span class="lnt">159
&lt;/span>&lt;span class="lnt">160
&lt;/span>&lt;span class="lnt">161
&lt;/span>&lt;span class="lnt">162
&lt;/span>&lt;span class="lnt">163
&lt;/span>&lt;span class="lnt">164
&lt;/span>&lt;span class="lnt">165
&lt;/span>&lt;span class="lnt">166
&lt;/span>&lt;span class="lnt">167
&lt;/span>&lt;span class="lnt">168
&lt;/span>&lt;span class="lnt">169
&lt;/span>&lt;span class="lnt">170
&lt;/span>&lt;span class="lnt">171
&lt;/span>&lt;span class="lnt">172
&lt;/span>&lt;span class="lnt">173
&lt;/span>&lt;span class="lnt">174
&lt;/span>&lt;span class="lnt">175
&lt;/span>&lt;span class="lnt">176
&lt;/span>&lt;span class="lnt">177
&lt;/span>&lt;span class="lnt">178
&lt;/span>&lt;span class="lnt">179
&lt;/span>&lt;span class="lnt">180
&lt;/span>&lt;span class="lnt">181
&lt;/span>&lt;span class="lnt">182
&lt;/span>&lt;span class="lnt">183
&lt;/span>&lt;span class="lnt">184
&lt;/span>&lt;span class="lnt">185
&lt;/span>&lt;span class="lnt">186
&lt;/span>&lt;span class="lnt">187
&lt;/span>&lt;span class="lnt">188
&lt;/span>&lt;span class="lnt">189
&lt;/span>&lt;span class="lnt">190
&lt;/span>&lt;span class="lnt">191
&lt;/span>&lt;span class="lnt">192
&lt;/span>&lt;span class="lnt">193
&lt;/span>&lt;span class="lnt">194
&lt;/span>&lt;span class="lnt">195
&lt;/span>&lt;span class="lnt">196
&lt;/span>&lt;span class="lnt">197
&lt;/span>&lt;span class="lnt">198
&lt;/span>&lt;span class="lnt">199
&lt;/span>&lt;span class="lnt">200
&lt;/span>&lt;span class="lnt">201
&lt;/span>&lt;span class="lnt">202
&lt;/span>&lt;span class="lnt">203
&lt;/span>&lt;span class="lnt">204
&lt;/span>&lt;span class="lnt">205
&lt;/span>&lt;span class="lnt">206
&lt;/span>&lt;span class="lnt">207
&lt;/span>&lt;span class="lnt">208
&lt;/span>&lt;span class="lnt">209
&lt;/span>&lt;span class="lnt">210
&lt;/span>&lt;span class="lnt">211
&lt;/span>&lt;span class="lnt">212
&lt;/span>&lt;span class="lnt">213
&lt;/span>&lt;span class="lnt">214
&lt;/span>&lt;span class="lnt">215
&lt;/span>&lt;span class="lnt">216
&lt;/span>&lt;span class="lnt">217
&lt;/span>&lt;span class="lnt">218
&lt;/span>&lt;span class="lnt">219
&lt;/span>&lt;span class="lnt">220
&lt;/span>&lt;span class="lnt">221
&lt;/span>&lt;span class="lnt">222
&lt;/span>&lt;span class="lnt">223
&lt;/span>&lt;span class="lnt">224
&lt;/span>&lt;span class="lnt">225
&lt;/span>&lt;span class="lnt">226
&lt;/span>&lt;span class="lnt">227
&lt;/span>&lt;span class="lnt">228
&lt;/span>&lt;span class="lnt">229
&lt;/span>&lt;span class="lnt">230
&lt;/span>&lt;span class="lnt">231
&lt;/span>&lt;span class="lnt">232
&lt;/span>&lt;span class="lnt">233
&lt;/span>&lt;span class="lnt">234
&lt;/span>&lt;span class="lnt">235
&lt;/span>&lt;span class="lnt">236
&lt;/span>&lt;span class="lnt">237
&lt;/span>&lt;span class="lnt">238
&lt;/span>&lt;span class="lnt">239
&lt;/span>&lt;span class="lnt">240
&lt;/span>&lt;span class="lnt">241
&lt;/span>&lt;span class="lnt">242
&lt;/span>&lt;span class="lnt">243
&lt;/span>&lt;span class="lnt">244
&lt;/span>&lt;span class="lnt">245
&lt;/span>&lt;span class="lnt">246
&lt;/span>&lt;span class="lnt">247
&lt;/span>&lt;span class="lnt">248
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;strings&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;google.golang.org/genproto/googleapis/api/annotations&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;google.golang.org/protobuf/compiler/protogen&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;google.golang.org/protobuf/proto&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;google.golang.org/protobuf/types/descriptorpb&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">const&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="nx">contextPackage&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">protogen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GoImportPath&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;context&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">ginPackage&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">protogen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GoImportPath&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;github.com/gin-gonic/gin&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">irisPackage&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">protogen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GoImportPath&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;github.com/kataras/iris/v12&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">methodSets&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// generateFile generates a _http.pb.go file containing gin/iris handler.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">generateFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">gen&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">protogen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Plugin&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">file&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">protogen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">File&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">gp&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">GenParam&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">protogen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GeneratedFile&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Services&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">gp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Omitempty&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nf">hasHTTPRule&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Services&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// è¿™é‡Œæˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰æ–‡ä»¶å
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">filename&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GeneratedFilenamePrefix&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s">&amp;#34;.pb.http.go&amp;#34;&lt;/span>
&lt;span class="nx">g&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">gen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewGeneratedFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">filename&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GoImportPath&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// å†™å…¥ä¸€äº›è­¦å‘Šä¹‹ç±»çš„ å‘Šè¯‰ç”¨æˆ·ä¸è¦ä¿®æ”¹
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;// Code generated by protoc-gen-go-http. DO NOT EDIT.&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;// versions:&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;// protoc-gen-go-http %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">version&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;package &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GoPackageName&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nf">generateFileContent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">gen&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">file&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">g&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">gp&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">g&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// generateFileContent generates the _http.pb.go file content, excluding the package statement.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">generateFileContent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">gen&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">protogen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Plugin&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">file&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">protogen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">File&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">g&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">protogen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GeneratedFile&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">gp&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">GenParam&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Services&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// import
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// è¿™é‡Œæœ‰ä¸ªæ’æ›²ï¼šå…¶å® import ç›¸å…³çš„ä»£ç æˆ‘ä»¬è¿™ä¹ˆä¸éœ€è¦ç‰¹æ®ŠæŒ‡å®šï¼Œprotogen åŒ…ä¼šå¸®æˆ‘ä»¬å¤„ç†ï¼Œ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// ä½†æ˜¯import çš„ path å‰çš„åˆ«åé»˜è®¤å– path æœ€åä¸€ä¸ª `/` ä¹‹åçš„å­—ç¬¦ï¼Œ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// æ¯”å¦‚ï¼šgithub.com/kataras/iris/v12 è¢«å¤„ç†æˆ v12 &amp;#34;github.com/kataras/iris/v12&amp;#34;
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// è¿™ä¸ªæˆ‘ä¸å¤ªæ„¿æ„æ¥å— æ‰€ä»¥è‡ªå·±å†™å…¥ import
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;// This imports are custom by galaxy micro framework.&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;import (&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">switch&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">gp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RouterEngine&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="s">&amp;#34;gin&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;gin&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34; &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ginPackage&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="s">&amp;#34;iris&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;iris&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34; &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">irisPackage&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;)&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// æ³¨ï¼š æˆ‘ä»¬éš¾å…æœ‰ä¸€äº› _ &amp;#34;my/package&amp;#34; è¿™ç§éœ€æ±‚ï¼Œè¿™å…¶å®ä¸ç”¨è‡ªå·±å†™ ç›´æ¥è°ƒ g.Import(&amp;#34;my/package&amp;#34;) å°±å¯ä»¥
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="c1">// è¿™é‡Œå®šä¹‰ä¸€å †å˜é‡æ˜¯ä¸ºäº†ç¨‹åºç¼–è¯‘çš„æ—¶å€™ç¡®ä¿è¿™äº›åŒ…æ˜¯æ­£ç¡®çš„ï¼Œå¦‚æœåŒ…ä¸å­˜åœ¨æˆ–è€…è¿™äº›å®šä¹‰çš„åŒ…å˜é‡ä¸å­˜åœ¨éƒ½ä¼šç¼–è¯‘å¤±è´¥
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;// This is a compile-time assertion to ensure that this generated file&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;// is compatible with the galaxy package it is being compiled against.&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// åªè¦è°ƒç”¨è¿™ä¸ª Ident æ–¹æ³• å°±ä¼šè‡ªåŠ¨å†™å…¥åˆ° import ä¸­ ï¼Œæ‰€ä»¥å¦‚æœå¯¹ import çš„åŒ…åæ²¡æœ‰ç‰¹æ®Šè¦æ±‚ï¼Œé‚£å°±ç›´æ¥ä½¿ç”¨ Ident
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;var _ &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">contextPackage&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Ident&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Context&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="c1">// åƒæˆ‘è‡ªå·±è‡ªå®šä¹‰ import çš„åŒ…å°±ä¸è¦ä½¿ç”¨ Ident æ–¹æ³•ï¼Œå¦åˆ™ç”Ÿæˆçš„ä»£ç æ–‡ä»¶é‡Œæœ‰ä¸¤ä¸ªåŒä¸€ä¸ªåŒ…çš„å¼•å…¥å¯¼è‡´è¯­æ³•é”™è¯¯
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">switch&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">gp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RouterEngine&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="s">&amp;#34;gin&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;const _ = &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;gin.&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;Version&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="s">&amp;#34;iris&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;const _ = &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;iris.&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;Version&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="c1">// åˆ°è¿™é‡Œæˆ‘ä»¬å°±æŠŠåŒ…å import å’Œå˜é‡å†™å…¥æˆåŠŸäº†ï¼Œå‰©ä¸‹çš„å°±æ˜¯é’ˆå¯¹ rpc service ç”Ÿæˆå¯¹åº”çš„ handler
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">service&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Services&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">genService&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">gen&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">file&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">g&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">service&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">gp&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// rpc service ä¿¡æ¯
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">serviceDesc&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">ServiceType&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="c1">// Greeter
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">ServiceName&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="c1">// helloworld.Greeter
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Metadata&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="c1">// api/helloworld/helloworld.proto
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">GenValidate&lt;/span> &lt;span class="kt">bool&lt;/span>
&lt;span class="nx">Methods&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">methodDesc&lt;/span>
&lt;span class="nx">MethodSets&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">methodDesc&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// rpc æ–¹æ³•ä¿¡æ¯
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">methodDesc&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// method
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Name&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="nx">Num&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;span class="nx">Request&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="nx">Reply&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="c1">// http_rule
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Path&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="nx">Method&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="nx">CamelCaseMethod&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="nx">HasVars&lt;/span> &lt;span class="kt">bool&lt;/span>
&lt;span class="nx">HasBody&lt;/span> &lt;span class="kt">bool&lt;/span>
&lt;span class="nx">Body&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="nx">ResponseBody&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// ç”Ÿæˆ service ç›¸å…³ä»£ç 
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">genService&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">gen&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">protogen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Plugin&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">file&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">protogen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">File&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">g&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">protogen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GeneratedFile&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">service&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">protogen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Service&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">gp&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">GenParam&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">service&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Desc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Options&lt;/span>&lt;span class="p">().(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">descriptorpb&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ServiceOptions&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">GetDeprecated&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;//&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">deprecationComment&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// HTTP Server.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// æœåŠ¡çš„ä¸»è¦å˜é‡ï¼Œæ¯”å¦‚æœåŠ¡å æœåŠ¡ç±»å‹ç­‰
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">sd&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">serviceDesc&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">ServiceType&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">service&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GoName&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">ServiceName&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">string&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">service&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Desc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">FullName&lt;/span>&lt;span class="p">()),&lt;/span>
&lt;span class="nx">Metadata&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Desc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Path&lt;/span>&lt;span class="p">(),&lt;/span>
&lt;span class="nx">GenValidate&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">gp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GenValidateCode&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// å¼€å§‹éå†æœåŠ¡çš„æ–¹æ³•
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">method&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">service&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Methods&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// ä¸å¤„ç†
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">method&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Desc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">IsStreamingClient&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nx">method&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Desc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">IsStreamingServer&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">continue&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// annotations è¿™ä¸ªå°±æ˜¯æˆ‘ä»¬åœ¨ rpc æ–¹æ³•é‡Œ option é‡Œå®šä¹‰çš„ http è·¯ç”±
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">rule&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">proto&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetExtension&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">method&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Desc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Options&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nx">annotations&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">E_Http&lt;/span>&lt;span class="p">).(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">annotations&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HttpRule&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">rule&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">bind&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">rule&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">AdditionalBindings&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// æ‹¿åˆ° optioné‡Œå®šä¹‰çš„è·¯ç”±ï¼Œ http methodç­‰ä¿¡æ¯
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">sd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Methods&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">sd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Methods&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nf">buildHTTPRule&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">g&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">method&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">bind&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">sd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Methods&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">sd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Methods&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nf">buildHTTPRule&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">g&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">method&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">rule&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">gp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Omitempty&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">path&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/%s/%s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">service&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Desc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">FullName&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nx">method&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Desc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Name&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="nx">sd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Methods&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">sd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Methods&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nf">buildMethodDesc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">g&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">method&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;POST&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">path&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// æ‹¿åˆ°äº† n ä¸ª rpc æ–¹æ³•ï¼Œå¼€å§‹ç”Ÿæˆäº†
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">sd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Methods&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// æ¸²æŸ“
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">P&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">sd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">execute&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">gp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RouterEngine&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// æ£€æŸ¥æ˜¯å¦æœ‰ http è§„åˆ™ å³
&lt;/span>&lt;span class="c1">// option (google.api.http) = {
&lt;/span>&lt;span class="c1">// get: &amp;#34;/user/query&amp;#34;
&lt;/span>&lt;span class="c1">// };
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">hasHTTPRule&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">services&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">protogen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Service&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">bool&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">service&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">services&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">method&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">service&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Methods&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">method&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Desc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">IsStreamingClient&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nx">method&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Desc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">IsStreamingServer&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">continue&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">rule&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">proto&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetExtension&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">method&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Desc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Options&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nx">annotations&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">E_Http&lt;/span>&lt;span class="p">).(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">annotations&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HttpRule&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">rule&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// è§£æ http è§„åˆ™ï¼Œè¯»å–å†…å®¹
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">buildHTTPRule&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">g&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">protogen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GeneratedFile&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">m&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">protogen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Method&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">rule&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">annotations&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HttpRule&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">methodDesc&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="nx">path&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="nx">method&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="nx">body&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="nx">responseBody&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="c1">// è¯»å– è·¯ç”±å’Œæ–¹æ³•
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">switch&lt;/span> &lt;span class="nx">pattern&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">rule&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Pattern&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="kd">type&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">annotations&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HttpRule_Get&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">path&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">pattern&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Get&lt;/span>
&lt;span class="nx">method&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">&amp;#34;GET&amp;#34;&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">annotations&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HttpRule_Put&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">path&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">pattern&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Put&lt;/span>
&lt;span class="nx">method&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">&amp;#34;PUT&amp;#34;&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">annotations&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HttpRule_Post&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">path&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">pattern&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Post&lt;/span>
&lt;span class="nx">method&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">&amp;#34;POST&amp;#34;&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">annotations&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HttpRule_Delete&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">path&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">pattern&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Delete&lt;/span>
&lt;span class="nx">method&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">&amp;#34;DELETE&amp;#34;&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">annotations&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HttpRule_Patch&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">path&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">pattern&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Patch&lt;/span>
&lt;span class="nx">method&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">&amp;#34;PATCH&amp;#34;&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">annotations&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HttpRule_Custom&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">path&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">pattern&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Custom&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Path&lt;/span>
&lt;span class="nx">method&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">pattern&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Custom&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Kind&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">body&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">rule&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Body&lt;/span>
&lt;span class="nx">responseBody&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">rule&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ResponseBody&lt;/span>
&lt;span class="nx">md&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">buildMethodDesc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">g&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">method&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">path&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">method&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s">&amp;#34;GET&amp;#34;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">md&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HasBody&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">body&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s">&amp;#34;*&amp;#34;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">md&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HasBody&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;span class="nx">md&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Body&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">body&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">md&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HasBody&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;span class="nx">md&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Body&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">&amp;#34;.&amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="nf">camelCaseVars&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">body&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">md&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HasBody&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">responseBody&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s">&amp;#34;*&amp;#34;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">md&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ResponseBody&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">responseBody&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">md&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ResponseBody&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">&amp;#34;.&amp;#34;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="nf">camelCaseVars&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">responseBody&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">md&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// æ„å»º æ¯ä¸ªæ–¹æ³•çš„åŸºç¡€ä¿¡æ¯
&lt;/span>&lt;span class="c1">// åˆ°è¿™é‡Œæˆ‘ä»¬æ‹¿åˆ°äº† æˆ‘ä»¬éœ€è¦ç”Ÿæˆä¸€ä¸ª handler çš„æ‰€æœ‰ä¿¡æ¯
&lt;/span>&lt;span class="c1">// åç§°ï¼Œè¾“å…¥ï¼Œè¾“å‡ºï¼Œæ–¹æ³•ç±»å‹ï¼Œè·¯ç”±
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">buildMethodDesc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">g&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">protogen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GeneratedFile&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">m&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">protogen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Method&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">method&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">path&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">methodDesc&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nx">methodSets&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GoName&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">}()&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">methodDesc&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">Name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GoName&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Num&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">methodSets&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GoName&lt;/span>&lt;span class="p">],&lt;/span>
&lt;span class="nx">Request&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">QualifiedGoIdent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Input&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GoIdent&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="c1">// rpc æ–¹æ³•ä¸­çš„ request
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Reply&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">g&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">QualifiedGoIdent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Output&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GoIdent&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="c1">// rpc æ–¹æ³•ä¸­çš„ response
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Path&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">path&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Method&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">method&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">CamelCaseMethod&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nf">camelCase&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">strings&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ToLower&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">method&lt;/span>&lt;span class="p">)),&lt;/span>
&lt;span class="nx">HasVars&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nf">buildPathVars&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">path&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// å¤„ç† è·¯ç”±ä¸­ /api/user/{name} è¿™ç§æƒ…å†µ
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">buildPathVars&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">method&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">protogen&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Method&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">path&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">res&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">strings&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Split&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">path&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;/&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">strings&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">HasPrefix&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">v&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;{&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nx">strings&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">HasSuffix&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">v&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;}&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">name&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">strings&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">TrimRight&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">strings&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">TrimLeft&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">v&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;{&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="s">&amp;#34;}&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">res&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">res&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">name&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="æ¨¡æ¿æ¸²æŸ“">æ¨¡æ¿æ¸²æŸ“&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// execute æ–¹æ³•å®ç°ä¹Ÿå…¶å®ä¸å¤æ‚ï¼Œæ€»èµ·æ¥å°±æ˜¯ go çš„ temple åŒ…çš„ä½¿ç”¨
&lt;/span>&lt;span class="c1">// æå‰å†™å¥½æ¨¡æ¿æ–‡ä»¶ï¼Œç„¶åæ‹¿åˆ°æ‰€æœ‰éœ€è¦çš„å˜é‡ï¼Œè¿›è¡Œæ¨¡æ¿æ¸²æŸ“ï¼Œå†™å…¥æ–‡ä»¶
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">serviceDesc&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">execute&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">routerEngine&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="nx">name&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">routerEngine&lt;/span>
&lt;span class="nx">tmp&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="k">switch&lt;/span> &lt;span class="nx">routerEngine&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="s">&amp;#34;gin&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">tmp&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">ginTemplate&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="s">&amp;#34;iris&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">tmp&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">irisTemplate&lt;/span>
&lt;span class="k">default&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;unknown http engine&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">MethodSets&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">methodDesc&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">m&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Methods&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">MethodSets&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Name&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">m&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">buf&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">bytes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Buffer&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">tmpl&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">template&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">Parse&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">strings&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">TrimSpace&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">tmp&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">tmpl&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Execute&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">strings&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Trim&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">String&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="s">&amp;#34;\r\n&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="æ¨¡æ¿å†…å®¹">æ¨¡æ¿å†…å®¹&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">
&lt;span class="kd">var&lt;/span> &lt;span class="nx">ginTemplate&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">`
&lt;/span>&lt;span class="s">&lt;/span>&lt;span class="cp">{{&lt;/span>&lt;span class="nx">$svrType&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">:=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="na">.ServiceType&lt;/span>&lt;span class="cp">}}&lt;/span>&lt;span class="s">
&lt;/span>&lt;span class="s">&lt;/span>&lt;span class="cp">{{&lt;/span>&lt;span class="nx">$svrName&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">:=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="na">.ServiceName&lt;/span>&lt;span class="cp">}}&lt;/span>&lt;span class="s">
&lt;/span>&lt;span class="s">&lt;/span>&lt;span class="cp">{{&lt;/span>&lt;span class="nx">$validate&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">:=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="na">.GenValidate&lt;/span>&lt;span class="cp">}}&lt;/span>&lt;span class="s">
&lt;/span>&lt;span class="s">// è¿™é‡Œå®šä¹‰ handler interface
&lt;/span>&lt;span class="s">type &lt;/span>&lt;span class="cp">{{&lt;/span>&lt;span class="na">.ServiceType&lt;/span>&lt;span class="cp">}}&lt;/span>&lt;span class="s">HTTPHandler interface {
&lt;/span>&lt;span class="s">&lt;/span>&lt;span class="cp">{{-&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">range&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="na">.MethodSets&lt;/span>&lt;span class="cp">}}&lt;/span>&lt;span class="s">
&lt;/span>&lt;span class="s"> &lt;/span>&lt;span class="cp">{{&lt;/span>&lt;span class="na">.Name&lt;/span>&lt;span class="cp">}}&lt;/span>&lt;span class="s">(context.Context, *&lt;/span>&lt;span class="cp">{{&lt;/span>&lt;span class="na">.Request&lt;/span>&lt;span class="cp">}}&lt;/span>&lt;span class="s">, *&lt;/span>&lt;span class="cp">{{&lt;/span>&lt;span class="na">.Reply&lt;/span>&lt;span class="cp">}}&lt;/span>&lt;span class="s">) error
&lt;/span>&lt;span class="s">&lt;/span>&lt;span class="cp">{{-&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">end&lt;/span>&lt;span class="cp">}}&lt;/span>&lt;span class="s">
&lt;/span>&lt;span class="s">}
&lt;/span>&lt;span class="s">
&lt;/span>&lt;span class="s">// Register&lt;/span>&lt;span class="cp">{{&lt;/span>&lt;span class="na">.ServiceType&lt;/span>&lt;span class="cp">}}&lt;/span>&lt;span class="s">HTTPHandler define http router handle by gin.
&lt;/span>&lt;span class="s">// æ³¨å†Œè·¯ç”± handler
&lt;/span>&lt;span class="s">func Register&lt;/span>&lt;span class="cp">{{&lt;/span>&lt;span class="na">.ServiceType&lt;/span>&lt;span class="cp">}}&lt;/span>&lt;span class="s">HTTPHandler(g *gin.RouterGroup, srv &lt;/span>&lt;span class="cp">{{&lt;/span>&lt;span class="na">.ServiceType&lt;/span>&lt;span class="cp">}}&lt;/span>&lt;span class="s">HTTPHandler) {
&lt;/span>&lt;span class="s"> &lt;/span>&lt;span class="cp">{{-&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">range&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="na">.Methods&lt;/span>&lt;span class="cp">}}&lt;/span>&lt;span class="s">
&lt;/span>&lt;span class="s"> g.&lt;/span>&lt;span class="cp">{{&lt;/span>&lt;span class="na">.Method&lt;/span>&lt;span class="cp">}}&lt;/span>&lt;span class="s">(&amp;#34;&lt;/span>&lt;span class="cp">{{&lt;/span>&lt;span class="na">.Path&lt;/span>&lt;span class="cp">}}&lt;/span>&lt;span class="s">&amp;#34;, _&lt;/span>&lt;span class="cp">{{&lt;/span>&lt;span class="nx">$svrType&lt;/span>&lt;span class="cp">}}&lt;/span>&lt;span class="s">_&lt;/span>&lt;span class="cp">{{&lt;/span>&lt;span class="na">.Name&lt;/span>&lt;span class="cp">}}{{&lt;/span>&lt;span class="na">.Num&lt;/span>&lt;span class="cp">}}&lt;/span>&lt;span class="s">_HTTP_Handler(srv))
&lt;/span>&lt;span class="s"> &lt;/span>&lt;span class="cp">{{-&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">end&lt;/span>&lt;span class="cp">}}&lt;/span>&lt;span class="s">
&lt;/span>&lt;span class="s">}
&lt;/span>&lt;span class="s">
&lt;/span>&lt;span class="s">// å®šä¹‰ handler
&lt;/span>&lt;span class="s">// éå†ä¹‹å‰è§£æåˆ°æ‰€æœ‰ rpc æ–¹æ³•ä¿¡æ¯
&lt;/span>&lt;span class="s">&lt;/span>&lt;span class="cp">{{&lt;/span>&lt;span class="k">range&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="na">.Methods&lt;/span>&lt;span class="cp">}}&lt;/span>&lt;span class="s">
&lt;/span>&lt;span class="s">func _&lt;/span>&lt;span class="cp">{{&lt;/span>&lt;span class="nx">$svrType&lt;/span>&lt;span class="cp">}}&lt;/span>&lt;span class="s">_&lt;/span>&lt;span class="cp">{{&lt;/span>&lt;span class="na">.Name&lt;/span>&lt;span class="cp">}}{{&lt;/span>&lt;span class="na">.Num&lt;/span>&lt;span class="cp">}}&lt;/span>&lt;span class="s">_HTTP_Handler(srv &lt;/span>&lt;span class="cp">{{&lt;/span>&lt;span class="nx">$svrType&lt;/span>&lt;span class="cp">}}&lt;/span>&lt;span class="s">HTTPHandler) func(c *gin.Context) {
&lt;/span>&lt;span class="s"> return func(c *gin.Context) {
&lt;/span>&lt;span class="s"> var (
&lt;/span>&lt;span class="s"> in = new(&lt;/span>&lt;span class="cp">{{&lt;/span>&lt;span class="na">.Request&lt;/span>&lt;span class="cp">}}&lt;/span>&lt;span class="s">)
&lt;/span>&lt;span class="s"> out = new(&lt;/span>&lt;span class="cp">{{&lt;/span>&lt;span class="na">.Reply&lt;/span>&lt;span class="cp">}}&lt;/span>&lt;span class="s">)
&lt;/span>&lt;span class="s"> ctx = middleware.GetContextFromGinCtx(c)
&lt;/span>&lt;span class="s"> )
&lt;/span>&lt;span class="s">
&lt;/span>&lt;span class="s"> if err := c.ShouldBind(in&lt;/span>&lt;span class="cp">{{&lt;/span>&lt;span class="na">.Body&lt;/span>&lt;span class="cp">}}&lt;/span>&lt;span class="s">); err != nil {
&lt;/span>&lt;span class="s"> c.AbortWithStatusJSON(400, gin.H{&amp;#34;err&amp;#34;: err.Error()})
&lt;/span>&lt;span class="s"> return
&lt;/span>&lt;span class="s"> }
&lt;/span>&lt;span class="s">
&lt;/span>&lt;span class="s"> // è¿™é‡Œå°±æ˜¯æœ€å¼€å§‹æåˆ°çš„åˆ¤æ–­æ˜¯å¦å¯ç”¨ validate
&lt;/span>&lt;span class="s"> // å…¶ä¸­è¿™ä¸ª api.Validator æ¥å£åªæœ‰ä¸€ä¸ªæ–¹æ³• Validate() error
&lt;/span>&lt;span class="s"> // æ‰€ä»¥éœ€è¦åœ¨ä¸€ä¸ªç»Ÿä¸€çš„åœ°æ–¹å®šä¹‰å¥½å¼•å…¥ä½¿ç”¨ï¼Œå»ºè®®ä¸è¦åœ¨ç”Ÿæˆçš„æ—¶å€™å†™å…¥ï¼Œå› ä¸ºè¿™ä¸ªæ˜¯é€šç”¨çš„ interface{}
&lt;/span>&lt;span class="s"> &lt;/span>&lt;span class="cp">{{&lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nx">$validate&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="cp">-}}&lt;/span>&lt;span class="s">
&lt;/span>&lt;span class="s"> // check param
&lt;/span>&lt;span class="s"> if v, ok := interface{}(in).(api.Validator);ok {
&lt;/span>&lt;span class="s"> if err := v.Validate();err != nil {
&lt;/span>&lt;span class="s"> c.AbortWithStatusJSON(400, gin.H{&amp;#34;err&amp;#34;: err.Error()})
&lt;/span>&lt;span class="s"> return
&lt;/span>&lt;span class="s"> }
&lt;/span>&lt;span class="s"> }
&lt;/span>&lt;span class="s"> &lt;/span>&lt;span class="cp">{{&lt;/span>&lt;span class="k">end&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="cp">-}}&lt;/span>&lt;span class="s">
&lt;/span>&lt;span class="s">
&lt;/span>&lt;span class="s"> // æ‰§è¡Œæ–¹æ³•
&lt;/span>&lt;span class="s"> err := srv.&lt;/span>&lt;span class="cp">{{&lt;/span>&lt;span class="na">.Name&lt;/span>&lt;span class="cp">}}&lt;/span>&lt;span class="s">(ctx, in, out)
&lt;/span>&lt;span class="s"> if err != nil {
&lt;/span>&lt;span class="s"> c.AbortWithStatusJSON(500, gin.H{&amp;#34;err&amp;#34;: err.Error()})
&lt;/span>&lt;span class="s"> return
&lt;/span>&lt;span class="s"> }
&lt;/span>&lt;span class="s">
&lt;/span>&lt;span class="s"> c.JSON(200, out)
&lt;/span>&lt;span class="s"> }
&lt;/span>&lt;span class="s">}
&lt;/span>&lt;span class="s">&lt;/span>&lt;span class="cp">{{&lt;/span>&lt;span class="k">end&lt;/span>&lt;span class="cp">}}&lt;/span>&lt;span class="s">
&lt;/span>&lt;span class="s">`&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>iris çš„æ¨¡æ¿åŸºæœ¬ç±»ä¼¼ã€‚&lt;/p>
&lt;p>åˆ°è¿™é‡Œä»£ç éƒ¨åˆ†å®Œå…¨ç»“æŸï¼Œåšä¸€ä¸ªç®€å•çš„æ€»ç»“ï¼š&lt;/p>
&lt;ol>
&lt;li>
&lt;p>æ„æ€éœ€æ±‚ï¼Œå³æˆ‘éœ€è¦ä»€ä¹ˆæ ·çš„æ’ä»¶ï¼Œå®ƒéœ€è¦ç»™æˆ‘ç”Ÿæˆä»€ä¹ˆçš„ä»£ç å—ï¼Ÿ&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æ ¹æ®éœ€æ±‚å…ˆè‡ªå·±å†™ä¸€ä¸ªé¢„æœŸä»£ç ï¼Œç„¶åæŠŠè¿™ä»½ä»£ç æ‹†è§£æˆä¸€ä¸ªæ¨¡æ¿ï¼Œæå–é‡Œé¢çš„å¯ä»¥æ¸²æŸ“çš„å˜é‡ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æ¨¡æ¿é‡Œå¯ä»¥æœ‰é€»è¾‘ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥åšä¸€äº›å‚æ•°æ ¡éªŒçš„æ–¹å¼ï¼Œç”Ÿæˆä¸åŒçš„ä»£ç ï¼Œæ¯”å¦‚é’ˆå¯¹ä¸åŒçš„ http æ–¹æ³•ï¼Œåšä¸åŒçš„å¤„ç†ï¼Œé’ˆå¯¹ä¸åŒçš„æ’ä»¶å‚æ•°ç”Ÿæˆä¸åŒçš„ä»£ç å—ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ç¨‹åºå…¥å£åˆ°æ¸²æŸ“æ–‡ä»¶å‰è¿™æ®µä»£ç ï¼ŒåŸºæœ¬éƒ½ç”¨ &lt;code>protogen&lt;/code> åŒ…æä¾›çš„æ–¹æ³•ï¼Œå¯ä»¥å¯¹è¿™ä¸ªåŒ…åšä¸€äº›è°ƒç ”é˜…è¯»æ–‡æ¡£ï¼Œçœ‹çœ‹å®ƒéƒ½æä¾›ä»€ä¹ˆèƒ½åŠ›, è¯´ä¸å®šå¯ä»¥å°‘èµ°å¾ˆå¤šå¼¯è·¯ã€‚&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>åŸºæœ¬å°±è¿™äº›äº†ï¼Œæˆ‘ä¹Ÿæ˜¯å„ç§ç¢ç£¨ç¢ç£¨å‡ºæ¥çš„ï¼Œå»ºè®®å¤§å®¶å¤šåŠ¨æ‰‹ï¼Œåªè¦ä¸å†™æ°¸è¿œå­¦ä¸åˆ°ç²¾é«“ã€‚&lt;/p></content><category scheme="https://yusank.github.io/categories/%E6%8A%80%E6%9C%AF/" term="æŠ€æœ¯" label="æŠ€æœ¯"/><category scheme="https://yusank.github.io/categories/protobuf/" term="protobuf" label="protobuf"/><category scheme="https://yusank.github.io/tags/go/" term="go" label="go"/><category scheme="https://yusank.github.io/tags/grpc/" term="grpc" label="grpc"/><category scheme="https://yusank.github.io/tags/protoc/" term="protoc" label="protoc"/></entry><entry><title type="text">å¦‚ä½•ç¼–å†™è‡ªå·±çš„ç¬¬ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·</title><link rel="alternate" type="text/html" href="https://yusank.github.io/posts/go-cobra/"/><id>https://yusank.github.io/posts/go-cobra/</id><updated>2021-09-18T06:24:55+00:00</updated><published>2021-06-30T18:22:00+08:00</published><author><name>yusank</name><uri>https://yusank.github.io/</uri><email>yusankurban@gmail.com</email></author><summary type="html">å…³äºå¦‚ä½•ç”¨ go è¯­è¨€ç¼–å†™ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ã€‚è¿™é‡Œä¼šåŸºäº cobra å¼€æºåº“è¿›è¡Œå¼€å‘ã€‚cobra ä½œä¸ºä¸€â€¦â€¦</summary><content type="html">&lt;p>å…³äºå¦‚ä½•ç”¨ go è¯­è¨€ç¼–å†™ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ã€‚è¿™é‡Œä¼šåŸºäº &lt;code>cobra&lt;/code> å¼€æºåº“è¿›è¡Œå¼€å‘ã€‚&lt;code>cobra&lt;/code> ä½œä¸ºä¸€ä¸ªéå¸¸æœ‰åçš„å‘½ä»¤è¡Œå·¥å…·åº“ï¼Œè¢«å¾ˆå¤šå¼€æºé¡¹ç›®å¼•å…¥ä½¿ç”¨ï¼Œå¾ˆå¤šå‘½ä»¤è¡Œå·¥å…·éƒ½èƒ½çœ‹åˆ° &lt;code>cobra&lt;/code> çš„èº«å½±ã€‚&lt;code>cobra&lt;/code> æä¾›ä¸€ä¸ªå®Œæ•´çš„å‘½ä»¤è¡Œçš„å·¥å…·çš„æ‰€éœ€çš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬å‘½ä»¤å®šä¹‰ã€å‘½ä»¤æ‰©å±•ã€è¯»å–å‚æ•°ç­‰ã€‚ä¸‹é¢æˆ‘ä»¬ä»¥å¼€å‘ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·çš„æµç¨‹ä¸€æ­¥æ­¥å­¦ä¹ å¦‚ä½•ä½¿ç”¨ &lt;code>cobra&lt;/code> å¼€å‘ä¸€ä¸ªè‡ªå·±çš„å‘½ä»¤è¡Œå·¥å…·ã€‚&lt;/p>
&lt;h2 id="åˆ›å»ºæ ¹å‘½ä»¤">åˆ›å»ºæ ¹å‘½ä»¤&lt;/h2>
&lt;p>æˆ‘ä»¬é¡¹ç›®æš‚ä¸”å°±å« &lt;code>myCmd&lt;/code>, æˆ‘ä»¬æœ¬åœ°åˆ›å»ºä¸€ä¸ªgoé¡¹ç›®å°±å« &lt;code>myCmd&lt;/code>ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ mkdir myCmd
$ &lt;span class="nb">cd&lt;/span> myCmd
$ touch main.go
$ go mod init myCmd
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>main.go&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;log&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/spf13/cobra&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="c1">// å®šä¹‰ä¸»å‘½ä»¤
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">rootCmd&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">cobra&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Command&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">Use&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;myCmd&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Short&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;è¿™é‡Œæ˜¯å¯¹å‘½ä»¤çš„ç®€çŸ­ä»‹ç»&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Long&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">`è¿™é‡Œå¯ä»¥æ”¾å¯¹å‘½ä»¤çš„è¯¦ç»†ä»‹ç»ã€‚
&lt;/span>&lt;span class="s">å¯ä»¥å¤šè¡Œ`&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Example&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;myCmd help&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">// ä½¿ç”¨ç¤ºä¾‹
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Version&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;v0.0.1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">// å®šä¹‰ç‰ˆæœ¬
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">dirPath&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">init&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// å®šä¹‰å‚æ•°ï¼Œå³ä»å‘½ä»¤è¡Œè¯»å–çš„å‚æ•°å˜é‡
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// é™¤äº† PersistentFlags å¤–ï¼Œä¹Ÿå¯ä»¥ç”¨ Flags()ï¼ŒåŒºåˆ«æ˜¯ å‰ä¸€ä¸ªå¯ä»¥åœ¨å…¶å­å‘½ä»¤ä¹Ÿå¯ä»¥ç”¨ï¼Œåä¸€ä¸ªä¸èƒ½ã€‚å³PersistentFlagsæ˜¯ä¸€ä¸ªå…¨å±€çš„flagæ³¨å†Œã€‚
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">rootCmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">PersistentFlags&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">StringVarP&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">dirPath&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;dir&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;d&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;.&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;æ–‡ä»¶è·¯å¾„&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">rootCmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Execute&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Fatal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¿™æ ·æˆ‘ä»¬å°±åˆ›å»ºäº†ä¸€ä¸ªå±äºçš„è‡ªå·±çš„å‘½ä»¤ï¼Œæ‰§è¡Œçœ‹ä¸€ä¸‹æ•ˆæœã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># ç›´æ¥æ‰§è¡Œ,ä¼šæ‰“å° å­—æ®µLongçš„å€¼ï¼Œ&lt;/span>
âœ./myCmd
è¿™é‡Œå¯ä»¥æ”¾å¯¹å‘½ä»¤çš„è¯¦ç»†ä»‹ç»ã€‚
å¯ä»¥å¤šè¡Œ
&lt;span class="c1"># æ‰“å°ç‰ˆæœ¬&lt;/span>
âœ./myCmd -v
myCmd version v0.0.1
&lt;span class="c1"># è¾“å…¥æœªçŸ¥ flag&lt;/span>
âœ./myCmd -x
Error: unknown shorthand flag: &lt;span class="s1">&amp;#39;x&amp;#39;&lt;/span> in -x
Usage:
Examples:
myCmd &lt;span class="nb">help&lt;/span>
Flags:
-d, --dir string æ–‡ä»¶è·¯å¾„ &lt;span class="o">(&lt;/span>default &lt;span class="s2">&amp;#34;.&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
-h, --help &lt;span class="nb">help&lt;/span> &lt;span class="k">for&lt;/span> myCmd
-v, --version version &lt;span class="k">for&lt;/span> myCmd
2021/07/04 15:18:59 unknown shorthand flag: &lt;span class="s1">&amp;#39;x&amp;#39;&lt;/span> in -x
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¸éš¾å‘ç°ï¼Œç‰ˆæœ¬å¤„ç†ï¼ŒæœªçŸ¥å‚æ•°å¤„ç†ç­‰æƒ…å†µ cobraå·²ç»åšäº†ç›¸å¯¹å®Œå–„çš„å¤„ç†ï¼Œæˆ‘ä»¬ä¸éœ€è¦åšå¤ªå¤šçš„é”™è¯¯å¤„ç†ã€‚&lt;/p>
&lt;p>ç›®å‰æœªçŸ¥ï¼Œæˆ‘ä»¬çš„çš„å‘½ä»¤åªæ˜¯å®šä¹‰äº†å‘½ä»¤ï¼Œå¹¶æ²¡æœ‰æ‰§è¡Œä»»ä½•æŒ‡ä»¤ï¼Œä¸‹é¢æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªç®€å•çš„æ‰§è¡Œå‡½æ•°ã€‚&lt;code>cobra.Command&lt;/code> æœ‰å¾ˆå¤šå‚æ•°å¯ä»¥å®šä¹‰æ‰§è¡Œå‡½æ•°çš„ï¼Œæˆ‘ä»¬ä»¥æœ€å¸¸ç”¨çš„çš„ &lt;code>Run&lt;/code>ï¼Œ&lt;code>RunE&lt;/code> ä¸ºä¾‹ï¼Œåˆ†åˆ«æ˜¯ä¸è¿”å›é”™è¯¯å’Œè¿”å›é”™è¯¯çš„å‡½æ•°å®šä¹‰ã€‚&lt;/p>
&lt;p>å‡å¦‚æˆ‘ä»¬çš„ä¸»å‘½ä»¤æ‰§è¡Œä¸€ä¸ªæ‰“å° d å‚æ•°ä¼ å€¼çš„ç›®å½•çš„ä¿¡æ¯ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// rootCmd
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">RunE&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">printDirInfo&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="cm">/*
&lt;/span>&lt;span class="cm">...
&lt;/span>&lt;span class="cm">*/&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">printDirInfo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">cmd&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">cobra&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Command&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">args&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">info&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Stat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">dirPath&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;name:%s, size:%d modTime:%v \n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">info&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Name&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nx">info&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Size&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nx">info&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ModTime&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ‰§è¡Œä¸€ä¸‹å‘½ä»¤ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># æŸ¥çœ‹ä¸€ä¸‹ main æ–‡ä»¶çš„ä¿¡æ¯&lt;/span>
âœ./myCmd -d main.go
name:main.go, size:759 modTime:2021-07-04 15:26:43.311399368 +0800 CST
&lt;span class="c1"># æŸ¥çœ‹ä¸€ä¸ªä¸å­˜åœ¨çš„æ–‡ä»¶&lt;/span>
âœ./myCmd -d main.go1
Error: stat main.go1: no such file or directory
Usage:
myCmd &lt;span class="o">[&lt;/span>flags&lt;span class="o">]&lt;/span>
Examples:
myCmd &lt;span class="nb">help&lt;/span>
Flags:
-d, --dir string å‘½ä»¤æ‰§è¡Œç›®å½• &lt;span class="o">(&lt;/span>default &lt;span class="s2">&amp;#34;.&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
-h, --help &lt;span class="nb">help&lt;/span> &lt;span class="k">for&lt;/span> myCmd
-v, --version version &lt;span class="k">for&lt;/span> myCmd
2021/07/04 15:30:01 stat main.go1: no such file or directory
&lt;span class="c1"># ä¸ä»…æ‰“å°å‡ºé”™è¯¯ï¼Œå¦‚ä½•ä½¿ç”¨å‘½ä»¤ä¹Ÿä¼šåŒæ—¶æ‰“å°å‡ºæ¥&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¸‹é¢æˆ‘ä»¬å°±æ·»åŠ æˆ‘ä»¬çš„å­å‘½ä»¤ã€‚&lt;/p>
&lt;h2 id="æ·»åŠ å­å‘½ä»¤">æ·»åŠ å­å‘½ä»¤&lt;/h2>
&lt;p>æˆ‘ä»¬ç°åœ¨æ·»åŠ ä¸€ä¸ªå­å‘½ä»¤ï¼Œè¿™ä¸ªå­å‘½ä»¤çš„åŠŸèƒ½æ˜¯ç»Ÿè®¡å½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ä¿¡æ¯ï¼Œæˆ‘ä»¬å°±èµ·åå« &lt;code>stat&lt;/code>ã€‚åŒæ—¶ï¼Œä¸ºäº†æ–¹ä¾¿å…¨å±€å˜é‡çš„åœ¨ä¸åŒåŒ…å†…è¯»å–ï¼Œåˆ›å»ºä¸€ä¸ª &lt;code>variable&lt;/code> çš„ç›®å½•ï¼Œé‡Œé¢å­˜æ”¾å…¨å±€çš„ä¸€äº›å˜é‡ï¼ŒåŒ…å†…å˜é‡å°±æ”¾åˆ°å„è‡ªåŒ…å†…ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">âœ mkdir stat
âœ mkdir variable
âœ touch stat/stat.go
âœ touch variable/variable.go
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¸‹é¢æ˜¯statæ–‡ä»¶çš„å†…å®¹ã€‚&lt;/p>
&lt;p>stat.go&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">stat&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;myCmd/variable&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;os&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;path/filepath&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/spf13/cobra&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="nx">StatCmd&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">cobra&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Command&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">Use&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;stat&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Short&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;ç»Ÿè®¡ç›®å½•&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">RunE&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">statDir&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">isStatDir&lt;/span> &lt;span class="kt">bool&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">init&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// è¿™é‡Œä½¿ç”¨ Flags åªåœ¨æˆ‘è¿™ä¸ªå‘½ä»¤å†…è§£æå’Œè¯»å–
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">StatCmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Flags&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">BoolVarP&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">isStatDir&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;stat_dir&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;æ˜¯å¦ç»Ÿè®¡ç›®å½•ä¿¡æ¯&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">statDir&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">cmd&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">cobra&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Command&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">args&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">filepath&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Walk&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">variable&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DirPath&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">path&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">info&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">FileInfo&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">info&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">IsDir&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">isStatDir&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// ä¸ç»Ÿè®¡
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;path:%s, size:%d, modTime:%v&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">path&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">info&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Size&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nx">info&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ModTime&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">})&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç„¶åå°†è¯¥å­å‘½ä»¤æ³¨å†Œçš„ä¸»å‘½ä»¤ä¸‹ã€‚&lt;/p>
&lt;p>main.go&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;log&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;myCmd/stat&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;myCmd/variable&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;os&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/spf13/cobra&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="nx">rootCmd&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">cobra&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Command&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">Use&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;myCmd&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Short&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;è¿™é‡Œæ˜¯å¯¹å‘½ä»¤çš„ç®€çŸ­ä»‹ç»&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Long&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">`è¿™é‡Œå¯ä»¥æ”¾å¯¹å‘½ä»¤çš„è¯¦ç»†ä»‹ç»ã€‚
&lt;/span>&lt;span class="s">å¯ä»¥å¤šè¡Œ`&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Example&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;myCmd help&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">// ä½¿ç”¨ç¤ºä¾‹
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Version&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">variable&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Version&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="c1">// å…¨å±€å˜é‡å¸¸é‡éƒ½ç§»åˆ° variable ç›®å½•ä¸‹
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">RunE&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">printDirInfo&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">init&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">rootCmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">PersistentFlags&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">StringVarP&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">variable&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DirPath&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;dir&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;d&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;.&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;æ–‡ä»¶è·¯å¾„&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// æ³¨å†Œå‘½ä»¤
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">rootCmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">AddCommand&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">stat&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">StatCmd&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">printDirInfo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">cmd&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">cobra&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Command&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">args&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">info&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Stat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">variable&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DirPath&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;name:%s, size:%d modTime:%v \n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">info&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Name&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nx">info&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Size&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nx">info&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ModTime&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">rootCmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Execute&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Fatal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å†æ¬¡æ‰§è¡Œ &lt;code>help&lt;/code> æŸ¥çœ‹æˆ‘ä»¬çš„å‘½ä»¤ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">âœ./myCmd -h
è¿™é‡Œå¯ä»¥æ”¾å¯¹å‘½ä»¤çš„è¯¦ç»†ä»‹ç»ã€‚
å¯ä»¥å¤šè¡Œ
Usage:
myCmd &lt;span class="o">[&lt;/span>flags&lt;span class="o">]&lt;/span>
myCmd &lt;span class="o">[&lt;/span>command&lt;span class="o">]&lt;/span>
Examples:
myCmd &lt;span class="nb">help&lt;/span>
Available Commands:
&lt;span class="nb">help&lt;/span> Help about any &lt;span class="nb">command&lt;/span>
stat ç»Ÿè®¡ç›®å½•
Flags:
-d, --dir string æ–‡ä»¶è·¯å¾„ &lt;span class="o">(&lt;/span>default &lt;span class="s2">&amp;#34;.&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
-h, --help &lt;span class="nb">help&lt;/span> &lt;span class="k">for&lt;/span> myCmd
-v, --version version &lt;span class="k">for&lt;/span> myCmd
Use &lt;span class="s2">&amp;#34;myCmd [command] --help&amp;#34;&lt;/span> &lt;span class="k">for&lt;/span> more information about a command.
&lt;span class="c1"># æŸ¥çœ‹å­å‘½ä»¤help&lt;/span>
âœ./myCmd stat -h
ç»Ÿè®¡ç›®å½•
Usage:
myCmd stat &lt;span class="o">[&lt;/span>flags&lt;span class="o">]&lt;/span>
Flags:
-h, --help &lt;span class="nb">help&lt;/span> &lt;span class="k">for&lt;/span> stat
-s, --stat_dir æ˜¯å¦ç»Ÿè®¡ç›®å½•ä¿¡æ¯
Global Flags:
-d, --dir string æ–‡ä»¶è·¯å¾„ &lt;span class="o">(&lt;/span>default &lt;span class="s2">&amp;#34;.&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;span class="c1"># ç»Ÿè®¡&lt;/span>
âœ./myCmd stat -d .
path:go.mod, size:61, modTime:2021-07-04 15:03:33.339495852 +0800 CST
path:go.sum, size:56568, modTime:2021-07-04 15:03:33.339185898 +0800 CST
path:main.go, size:929, modTime:2021-07-04 15:55:07.206300444 +0800 CST
path:myCmd, size:4344056, modTime:2021-07-04 16:01:12.930132286 +0800 CST
path:stat/stat.go, size:691, modTime:2021-07-04 16:01:09.353487727 +0800 CST
path:variable/variable.go, size:73, modTime:2021-07-04 15:48:18.345134258 +0800 CST
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¸éš¾å‘ç°ï¼Œè¿™ä¸ªå­å‘½ä»¤å¯ä»¥æ— é™åµŒå¥—ï¼Œæˆ‘ä»¬å¯ä»¥æ‹¥æœ‰äºŒçº§ä¸‰çº§å­å‘½ä»¤ï¼Œèƒ½æ»¡è¶³æˆ‘ä»¬å„ç§å„æ ·å¥‡è‘©çš„éœ€æ±‚ï¼Œå­å‘½ä»¤å¯ä»¥å¤ç”¨å…¶ä¸Šçº§ç›®å½•çš„ flagå‚æ•°ã€‚&lt;/p>
&lt;h2 id="è‡ªä¸»æ›´æ–°">è‡ªä¸»æ›´æ–°&lt;/h2>
&lt;p>å‡å¦‚æˆ‘ä»¬å¼€å‘å‘½ä»¤ï¼Œå·²ç»å‘å¸ƒåˆ° GitHub ä¸Šï¼Œåˆ«äººå¯ä»¥ç®€å•çš„ &lt;code>go get&lt;/code> å‘½ä»¤å°±èƒ½å®‰è£…ä½¿ç”¨æˆ‘ä»¬çš„å‘½ä»¤ã€‚ä½†æ˜¯æˆ‘è¦æ˜¯å‘å¸ƒä¸€ä¸ªæ–°ç‰ˆæœ¬ï¼Œå¸Œæœ›ä½¿ç”¨çš„äººèƒ½çŸ¥é“æˆ‘çš„å‘½ä»¤å·¥å…·æœ‰æ–°ç‰ˆäº†è€Œä¸”è¦æ˜¯èƒ½æ–¹ä¾¿çš„æ›´æ–°åˆ°æœ€æ–°çš„ç‰ˆæœ¬æ˜¯ä¸æ˜¯ä¸€ä¸ªéå¸¸äººæ€§åŒ–çš„è®¾è®¡å‘¢ï¼Ÿ&lt;/p>
&lt;p>å…¶å®å®ç°èµ·æ¥ä¹Ÿä¸éš¾ï¼Œè¿™é‡ŒæŠ›å‡ºä¸ªæ€è·¯ã€‚å‡å¦‚æˆ‘ä»¬å‘½ä»¤æ¯æ¬¡æ‰§è¡Œçš„æ—¶å€™ï¼Œæˆ‘åšä¸€æ¬¡ç‰ˆæœ¬æ£€æŸ¥ï¼ˆä½†æ˜¯&lt;strong>å¼ºçƒˆä¸å»ºè®®&lt;/strong>æ¯æ¬¡éƒ½æ£€æŸ¥ï¼Œæœ€å¥½æœ¬åœ°åšä¸€ä¸ªä¸Šæ¬¡æ£€æŸ¥æ—¶é—´çš„ç¼“å­˜ï¼Œæœ€å¤šä¸€å¤©æ£€æŸ¥ä¸€æ¬¡ï¼Œå¦åˆ™ç”¨æˆ·ä½“éªŒéå¸¸ä¸å¥½ï¼‰ï¼Œå¦‚æœæœ‰æ–°çš„ç‰ˆæœ¬æˆ‘å°±æé†’ç”¨æˆ·ï¼Œç”šè‡³æˆ‘å¯ä»¥æ£€æŸ¥çš„æ—¶å€™æ‹‰è¿‡æ¥æ–°ç‰ˆæœ¬çš„ feature å±•ç°ç»™ç”¨æˆ·ï¼Œï¼Œç„¶åæä¾›ä¸€ä¸ª &lt;code>update&lt;/code> çš„å­å‘½ä»¤ï¼Œè‡ªæˆ‘æ›´æ–°ï¼Œè¿™ä½“éªŒæ˜¯ä¸æ˜¯å¬èµ·æ¥å°±å¾ˆä¸é”™å‘€ã€‚&lt;/p>
&lt;p>è‡³äº &lt;code>update&lt;/code> è¿™ä¸ªå­å‘½ä»¤å®ç°ä¹Ÿå¾ˆç®€å•ï¼Œå°è¯•æ‰§è¡Œä¸€æ¬¡ &lt;code>go get -u &amp;lt;myCmdRemoteURL&amp;gt;&lt;/code> å³å¯ï¼Œè™½ç„¶çœ‹èµ·æ¥æ˜¯å¯¹ &lt;code>go get&lt;/code> çš„ä¸€æ¬¡å°è£…ï¼Œä½†æ˜¯å¯¹äºç”¨æˆ·æ¥è¯´å°±å¾ˆç®€å•æ–¹ä¾¿ã€‚&lt;/p>
&lt;h2 id="å°å½©è›‹">å°å½©è›‹&lt;/h2>
&lt;p>åˆ°è¿™é‡Œæˆ‘ä»¬ä¸€ä¸ªå°å‘½ä»¤è¡Œå·¥å…·ä¹Ÿæœ‰æ¨¡æœ‰æ ·äº†ï¼Œä½†æ˜¯ç¼ºä¸€ä¸ªçµé­‚ï¼Œæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ&lt;/p>
&lt;p>å½“ç„¶æ˜¯&lt;/p>
&lt;p>å‘½ä»¤çš„ç‚«é…·çš„logoï¼ï¼ï¼&lt;/p>
&lt;p>å…ˆçœ‹æ•ˆæœå›¾ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># æ™®é€šç‰ˆæœ¬&lt;/span>
__ __ __ __ _____ __ __ _____
&lt;span class="p">|&lt;/span> &lt;span class="se">\/&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="se">\ \ &lt;/span> / / / ____&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="se">\/&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> __ &lt;span class="se">\ &lt;/span>
&lt;span class="p">|&lt;/span> &lt;span class="se">\ &lt;/span> / &lt;span class="p">|&lt;/span> &lt;span class="se">\ \_&lt;/span>/ / &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="se">\ &lt;/span> / &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>
&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>&lt;span class="se">\/&lt;/span>&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="se">\ &lt;/span> / &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>&lt;span class="se">\/&lt;/span>&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>
&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>____ &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>__&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>
&lt;span class="p">|&lt;/span>_&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>_&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>_&lt;span class="p">|&lt;/span> &lt;span class="se">\_&lt;/span>____&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>_&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>_&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>_____/
&lt;span class="c1"># æ–œä½“&lt;/span>
/&lt;span class="p">|&lt;/span> //&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="se">\\&lt;/span> / / // &lt;span class="o">)&lt;/span> &lt;span class="o">)&lt;/span> /&lt;span class="p">|&lt;/span> //&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> // &lt;span class="o">)&lt;/span> &lt;span class="o">)&lt;/span>
//&lt;span class="p">|&lt;/span> // &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="se">\\&lt;/span> / / // //&lt;span class="p">|&lt;/span> // &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> // / /
// &lt;span class="p">|&lt;/span> // &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="se">\\&lt;/span>/ / // // &lt;span class="p">|&lt;/span> // &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> // / /
// &lt;span class="p">|&lt;/span> // &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> / / // // &lt;span class="p">|&lt;/span> // &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> // / /
// &lt;span class="p">|&lt;/span>// &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> / / &lt;span class="o">((&lt;/span>____/ / // &lt;span class="p">|&lt;/span>// &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> //____/ /
&lt;span class="c1"># å¤¸å¼ ç‰ˆæœ¬&lt;/span>
_____ _____ _____ _____ _____
/&lt;span class="se">\ &lt;/span> &lt;span class="se">\ &lt;/span> &lt;span class="p">|&lt;/span>&lt;span class="se">\ &lt;/span> &lt;span class="se">\ &lt;/span> /&lt;span class="se">\ &lt;/span> &lt;span class="se">\ &lt;/span> /&lt;span class="se">\ &lt;/span> &lt;span class="se">\ &lt;/span> /&lt;span class="se">\ &lt;/span> &lt;span class="se">\ &lt;/span>
/::&lt;span class="se">\_&lt;/span>___&lt;span class="se">\ &lt;/span> &lt;span class="p">|&lt;/span>:&lt;span class="se">\_&lt;/span>___&lt;span class="se">\ &lt;/span> /::&lt;span class="se">\ &lt;/span> &lt;span class="se">\ &lt;/span> /::&lt;span class="se">\_&lt;/span>___&lt;span class="se">\ &lt;/span> /::&lt;span class="se">\ &lt;/span> &lt;span class="se">\ &lt;/span>
/::::&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>::&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> /::::&lt;span class="se">\ &lt;/span> &lt;span class="se">\ &lt;/span> /::::&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> /::::&lt;span class="se">\ &lt;/span> &lt;span class="se">\ &lt;/span>
/:::::&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>::&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> /::::::&lt;span class="se">\ &lt;/span> &lt;span class="se">\ &lt;/span> /:::::&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> /::::::&lt;span class="se">\ &lt;/span> &lt;span class="se">\ &lt;/span>
/::::::&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>::&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> /:::/&lt;span class="se">\:&lt;/span>::&lt;span class="se">\ &lt;/span> &lt;span class="se">\ &lt;/span> /::::::&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> /:::/&lt;span class="se">\:&lt;/span>::&lt;span class="se">\ &lt;/span> &lt;span class="se">\ &lt;/span>
/:::/&lt;span class="p">|&lt;/span>::&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>::&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> /:::/ &lt;span class="se">\:&lt;/span>::&lt;span class="se">\ &lt;/span> &lt;span class="se">\ &lt;/span> /:::/&lt;span class="p">|&lt;/span>::&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> /:::/ &lt;span class="se">\:&lt;/span>::&lt;span class="se">\ &lt;/span> &lt;span class="se">\ &lt;/span>
/:::/ &lt;span class="p">|&lt;/span>::&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>::&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> /:::/ &lt;span class="se">\:&lt;/span>::&lt;span class="se">\ &lt;/span> &lt;span class="se">\ &lt;/span> /:::/ &lt;span class="p">|&lt;/span>::&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> /:::/ &lt;span class="se">\:&lt;/span>::&lt;span class="se">\ &lt;/span> &lt;span class="se">\ &lt;/span>
/:::/ &lt;span class="p">|&lt;/span>::&lt;span class="p">|&lt;/span>___&lt;span class="p">|&lt;/span>______ &lt;span class="p">|&lt;/span>::&lt;span class="p">|&lt;/span>___&lt;span class="p">|&lt;/span>______ /:::/ / &lt;span class="se">\:&lt;/span>::&lt;span class="se">\ &lt;/span> &lt;span class="se">\ &lt;/span> /:::/ &lt;span class="p">|&lt;/span>::&lt;span class="p">|&lt;/span>___&lt;span class="p">|&lt;/span>______ /:::/ / &lt;span class="se">\:&lt;/span>::&lt;span class="se">\ &lt;/span> &lt;span class="se">\ &lt;/span>
/:::/ &lt;span class="p">|&lt;/span>::::::::&lt;span class="se">\ &lt;/span> &lt;span class="se">\ &lt;/span> /::::::::&lt;span class="se">\ &lt;/span> &lt;span class="se">\ &lt;/span> /:::/ / &lt;span class="se">\:&lt;/span>::&lt;span class="se">\ &lt;/span> &lt;span class="se">\ &lt;/span> /:::/ &lt;span class="p">|&lt;/span>::::::::&lt;span class="se">\ &lt;/span> &lt;span class="se">\ &lt;/span> /:::/ / &lt;span class="se">\:&lt;/span>::&lt;span class="se">\ &lt;/span>___&lt;span class="se">\ &lt;/span>
/:::/ &lt;span class="p">|&lt;/span>:::::::::&lt;span class="se">\_&lt;/span>___&lt;span class="se">\ &lt;/span> /::::::::::&lt;span class="se">\_&lt;/span>___&lt;span class="se">\/&lt;/span>:::/____/ &lt;span class="se">\:&lt;/span>::&lt;span class="se">\_&lt;/span>___&lt;span class="se">\/&lt;/span>:::/ &lt;span class="p">|&lt;/span>:::::::::&lt;span class="se">\_&lt;/span>___&lt;span class="se">\/&lt;/span>:::/____/ &lt;span class="se">\:&lt;/span>::&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>
&lt;span class="se">\:&lt;/span>:/ / ~~~~~/:::/ / /:::/~~~~/~~ &lt;span class="se">\:&lt;/span>::&lt;span class="se">\ &lt;/span> &lt;span class="se">\ &lt;/span> &lt;span class="se">\:&lt;/span>:/ /&lt;span class="se">\:&lt;/span>:/ / ~~~~~/:::/ /&lt;span class="se">\:&lt;/span>::&lt;span class="se">\ &lt;/span> &lt;span class="se">\ &lt;/span> /:::&lt;span class="p">|&lt;/span>____&lt;span class="p">|&lt;/span>
&lt;span class="se">\/&lt;/span>____/ /:::/ / /:::/ / &lt;span class="se">\:&lt;/span>::&lt;span class="se">\ &lt;/span> &lt;span class="se">\ &lt;/span> &lt;span class="se">\/&lt;/span>____/ &lt;span class="se">\/&lt;/span>____/ /:::/ / &lt;span class="se">\:&lt;/span>::&lt;span class="se">\ &lt;/span> &lt;span class="se">\ &lt;/span> /:::/ /
/:::/ / /:::/ / &lt;span class="se">\:&lt;/span>::&lt;span class="se">\ &lt;/span> &lt;span class="se">\ &lt;/span> /:::/ / &lt;span class="se">\:&lt;/span>::&lt;span class="se">\ &lt;/span> &lt;span class="se">\ &lt;/span>/:::/ /
/:::/ / /:::/ / &lt;span class="se">\:&lt;/span>::&lt;span class="se">\ &lt;/span> &lt;span class="se">\ &lt;/span> /:::/ / &lt;span class="se">\:&lt;/span>::&lt;span class="se">\ &lt;/span> /:::/ /
/:::/ / &lt;span class="se">\:&lt;/span>:/ / &lt;span class="se">\:&lt;/span>::&lt;span class="se">\ &lt;/span> &lt;span class="se">\ &lt;/span> /:::/ / &lt;span class="se">\:&lt;/span>::&lt;span class="se">\ &lt;/span> /:::/ /
/:::/ / &lt;span class="se">\/&lt;/span>____/ &lt;span class="se">\:&lt;/span>::&lt;span class="se">\ &lt;/span> &lt;span class="se">\ &lt;/span> /:::/ / &lt;span class="se">\:&lt;/span>::&lt;span class="se">\/&lt;/span>:::/ /
/:::/ / &lt;span class="se">\:&lt;/span>::&lt;span class="se">\ &lt;/span> &lt;span class="se">\ &lt;/span> /:::/ / &lt;span class="se">\:&lt;/span>:::::/ /
/:::/ / &lt;span class="se">\:&lt;/span>::&lt;span class="se">\_&lt;/span>___&lt;span class="se">\ &lt;/span> /:::/ / &lt;span class="se">\:&lt;/span>:::/ /
&lt;span class="se">\:&lt;/span>:/ / &lt;span class="se">\:&lt;/span>:/ / &lt;span class="se">\:&lt;/span>:/ / &lt;span class="se">\:&lt;/span>:/____/
&lt;span class="se">\/&lt;/span>____/ &lt;span class="se">\/&lt;/span>____/ &lt;span class="se">\/&lt;/span>____/ ~~
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æˆ‘éšæœºé€‰äº†å‡ ä¸ªä½œä¸ºæ¼”ç¤ºï¼Œ&lt;a href="https://www.colorschemer.com/ascii-art-generator">ç‚¹å‡»è¿™é‡Œè·³è½¬&lt;/a>åˆ¶ä½œè‡ªå·±å·¥å…·çš„logoï¼Œç„¶åå†ä¸»å‘½ä»¤æ³¨å†Œä¸€ä¸ª &lt;code>PreRun&lt;/code> çš„å‡½æ•°ï¼Œåœ¨è¯¥å‡½æ•°å†…æ‰“å°æˆ‘ä»¬çš„logoã€‚è¿™æ ·åœ¨ä¸»é€»è¾‘æ‰§è¡Œå‰ä¼šæ‰“å°æˆ‘ä»¬çš„logoï¼Œè¾¨è¯†åº¦ä¸€ä¸‹å­æé«˜å¾ˆå¤šã€‚&lt;/p>
&lt;p>å®é™…æ•ˆæœï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">âœ./myCmd -d main.go
__ __ __ __ _____ __ __ _____
&lt;span class="p">|&lt;/span> &lt;span class="se">\/&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="se">\ \ &lt;/span> / / / ____&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="se">\/&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> __ &lt;span class="se">\ &lt;/span>
&lt;span class="p">|&lt;/span> &lt;span class="se">\ &lt;/span> / &lt;span class="p">|&lt;/span> &lt;span class="se">\ \_&lt;/span>/ / &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="se">\ &lt;/span> / &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>
&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>&lt;span class="se">\/&lt;/span>&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="se">\ &lt;/span> / &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>&lt;span class="se">\/&lt;/span>&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>
&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>____ &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>__&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>
&lt;span class="p">|&lt;/span>_&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>_&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>_&lt;span class="p">|&lt;/span> &lt;span class="se">\_&lt;/span>____&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>_&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>_&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span>_____/
name:main.go, size:1320 modTime:2021-07-04 16:28:51.339520282 +0800 CST
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æš‚ä¸”å°±è¿™ä¹ˆå¤šï¼Œæ„Ÿè°¢ &lt;code>spf13/cobra&lt;/code> çš„ä½œè€…ï¼Œæä¾›è¿™ä¹ˆé«˜è´¨é‡çš„å¼€æºåº“ã€‚&lt;/p></content><category scheme="https://yusank.github.io/categories/%E6%8A%80%E6%9C%AF/" term="æŠ€æœ¯" label="æŠ€æœ¯"/><category scheme="https://yusank.github.io/tags/go/" term="go" label="go"/><category scheme="https://yusank.github.io/tags/cobra/" term="cobra" label="cobra"/></entry><entry><title type="text">Go-Micro ä¸­ä½¿ç”¨Nacos</title><link rel="alternate" type="text/html" href="https://yusank.github.io/posts/use-nacos-with-go-micro/"/><id>https://yusank.github.io/posts/use-nacos-with-go-micro/</id><updated>2021-09-18T06:24:55+00:00</updated><published>2021-06-23T18:22:00+08:00</published><author><name>yusank</name><uri>https://yusank.github.io/</uri><email>yusankurban@gmail.com</email></author><summary type="html">go-micro ä½œä¸ºæ¯”è¾ƒæµè¡Œçš„å¾®æœåŠ¡æ¡†æ¶ï¼Œå…¶è‰¯å¥½çš„æ¥å£è®¾è®¡ä¸ºåæœŸæ‰©å±•ä½¿ç”¨å¸¦æ¥äº†éå¸¸å¥½çš„ä¾¿åˆ©æ€§ã€‚â€¦â€¦</summary><content type="html">&lt;p>&lt;code>go-micro&lt;/code> ä½œä¸ºæ¯”è¾ƒæµè¡Œçš„å¾®æœåŠ¡æ¡†æ¶ï¼Œå…¶è‰¯å¥½çš„æ¥å£è®¾è®¡ä¸ºåæœŸæ‰©å±•ä½¿ç”¨å¸¦æ¥äº†éå¸¸å¥½çš„ä¾¿åˆ©æ€§ã€‚æœ¬æ–‡ç« ä¸»è¦è®²åœ¨ &lt;code>go-micro&lt;/code> ä¸­ç”¨ &lt;code>nacos&lt;/code> ä½œä¸ºæœåŠ¡æ³¨å†Œä¸­å¿ƒå’Œé…ç½®ä¸­å¿ƒã€‚&lt;/p>
&lt;h2 id="æ³¨å†Œä¸­å¿ƒ">æ³¨å†Œä¸­å¿ƒ&lt;/h2>
&lt;p>å…ˆçœ‹ä¸€ä¸‹ &lt;code>go-micro&lt;/code> å®šä¹‰çš„æœåŠ¡æ³¨å†Œæ¥å£ã€‚&lt;/p>
&lt;p>registry.go&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// æœåŠ¡æ³¨å†Œæ¥å£
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">Registry&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// åˆå§‹åŒ–
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Init&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="nx">Option&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="c1">// è¿”å›å¯é€‰å‚æ•°
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Options&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="nx">Options&lt;/span>
&lt;span class="c1">// æœåŠ¡æ³¨å†Œ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Register&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">Service&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="nx">RegisterOption&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="c1">// æœåŠ¡æ³¨é”€
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Deregister&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">Service&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="nx">DeregisterOption&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="c1">// æŸ¥è¯¢æœåŠ¡
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">GetService&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="nx">GetOption&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">([]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">Service&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// åˆ—å‡ºæœåŠ¡
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">ListServices&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="nx">ListOption&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">([]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">Service&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// ç›‘å¬æœåŠ¡
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Watch&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="nx">WatchOption&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">Watcher&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nf">String&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åªè¦åŸºäºä»»æ„ä¸€ä¸ªæœåŠ¡æ³¨å†ŒæœåŠ¡å®ç°ä»¥ä¸Šæ¥å£ï¼Œå³å¯åœ¨ &lt;code>go-micro&lt;/code> ä¸­ä½œä¸ºæ³¨å†Œä¸­å¿ƒä½¿ç”¨ã€‚å‡å¦‚æˆ‘ç”¨ä¸€ä¸ª &lt;code>customRegistry&lt;/code> å®ç°æ¥å£åï¼Œåœ¨ &lt;code>go-micro&lt;/code> åˆå§‹åŒ–çš„æ—¶å€™æˆ–æœåŠ¡å¯åŠ¨æ—¶å€™é€šè¿‡å¯åŠ¨å‚æ•°æŒ‡å®šå®ç°æ¥å£çš„æ¥å£çš„ &lt;code>String() string&lt;/code>æ–¹æ³•çš„è¿”å›å€¼æ¥å£ã€‚&lt;/p>
&lt;p>å¦‚ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// å‡å¦‚è¯¥ç»“æ„ä½“å·²å®ç° Registry æ¥å£
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">customRegistry&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">customRegistry&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">String&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;custom&amp;#34;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// ä»£ç ä¸­æŒ‡å®š
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">micro&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewService&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">micro&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Registry&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">customRegistry&lt;/span>&lt;span class="p">{}))&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// å¯åŠ¨å‚æ•°æŒ‡å®š
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">myApp&lt;/span> &lt;span class="o">--&lt;/span> &lt;span class="nx">registry&lt;/span> &lt;span class="nx">custom&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æ­¤ä¸€çœ‹ï¼Œå‘ç°éå¸¸æ–¹ä¾¿å’Œå¥½æ‰©å±•ï¼Œæ¥ä¸‹æ¥è´´å‡ºå¦‚ä½•ä½¿ç”¨nacos å®ç°è¯¥ &lt;code>Registry&lt;/code> æ¥å£ã€‚&lt;/p>
&lt;p>ç›´æ¥åˆ—å‡ºå…³é”®ä»£ç å—ï¼š&lt;/p>
&lt;p>registry.go&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt"> 10
&lt;/span>&lt;span class="lnt"> 11
&lt;/span>&lt;span class="lnt"> 12
&lt;/span>&lt;span class="lnt"> 13
&lt;/span>&lt;span class="lnt"> 14
&lt;/span>&lt;span class="lnt"> 15
&lt;/span>&lt;span class="lnt"> 16
&lt;/span>&lt;span class="lnt"> 17
&lt;/span>&lt;span class="lnt"> 18
&lt;/span>&lt;span class="lnt"> 19
&lt;/span>&lt;span class="lnt"> 20
&lt;/span>&lt;span class="lnt"> 21
&lt;/span>&lt;span class="lnt"> 22
&lt;/span>&lt;span class="lnt"> 23
&lt;/span>&lt;span class="lnt"> 24
&lt;/span>&lt;span class="lnt"> 25
&lt;/span>&lt;span class="lnt"> 26
&lt;/span>&lt;span class="lnt"> 27
&lt;/span>&lt;span class="lnt"> 28
&lt;/span>&lt;span class="lnt"> 29
&lt;/span>&lt;span class="lnt"> 30
&lt;/span>&lt;span class="lnt"> 31
&lt;/span>&lt;span class="lnt"> 32
&lt;/span>&lt;span class="lnt"> 33
&lt;/span>&lt;span class="lnt"> 34
&lt;/span>&lt;span class="lnt"> 35
&lt;/span>&lt;span class="lnt"> 36
&lt;/span>&lt;span class="lnt"> 37
&lt;/span>&lt;span class="lnt"> 38
&lt;/span>&lt;span class="lnt"> 39
&lt;/span>&lt;span class="lnt"> 40
&lt;/span>&lt;span class="lnt"> 41
&lt;/span>&lt;span class="lnt"> 42
&lt;/span>&lt;span class="lnt"> 43
&lt;/span>&lt;span class="lnt"> 44
&lt;/span>&lt;span class="lnt"> 45
&lt;/span>&lt;span class="lnt"> 46
&lt;/span>&lt;span class="lnt"> 47
&lt;/span>&lt;span class="lnt"> 48
&lt;/span>&lt;span class="lnt"> 49
&lt;/span>&lt;span class="lnt"> 50
&lt;/span>&lt;span class="lnt"> 51
&lt;/span>&lt;span class="lnt"> 52
&lt;/span>&lt;span class="lnt"> 53
&lt;/span>&lt;span class="lnt"> 54
&lt;/span>&lt;span class="lnt"> 55
&lt;/span>&lt;span class="lnt"> 56
&lt;/span>&lt;span class="lnt"> 57
&lt;/span>&lt;span class="lnt"> 58
&lt;/span>&lt;span class="lnt"> 59
&lt;/span>&lt;span class="lnt"> 60
&lt;/span>&lt;span class="lnt"> 61
&lt;/span>&lt;span class="lnt"> 62
&lt;/span>&lt;span class="lnt"> 63
&lt;/span>&lt;span class="lnt"> 64
&lt;/span>&lt;span class="lnt"> 65
&lt;/span>&lt;span class="lnt"> 66
&lt;/span>&lt;span class="lnt"> 67
&lt;/span>&lt;span class="lnt"> 68
&lt;/span>&lt;span class="lnt"> 69
&lt;/span>&lt;span class="lnt"> 70
&lt;/span>&lt;span class="lnt"> 71
&lt;/span>&lt;span class="lnt"> 72
&lt;/span>&lt;span class="lnt"> 73
&lt;/span>&lt;span class="lnt"> 74
&lt;/span>&lt;span class="lnt"> 75
&lt;/span>&lt;span class="lnt"> 76
&lt;/span>&lt;span class="lnt"> 77
&lt;/span>&lt;span class="lnt"> 78
&lt;/span>&lt;span class="lnt"> 79
&lt;/span>&lt;span class="lnt"> 80
&lt;/span>&lt;span class="lnt"> 81
&lt;/span>&lt;span class="lnt"> 82
&lt;/span>&lt;span class="lnt"> 83
&lt;/span>&lt;span class="lnt"> 84
&lt;/span>&lt;span class="lnt"> 85
&lt;/span>&lt;span class="lnt"> 86
&lt;/span>&lt;span class="lnt"> 87
&lt;/span>&lt;span class="lnt"> 88
&lt;/span>&lt;span class="lnt"> 89
&lt;/span>&lt;span class="lnt"> 90
&lt;/span>&lt;span class="lnt"> 91
&lt;/span>&lt;span class="lnt"> 92
&lt;/span>&lt;span class="lnt"> 93
&lt;/span>&lt;span class="lnt"> 94
&lt;/span>&lt;span class="lnt"> 95
&lt;/span>&lt;span class="lnt"> 96
&lt;/span>&lt;span class="lnt"> 97
&lt;/span>&lt;span class="lnt"> 98
&lt;/span>&lt;span class="lnt"> 99
&lt;/span>&lt;span class="lnt">100
&lt;/span>&lt;span class="lnt">101
&lt;/span>&lt;span class="lnt">102
&lt;/span>&lt;span class="lnt">103
&lt;/span>&lt;span class="lnt">104
&lt;/span>&lt;span class="lnt">105
&lt;/span>&lt;span class="lnt">106
&lt;/span>&lt;span class="lnt">107
&lt;/span>&lt;span class="lnt">108
&lt;/span>&lt;span class="lnt">109
&lt;/span>&lt;span class="lnt">110
&lt;/span>&lt;span class="lnt">111
&lt;/span>&lt;span class="lnt">112
&lt;/span>&lt;span class="lnt">113
&lt;/span>&lt;span class="lnt">114
&lt;/span>&lt;span class="lnt">115
&lt;/span>&lt;span class="lnt">116
&lt;/span>&lt;span class="lnt">117
&lt;/span>&lt;span class="lnt">118
&lt;/span>&lt;span class="lnt">119
&lt;/span>&lt;span class="lnt">120
&lt;/span>&lt;span class="lnt">121
&lt;/span>&lt;span class="lnt">122
&lt;/span>&lt;span class="lnt">123
&lt;/span>&lt;span class="lnt">124
&lt;/span>&lt;span class="lnt">125
&lt;/span>&lt;span class="lnt">126
&lt;/span>&lt;span class="lnt">127
&lt;/span>&lt;span class="lnt">128
&lt;/span>&lt;span class="lnt">129
&lt;/span>&lt;span class="lnt">130
&lt;/span>&lt;span class="lnt">131
&lt;/span>&lt;span class="lnt">132
&lt;/span>&lt;span class="lnt">133
&lt;/span>&lt;span class="lnt">134
&lt;/span>&lt;span class="lnt">135
&lt;/span>&lt;span class="lnt">136
&lt;/span>&lt;span class="lnt">137
&lt;/span>&lt;span class="lnt">138
&lt;/span>&lt;span class="lnt">139
&lt;/span>&lt;span class="lnt">140
&lt;/span>&lt;span class="lnt">141
&lt;/span>&lt;span class="lnt">142
&lt;/span>&lt;span class="lnt">143
&lt;/span>&lt;span class="lnt">144
&lt;/span>&lt;span class="lnt">145
&lt;/span>&lt;span class="lnt">146
&lt;/span>&lt;span class="lnt">147
&lt;/span>&lt;span class="lnt">148
&lt;/span>&lt;span class="lnt">149
&lt;/span>&lt;span class="lnt">150
&lt;/span>&lt;span class="lnt">151
&lt;/span>&lt;span class="lnt">152
&lt;/span>&lt;span class="lnt">153
&lt;/span>&lt;span class="lnt">154
&lt;/span>&lt;span class="lnt">155
&lt;/span>&lt;span class="lnt">156
&lt;/span>&lt;span class="lnt">157
&lt;/span>&lt;span class="lnt">158
&lt;/span>&lt;span class="lnt">159
&lt;/span>&lt;span class="lnt">160
&lt;/span>&lt;span class="lnt">161
&lt;/span>&lt;span class="lnt">162
&lt;/span>&lt;span class="lnt">163
&lt;/span>&lt;span class="lnt">164
&lt;/span>&lt;span class="lnt">165
&lt;/span>&lt;span class="lnt">166
&lt;/span>&lt;span class="lnt">167
&lt;/span>&lt;span class="lnt">168
&lt;/span>&lt;span class="lnt">169
&lt;/span>&lt;span class="lnt">170
&lt;/span>&lt;span class="lnt">171
&lt;/span>&lt;span class="lnt">172
&lt;/span>&lt;span class="lnt">173
&lt;/span>&lt;span class="lnt">174
&lt;/span>&lt;span class="lnt">175
&lt;/span>&lt;span class="lnt">176
&lt;/span>&lt;span class="lnt">177
&lt;/span>&lt;span class="lnt">178
&lt;/span>&lt;span class="lnt">179
&lt;/span>&lt;span class="lnt">180
&lt;/span>&lt;span class="lnt">181
&lt;/span>&lt;span class="lnt">182
&lt;/span>&lt;span class="lnt">183
&lt;/span>&lt;span class="lnt">184
&lt;/span>&lt;span class="lnt">185
&lt;/span>&lt;span class="lnt">186
&lt;/span>&lt;span class="lnt">187
&lt;/span>&lt;span class="lnt">188
&lt;/span>&lt;span class="lnt">189
&lt;/span>&lt;span class="lnt">190
&lt;/span>&lt;span class="lnt">191
&lt;/span>&lt;span class="lnt">192
&lt;/span>&lt;span class="lnt">193
&lt;/span>&lt;span class="lnt">194
&lt;/span>&lt;span class="lnt">195
&lt;/span>&lt;span class="lnt">196
&lt;/span>&lt;span class="lnt">197
&lt;/span>&lt;span class="lnt">198
&lt;/span>&lt;span class="lnt">199
&lt;/span>&lt;span class="lnt">200
&lt;/span>&lt;span class="lnt">201
&lt;/span>&lt;span class="lnt">202
&lt;/span>&lt;span class="lnt">203
&lt;/span>&lt;span class="lnt">204
&lt;/span>&lt;span class="lnt">205
&lt;/span>&lt;span class="lnt">206
&lt;/span>&lt;span class="lnt">207
&lt;/span>&lt;span class="lnt">208
&lt;/span>&lt;span class="lnt">209
&lt;/span>&lt;span class="lnt">210
&lt;/span>&lt;span class="lnt">211
&lt;/span>&lt;span class="lnt">212
&lt;/span>&lt;span class="lnt">213
&lt;/span>&lt;span class="lnt">214
&lt;/span>&lt;span class="lnt">215
&lt;/span>&lt;span class="lnt">216
&lt;/span>&lt;span class="lnt">217
&lt;/span>&lt;span class="lnt">218
&lt;/span>&lt;span class="lnt">219
&lt;/span>&lt;span class="lnt">220
&lt;/span>&lt;span class="lnt">221
&lt;/span>&lt;span class="lnt">222
&lt;/span>&lt;span class="lnt">223
&lt;/span>&lt;span class="lnt">224
&lt;/span>&lt;span class="lnt">225
&lt;/span>&lt;span class="lnt">226
&lt;/span>&lt;span class="lnt">227
&lt;/span>&lt;span class="lnt">228
&lt;/span>&lt;span class="lnt">229
&lt;/span>&lt;span class="lnt">230
&lt;/span>&lt;span class="lnt">231
&lt;/span>&lt;span class="lnt">232
&lt;/span>&lt;span class="lnt">233
&lt;/span>&lt;span class="lnt">234
&lt;/span>&lt;span class="lnt">235
&lt;/span>&lt;span class="lnt">236
&lt;/span>&lt;span class="lnt">237
&lt;/span>&lt;span class="lnt">238
&lt;/span>&lt;span class="lnt">239
&lt;/span>&lt;span class="lnt">240
&lt;/span>&lt;span class="lnt">241
&lt;/span>&lt;span class="lnt">242
&lt;/span>&lt;span class="lnt">243
&lt;/span>&lt;span class="lnt">244
&lt;/span>&lt;span class="lnt">245
&lt;/span>&lt;span class="lnt">246
&lt;/span>&lt;span class="lnt">247
&lt;/span>&lt;span class="lnt">248
&lt;/span>&lt;span class="lnt">249
&lt;/span>&lt;span class="lnt">250
&lt;/span>&lt;span class="lnt">251
&lt;/span>&lt;span class="lnt">252
&lt;/span>&lt;span class="lnt">253
&lt;/span>&lt;span class="lnt">254
&lt;/span>&lt;span class="lnt">255
&lt;/span>&lt;span class="lnt">256
&lt;/span>&lt;span class="lnt">257
&lt;/span>&lt;span class="lnt">258
&lt;/span>&lt;span class="lnt">259
&lt;/span>&lt;span class="lnt">260
&lt;/span>&lt;span class="lnt">261
&lt;/span>&lt;span class="lnt">262
&lt;/span>&lt;span class="lnt">263
&lt;/span>&lt;span class="lnt">264
&lt;/span>&lt;span class="lnt">265
&lt;/span>&lt;span class="lnt">266
&lt;/span>&lt;span class="lnt">267
&lt;/span>&lt;span class="lnt">268
&lt;/span>&lt;span class="lnt">269
&lt;/span>&lt;span class="lnt">270
&lt;/span>&lt;span class="lnt">271
&lt;/span>&lt;span class="lnt">272
&lt;/span>&lt;span class="lnt">273
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;errors&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;net&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;strconv&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;time&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/asim/go-micro/v3/cmd&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/asim/go-micro/v3/registry&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/nacos-group/nacos-sdk-go/v2/clients&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/nacos-group/nacos-sdk-go/v2/clients/naming_client&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/nacos-group/nacos-sdk-go/v2/common/constant&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/nacos-group/nacos-sdk-go/v2/common/logger&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/nacos-group/nacos-sdk-go/v2/vo&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">nacosRegistry&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// nacos sdk çš„client
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">client&lt;/span> &lt;span class="nx">naming_client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">INamingClient&lt;/span>
&lt;span class="c1">// å¯é€‰å‚æ•°ï¼Œåˆå§‹åŒ–çš„æ—¶å€™å¯ä»¥é€šè¿‡ registry.Option æ–¹æ³•æŒ‡å®šé…ç½®
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">opts&lt;/span> &lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Options&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">init&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// è®¾ç½®ä¸ºé»˜è®¤é…ç½®
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">cmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DefaultRegistries&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s">&amp;#34;nacos&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">NewRegistry&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// NewRegistry NewRegistry
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">NewRegistry&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">opts&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Option&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Registry&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">n&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">nacosRegistry&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">opts&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Options&lt;/span>&lt;span class="p">{},&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">configure&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">opts&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">n&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// è¿™ä¸ªæ–¹æ³•æ€»ç»“ä¸‹æ¥å°±æ˜¯å¹²äº†ä¸€ä»¶äº‹ï¼šé…ç½®åˆå§‹åŒ–
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">configure&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">n&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">nacosRegistry&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">opts&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Option&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// set opts
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">o&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">opts&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">o&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">n&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">opts&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">clientConfig&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">constant&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ClientConfig&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="nx">serverConfigs&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="nx">constant&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ServerConfig&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">contextPath&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="s">&amp;#34;/nacos&amp;#34;&lt;/span>
&lt;span class="nx">cfg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">n&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">opts&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Value&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">configKey&lt;/span>&lt;span class="p">{}).(&lt;/span>&lt;span class="nx">constant&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ClientConfig&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">clientConfig&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">cfg&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">addrs&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">n&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">opts&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Value&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">addressKey&lt;/span>&lt;span class="p">{}).([]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">ok&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">addrs&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="s">&amp;#34;127.0.0.1:8848&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span> &lt;span class="c1">// é»˜è®¤è¿æ¥æœ¬åœ°
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">addr&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">addrs&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// check we have a port
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">host&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">port&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SplitHostPort&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">addr&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">p&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">strconv&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ParseUint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">port&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">64&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">serverConfigs&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">serverConfigs&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">constant&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ServerConfig&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="c1">// Scheme: &amp;#34;go.micro&amp;#34;,
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">IpAddr&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">host&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Port&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">p&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">ContextPath&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">contextPath&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">})&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">n&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">opts&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Timeout&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">n&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">opts&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Timeout&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">clientConfig&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TimeoutMs&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">uint64&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">n&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">opts&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Timeout&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Milliseconds&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="c1">// åˆ›å»ºå®¢æˆ·ç«¯
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">client&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">clients&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">CreateNamingClient&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{}{&lt;/span>
&lt;span class="nx">constant&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">KEY_SERVER_CONFIGS&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">serverConfigs&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">constant&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">KEY_CLIENT_CONFIG&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">clientConfig&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">})&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">n&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">client&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">client&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">n&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">nacosRegistry&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Init&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">opts&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Option&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">_&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">configure&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">opts&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">n&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">nacosRegistry&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Options&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Options&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">n&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">opts&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">n&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">nacosRegistry&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Register&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Service&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">opts&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RegisterOption&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">options&lt;/span> &lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RegisterOptions&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">o&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">opts&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">o&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">options&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">withContext&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;span class="c1">// å¤„ç†å‚æ•°
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">param&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">vo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RegisterInstanceParam&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">options&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">p&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">options&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Value&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;register_instance_param&amp;#34;&lt;/span>&lt;span class="p">).(&lt;/span>&lt;span class="nx">vo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RegisterInstanceParam&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">param&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">p&lt;/span>
&lt;span class="nx">withContext&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">ok&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">withContext&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">host&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">port&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">getNodeIPPort&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Nodes&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="nx">Metadata&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s">&amp;#34;version&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Version&lt;/span>
&lt;span class="nx">param&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Ip&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">host&lt;/span>
&lt;span class="nx">param&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Port&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">uint64&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">port&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">param&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Metadata&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Nodes&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="nx">Metadata&lt;/span>
&lt;span class="nx">param&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ServiceName&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Name&lt;/span>
&lt;span class="nx">param&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Enable&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;span class="nx">param&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Healthy&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;span class="nx">param&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Weight&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mf">1.0&lt;/span>
&lt;span class="nx">param&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Ephemeral&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// æ³¨å†ŒèŠ‚ç‚¹
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">n&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">RegisterInstance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">param&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">n&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">nacosRegistry&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Deregister&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Service&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">opts&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DeregisterOption&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">options&lt;/span> &lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DeregisterOptions&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">o&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">opts&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">o&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">options&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">withContext&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;span class="nx">param&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">vo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DeregisterInstanceParam&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">options&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">p&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">options&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Value&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;deregister_instance_param&amp;#34;&lt;/span>&lt;span class="p">).(&lt;/span>&lt;span class="nx">vo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DeregisterInstanceParam&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">param&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">p&lt;/span>
&lt;span class="nx">withContext&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">ok&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">withContext&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">host&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">port&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">getNodeIPPort&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">param&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Ip&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">host&lt;/span>
&lt;span class="nx">param&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Port&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">uint64&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">port&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">param&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ServiceName&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Name&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">n&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">DeregisterInstance&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">param&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">n&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">nacosRegistry&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">GetService&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">name&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">opts&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GetOption&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">([]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Service&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">options&lt;/span> &lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GetOptions&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">o&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">opts&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">o&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">options&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">withContext&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;span class="nx">param&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">vo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GetServiceParam&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">options&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// å¯ä»¥é€šè¿‡contextä¼ å‚
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">p&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">options&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Value&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;select_instances_param&amp;#34;&lt;/span>&lt;span class="p">).(&lt;/span>&lt;span class="nx">vo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GetServiceParam&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">param&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">p&lt;/span>
&lt;span class="nx">withContext&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">ok&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">withContext&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">param&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ServiceName&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">name&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">service&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">n&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetService&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">param&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">services&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Service&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">service&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Hosts&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">//log.Printf(&amp;#34;%+v\n&amp;#34;, v)
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// è·³è¿‡ä¸æ­£å¸¸çš„èŠ‚ç‚¹
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">v&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Healthy&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">v&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Enable&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Weight&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">continue&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">nodes&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Node&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">nodes&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">nodes&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Node&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">Id&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">InstanceId&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Address&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">JoinHostPort&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">v&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Ip&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;%d&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Port&lt;/span>&lt;span class="p">)),&lt;/span>
&lt;span class="nx">Metadata&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Metadata&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">})&lt;/span>
&lt;span class="nx">s&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Service&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">Name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ServiceName&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Version&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Metadata&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s">&amp;#34;version&amp;#34;&lt;/span>&lt;span class="p">],&lt;/span>
&lt;span class="nx">Metadata&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Metadata&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Nodes&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">nodes&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">services&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">services&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">s&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">services&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">n&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">nacosRegistry&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">ListServices&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">opts&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ListOption&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">([]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Service&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">options&lt;/span> &lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ListOptions&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">o&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">opts&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">o&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">options&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">withContext&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;span class="nx">param&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">vo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GetAllServiceInfoParam&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">options&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">p&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">options&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Value&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;get_all_service_info_param&amp;#34;&lt;/span>&lt;span class="p">).(&lt;/span>&lt;span class="nx">vo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GetAllServiceInfoParam&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">param&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">p&lt;/span>
&lt;span class="nx">withContext&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">ok&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">withContext&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">services&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">n&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetAllServicesInfo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">param&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">param&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PageNo&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;span class="nx">param&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PageSize&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">uint32&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">services&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Count&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">services&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">n&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetAllServicesInfo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">param&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">registryServices&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Service&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">services&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Doms&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">registryServices&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">registryServices&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Service&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">Name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">})&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">registryServices&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">n&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">nacosRegistry&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Watch&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">opts&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">WatchOption&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Watcher&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nf">newWatcher&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">opts&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">n&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">nacosRegistry&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">String&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;nacos&amp;#34;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">getNodeIPPort&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Service&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">host&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">port&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Nodes&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">errors&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;you must deregister at least one node&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">node&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Nodes&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="nx">host&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">pt&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SplitHostPort&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">node&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Address&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">port&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">strconv&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Atoi&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">pt&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>watcher.go æ˜¯ç›‘å¬æœåŠ¡çš„é€»è¾‘ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt"> 10
&lt;/span>&lt;span class="lnt"> 11
&lt;/span>&lt;span class="lnt"> 12
&lt;/span>&lt;span class="lnt"> 13
&lt;/span>&lt;span class="lnt"> 14
&lt;/span>&lt;span class="lnt"> 15
&lt;/span>&lt;span class="lnt"> 16
&lt;/span>&lt;span class="lnt"> 17
&lt;/span>&lt;span class="lnt"> 18
&lt;/span>&lt;span class="lnt"> 19
&lt;/span>&lt;span class="lnt"> 20
&lt;/span>&lt;span class="lnt"> 21
&lt;/span>&lt;span class="lnt"> 22
&lt;/span>&lt;span class="lnt"> 23
&lt;/span>&lt;span class="lnt"> 24
&lt;/span>&lt;span class="lnt"> 25
&lt;/span>&lt;span class="lnt"> 26
&lt;/span>&lt;span class="lnt"> 27
&lt;/span>&lt;span class="lnt"> 28
&lt;/span>&lt;span class="lnt"> 29
&lt;/span>&lt;span class="lnt"> 30
&lt;/span>&lt;span class="lnt"> 31
&lt;/span>&lt;span class="lnt"> 32
&lt;/span>&lt;span class="lnt"> 33
&lt;/span>&lt;span class="lnt"> 34
&lt;/span>&lt;span class="lnt"> 35
&lt;/span>&lt;span class="lnt"> 36
&lt;/span>&lt;span class="lnt"> 37
&lt;/span>&lt;span class="lnt"> 38
&lt;/span>&lt;span class="lnt"> 39
&lt;/span>&lt;span class="lnt"> 40
&lt;/span>&lt;span class="lnt"> 41
&lt;/span>&lt;span class="lnt"> 42
&lt;/span>&lt;span class="lnt"> 43
&lt;/span>&lt;span class="lnt"> 44
&lt;/span>&lt;span class="lnt"> 45
&lt;/span>&lt;span class="lnt"> 46
&lt;/span>&lt;span class="lnt"> 47
&lt;/span>&lt;span class="lnt"> 48
&lt;/span>&lt;span class="lnt"> 49
&lt;/span>&lt;span class="lnt"> 50
&lt;/span>&lt;span class="lnt"> 51
&lt;/span>&lt;span class="lnt"> 52
&lt;/span>&lt;span class="lnt"> 53
&lt;/span>&lt;span class="lnt"> 54
&lt;/span>&lt;span class="lnt"> 55
&lt;/span>&lt;span class="lnt"> 56
&lt;/span>&lt;span class="lnt"> 57
&lt;/span>&lt;span class="lnt"> 58
&lt;/span>&lt;span class="lnt"> 59
&lt;/span>&lt;span class="lnt"> 60
&lt;/span>&lt;span class="lnt"> 61
&lt;/span>&lt;span class="lnt"> 62
&lt;/span>&lt;span class="lnt"> 63
&lt;/span>&lt;span class="lnt"> 64
&lt;/span>&lt;span class="lnt"> 65
&lt;/span>&lt;span class="lnt"> 66
&lt;/span>&lt;span class="lnt"> 67
&lt;/span>&lt;span class="lnt"> 68
&lt;/span>&lt;span class="lnt"> 69
&lt;/span>&lt;span class="lnt"> 70
&lt;/span>&lt;span class="lnt"> 71
&lt;/span>&lt;span class="lnt"> 72
&lt;/span>&lt;span class="lnt"> 73
&lt;/span>&lt;span class="lnt"> 74
&lt;/span>&lt;span class="lnt"> 75
&lt;/span>&lt;span class="lnt"> 76
&lt;/span>&lt;span class="lnt"> 77
&lt;/span>&lt;span class="lnt"> 78
&lt;/span>&lt;span class="lnt"> 79
&lt;/span>&lt;span class="lnt"> 80
&lt;/span>&lt;span class="lnt"> 81
&lt;/span>&lt;span class="lnt"> 82
&lt;/span>&lt;span class="lnt"> 83
&lt;/span>&lt;span class="lnt"> 84
&lt;/span>&lt;span class="lnt"> 85
&lt;/span>&lt;span class="lnt"> 86
&lt;/span>&lt;span class="lnt"> 87
&lt;/span>&lt;span class="lnt"> 88
&lt;/span>&lt;span class="lnt"> 89
&lt;/span>&lt;span class="lnt"> 90
&lt;/span>&lt;span class="lnt"> 91
&lt;/span>&lt;span class="lnt"> 92
&lt;/span>&lt;span class="lnt"> 93
&lt;/span>&lt;span class="lnt"> 94
&lt;/span>&lt;span class="lnt"> 95
&lt;/span>&lt;span class="lnt"> 96
&lt;/span>&lt;span class="lnt"> 97
&lt;/span>&lt;span class="lnt"> 98
&lt;/span>&lt;span class="lnt"> 99
&lt;/span>&lt;span class="lnt">100
&lt;/span>&lt;span class="lnt">101
&lt;/span>&lt;span class="lnt">102
&lt;/span>&lt;span class="lnt">103
&lt;/span>&lt;span class="lnt">104
&lt;/span>&lt;span class="lnt">105
&lt;/span>&lt;span class="lnt">106
&lt;/span>&lt;span class="lnt">107
&lt;/span>&lt;span class="lnt">108
&lt;/span>&lt;span class="lnt">109
&lt;/span>&lt;span class="lnt">110
&lt;/span>&lt;span class="lnt">111
&lt;/span>&lt;span class="lnt">112
&lt;/span>&lt;span class="lnt">113
&lt;/span>&lt;span class="lnt">114
&lt;/span>&lt;span class="lnt">115
&lt;/span>&lt;span class="lnt">116
&lt;/span>&lt;span class="lnt">117
&lt;/span>&lt;span class="lnt">118
&lt;/span>&lt;span class="lnt">119
&lt;/span>&lt;span class="lnt">120
&lt;/span>&lt;span class="lnt">121
&lt;/span>&lt;span class="lnt">122
&lt;/span>&lt;span class="lnt">123
&lt;/span>&lt;span class="lnt">124
&lt;/span>&lt;span class="lnt">125
&lt;/span>&lt;span class="lnt">126
&lt;/span>&lt;span class="lnt">127
&lt;/span>&lt;span class="lnt">128
&lt;/span>&lt;span class="lnt">129
&lt;/span>&lt;span class="lnt">130
&lt;/span>&lt;span class="lnt">131
&lt;/span>&lt;span class="lnt">132
&lt;/span>&lt;span class="lnt">133
&lt;/span>&lt;span class="lnt">134
&lt;/span>&lt;span class="lnt">135
&lt;/span>&lt;span class="lnt">136
&lt;/span>&lt;span class="lnt">137
&lt;/span>&lt;span class="lnt">138
&lt;/span>&lt;span class="lnt">139
&lt;/span>&lt;span class="lnt">140
&lt;/span>&lt;span class="lnt">141
&lt;/span>&lt;span class="lnt">142
&lt;/span>&lt;span class="lnt">143
&lt;/span>&lt;span class="lnt">144
&lt;/span>&lt;span class="lnt">145
&lt;/span>&lt;span class="lnt">146
&lt;/span>&lt;span class="lnt">147
&lt;/span>&lt;span class="lnt">148
&lt;/span>&lt;span class="lnt">149
&lt;/span>&lt;span class="lnt">150
&lt;/span>&lt;span class="lnt">151
&lt;/span>&lt;span class="lnt">152
&lt;/span>&lt;span class="lnt">153
&lt;/span>&lt;span class="lnt">154
&lt;/span>&lt;span class="lnt">155
&lt;/span>&lt;span class="lnt">156
&lt;/span>&lt;span class="lnt">157
&lt;/span>&lt;span class="lnt">158
&lt;/span>&lt;span class="lnt">159
&lt;/span>&lt;span class="lnt">160
&lt;/span>&lt;span class="lnt">161
&lt;/span>&lt;span class="lnt">162
&lt;/span>&lt;span class="lnt">163
&lt;/span>&lt;span class="lnt">164
&lt;/span>&lt;span class="lnt">165
&lt;/span>&lt;span class="lnt">166
&lt;/span>&lt;span class="lnt">167
&lt;/span>&lt;span class="lnt">168
&lt;/span>&lt;span class="lnt">169
&lt;/span>&lt;span class="lnt">170
&lt;/span>&lt;span class="lnt">171
&lt;/span>&lt;span class="lnt">172
&lt;/span>&lt;span class="lnt">173
&lt;/span>&lt;span class="lnt">174
&lt;/span>&lt;span class="lnt">175
&lt;/span>&lt;span class="lnt">176
&lt;/span>&lt;span class="lnt">177
&lt;/span>&lt;span class="lnt">178
&lt;/span>&lt;span class="lnt">179
&lt;/span>&lt;span class="lnt">180
&lt;/span>&lt;span class="lnt">181
&lt;/span>&lt;span class="lnt">182
&lt;/span>&lt;span class="lnt">183
&lt;/span>&lt;span class="lnt">184
&lt;/span>&lt;span class="lnt">185
&lt;/span>&lt;span class="lnt">186
&lt;/span>&lt;span class="lnt">187
&lt;/span>&lt;span class="lnt">188
&lt;/span>&lt;span class="lnt">189
&lt;/span>&lt;span class="lnt">190
&lt;/span>&lt;span class="lnt">191
&lt;/span>&lt;span class="lnt">192
&lt;/span>&lt;span class="lnt">193
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;log&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;net&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;reflect&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;sync&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/asim/go-micro/v3/logger&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/asim/go-micro/v3/registry&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/nacos-group/nacos-sdk-go/v2/model&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/nacos-group/nacos-sdk-go/v2/vo&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">watcher&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">n&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">nacosRegistry&lt;/span> &lt;span class="c1">// æ³¨å†Œå®ç°
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">wo&lt;/span> &lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">WatchOptions&lt;/span> &lt;span class="c1">// ç›‘å¬option
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="nx">next&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Result&lt;/span> &lt;span class="c1">// é€šè¿‡channelä¼ é€’æ•°æ®
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">exit&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="kt">bool&lt;/span> &lt;span class="c1">// é€€å‡ºchannel
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="c1">// åœ¨å†…å­˜ä¸­ç¼“å­˜æ•°æ®å¹¶å®šæ—¶ç»´æŠ¤
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">sync&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RWMutex&lt;/span>
&lt;span class="nx">services&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">][]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Service&lt;/span>
&lt;span class="nx">cacheServices&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">][]&lt;/span>&lt;span class="nx">model&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Instance&lt;/span>
&lt;span class="nx">param&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">vo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">SubscribeParam&lt;/span>
&lt;span class="nx">Doms&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">newWatcher&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">nr&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">nacosRegistry&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">opts&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">WatchOption&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Watcher&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">wo&lt;/span> &lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">WatchOptions&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">o&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">opts&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">o&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">wo&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">nw&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">watcher&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">n&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">nr&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">wo&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">wo&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">exit&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kt">bool&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="nx">next&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Result&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="nx">services&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">][]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Service&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="nx">cacheServices&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">][]&lt;/span>&lt;span class="nx">model&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Instance&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="nx">param&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">vo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">SubscribeParam&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="nx">Doms&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">withContext&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">wo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">p&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">wo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Value&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;subscribe_param&amp;#34;&lt;/span>&lt;span class="p">).(&lt;/span>&lt;span class="nx">vo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">SubscribeParam&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">nw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">param&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">p&lt;/span>
&lt;span class="nx">withContext&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">ok&lt;/span>
&lt;span class="nx">nw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">param&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">SubscribeCallback&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">nw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">callBackHandle&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="nx">nr&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Subscribe&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">nw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">param&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">withContext&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">param&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">vo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GetAllServiceInfoParam&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="nx">services&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">nr&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetAllServicesInfo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">param&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">param&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PageNo&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;span class="nx">param&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">PageSize&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">uint32&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">services&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Count&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">services&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">nr&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">GetAllServicesInfo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">param&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">nw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Doms&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">services&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Doms&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">nw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Doms&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">param&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">vo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">SubscribeParam&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">ServiceName&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">SubscribeCallback&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">nw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">callBackHandle&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="nx">nr&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Subscribe&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">param&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">nw&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// callBackHandle å›è°ƒå‡½æ•°æ³¨å†Œåˆ°nacosSDKå†…ï¼Œç›‘å¬çš„æœåŠ¡æœ‰å˜åŒ–æ—¶ ä¼šè¢«è°ƒç”¨
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">nw&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">watcher&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">callBackHandle&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">services&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">model&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Instance&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">logger&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;nacos watcher call back handle error:%v&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">serviceName&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">services&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="nx">ServiceName&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">nw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">cacheServices&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">serviceName&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">nw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Lock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">nw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">cacheServices&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">serviceName&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">services&lt;/span>
&lt;span class="nx">nw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unlock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">services&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">nw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">next&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Result&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">Action&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;create&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">Service&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nf">buildRegistryService&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">v&lt;/span>&lt;span class="p">)}&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">subscribeService&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">services&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">create&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">cacheService&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">nw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">cacheServices&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">serviceName&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">subscribeService&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">InstanceId&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nx">cacheService&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">InstanceId&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">reflect&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">DeepEqual&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">subscribeService&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">cacheService&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">//update instance
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">nw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">next&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Result&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">Action&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;update&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">Service&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nf">buildRegistryService&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">subscribeService&lt;/span>&lt;span class="p">)}&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">create&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//new instance
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">create&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;create&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">subscribeService&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ServiceName&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">subscribeService&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Port&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">nw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">next&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Result&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">Action&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;create&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">Service&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nf">buildRegistryService&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">subscribeService&lt;/span>&lt;span class="p">)}&lt;/span>
&lt;span class="nx">nw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Lock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">nw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">cacheServices&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">serviceName&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">nw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">cacheServices&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">serviceName&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="nx">subscribeService&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">nw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unlock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">index&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">cacheService&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">nw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">cacheServices&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">serviceName&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">del&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">subscribeService&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">services&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">subscribeService&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">InstanceId&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nx">cacheService&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">InstanceId&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">del&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">del&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;del&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">cacheService&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ServiceName&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">cacheService&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Port&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">nw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">next&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Result&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">Action&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;delete&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">Service&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nf">buildRegistryService&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">cacheService&lt;/span>&lt;span class="p">)}&lt;/span>
&lt;span class="nx">nw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Lock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">nw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">cacheServices&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">serviceName&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="nx">index&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">model&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Instance&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="nx">nw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unlock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">buildRegistryService&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">v&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">model&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Instance&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Service&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">nodes&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Node&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">nodes&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">nodes&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Node&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">Id&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">InstanceId&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Address&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">JoinHostPort&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">v&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Ip&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;%d&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Port&lt;/span>&lt;span class="p">)),&lt;/span>
&lt;span class="nx">Metadata&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Metadata&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">})&lt;/span>
&lt;span class="nx">s&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Service&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">Name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ServiceName&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Version&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;latest&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Metadata&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Metadata&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Nodes&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">nodes&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// watcher å®ç°äº† register.Watcher æ¥å£ï¼Œè¯¥æ–¹æ³•ä¸ºé˜»å¡çš„ï¼Œåªæœ‰æœåŠ¡æœ‰å˜åŒ–æ—¶ next channelé‡Œæ‰ä¼šæœ‰å€¼
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">nw&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">watcher&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Next&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">r&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Result&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">select&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">nw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">exit&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ErrWatcherStopped&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">nw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">next&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">ok&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ErrWatcherStopped&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">r&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">nw&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">watcher&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Stop&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">select&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">nw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">exit&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="k">default&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nb">close&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">nw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">exit&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">nw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Doms&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">nw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Doms&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">param&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">vo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">SubscribeParam&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">ServiceName&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">SubscribeCallback&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">nw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">callBackHandle&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">_&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">nw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">n&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unsubscribe&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">param&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">_&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">nw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">n&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">client&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unsubscribe&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">nw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">param&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¸éš¾å‘ç°ï¼Œå…¶å®åœ¨æ¥å£å®šä¹‰å¥½çš„æƒ…å†µä¸‹ï¼Œå†™å…¶å®ç°æ–¹æ³•ä¸éš¾ï¼Œåªè¦æŒ‰ç…§æ¥å£å®šä¹‰å’Œå«ä¹‰ï¼Œæ­£å¸¸é€»è¾‘é€»è¾‘å³å¯ã€‚
è¿™æ®µä»£ç æˆ‘å·²ç» PR åˆ° &lt;code>go-micro&lt;/code> é¡¹ç›® ï¼Œå¯ä»¥åœ¨GitHubä¸Šç›´æ¥æŸ¥çœ‹æºç ã€‚&lt;a href="https://github.com/asim/go-micro/tree/master/plugins/registry/nacos">ä¼ é€é—¨&lt;/a>ã€‚&lt;/p></content><category scheme="https://yusank.github.io/categories/microservice/" term="microservice" label="microservice"/><category scheme="https://yusank.github.io/tags/go/" term="go" label="go"/><category scheme="https://yusank.github.io/tags/go-micro/" term="go-micro" label="go-micro"/></entry><entry><title type="text">Go-Micro çš„æ¶æ„åŠå…¶ä½¿ç”¨ï¼ˆä¸€ï¼‰</title><link rel="alternate" type="text/html" href="https://yusank.github.io/posts/go-micro-1/"/><id>https://yusank.github.io/posts/go-micro-1/</id><updated>2021-09-18T06:24:55+00:00</updated><published>2021-06-11T18:22:00+08:00</published><author><name>yusank</name><uri>https://yusank.github.io/</uri><email>yusankurban@gmail.com</email></author><summary type="html">å…³äºå¦‚ä½•ä½¿ç”¨goçš„å¾®æœåŠ¡æ¡†æ¶ go-micro/v3 çš„ä½¿ç”¨å’Œå…¶æ’ä»¶çš„è‡ªå®šä¹‰ã€‚ç¬¬ä¸€éƒ¨åˆ†å°†æ¡†æ¶çš„æ¶æ„å¤§è‡´äº†â€¦â€¦</summary><content type="html">&lt;p>å…³äºå¦‚ä½•ä½¿ç”¨goçš„å¾®æœåŠ¡æ¡†æ¶ &lt;code>go-micro/v3&lt;/code> çš„ä½¿ç”¨å’Œå…¶æ’ä»¶çš„è‡ªå®šä¹‰ã€‚ç¬¬ä¸€éƒ¨åˆ†å°†æ¡†æ¶çš„æ¶æ„å¤§è‡´äº†è§£ä¸€éã€‚&lt;/p>
&lt;h2 id="æ¶æ„">æ¶æ„&lt;/h2>
&lt;blockquote>
&lt;p>ä»¥ &lt;code>v3.5.1&lt;/code> åˆ†æ”¯ä¸ºä¾‹&lt;/p>
&lt;/blockquote>
&lt;p>&lt;code>go-micor&lt;/code> é¡¹ç›®çš„ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ tree -L &lt;span class="m">2&lt;/span>
.
â”œâ”€â”€ LICENSE
â”œâ”€â”€ README.md
â”œâ”€â”€ _config.yml
â”œâ”€â”€ api // api æ¥å£çš„å®šä¹‰ï¼ŒåŒ…æ‹¬httpã€grpcã€routerç­‰
â”œâ”€â”€ auth // è´¦å·è®¤è¯æ¥å£çš„å®šä¹‰
â”œâ”€â”€ broker // æ¶ˆæ¯é˜Ÿåˆ—æ¥å£å®šä¹‰åŠé»˜è®¤å®ç°
â”œâ”€â”€ client // å®¢æˆ·ç«¯ç›¸å…³æ¥å£å®šä¹‰å’Œå®ç°
â”œâ”€â”€ cmd // å¯æ‰§è¡Œå‘½ä»¤ï¼ˆåŒ…æ‹¬ç”Ÿæˆprotobufçš„å‘½ä»¤å®ç°ï¼‰
â”œâ”€â”€ codec // code encoder
â”œâ”€â”€ config // åŠ¨æ€é…ç½®çš„æ¥å£å®šä¹‰
â”œâ”€â”€ debug // debug æ¨¡å¼
â”œâ”€â”€ errors // é”™è¯¯å¤„ç†
â”œâ”€â”€ examples // å„ä¸ªæ¨¡å—çš„ç¤ºä¾‹ä»£ç 
â”œâ”€â”€ logger // æ—¥å¿—æ¨¡å—æ¥å£å®šä¹‰
â”œâ”€â”€ metadata // åŸæ•°æ®
â”œâ”€â”€ plugins // å„ä¸ªæ¨¡å—å®šä¹‰çš„æ¥å£çš„ä¸åŒå®ç°
â”œâ”€â”€ registry // æœåŠ¡æ³¨å†Œæ¥å£å®šä¹‰
â”œâ”€â”€ selector // è´Ÿè½½å‡è¡¡
â”œâ”€â”€ server // æœåŠ¡ç«¯æ¥å£å®šä¹‰
â”œâ”€â”€ store // æ•°æ®å­˜å‚¨æ¥å£å®šä¹‰
â”œâ”€â”€ sync
â”œâ”€â”€ transport // è¯·æ±‚è½¬å‘
â””â”€â”€ util // å·¥å…·ç±»
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¸‹é¢æŒ‰ç›®å½•å°† &lt;code>go-micro&lt;/code> çš„ä¸»è¦æ ¸å¿ƒæ¨¡å—è¿‡ä¸€éã€‚&lt;/p>
&lt;h3 id="api">API&lt;/h3>
&lt;blockquote>
&lt;p>&lt;code>api&lt;/code> å±‚ä¸ºå®šä¹‰å’Œå®ç°åŸºäºhttp/gRPCçš„api serviceã€‚å³httpè¯·æ±‚å¤„ç† è·¯ç”±å¤„ç† è·¯ç”±æ³¨å†Œç­‰ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>æ¥å£å®šä¹‰ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Api&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Initialise options
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Init&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="nx">Option&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="c1">// Get the options
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Options&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="nx">Options&lt;/span>
&lt;span class="c1">// Register a http handler
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Register&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">Endpoint&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="c1">// Register a route
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Deregister&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">Endpoint&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="c1">// Implemenation of api
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">String&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç›®å½•ç»“æ„ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ tree
.
â”œâ”€â”€ api.go
â”œâ”€â”€ api_test.go
â”œâ”€â”€ handler // æ¥å£å¤„ç†æ–¹æ³•
â”‚Â Â  â”œâ”€â”€ api // å®ç° http.ServerHTTP&lt;span class="o">()&lt;/span> æ–¹æ³•
â”‚Â Â  â”œâ”€â”€ event // åŸºäºæ¶ˆæ¯é˜Ÿåˆ—çš„å®ç°
â”‚Â Â  â”œâ”€â”€ handler.go // æ¥å£å®šä¹‰
â”‚Â Â  â”œâ”€â”€ http // åŸºäºhttpçš„å®ç°
â”‚Â Â  â”œâ”€â”€ options.go
â”‚Â Â  â”œâ”€â”€ rpc // åŸºäºrpcçš„å®ç°
â”‚Â Â  â””â”€â”€ web // æ”¯æŒwebsocketçš„å®ç°
â”œâ”€â”€ proto
â”‚Â Â  â”œâ”€â”€ api.pb.go
â”‚Â Â  â”œâ”€â”€ api.pb.micro.go
â”‚Â Â  â””â”€â”€ api.proto // æ•°æ®ç»“æ„å®šä¹‰
â”œâ”€â”€ resolver // è§£æè¯·æ±‚åŠè·¯ç”±
â”‚Â Â  â”œâ”€â”€ grpc
â”‚Â Â  â”œâ”€â”€ host
â”‚Â Â  â”œâ”€â”€ options.go
â”‚Â Â  â”œâ”€â”€ path
â”‚Â Â  â”œâ”€â”€ resolver.go
â”‚Â Â  â””â”€â”€ vpath
â”œâ”€â”€ router // è·¯ç”±å®šä¹‰å’Œæ³¨å†Œ
â”‚Â Â  â”œâ”€â”€ options.go
â”‚Â Â  â”œâ”€â”€ registry
â”‚Â Â  â”œâ”€â”€ router.go
â”‚Â Â  â”œâ”€â”€ static
â”‚Â Â  â””â”€â”€ util
â””â”€â”€ server // æœåŠ¡å®šä¹‰å’Œå¯åŠ¨
â”œâ”€â”€ acme
â”œâ”€â”€ cors
â”œâ”€â”€ http
â”œâ”€â”€ options.go
â””â”€â”€ server.go
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="config">Config&lt;/h3>
&lt;blockquote>
&lt;p>&lt;code>config&lt;/code> ä½œä¸ºåŠ¨æ€é…ç½®ä¸­å¿ƒçš„æ¥å£å®šä¹‰å’Œå®ç°ã€‚æ”¯æŒåŠ¨æ€åŠ è½½ã€æ’ä»¶å¼é…ç½®æºã€é…ç½®åˆå¹¶å’Œè§‚å¯Ÿé…ç½®å˜åŒ–ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>æ¥å£å®šä¹‰ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;span class="lnt">70
&lt;/span>&lt;span class="lnt">71
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// Config is an interface abstraction for dynamic configuration
&lt;/span>&lt;span class="c1">// é…ç½®æ¥å£å®šä¹‰
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">Config&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// provide the reader.Values interface
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// è¯»å–åˆ°çš„é…ç½®çš„reader
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">reader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Values&lt;/span>
&lt;span class="c1">// Init the config
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Init&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">opts&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="nx">Option&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="c1">// Options in the config
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Options&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="nx">Options&lt;/span>
&lt;span class="c1">// Stop the config loader/watcher
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="c1">// Load config sources
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// å¯ä»¥åŠ è½½å¤šä¸ªSource
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Load&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">source&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="nx">source&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Source&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="c1">// Force a source changeset sync
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// åŒæ­¥é…ç½®å˜åŒ–
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Sync&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="c1">// Watch a value for changes
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// è®¢é˜…é…ç½®å˜åŒ–
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Watch&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">path&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">Watcher&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// Watcher is the config watcher
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">Watcher&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">Next&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">reader&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Value&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nf">Stop&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// Source is the source from which config is loaded
&lt;/span>&lt;span class="c1">// Source å°±æ˜¯é…ç½®æ¥æº go-micro å·²å®ç°åŸºäºconsulï¼Œetcdï¼Œfileç­‰å¤šç§é…ç½®æ¥æºï¼Œä¹Ÿå¯ä»¥è‡ªå·±å®ç°ä¸‹é¢æ¥å£æ¥ä½¿ç”¨
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">Source&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">Read&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">ChangeSet&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nf">Write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">ChangeSet&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="nf">Watch&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">Watcher&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nf">String&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// Reader is an interface for merging changesets
&lt;/span>&lt;span class="c1">// ç”¨äºé…ç½®åˆå¹¶
&lt;/span>&lt;span class="c1">// go-micro å®ç°äº†åŸºäºjsonçš„Reader,é»˜è®¤ç”¨jsonä½œä¸ºè§£æé…ç½®å†…å®¹ï¼Œå¹¶åœ¨æ’ä»¶ç›®å½•å†…å®ç°äº† toml yaml xmlç­‰æ ¼å¼çš„Encoderå¯ä»¥æŒ‰éœ€æ±‚æ›¿æ¢
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">Reader&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">Merge&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">...*&lt;/span>&lt;span class="nx">source&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ChangeSet&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">source&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ChangeSet&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nf">Values&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">source&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ChangeSet&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">Values&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nf">String&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// Values is returned by the reader
&lt;/span>&lt;span class="c1">// ç”¨äºè¯»å†™é…ç½®ï¼Œè¯»å–çš„é…ç½®ä¼šè¿”å› Value
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">Values&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">Bytes&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>
&lt;span class="nf">Get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">path&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">Value&lt;/span>
&lt;span class="nf">Set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">val&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="nx">path&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nf">Del&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">path&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nf">Map&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="nf">Scan&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">v&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// Value represents a value of any type
&lt;/span>&lt;span class="c1">// Value ä¸ºæ‹¿åˆ°çš„é…ç½®ï¼Œå¯ä»¥é€šè¿‡å…¶æ–¹æ³•è½¬åˆ°åŸºç¡€ç±»å‹ã€‚
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">Value&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">Bool&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">def&lt;/span> &lt;span class="kt">bool&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">bool&lt;/span>
&lt;span class="nf">Int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">def&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;span class="nf">String&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">def&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="nf">Float64&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">def&lt;/span> &lt;span class="kt">float64&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">float64&lt;/span>
&lt;span class="nf">Duration&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">def&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Duration&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Duration&lt;/span>
&lt;span class="nf">StringSlice&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">def&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span>
&lt;span class="nf">StringMap&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">def&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">string&lt;/span>
&lt;span class="nf">Scan&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">val&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="nf">Bytes&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç›®å½•ç»“æ„ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ tree -L &lt;span class="m">2&lt;/span>
.
â”œâ”€â”€ README.md
â”œâ”€â”€ config.go // Config æ¥å£å®šä¹‰
â”œâ”€â”€ default.go // é»˜è®¤å®ç°çš„Config
â”œâ”€â”€ default_test.go
â”œâ”€â”€ encoder // encoder è§£æé…ç½®å†…å®¹
â”‚Â Â  â”œâ”€â”€ encoder.go
â”‚Â Â  â””â”€â”€ json // jsonå®ç°
â”œâ”€â”€ loader // åŠ è½½é…ç½®
â”‚Â Â  â”œâ”€â”€ loader.go
â”‚Â Â  â””â”€â”€ memory // åŸºäºå†…å­˜çš„åŠ è½½ï¼Œå³å¯åŠ¨æ—¶ä¼šå°†é…ç½®åŠ è½½åˆ°å†…å­˜
â”œâ”€â”€ options.go
â”œâ”€â”€ reader // å®šä¹‰å’Œå®ç°Readerï¼Œå†…éƒ¨ä¾èµ–Encoder
â”‚Â Â  â”œâ”€â”€ json
â”‚Â Â  â”œâ”€â”€ options.go
â”‚Â Â  â”œâ”€â”€ preprocessor.go
â”‚Â Â  â”œâ”€â”€ preprocessor_test.go
â”‚Â Â  â””â”€â”€ reader.go
â”œâ”€â”€ secrets // å®šä¹‰å’Œå®ç°éœ€è¦åŠ è§£å¯†çš„é…ç½®
â”‚Â Â  â”œâ”€â”€ box
â”‚Â Â  â”œâ”€â”€ secretbox
â”‚Â Â  â””â”€â”€ secrets.go
â”œâ”€â”€ &lt;span class="nb">source&lt;/span> // é…ç½®æ¥æº
â”‚Â Â  â”œâ”€â”€ changeset.go
â”‚Â Â  â”œâ”€â”€ cli
â”‚Â Â  â”œâ”€â”€ env // åŸºäºç¯å¢ƒå˜é‡çš„å®ç°
â”‚Â Â  â”œâ”€â”€ file // åŸºäºæœ¬åœ°æ–‡ä»¶å®ç°
â”‚Â Â  â”œâ”€â”€ flag // åŸºäºå¯åŠ¨å‚æ•°flagå®ç°
â”‚Â Â  â”œâ”€â”€ memory // åŸºäºå†…å­˜å®ç°
â”‚Â Â  â”œâ”€â”€ noop.go
â”‚Â Â  â”œâ”€â”€ options.go
â”‚Â Â  â””â”€â”€ source.go
â””â”€â”€ value.go
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>plugins/config/encoder&lt;/code> ç›®å½•:&lt;/p>
&lt;blockquote>
&lt;p>å®ç°Encoderæ¥å£&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ tree
plugins/config/encoder
â”œâ”€â”€ cue
â”œâ”€â”€ hcl
â”œâ”€â”€ toml
â”œâ”€â”€ xml
â””â”€â”€ yaml
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>plugins/config/source&lt;/code> ç›®å½•ï¼š&lt;/p>
&lt;blockquote>
&lt;p>å®ç°Sourceæ¥å£&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ tree
plugins/config/source
â”œâ”€â”€ configmap
â”œâ”€â”€ consul
â”œâ”€â”€ etcd
â”œâ”€â”€ grpc
â”œâ”€â”€ mucp
â”œâ”€â”€ pkger
â”œâ”€â”€ runtimevar
â”œâ”€â”€ url
â””â”€â”€ vault
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="logger">Logger&lt;/h3>
&lt;blockquote>
&lt;p>&lt;code>Logger&lt;/code> åŒ…ä¸ºå…¨å±€æ—¥å¿—åº“ï¼Œé»˜è®¤å®ç°äº†ä¸€å¥—ï¼Œå¹¶åœ¨&lt;code>plugins&lt;/code> å†…å®ç°äº†åŸºäº logrusï¼Œzapçš„ä¸ªä¸»æµçš„æ—¥å¿—çš„å®ç°ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>æ¥å£å®šä¹‰ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// Logger is a generic logging interface
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">Logger&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Init initialises options
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Init&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">options&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="nx">Option&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="c1">// The Logger options
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Options&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="nx">Options&lt;/span>
&lt;span class="c1">// Fields set fields to always be logged
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Fields&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">fields&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="nx">Logger&lt;/span>
&lt;span class="c1">// Log writes a log entry
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">level&lt;/span> &lt;span class="nx">Level&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span>
&lt;span class="c1">// Logf writes a formatted log entry
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Logf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">level&lt;/span> &lt;span class="nx">Level&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">format&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span>
&lt;span class="c1">// String returns the name of logger
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">String&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è‹¥éœ€è¦è‡ªå·±å®šä¹‰æ—¥å¿—æ ¼å¼å’Œæ—¥å¿—åº“ï¼Œå¯ä»¥å®ç°ä¸Šé¢æ¥å£ï¼Œå¹¶åˆå§‹åŒ–çš„æ—¶å€™æŒ‡å®šå³å¯ã€‚&lt;/p>
&lt;h3 id="plugins">plugins&lt;/h3>
&lt;blockquote>
&lt;p>è¯¥ç›®å½•ä½œä¸ºæ’ä»¶ç›®å½•ï¼Œå®ç°äº†å¤§éƒ¨åˆ†é¢„å®šä¹‰çš„æ¥å£ï¼Œæ–¹ä¾¿ä½¿ç”¨çš„æ—¶å€™æ›¿æ¢æˆé»˜è®¤å®ç°çš„æ¨¡å—ä»£ç ã€‚
è¯¥ç›®å½•ä¸‹æ‰€æœ‰å­ç›®å½•å‡å¯ä»¥ä½œä¸ºgo mod package å¯¼å…¥ä½¿ç”¨
åœ¨ä¹‹åè®²å¦‚ä½•ä½¿ç”¨æ˜¯ åŒæ—¶æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨æ’ä»¶&lt;/p>
&lt;/blockquote>
&lt;p>ç›®å½•ç»“æ„ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt"> 10
&lt;/span>&lt;span class="lnt"> 11
&lt;/span>&lt;span class="lnt"> 12
&lt;/span>&lt;span class="lnt"> 13
&lt;/span>&lt;span class="lnt"> 14
&lt;/span>&lt;span class="lnt"> 15
&lt;/span>&lt;span class="lnt"> 16
&lt;/span>&lt;span class="lnt"> 17
&lt;/span>&lt;span class="lnt"> 18
&lt;/span>&lt;span class="lnt"> 19
&lt;/span>&lt;span class="lnt"> 20
&lt;/span>&lt;span class="lnt"> 21
&lt;/span>&lt;span class="lnt"> 22
&lt;/span>&lt;span class="lnt"> 23
&lt;/span>&lt;span class="lnt"> 24
&lt;/span>&lt;span class="lnt"> 25
&lt;/span>&lt;span class="lnt"> 26
&lt;/span>&lt;span class="lnt"> 27
&lt;/span>&lt;span class="lnt"> 28
&lt;/span>&lt;span class="lnt"> 29
&lt;/span>&lt;span class="lnt"> 30
&lt;/span>&lt;span class="lnt"> 31
&lt;/span>&lt;span class="lnt"> 32
&lt;/span>&lt;span class="lnt"> 33
&lt;/span>&lt;span class="lnt"> 34
&lt;/span>&lt;span class="lnt"> 35
&lt;/span>&lt;span class="lnt"> 36
&lt;/span>&lt;span class="lnt"> 37
&lt;/span>&lt;span class="lnt"> 38
&lt;/span>&lt;span class="lnt"> 39
&lt;/span>&lt;span class="lnt"> 40
&lt;/span>&lt;span class="lnt"> 41
&lt;/span>&lt;span class="lnt"> 42
&lt;/span>&lt;span class="lnt"> 43
&lt;/span>&lt;span class="lnt"> 44
&lt;/span>&lt;span class="lnt"> 45
&lt;/span>&lt;span class="lnt"> 46
&lt;/span>&lt;span class="lnt"> 47
&lt;/span>&lt;span class="lnt"> 48
&lt;/span>&lt;span class="lnt"> 49
&lt;/span>&lt;span class="lnt"> 50
&lt;/span>&lt;span class="lnt"> 51
&lt;/span>&lt;span class="lnt"> 52
&lt;/span>&lt;span class="lnt"> 53
&lt;/span>&lt;span class="lnt"> 54
&lt;/span>&lt;span class="lnt"> 55
&lt;/span>&lt;span class="lnt"> 56
&lt;/span>&lt;span class="lnt"> 57
&lt;/span>&lt;span class="lnt"> 58
&lt;/span>&lt;span class="lnt"> 59
&lt;/span>&lt;span class="lnt"> 60
&lt;/span>&lt;span class="lnt"> 61
&lt;/span>&lt;span class="lnt"> 62
&lt;/span>&lt;span class="lnt"> 63
&lt;/span>&lt;span class="lnt"> 64
&lt;/span>&lt;span class="lnt"> 65
&lt;/span>&lt;span class="lnt"> 66
&lt;/span>&lt;span class="lnt"> 67
&lt;/span>&lt;span class="lnt"> 68
&lt;/span>&lt;span class="lnt"> 69
&lt;/span>&lt;span class="lnt"> 70
&lt;/span>&lt;span class="lnt"> 71
&lt;/span>&lt;span class="lnt"> 72
&lt;/span>&lt;span class="lnt"> 73
&lt;/span>&lt;span class="lnt"> 74
&lt;/span>&lt;span class="lnt"> 75
&lt;/span>&lt;span class="lnt"> 76
&lt;/span>&lt;span class="lnt"> 77
&lt;/span>&lt;span class="lnt"> 78
&lt;/span>&lt;span class="lnt"> 79
&lt;/span>&lt;span class="lnt"> 80
&lt;/span>&lt;span class="lnt"> 81
&lt;/span>&lt;span class="lnt"> 82
&lt;/span>&lt;span class="lnt"> 83
&lt;/span>&lt;span class="lnt"> 84
&lt;/span>&lt;span class="lnt"> 85
&lt;/span>&lt;span class="lnt"> 86
&lt;/span>&lt;span class="lnt"> 87
&lt;/span>&lt;span class="lnt"> 88
&lt;/span>&lt;span class="lnt"> 89
&lt;/span>&lt;span class="lnt"> 90
&lt;/span>&lt;span class="lnt"> 91
&lt;/span>&lt;span class="lnt"> 92
&lt;/span>&lt;span class="lnt"> 93
&lt;/span>&lt;span class="lnt"> 94
&lt;/span>&lt;span class="lnt"> 95
&lt;/span>&lt;span class="lnt"> 96
&lt;/span>&lt;span class="lnt"> 97
&lt;/span>&lt;span class="lnt"> 98
&lt;/span>&lt;span class="lnt"> 99
&lt;/span>&lt;span class="lnt">100
&lt;/span>&lt;span class="lnt">101
&lt;/span>&lt;span class="lnt">102
&lt;/span>&lt;span class="lnt">103
&lt;/span>&lt;span class="lnt">104
&lt;/span>&lt;span class="lnt">105
&lt;/span>&lt;span class="lnt">106
&lt;/span>&lt;span class="lnt">107
&lt;/span>&lt;span class="lnt">108
&lt;/span>&lt;span class="lnt">109
&lt;/span>&lt;span class="lnt">110
&lt;/span>&lt;span class="lnt">111
&lt;/span>&lt;span class="lnt">112
&lt;/span>&lt;span class="lnt">113
&lt;/span>&lt;span class="lnt">114
&lt;/span>&lt;span class="lnt">115
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ tree
plugins
â”œâ”€â”€ LICENSE
â”œâ”€â”€ README.md
â”œâ”€â”€ auth // ç”¨æˆ·è®¤çœŸ
â”‚Â Â  â””â”€â”€ jwt // å®ç°åŸºäºjwtçš„authæ¥å£
â”œâ”€â”€ broker // æ”¯æŒäº†å¸‚é¢ä¸Šå¤§éƒ¨åˆ†æ¶ˆæ¯é˜Ÿåˆ—
â”‚Â Â  â”œâ”€â”€ gocloud
â”‚Â Â  â”œâ”€â”€ googlepubsub
â”‚Â Â  â”œâ”€â”€ grpc
â”‚Â Â  â”œâ”€â”€ http
â”‚Â Â  â”œâ”€â”€ kafka
â”‚Â Â  â”œâ”€â”€ memory
â”‚Â Â  â”œâ”€â”€ mqtt
â”‚Â Â  â”œâ”€â”€ nats
â”‚Â Â  â”œâ”€â”€ nsq
â”‚Â Â  â”œâ”€â”€ proxy
â”‚Â Â  â”œâ”€â”€ rabbitmq
â”‚Â Â  â”œâ”€â”€ redis
â”‚Â Â  â”œâ”€â”€ segmentio
â”‚Â Â  â”œâ”€â”€ snssqs
â”‚Â Â  â”œâ”€â”€ sqs
â”‚Â Â  â”œâ”€â”€ stan
â”‚Â Â  â””â”€â”€ stomp
â”œâ”€â”€ client // æ”¯æŒäº†grpc http ç­‰æ–¹å¼çš„å®¢æˆ·ç«¯å®ç°
â”‚Â Â  â”œâ”€â”€ grpc
â”‚Â Â  â”œâ”€â”€ http
â”‚Â Â  â”œâ”€â”€ mock
â”‚Â Â  â””â”€â”€ mucp
â”œâ”€â”€ codec // æ¶ˆæ¯çš„ç¼–ç è§£ç çš„å®ç°
â”‚Â Â  â”œâ”€â”€ bsonrpc
â”‚Â Â  â”œâ”€â”€ json-iterator
â”‚Â Â  â”œâ”€â”€ jsonrpc2
â”‚Â Â  â”œâ”€â”€ msgpackrpc
â”‚Â Â  â””â”€â”€ segmentio
â”œâ”€â”€ config // é…ç½®
â”‚ â”œâ”€â”€ encoder // é…ç½®ç¼–ç è§£ç 
â”‚Â Â  â”œâ”€â”€ cue
â”‚Â Â  â”œâ”€â”€ hcl
â”‚Â Â  â”œâ”€â”€ toml
â”‚Â Â  â”œâ”€â”€ xml
â”‚Â Â  â””â”€â”€ yaml
â”‚ â””â”€â”€ &lt;span class="nb">source&lt;/span> // é…ç½®æ•°æ®æº
â”‚ â”œâ”€â”€ configmap
â”‚ â”œâ”€â”€ consul
â”‚ â”œâ”€â”€ etcd
â”‚ â”œâ”€â”€ grpc
â”‚ â”œâ”€â”€ mucp
â”‚ â”œâ”€â”€ pkger
â”‚ â”œâ”€â”€ runtimevar
â”‚ â”œâ”€â”€ url
â”‚ â””â”€â”€ vault
â”œâ”€â”€ logger // æ—¥å¿—åº“
â”‚Â Â  â”œâ”€â”€ apex
â”‚Â Â  â”œâ”€â”€ logrus
â”‚Â Â  â”œâ”€â”€ zap
â”‚Â Â  â””â”€â”€ zerolog
â”œâ”€â”€ plugin.go
â”œâ”€â”€ proxy
â”‚Â Â  â””â”€â”€ http
â”œâ”€â”€ registry // æœåŠ¡å‘ç°æœåŠ¡æ³¨å†Œ
â”‚Â Â  â”œâ”€â”€ cache
â”‚Â Â  â”œâ”€â”€ consul
â”‚Â Â  â”œâ”€â”€ etcd
â”‚Â Â  â”œâ”€â”€ eureka
â”‚Â Â  â”œâ”€â”€ gossip
â”‚Â Â  â”œâ”€â”€ kubernetes
â”‚Â Â  â”œâ”€â”€ mdns
â”‚Â Â  â”œâ”€â”€ memory
â”‚Â Â  â”œâ”€â”€ multi
â”‚Â Â  â”œâ”€â”€ nats
â”‚Â Â  â”œâ”€â”€ proxy
â”‚Â Â  â””â”€â”€ zookeeper
â”œâ”€â”€ release.sh
â”œâ”€â”€ selector // è´Ÿè½½å‡è¡¡
â”‚Â Â  â”œâ”€â”€ dns
â”‚Â Â  â”œâ”€â”€ label
â”‚Â Â  â”œâ”€â”€ registry
â”‚Â Â  â”œâ”€â”€ shard
â”‚Â Â  â””â”€â”€ static
â”œâ”€â”€ server // åç«¯æœåŠ¡
â”‚Â Â  â”œâ”€â”€ grpc
â”‚Â Â  â”œâ”€â”€ http
â”‚Â Â  â””â”€â”€ mucp
â”œâ”€â”€ store // æ•°æ®å­˜å‚¨çš„å®ç°
â”‚Â Â  â”œâ”€â”€ cockroach
â”‚Â Â  â”œâ”€â”€ consul
â”‚Â Â  â”œâ”€â”€ file
â”‚Â Â  â”œâ”€â”€ memcached
â”‚Â Â  â”œâ”€â”€ memory
â”‚Â Â  â”œâ”€â”€ mysql
â”‚Â Â  â””â”€â”€ redis
â”œâ”€â”€ sync // æ•°æ®åŒæ­¥
â”‚Â Â  â”œâ”€â”€ etcd
â”‚Â Â  â””â”€â”€ memory
â”œâ”€â”€ template.go
â”œâ”€â”€ transport // æœåŠ¡ä¹‹é—´é€šè®¯æ¨¡å—
â”‚Â Â  â”œâ”€â”€ grpc
â”‚Â Â  â”œâ”€â”€ http
â”‚Â Â  â”œâ”€â”€ memory
â”‚Â Â  â”œâ”€â”€ nats
â”‚Â Â  â”œâ”€â”€ quic
â”‚Â Â  â”œâ”€â”€ rabbitmq
â”‚Â Â  â”œâ”€â”€ tcp
â”‚Â Â  â””â”€â”€ utp
â””â”€â”€ wrapper // è‡ªå®šä¹‰ç»„ä»¶ æ¯”å¦‚ç›‘æ§ã€é™æµã€ç†”æ–­ã€è¿½è¸ªç­‰
â”œâ”€â”€ README.md
â”œâ”€â”€ breaker // ç†”æ–­
â”œâ”€â”€ endpoint // æŒ‡å®šæœåŠ¡èŠ‚ç‚¹
â”œâ”€â”€ monitoring // ç›‘æ§
â”œâ”€â”€ ratelimiter // é™æµ
â”œâ”€â”€ &lt;span class="k">select&lt;/span> // è´Ÿè½½å‡è¡¡
â”œâ”€â”€ service
â”œâ”€â”€ trace // é“¾è·¯è¿½è¸ª
â””â”€â”€ validator // å‚æ•°æ ¡éªŒï¼ˆå¤„ç†è¯·æ±‚æ—¶ å¯ä»¥ç»Ÿä¸€å‚æ•°æ ¡éªŒç­‰å·¥ä½œï¼‰
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="registry">Registry&lt;/h3>
&lt;blockquote>
&lt;p>æœåŠ¡å‘ç°/æœåŠ¡æ³¨å†Œç›¸å…³é€»è¾‘å‡åœ¨ &lt;code>registry&lt;/code> åŒ…å†…å®ç°ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>æ ¸å¿ƒæ¥å£å®šä¹‰ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// The registry provides an interface for service discovery
&lt;/span>&lt;span class="c1">// and an abstraction over varying implementations
&lt;/span>&lt;span class="c1">// {consul, etcd, zookeeper, ...}
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">Registry&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">Init&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="nx">Option&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="nf">Options&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="nx">Options&lt;/span>
&lt;span class="c1">// æœåŠ¡æ³¨å†Œ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Register&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">Service&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="nx">RegisterOption&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="c1">// æœåŠ¡æ³¨é”€
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Deregister&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">Service&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="nx">DeregisterOption&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="c1">// æŸ¥è¯¢æœåŠ¡
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">GetService&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="nx">GetOption&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">([]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">Service&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// åˆ—å‡ºæœåŠ¡åˆ—è¡¨
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">ListServices&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="nx">ListOption&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">([]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">Service&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// ç›‘æ§æœåŠ¡
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Watch&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="nx">WatchOption&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">Watcher&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nf">String&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// Watcher is an interface that returns updates
&lt;/span>&lt;span class="c1">// about services within the registry.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">Watcher&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Next is a blocking call
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Next&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">Result&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nf">Stop&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="selector">Selector&lt;/h3>
&lt;blockquote>
&lt;p>è´Ÿè½½å‡è¡¡é€»è¾‘ï¼Œå³å®¢æˆ·ç«¯è¯·æ±‚å…¶ä»–æœåŠ¡æ—¶å¦‚ä½•é€‰å–æœåŠ¡èŠ‚ç‚¹éƒ½æ˜¯åœ¨è¯¥åŒ…å†…å®ç°ã€‚å¯ä»¥é€šè¿‡optionæŒ‡å®šç­–ç•¥ï¼Œéšæœºï¼Œè½®è¯¢ç­‰ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>æ¥å£å®šä¹‰ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// Selector builds on the registry as a mechanism to pick nodes
&lt;/span>&lt;span class="c1">// and mark their status. This allows host pools and other things
&lt;/span>&lt;span class="c1">// to be built using various algorithms.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">Selector&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">Init&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">opts&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="nx">Option&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="nf">Options&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="nx">Options&lt;/span>
&lt;span class="c1">// Select returns a function which should return the next node
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Select&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">service&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">opts&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="nx">SelectOption&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">Next&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// Mark sets the success/error against a node
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Mark&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">service&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">node&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Node&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// Reset returns state back to zero for a service
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Reset&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">service&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// Close renders the selector unusable
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="c1">// Name of the selector
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">String&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// Next is a function that returns the next node
&lt;/span>&lt;span class="c1">// based on the selector&amp;#39;s strategy
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">Next&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Node&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="server">Server&lt;/h3>
&lt;blockquote>
&lt;p>server åŒ…ä¸ºå®šä¹‰å’Œå®ç°ç®¡ç†æœåŠ¡ç›¸å…³é€»è¾‘ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>serverçš„å®šä¹‰ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// Server is a simple micro server abstraction
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">Server&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Initialise options
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Init&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="nx">Option&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="c1">// Retrieve the options
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Options&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="nx">Options&lt;/span>
&lt;span class="c1">// Register a handler
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Handle&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">Handler&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="c1">// Create a new handler
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">NewHandler&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="nx">HandlerOption&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">Handler&lt;/span>
&lt;span class="c1">// Create a new subscriber
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">NewSubscriber&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="nx">SubscriberOption&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">Subscriber&lt;/span>
&lt;span class="c1">// Register a subscriber
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Subscribe&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">Subscriber&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="c1">// Start the server
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Start&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="c1">// Stop the server
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Stop&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="c1">// Server implementation
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">String&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// Router handle serving messages
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">Router&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// ProcessMessage processes a message
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// å¤„ç†æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆæ¯
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">ProcessMessage&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">Message&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="c1">// ServeRequest processes a request to completion
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// å¤„ç† http/rpc è¯·æ±‚
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">ServeRequest&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">Request&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">Response&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é»˜è®¤å®ç°äº†rpcå’Œæ¶ˆæ¯é˜Ÿåˆ—ï¼ŒhttpæœåŠ¡ å¯ä»¥ä½¿ç”¨&lt;code>plugins/server/http&lt;/code> åŒ…ã€‚&lt;/p>
&lt;h3 id="store">Store&lt;/h3>
&lt;blockquote>
&lt;p>è¯¥åŒ…å®šä¹‰äº†æ•°æ®å­˜å‚¨çš„æ¥å£ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>æ¥å£å®šä¹‰ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// Store is a data storage interface
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">Store&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Init initialises the store. It must perform any required setup on the backing storage implementation and check that it is ready for use, returning any errors.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Init&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="nx">Option&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="c1">// Options allows you to view the current options.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Options&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="nx">Options&lt;/span>
&lt;span class="c1">// Read takes a single key name and optional ReadOptions. It returns matching []*Record or an error.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Read&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">key&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">opts&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="nx">ReadOption&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">([]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">Record&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// Write() writes a record to the store, and returns an error if the record was not written.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">r&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Record&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">opts&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="nx">WriteOption&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="c1">// Delete removes the record with the corresponding key from the store.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Delete&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">key&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">opts&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="nx">DeleteOption&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="c1">// List returns any keys that match, or an empty list with no error if none matched.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">List&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">opts&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="nx">ListOption&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">([]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// Close the store
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="c1">// String returns the name of the implementation.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">String&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å…·ä½“ä½¿ç”¨æ•°æ®åº“ç±»å‹ï¼Œåœ¨&lt;code>plugins/store&lt;/code> å†…åˆå§‹åŒ–å¯¹åº”çš„å®ä¾‹ã€‚&lt;/p>
&lt;h3 id="sync">Sync&lt;/h3>
&lt;blockquote>
&lt;p>&lt;code>sync&lt;/code> åŒ…ä¸ºå®šä¹‰åˆ†å¸ƒå¼é€‰ä¸¾å’Œåˆ†å¸ƒå¼é”çš„å®šä¹‰ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>æ¥å£å®šä¹‰ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// Sync is an interface for distributed synchronization
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">Sync&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Initialise options
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Init&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="nx">Option&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="c1">// Return the options
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Options&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="nx">Options&lt;/span>
&lt;span class="c1">// Elect a leader
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// é€‰ä¸¾
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Leader&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">id&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">opts&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="nx">LeaderOption&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">Leader&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// Lock acquires a lock
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// ä¸Šé”
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Lock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">id&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">opts&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="nx">LockOption&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="c1">// Unlock releases a lock
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// é‡Šæ”¾é”
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Unlock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">id&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="c1">// Sync implementation
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">String&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// Leader provides leadership election
&lt;/span>&lt;span class="c1">// æä¾›åˆ†å¸ƒå¼é€‰ä¸¾
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">Leader&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// resign leadership
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// è¾èŒ å³æ”¾å¼ƒLeaderçŠ¶æ€
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Resign&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="c1">// status returns when leadership is lost
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// åœ¨leader çŠ¶æ€å¤±å»æ—¶ï¼Œchannelå†…å¯è¯»å–
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Status&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="kt">bool&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></content><category scheme="https://yusank.github.io/categories/microservice/" term="microservice" label="microservice"/><category scheme="https://yusank.github.io/tags/go/" term="go" label="go"/><category scheme="https://yusank.github.io/tags/go-micro/" term="go-micro" label="go-micro"/></entry><entry><title type="text">Go é¢è¯•æ€»ç»“</title><link rel="alternate" type="text/html" href="https://yusank.github.io/posts/go-interview/"/><id>https://yusank.github.io/posts/go-interview/</id><updated>2021-09-18T06:24:55+00:00</updated><published>2021-05-31T21:13:41+08:00</published><author><name>yusank</name><uri>https://yusank.github.io/</uri><email>yusankurban@gmail.com</email></author><summary type="html">ç»å†äº†2ä¸ªæœˆçš„é¢è¯•æŠ˜ç£¨ï¼Œæ‹¿åˆ°offeræ€»ç®—ç»“æŸäº†è¿™æ®µæ—¶é—´ã€‚ä¸»è¦æ˜¯æƒ³è®°å½•é¢è¯•ä¸­é‡åˆ°â€¦â€¦</summary><content type="html">&lt;p>ç»å†äº†2ä¸ªæœˆçš„é¢è¯•æŠ˜ç£¨ï¼Œæ‹¿åˆ°offeræ€»ç®—ç»“æŸäº†è¿™æ®µæ—¶é—´ã€‚ä¸»è¦æ˜¯æƒ³è®°å½•é¢è¯•ä¸­é‡åˆ°çš„é—®é¢˜ï¼Œåˆ—å‡ºæ¥çš„é—®é¢˜ä¸ä¸€å®šæœ‰ç­”æ¡ˆï¼Œæœ‰ç­”æ¡ˆä¹Ÿä¸ä¸€å®šæ˜¯æœ€ä½³ç­”æ¡ˆï¼Œæ‰€ä»¥è¿˜æ˜¯çœ‹é—®é¢˜ä¸ºä¸»ï¼Œç­”æ¡ˆè‡ªè¡Œè§£å†³ã€‚&lt;/p>
&lt;h1 id="çŸ¥è¯†æ¶æ„">çŸ¥è¯†æ¶æ„&lt;/h1>
&lt;p>&lt;img src="https://raw.githubusercontent.com/yusank/hugo.yusank.space/master/xmind.png" alt="xmind">&lt;/p>
&lt;h2 id="æ•°æ®åº“">æ•°æ®åº“&lt;/h2>
&lt;h3 id="mysql">MySQL&lt;/h3>
&lt;h4 id="ç´¢å¼•">ç´¢å¼•&lt;/h4>
&lt;ul>
&lt;li>B+tree &lt;a href="https://mp.weixin.qq.com/s/5Yl6H6up9ntZq6l8qxiogw">ç´¢å¼•&lt;/a>
&lt;ul>
&lt;li>æ•°æ®å­˜å‚¨ä½ç½®-åœ¨å¶å­èŠ‚ç‚¹ ç›¸é‚»èŠ‚ç‚¹æ˜¯é“¾è¡¨ç»“æ„ è¿™æ ·å¯ä»¥å®ç° range æŸ¥è¯¢&lt;/li>
&lt;li>è”åˆç´¢å¼• æœ€å·¦åŸåˆ™&lt;/li>
&lt;li>ç´¢å¼•ä¸èƒ½æ˜¯è¡¨è¾¾å¼çš„ä¸€éƒ¨åˆ† å¦åˆ™ä¸èµ°ç´¢å¼•&lt;/li>
&lt;li>ä¸ºä»€ä¹ˆä¸»é”®æ˜¯é€’å¢çš„ï¼Œéšæœºä¼šæ€ä¹ˆæ ·ï¼Ÿ
&lt;ul>
&lt;li>å¦‚æœä½¿ç”¨éè‡ªå¢ä¸»é”®ï¼ˆå¦‚æœèº«ä»½è¯å·æˆ–å­¦å·ç­‰ï¼‰ï¼Œç”±äºæ¯æ¬¡æ’å…¥ä¸»é”®çš„å€¼è¿‘ä¼¼äºéšæœºï¼Œå› æ­¤æ¯æ¬¡æ–°çºªå½•éƒ½è¦è¢«æ’åˆ°ç°æœ‰ç´¢å¼•é¡µå¾—ä¸­é—´æŸä¸ªä½ç½®ï¼Œæ­¤æ—¶MySQLä¸å¾—ä¸ä¸ºäº†å°†æ–°è®°å½•æ’åˆ°åˆé€‚ä½ç½®è€Œ&lt;code>ç§»åŠ¨æ•°æ®&lt;/code>ï¼Œç”šè‡³ç›®æ ‡é¡µé¢å¯èƒ½å·²ç»è¢«å›å†™åˆ°ç£ç›˜ä¸Šè€Œä»ç¼“å­˜ä¸­æ¸…æ‰ï¼Œæ­¤æ—¶åˆè¦ä»ç£ç›˜ä¸Šè¯»å›æ¥ï¼Œè¿™å¢åŠ äº†å¾ˆå¤šå¼€é”€ï¼ŒåŒæ—¶é¢‘ç¹çš„ç§»åŠ¨ã€åˆ†é¡µæ“ä½œé€ æˆäº†&lt;code>å¤§é‡çš„ç¢ç‰‡&lt;/code>ï¼Œå¾—åˆ°äº†ä¸å¤Ÿç´§å‡‘çš„ç´¢å¼•ç»“æ„ï¼Œåç»­ä¸å¾—ä¸é€šè¿‡&lt;code>OPTIMIZE TABLE&lt;/code>æ¥é‡å»ºè¡¨å¹¶ä¼˜åŒ–å¡«å……é¡µé¢ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>å“ˆå¸Œç´¢å¼• - ç²¾å‡†æŸ¥è¯¢&lt;/li>
&lt;li>èšç°‡ç´¢å¼•å’Œéèšç°‡ç´¢å¼•
&lt;img src="https://img2018.cnblogs.com/i-beta/1464190/201911/1464190-20191106145143172-1760681728.png" alt="è¯·çœ‹å›¾">&lt;/li>
&lt;/ul>
&lt;h4 id="äº‹åŠ¡">äº‹åŠ¡&lt;/h4>
&lt;ul>
&lt;li>
&lt;p>äº‹åŠ¡çš„å››ç§ç‰¹æ€§ï¼š&lt;/p>
&lt;ul>
&lt;li>åŸå­æ€§ï¼šä¸€ä¸ªäº‹åŠ¡ï¼ˆtransactionï¼‰ä¸­çš„æ‰€æœ‰æ“ä½œï¼Œè¦ä¹ˆå…¨éƒ¨å®Œæˆï¼Œè¦ä¹ˆå…¨éƒ¨ä¸å®Œæˆï¼Œä¸ä¼šç»“æŸåœ¨ä¸­é—´æŸä¸ªç¯èŠ‚ã€‚äº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œä¼šè¢«å›æ»šï¼ˆRollbackï¼‰åˆ°äº‹åŠ¡å¼€å§‹å‰çš„çŠ¶æ€ï¼Œå°±åƒè¿™ä¸ªäº‹åŠ¡ä»æ¥æ²¡æœ‰æ‰§è¡Œè¿‡ä¸€æ ·ã€‚&lt;/li>
&lt;li>è‡´æ€§ï¼šåœ¨äº‹åŠ¡å¼€å§‹ä¹‹å‰å’Œäº‹åŠ¡ç»“æŸä»¥åï¼Œæ•°æ®åº“çš„å®Œæ•´æ€§æ²¡æœ‰è¢«ç ´åã€‚è¿™è¡¨ç¤ºå†™å…¥çš„èµ„æ–™å¿…é¡»å®Œå…¨ç¬¦åˆæ‰€æœ‰çš„é¢„è®¾è§„åˆ™ï¼Œè¿™åŒ…å«èµ„æ–™çš„ç²¾ç¡®åº¦ã€ä¸²è”æ€§ä»¥åŠåç»­æ•°æ®åº“å¯ä»¥è‡ªå‘æ€§åœ°å®Œæˆé¢„å®šçš„å·¥ä½œã€‚&lt;/li>
&lt;li>éš”ç¦»æ€§ï¼šæ•°æ®åº“å…è®¸å¤šä¸ªå¹¶å‘äº‹åŠ¡åŒæ—¶å¯¹å…¶æ•°æ®è¿›è¡Œè¯»å†™å’Œä¿®æ”¹çš„èƒ½åŠ›ï¼Œéš”ç¦»æ€§å¯ä»¥é˜²æ­¢å¤šä¸ªäº‹åŠ¡å¹¶å‘æ‰§è¡Œæ—¶ç”±äºäº¤å‰æ‰§è¡Œè€Œå¯¼è‡´æ•°æ®çš„ä¸ä¸€è‡´ã€‚äº‹åŠ¡éš”ç¦»åˆ†ä¸ºä¸åŒçº§åˆ«ï¼ŒåŒ…æ‹¬è¯»æœªæäº¤ï¼ˆRead uncommittedï¼‰ã€è¯»æäº¤ï¼ˆread committedï¼‰ã€å¯é‡å¤è¯»ï¼ˆrepeatable readï¼‰å’Œä¸²è¡ŒåŒ–ï¼ˆSerializableï¼‰ã€‚&lt;/li>
&lt;li>æŒä¹…æ€§ï¼šäº‹åŠ¡å¤„ç†ç»“æŸåï¼Œå¯¹æ•°æ®çš„ä¿®æ”¹å°±æ˜¯æ°¸ä¹…çš„ï¼Œå³ä¾¿ç³»ç»Ÿæ•…éšœä¹Ÿä¸ä¼šä¸¢å¤±ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>äº‹åŠ¡çš„&lt;a href="https://tech.meituan.com/2014/08/20/innodb-lock.html">éš”ç¦»çº§åˆ«&lt;/a>ï¼š&lt;/p>
&lt;ul>
&lt;li>æœªæäº¤è¯»(Read Uncommitted)ï¼šå…è®¸è„è¯»ï¼Œä¹Ÿå°±æ˜¯å¯èƒ½è¯»å–åˆ°å…¶ä»–ä¼šè¯ä¸­æœªæäº¤äº‹åŠ¡ä¿®æ”¹çš„æ•°æ®&lt;/li>
&lt;li>æäº¤è¯»(Read Committed)ï¼šåªèƒ½è¯»å–åˆ°å·²ç»æäº¤çš„æ•°æ®ã€‚Oracleç­‰å¤šæ•°æ•°æ®åº“é»˜è®¤éƒ½æ˜¯è¯¥çº§åˆ« (ä¸é‡å¤è¯»)&lt;/li>
&lt;li>å¯é‡å¤è¯»(Repeated Read)ï¼šå¯é‡å¤è¯»ã€‚åœ¨åŒä¸€ä¸ªäº‹åŠ¡å†…çš„æŸ¥è¯¢éƒ½æ˜¯äº‹åŠ¡å¼€å§‹æ—¶åˆ»ä¸€è‡´çš„ï¼ŒInnoDBé»˜è®¤çº§åˆ«ã€‚åœ¨SQLæ ‡å‡†ä¸­ï¼Œè¯¥éš”ç¦»çº§åˆ«æ¶ˆé™¤äº†ä¸å¯é‡å¤è¯»ï¼Œä½†æ˜¯è¿˜å­˜åœ¨å¹»è±¡è¯»&lt;/li>
&lt;li>ä¸²è¡Œè¯»(Serializable)ï¼šå®Œå…¨ä¸²è¡ŒåŒ–çš„è¯»ï¼Œæ¯æ¬¡è¯»éƒ½éœ€è¦è·å¾—è¡¨çº§å…±äº«é”ï¼Œè¯»å†™ç›¸äº’éƒ½ä¼šé˜»å¡&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>éš”ç¦»çº§åˆ«&lt;/th>
&lt;th>è„è¯»ï¼ˆDirty Readï¼‰&lt;/th>
&lt;th>ä¸å¯é‡å¤è¯»ï¼ˆNonRepeatable Readï¼‰&lt;/th>
&lt;th>å¹»è¯»ï¼ˆPhantom Readï¼‰&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>æœªæäº¤è¯»ï¼ˆRead uncommittedï¼‰&lt;/td>
&lt;td>å¯èƒ½&lt;/td>
&lt;td>å¯èƒ½&lt;/td>
&lt;td>å¯èƒ½&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>å·²æäº¤è¯»ï¼ˆRead committedï¼‰&lt;/td>
&lt;td>ä¸å¯èƒ½&lt;/td>
&lt;td>å¯èƒ½&lt;/td>
&lt;td>å¯èƒ½&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>å¯é‡å¤è¯»ï¼ˆRepeatable readï¼‰&lt;/td>
&lt;td>ä¸å¯èƒ½&lt;/td>
&lt;td>ä¸å¯èƒ½&lt;/td>
&lt;td>å¯èƒ½ï¼ˆinnodb ä¸å­˜åœ¨ï¼‰&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>å¯ä¸²è¡ŒåŒ–ï¼ˆSerializable ï¼‰&lt;/td>
&lt;td>ä¸å¯èƒ½&lt;/td>
&lt;td>ä¸å¯èƒ½&lt;/td>
&lt;td>ä¸å¯èƒ½&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h4 id="åˆ†åº“åˆ†è¡¨">åˆ†åº“åˆ†è¡¨&lt;/h4>
&lt;p>æ°´å¹³ï¼š&lt;/p>
&lt;ul>
&lt;li>æ°´å¹³åˆ†è¡¨ -- è¡¨ä¹‹é—´ç»“æ„ç›¸åŒ è¡¨ä¹‹é—´æ•°æ®ä¸ç›¸åŒ æ‰€æœ‰è¡¨çš„æ•°æ®å¹¶é›†æ˜¯æ€»æ•°æ®ï¼ˆå•è¡¨æ•°æ®é‡å¾ˆå¤§ï¼Œå½±å“sqlæ€§èƒ½ï¼‰&lt;/li>
&lt;li>æ°´å¹³åˆ†åº“ -- åº“ä¹‹é—´è¡¨ç»“æ„ç›¸åŒ åº“ä¹‹é—´æ•°æ®ä¸ç›¸åŒ æ‰€æœ‰åº“æ•°æ®çš„å¹¶é›†æ˜¯æ€»æ•°æ®ï¼ˆå¹¶å‘é‡å¾ˆé«˜ï¼Œcpu ç½‘ç»œæ‰›ä¸ä½ï¼Œåˆ†åº“ç¼“è§£å‹åŠ›ï¼‰&lt;/li>
&lt;/ul>
&lt;p>å‚ç›´ï¼š&lt;/p>
&lt;ul>
&lt;li>å‚ç›´åˆ†è¡¨ -- è¡¨ä¹‹é—´ç»“æ„ä¸ç›¸åŒï¼Œæ•°æ®æ ¹æ®æŸä¸ªå­—æ®µå…³è”ï¼Œç¼“è§£ioæ€§èƒ½&lt;/li>
&lt;li>å‚ç›´åˆ†åº“ -- åº“ä¹‹å‰çš„è¡¨ä¹‹é—´ç»“æ„ä¸ç›¸åŒï¼ŒæœåŠ¡å‹åŠ›å¾ˆé«˜ å¯ä»¥è€ƒè™‘æ‹†å‡ºå»åšå•ç‹¬æœåŠ¡äº†&lt;/li>
&lt;/ul>
&lt;p>æ–¹æ¡ˆï¼š&lt;/p>
&lt;p>&lt;strong>æ–¹æ¡ˆä¸€ï¼ˆæ°´å¹³æ‰©å®¹åº“ï¼‰&lt;/strong>
é‡‡ç”¨åŒå€æ‰©å®¹ç­–ç•¥ï¼Œé¿å…æ•°æ®è¿ç§»ã€‚æ‰©å®¹å‰æ¯ä¸ªèŠ‚ç‚¹çš„æ•°æ®ï¼Œæœ‰ä¸€åŠè¦è¿ç§»è‡³ä¸€ä¸ªæ–°å¢èŠ‚ç‚¹ä¸­ï¼Œå¯¹åº”å…³ç³»æ¯”è¾ƒç®€å•ã€‚
å…·ä½“æ“ä½œå¦‚ä¸‹(å‡è®¾å·²æœ‰ 2 ä¸ªèŠ‚ç‚¹ A/Bï¼Œè¦åŒå€æ‰©å®¹è‡³ A/A2/B/B2 è¿™ 4 ä¸ªèŠ‚ç‚¹)ï¼š&lt;/p>
&lt;ul>
&lt;li>æ— éœ€åœæ­¢åº”ç”¨æœåŠ¡å™¨ï¼›&lt;/li>
&lt;li>æ–°å¢ä¸¤ä¸ªæ•°æ®åº“ A2/B2 ä½œä¸ºä»åº“ï¼Œè®¾ç½®ä¸»ä»åŒæ­¥å…³ç³»ä¸ºï¼šA=&amp;gt;A2ã€B=&amp;gt;B2ï¼Œç›´è‡³ä¸»ä»æ•°æ®åŒæ­¥å®Œæ¯•(æ—©æœŸæ•°æ®å¯æ‰‹å·¥åŒæ­¥)ï¼›&lt;/li>
&lt;li>è°ƒæ•´åˆ†ç‰‡è§„åˆ™å¹¶ä½¿ä¹‹ç”Ÿæ•ˆï¼š&lt;/li>
&lt;li>åŸ ID%2=0 =&amp;gt; A æ”¹ä¸º ID%4=0 =&amp;gt; A, ID%4=2 =&amp;gt; A2ï¼›&lt;/li>
&lt;li>åŸ ID%2=1 =&amp;gt; B æ”¹ä¸º ID%4=1 =&amp;gt; B, ID%4=3 =&amp;gt; B2ã€‚&lt;/li>
&lt;li>è§£é™¤æ•°æ®åº“å®ä¾‹çš„ä¸»ä»åŒæ­¥å…³ç³»ï¼Œå¹¶ä½¿ä¹‹ç”Ÿæ•ˆï¼›&lt;/li>
&lt;li>æ­¤æ—¶ï¼Œå››ä¸ªèŠ‚ç‚¹çš„æ•°æ®éƒ½å·²å®Œæ•´ï¼Œåªæ˜¯æœ‰å†—ä½™(å¤šå­˜äº†å’Œè‡ªå·±é…å¯¹çš„èŠ‚ç‚¹çš„é‚£éƒ¨åˆ†æ•°æ®)ï¼Œæ‹©æœºæ¸…é™¤å³å¯(è¿‡åéšæ—¶è¿›è¡Œï¼Œä¸å½±å“ä¸šåŠ¡)ã€‚&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://pic2.zhimg.com/v2-789f54a192017f3fa3138d3bf768cbad_r.jpg" alt="æ°´å¹³æ‰©åº“">&lt;/p>
&lt;p>&lt;strong>æ–¹æ¡ˆäºŒï¼ˆæ°´å¹³æ‰©å®¹è¡¨-åŒå†™ï¼‰&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>ç¬¬ä¸€æ­¥ï¼šï¼ˆåŒæ­¥åŒå†™ï¼‰ä¿®æ”¹åº”ç”¨é…ç½®å’Œä»£ç ï¼ŒåŠ ä¸ŠåŒå†™ï¼Œéƒ¨ç½²&lt;/li>
&lt;li>ç¬¬äºŒæ­¥ï¼šï¼ˆåŒæ­¥åŒå†™ï¼‰å°†è€åº“ä¸­çš„è€æ•°æ®å¤åˆ¶åˆ°æ–°åº“ä¸­&lt;/li>
&lt;li>ç¬¬ä¸‰æ­¥ï¼šï¼ˆåŒæ­¥åŒå†™ï¼‰ä»¥è€åº“ä¸ºå‡†æ ¡å¯¹æ–°åº“ä¸­çš„è€æ•°æ®&lt;/li>
&lt;li>ç¬¬å››æ­¥ï¼šï¼ˆåŒæ­¥åŒå†™ï¼‰ä¿®æ”¹åº”ç”¨é…ç½®å’Œä»£ç ï¼Œå»æ‰åŒå†™ï¼Œéƒ¨ç½²ï¼›&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://pic2.zhimg.com/v2-4847eb9e869a90b8eb293ecdfeb19acd_r.jpg" alt="æ°´å¹³æ‰©å®¹è¡¨">&lt;/p>
&lt;h3 id="redis">Redis&lt;/h3>
&lt;h4 id="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„&lt;/h4>
&lt;ul>
&lt;li>String ç®€å•åŠ¨æ€å­—ç¬¦ä¸²
&lt;ul>
&lt;li>ç¼–ç æ–¹å¼ä¸åŒä¼šæœ‰ä»€ä¹ˆå½±å“&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Set åº•å±‚å“ˆå¸Œè¡¨&lt;/li>
&lt;li>ZSet memberå­˜åœ¨å“ˆå¸Œè¡¨ä¸­ score å­˜åœ¨è·³è¡¨é‡Œ æŸ¥è¯¢æ’å…¥æ—¶é—´å¤æ‚ logn
&lt;ul>
&lt;li>ä¸ºä»€ä¹ˆç”¨è·³è¡¨&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>List åŒå‘é“¾è¡¨ç»“æ„&lt;/li>
&lt;li>Hmap å“ˆå¸Œè¡¨&lt;/li>
&lt;/ul>
&lt;h4 id="æ€§èƒ½">æ€§èƒ½&lt;/h4>
&lt;p>&lt;a href="https://mp.weixin.qq.com/s/b_yzbLeQh57oYjqlIgPiYQ">ä¸ºä»€ä¹ˆè¿™ä¹ˆå¿«&lt;/a>
&lt;a href="https://juejin.cn/post/6915599025882431501?utm_source=gold_browser_extension#heading-4">ä¸ºä»€ä¹ˆè¿™ä¹ˆå¿«2&lt;/a>&lt;/p>
&lt;ul>
&lt;li>æ•°æ®å‡å­˜åœ¨å†…å­˜ï¼ˆå¼•å‘å‡ºæŒä¹…åŒ–é—®é¢˜ï¼‰&lt;/li>
&lt;li>é«˜æ•ˆçš„æ•°æ®ç»“æ„&lt;/li>
&lt;li>å•çº¿ç¨‹ï¼Œçœå»çº¿ç¨‹é—´ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ—¶é—´ ä»¥åŠä¸éœ€è¦è€ƒè™‘é”&lt;/li>
&lt;li>ç½‘ç»œio å¤šè·¯å¤ç”¨ å¯ä»¥è®©å•ä¸ªçº¿ç¨‹å¤„ç†å¤šä¸ªè¯·æ±‚è¿æ¥ å‡å°‘ç½‘ç»œio&lt;/li>
&lt;li>Redisé‡‡ç”¨è‡ªå·±å®ç°çš„äº‹ä»¶åˆ†ç¦»å™¨ï¼Œæ•ˆç‡æ¯”è¾ƒé«˜ï¼Œå†…éƒ¨é‡‡ç”¨éé˜»å¡çš„æ‰§è¡Œæ–¹å¼ï¼Œååèƒ½åŠ›æ¯”è¾ƒå¤§ã€‚&lt;/li>
&lt;/ul>
&lt;h4 id="æŒä¹…åŒ–">æŒä¹…åŒ–&lt;/h4>
&lt;p>ä¸¤ç§æŒä¹…åŒ–ï¼š&lt;/p>
&lt;ul>
&lt;li>RDBæŒä¹…åŒ– å³å†…å­˜æ•°æ®å®šæ—¶dumpåˆ°ç£ç›˜ä¸Šã€‚
&lt;ul>
&lt;li>fork ä¸€ä¸ªå­è¿›ç¨‹ å°†æ•°æ®å†™å…¥ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ å†™å…¥æˆåŠŸå æ›¿æ¢æºæ–‡ä»¶ã€‚&lt;/li>
&lt;li>å¿«ç…§çš„æ•°æ®æ˜¯æˆªæ­¢forkå‘½ä»¤æ‰§è¡Œçš„é‚£ä¸€åˆ»&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>AOF å°†Redisçš„æ“ä½œæ—¥å¿—ä»¥è¿½åŠ çš„æ–¹å¼å†™å…¥æ–‡ä»¶ã€‚
&lt;ul>
&lt;li>å°†æ¯ä¸€ä¸ªå†™ã€åˆ æ“ä½œè®°å½•ä¸‹æ¥ã€‚é»˜è®¤é…ç½®æ—¶æ¯ç§’åŒæ­¥ä¸€æ¬¡ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>RDBå­˜åœ¨å“ªäº›ä¼˜åŠ¿å‘¢ï¼Ÿ&lt;/p>
&lt;p>1). ä¸€æ—¦é‡‡ç”¨è¯¥æ–¹å¼ï¼Œé‚£ä¹ˆä½ çš„æ•´ä¸ªRedisæ•°æ®åº“å°†åªåŒ…å«ä¸€ä¸ªæ–‡ä»¶ï¼Œè¿™å¯¹äºæ–‡ä»¶å¤‡ä»½è€Œè¨€æ˜¯éå¸¸å®Œç¾çš„ã€‚æ¯”å¦‚ï¼Œä½ å¯èƒ½æ‰“ç®—æ¯ä¸ªå°æ—¶å½’æ¡£ä¸€æ¬¡æœ€è¿‘24å°æ—¶çš„æ•°æ®ï¼ŒåŒæ—¶è¿˜è¦æ¯å¤©å½’æ¡£ä¸€æ¬¡æœ€è¿‘30å¤©çš„æ•°æ®ã€‚é€šè¿‡è¿™æ ·çš„å¤‡ä»½ç­–ç•¥ï¼Œä¸€æ—¦ç³»ç»Ÿå‡ºç°ç¾éš¾æ€§æ•…éšœï¼Œæˆ‘ä»¬å¯ä»¥éå¸¸å®¹æ˜“çš„è¿›è¡Œæ¢å¤ã€‚&lt;/p>
&lt;p>2). å¯¹äºç¾éš¾æ¢å¤è€Œè¨€ï¼ŒRDBæ˜¯éå¸¸ä¸é”™çš„é€‰æ‹©ã€‚å› ä¸ºæˆ‘ä»¬å¯ä»¥éå¸¸è½»æ¾çš„å°†ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶å‹ç¼©åå†è½¬ç§»åˆ°å…¶å®ƒå­˜å‚¨ä»‹è´¨ä¸Šã€‚&lt;/p>
&lt;p>3). æ€§èƒ½æœ€å¤§åŒ–ã€‚å¯¹äºRedisçš„æœåŠ¡è¿›ç¨‹è€Œè¨€ï¼Œåœ¨å¼€å§‹æŒä¹…åŒ–æ—¶ï¼Œå®ƒå”¯ä¸€éœ€è¦åšçš„åªæ˜¯forkå‡ºå­è¿›ç¨‹ï¼Œä¹‹åå†ç”±å­è¿›ç¨‹å®Œæˆè¿™äº›æŒä¹…åŒ–çš„å·¥ä½œï¼Œè¿™æ ·å°±å¯ä»¥æå¤§çš„é¿å…æœåŠ¡è¿›ç¨‹æ‰§è¡ŒIOæ“ä½œäº†ã€‚&lt;/p>
&lt;p>4). ç›¸æ¯”äºAOFæœºåˆ¶ï¼Œå¦‚æœæ•°æ®é›†å¾ˆå¤§ï¼ŒRDBçš„å¯åŠ¨æ•ˆç‡ä¼šæ›´é«˜ã€‚&lt;/p>
&lt;p>RDBåˆå­˜åœ¨å“ªäº›åŠ£åŠ¿å‘¢ï¼Ÿ&lt;/p>
&lt;p>1). å¦‚æœä½ æƒ³ä¿è¯æ•°æ®çš„é«˜å¯ç”¨æ€§ï¼Œå³æœ€å¤§é™åº¦çš„é¿å…æ•°æ®ä¸¢å¤±ï¼Œé‚£ä¹ˆRDBå°†ä¸æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚å› ä¸ºç³»ç»Ÿä¸€æ—¦åœ¨å®šæ—¶æŒä¹…åŒ–ä¹‹å‰å‡ºç°å®•æœºç°è±¡ï¼Œæ­¤å‰æ²¡æœ‰æ¥å¾—åŠå†™å…¥ç£ç›˜çš„æ•°æ®éƒ½å°†ä¸¢å¤±ã€‚&lt;/p>
&lt;p>2). ç”±äºRDBæ˜¯é€šè¿‡forkå­è¿›ç¨‹æ¥ååŠ©å®Œæˆæ•°æ®æŒä¹…åŒ–å·¥ä½œçš„ï¼Œå› æ­¤ï¼Œå¦‚æœå½“æ•°æ®é›†è¾ƒå¤§æ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•´ä¸ªæœåŠ¡å™¨åœæ­¢æœåŠ¡å‡ ç™¾æ¯«ç§’ï¼Œç”šè‡³æ˜¯1ç§’é’Ÿã€‚&lt;/p>
&lt;p>AOFçš„ä¼˜åŠ¿æœ‰å“ªäº›å‘¢ï¼Ÿ&lt;/p>
&lt;p>1). è¯¥æœºåˆ¶å¯ä»¥å¸¦æ¥æ›´é«˜çš„æ•°æ®å®‰å…¨æ€§ï¼Œå³æ•°æ®æŒä¹…æ€§ã€‚Redisä¸­æä¾›äº†3ä¸­åŒæ­¥ç­–ç•¥ï¼Œå³æ¯ç§’åŒæ­¥ã€æ¯ä¿®æ”¹åŒæ­¥å’Œä¸åŒæ­¥ã€‚äº‹å®ä¸Šï¼Œæ¯ç§’åŒæ­¥ä¹Ÿæ˜¯å¼‚æ­¥å®Œæˆçš„ï¼Œå…¶æ•ˆç‡ä¹Ÿæ˜¯éå¸¸é«˜çš„ï¼Œæ‰€å·®çš„æ˜¯ä¸€æ—¦ç³»ç»Ÿå‡ºç°å®•æœºç°è±¡ï¼Œé‚£ä¹ˆè¿™ä¸€ç§’é’Ÿä¹‹å†…ä¿®æ”¹çš„æ•°æ®å°†ä¼šä¸¢å¤±ã€‚è€Œæ¯ä¿®æ”¹åŒæ­¥ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶è§†ä¸ºåŒæ­¥æŒä¹…åŒ–ï¼Œå³æ¯æ¬¡å‘ç”Ÿçš„æ•°æ®å˜åŒ–éƒ½ä¼šè¢«ç«‹å³è®°å½•åˆ°ç£ç›˜ä¸­ã€‚å¯ä»¥é¢„è§ï¼Œè¿™ç§æ–¹å¼åœ¨æ•ˆç‡ä¸Šæ˜¯æœ€ä½çš„ã€‚è‡³äºæ— åŒæ­¥ï¼Œæ— éœ€å¤šè¨€ï¼Œæˆ‘æƒ³å¤§å®¶éƒ½èƒ½æ­£ç¡®çš„ç†è§£å®ƒã€‚&lt;/p>
&lt;p>2). ç”±äºè¯¥æœºåˆ¶å¯¹æ—¥å¿—æ–‡ä»¶çš„å†™å…¥æ“ä½œé‡‡ç”¨çš„æ˜¯appendæ¨¡å¼ï¼Œå› æ­¤åœ¨å†™å…¥è¿‡ç¨‹ä¸­å³ä½¿å‡ºç°å®•æœºç°è±¡ï¼Œä¹Ÿä¸ä¼šç ´åæ—¥å¿—æ–‡ä»¶ä¸­å·²ç»å­˜åœ¨çš„å†…å®¹ã€‚ç„¶è€Œå¦‚æœæˆ‘ä»¬æœ¬æ¬¡æ“ä½œåªæ˜¯å†™å…¥äº†ä¸€åŠæ•°æ®å°±å‡ºç°äº†ç³»ç»Ÿå´©æºƒé—®é¢˜ï¼Œä¸ç”¨æ‹…å¿ƒï¼Œåœ¨Redisä¸‹ä¸€æ¬¡å¯åŠ¨ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡redis-check-aofå·¥å…·æ¥å¸®åŠ©æˆ‘ä»¬è§£å†³æ•°æ®ä¸€è‡´æ€§çš„é—®é¢˜ã€‚&lt;/p>
&lt;p>3). å¦‚æœæ—¥å¿—è¿‡å¤§ï¼ŒRediså¯ä»¥è‡ªåŠ¨å¯ç”¨rewriteæœºåˆ¶ã€‚å³Redisä»¥appendæ¨¡å¼ä¸æ–­çš„å°†ä¿®æ”¹æ•°æ®å†™å…¥åˆ°è€çš„ç£ç›˜æ–‡ä»¶ä¸­ï¼ŒåŒæ—¶Redisè¿˜ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶ç”¨äºè®°å½•æ­¤æœŸé—´æœ‰å“ªäº›ä¿®æ”¹å‘½ä»¤è¢«æ‰§è¡Œã€‚å› æ­¤åœ¨è¿›è¡Œrewriteåˆ‡æ¢æ—¶å¯ä»¥æ›´å¥½çš„ä¿è¯æ•°æ®å®‰å…¨æ€§ã€‚&lt;/p>
&lt;p>4). AOFåŒ…å«ä¸€ä¸ªæ ¼å¼æ¸…æ™°ã€æ˜“äºç†è§£çš„æ—¥å¿—æ–‡ä»¶ç”¨äºè®°å½•æ‰€æœ‰çš„ä¿®æ”¹æ“ä½œã€‚äº‹å®ä¸Šï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡è¯¥æ–‡ä»¶å®Œæˆæ•°æ®çš„é‡å»ºã€‚&lt;/p>
&lt;p>AOFçš„åŠ£åŠ¿æœ‰å“ªäº›å‘¢ï¼Ÿ&lt;/p>
&lt;p>1). å¯¹äºç›¸åŒæ•°é‡çš„æ•°æ®é›†è€Œè¨€ï¼ŒAOFæ–‡ä»¶é€šå¸¸è¦å¤§äºRDBæ–‡ä»¶ã€‚RDB åœ¨æ¢å¤å¤§æ•°æ®é›†æ—¶çš„é€Ÿåº¦æ¯” AOF çš„æ¢å¤é€Ÿåº¦è¦å¿«ã€‚&lt;/p>
&lt;p>2). æ ¹æ®åŒæ­¥ç­–ç•¥çš„ä¸åŒï¼ŒAOFåœ¨è¿è¡Œæ•ˆç‡ä¸Šå¾€å¾€ä¼šæ…¢äºRDBã€‚æ€»ä¹‹ï¼Œæ¯ç§’åŒæ­¥ç­–ç•¥çš„æ•ˆç‡æ˜¯æ¯”è¾ƒé«˜çš„ï¼ŒåŒæ­¥ç¦ç”¨ç­–ç•¥çš„æ•ˆç‡å’ŒRDBä¸€æ ·é«˜æ•ˆã€‚&lt;/p>
&lt;p>äºŒè€…é€‰æ‹©çš„æ ‡å‡†ï¼Œå°±æ˜¯çœ‹ç³»ç»Ÿæ˜¯æ„¿æ„ç‰ºç‰²ä¸€äº›æ€§èƒ½ï¼Œæ¢å–æ›´é«˜çš„ç¼“å­˜ä¸€è‡´æ€§ï¼ˆaofï¼‰ï¼Œè¿˜æ˜¯æ„¿æ„å†™æ“ä½œé¢‘ç¹çš„æ—¶å€™ï¼Œä¸å¯ç”¨å¤‡ä»½æ¥æ¢å–æ›´é«˜çš„æ€§èƒ½ï¼Œå¾…æ‰‹åŠ¨è¿è¡Œsaveçš„æ—¶å€™ï¼Œå†åšå¤‡ä»½ï¼ˆrdbï¼‰ã€‚rdbè¿™ä¸ªå°±æ›´æœ‰äº› eventually consistentçš„æ„æ€äº†ã€‚&lt;/p>
&lt;h4 id="å†…å­˜æ¨¡å‹">å†…å­˜æ¨¡å‹&lt;/h4>
&lt;p>&lt;a href="https://mp.weixin.qq.com/s/YGmOoBZ7J-3dPrNntRTfSg">å†…å­˜æ¨¡å‹&lt;/a>&lt;/p>
&lt;h3 id="mongodb">MongoDB&lt;/h3>
&lt;blockquote>
&lt;p>å¾…è¡¥å……&lt;/p>
&lt;/blockquote>
&lt;h3 id="ç¼“å­˜">ç¼“å­˜&lt;/h3>
&lt;blockquote>
&lt;p>å¸¸è§ç¼“å­˜ç­–ç•¥&lt;/p>
&lt;/blockquote>
&lt;p>&lt;a href="https://www.cnblogs.com/lpfuture/p/5796398.html">ä¸€è‡´æ€§å“ˆå¸Œ&lt;/a> è§£å†³æŸä¸ªç¼“å­˜èŠ‚ç‚¹å®•æœºçš„æƒ…å†µã€‚&lt;/p>
&lt;h4 id="ç¼“å­˜ç©¿é€">ç¼“å­˜ç©¿é€&lt;/h4>
&lt;p>æè¿°ï¼šç¼“å­˜ç©¿é€æ˜¯æŒ‡ç¼“å­˜å’Œæ•°æ®åº“ä¸­éƒ½æ²¡æœ‰çš„æ•°æ®ï¼Œè€Œç”¨æˆ·ä¸æ–­å‘èµ·è¯·æ±‚ï¼Œå¦‚å‘èµ·ä¸ºidä¸ºâ€œ-1â€çš„æ•°æ®æˆ–idä¸ºç‰¹åˆ«å¤§ä¸å­˜åœ¨çš„æ•°æ®ã€‚è¿™æ—¶çš„ç”¨æˆ·å¾ˆå¯èƒ½æ˜¯æ”»å‡»è€…ï¼Œæ”»å‡»ä¼šå¯¼è‡´æ•°æ®åº“å‹åŠ›è¿‡å¤§ã€‚&lt;/p>
&lt;p>è§£å†³æ–¹æ¡ˆï¼š&lt;/p>
&lt;ul>
&lt;li>æ¥å£å±‚å¢åŠ æ ¡éªŒï¼Œå¦‚ç”¨æˆ·é‰´æƒæ ¡éªŒï¼ŒidåšåŸºç¡€æ ¡éªŒï¼Œid&amp;lt;=0çš„ç›´æ¥æ‹¦æˆªã€‚&lt;/li>
&lt;li>ä»ç¼“å­˜å–ä¸åˆ°çš„æ•°æ®ï¼Œåœ¨æ•°æ®åº“ä¸­ä¹Ÿæ²¡æœ‰å–åˆ°ï¼Œè¿™æ—¶ä¹Ÿå¯ä»¥å°†key-valueå¯¹å†™ä¸ºkey-nullï¼Œç¼“å­˜æœ‰æ•ˆæ—¶é—´å¯ä»¥è®¾ç½®çŸ­ç‚¹ï¼Œå¦‚30ç§’ï¼ˆè®¾ç½®å¤ªé•¿ä¼šå¯¼è‡´æ­£å¸¸æƒ…å†µä¹Ÿæ²¡æ³•ä½¿ç”¨ï¼‰ã€‚è¿™æ ·å¯ä»¥é˜²æ­¢æ”»å‡»ç”¨æˆ·åå¤ç”¨åŒä¸€ä¸ªidæš´åŠ›æ”»å‡»ã€‚&lt;/li>
&lt;li>&lt;a href="https://zhuanlan.zhihu.com/p/72378274">å¸ƒéš†è¿‡æ»¤å™¨&lt;/a>ï¼šå°†æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„æ•°æ®å“ˆå¸Œåˆ°ä¸€ä¸ªè¶³å¤Ÿå¤§çš„bitmapä¸­ï¼Œä¸€ä¸ªä¸€å®šä¸å­˜åœ¨çš„æ•°æ®ä¼šè¢« è¿™ä¸ªbitmapæ‹¦æˆªæ‰ï¼Œä»è€Œé¿å…äº†å¯¹åº•å±‚å­˜å‚¨ç³»ç»Ÿçš„æŸ¥è¯¢å‹åŠ›ã€‚
&lt;ul>
&lt;li>å¸ƒéš†è¿‡æ»¤å™¨åŸç†ï¼šå¯¹keyè¿›è¡Œå¤šä¸ª(n)hashç®—æ³• å¹¶å°†å…¶å€¼ä¸ bitArray é•¿åº¦m è¿›è¡Œå–æ¨¡ å¹¶å¯¹åº”çš„ä½ç½®ç½®ä½1ï¼Œå½“ä¸€ä¸ªæ–°çš„keyè¿›è¡ŒæŸ¥è¯¢æ—¶ å…ˆæŸ¥è¯¢å…¶nä¸ªhashç®—æ³•åçš„å„ä¸ªä½ç½®æ˜¯å¦ä¸º1 å¦‚æœéƒ½ä¸º1 åˆ™è¿™ä¸ªkeyå¯èƒ½å­˜åœ¨ å¦‚æœæœ‰ä»»æ„ä¸€ä¸ªä½ç½®ä¸æ˜¯1 åˆ™è¿™ä¸ªkey ä¸€å®šä¸å­˜åœ¨ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h4 id="ç¼“å­˜å‡»ç©¿">ç¼“å­˜å‡»ç©¿&lt;/h4>
&lt;p>æè¿°ï¼šç¼“å­˜å‡»ç©¿æ˜¯æŒ‡ç¼“å­˜ä¸­æ²¡æœ‰ä½†æ•°æ®åº“ä¸­æœ‰çš„æ•°æ®ï¼ˆä¸€èˆ¬æ˜¯ç¼“å­˜æ—¶é—´åˆ°æœŸï¼‰ï¼Œè¿™æ—¶ç”±äºå¹¶å‘ç”¨æˆ·ç‰¹åˆ«å¤šï¼ŒåŒæ—¶è¯»ç¼“å­˜æ²¡è¯»åˆ°æ•°æ®ï¼ŒåˆåŒæ—¶å»æ•°æ®åº“å»å–æ•°æ®ï¼Œå¼•èµ·æ•°æ®åº“å‹åŠ›ç¬é—´å¢å¤§ï¼Œé€ æˆè¿‡å¤§å‹åŠ›&lt;/p>
&lt;p>è§£å†³æ–¹æ¡ˆï¼š&lt;/p>
&lt;ul>
&lt;li>çƒ­ç‚¹æ•°æ®ä¸åšè¿‡æœŸ&lt;/li>
&lt;li>äº’æ–¥é”ã€‚å¦‚æœæ•°æ®ç¼“å­˜ä¸å­˜åœ¨ åˆ™å…ˆè¿›è¡Œä¸Šé”è¯»æ•°æ®å†™ç¼“å­˜é‡Šæ”¾é”&lt;/li>
&lt;/ul>
&lt;h4 id="ç¼“å­˜é›ªå´©">ç¼“å­˜é›ªå´©&lt;/h4>
&lt;p>æè¿°ï¼šç¼“å­˜é›ªå´©æ˜¯æŒ‡ç¼“å­˜ä¸­æ•°æ®å¤§æ‰¹é‡åˆ°è¿‡æœŸæ—¶é—´ï¼Œè€ŒæŸ¥è¯¢æ•°æ®é‡å·¨å¤§ï¼Œå¼•èµ·æ•°æ®åº“å‹åŠ›è¿‡å¤§ç”šè‡³downæœºã€‚å’Œç¼“å­˜å‡»ç©¿ä¸åŒçš„æ˜¯ï¼Œç¼“å­˜å‡»ç©¿æŒ‡å¹¶å‘æŸ¥åŒä¸€æ¡æ•°æ®ï¼Œç¼“å­˜é›ªå´©æ˜¯ä¸åŒæ•°æ®éƒ½è¿‡æœŸäº†ï¼Œå¾ˆå¤šæ•°æ®éƒ½æŸ¥ä¸åˆ°ä»è€ŒæŸ¥æ•°æ®åº“ã€‚&lt;/p>
&lt;p>è§£å†³æ–¹æ¡ˆï¼š&lt;/p>
&lt;ul>
&lt;li>è¿‡æœŸæ—¶é—´åŠ éšæœºæ•°&lt;/li>
&lt;li>çƒ­ç‚¹æ•°æ®ä¸è¿‡æœŸ&lt;/li>
&lt;li>åˆ†å¸ƒå¼ç¼“å­˜ å°†çƒ­ç‚¹æ•°æ®æ‹†åˆ†åˆ°ä¸åŒçš„å®ä¾‹&lt;/li>
&lt;/ul>
&lt;h2 id="è¯­è¨€ç‰¹æ€§">è¯­è¨€ç‰¹æ€§&lt;/h2>
&lt;h3 id="gmp">GMP&lt;/h3>
&lt;p>&lt;a href="https://www.cnblogs.com/sunsky303/p/9705727.html">è°ƒåº¦&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://mp.weixin.qq.com/s?__biz=MzA4ODg0NDkzOA==&amp;amp;mid=2247487174&amp;amp;idx=1&amp;amp;sn=a716cc5cc48b7cf6078698942a6c6c18&amp;amp;source=41&amp;amp;key=&amp;amp;ascene=14&amp;amp;uin=&amp;amp;devicetype=Windows+10&amp;amp;version=620603c8&amp;amp;lang=zh_CN&amp;amp;winzoom=1">è°ƒåº¦2&lt;/a>&lt;/p>
&lt;p>&lt;img src="https://camo.githubusercontent.com/9a6338ccd341d0221f1096630c67f74ddf8a9f58f50b3f7f359d88d760d5355a/68747470733a2f2f7a68616f6d656e672d707269766174652e6f73732d636e2d7368616e676861692e616c6979756e63732e636f6d2f696d616765732f676d702e706e67" alt="è°ƒåº¦">&lt;/p>
&lt;h4 id="æ¦‚å¿µ">æ¦‚å¿µ&lt;/h4>
&lt;ul>
&lt;li>Gï¼šä»£è¡¨ä¸€ä¸ªgoroutineå¯¹è±¡ï¼Œæ¯æ¬¡goè°ƒç”¨çš„æ—¶å€™ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªGå¯¹è±¡ï¼Œå®ƒåŒ…æ‹¬æ ˆã€æŒ‡ä»¤æŒ‡é’ˆä»¥åŠå¯¹äºè°ƒç”¨goroutineså¾ˆé‡è¦çš„å…¶å®ƒä¿¡æ¯ï¼Œæ¯”å¦‚é˜»å¡å®ƒçš„ä»»ä½•channelï¼Œå…¶ä¸»è¦æ•°æ®ç»“æ„ï¼š&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">g&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">stack&lt;/span> &lt;span class="nx">stack&lt;/span> &lt;span class="c1">// æè¿°äº†çœŸå®çš„æ ˆå†…å­˜ï¼ŒåŒ…æ‹¬ä¸Šä¸‹ç•Œ
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="nx">m&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">m&lt;/span> &lt;span class="c1">// å½“å‰çš„m
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">sched&lt;/span> &lt;span class="nx">gobuf&lt;/span> &lt;span class="c1">// goroutineåˆ‡æ¢æ—¶ï¼Œç”¨äºä¿å­˜gçš„ä¸Šä¸‹æ–‡
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">param&lt;/span> &lt;span class="nx">unsafe&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Pointer&lt;/span> &lt;span class="c1">// ç”¨äºä¼ é€’å‚æ•°ï¼Œç¡çœ æ—¶å…¶ä»–goroutineå¯ä»¥è®¾ç½®paramï¼Œå”¤é†’æ—¶è¯¥goroutineå¯ä»¥è·å–
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">atomicstatus&lt;/span> &lt;span class="kt">uint32&lt;/span>
&lt;span class="nx">stackLock&lt;/span> &lt;span class="kt">uint32&lt;/span>
&lt;span class="nx">goid&lt;/span> &lt;span class="kt">int64&lt;/span> &lt;span class="c1">// goroutineçš„ID
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">waitsince&lt;/span> &lt;span class="kt">int64&lt;/span> &lt;span class="c1">// gè¢«é˜»å¡çš„å¤§ä½“æ—¶é—´
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">lockedm&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">m&lt;/span> &lt;span class="c1">// Gè¢«é”å®šåªåœ¨è¿™ä¸ªmä¸Šè¿è¡Œ
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>M: ä»£è¡¨å†…æ ¸çº¿ç¨‹(Pthread)ï¼Œå®ƒæœ¬èº«å°±ä¸ä¸€ä¸ªå†…æ ¸çº¿ç¨‹è¿›è¡Œç»‘å®šï¼Œgoroutine è¿è¡Œåœ¨Mä¸Šã€‚&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">m&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="cm">/*
&lt;/span>&lt;span class="cm"> 1. æ‰€æœ‰è°ƒç”¨æ ˆçš„Goroutine,è¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒç‰¹æ®Šçš„Goroutineã€‚
&lt;/span>&lt;span class="cm"> 2. æ™®é€šçš„Goroutineæ ˆæ˜¯åœ¨Heapåˆ†é…çš„å¯å¢é•¿çš„stack,è€Œg0çš„stackæ˜¯Må¯¹åº”çš„çº¿ç¨‹æ ˆã€‚
&lt;/span>&lt;span class="cm"> 3. æ‰€æœ‰è°ƒåº¦ç›¸å…³ä»£ç ,ä¼šå…ˆåˆ‡æ¢åˆ°è¯¥Goroutineçš„æ ˆå†æ‰§è¡Œã€‚
&lt;/span>&lt;span class="cm"> */&lt;/span>
&lt;span class="nx">g0&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">g&lt;/span>
&lt;span class="nx">curg&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">g&lt;/span> &lt;span class="c1">// Må½“å‰ç»‘å®šçš„ç»“æ„ä½“G
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="c1">// SPã€PCå¯„å­˜å™¨ç”¨äºç°åœºä¿æŠ¤å’Œç°åœºæ¢å¤
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">vdsoSP&lt;/span> &lt;span class="kt">uintptr&lt;/span>
&lt;span class="nx">vdsoPC&lt;/span> &lt;span class="kt">uintptr&lt;/span>
&lt;span class="c1">// çœç•¥â€¦}
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>Pï¼šP(Processor)æ˜¯ä¸€ä¸ªæŠ½è±¡çš„æ¦‚å¿µï¼Œå¹¶ä¸æ˜¯çœŸæ­£çš„ç‰©ç†CPUã€‚æ‰€ä»¥å½“Pæœ‰ä»»åŠ¡æ—¶éœ€è¦åˆ›å»ºæˆ–è€…å”¤é†’ä¸€ä¸ªç³»ç»Ÿçº¿ç¨‹æ¥æ‰§è¡Œå®ƒé˜Ÿåˆ—é‡Œçš„ä»»åŠ¡ã€‚æ‰€ä»¥P/Méœ€è¦è¿›è¡Œç»‘å®šï¼Œæ„æˆä¸€ä¸ªæ‰§è¡Œå•å…ƒã€‚
På†³å®šäº†åŒæ—¶å¯ä»¥å¹¶å‘ä»»åŠ¡çš„æ•°é‡ï¼Œå¯é€šè¿‡GOMAXPROCSé™åˆ¶åŒæ—¶æ‰§è¡Œç”¨æˆ·çº§ä»»åŠ¡çš„æ“ä½œç³»ç»Ÿçº¿ç¨‹ã€‚å¯ä»¥é€šè¿‡runtime.GOMAXPROCSè¿›è¡ŒæŒ‡å®šã€‚åœ¨Go1.5ä¹‹åGOMAXPROCSè¢«é»˜è®¤è®¾ç½®å¯ç”¨çš„æ ¸æ•°ï¼Œè€Œä¹‹å‰åˆ™é»˜è®¤ä¸º1ã€‚&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// è‡ªå®šä¹‰è®¾ç½®GOMAXPROCSæ•°é‡
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">GOMAXPROCS&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">n&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="cm">/*
&lt;/span>&lt;span class="cm"> 1. GOMAXPROCSè®¾ç½®å¯æ‰§è¡Œçš„CPUçš„æœ€å¤§æ•°é‡,åŒæ—¶è¿”å›ä¹‹å‰çš„è®¾ç½®ã€‚
&lt;/span>&lt;span class="cm"> 2. å¦‚æœn &amp;lt; 1,åˆ™ä¸æ›´æ”¹å½“å‰çš„å€¼ã€‚
&lt;/span>&lt;span class="cm"> */&lt;/span>
&lt;span class="nx">ret&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">gomaxprocs&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nf">stopTheWorld&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;GOMAXPROCS&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// startTheWorldå¯åŠ¨æ—¶,ä½¿ç”¨newprocsã€‚
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">newprocs&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">int32&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">n&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nf">startTheWorld&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">ret&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// é»˜è®¤Pè¢«ç»‘å®šåˆ°æ‰€æœ‰CPUæ ¸ä¸Š
&lt;/span>&lt;span class="c1">// P == cpu.cores
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">getproccount&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">int32&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kd">const&lt;/span> &lt;span class="nx">maxCPUs&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">64&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">1024&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">buf&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="nx">maxCPUs&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">byte&lt;/span>
&lt;span class="c1">// è·å–CPU Core
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">r&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">sched_getaffinity&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">unsafe&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sizeof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">])&lt;/span>
&lt;span class="nx">n&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">int32&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">buf&lt;/span>&lt;span class="p">[:&lt;/span>&lt;span class="nx">r&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">v&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">n&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="nb">int32&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">v&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">v&lt;/span> &lt;span class="o">&amp;gt;&amp;gt;=&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">n&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">n&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">n&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// ä¸€ä¸ªè¿›ç¨‹é»˜è®¤è¢«ç»‘å®šåœ¨æ‰€æœ‰CPUæ ¸ä¸Š,è¿”å›æ‰€æœ‰CPU coreã€‚
&lt;/span>&lt;span class="c1">// è·å–è¿›ç¨‹çš„CPUäº²å’Œæ€§æ©ç ç³»ç»Ÿè°ƒç”¨
&lt;/span>&lt;span class="c1">// rax 204 ; ç³»ç»Ÿè°ƒç”¨ç 
&lt;/span>&lt;span class="c1">// system_call sys_sched_getaffinity; ç³»ç»Ÿè°ƒç”¨åç§°
&lt;/span>&lt;span class="c1">// rid pid ; è¿›ç¨‹å·
&lt;/span>&lt;span class="c1">// rsi unsigned int len
&lt;/span>&lt;span class="c1">// rdx unsigned long *user_mask_ptr
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">sys_linux_amd64&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">s&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">TEXT&lt;/span> &lt;span class="nx">runtime&lt;/span>&lt;span class="err">Â·&lt;/span>&lt;span class="nf">sched_getaffinity&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">SB&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="nx">NOSPLIT&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="err">$&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;span class="nx">MOVQ&lt;/span> &lt;span class="nx">pid&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">FP&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nx">DI&lt;/span>
&lt;span class="nx">MOVQ&lt;/span> &lt;span class="nx">len&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="mi">8&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">FP&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nx">SI&lt;/span>
&lt;span class="nx">MOVQ&lt;/span> &lt;span class="nx">buf&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="mi">16&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">FP&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nx">DX&lt;/span>
&lt;span class="nx">MOVL&lt;/span> &lt;span class="err">$&lt;/span>&lt;span class="nx">SYS_sched_getaffinity&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">AX&lt;/span>
&lt;span class="nx">SYSCALL&lt;/span>
&lt;span class="nx">MOVL&lt;/span> &lt;span class="nx">AX&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ret&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="mi">24&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">FP&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">RET&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="è°ƒåº¦è¿‡ç¨‹">è°ƒåº¦è¿‡ç¨‹&lt;/h4>
&lt;p>é¦–å…ˆåˆ›å»ºä¸€ä¸ªGå¯¹è±¡ï¼ŒGå¯¹è±¡ä¿å­˜åˆ°Pæœ¬åœ°é˜Ÿåˆ—æˆ–è€…æ˜¯å…¨å±€é˜Ÿåˆ—ã€‚Pæ­¤æ—¶å»å”¤é†’ä¸€ä¸ªMã€‚Pç»§ç»­æ‰§è¡Œå®ƒçš„æ‰§è¡Œåºã€‚Må¯»æ‰¾æ˜¯å¦æœ‰ç©ºé—²çš„Pï¼Œå¦‚æœæœ‰åˆ™å°†è¯¥Gå¯¹è±¡ç§»åŠ¨åˆ°å®ƒæœ¬èº«ã€‚æ¥ä¸‹æ¥Mæ‰§è¡Œä¸€ä¸ªè°ƒåº¦å¾ªç¯(è°ƒç”¨Gå¯¹è±¡-&amp;gt;æ‰§è¡Œ-&amp;gt;æ¸…ç†çº¿ç¨‹â†’ç»§ç»­æ‰¾æ–°çš„Goroutineæ‰§è¡Œ)ã€‚&lt;/p>
&lt;p>Mæ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œéšæ—¶ä¼šå‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚å½“å‘ç”Ÿä¸Šçº¿æ–‡åˆ‡æ¢æ—¶ï¼Œéœ€è¦å¯¹æ‰§è¡Œç°åœºè¿›è¡Œä¿æŠ¤ï¼Œä»¥ä¾¿ä¸‹æ¬¡è¢«è°ƒåº¦æ‰§è¡Œæ—¶è¿›è¡Œç°åœºæ¢å¤ã€‚Goè°ƒåº¦å™¨Mçš„æ ˆä¿å­˜åœ¨Gå¯¹è±¡ä¸Šï¼Œåªéœ€è¦å°†Mæ‰€éœ€è¦çš„å¯„å­˜å™¨(SPã€PCç­‰)ä¿å­˜åˆ°Gå¯¹è±¡ä¸Šå°±å¯ä»¥å®ç°ç°åœºä¿æŠ¤ã€‚å½“è¿™äº›å¯„å­˜å™¨æ•°æ®è¢«ä¿æŠ¤èµ·æ¥ï¼Œå°±éšæ—¶å¯ä»¥åšä¸Šä¸‹æ–‡åˆ‡æ¢äº†ï¼Œåœ¨ä¸­æ–­ä¹‹å‰æŠŠç°åœºä¿å­˜èµ·æ¥ã€‚å¦‚æœæ­¤æ—¶Gä»»åŠ¡è¿˜æ²¡æœ‰æ‰§è¡Œå®Œï¼ŒMå¯ä»¥å°†ä»»åŠ¡é‡æ–°ä¸¢åˆ°Pçš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡è¢«è°ƒåº¦æ‰§è¡Œã€‚å½“å†æ¬¡è¢«è°ƒåº¦æ‰§è¡Œæ—¶ï¼ŒMé€šè¿‡è®¿é—®Gçš„vdsoSPã€vdsoPCå¯„å­˜å™¨è¿›è¡Œç°åœºæ¢å¤(ä»ä¸Šæ¬¡ä¸­æ–­ä½ç½®ç»§ç»­æ‰§è¡Œ)ã€‚&lt;/p>
&lt;h5 id="å¤šä¸ªçº¿ç¨‹ä¸‹å¦‚ä½•è°ƒåº¦">å¤šä¸ªçº¿ç¨‹ä¸‹å¦‚ä½•è°ƒåº¦&lt;/h5>
&lt;p>æŠ›å‡ºä¸€ä¸ªé—®é¢˜ï¼šæ¯ä¸ªPé‡Œé¢çš„Gæ‰§è¡Œæ—¶é—´æ˜¯ä¸å¯æ§çš„ï¼Œå¦‚æœå¤šä¸ªPåŒæ—¶åœ¨æ‰§è¡Œï¼Œä¼šä¸ä¼šå‡ºç°æœ‰çš„Pé‡Œé¢çš„Gæ‰§è¡Œä¸å®Œï¼Œæœ‰çš„Pé‡Œé¢å‡ ä¹æ²¡æœ‰Gå¯æ‰§è¡Œå‘¢ï¼Ÿ&lt;/p>
&lt;p>è¿™å°±è¦ä»Mçš„è‡ªå¾ªç¯è¿‡ç¨‹ä¸­å¦‚ä½•è·å–Gã€å½’è¿˜Gçš„è¡Œä¸ºè¯´èµ·äº†&lt;/p>
&lt;p>æœ‰ä¸¤ç§é€”å¾„ï¼š1.å€ŸåŠ©å…¨å±€é˜Ÿåˆ— sched.runq ä½œä¸ºä¸­ä»‹ï¼Œæœ¬åœ°Pé‡Œçš„Gå¤ªå¤šçš„è¯å°±æ”¾å…¨å±€é‡Œï¼ŒGå¤ªå°‘çš„è¯å°±ä»å…¨å±€å–ã€‚
2.å…¨å±€åˆ—è¡¨é‡Œæ²¡æœ‰çš„è¯ç›´æ¥ä»P1é‡Œå·å–(steal)ã€‚(æ›´å¤šMåœ¨æ‰§è¡Œçš„è¯ï¼ŒåŒæ ·çš„åŸç†ï¼Œè¿™é‡Œå°±åªæ‹¿2ä¸ªæ¥ä¸¾ä¾‹)&lt;/p>
&lt;h5 id="è°ƒåº¦å¾ªç¯ä¸­å¦‚ä½•è®©å‡ºcpu">è°ƒåº¦å¾ªç¯ä¸­å¦‚ä½•è®©å‡ºCPU&lt;/h5>
&lt;ul>
&lt;li>æ­£å¸¸å®Œæˆè®©å‡ºCPU&lt;/li>
&lt;li>ä¸»åŠ¨è®©å‡ºCPU
&lt;ul>
&lt;li>time.Sleep(),IOé˜»å¡ç­‰&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>æŠ¢å è®©å‡ºCPU&lt;/li>
&lt;/ul>
&lt;h4 id="æŠ¢å å¼è°ƒåº¦">æŠ¢å å¼è°ƒåº¦&lt;/h4>
&lt;p>æ¦‚å¿µï¼šæšä¸¾æ‰€æœ‰çš„P å¦‚æœPåœ¨ç³»ç»Ÿè°ƒç”¨ä¸­(_Psyscall), ä¸”ç»è¿‡äº†ä¸€æ¬¡sysmonå¾ªç¯(20us~10ms), åˆ™æŠ¢å è¿™ä¸ªPï¼Œ è°ƒç”¨handoffpè§£é™¤Må’ŒPä¹‹é—´çš„å…³è”ï¼Œ å¦‚æœPåœ¨è¿è¡Œä¸­(_Prunning), ä¸”ç»è¿‡äº†ä¸€æ¬¡sysmonå¾ªç¯å¹¶ä¸”Gè¿è¡Œæ—¶é—´è¶…è¿‡forcePreemptNS(10ms), åˆ™æŠ¢å è¿™ä¸ªP&lt;/p>
&lt;p>å¹¶è®¾ç½®g.preempt = trueï¼Œg.stackguard0 = stackPreemptã€‚&lt;/p>
&lt;p>ä¸ºä»€ä¹ˆè®¾ç½®äº†stackguardå°±å¯ä»¥å®ç°æŠ¢å ?&lt;/p>
&lt;p>å› ä¸ºè¿™ä¸ªå€¼ç”¨äºæ£€æŸ¥å½“å‰æ ˆç©ºé—´æ˜¯å¦è¶³å¤Ÿ, goå‡½æ•°çš„å¼€å¤´ä¼šæ¯”å¯¹è¿™ä¸ªå€¼åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å¼ æ ˆã€‚&lt;/p>
&lt;p>newstackå‡½æ•°åˆ¤æ–­g.stackguard0ç­‰äºstackPreempt, å°±çŸ¥é“è¿™æ˜¯æŠ¢å è§¦å‘çš„, è¿™æ—¶ä¼šå†æ£€æŸ¥ä¸€éæ˜¯å¦è¦æŠ¢å ã€‚&lt;/p>
&lt;p>æŠ¢å æœºåˆ¶ä¿è¯äº†ä¸ä¼šæœ‰ä¸€ä¸ªGé•¿æ—¶é—´çš„è¿è¡Œå¯¼è‡´å…¶ä»–Gæ— æ³•è¿è¡Œçš„æƒ…å†µå‘ç”Ÿã€‚&lt;/p>
&lt;h4 id="ä¸»åŠ¨è®©å‡ºcpu">ä¸»åŠ¨è®©å‡ºCPU&lt;/h4>
&lt;h5 id="timesleep">time.Sleep()&lt;/h5>
&lt;p>timeSleep å‡½æ•°é‡Œé€šè¿‡ addtimerLocked æŠŠå®šæ—¶å™¨åŠ å…¥åˆ° timer ç®¡ç†å™¨ï¼ˆtimer é€šè¿‡æœ€å°å †çš„æ•°æ®ç»“æ„å­˜æ”¾æ¯ä¸ªå®šæ—¶å™¨ï¼Œåœ¨è¿™ä¸åšè¯¦ç»†è¯´æ˜ï¼‰åï¼Œå†é€šè¿‡ goparkunlock å®ç°æŠŠå½“å‰Gä¼‘çœ ï¼Œè¿™é‡Œçœ‹åˆ°äº†ä¸Šé¢æåˆ°çš„ gopark æ–¹æ³•è¿›è¡Œè°ƒåº¦å¾ªç¯çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚&lt;/p>
&lt;p>åœ¨ addtimerLocked æ–¹æ³•çš„æœ€ä¸‹é¢æœ‰ä¸ªé€»è¾‘åœ¨è¿è¡ŒæœŸé—´å¼€å¯äº†'å…¨å±€æ—¶é—´äº‹ä»¶é©±åŠ¨å™¨'timerproc,è¯¥æ–¹æ³•ä¼šå…¨ç¨‹éå†æœ€å°å †ï¼Œå¯»æ‰¾æœ€æ—©è¿›å…¥ timer ç®¡ç†å™¨çš„å®šæ—¶å™¨ï¼Œç„¶åå”¤é†’ã€‚ä»–æ˜¯æ€ä¹ˆæ‰¾åˆ°è¦å”¤é†’å“ªä¸ªGçš„ï¼Ÿå›å¤´çœ‹ä¸‹ timeSleep æ–¹æ³•é‡ŒæŠŠå½“æ—¶æ­£åœ¨æ‰§è¡Œçš„Gä»¥åŠå”¤é†’æ–¹æ³• goroutineReady å¸¦åˆ°äº†æ¯ä¸ªå®šæ—¶å™¨é‡Œï¼Œè€Œåœ¨ timerproc åˆ™é€šè¿‡æ‰¾åˆ°æœŸçš„å®šæ—¶å™¨æ‰§è¡Œf(arg, seq)&lt;/p>
&lt;p>å³é€šè¿‡ goroutineReady æ–¹æ³•å”¤é†’ã€‚æ–¹æ³•è°ƒç”¨è¿‡ç¨‹: goroutineReady() -&amp;gt; ready()&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// runtime/time.go
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">timeSleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ns&lt;/span> &lt;span class="kt">int64&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">ns&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">t&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">getg&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nx">timer&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">t&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">t&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">timer&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nf">getg&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nx">timer&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">t&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="o">*&lt;/span>&lt;span class="nx">t&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">timer&lt;/span>&lt;span class="p">{}&lt;/span> &lt;span class="c1">// æ¯ä¸ªå®šæ—¶ä»»åŠ¡éƒ½åˆ›å»ºä¸€ä¸ªtimer
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">t&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">when&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">nanotime&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="nx">ns&lt;/span>
&lt;span class="nx">t&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">f&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">goroutineReady&lt;/span> &lt;span class="c1">// è®°å½•å”¤é†’è¯¥Gçš„æ–¹æ³•,å”¤é†’æ—¶é€šè¿‡è¯¥æ–¹æ³•æ‰§è¡Œå”¤é†’
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">t&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">arg&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">getg&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="c1">// æŠŠtimerä¸å½“å‰Gå…³è”,æ—¶é—´åˆ°äº†å”¤é†’æ—¶é€šè¿‡è¯¥å‚æ•°æ‰¾åˆ°æ‰€åœ¨çš„G
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">lock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">timers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">lock&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nf">addtimerLocked&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// æŠŠtimeræ·»åŠ åˆ°æœ€å°å †é‡Œ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">goparkunlock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">timers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">lock&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;sleep&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">traceEvGoSleep&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// åˆ‡åˆ°G0è®©å‡ºCPU,è¿›å…¥ä¼‘çœ 
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ€»ç»“ï¼štime.Sleep æƒ³è¦è¿›å…¥é˜»å¡(ä¼‘çœ )çŠ¶æ€ï¼Œå…¶å®æ˜¯é€šè¿‡ gopark æ–¹æ³•ç»™è‡ªå·±æ ‡è®°ä¸ª_Gwaiting çŠ¶æ€ï¼Œç„¶åæŠŠè‡ªå·±æ‰€å ç”¨çš„CPUçº¿ç¨‹èµ„æºç»™é‡Šæ”¾å‡ºæ¥ï¼Œç»§ç»­æ‰§è¡Œè°ƒåº¦ä»»åŠ¡ï¼Œè°ƒåº¦å…¶å®ƒçš„Gæ¥è¿è¡Œã€‚è€Œå”¤é†’æ˜¯é€šè¿‡æŠŠGæ›´æ”¹å›_Grunnable çŠ¶æ€åï¼Œç„¶åæŠŠGæ”¾å…¥åˆ°Pçš„å¾…è¿è¡Œé˜Ÿåˆ—é‡Œç­‰å¾…æ‰§è¡Œã€‚é€šè¿‡è¿™ç‚¹è¿˜å¯ä»¥çœ‹å‡ºä¼‘çœ ä¸­çš„Gå…¶å®å¹¶ä¸å ç”¨ CPU èµ„æºï¼Œæœ€å¤šæ˜¯å ç”¨å†…å­˜ï¼Œæ˜¯ä¸ªå¾ˆè½»é‡çº§çš„é˜»å¡ã€‚&lt;/p>
&lt;h5 id="mutex">Mutex&lt;/h5>
&lt;p>Mutex.Lock æ–¹æ³•é€šè¿‡è°ƒç”¨ runtime_SemacquireMutex æœ€ç»ˆè¿˜æ˜¯è°ƒç”¨ goparkunlock å®ç°æŠŠGè¿›å…¥åˆ°ä¼‘çœ çŠ¶æ€ã€‚åœ¨è¿›å…¥ä¼‘çœ ä¹‹å‰å…ˆæŠŠè‡ªå·±åŠ å…¥åˆ°é˜Ÿåˆ—é‡Œ root.queue(addr, s, lifo)ï¼Œåœ¨ queue æ–¹æ³•é‡Œï¼Œè®°å½•äº†å½“å‰çš„Gï¼Œä»¥ä¾¿ä»¥åæ‰¾åˆ°å¹¶å”¤é†’ã€‚&lt;/p>
&lt;p>Mutex. Unlock æ–¹æ³•é€šè¿‡è°ƒç”¨ runtime_Semrelease æœ€ç»ˆè¿˜æ˜¯è°ƒç”¨ goready å®ç°æŠŠGå”¤é†’ã€‚&lt;/p>
&lt;h5 id="channel">Channel&lt;/h5>
&lt;p>&lt;strong>å‘é€ç«¯ï¼š&lt;/strong>&lt;/p>
&lt;p>å½“ç»™ä¸€ä¸ª chan å‘é€æ¶ˆæ¯çš„æ—¶å€™ï¼Œå®è´¨è§¦å‘çš„æ–¹æ³•æ˜¯ chansendã€‚åœ¨è¯¥æ–¹æ³•é‡Œä¸æ˜¯å…ˆè¿›å…¥ä¼‘çœ çŠ¶æ€ã€‚&lt;/p>
&lt;p>1ï¼‰å¦‚æœæ­¤æ—¶æœ‰æ¥æ”¶è€…æ¥æ”¶è¿™ä¸ª chan çš„æ¶ˆæ¯åˆ™ç›´æ¥æŠŠæ•°æ®é€šè¿‡ send æ–¹æ³•æ‰”ç»™æ¥æ”¶è€…ï¼Œå¹¶å”¤é†’æ¥æ”¶è€…çš„Gï¼Œç„¶åå½“å‰Gåˆ™ç»§ç»­æ‰§è¡Œã€‚&lt;/p>
&lt;p>2ï¼‰å¦‚æœæ²¡æœ‰æ¥æ”¶è€…ï¼Œå°±æŠŠæ•°æ® copy åˆ° chan çš„ä¸´æ—¶å†…å­˜é‡Œï¼Œä¸”å†…å­˜æ²¡æœ‰æ»¡å°±ç»§ç»­æ‰§è¡Œå½“å‰Gã€‚&lt;/p>
&lt;p>3ï¼‰å¦‚æœæ²¡æœ‰æ¥æ”¶è€…ä¸” chan æ»¡äº†ï¼Œä¾ç„¶æ˜¯é€šè¿‡ goparkunlock æ–¹æ³•è¿›å…¥ä¼‘çœ ã€‚åœ¨ä¼‘çœ å‰æŠŠå½“å‰çš„Gç›¸å…³ä¿¡æ¯å­˜åˆ°é˜Ÿåˆ—ï¼ˆsendqï¼‰ä»¥ä¾¿æœ‰æ¥æ”¶è€…æ¥æ”¶æ•°æ®çš„æ—¶å€™å”¤é†’å½“å‰Gã€‚&lt;/p>
&lt;p>&lt;strong>æ¥æ”¶ç«¯ï¼š&lt;/strong>&lt;/p>
&lt;p>chanrecv æ–¹æ³•æ˜¯åœ¨ chan æ¥æ”¶è€…çš„åœ°æ–¹è°ƒç”¨çš„æ–¹æ³•ã€‚&lt;/p>
&lt;p>1ï¼‰å¦‚æœæœ‰å‘é€è€…è¢«ä¼‘çœ ï¼Œåˆ™å–å‡ºæ•°æ®ç„¶åå”¤é†’å‘é€è€…ï¼Œå½“å‰æ¥æ”¶è€…çš„Gæ‹¿åˆ°æ•°æ®ç»§ç»­æ‰§è¡Œã€‚&lt;/p>
&lt;p>2ï¼‰å¦‚æœæ²¡æœ‰ç­‰å¾…çš„å‘é€è€…å°±çœ‹ä¸‹æœ‰æ²¡æœ‰å‘é€çš„æ•°æ®è¿˜æ²¡è¢«æ¥æ”¶ï¼Œæœ‰çš„è¯å°±ç›´æ¥å–å‡ºæ•°æ®ç„¶åè¿”å›ï¼Œå½“å‰æ¥æ”¶è€…çš„Gæ‹¿åˆ°æ•°æ®ç»§ç»­æ‰§è¡Œã€‚ï¼ˆæ³¨æ„ï¼šè¿™é‡Œå–çš„æ•°æ®ä¸æ˜¯æ­£åœ¨ç­‰å¾…çš„ sender çš„æ•°æ®ï¼Œè€Œæ˜¯ä» chan çš„å¼€å¤´çš„å†…å­˜å–ï¼Œå¦‚æœæ˜¯ sender çš„æ•°æ®åˆ™è¯»å‡ºæ¥çš„æ•°æ®é¡ºåºå°±ä¹±äº†ï¼‰&lt;/p>
&lt;p>3ï¼‰å¦‚æœå³æ²¡æœ‰å‘é€è€…ï¼Œchan é‡Œä¹Ÿæ²¡æ•°æ®å°±é€šè¿‡ goparkunlock è¿›è¡Œä¼‘çœ ï¼Œåœ¨ä¼‘çœ ä¹‹å‰æŠŠå½“å‰çš„Gç›¸å…³ä¿¡æ¯å­˜åˆ° recvq é‡Œé¢ï¼Œä»¥ä¾¿æœ‰æ•°æ®æ—¶æ‰¾åˆ°è¦å”¤é†’çš„Gã€‚&lt;/p>
&lt;h4 id="qa">QA&lt;/h4>
&lt;p>1.ä¸ºä»€ä¹ˆpçš„local queue å¯æ— é”è®¿é—® ä»»åŠ¡çªƒå–çš„æ—¶å€™éœ€è¦åŠ é”å˜›ï¼Ÿ
ç­”ï¼šåŸå­æ“ä½œã€‚&lt;/p>
&lt;h3 id="åƒåœ¾å›æ”¶">åƒåœ¾å›æ”¶&lt;/h3>
&lt;ul>
&lt;li>&lt;a href="https://segmentfault.com/a/1190000020086769">ä¸‰è‰²æ ‡è®°&lt;/a>&lt;/li>
&lt;li>å“ªäº›æƒ…å†µä¸‹ä¸è¢«åƒåœ¾å›æ”¶ï¼Ÿ&lt;/li>
&lt;li>å¼ºä¸‰è‰²å’Œå¼±ä¸‰è‰²&lt;/li>
&lt;li>å†™å±éšœ&lt;/li>
&lt;/ul>
&lt;h3 id="channel-1">channel&lt;/h3>
&lt;h3 id="slice">slice&lt;/h3>
&lt;h3 id="map">map&lt;/h3>
&lt;ul>
&lt;li>æ€ä¹ˆè§£å†³è¯»å†™å¹¶å‘ï¼ˆé™¤äº†é”ï¼‰&lt;/li>
&lt;li>sync.Map äº†è§£ä¸€ä¸‹&lt;/li>
&lt;/ul>
&lt;h3 id="httpåº“">httpåº“&lt;/h3>
&lt;h3 id="interface">interface&lt;/h3>
&lt;ul>
&lt;li>iface
&lt;ul>
&lt;li>æœ‰æ–¹æ³•çš„interface{}&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>eface
&lt;ul>
&lt;li>æ²¡æœ‰æ–¹æ³•çš„interface{}&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="å…¶ä»–">å…¶ä»–&lt;/h3>
&lt;h4 id="å˜é‡é€ƒé€¸">å˜é‡é€ƒé€¸&lt;/h4>
&lt;h2 id="é¡¹ç›®ç»éªŒ">é¡¹ç›®ç»éªŒ&lt;/h2>
&lt;h3 id="å¾®æœåŠ¡">å¾®æœåŠ¡&lt;/h3>
&lt;h3 id="æœåŠ¡é™æµé™é€Ÿç†”æ–­">æœåŠ¡é™æµé™é€Ÿç†”æ–­&lt;/h3>
&lt;p>&lt;a href="https://mp.weixin.qq.com/s/n9wpL6uSjza2nEprLbJDKw">æœåŠ¡ç†”æ–­&lt;/a>&lt;/p>
&lt;h3 id="æç°ä¸ªäººèƒ½åŠ›çš„ç‚¹">æç°ä¸ªäººèƒ½åŠ›çš„ç‚¹&lt;/h3>
&lt;ul>
&lt;li>å¼•å…¥ etcdï¼ŒåŸºäº etcd å¼€å‘æœåŠ¡é—´é€šä¿¡çš„åŸºç¡€åº“ è§£å†³æœåŠ¡é—´é€šä¿¡å’ŒæœåŠ¡é€‰ä¸¾é—®é¢˜&lt;/li>
&lt;li>å¼•å…¥nsq ä¿®æ”¹æºç  æ”¯æŒå»¶è¿Ÿæ¶ˆæ¯æŒä¹…åŒ–ï¼ŒäºŒæ¬¡å¼€å‘ SDK æ”¯æŒè¿æ¥æ± &lt;/li>
&lt;li>å¼€å‘é¡¹ç›®åŸºç¡€æ¶æ„ï¼Œä¸€é”®ç”Ÿæˆæ–°é¡¹ç›®&lt;/li>
&lt;li>å¼€å‘åŸºç¡€ lib åŒ…ï¼Œwechat åŒ… ï¼Œcommon åŒ…ï¼Œ eventbus-lib ï¼Œhtlog-go æé«˜å¼€å‘æ•ˆç‡&lt;/li>
&lt;li>è§„èŒƒåŒ–é¡¹ç›®å¼€å‘+ä¸Šçº¿æµç¨‹ï¼Œè§„èŒƒåŒ–æ¶æ„&lt;/li>
&lt;li>å¼€å‘ç»Ÿä¸€çš„å†…éƒ¨æ¶ˆæ¯æœåŠ¡ï¼Œè§„èŒƒå†…æœé£ä¹¦/ä¼ä¸šå¾®ä¿¡æ¶ˆæ¯çš„å‘é€&lt;/li>
&lt;li>åå°æœåŠ¡å•ç‚¹ç™»å½•åŠŸèƒ½&lt;/li>
&lt;li>æœåŠ¡æ‹†è§£ å‘å¾®æœåŠ¡æ–¹å‘æ”¹è¿›&lt;/li>
&lt;li>æ•æ„Ÿè¯ å»ºç«‹è¯åº“ç»“æ„ï¼ˆB-treeï¼‰é»‘ç™½åå•çš„ç¼“å­˜&lt;/li>
&lt;li>è‡ªæˆ‘ä»‹ç»ï¼š
&lt;ul>
&lt;li>éƒ¨é—¨å†…çš„å®šä½ï¼šåç«¯å¼€å‘+åŸºç¡€æœåŠ¡æ­å»º&lt;/li>
&lt;li>å…³æ³¨æ–°æŠ€æœ¯ è¡¨ç°å‡ºæŒç»­å­¦ä¹ &lt;/li>
&lt;li>å²—ä½åŒ¹é…åº¦&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="ç³»ç»Ÿè®¾è®¡">ç³»ç»Ÿè®¾è®¡&lt;/h3>
&lt;p>&lt;a href="https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md">ç³»ç»Ÿè®¾è®¡&lt;/a>&lt;/p>
&lt;h2 id="ç®—æ³•">ç®—æ³•&lt;/h2>
&lt;p>&lt;a href="https://github.com/yusank/leetcode">githubé¡¹ç›®&lt;/a>&lt;/p>
&lt;h3 id="å †">å †&lt;/h3>
&lt;ul>
&lt;li>æœ€å°å †/æœ€å¤§å †&lt;/li>
&lt;li>topK ç®—æ³•çš„å®ç°ï¼š hash åŠ  å°é¡¶å †&lt;/li>
&lt;li>å †æ’åº&lt;/li>
&lt;/ul>
&lt;h3 id="é“¾è¡¨">é“¾è¡¨&lt;/h3>
&lt;ul>
&lt;li>å•å‘é“¾è¡¨/åŒå‘é“¾è¡¨&lt;/li>
&lt;li>é“¾è¡¨æ‰¾ç¯ï¼ˆå¿«æ…¢æŒ‡é’ˆï¼‰&lt;/li>
&lt;li>é“¾è¡¨å±€éƒ¨/å…¨éƒ¨æ—‹è½¬ï¼ˆå³ä¿®æ”¹æ–¹å‘ï¼‰&lt;/li>
&lt;/ul>
&lt;p>é—®é¢˜ï¼šæŸ¥æ‰¾å€’æ•°ç¬¬ K ä¸ªèŠ‚ç‚¹&lt;/p>
&lt;h3 id="äºŒå‰æ ‘">äºŒå‰æ ‘&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>äºŒå‰æ ‘çš„äº”ç§éå†&lt;/p>
&lt;ul>
&lt;li>å‰åº æ ¹-å·¦-å³&lt;/li>
&lt;li>ä¸­åº å·¦-æ ¹-å³&lt;/li>
&lt;li>ååº å·¦-å³-æ ¹&lt;/li>
&lt;li>å±‚æ¬¡éå† ä¸€å±‚ä¸€å±‚ä»å·¦åˆ°å³&lt;/li>
&lt;li>é”¯é½¿éå†ï¼ˆså‹éå†ï¼‰æ¯ä¸€å±‚æ¢æ–¹å‘&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>äºŒå‰æ ‘æŸ¥æ‰¾&lt;/p>
&lt;ul>
&lt;li>æŸ¥æ‰¾æœ€è¿‘è·¯åŠ²&lt;/li>
&lt;li>æŸ¥æ‰¾å…±åŒç¥–å…ˆï¼ˆæœ€è¿‘ç¥–å…ˆï¼‰&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>äºŒå‰æ ‘çš„è½¬æ¢&lt;/p>
&lt;ul>
&lt;li>å·¦å³è½¬æ¢&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>å…¶ä»–&lt;/p>
&lt;ul>
&lt;li>æ‰“å°å³è§†å›¾å·¦è§†å›¾ï¼ˆå³æ‰“å°æ¯ä¸€å±‚çš„æœ€å³è¾¹æˆ–æœ€å·¦è¾¹ï¼‰&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="å›æº¯æ³•é€’å½’æ³•">å›æº¯æ³•é€’å½’æ³•&lt;/h3>
&lt;p>ç†è§£å›æº¯é€’å½’çš„æ¯ä¸€å±‚å †æ ˆæƒ…å†µï¼Œå­¦ä¼šä»€ä¹ˆæƒ…å†µä¸‹ä½¿ç”¨å›æº¯/é€’å½’&lt;/p>
&lt;h3 id="åŠ¨æ€è§„åˆ’dp">åŠ¨æ€è§„åˆ’ï¼ˆDPï¼‰&lt;/h3>
&lt;p>æ‰¾è·¯çº¿æ•°é‡ï¼Œçˆ¬å°é˜¶ï¼ŒèƒŒåŒ…é—®é¢˜
æ•°ç»„ç­‰å’Œåˆ†ç»„é—®é¢˜&lt;/p>
&lt;h2 id="è®¡ç®—æœºåŸºç¡€">è®¡ç®—æœºåŸºç¡€&lt;/h2>
&lt;h3 id="åŸºç¡€æ¦‚å¿µ">åŸºç¡€æ¦‚å¿µ&lt;/h3>
&lt;p>é—®é¢˜ï¼šæŸ¥çœ‹å½“å‰æœåŠ¡å™¨çš„æ€§èƒ½&amp;amp;æŸ¥çœ‹ go å¼€çš„çº¿ç¨‹æ•°ï¼Ÿ&lt;/p>
&lt;p>é—®é¢˜ï¼šè¿›ç¨‹çº¿ç¨‹åç¨‹çš„åŒºåˆ«ï¼Ÿ&lt;/p>
&lt;p>é—®é¢˜ï¼šselect poll epoll çš„åŒºåˆ«ï¼Ÿ&lt;/p>
&lt;ul>
&lt;li>select æœ‰å¤§å°é™åˆ¶ æ•ˆç‡ä½ å¯¹ socket æ˜¯çº¿æ€§æ‰«æ åŒæ­¥å¤šè·¯å¤ç”¨ O(n)&lt;/li>
&lt;li>poll ä¸ select ç±»ä¼¼ ä½†æ˜¯ç”¨çš„é“¾è¡¨ç»“æ„ æ‰€ä»¥æ²¡æœ‰å¤§å°é™åˆ¶ åŒæ­¥å¤šè·¯å¤ç”¨ O(n)&lt;/li>
&lt;li>epollå¯ä»¥ç†è§£ä¸ºevent pollï¼Œä¸åŒäºå¿™è½®è¯¢å’Œæ— å·®åˆ«è½®è¯¢ï¼Œepollä¼šæŠŠå“ªä¸ªæµå‘ç”Ÿäº†æ€æ ·çš„I/Oäº‹ä»¶é€šçŸ¥æˆ‘ä»¬ã€‚æ‰€ä»¥æˆ‘ä»¬è¯´epollå®é™…ä¸Šæ˜¯äº‹ä»¶é©±åŠ¨ï¼ˆæ¯ä¸ªäº‹ä»¶å…³è”ä¸Šfdï¼‰çš„ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯¹è¿™äº›æµçš„æ“ä½œéƒ½æ˜¯æœ‰æ„ä¹‰çš„ã€‚ï¼ˆå¤æ‚åº¦é™ä½åˆ°äº†O(1)ï¼‰&lt;/li>
&lt;/ul>
&lt;p>&lt;a href="https://www.cnblogs.com/aspirant/p/9166944.html">ç›¸å…³é“¾æ¥&lt;/a>&lt;/p>
&lt;h3 id="tcpudp">tcp/udp&lt;/h3>
&lt;p>&lt;a href="https://mp.weixin.qq.com/s/THQ9zAJ4yso1knGtwKcw_Q">tcpå¿…å¤‡&lt;/a>&lt;/p>
&lt;p>é—®é¢˜ï¼štcp time await å‘ç”Ÿåœ¨å“ªç«¯ï¼Ÿ&lt;/p>
&lt;p>A: å‘ç”Ÿåœ¨å››æ¬¡æŒ¥æ‰‹æ—¶å®¢æˆ·ç«¯ï¼Œæœ€åä¼šç­‰2MSLã€‚&lt;/p>
&lt;p>é—®é¢˜ï¼šä¸ºä»€ä¹ˆå®¢æˆ·ç«¯æœ€åè¿˜è¦ç­‰å¾…2MSLï¼Ÿ&lt;/p>
&lt;p>ç­”ï¼šMSLï¼ˆMaximum Segment Lifetimeï¼‰ï¼ŒTCPå…è®¸ä¸åŒçš„å®ç°å¯ä»¥è®¾ç½®ä¸åŒçš„MSLå€¼ã€‚ç¬¬ä¸€ï¼Œä¿è¯å®¢æˆ·ç«¯å‘é€çš„æœ€åä¸€ä¸ªACKæŠ¥æ–‡èƒ½å¤Ÿåˆ°è¾¾æœåŠ¡å™¨ï¼Œå› ä¸ºè¿™ä¸ªACKæŠ¥æ–‡å¯èƒ½ä¸¢å¤±ã€‚ç«™åœ¨æœåŠ¡å™¨çš„è§’åº¦çœ‹æ¥ï¼Œæˆ‘å·²ç»å‘é€äº†FIN+ACKæŠ¥æ–‡è¯·æ±‚æ–­å¼€äº†ï¼Œå®¢æˆ·ç«¯è¿˜æ²¡æœ‰ç»™æˆ‘å›åº”ï¼Œåº”è¯¥æ˜¯æˆ‘å‘é€çš„è¯·æ±‚æ–­å¼€æŠ¥æ–‡å®ƒæ²¡æœ‰æ”¶åˆ°ï¼Œäºæ˜¯æœåŠ¡å™¨åˆä¼šé‡æ–°å‘é€ä¸€æ¬¡ï¼Œè€Œå®¢æˆ·ç«¯å°±èƒ½åœ¨è¿™ä¸ª2MSLæ—¶é—´æ®µå†…æ”¶åˆ°è¿™ä¸ªé‡ä¼ çš„æŠ¥æ–‡ï¼Œæ¥ç€ç»™å‡ºå›åº”æŠ¥æ–‡ï¼Œå¹¶ä¸”ä¼šé‡å¯2MSLè®¡æ—¶å™¨ã€‚å¦‚æœå®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡ç«¯çš„FIN+ACKæŠ¥æ–‡åï¼Œå‘é€ä¸€ä¸ªACKç»™æœåŠ¡ç«¯ä¹‹åå°±â€œè‡ªç§â€åœ°ç«‹é©¬è¿›å…¥CLOSEDçŠ¶æ€ï¼Œå¯èƒ½ä¼šå¯¼è‡´æœåŠ¡ç«¯æ— æ³•ç¡®è®¤æ”¶åˆ°æœ€åçš„ACKæŒ‡ä»¤ï¼Œä¹Ÿå°±æ— æ³•è¿›å…¥CLOSEDçŠ¶æ€ï¼Œè¿™æ˜¯å®¢æˆ·ç«¯ä¸è´Ÿè´£ä»»çš„è¡¨ç°ã€‚ç¬¬äºŒï¼Œé˜²æ­¢å¤±æ•ˆè¯·æ±‚ã€‚é˜²æ­¢ç±»ä¼¼ä¸â€œä¸‰æ¬¡æ¡æ‰‹â€ä¸­æåˆ°äº†çš„â€œå·²ç»å¤±æ•ˆçš„è¿æ¥è¯·æ±‚æŠ¥æ–‡æ®µâ€å‡ºç°åœ¨æœ¬è¿æ¥ä¸­ã€‚å®¢æˆ·ç«¯å‘é€å®Œæœ€åä¸€ä¸ªç¡®è®¤æŠ¥æ–‡åï¼Œåœ¨è¿™ä¸ª2MSLæ—¶é—´ä¸­ï¼Œå°±å¯ä»¥ä½¿æœ¬è¿æ¥æŒç»­çš„æ—¶é—´å†…æ‰€äº§ç”Ÿçš„æ‰€æœ‰æŠ¥æ–‡æ®µéƒ½ä»ç½‘ç»œä¸­æ¶ˆå¤±ã€‚è¿™æ ·æ–°çš„è¿æ¥ä¸­ä¸ä¼šå‡ºç°æ—§è¿æ¥çš„è¯·æ±‚æŠ¥æ–‡ã€‚&lt;/p>
&lt;p>åœ¨TIME_WAITçŠ¶æ€æ— æ³•çœŸæ­£é‡Šæ”¾å¥æŸ„èµ„æºï¼Œåœ¨æ­¤æœŸé—´ï¼ŒSocketä¸­ä½¿ç”¨çš„æœ¬åœ°ç«¯å£åœ¨é»˜è®¤æƒ…å†µä¸‹ä¸èƒ½å†è¢«ä½¿ç”¨ã€‚è¯¥é™åˆ¶å¯¹äºå®¢æˆ·ç«¯æœºå™¨æ¥è¯´æ˜¯æ— æ‰€è°“çš„ï¼Œä½†å¯¹äºé«˜å¹¶å‘æœåŠ¡å™¨æ¥è¯´ï¼Œä¼šæå¤§åœ°é™åˆ¶æœ‰æ•ˆè¿æ¥çš„åˆ›å»ºæ•°é‡ï¼Œç§°ä¸ºæ€§èƒ½ç“¶é¢ˆã€‚æ‰€ä»¥å»ºè®®å°†é«˜å¹¶å‘æœåŠ¡å™¨TIME_WAITè¶…æ—¶æ—¶é—´è°ƒå°ã€‚RFC793ä¸­è§„å®šMSLä¸º2åˆ†é’Ÿã€‚ä½†æ˜¯åœ¨å½“å‰çš„é«˜é€Ÿç½‘ç»œä¸­ï¼Œ2åˆ†é’Ÿçš„ç­‰å¾…æ—¶é—´ä¼šé€ æˆèµ„æºçš„æå¤§æµªè´¹ï¼Œåœ¨é«˜å¹¶å‘æœåŠ¡å™¨ä¸Šé€šå¸¸ä¼šä½¿ç”¨æ›´å°çš„å€¼ã€‚&lt;/p>
&lt;h3 id="http">http&lt;/h3>
&lt;p>&lt;a href="https://zhuanlan.zhihu.com/p/159274359?hmsr=toutiao.io&amp;amp;utm_medium=toutiao.io&amp;amp;utm_source=toutiao.io">è°ˆè°ˆHTTP&lt;/a>&lt;/p>
&lt;p>https ç›¸å…³&lt;/p>
&lt;h3 id="grpc">grpc&lt;/h3>
&lt;h2 id="å…¶ä»–qa">å…¶ä»–QA&lt;/h2>
&lt;ul>
&lt;li>Q: è§£é‡Šgraceful å¹³æ»‘é‡å¯ï¼Ÿ&lt;/li>
&lt;li>Qï¼š&lt;/li>
&lt;/ul></content><category scheme="https://yusank.github.io/categories/%E7%BB%8F%E9%AA%8C/" term="ç»éªŒ" label="ç»éªŒ"/><category scheme="https://yusank.github.io/categories/%E9%9D%A2%E8%AF%95/" term="é¢è¯•" label="é¢è¯•"/><category scheme="https://yusank.github.io/tags/%E9%9D%A2%E8%AF%95/" term="é¢è¯•" label="é¢è¯•"/></entry><entry><title type="text">Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)</title><link rel="alternate" type="text/html" href="https://yusank.github.io/posts/go-standard/"/><id>https://yusank.github.io/posts/go-standard/</id><updated>2021-09-18T06:24:55+00:00</updated><published>2020-11-25T16:24:41+08:00</published><author><name>yusank</name><uri>https://yusank.github.io/</uri><email>yusankurban@gmail.com</email></author><summary type="html">è¯­è¨€ç¯‡ï¼Œæå‡ºå¸¸è§çš„å¼€å‘ä¸Šçš„ä¸å¥½çš„ã€ä¸è§„èŒƒçš„å†™æ³•ï¼Œå¹¶ç»™å‡ºæ›´å¥½çš„å†™æ³•ã€‚ Uber æ˜¯ä¸€å®¶ç¾å›½ç¡…â€¦â€¦</summary><content type="html">&lt;p>è¯­è¨€ç¯‡ï¼Œæå‡ºå¸¸è§çš„å¼€å‘ä¸Šçš„ä¸å¥½çš„ã€ä¸è§„èŒƒçš„å†™æ³•ï¼Œå¹¶ç»™å‡ºæ›´å¥½çš„å†™æ³•ã€‚
&lt;a href="https://www.uber.com/">Uber&lt;/a> æ˜¯ä¸€å®¶ç¾å›½ç¡…è°·çš„ç§‘æŠ€å…¬å¸ï¼Œä¹Ÿæ˜¯ Go è¯­è¨€çš„æ—©æœŸ adopterã€‚å…¶å¼€æºäº†å¾ˆå¤š golang é¡¹ç›®ï¼Œè¯¸å¦‚è¢« Gopher åœˆç†ŸçŸ¥çš„ &lt;a href="https://github.com/uber-go/zap">zap&lt;/a>ã€&lt;a href="https://github.com/jaegertracing/jaeger">jaeger&lt;/a> ç­‰ã€‚2018 å¹´å¹´æœ« Uber å°†å†…éƒ¨çš„ &lt;a href="https://github.com/uber-go/guide">Go é£æ ¼è§„èŒƒ&lt;/a> å¼€æºåˆ° GitHubï¼Œç»è¿‡ä¸€å¹´çš„ç§¯ç´¯å’Œæ›´æ–°ï¼Œè¯¥è§„èŒƒå·²ç»åˆå…·è§„æ¨¡ï¼Œå¹¶å—åˆ°å¹¿å¤§ Gopher çš„å…³æ³¨ã€‚æœ¬æ–‡æ˜¯è¯¥è§„èŒƒçš„ä¸­æ–‡ç‰ˆæœ¬ï¼Œå¹¶åŠ ä»¥ä½œè€…ä¸ªäººçš„ä¸€äº›çœ‹æ³•ï¼Œé &lt;code>uber&lt;/code> å®˜æ–¹çš„å»ºè®®å’Œçœ‹æ³• æœ¬äººä¼šåŠ ä»¥æ ‡æ³¨ã€‚&lt;/p>
&lt;h2 id="ä»‹ç»">ä»‹ç»&lt;/h2>
&lt;p>æ ·å¼ (style) æ˜¯æ”¯é…æˆ‘ä»¬ä»£ç çš„æƒ¯ä¾‹ã€‚æœ¯è¯­&lt;code>æ ·å¼&lt;/code>æœ‰ç‚¹ç”¨è¯ä¸å½“ï¼Œå› ä¸ºè¿™äº›çº¦å®šæ¶µç›–çš„èŒƒå›´ä¸é™äºç”± gofmt æ›¿æˆ‘ä»¬å¤„ç†çš„æºæ–‡ä»¶æ ¼å¼ã€‚&lt;/p>
&lt;p>æœ¬æŒ‡å—çš„ç›®çš„æ˜¯é€šè¿‡è¯¦ç»†æè¿°åœ¨ Uber ç¼–å†™ Go ä»£ç çš„æ³¨æ„äº‹é¡¹æ¥ç®¡ç†è¿™ç§å¤æ‚æ€§ã€‚è¿™äº›è§„åˆ™çš„å­˜åœ¨æ˜¯ä¸ºäº†ä½¿ä»£ç åº“æ˜“äºç®¡ç†ï¼ŒåŒæ—¶ä»ç„¶å…è®¸å·¥ç¨‹å¸ˆæ›´æœ‰æ•ˆåœ°ä½¿ç”¨ Go è¯­è¨€åŠŸèƒ½ã€‚&lt;/p>
&lt;p>è¯¥æŒ‡å—æœ€åˆç”± &lt;a href="https://github.com/prashantv">Prashant Varanasi&lt;/a> å’Œ &lt;a href="https://github.com/nomis52">Simon Newton&lt;/a> ç¼–å†™ï¼Œç›®çš„æ˜¯ä½¿ä¸€äº›åŒäº‹èƒ½å¿«é€Ÿä½¿ç”¨ Goã€‚å¤šå¹´æ¥ï¼Œè¯¥æŒ‡å—å·²æ ¹æ®å…¶ä»–äººçš„åé¦ˆè¿›è¡Œäº†ä¿®æ”¹ã€‚&lt;/p>
&lt;p>æœ¬æ–‡æ¡£è®°å½•äº†æˆ‘ä»¬åœ¨ Uber éµå¾ªçš„ Go ä»£ç ä¸­çš„æƒ¯ç”¨çº¦å®šã€‚å…¶ä¸­è®¸å¤šæ˜¯ Go çš„é€šç”¨å‡†åˆ™ï¼Œè€Œå…¶ä»–æ‰©å±•å‡†åˆ™ä¾èµ–äºä¸‹é¢å¤–éƒ¨çš„æŒ‡å—ï¼š&lt;/p>
&lt;ol>
&lt;li>&lt;a href="https://golang.org/doc/effective_go.html">Effective Go&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/golang/go/wiki/CodeReviewComments">The Go common mistakes guide&lt;/a>&lt;/li>
&lt;/ol>
&lt;p>æ‰€æœ‰ä»£ç éƒ½åº”è¯¥é€šè¿‡&lt;code>golint&lt;/code>å’Œ&lt;code>go vet&lt;/code>çš„æ£€æŸ¥å¹¶æ— é”™è¯¯ã€‚æˆ‘ä»¬å»ºè®®æ‚¨å°†ç¼–è¾‘å™¨è®¾ç½®ä¸ºï¼š&lt;/p>
&lt;ul>
&lt;li>ä¿å­˜æ—¶è¿è¡Œ &lt;code>goimports&lt;/code>&lt;/li>
&lt;li>è¿è¡Œ &lt;code>golint&lt;/code> å’Œ &lt;code>go vet&lt;/code> æ£€æŸ¥é”™è¯¯&lt;/li>
&lt;/ul>
&lt;p>æ‚¨å¯ä»¥åœ¨ä»¥ä¸‹ Go ç¼–è¾‘å™¨å·¥å…·æ”¯æŒé¡µé¢ä¸­æ‰¾åˆ°æ›´ä¸ºè¯¦ç»†çš„ä¿¡æ¯ï¼š
&lt;a href="https://github.com/golang/go/wiki/IDEsAndTextEditorPlugins">https://github.com/golang/go/wiki/IDEsAndTextEditorPlugins&lt;/a>&lt;/p>
&lt;h2 id="æŒ‡å¯¼åŸåˆ™">æŒ‡å¯¼åŸåˆ™&lt;/h2>
&lt;h3 id="æŒ‡å‘-interface-çš„æŒ‡é’ˆ">æŒ‡å‘ interface çš„æŒ‡é’ˆ&lt;/h3>
&lt;p>æ‚¨å‡ ä¹ä¸éœ€è¦æŒ‡å‘æ¥å£ç±»å‹çš„æŒ‡é’ˆã€‚æ‚¨åº”è¯¥å°†æ¥å£ä½œä¸ºå€¼è¿›è¡Œä¼ é€’ï¼Œåœ¨è¿™æ ·çš„ä¼ é€’è¿‡ç¨‹ä¸­ï¼Œå®è´¨ä¸Šä¼ é€’çš„åº•å±‚æ•°æ®ä»ç„¶å¯ä»¥æ˜¯æŒ‡é’ˆã€‚&lt;/p>
&lt;p>æ¥å£å®è´¨ä¸Šåœ¨åº•å±‚ç”¨ä¸¤ä¸ªå­—æ®µè¡¨ç¤ºï¼š&lt;/p>
&lt;ol>
&lt;li>ä¸€ä¸ªæŒ‡å‘æŸäº›ç‰¹å®šç±»å‹ä¿¡æ¯çš„æŒ‡é’ˆã€‚æ‚¨å¯ä»¥å°†å…¶è§†ä¸º&amp;quot;type&amp;quot;ã€‚&lt;/li>
&lt;li>æ•°æ®æŒ‡é’ˆã€‚å¦‚æœå­˜å‚¨çš„æ•°æ®æ˜¯æŒ‡é’ˆï¼Œåˆ™ç›´æ¥å­˜å‚¨ã€‚å¦‚æœå­˜å‚¨çš„æ•°æ®æ˜¯ä¸€ä¸ªå€¼ï¼Œåˆ™å­˜å‚¨æŒ‡å‘è¯¥å€¼çš„æŒ‡é’ˆã€‚&lt;/li>
&lt;/ol>
&lt;p>å¦‚æœå¸Œæœ›æ¥å£æ–¹æ³•ä¿®æ”¹åŸºç¡€æ•°æ®ï¼Œåˆ™å¿…é¡»ä½¿ç”¨æŒ‡é’ˆä¼ é€’(å°†å¯¹è±¡æŒ‡é’ˆèµ‹å€¼ç»™æ¥å£å˜é‡)ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">F&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">f&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">S1&lt;/span> &lt;span class="kd">struct&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="nx">S1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">f&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">S2&lt;/span> &lt;span class="kd">struct&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">S2&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">f&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;span class="c1">// f1.f()æ— æ³•ä¿®æ”¹åº•å±‚æ•°æ®
&lt;/span>&lt;span class="c1">// f2.f() å¯ä»¥ä¿®æ”¹åº•å±‚æ•°æ®,ç»™æ¥å£å˜é‡f2èµ‹å€¼æ—¶ä½¿ç”¨çš„æ˜¯å¯¹è±¡æŒ‡é’ˆ
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">var&lt;/span> &lt;span class="nx">f1&lt;/span> &lt;span class="nx">F&lt;/span>&lt;span class="o">:=&lt;/span> &lt;span class="nx">S1&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">f2&lt;/span> &lt;span class="nx">F&lt;/span>&lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">S2&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="interface-åˆç†æ€§éªŒè¯">Interface åˆç†æ€§éªŒè¯&lt;/h3>
&lt;p>åœ¨ç¼–è¯‘æ—¶éªŒè¯æ¥å£çš„ç¬¦åˆæ€§ã€‚è¿™åŒ…æ‹¬ï¼š&lt;/p>
&lt;ul>
&lt;li>å°†å®ç°ç‰¹å®šæ¥å£çš„å¯¼å‡ºç±»å‹ä½œä¸ºæ¥å£API çš„ä¸€éƒ¨åˆ†è¿›è¡Œæ£€æŸ¥&lt;/li>
&lt;li>å®ç°åŒä¸€æ¥å£çš„(å¯¼å‡ºå’Œéå¯¼å‡º)ç±»å‹å±äºå®ç°ç±»å‹çš„é›†åˆ&lt;/li>
&lt;li>ä»»ä½•è¿åæ¥å£åˆç†æ€§æ£€æŸ¥çš„åœºæ™¯,éƒ½ä¼šç»ˆæ­¢ç¼–è¯‘,å¹¶é€šçŸ¥ç»™ç”¨æˆ·&lt;/li>
&lt;/ul>
&lt;p>è¡¥å……:ä¸Šé¢3æ¡æ˜¯ç¼–è¯‘å™¨å¯¹æ¥å£çš„æ£€æŸ¥æœºåˆ¶,
å¤§ä½“æ„æ€æ˜¯é”™è¯¯ä½¿ç”¨æ¥å£ä¼šåœ¨ç¼–è¯‘æœŸæŠ¥é”™.
æ‰€ä»¥å¯ä»¥åˆ©ç”¨è¿™ä¸ªæœºåˆ¶è®©éƒ¨åˆ†é—®é¢˜åœ¨ç¼–è¯‘æœŸæš´éœ².&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Bad&lt;/th>
&lt;th>Good&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// å¦‚æœHandleræ²¡æœ‰å®ç°http.Handler,ä¼šåœ¨è¿è¡Œæ—¶æŠ¥é”™
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">Handler&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// ...
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">h&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Handler&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">ServeHTTP&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nx">w&lt;/span> &lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ResponseWriter&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">r&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Handler&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// ...
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="c1">// ç”¨äºè§¦å‘ç¼–è¯‘æœŸçš„æ¥å£çš„åˆç†æ€§æ£€æŸ¥æœºåˆ¶
&lt;/span>&lt;span class="c1">// å¦‚æœHandleræ²¡æœ‰å®ç°http.Handler,ä¼šåœ¨ç¼–è¯‘æœŸæŠ¥é”™
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">var&lt;/span> &lt;span class="nx">_&lt;/span> &lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Handler&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">Handler&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="kc">nil&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">h&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Handler&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">ServeHTTP&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nx">w&lt;/span> &lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ResponseWriter&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">r&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// ...
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;p>å¦‚æœ &lt;code>*Handler&lt;/code> ä¸ &lt;code>http.Handler&lt;/code> çš„æ¥å£ä¸åŒ¹é…,
é‚£ä¹ˆè¯­å¥ &lt;code>var _ http.Handler = (*Handler)(nil)&lt;/code> å°†æ— æ³•ç¼–è¯‘é€šè¿‡.&lt;/p>
&lt;p>èµ‹å€¼çš„å³è¾¹åº”è¯¥æ˜¯æ–­è¨€ç±»å‹çš„é›¶å€¼ã€‚
å¯¹äºæŒ‡é’ˆç±»å‹ï¼ˆå¦‚ &lt;code>*Handler&lt;/code>ï¼‰ã€åˆ‡ç‰‡å’Œæ˜ å°„ï¼Œè¿™æ˜¯ &lt;code>nil&lt;/code>ï¼›
å¯¹äºç»“æ„ç±»å‹ï¼Œè¿™æ˜¯ç©ºç»“æ„ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">LogHandler&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">h&lt;/span> &lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Handler&lt;/span>
&lt;span class="nx">log&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">zap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Logger&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">_&lt;/span> &lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Handler&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">LogHandler&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">h&lt;/span> &lt;span class="nx">LogHandler&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">ServeHTTP&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nx">w&lt;/span> &lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ResponseWriter&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">r&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// ...
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="æ¥æ”¶å™¨-receiver-ä¸æ¥å£">æ¥æ”¶å™¨ (receiver) ä¸æ¥å£&lt;/h3>
&lt;p>ä½¿ç”¨å€¼æ¥æ”¶å™¨çš„æ–¹æ³•æ—¢å¯ä»¥é€šè¿‡å€¼è°ƒç”¨ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æŒ‡é’ˆè°ƒç”¨ã€‚&lt;/p>
&lt;p>å¸¦æŒ‡é’ˆæ¥æ”¶å™¨çš„æ–¹æ³•åªèƒ½é€šè¿‡æŒ‡é’ˆæˆ– &lt;a href="https://golang.org/ref/spec#Method_values">addressable values&lt;/a>è°ƒç”¨.&lt;/p>
&lt;p>ä¾‹å¦‚ï¼Œ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">S&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">data&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="nx">S&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Read&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">data&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">S&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">str&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">data&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">str&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">sVals&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="nx">S&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s">&amp;#34;A&amp;#34;&lt;/span>&lt;span class="p">}}&lt;/span>
&lt;span class="c1">// ä½ åªèƒ½é€šè¿‡å€¼è°ƒç”¨ Read
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">sVals&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="nf">Read&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="c1">// è¿™ä¸èƒ½ç¼–è¯‘é€šè¿‡ï¼š
&lt;/span>&lt;span class="c1">// sVals[1].Write(&amp;#34;test&amp;#34;)
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="nx">sPtrs&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">S&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="s">&amp;#34;A&amp;#34;&lt;/span>&lt;span class="p">}}&lt;/span>
&lt;span class="c1">// é€šè¿‡æŒ‡é’ˆæ—¢å¯ä»¥è°ƒç”¨ Readï¼Œä¹Ÿå¯ä»¥è°ƒç”¨ Write æ–¹æ³•
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">sPtrs&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="nf">Read&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">sPtrs&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="nf">Write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;test&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç±»ä¼¼çš„,å³ä½¿æ–¹æ³•æœ‰äº†å€¼æ¥æ”¶å™¨,ä¹ŸåŒæ ·å¯ä»¥ç”¨æŒ‡é’ˆæ¥æ”¶å™¨æ¥æ»¡è¶³æ¥å£.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">F&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">f&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">S1&lt;/span> &lt;span class="kd">struct&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="nx">S1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">f&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">S2&lt;/span> &lt;span class="kd">struct&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">S2&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">f&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;span class="nx">s1Val&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">S1&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="nx">s1Ptr&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">S1&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="nx">s2Val&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">S2&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="nx">s2Ptr&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">S2&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="nx">F&lt;/span>
&lt;span class="nx">i&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">s1Val&lt;/span>
&lt;span class="nx">i&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">s1Ptr&lt;/span>
&lt;span class="nx">i&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">s2Ptr&lt;/span>
&lt;span class="c1">// ä¸‹é¢ä»£ç æ— æ³•é€šè¿‡ç¼–è¯‘ã€‚å› ä¸º s2Val æ˜¯ä¸€ä¸ªå€¼ï¼Œè€Œ S2 çš„ f æ–¹æ³•ä¸­æ²¡æœ‰ä½¿ç”¨å€¼æ¥æ”¶å™¨
&lt;/span>&lt;span class="c1">// i = s2Val
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;a href="https://golang.org/doc/effective_go.html">Effective Go&lt;/a> ä¸­æœ‰ä¸€æ®µå…³äº &lt;a href="https://golang.org/doc/effective_go.html#pointers_vs_values">pointers vs. values&lt;/a> çš„ç²¾å½©è®²è§£ã€‚&lt;/p>
&lt;p>è¡¥å……:&lt;/p>
&lt;ul>
&lt;li>ä¸€ä¸ªç±»å‹å¯ä»¥æœ‰å€¼æ¥æ”¶å™¨æ–¹æ³•é›†å’ŒæŒ‡é’ˆæ¥æ”¶å™¨æ–¹æ³•é›†
&lt;ul>
&lt;li>å€¼æ¥æ”¶å™¨æ–¹æ³•é›†æ˜¯æŒ‡é’ˆæ¥æ”¶å™¨æ–¹æ³•é›†çš„å­é›†,åä¹‹ä¸æ˜¯&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>è§„åˆ™
&lt;ul>
&lt;li>å€¼å¯¹è±¡åªå¯ä»¥ä½¿ç”¨å€¼æ¥æ”¶å™¨æ–¹æ³•é›†&lt;/li>
&lt;li>æŒ‡é’ˆå¯¹è±¡å¯ä»¥ä½¿ç”¨ å€¼æ¥æ”¶å™¨æ–¹æ³•é›† + æŒ‡é’ˆæ¥æ”¶å™¨æ–¹æ³•é›†&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>æ¥å£çš„åŒ¹é…(æˆ–è€…å«å®ç°)
&lt;ul>
&lt;li>ç±»å‹å®ç°äº†æ¥å£çš„æ‰€æœ‰æ–¹æ³•,å«åŒ¹é…&lt;/li>
&lt;li>å…·ä½“çš„è®²,è¦ä¹ˆæ˜¯ç±»å‹çš„å€¼æ–¹æ³•é›†åŒ¹é…æ¥å£,è¦ä¹ˆæ˜¯æŒ‡é’ˆæ–¹æ³•é›†åŒ¹é…æ¥å£&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>å…·ä½“çš„åŒ¹é…åˆ†ä¸¤ç§:&lt;/p>
&lt;ul>
&lt;li>å€¼æ–¹æ³•é›†å’Œæ¥å£åŒ¹é…
&lt;ul>
&lt;li>ç»™æ¥å£å˜é‡èµ‹å€¼çš„ä¸ç®¡æ˜¯å€¼è¿˜æ˜¯æŒ‡é’ˆå¯¹è±¡,éƒ½ok,å› ä¸ºéƒ½åŒ…å«å€¼æ–¹æ³•é›†&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>æŒ‡é’ˆæ–¹æ³•é›†å’Œæ¥å£åŒ¹é…
&lt;ul>
&lt;li>åªèƒ½å°†æŒ‡é’ˆå¯¹è±¡èµ‹å€¼ç»™æ¥å£å˜é‡,å› ä¸ºåªæœ‰æŒ‡é’ˆæ–¹æ³•é›†å’Œæ¥å£åŒ¹é…&lt;/li>
&lt;li>å¦‚æœå°†å€¼å¯¹è±¡èµ‹å€¼ç»™æ¥å£å˜é‡,ä¼šåœ¨ç¼–è¯‘æœŸæŠ¥é”™(ä¼šè§¦å‘æ¥å£åˆç†æ€§æ£€æŸ¥æœºåˆ¶)&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>ä¸ºå•¥ i = s2Val ä¼šæŠ¥é”™,å› ä¸ºå€¼æ–¹æ³•é›†å’Œæ¥å£ä¸åŒ¹é….&lt;/p>
&lt;h3 id="é›¶å€¼-mutex-æ˜¯æœ‰æ•ˆçš„">é›¶å€¼ Mutex æ˜¯æœ‰æ•ˆçš„&lt;/h3>
&lt;p>é›¶å€¼ &lt;code>sync.Mutex&lt;/code> å’Œ &lt;code>sync.RWMutex&lt;/code> æ˜¯æœ‰æ•ˆçš„ã€‚æ‰€ä»¥æŒ‡å‘ mutex çš„æŒ‡é’ˆåŸºæœ¬æ˜¯ä¸å¿…è¦çš„ã€‚&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">mu&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">sync&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Mutex&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">mu&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Lock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">var&lt;/span> &lt;span class="nx">mu&lt;/span> &lt;span class="nx">sync&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Mutex&lt;/span>
&lt;span class="nx">mu&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Lock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;p>å¦‚æœä½ ä½¿ç”¨ç»“æ„ä½“æŒ‡é’ˆï¼Œmutex å¯ä»¥éæŒ‡é’ˆå½¢å¼ä½œä¸ºç»“æ„ä½“çš„ç»„æˆå­—æ®µï¼Œæˆ–è€…æ›´å¥½çš„æ–¹å¼æ˜¯ç›´æ¥åµŒå…¥åˆ°ç»“æ„ä½“ä¸­ã€‚
å¦‚æœæ˜¯ç§æœ‰ç»“æ„ä½“ç±»å‹æˆ–æ˜¯è¦å®ç° Mutex æ¥å£çš„ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨åµŒå…¥ mutex çš„æ–¹æ³•ï¼š&lt;/p>
&lt;table>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">smap&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">sync&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Mutex&lt;/span> &lt;span class="c1">// only for unexported typesï¼ˆä»…é€‚ç”¨äºéå¯¼å‡ºç±»å‹ï¼‰
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="nx">data&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">string&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">newSMap&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">smap&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">smap&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">data&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">smap&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">k&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Lock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unlock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">data&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">k&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">SMap&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">mu&lt;/span> &lt;span class="nx">sync&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Mutex&lt;/span> &lt;span class="c1">// å¯¹äºå¯¼å‡ºç±»å‹ï¼Œè¯·ä½¿ç”¨ç§æœ‰é”
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="nx">data&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">string&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">NewSMap&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">SMap&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">SMap&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">data&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">SMap&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">k&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">mu&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Lock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">mu&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unlock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">data&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">k&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tr>
&lt;tr>
&lt;td>ä¸ºç§æœ‰ç±»å‹æˆ–éœ€è¦å®ç°äº’æ–¥æ¥å£çš„ç±»å‹åµŒå…¥ã€‚&lt;/td>
&lt;td>å¯¹äºå¯¼å‡ºçš„ç±»å‹ï¼Œè¯·ä½¿ç”¨ä¸“ç”¨å­—æ®µã€‚&lt;/td>
&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;h3 id="åœ¨è¾¹ç•Œå¤„æ‹·è´-slices-å’Œ-maps">åœ¨è¾¹ç•Œå¤„æ‹·è´ Slices å’Œ Maps&lt;/h3>
&lt;p>slices å’Œ maps åŒ…å«äº†æŒ‡å‘åº•å±‚æ•°æ®çš„æŒ‡é’ˆï¼Œå› æ­¤åœ¨éœ€è¦å¤åˆ¶å®ƒä»¬æ—¶è¦ç‰¹åˆ«æ³¨æ„ã€‚&lt;/p>
&lt;h4 id="æ¥æ”¶-slices-å’Œ-maps">æ¥æ”¶ Slices å’Œ Maps&lt;/h4>
&lt;p>è¯·è®°ä½ï¼Œå½“ map æˆ– slice ä½œä¸ºå‡½æ•°å‚æ•°ä¼ å…¥æ—¶ï¼Œå¦‚æœæ‚¨å­˜å‚¨äº†å¯¹å®ƒä»¬çš„å¼•ç”¨ï¼Œåˆ™ç”¨æˆ·å¯ä»¥å¯¹å…¶è¿›è¡Œä¿®æ”¹ã€‚&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th> &lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">d&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Driver&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">SetTrips&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">trips&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">Trip&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">d&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">trips&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">trips&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">trips&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">...&lt;/span>
&lt;span class="nx">d1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetTrips&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">trips&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// ä½ æ˜¯è¦ä¿®æ”¹ d1.trips å—ï¼Ÿ
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">trips&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="o">...&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>
&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">d&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Driver&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">SetTrips&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">trips&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">Trip&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">d&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">trips&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="nx">Trip&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">trips&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="nb">copy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">d&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">trips&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">trips&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">trips&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">...&lt;/span>
&lt;span class="nx">d1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetTrips&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">trips&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// è¿™é‡Œæˆ‘ä»¬ä¿®æ”¹ trips[0]ï¼Œä½†ä¸ä¼šå½±å“åˆ° d1.trips
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">trips&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="o">...&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h4 id="è¿”å›-slices-æˆ–-maps">è¿”å› slices æˆ– maps&lt;/h4>
&lt;p>åŒæ ·ï¼Œè¯·æ³¨æ„ç”¨æˆ·å¯¹æš´éœ²å†…éƒ¨çŠ¶æ€çš„ map æˆ– slice çš„ä¿®æ”¹ã€‚&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Stats&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">mu&lt;/span> &lt;span class="nx">sync&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Mutex&lt;/span>
&lt;span class="nx">counters&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">int&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// Snapshot è¿”å›å½“å‰çŠ¶æ€ã€‚
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Stats&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Snapshot&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">mu&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Lock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">mu&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unlock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">counters&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// snapshot ä¸å†å—äº’æ–¥é”ä¿æŠ¤
&lt;/span>&lt;span class="c1">// å› æ­¤å¯¹ snapshot çš„ä»»ä½•è®¿é—®éƒ½å°†å—åˆ°æ•°æ®ç«äº‰çš„å½±å“
&lt;/span>&lt;span class="c1">// å½±å“ stats.counters
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">snapshot&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">stats&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Snapshot&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Stats&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">mu&lt;/span> &lt;span class="nx">sync&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Mutex&lt;/span>
&lt;span class="nx">counters&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">int&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Stats&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Snapshot&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">mu&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Lock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">mu&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unlock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">result&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">counters&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">k&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">counters&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">result&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">k&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">v&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">result&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// snapshot ç°åœ¨æ˜¯ä¸€ä¸ªæ‹·è´
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">snapshot&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">stats&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Snapshot&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;h3 id="ä½¿ç”¨-defer-é‡Šæ”¾èµ„æº">ä½¿ç”¨ defer é‡Šæ”¾èµ„æº&lt;/h3>
&lt;p>ä½¿ç”¨ defer é‡Šæ”¾èµ„æºï¼Œè¯¸å¦‚æ–‡ä»¶å’Œé”ã€‚&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">p&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Lock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">p&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">count&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="mi">10&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">p&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unlock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">p&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">count&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">p&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">count&lt;/span>&lt;span class="o">++&lt;/span>
&lt;span class="nx">newCount&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">p&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">count&lt;/span>
&lt;span class="nx">p&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unlock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">newCount&lt;/span>
&lt;span class="c1">// å½“æœ‰å¤šä¸ª return åˆ†æ”¯æ—¶ï¼Œå¾ˆå®¹æ˜“é—å¿˜ unlock
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">p&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Lock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">p&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unlock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">p&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">count&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="mi">10&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">p&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">count&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">p&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">count&lt;/span>&lt;span class="o">++&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">p&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">count&lt;/span>
&lt;span class="c1">// æ›´å¯è¯»
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;p>Defer çš„å¼€é”€éå¸¸å°ï¼Œåªæœ‰åœ¨æ‚¨å¯ä»¥è¯æ˜å‡½æ•°æ‰§è¡Œæ—¶é—´å¤„äºçº³ç§’çº§çš„ç¨‹åº¦æ—¶ï¼Œæ‰åº”é¿å…è¿™æ ·åšã€‚ä½¿ç”¨ defer æå‡å¯è¯»æ€§æ˜¯å€¼å¾—çš„ï¼Œå› ä¸ºä½¿ç”¨å®ƒä»¬çš„æˆæœ¬å¾®ä¸è¶³é“ã€‚å°¤å…¶é€‚ç”¨äºé‚£äº›ä¸ä»…ä»…æ˜¯ç®€å•å†…å­˜è®¿é—®çš„è¾ƒå¤§çš„æ–¹æ³•ï¼Œåœ¨è¿™äº›æ–¹æ³•ä¸­å…¶ä»–è®¡ç®—çš„èµ„æºæ¶ˆè€—è¿œè¶…è¿‡ &lt;code>defer&lt;/code>ã€‚&lt;/p>
&lt;h3 id="channel-çš„-size-è¦ä¹ˆæ˜¯-1è¦ä¹ˆæ˜¯æ— ç¼“å†²çš„">Channel çš„ size è¦ä¹ˆæ˜¯ 1ï¼Œè¦ä¹ˆæ˜¯æ— ç¼“å†²çš„&lt;/h3>
&lt;p>channel é€šå¸¸ size åº”ä¸º 1 æˆ–æ˜¯æ— ç¼“å†²çš„ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œchannel æ˜¯æ— ç¼“å†²çš„ï¼Œå…¶ size ä¸ºé›¶ã€‚ä»»ä½•å…¶ä»–å°ºå¯¸éƒ½å¿…é¡»ç»è¿‡ä¸¥æ ¼çš„å®¡æŸ¥ã€‚æˆ‘ä»¬éœ€è¦è€ƒè™‘å¦‚ä½•ç¡®å®šå¤§å°ï¼Œè€ƒè™‘æ˜¯ä»€ä¹ˆé˜»æ­¢äº† channel åœ¨é«˜è´Ÿè½½ä¸‹å’Œé˜»å¡å†™æ—¶çš„å†™å…¥ï¼Œä»¥åŠå½“è¿™ç§æƒ…å†µå‘ç”Ÿæ—¶ç³»ç»Ÿé€»è¾‘æœ‰å“ªäº›å˜åŒ–ã€‚(ç¿»è¯‘è§£é‡Šï¼šæŒ‰ç…§åŸæ–‡æ„æ€æ˜¯éœ€è¦ç•Œå®šé€šé“è¾¹ç•Œï¼Œç«æ€æ¡ä»¶ï¼Œä»¥åŠé€»è¾‘ä¸Šä¸‹æ–‡æ¢³ç†)&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// åº”è¯¥è¶³ä»¥æ»¡è¶³ä»»ä½•æƒ…å†µï¼
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">64&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// å¤§å°ï¼š1
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// æˆ–è€…
&lt;/span>&lt;span class="c1">// æ— ç¼“å†² channelï¼Œå¤§å°ä¸º 0
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;h3 id="æšä¸¾ä»-1-å¼€å§‹">æšä¸¾ä» 1 å¼€å§‹&lt;/h3>
&lt;p>åœ¨ Go ä¸­å¼•å…¥æšä¸¾çš„æ ‡å‡†æ–¹æ³•æ˜¯å£°æ˜ä¸€ä¸ªè‡ªå®šä¹‰ç±»å‹å’Œä¸€ä¸ªä½¿ç”¨äº† iota çš„ const ç»„ã€‚ç”±äºå˜é‡çš„é»˜è®¤å€¼ä¸º 0ï¼Œå› æ­¤é€šå¸¸åº”ä»¥éé›¶å€¼å¼€å¤´æšä¸¾ã€‚&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Operation&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;span class="kd">const&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="nx">Add&lt;/span> &lt;span class="nx">Operation&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">iota&lt;/span>
&lt;span class="nx">Subtract&lt;/span>
&lt;span class="nx">Multiply&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="c1">// Add=0, Subtract=1, Multiply=2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Operation&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;span class="kd">const&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="nx">Add&lt;/span> &lt;span class="nx">Operation&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">iota&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;span class="nx">Subtract&lt;/span>
&lt;span class="nx">Multiply&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="c1">// Add=1, Subtract=2, Multiply=3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½¿ç”¨é›¶å€¼æ˜¯æœ‰æ„ä¹‰çš„ï¼ˆæšä¸¾ä»é›¶å¼€å§‹ï¼‰ï¼Œä¾‹å¦‚ï¼Œå½“é›¶å€¼æ˜¯ç†æƒ³çš„é»˜è®¤è¡Œä¸ºæ—¶ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">LogOutput&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;span class="kd">const&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="nx">LogToStdout&lt;/span> &lt;span class="nx">LogOutput&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">iota&lt;/span>
&lt;span class="nx">LogToFile&lt;/span>
&lt;span class="nx">LogToRemote&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="c1">// LogToStdout=0, LogToFile=1, LogToRemote=2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="ä½¿ç”¨-time-å¤„ç†æ—¶é—´">ä½¿ç”¨ time å¤„ç†æ—¶é—´&lt;/h3>
&lt;p>æ—¶é—´å¤„ç†å¾ˆå¤æ‚ã€‚å…³äºæ—¶é—´çš„é”™è¯¯å‡è®¾é€šå¸¸åŒ…æ‹¬ä»¥ä¸‹å‡ ç‚¹ã€‚&lt;/p>
&lt;ol>
&lt;li>ä¸€å¤©æœ‰ 24 å°æ—¶&lt;/li>
&lt;li>ä¸€å°æ—¶æœ‰ 60 åˆ†é’Ÿ&lt;/li>
&lt;li>ä¸€å‘¨æœ‰ä¸ƒå¤©&lt;/li>
&lt;li>ä¸€å¹´ 365 å¤©&lt;/li>
&lt;li>&lt;a href="https://infiniteundo.com/post/25326999628/falsehoods-programmers-believe-about-time">è¿˜æœ‰æ›´å¤š&lt;/a>&lt;/li>
&lt;/ol>
&lt;p>ä¾‹å¦‚ï¼Œ&lt;em>1&lt;/em> è¡¨ç¤ºåœ¨ä¸€ä¸ªæ—¶é—´ç‚¹ä¸ŠåŠ ä¸Š 24 å°æ—¶å¹¶ä¸æ€»æ˜¯äº§ç”Ÿä¸€ä¸ªæ–°çš„æ—¥å†æ—¥ã€‚&lt;/p>
&lt;p>å› æ­¤ï¼Œåœ¨å¤„ç†æ—¶é—´æ—¶å§‹ç»ˆä½¿ç”¨ &lt;a href="https://golang.org/pkg/time/">&lt;code>&amp;quot;time&amp;quot;&lt;/code>&lt;/a> åŒ…ï¼Œå› ä¸ºå®ƒæœ‰åŠ©äºä»¥æ›´å®‰å…¨ã€æ›´å‡†ç¡®çš„æ–¹å¼å¤„ç†è¿™äº›ä¸æ­£ç¡®çš„å‡è®¾ã€‚&lt;/p>
&lt;h4 id="ä½¿ç”¨-timetime-è¡¨è¾¾ç¬æ—¶æ—¶é—´">ä½¿ç”¨ &lt;code>time.Time&lt;/code> è¡¨è¾¾ç¬æ—¶æ—¶é—´&lt;/h4>
&lt;p>åœ¨å¤„ç†æ—¶é—´çš„ç¬é—´æ—¶ä½¿ç”¨ &lt;a href="https://golang.org/pkg/time/#Time">&lt;code>time.time&lt;/code>&lt;/a>ï¼Œåœ¨æ¯”è¾ƒã€æ·»åŠ æˆ–å‡å»æ—¶é—´æ—¶ä½¿ç”¨ &lt;code>time.Time&lt;/code> ä¸­çš„æ–¹æ³•ã€‚&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">isActive&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">now&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">start&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">stop&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">bool&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">start&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="nx">now&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nx">now&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nx">stop&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">isActive&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">now&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">start&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">stop&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Time&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">bool&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">start&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Before&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">now&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nx">start&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Equal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">now&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nx">now&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Before&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">stop&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;h4 id="ä½¿ç”¨-timeduration-è¡¨è¾¾æ—¶é—´æ®µ">ä½¿ç”¨ &lt;code>time.Duration&lt;/code> è¡¨è¾¾æ—¶é—´æ®µ&lt;/h4>
&lt;p>åœ¨å¤„ç†æ—¶é—´æ®µæ—¶ä½¿ç”¨ &lt;a href="https://golang.org/pkg/time/#Duration">&lt;code>time.Duration&lt;/code>&lt;/a> .&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">poll&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">delay&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// ...
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Duration&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">delay&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Millisecond&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nf">poll&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// æ˜¯å‡ ç§’é’Ÿè¿˜æ˜¯å‡ æ¯«ç§’?
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">poll&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">delay&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Duration&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// ...
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">delay&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nf">poll&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;p>å›åˆ°ç¬¬ä¸€ä¸ªä¾‹å­ï¼Œåœ¨ä¸€ä¸ªæ—¶é—´ç¬é—´åŠ ä¸Š 24 å°æ—¶ï¼Œæˆ‘ä»¬ç”¨äºæ·»åŠ æ—¶é—´çš„æ–¹æ³•å–å†³äºæ„å›¾ã€‚å¦‚æœæˆ‘ä»¬æƒ³è¦ä¸‹ä¸€ä¸ªæ—¥å†æ—¥(å½“å‰å¤©çš„ä¸‹ä¸€å¤©)çš„åŒä¸€ä¸ªæ—¶é—´ç‚¹ï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨ &lt;a href="https://golang.org/pkg/time/#Time.AddDate">&lt;code>Time.AddDate&lt;/code>&lt;/a>ã€‚ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬æƒ³ä¿è¯æŸä¸€æ—¶åˆ»æ¯”å‰ä¸€æ—¶åˆ»æ™š 24 å°æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨ &lt;a href="https://golang.org/pkg/time/#Time.Add">&lt;code>Time.Add&lt;/code>&lt;/a>ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">newDay&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">t&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">AddDate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span> &lt;span class="cm">/* years */&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="cm">/* months */&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="cm">/* days */&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">maybeNewDay&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">t&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">24&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Hour&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="å¯¹å¤–éƒ¨ç³»ç»Ÿä½¿ç”¨-timetime-å’Œ-timeduration">å¯¹å¤–éƒ¨ç³»ç»Ÿä½¿ç”¨ &lt;code>time.Time&lt;/code> å’Œ &lt;code>time.Duration&lt;/code>&lt;/h4>
&lt;p>å°½å¯èƒ½åœ¨ä¸å¤–éƒ¨ç³»ç»Ÿçš„äº¤äº’ä¸­ä½¿ç”¨ &lt;code>time.Duration&lt;/code> å’Œ &lt;code>time.Time&lt;/code> ä¾‹å¦‚ :&lt;/p>
&lt;ul>
&lt;li>
&lt;p>Command-line æ ‡å¿—: &lt;a href="https://golang.org/pkg/flag/">&lt;code>flag&lt;/code>&lt;/a> é€šè¿‡ &lt;a href="https://golang.org/pkg/time/#ParseDuration">&lt;code>time.ParseDuration&lt;/code>&lt;/a> æ”¯æŒ &lt;code>time.Duration&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>JSON: &lt;a href="https://golang.org/pkg/encoding/json/">&lt;code>encoding/json&lt;/code>&lt;/a> é€šè¿‡å…¶ &lt;a href="https://golang.org/pkg/time/#Time.UnmarshalJSON">&lt;code>UnmarshalJSON&lt;/code> method&lt;/a> æ–¹æ³•æ”¯æŒå°† &lt;code>time.Time&lt;/code> ç¼–ç ä¸º &lt;a href="https://tools.ietf.org/html/rfc3339">RFC 3339&lt;/a> å­—ç¬¦ä¸²&lt;/p>
&lt;/li>
&lt;li>
&lt;p>SQL: &lt;a href="https://golang.org/pkg/database/sql/">&lt;code>database/sql&lt;/code>&lt;/a> æ”¯æŒå°† &lt;code>DATETIME&lt;/code> æˆ– &lt;code>TIMESTAMP&lt;/code> åˆ—è½¬æ¢ä¸º &lt;code>time.Time&lt;/code>ï¼Œå¦‚æœåº•å±‚é©±åŠ¨ç¨‹åºæ”¯æŒåˆ™è¿”å›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>YAML: &lt;a href="https://godoc.org/gopkg.in/yaml.v2">&lt;code>gopkg.in/yaml.v2&lt;/code>&lt;/a> æ”¯æŒå°† &lt;code>time.Time&lt;/code> ä½œä¸º &lt;a href="https://tools.ietf.org/html/rfc3339">RFC 3339&lt;/a> å­—ç¬¦ä¸²ï¼Œå¹¶é€šè¿‡ &lt;a href="https://golang.org/pkg/time/#ParseDuration">&lt;code>time.ParseDuration&lt;/code>&lt;/a> æ”¯æŒ &lt;code>time.Duration&lt;/code>ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>å½“ä¸èƒ½åœ¨è¿™äº›äº¤äº’ä¸­ä½¿ç”¨ &lt;code>time.Duration&lt;/code> æ—¶ï¼Œè¯·ä½¿ç”¨ &lt;code>int&lt;/code> æˆ– &lt;code>float64&lt;/code>ï¼Œå¹¶åœ¨å­—æ®µåç§°ä¸­åŒ…å«å•ä½ã€‚&lt;/p>
&lt;p>ä¾‹å¦‚ï¼Œç”±äº &lt;code>encoding/json&lt;/code> ä¸æ”¯æŒ &lt;code>time.Duration&lt;/code>ï¼Œå› æ­¤è¯¥å•ä½åŒ…å«åœ¨å­—æ®µçš„åç§°ä¸­ã€‚&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// {&amp;#34;interval&amp;#34;: 2}
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">Config&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">Interval&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="s">`json:&amp;#34;interval&amp;#34;`&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// {&amp;#34;intervalMillis&amp;#34;: 2000}
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">Config&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">IntervalMillis&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="s">`json:&amp;#34;intervalMillis&amp;#34;`&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;p>å½“åœ¨è¿™äº›äº¤äº’ä¸­ä¸èƒ½ä½¿ç”¨ &lt;code>time.Time&lt;/code> æ—¶ï¼Œé™¤éè¾¾æˆä¸€è‡´ï¼Œå¦åˆ™ä½¿ç”¨ &lt;code>string&lt;/code> å’Œ &lt;a href="https://tools.ietf.org/html/rfc3339">RFC 3339&lt;/a> ä¸­å®šä¹‰çš„æ ¼å¼æ—¶é—´æˆ³ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œ&lt;a href="https://golang.org/pkg/time/#Time.UnmarshalText">&lt;code>Time.UnmarshalText&lt;/code>&lt;/a> ä½¿ç”¨æ­¤æ ¼å¼ï¼Œå¹¶å¯é€šè¿‡ &lt;a href="https://golang.org/pkg/time/#RFC3339">&lt;code>time.RFC3339&lt;/code>&lt;/a> åœ¨ &lt;code>Time.Format&lt;/code> å’Œ &lt;code>time.Parse&lt;/code> ä¸­ä½¿ç”¨ã€‚&lt;/p>
&lt;p>å°½ç®¡è¿™åœ¨å®è·µä¸­å¹¶ä¸æˆé—®é¢˜ï¼Œä½†è¯·è®°ä½ï¼Œ&lt;code>&amp;quot;time&amp;quot;&lt;/code> åŒ…ä¸æ”¯æŒè§£æé—°ç§’æ—¶é—´æˆ³ï¼ˆ&lt;a href="https://github.com/golang/go/issues/8728">8728&lt;/a>ï¼‰ï¼Œä¹Ÿä¸åœ¨è®¡ç®—ä¸­è€ƒè™‘é—°ç§’ï¼ˆ&lt;a href="https://github.com/golang/go/issues/15190">15190&lt;/a>ï¼‰ã€‚å¦‚æœæ‚¨æ¯”è¾ƒä¸¤ä¸ªæ—¶é—´ç¬é—´ï¼Œåˆ™å·®å¼‚å°†ä¸åŒ…æ‹¬è¿™ä¸¤ä¸ªç¬é—´ä¹‹é—´å¯èƒ½å‘ç”Ÿçš„é—°ç§’ã€‚&lt;/p>
&lt;h3 id="é”™è¯¯ç±»å‹">é”™è¯¯ç±»å‹&lt;/h3>
&lt;p>Go ä¸­æœ‰å¤šç§å£°æ˜é”™è¯¯ï¼ˆError) çš„é€‰é¡¹ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://golang.org/pkg/errors/#New">&lt;code>errors.New&lt;/code>&lt;/a> å¯¹äºç®€å•é™æ€å­—ç¬¦ä¸²çš„é”™è¯¯&lt;/li>
&lt;li>&lt;a href="https://golang.org/pkg/fmt/#Errorf">&lt;code>fmt.Errorf&lt;/code>&lt;/a> ç”¨äºæ ¼å¼åŒ–çš„é”™è¯¯å­—ç¬¦ä¸²&lt;/li>
&lt;li>å®ç° &lt;code>Error()&lt;/code> æ–¹æ³•çš„è‡ªå®šä¹‰ç±»å‹&lt;/li>
&lt;li>ç”¨ &lt;a href="https://godoc.org/github.com/pkg/errors#Wrap">&lt;code>&amp;quot;pkg/errors&amp;quot;.Wrap&lt;/code>&lt;/a> çš„ Wrapped errors&lt;/li>
&lt;/ul>
&lt;p>è¿”å›é”™è¯¯æ—¶ï¼Œè¯·è€ƒè™‘ä»¥ä¸‹å› ç´ ä»¥ç¡®å®šæœ€ä½³é€‰æ‹©ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>è¿™æ˜¯ä¸€ä¸ªä¸éœ€è¦é¢å¤–ä¿¡æ¯çš„ç®€å•é”™è¯¯å—ï¼Ÿå¦‚æœæ˜¯è¿™æ ·ï¼Œ&lt;a href="https://golang.org/pkg/errors/#New">&lt;code>errors.New&lt;/code>&lt;/a> è¶³å¤Ÿäº†ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å®¢æˆ·éœ€è¦æ£€æµ‹å¹¶å¤„ç†æ­¤é”™è¯¯å—ï¼Ÿå¦‚æœæ˜¯è¿™æ ·ï¼Œåˆ™åº”ä½¿ç”¨è‡ªå®šä¹‰ç±»å‹å¹¶å®ç°è¯¥ &lt;code>Error()&lt;/code> æ–¹æ³•ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æ‚¨æ˜¯å¦æ­£åœ¨ä¼ æ’­ä¸‹æ¸¸å‡½æ•°è¿”å›çš„é”™è¯¯ï¼Ÿå¦‚æœæ˜¯è¿™æ ·ï¼Œè¯·æŸ¥çœ‹æœ¬æ–‡åé¢æœ‰å…³é”™è¯¯åŒ…è£… &lt;a href="https://yusank.github.io/posts/go-standard/#%E9%94%99%E8%AF%AF%E5%8C%85%E8%A3%85" title="Error-Wrapping">section on error wrapping&lt;/a> éƒ¨åˆ†çš„å†…å®¹ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å¦åˆ™ &lt;a href="https://golang.org/pkg/fmt/#Errorf">&lt;code>fmt.Errorf&lt;/code>&lt;/a> å°±å¯ä»¥äº†ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>å¦‚æœå®¢æˆ·ç«¯éœ€è¦æ£€æµ‹é”™è¯¯ï¼Œå¹¶ä¸”æ‚¨å·²ä½¿ç”¨åˆ›å»ºäº†ä¸€ä¸ªç®€å•çš„é”™è¯¯ &lt;a href="https://golang.org/pkg/errors/#New">&lt;code>errors.New&lt;/code>&lt;/a>ï¼Œè¯·ä½¿ç”¨ä¸€ä¸ªé”™è¯¯å˜é‡ã€‚&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// package foo
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">Open&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">errors&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;could not open&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// package bar
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">use&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">foo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Open&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s">&amp;#34;could not open&amp;#34;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// handle
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;unknown error&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// package foo
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">ErrCouldNotOpen&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">errors&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;could not open&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">Open&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">ErrCouldNotOpen&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// package bar
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">foo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Open&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nx">foo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ErrCouldNotOpen&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// handle
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;unknown error&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;p>å¦‚æœæ‚¨æœ‰å¯èƒ½éœ€è¦å®¢æˆ·ç«¯æ£€æµ‹çš„é”™è¯¯ï¼Œå¹¶ä¸”æƒ³å‘å…¶ä¸­æ·»åŠ æ›´å¤šä¿¡æ¯ï¼ˆä¾‹å¦‚ï¼Œå®ƒä¸æ˜¯é™æ€å­—ç¬¦ä¸²ï¼‰ï¼Œåˆ™åº”ä½¿ç”¨è‡ªå®šä¹‰ç±»å‹ã€‚&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">file&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;file %q not found&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">file&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">use&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;testfile.txt&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">strings&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Contains&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="s">&amp;#34;not found&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// handle
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;unknown error&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">errNotFound&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">file&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">e&lt;/span> &lt;span class="nx">errNotFound&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Error&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;file %q not found&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">file&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">file&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">errNotFound&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">file&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">file&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">use&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;testfile.txt&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="nx">errNotFound&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// handle
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;unknown error&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;p>ç›´æ¥å¯¼å‡ºè‡ªå®šä¹‰é”™è¯¯ç±»å‹æ—¶è¦å°å¿ƒï¼Œå› ä¸ºå®ƒä»¬å·²æˆä¸ºç¨‹åºåŒ…å…¬å…± API çš„ä¸€éƒ¨åˆ†ã€‚æœ€å¥½å…¬å¼€åŒ¹é…å™¨åŠŸèƒ½ä»¥æ£€æŸ¥é”™è¯¯ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// package foo
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">errNotFound&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">file&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">e&lt;/span> &lt;span class="nx">errNotFound&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Error&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;file %q not found&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">e&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">file&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">IsNotFoundError&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">bool&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="nx">errNotFound&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">ok&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">Open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">file&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">errNotFound&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">file&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">file&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// package bar
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">foo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;foo&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">foo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">IsNotFoundError&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// handle
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;unknown error&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="é”™è¯¯åŒ…è£…-error-wrapping">é”™è¯¯åŒ…è£… (Error Wrapping)&lt;/h3>
&lt;p>ä¸€ä¸ªï¼ˆå‡½æ•°/æ–¹æ³•ï¼‰è°ƒç”¨å¤±è´¥æ—¶ï¼Œæœ‰ä¸‰ç§ä¸»è¦çš„é”™è¯¯ä¼ æ’­æ–¹å¼ï¼š&lt;/p>
&lt;ul>
&lt;li>å¦‚æœæ²¡æœ‰è¦æ·»åŠ çš„å…¶ä»–ä¸Šä¸‹æ–‡ï¼Œå¹¶ä¸”æ‚¨æƒ³è¦ç»´æŠ¤åŸå§‹é”™è¯¯ç±»å‹ï¼Œåˆ™è¿”å›åŸå§‹é”™è¯¯ã€‚&lt;/li>
&lt;li>æ·»åŠ ä¸Šä¸‹æ–‡ï¼Œä½¿ç”¨ &lt;a href="https://godoc.org/github.com/pkg/errors#Wrap">&lt;code>&amp;quot;pkg/errors&amp;quot;.Wrap&lt;/code>&lt;/a> ä»¥ä¾¿é”™è¯¯æ¶ˆæ¯æä¾›æ›´å¤šä¸Šä¸‹æ–‡ ,&lt;a href="https://godoc.org/github.com/pkg/errors#Cause">&lt;code>&amp;quot;pkg/errors&amp;quot;.Cause&lt;/code>&lt;/a> å¯ç”¨äºæå–åŸå§‹é”™è¯¯ã€‚&lt;/li>
&lt;li>å¦‚æœè°ƒç”¨è€…ä¸éœ€è¦æ£€æµ‹æˆ–å¤„ç†çš„ç‰¹å®šé”™è¯¯æƒ…å†µï¼Œä½¿ç”¨ &lt;a href="https://golang.org/pkg/fmt/#Errorf">&lt;code>fmt.Errorf&lt;/code>&lt;/a>ã€‚&lt;/li>
&lt;/ul>
&lt;p>å»ºè®®åœ¨å¯èƒ½çš„åœ°æ–¹æ·»åŠ ä¸Šä¸‹æ–‡ï¼Œä»¥ä½¿æ‚¨è·å¾—è¯¸å¦‚â€œè°ƒç”¨æœåŠ¡ fooï¼šè¿æ¥è¢«æ‹’ç»â€ä¹‹ç±»çš„æ›´æœ‰ç”¨çš„é”™è¯¯ï¼Œè€Œä¸æ˜¯è¯¸å¦‚â€œè¿æ¥è¢«æ‹’ç»â€ä¹‹ç±»çš„æ¨¡ç³Šé”™è¯¯ã€‚&lt;/p>
&lt;p>åœ¨å°†ä¸Šä¸‹æ–‡æ·»åŠ åˆ°è¿”å›çš„é”™è¯¯æ—¶ï¼Œè¯·é¿å…ä½¿ç”¨â€œfailed toâ€ä¹‹ç±»çš„çŸ­è¯­ä»¥ä¿æŒä¸Šä¸‹æ–‡ç®€æ´ï¼Œè¿™äº›çŸ­è¯­ä¼šé™ˆè¿°æ˜æ˜¾çš„å†…å®¹ï¼Œå¹¶éšç€é”™è¯¯åœ¨å †æ ˆä¸­çš„æ¸—é€è€Œé€æ¸å †ç§¯ï¼š&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">s&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">store&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;failed to create new store: %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">s&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">store&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Errorf&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;new store: %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">failed to x: failed to y: failed to create new store: the error
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">x: y: new store: the error
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;p>ä½†æ˜¯ï¼Œä¸€æ—¦å°†é”™è¯¯å‘é€åˆ°å¦ä¸€ä¸ªç³»ç»Ÿï¼Œå°±åº”è¯¥æ˜ç¡®æ¶ˆæ¯æ˜¯é”™è¯¯æ¶ˆæ¯ï¼ˆä¾‹å¦‚ä½¿ç”¨&lt;code>err&lt;/code>æ ‡è®°ï¼Œæˆ–åœ¨æ—¥å¿—ä¸­ä»¥â€Failedâ€ä¸ºå‰ç¼€ï¼‰ã€‚&lt;/p>
&lt;p>å¦è¯·å‚è§ &lt;a href="https://dave.cheney.net/2016/04/27/dont-just-check-errors-handle-them-gracefully">Don't just check errors, handle them gracefully&lt;/a>. ä¸è¦åªæ˜¯æ£€æŸ¥é”™è¯¯ï¼Œè¦ä¼˜é›…åœ°å¤„ç†é”™è¯¯&lt;/p>
&lt;h3 id="å¤„ç†ç±»å‹æ–­è¨€å¤±è´¥">å¤„ç†ç±»å‹æ–­è¨€å¤±è´¥&lt;/h3>
&lt;p>&lt;a href="https://golang.org/ref/spec#Type_assertions">type assertion&lt;/a> çš„å•ä¸ªè¿”å›å€¼å½¢å¼é’ˆå¯¹ä¸æ­£ç¡®çš„ç±»å‹å°†äº§ç”Ÿ panicã€‚å› æ­¤ï¼Œè¯·å§‹ç»ˆä½¿ç”¨â€œcomma okâ€çš„æƒ¯ç”¨æ³•ã€‚&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">t&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">t&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">ok&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// ä¼˜é›…åœ°å¤„ç†é”™è¯¯
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;!-- TODO: There are a few situations where the single assignment form is
fine. -->
&lt;h3 id="ä¸è¦-panic">ä¸è¦ panic&lt;/h3>
&lt;p>åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è¿è¡Œçš„ä»£ç å¿…é¡»é¿å…å‡ºç° panicã€‚panic æ˜¯ &lt;a href="https://en.wikipedia.org/wiki/Cascading_failure">cascading failures&lt;/a> çº§è”å¤±è´¥çš„ä¸»è¦æ ¹æº ã€‚å¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œè¯¥å‡½æ•°å¿…é¡»è¿”å›é”™è¯¯ï¼Œå¹¶å…è®¸è°ƒç”¨æ–¹å†³å®šå¦‚ä½•å¤„ç†å®ƒã€‚&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">args&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">args&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;an argument is required&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// ...
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Args&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">:])&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">args&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">args&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">errors&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;an argument is required&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// ...
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Args&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">:]);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Fprintln&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Stderr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;p>panic/recover ä¸æ˜¯é”™è¯¯å¤„ç†ç­–ç•¥ã€‚ä»…å½“å‘ç”Ÿä¸å¯æ¢å¤çš„äº‹æƒ…ï¼ˆä¾‹å¦‚ï¼šnil å¼•ç”¨ï¼‰æ—¶ï¼Œç¨‹åºæ‰å¿…é¡» panicã€‚ç¨‹åºåˆå§‹åŒ–æ˜¯ä¸€ä¸ªä¾‹å¤–ï¼šç¨‹åºå¯åŠ¨æ—¶åº”ä½¿ç¨‹åºä¸­æ­¢çš„ä¸è‰¯æƒ…å†µå¯èƒ½ä¼šå¼•èµ· panicã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">var&lt;/span> &lt;span class="nx">_statusTemplate&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">template&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Must&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">template&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nf">Parse&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;_statusHTML&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å³ä½¿åœ¨æµ‹è¯•ä»£ç ä¸­ï¼Œä¹Ÿä¼˜å…ˆä½¿ç”¨&lt;code>t.Fatal&lt;/code>æˆ–è€…&lt;code>t.FailNow&lt;/code>è€Œä¸æ˜¯ panic æ¥ç¡®ä¿å¤±è´¥è¢«æ ‡è®°ã€‚&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// func TestFoo(t *testing.T)
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="nx">f&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">ioutil&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">TempFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;test&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;failed to set up test&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// func TestFoo(t *testing.T)
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="nx">f&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">ioutil&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">TempFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;test&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">t&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Fatal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;failed to set up test&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;!-- TODO: Explain how to use _test packages. -->
&lt;h3 id="ä½¿ç”¨-gouberorgatomic">ä½¿ç”¨ go.uber.org/atomic&lt;/h3>
&lt;p>ä½¿ç”¨ &lt;a href="https://golang.org/pkg/sync/atomic/">sync/atomic&lt;/a> åŒ…çš„åŸå­æ“ä½œå¯¹åŸå§‹ç±»å‹ (&lt;code>int32&lt;/code>, &lt;code>int64&lt;/code>ç­‰ï¼‰è¿›è¡Œæ“ä½œï¼Œå› ä¸ºå¾ˆå®¹æ˜“å¿˜è®°ä½¿ç”¨åŸå­æ“ä½œæ¥è¯»å–æˆ–ä¿®æ”¹å˜é‡ã€‚&lt;/p>
&lt;p>&lt;a href="https://godoc.org/go.uber.org/atomic">go.uber.org/atomic&lt;/a> é€šè¿‡éšè—åŸºç¡€ç±»å‹ä¸ºè¿™äº›æ“ä½œå¢åŠ äº†ç±»å‹å®‰å…¨æ€§ã€‚æ­¤å¤–ï¼Œå®ƒåŒ…æ‹¬ä¸€ä¸ªæ–¹ä¾¿çš„&lt;code>atomic.Bool&lt;/code>ç±»å‹ã€‚&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">foo&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">running&lt;/span> &lt;span class="kt">int32&lt;/span> &lt;span class="c1">// atomic
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">f&lt;/span>&lt;span class="o">*&lt;/span> &lt;span class="nx">foo&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">start&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">atomic&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SwapInt32&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">f&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">running&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// already runningâ€¦
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// start the Foo
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">f&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">foo&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">isRunning&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">bool&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">f&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">running&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="c1">// race!
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">foo&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">running&lt;/span> &lt;span class="nx">atomic&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Bool&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">f&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">foo&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">start&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">f&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">running&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Swap&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// already runningâ€¦
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// start the Foo
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">f&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">foo&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">isRunning&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">bool&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">f&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">running&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Load&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;h3 id="é¿å…å¯å˜å…¨å±€å˜é‡">é¿å…å¯å˜å…¨å±€å˜é‡&lt;/h3>
&lt;p>ä½¿ç”¨é€‰æ‹©ä¾èµ–æ³¨å…¥æ–¹å¼é¿å…æ”¹å˜å…¨å±€å˜é‡ã€‚
æ—¢é€‚ç”¨äºå‡½æ•°æŒ‡é’ˆåˆé€‚ç”¨äºå…¶ä»–å€¼ç±»å‹&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// sign.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">var&lt;/span> &lt;span class="nx">_timeNow&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Now&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">sign&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">msg&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">now&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">_timeNow&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nf">signWithTime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">msg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">now&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// sign.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">signer&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">now&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Time&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">newSigner&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">signer&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">signer&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">now&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Now&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">signer&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Sign&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">msg&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">now&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">now&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nf">signWithTime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">msg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">now&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// sign_test.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">TestSign&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">testing&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">T&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">oldTimeNow&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">_timeNow&lt;/span>
&lt;span class="nx">_timeNow&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Time&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">someFixedTime&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nx">_timeNow&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">oldTimeNow&lt;/span> &lt;span class="p">}()&lt;/span>
&lt;span class="nx">assert&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Equal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">want&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nf">sign&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">give&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// sign_test.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">TestSigner&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">testing&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">T&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">s&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">newSigner&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">now&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Time&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">someFixedTime&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">assert&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Equal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">want&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sign&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">give&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;h3 id="é¿å…åœ¨å…¬å…±ç»“æ„ä¸­åµŒå…¥ç±»å‹">é¿å…åœ¨å…¬å…±ç»“æ„ä¸­åµŒå…¥ç±»å‹&lt;/h3>
&lt;p>è¿™äº›åµŒå…¥çš„ç±»å‹æ³„æ¼å®ç°ç»†èŠ‚ã€ç¦æ­¢ç±»å‹æ¼”åŒ–å’Œæ¨¡ç³Šçš„æ–‡æ¡£ã€‚&lt;/p>
&lt;p>å‡è®¾æ‚¨ä½¿ç”¨å…±äº«çš„ &lt;code>AbstractList&lt;/code> å®ç°äº†å¤šç§åˆ—è¡¨ç±»å‹ï¼Œè¯·é¿å…åœ¨å…·ä½“çš„åˆ—è¡¨å®ç°ä¸­åµŒå…¥ &lt;code>AbstractList&lt;/code>ã€‚
ç›¸åï¼Œåªéœ€æ‰‹åŠ¨å°†æ–¹æ³•å†™å…¥å…·ä½“çš„åˆ—è¡¨ï¼Œè¯¥åˆ—è¡¨å°†å§”æ‰˜ç»™æŠ½è±¡åˆ—è¡¨ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">AbstractList&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;span class="c1">// æ·»åŠ å°†å®ä½“æ·»åŠ åˆ°åˆ—è¡¨ä¸­ã€‚
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">l&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">AbstractList&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">e&lt;/span> &lt;span class="nx">Entity&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// ...
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="c1">// ç§»é™¤ä»åˆ—è¡¨ä¸­ç§»é™¤å®ä½“ã€‚
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">l&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">AbstractList&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Remove&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">e&lt;/span> &lt;span class="nx">Entity&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// ...
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// ConcreteList æ˜¯ä¸€ä¸ªå®ä½“åˆ—è¡¨ã€‚
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">ConcreteList&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="o">*&lt;/span>&lt;span class="nx">AbstractList&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// ConcreteList æ˜¯ä¸€ä¸ªå®ä½“åˆ—è¡¨ã€‚
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">ConcreteList&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">list&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">AbstractList&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// æ·»åŠ å°†å®ä½“æ·»åŠ åˆ°åˆ—è¡¨ä¸­ã€‚
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">l&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ConcreteList&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">e&lt;/span> &lt;span class="nx">Entity&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">l&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">list&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">e&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// ç§»é™¤ä»åˆ—è¡¨ä¸­ç§»é™¤å®ä½“ã€‚
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">l&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ConcreteList&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Remove&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">e&lt;/span> &lt;span class="nx">Entity&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">l&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">list&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Remove&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">e&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;p>Go å…è®¸ &lt;a href="https://golang.org/doc/effective_go.html#embedding">ç±»å‹åµŒå…¥&lt;/a> ä½œä¸ºç»§æ‰¿å’Œç»„åˆä¹‹é—´çš„æŠ˜è¡·ã€‚
å¤–éƒ¨ç±»å‹è·å–åµŒå…¥ç±»å‹çš„æ–¹æ³•çš„éšå¼å‰¯æœ¬ã€‚
é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™äº›æ–¹æ³•å§”æ‰˜ç»™åµŒå…¥å®ä¾‹çš„åŒä¸€æ–¹æ³•ã€‚&lt;/p>
&lt;p>ç»“æ„è¿˜è·å¾—ä¸ç±»å‹åŒåçš„å­—æ®µã€‚
æ‰€ä»¥ï¼Œå¦‚æœåµŒå…¥çš„ç±»å‹æ˜¯ publicï¼Œé‚£ä¹ˆå­—æ®µæ˜¯ publicã€‚ä¸ºäº†ä¿æŒå‘åå…¼å®¹æ€§ï¼Œå¤–éƒ¨ç±»å‹çš„æ¯ä¸ªæœªæ¥ç‰ˆæœ¬éƒ½å¿…é¡»ä¿ç•™åµŒå…¥ç±»å‹ã€‚&lt;/p>
&lt;p>å¾ˆå°‘éœ€è¦åµŒå…¥ç±»å‹ã€‚
è¿™æ˜¯ä¸€ç§æ–¹ä¾¿ï¼Œå¯ä»¥å¸®åŠ©æ‚¨é¿å…ç¼–å†™å†—é•¿çš„å§”æ‰˜æ–¹æ³•ã€‚&lt;/p>
&lt;p>å³ä½¿åµŒå…¥å…¼å®¹çš„æŠ½è±¡åˆ—è¡¨ &lt;em>interface&lt;/em>ï¼Œè€Œä¸æ˜¯ç»“æ„ä½“ï¼Œè¿™å°†ä¸ºå¼€å‘äººå‘˜æä¾›æ›´å¤§çš„çµæ´»æ€§æ¥æ”¹å˜æœªæ¥ï¼Œä½†ä»ç„¶æ³„éœ²äº†å…·ä½“åˆ—è¡¨ä½¿ç”¨æŠ½è±¡å®ç°çš„ç»†èŠ‚ã€‚&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// AbstractList æ˜¯å„ç§å®ä½“åˆ—è¡¨çš„é€šç”¨å®ç°ã€‚
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">AbstractList&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">Add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">Entity&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nf">Remove&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">Entity&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// ConcreteList æ˜¯ä¸€ä¸ªå®ä½“åˆ—è¡¨ã€‚
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">ConcreteList&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">AbstractList&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// ConcreteList æ˜¯ä¸€ä¸ªå®ä½“åˆ—è¡¨ã€‚
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">ConcreteList&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">list&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">AbstractList&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// æ·»åŠ å°†å®ä½“æ·»åŠ åˆ°åˆ—è¡¨ä¸­ã€‚
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">l&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ConcreteList&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">e&lt;/span> &lt;span class="nx">Entity&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">l&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">list&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">e&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// ç§»é™¤ä»åˆ—è¡¨ä¸­ç§»é™¤å®ä½“ã€‚
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">l&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">ConcreteList&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Remove&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">e&lt;/span> &lt;span class="nx">Entity&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">l&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">list&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Remove&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">e&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;p>æ— è®ºæ˜¯ä½¿ç”¨åµŒå…¥å¼ç»“æ„è¿˜æ˜¯ä½¿ç”¨åµŒå…¥å¼æ¥å£ï¼ŒåµŒå…¥å¼ç±»å‹éƒ½ä¼šé™åˆ¶ç±»å‹çš„æ¼”åŒ–.&lt;/p>
&lt;ul>
&lt;li>å‘åµŒå…¥å¼æ¥å£æ·»åŠ æ–¹æ³•æ˜¯ä¸€ä¸ªç ´åæ€§çš„æ”¹å˜ã€‚&lt;/li>
&lt;li>åˆ é™¤åµŒå…¥ç±»å‹æ˜¯ä¸€ä¸ªç ´åæ€§çš„æ”¹å˜ã€‚&lt;/li>
&lt;li>å³ä½¿ä½¿ç”¨æ»¡è¶³ç›¸åŒæ¥å£çš„æ›¿ä»£æ–¹æ³•æ›¿æ¢åµŒå…¥ç±»å‹ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªç ´åæ€§çš„æ”¹å˜ã€‚&lt;/li>
&lt;/ul>
&lt;p>å°½ç®¡ç¼–å†™è¿™äº›å§”æ‰˜æ–¹æ³•æ˜¯ä¹å‘³çš„ï¼Œä½†æ˜¯é¢å¤–çš„å·¥ä½œéšè—äº†å®ç°ç»†èŠ‚ï¼Œç•™ä¸‹äº†æ›´å¤šçš„æ›´æ”¹æœºä¼šï¼Œè¿˜æ¶ˆé™¤äº†åœ¨æ–‡æ¡£ä¸­å‘ç°å®Œæ•´åˆ—è¡¨æ¥å£çš„é—´æ¥æ€§æ“ä½œã€‚&lt;/p>
&lt;h3 id="é¿å…ä½¿ç”¨å†…ç½®åç§°">é¿å…ä½¿ç”¨å†…ç½®åç§°&lt;/h3>
&lt;p>Goè¯­è¨€è§„èŒƒ&lt;a href="https://golang.org/ref/spec">language specification&lt;/a> æ¦‚è¿°äº†å‡ ä¸ªå†…ç½®çš„ï¼Œ
ä¸åº”åœ¨Goé¡¹ç›®ä¸­ä½¿ç”¨çš„åç§°æ ‡è¯†&lt;a href="https://golang.org/ref/spec#Predeclared_identifiers">predeclared identifiers&lt;/a>ã€‚&lt;/p>
&lt;p>æ ¹æ®ä¸Šä¸‹æ–‡çš„ä¸åŒï¼Œå°†è¿™äº›æ ‡è¯†ç¬¦ä½œä¸ºåç§°é‡å¤ä½¿ç”¨ï¼Œ
å°†åœ¨å½“å‰ä½œç”¨åŸŸï¼ˆæˆ–ä»»ä½•åµŒå¥—ä½œç”¨åŸŸï¼‰ä¸­éšè—åŸå§‹æ ‡è¯†ç¬¦ï¼Œæˆ–è€…æ··æ·†ä»£ç ã€‚
åœ¨æœ€å¥½çš„æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨ä¼šæŠ¥é”™ï¼›åœ¨æœ€åçš„æƒ…å†µä¸‹ï¼Œè¿™æ ·çš„ä»£ç å¯èƒ½ä¼šå¼•å…¥æ½œåœ¨çš„ã€éš¾ä»¥æ¢å¤çš„é”™è¯¯ã€‚&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">var&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="c1">// `error` ä½œç”¨åŸŸéšå¼è¦†ç›–
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="c1">// or
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">handleErrorMessage&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">error&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// `error` ä½œç”¨åŸŸéšå¼è¦†ç›–
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">var&lt;/span> &lt;span class="nx">errorMessage&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="c1">// `error` æŒ‡å‘å†…ç½®çš„éè¦†ç›–
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="c1">// or
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">handleErrorMessage&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">msg&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// `error` æŒ‡å‘å†…ç½®çš„éè¦†ç›–
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Foo&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// è™½ç„¶è¿™äº›å­—æ®µåœ¨æŠ€æœ¯ä¸Šä¸æ„æˆé˜´å½±ï¼Œä½†`error`æˆ–`string`å­—ç¬¦ä¸²çš„é‡æ˜ å°„ç°åœ¨æ˜¯ä¸æ˜ç¡®çš„ã€‚
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="kt">string&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">f&lt;/span> &lt;span class="nx">Foo&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Error&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// `error` å’Œ `f.error` åœ¨è§†è§‰ä¸Šæ˜¯ç›¸ä¼¼çš„
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="nx">f&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="kt">error&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">f&lt;/span> &lt;span class="nx">Foo&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">String&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// `string` and `f.string` åœ¨è§†è§‰ä¸Šæ˜¯ç›¸ä¼¼çš„
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="nx">f&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="kt">string&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Foo&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// `error` and `string` ç°åœ¨æ˜¯æ˜ç¡®çš„ã€‚
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="nx">str&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">f&lt;/span> &lt;span class="nx">Foo&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Error&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">f&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">f&lt;/span> &lt;span class="nx">Foo&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">String&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">f&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">str&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;p>æ³¨æ„ï¼Œç¼–è¯‘å™¨åœ¨ä½¿ç”¨é¢„å…ˆåˆ†éš”çš„æ ‡è¯†ç¬¦æ—¶ä¸ä¼šç”Ÿæˆé”™è¯¯ï¼Œ
ä½†æ˜¯è¯¸å¦‚&lt;code>go vet&lt;/code>ä¹‹ç±»çš„å·¥å…·ä¼šæ­£ç¡®åœ°æŒ‡å‡ºè¿™äº›å’Œå…¶ä»–æƒ…å†µä¸‹çš„éšå¼é—®é¢˜ã€‚&lt;/p>
&lt;h3 id="é¿å…ä½¿ç”¨-init">é¿å…ä½¿ç”¨ &lt;code>init()&lt;/code>&lt;/h3>
&lt;p>å°½å¯èƒ½é¿å…ä½¿ç”¨&lt;code>init()&lt;/code>ã€‚å½“&lt;code>init()&lt;/code>æ˜¯ä¸å¯é¿å…æˆ–å¯å–çš„ï¼Œä»£ç åº”å…ˆå°è¯•ï¼š&lt;/p>
&lt;ol>
&lt;li>æ— è®ºç¨‹åºç¯å¢ƒæˆ–è°ƒç”¨å¦‚ä½•ï¼Œéƒ½è¦å®Œå…¨ç¡®å®šã€‚&lt;/li>
&lt;li>é¿å…ä¾èµ–äºå…¶ä»–&lt;code>init()&lt;/code>å‡½æ•°çš„é¡ºåºæˆ–å‰¯ä½œç”¨ã€‚è™½ç„¶&lt;code>init()&lt;/code>é¡ºåºæ˜¯æ˜ç¡®çš„ï¼Œä½†ä»£ç å¯ä»¥æ›´æ”¹ï¼Œ
å› æ­¤&lt;code>init()&lt;/code>å‡½æ•°ä¹‹é—´çš„å…³ç³»å¯èƒ½ä¼šä½¿ä»£ç å˜å¾—è„†å¼±å’Œå®¹æ˜“å‡ºé”™ã€‚&lt;/li>
&lt;li>é¿å…è®¿é—®æˆ–æ“ä½œå…¨å±€æˆ–ç¯å¢ƒçŠ¶æ€ï¼Œå¦‚æœºå™¨ä¿¡æ¯ã€ç¯å¢ƒå˜é‡ã€å·¥ä½œç›®å½•ã€ç¨‹åºå‚æ•°/è¾“å…¥ç­‰ã€‚&lt;/li>
&lt;li>é¿å…&lt;code>I/O&lt;/code>ï¼ŒåŒ…æ‹¬æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œå’Œç³»ç»Ÿè°ƒç”¨ã€‚&lt;/li>
&lt;/ol>
&lt;p>ä¸èƒ½æ»¡è¶³è¿™äº›è¦æ±‚çš„ä»£ç å¯èƒ½å±äºè¦ä½œä¸º&lt;code>main()&lt;/code>è°ƒç”¨çš„ä¸€éƒ¨åˆ†ï¼ˆæˆ–ç¨‹åºç”Ÿå‘½å‘¨æœŸä¸­çš„å…¶ä»–åœ°æ–¹ï¼‰ï¼Œ
æˆ–è€…ä½œä¸º&lt;code>main()&lt;/code>æœ¬èº«çš„ä¸€éƒ¨åˆ†å†™å…¥ã€‚ç‰¹åˆ«æ˜¯ï¼Œæ‰“ç®—ç”±å…¶ä»–ç¨‹åºä½¿ç”¨çš„åº“åº”è¯¥ç‰¹åˆ«æ³¨æ„å®Œå…¨ç¡®å®šæ€§ï¼Œ
è€Œä¸æ˜¯æ‰§è¡Œâ€œinit magicâ€&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Foo&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// ...
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">_defaultFoo&lt;/span> &lt;span class="nx">Foo&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">init&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">_defaultFoo&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">Foo&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="c1">// ...
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">var&lt;/span> &lt;span class="nx">_defaultFoo&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">Foo&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="c1">// ...
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="c1">// or, ä¸ºäº†æ›´å¥½çš„å¯æµ‹è¯•æ€§:
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">var&lt;/span> &lt;span class="nx">_defaultFoo&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">defaultFoo&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">defaultFoo&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="nx">Foo&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">Foo&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="c1">// ...
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Config&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// ...
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">_config&lt;/span> &lt;span class="nx">Config&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">init&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Bad: åŸºäºå½“å‰ç›®å½•
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">cwd&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">_&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Getwd&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="c1">// Bad: I/O
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">raw&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">_&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">ioutil&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ReadFile&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nx">path&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">cwd&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;config&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;config.yaml&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="nx">yaml&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unmarshal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">raw&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">_config&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Config&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// ...
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">loadConfig&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="nx">Config&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">cwd&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Getwd&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="c1">// handle err
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">raw&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">ioutil&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ReadFile&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nx">path&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Join&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">cwd&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;config&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;config.yaml&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="c1">// handle err
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">var&lt;/span> &lt;span class="nx">config&lt;/span> &lt;span class="nx">Config&lt;/span>
&lt;span class="nx">yaml&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unmarshal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">raw&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">config&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">config&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;p>è€ƒè™‘åˆ°ä¸Šè¿°æƒ…å†µï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œ&lt;code>init()&lt;/code>å¯èƒ½æ›´å¯å–æˆ–æ˜¯å¿…è¦çš„ï¼Œå¯èƒ½åŒ…æ‹¬ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>ä¸èƒ½è¡¨ç¤ºä¸ºå•ä¸ªèµ‹å€¼çš„å¤æ‚è¡¨è¾¾å¼ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å¯æ’å…¥çš„é’©å­ï¼Œå¦‚&lt;code>database/sql&lt;/code>ã€ç¼–ç ç±»å‹æ³¨å†Œè¡¨ç­‰ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å¯¹&lt;a href="https://cloud.google.com/functions/docs/bestpractices/tips#use_global_variables_to_reuse_objects_in_future_invocations">Google Cloud Functions&lt;/a>å’Œå…¶ä»–å½¢å¼çš„ç¡®å®šæ€§é¢„è®¡ç®—çš„ä¼˜åŒ–ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="è¿½åŠ æ—¶ä¼˜å…ˆæŒ‡å®šåˆ‡ç‰‡å®¹é‡">è¿½åŠ æ—¶ä¼˜å…ˆæŒ‡å®šåˆ‡ç‰‡å®¹é‡&lt;/h3>
&lt;p>è¿½åŠ æ—¶ä¼˜å…ˆæŒ‡å®šåˆ‡ç‰‡å®¹é‡&lt;/p>
&lt;p>åœ¨å°½å¯èƒ½çš„æƒ…å†µä¸‹ï¼Œåœ¨åˆå§‹åŒ–è¦è¿½åŠ çš„åˆ‡ç‰‡æ—¶ä¸º&lt;code>make()&lt;/code>æä¾›ä¸€ä¸ªå®¹é‡å€¼ã€‚&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="k">for&lt;/span> &lt;span class="nx">n&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">n&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nx">b&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">N&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">n&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">data&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">k&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">k&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nx">size&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">k&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">data&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">data&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">k&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="k">for&lt;/span> &lt;span class="nx">n&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">n&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nx">b&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">N&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">n&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">data&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">size&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">k&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">k&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nx">size&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">k&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">data&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">data&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">k&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">BenchmarkBad-4 100000000 2.48s
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">BenchmarkGood-4 100000000 0.21s
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;h2 id="æ€§èƒ½">æ€§èƒ½&lt;/h2>
&lt;p>æ€§èƒ½æ–¹é¢çš„ç‰¹å®šå‡†åˆ™åªé€‚ç”¨äºé«˜é¢‘åœºæ™¯ã€‚&lt;/p>
&lt;h3 id="ä¼˜å…ˆä½¿ç”¨-strconv-è€Œä¸æ˜¯-fmt">ä¼˜å…ˆä½¿ç”¨ strconv è€Œä¸æ˜¯ fmt&lt;/h3>
&lt;p>å°†åŸè¯­è½¬æ¢ä¸ºå­—ç¬¦ä¸²æˆ–ä»å­—ç¬¦ä¸²è½¬æ¢æ—¶ï¼Œ&lt;code>strconv&lt;/code>é€Ÿåº¦æ¯”&lt;code>fmt&lt;/code>å¿«ã€‚&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nx">b&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">N&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">s&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">rand&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Int&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nx">b&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">N&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">s&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">strconv&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Itoa&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">rand&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Int&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">BenchmarkFmtSprint-4 143 ns/op 2 allocs/op
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">BenchmarkStrconv-4 64.2 ns/op 1 allocs/op
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;h3 id="é¿å…å­—ç¬¦ä¸²åˆ°å­—èŠ‚çš„è½¬æ¢">é¿å…å­—ç¬¦ä¸²åˆ°å­—èŠ‚çš„è½¬æ¢&lt;/h3>
&lt;p>ä¸è¦åå¤ä»å›ºå®šå­—ç¬¦ä¸²åˆ›å»ºå­—èŠ‚ sliceã€‚ç›¸åï¼Œè¯·æ‰§è¡Œä¸€æ¬¡è½¬æ¢å¹¶æ•è·ç»“æœã€‚&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nx">b&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">N&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">w&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Write&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="nb">byte&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Hello world&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">data&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nb">byte&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Hello world&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nx">b&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">N&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">w&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">data&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/tr>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">BenchmarkBad-4 50000000 22.2 ns/op
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">BenchmarkGood-4 500000000 3.25 ns/op
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;h3 id="æŒ‡å®šå®¹å™¨å®¹é‡">æŒ‡å®šå®¹å™¨å®¹é‡&lt;/h3>
&lt;p>å°½å¯èƒ½æŒ‡å®šå®¹å™¨å®¹é‡ï¼Œä»¥ä¾¿ä¸ºå®¹å™¨é¢„å…ˆåˆ†é…å†…å­˜ã€‚è¿™å°†åœ¨æ·»åŠ å…ƒç´ æ—¶æœ€å°åŒ–åç»­åˆ†é…ï¼ˆé€šè¿‡å¤åˆ¶å’Œè°ƒæ•´å®¹å™¨å¤§å°ï¼‰ã€‚&lt;/p>
&lt;h4 id="æŒ‡å®šmapå®¹é‡æç¤º">æŒ‡å®šMapå®¹é‡æç¤º&lt;/h4>
&lt;p>åœ¨å°½å¯èƒ½çš„æƒ…å†µä¸‹ï¼Œåœ¨ä½¿ç”¨ &lt;code>make()&lt;/code> åˆå§‹åŒ–çš„æ—¶å€™æä¾›å®¹é‡ä¿¡æ¯&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">T1&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="nx">T2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">hint&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å‘&lt;code>make()&lt;/code>æä¾›å®¹é‡æç¤ºä¼šåœ¨åˆå§‹åŒ–æ—¶å°è¯•è°ƒæ•´mapçš„å¤§å°ï¼Œè¿™å°†å‡å°‘åœ¨å°†å…ƒç´ æ·»åŠ åˆ°mapæ—¶ä¸ºmapé‡æ–°åˆ†é…å†…å­˜ã€‚&lt;/p>
&lt;p>æ³¨æ„ï¼Œä¸slicesä¸åŒã€‚map capacityæç¤ºå¹¶ä¸ä¿è¯å®Œå…¨çš„æŠ¢å å¼åˆ†é…ï¼Œè€Œæ˜¯ç”¨äºä¼°è®¡æ‰€éœ€çš„hashmap bucketçš„æ•°é‡ã€‚
å› æ­¤ï¼Œåœ¨å°†å…ƒç´ æ·»åŠ åˆ°mapæ—¶ï¼Œç”šè‡³åœ¨æŒ‡å®šmapå®¹é‡æ—¶ï¼Œä»å¯èƒ½å‘ç”Ÿåˆ†é…ã€‚&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">m&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">FileInfo&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">files&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">_&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">ioutil&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ReadDir&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;./files&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">f&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">files&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">m&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">f&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Name&lt;/span>&lt;span class="p">()]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">f&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">
&lt;span class="nx">files&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">_&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">ioutil&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ReadDir&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;./files&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">m&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">FileInfo&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">files&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">f&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">files&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">m&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">f&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Name&lt;/span>&lt;span class="p">()]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">f&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;tr>&lt;td>
&lt;p>&lt;code>m&lt;/code> æ˜¯åœ¨æ²¡æœ‰å¤§å°æç¤ºçš„æƒ…å†µä¸‹åˆ›å»ºçš„ï¼› åœ¨è¿è¡Œæ—¶å¯èƒ½ä¼šæœ‰æ›´å¤šåˆ†é…ã€‚&lt;/p>
&lt;/td>&lt;td>
&lt;p>&lt;code>m&lt;/code> æ˜¯æœ‰å¤§å°æç¤ºåˆ›å»ºçš„ï¼›åœ¨è¿è¡Œæ—¶å¯èƒ½ä¼šæœ‰æ›´å°‘çš„åˆ†é…ã€‚&lt;/p>
&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;h4 id="æŒ‡å®šåˆ‡ç‰‡å®¹é‡">æŒ‡å®šåˆ‡ç‰‡å®¹é‡&lt;/h4>
&lt;p>åœ¨å°½å¯èƒ½çš„æƒ…å†µä¸‹ï¼Œåœ¨ä½¿ç”¨&lt;code>make()&lt;/code>åˆå§‹åŒ–åˆ‡ç‰‡æ—¶æä¾›å®¹é‡ä¿¡æ¯ï¼Œç‰¹åˆ«æ˜¯åœ¨è¿½åŠ åˆ‡ç‰‡æ—¶ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="nx">T&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">length&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">capacity&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¸mapsä¸åŒï¼Œslice capacityä¸æ˜¯ä¸€ä¸ªæç¤ºï¼šç¼–è¯‘å™¨å°†ä¸ºæä¾›ç»™&lt;code>make()&lt;/code>çš„sliceçš„å®¹é‡åˆ†é…è¶³å¤Ÿçš„å†…å­˜ï¼Œ
è¿™æ„å‘³ç€åç»­çš„append()`æ“ä½œå°†å¯¼è‡´é›¶åˆ†é…ï¼ˆç›´åˆ°sliceçš„é•¿åº¦ä¸å®¹é‡åŒ¹é…ï¼Œåœ¨æ­¤ä¹‹åï¼Œä»»ä½•appendéƒ½å¯èƒ½è°ƒæ•´å¤§å°ä»¥å®¹çº³å…¶ä»–å…ƒç´ ï¼‰ã€‚&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="k">for&lt;/span> &lt;span class="nx">n&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">n&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nx">b&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">N&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">n&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">data&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">k&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">k&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nx">size&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">k&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">data&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">data&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">k&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="k">for&lt;/span> &lt;span class="nx">n&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">n&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nx">b&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">N&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">n&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">data&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">size&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">k&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">k&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nx">size&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">k&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">data&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">data&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">k&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">BenchmarkBad-4 100000000 2.48s
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">BenchmarkGood-4 100000000 0.21s
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;h2 id="è§„èŒƒ">è§„èŒƒ&lt;/h2>
&lt;h3 id="ä¸€è‡´æ€§">ä¸€è‡´æ€§&lt;/h3>
&lt;p>æœ¬æ–‡ä¸­æ¦‚è¿°çš„ä¸€äº›æ ‡å‡†éƒ½æ˜¯å®¢è§‚æ€§çš„è¯„ä¼°ï¼Œæ˜¯æ ¹æ®åœºæ™¯ã€ä¸Šä¸‹æ–‡ã€æˆ–è€…ä¸»è§‚æ€§çš„åˆ¤æ–­ï¼›&lt;/p>
&lt;p>ä½†æ˜¯æœ€é‡è¦çš„æ˜¯ï¼Œ&lt;strong>ä¿æŒä¸€è‡´&lt;/strong>.&lt;/p>
&lt;p>ä¸€è‡´æ€§çš„ä»£ç æ›´å®¹æ˜“ç»´æŠ¤ã€æ˜¯æ›´åˆç†çš„ã€éœ€è¦æ›´å°‘çš„å­¦ä¹ æˆæœ¬ã€å¹¶ä¸”éšç€æ–°çš„çº¦å®šå‡ºç°æˆ–è€…å‡ºç°é”™è¯¯åæ›´å®¹æ˜“è¿ç§»ã€æ›´æ–°ã€ä¿®å¤ bug&lt;/p>
&lt;p>ç›¸åï¼Œåœ¨ä¸€ä¸ªä»£ç åº“ä¸­åŒ…å«å¤šä¸ªå®Œå…¨ä¸åŒæˆ–å†²çªçš„ä»£ç é£æ ¼ä¼šå¯¼è‡´ç»´æŠ¤æˆæœ¬å¼€é”€ã€ä¸ç¡®å®šæ€§å’Œè®¤çŸ¥åå·®ã€‚æ‰€æœ‰è¿™äº›éƒ½ä¼šç›´æ¥å¯¼è‡´é€Ÿåº¦é™ä½ã€ä»£ç å®¡æŸ¥ç—›è‹¦ã€è€Œä¸”å¢åŠ  bug æ•°é‡ã€‚&lt;/p>
&lt;p>å°†è¿™äº›æ ‡å‡†åº”ç”¨äºä»£ç åº“æ—¶ï¼Œå»ºè®®åœ¨ packageï¼ˆæˆ–æ›´å¤§ï¼‰çº§åˆ«è¿›è¡Œæ›´æ”¹ï¼Œå­åŒ…çº§åˆ«çš„åº”ç”¨ç¨‹åºé€šè¿‡å°†å¤šä¸ªæ ·å¼å¼•å…¥åˆ°åŒä¸€ä»£ç ä¸­ï¼Œè¿åäº†ä¸Šè¿°å…³æ³¨ç‚¹ã€‚&lt;/p>
&lt;h3 id="ç›¸ä¼¼çš„å£°æ˜æ”¾åœ¨ä¸€ç»„">ç›¸ä¼¼çš„å£°æ˜æ”¾åœ¨ä¸€ç»„&lt;/h3>
&lt;p>Go è¯­è¨€æ”¯æŒå°†ç›¸ä¼¼çš„å£°æ˜æ”¾åœ¨ä¸€ä¸ªç»„å†…ã€‚&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">import&lt;/span> &lt;span class="s">&amp;#34;a&amp;#34;&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="s">&amp;#34;b&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;a&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;b&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;p>è¿™åŒæ ·é€‚ç”¨äºå¸¸é‡ã€å˜é‡å’Œç±»å‹å£°æ˜ï¼š&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">
&lt;span class="kd">const&lt;/span> &lt;span class="nx">a&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;span class="kd">const&lt;/span> &lt;span class="nx">b&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">2&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">a&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">b&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">2&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">Area&lt;/span> &lt;span class="kt">float64&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">Volume&lt;/span> &lt;span class="kt">float64&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">const&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="nx">a&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;span class="nx">b&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">2&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="nx">a&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;span class="nx">b&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">2&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="nx">Area&lt;/span> &lt;span class="kt">float64&lt;/span>
&lt;span class="nx">Volume&lt;/span> &lt;span class="kt">float64&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;p>ä»…å°†ç›¸å…³çš„å£°æ˜æ”¾åœ¨ä¸€ç»„ã€‚ä¸è¦å°†ä¸ç›¸å…³çš„å£°æ˜æ”¾åœ¨ä¸€ç»„ã€‚&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Operation&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;span class="kd">const&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="nx">Add&lt;/span> &lt;span class="nx">Operation&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">iota&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;span class="nx">Subtract&lt;/span>
&lt;span class="nx">Multiply&lt;/span>
&lt;span class="nx">ENV_VAR&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">&amp;#34;MY_ENV&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Operation&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;span class="kd">const&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="nx">Add&lt;/span> &lt;span class="nx">Operation&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">iota&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;span class="nx">Subtract&lt;/span>
&lt;span class="nx">Multiply&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">const&lt;/span> &lt;span class="nx">ENV_VAR&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">&amp;#34;MY_ENV&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;p>åˆ†ç»„ä½¿ç”¨çš„ä½ç½®æ²¡æœ‰é™åˆ¶ï¼Œä¾‹å¦‚ï¼šä½ å¯ä»¥åœ¨å‡½æ•°å†…éƒ¨ä½¿ç”¨å®ƒä»¬ï¼š&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">f&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">red&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">color&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mh">0xff0000&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">green&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">color&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mh">0x00ff00&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">blue&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">color&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mh">0x0000ff&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">f&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="nx">red&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">color&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mh">0xff0000&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">green&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">color&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mh">0x00ff00&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">blue&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">color&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mh">0x0000ff&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;h3 id="import-åˆ†ç»„">import åˆ†ç»„&lt;/h3>
&lt;p>å¯¼å…¥åº”è¯¥åˆ†ä¸ºä¸¤ç»„ï¼š&lt;/p>
&lt;ul>
&lt;li>æ ‡å‡†åº“&lt;/li>
&lt;li>å½“å‰é¡¹ç›®å†…çš„å¼•ç”¨&lt;/li>
&lt;li>ç¬¬ä¸‰æ–¹åº“&lt;/li>
&lt;/ul>
&lt;p>é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™æ˜¯ goimports åº”ç”¨çš„åˆ†ç»„ã€‚&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;os&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;go.uber.org/atomic&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;golang.org/x/sync/errgroup&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;currentProject/model&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;currentProject/handler&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;os&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;currentProject/model&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;currentProject/handler&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;go.uber.org/atomic&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;golang.org/x/sync/errgroup&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;h3 id="åŒ…å">åŒ…å&lt;/h3>
&lt;p>å½“å‘½ååŒ…æ—¶ï¼Œè¯·æŒ‰ä¸‹é¢è§„åˆ™é€‰æ‹©ä¸€ä¸ªåç§°ï¼š&lt;/p>
&lt;ul>
&lt;li>å…¨éƒ¨å°å†™ã€‚æ²¡æœ‰å¤§å†™æˆ–ä¸‹åˆ’çº¿ã€‚&lt;/li>
&lt;li>å¤§å¤šæ•°ä½¿ç”¨å‘½åå¯¼å…¥çš„æƒ…å†µä¸‹ï¼Œä¸éœ€è¦é‡å‘½åã€‚&lt;/li>
&lt;li>ç®€çŸ­è€Œç®€æ´ã€‚è¯·è®°ä½ï¼Œåœ¨æ¯ä¸ªä½¿ç”¨çš„åœ°æ–¹éƒ½å®Œæ•´æ ‡è¯†äº†è¯¥åç§°ã€‚&lt;/li>
&lt;li>ä¸ç”¨å¤æ•°ã€‚ä¾‹å¦‚&lt;code>net/url&lt;/code>ï¼Œè€Œä¸æ˜¯&lt;code>net/urls&lt;/code>ã€‚&lt;/li>
&lt;li>ä¸è¦ç”¨â€œcommonâ€ï¼Œâ€œutilâ€ï¼Œâ€œsharedâ€æˆ–â€œlibâ€ã€‚è¿™äº›æ˜¯ä¸å¥½çš„ï¼Œä¿¡æ¯é‡ä¸è¶³çš„åç§°ã€‚(åº”è¯¥ä½¿ç”¨æ›´å…·ä½“çš„å‘½åæ–¹å¼ å¦‚&lt;code>httputil&lt;/code>, &lt;code>mathutil&lt;/code> ç­‰ã€‚)&lt;/li>
&lt;/ul>
&lt;p>å¦è¯·å‚é˜… &lt;a href="https://blog.golang.org/package-names">Package Names&lt;/a> å’Œ &lt;a href="https://rakyll.org/style-packages/">Go åŒ…æ ·å¼æŒ‡å—&lt;/a>.&lt;/p>
&lt;h3 id="å‡½æ•°å">å‡½æ•°å&lt;/h3>
&lt;p>æˆ‘ä»¬éµå¾ª Go ç¤¾åŒºå…³äºä½¿ç”¨ &lt;a href="https://golang.org/doc/effective_go.html#mixed-caps">MixedCaps ä½œä¸ºå‡½æ•°å&lt;/a> çš„çº¦å®šã€‚æœ‰ä¸€ä¸ªä¾‹å¤–ï¼Œä¸ºäº†å¯¹ç›¸å…³çš„æµ‹è¯•ç”¨ä¾‹è¿›è¡Œåˆ†ç»„ï¼Œå‡½æ•°åå¯èƒ½åŒ…å«ä¸‹åˆ’çº¿ï¼Œå¦‚ï¼š&lt;code>TestMyFunction_WhatIsBeingTested&lt;/code>.&lt;/p>
&lt;h3 id="å¯¼å…¥åˆ«å">å¯¼å…¥åˆ«å&lt;/h3>
&lt;p>å¦‚æœç¨‹åºåŒ…åç§°ä¸å¯¼å…¥è·¯å¾„çš„æœ€åä¸€ä¸ªå…ƒç´ ä¸åŒ¹é…ï¼Œåˆ™å¿…é¡»ä½¿ç”¨å¯¼å…¥åˆ«åã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;net/http&amp;#34;&lt;/span>
&lt;span class="nx">client&lt;/span> &lt;span class="s">&amp;#34;example.com/client-go&amp;#34;&lt;/span>
&lt;span class="nx">trace&lt;/span> &lt;span class="s">&amp;#34;example.com/trace/v2&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨æ‰€æœ‰å…¶ä»–æƒ…å†µä¸‹ï¼Œé™¤éå¯¼å…¥ä¹‹é—´æœ‰ç›´æ¥å†²çªï¼Œå¦åˆ™åº”é¿å…å¯¼å…¥åˆ«åã€‚&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;os&amp;#34;&lt;/span>
&lt;span class="nx">nettrace&lt;/span> &lt;span class="s">&amp;#34;golang.net/x/trace&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;os&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;runtime/trace&amp;#34;&lt;/span>
&lt;span class="nx">nettrace&lt;/span> &lt;span class="s">&amp;#34;golang.net/x/trace&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;h3 id="å‡½æ•°åˆ†ç»„ä¸é¡ºåº">å‡½æ•°åˆ†ç»„ä¸é¡ºåº&lt;/h3>
&lt;ul>
&lt;li>å‡½æ•°åº”æŒ‰ç²—ç•¥çš„è°ƒç”¨é¡ºåºæ’åºã€‚&lt;/li>
&lt;li>åŒä¸€æ–‡ä»¶ä¸­çš„å‡½æ•°åº”æŒ‰æ¥æ”¶è€…åˆ†ç»„ã€‚&lt;/li>
&lt;/ul>
&lt;p>å› æ­¤ï¼Œå¯¼å‡ºçš„å‡½æ•°åº”å…ˆå‡ºç°åœ¨æ–‡ä»¶ä¸­ï¼Œæ”¾åœ¨&lt;code>struct&lt;/code>, &lt;code>const&lt;/code>, &lt;code>var&lt;/code>å®šä¹‰çš„åé¢ã€‚&lt;/p>
&lt;p>åœ¨å®šä¹‰ç±»å‹ä¹‹åï¼Œä½†åœ¨æ¥æ”¶è€…çš„å…¶ä½™æ–¹æ³•ä¹‹å‰ï¼Œå¯èƒ½ä¼šå‡ºç°ä¸€ä¸ª &lt;code>newXYZ()&lt;/code>/&lt;code>NewXYZ()&lt;/code>&lt;/p>
&lt;p>ç”±äºå‡½æ•°æ˜¯æŒ‰æ¥æ”¶è€…åˆ†ç»„çš„ï¼Œå› æ­¤æ™®é€šå·¥å…·å‡½æ•°åº”åœ¨æ–‡ä»¶æœ«å°¾å‡ºç°ã€‚&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">something&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Cost&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nf">calcCost&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">weights&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">something&lt;/span> &lt;span class="kd">struct&lt;/span>&lt;span class="p">{&lt;/span> &lt;span class="o">...&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">calcCost&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">n&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">something&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Stop&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">newSomething&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">something&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">something&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">something&lt;/span> &lt;span class="kd">struct&lt;/span>&lt;span class="p">{&lt;/span> &lt;span class="o">...&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">newSomething&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">something&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">something&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">something&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Cost&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nf">calcCost&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">weights&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">something&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Stop&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">calcCost&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">n&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;h3 id="å‡å°‘åµŒå¥—">å‡å°‘åµŒå¥—&lt;/h3>
&lt;p>ä»£ç åº”é€šè¿‡å°½å¯èƒ½å…ˆå¤„ç†é”™è¯¯æƒ…å†µ/ç‰¹æ®Šæƒ…å†µå¹¶å°½æ—©è¿”å›æˆ–ç»§ç»­å¾ªç¯æ¥å‡å°‘åµŒå¥—ã€‚å‡å°‘åµŒå¥—å¤šä¸ªçº§åˆ«çš„ä»£ç çš„ä»£ç é‡ã€‚&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">data&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">F1&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">v&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">process&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">v&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Call&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">v&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Send&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Invalid v: %v&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">data&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">F1&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Invalid v: %v&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">continue&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">v&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">process&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">v&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Call&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">v&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Send&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;h3 id="ä¸å¿…è¦çš„-else">ä¸å¿…è¦çš„ else&lt;/h3>
&lt;p>å¦‚æœåœ¨ if çš„ä¸¤ä¸ªåˆ†æ”¯ä¸­éƒ½è®¾ç½®äº†å˜é‡ï¼Œåˆ™å¯ä»¥å°†å…¶æ›¿æ¢ä¸ºå•ä¸ª ifã€‚&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">var&lt;/span> &lt;span class="nx">a&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">b&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">a&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">100&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">a&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">10&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">a&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">10&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">b&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">a&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">100&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;h3 id="é¡¶å±‚å˜é‡å£°æ˜">é¡¶å±‚å˜é‡å£°æ˜&lt;/h3>
&lt;p>åœ¨é¡¶å±‚ï¼Œä½¿ç”¨æ ‡å‡†&lt;code>var&lt;/code>å…³é”®å­—ã€‚è¯·å‹¿æŒ‡å®šç±»å‹ï¼Œé™¤éå®ƒä¸è¡¨è¾¾å¼çš„ç±»å‹ä¸åŒã€‚&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">var&lt;/span> &lt;span class="nx">_s&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">F&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">F&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;A&amp;#34;&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">var&lt;/span> &lt;span class="nx">_s&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">F&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="c1">// ç”±äº F å·²ç»æ˜ç¡®äº†è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹ï¼Œå› æ­¤æˆ‘ä»¬æ²¡æœ‰å¿…è¦æ˜¾å¼æŒ‡å®š_s çš„ç±»å‹
&lt;/span>&lt;span class="c1">// è¿˜æ˜¯é‚£ç§ç±»å‹
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">F&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;A&amp;#34;&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;p>å¦‚æœè¡¨è¾¾å¼çš„ç±»å‹ä¸æ‰€éœ€çš„ç±»å‹ä¸å®Œå…¨åŒ¹é…ï¼Œè¯·æŒ‡å®šç±»å‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">myError&lt;/span> &lt;span class="kd">struct&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">myError&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Error&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;error&amp;#34;&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">F&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="nx">myError&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="nx">myError&lt;/span>&lt;span class="p">{}&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">_e&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">F&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="c1">// F è¿”å›ä¸€ä¸ª myError ç±»å‹çš„å®ä¾‹ï¼Œä½†æ˜¯æˆ‘ä»¬è¦ error ç±»å‹
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="å¯¹äºæœªå¯¼å‡ºçš„é¡¶å±‚å¸¸é‡å’Œå˜é‡ä½¿ç”¨_ä½œä¸ºå‰ç¼€">å¯¹äºæœªå¯¼å‡ºçš„é¡¶å±‚å¸¸é‡å’Œå˜é‡ï¼Œä½¿ç”¨_ä½œä¸ºå‰ç¼€&lt;/h3>
&lt;p>åœ¨æœªå¯¼å‡ºçš„é¡¶çº§&lt;code>vars&lt;/code>å’Œ&lt;code>consts&lt;/code>ï¼Œ å‰é¢åŠ ä¸Šå‰ç¼€_ï¼Œä»¥ä½¿å®ƒä»¬åœ¨ä½¿ç”¨æ—¶æ˜ç¡®è¡¨ç¤ºå®ƒä»¬æ˜¯å…¨å±€ç¬¦å·ã€‚&lt;/p>
&lt;p>ä¾‹å¤–ï¼šæœªå¯¼å‡ºçš„é”™è¯¯å€¼ï¼Œåº”ä»¥&lt;code>err&lt;/code>å¼€å¤´ã€‚&lt;/p>
&lt;p>åŸºæœ¬ä¾æ®ï¼šé¡¶çº§å˜é‡å’Œå¸¸é‡å…·æœ‰åŒ…èŒƒå›´ä½œç”¨åŸŸã€‚ä½¿ç”¨é€šç”¨åç§°å¯èƒ½å¾ˆå®¹æ˜“åœ¨å…¶ä»–æ–‡ä»¶ä¸­æ„å¤–ä½¿ç”¨é”™è¯¯çš„å€¼ã€‚&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// foo.go
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="kd">const&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="nx">defaultPort&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">8080&lt;/span>
&lt;span class="nx">defaultUser&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">&amp;#34;user&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="c1">// bar.go
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">Bar&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">defaultPort&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">9090&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Default port&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">defaultPort&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// We will not see a compile error if the first line of
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// Bar() is deleted.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// foo.go
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="kd">const&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="nx">_defaultPort&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">8080&lt;/span>
&lt;span class="nx">_defaultUser&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">&amp;#34;user&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;h3 id="ç»“æ„ä½“ä¸­çš„åµŒå…¥">ç»“æ„ä½“ä¸­çš„åµŒå…¥&lt;/h3>
&lt;p>åµŒå…¥å¼ç±»å‹ï¼ˆä¾‹å¦‚ mutexï¼‰åº”ä½äºç»“æ„ä½“å†…çš„å­—æ®µåˆ—è¡¨çš„é¡¶éƒ¨ï¼Œå¹¶ä¸”å¿…é¡»æœ‰ä¸€ä¸ªç©ºè¡Œå°†åµŒå…¥å¼å­—æ®µä¸å¸¸è§„å­—æ®µåˆ†éš”å¼€ã€‚&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Client&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">version&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Client&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Client&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Client&lt;/span>
&lt;span class="nx">version&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;p>å†…åµŒåº”è¯¥æä¾›åˆ‡å®çš„å¥½å¤„ï¼Œæ¯”å¦‚ä»¥è¯­ä¹‰ä¸Šåˆé€‚çš„æ–¹å¼æ·»åŠ æˆ–å¢å¼ºåŠŸèƒ½ã€‚
å®ƒåº”è¯¥åœ¨å¯¹ç”¨æˆ·ä¸åˆ©å½±å“çš„æƒ…å†µä¸‹å®Œæˆè¿™é¡¹å·¥ä½œï¼ˆå¦è¯·å‚è§ï¼š&lt;code>é¿å…åœ¨å…¬å…±ç»“æ„ä¸­åµŒå…¥ç±»å‹&lt;/code>&lt;a href="https://yusank.github.io/posts/go-standard/#avoid-embedding-types-in-public-structs">Avoid Embedding Types in Public Structs&lt;/a>ï¼‰ã€‚&lt;/p>
&lt;p>åµŒå…¥ &lt;strong>ä¸åº”è¯¥&lt;/strong>:&lt;/p>
&lt;ul>
&lt;li>çº¯ç²¹æ˜¯ä¸ºäº†ç¾è§‚æˆ–æ–¹ä¾¿ã€‚&lt;/li>
&lt;li>ä½¿å¤–éƒ¨ç±»å‹æ›´éš¾æ„é€ æˆ–ä½¿ç”¨ã€‚&lt;/li>
&lt;li>å½±å“å¤–éƒ¨ç±»å‹çš„é›¶å€¼ã€‚å¦‚æœå¤–éƒ¨ç±»å‹æœ‰ä¸€ä¸ªæœ‰ç”¨çš„é›¶å€¼ï¼Œåˆ™åœ¨åµŒå…¥å†…éƒ¨ç±»å‹ä¹‹ååº”è¯¥ä»ç„¶æœ‰ä¸€ä¸ªæœ‰ç”¨çš„é›¶å€¼ã€‚&lt;/li>
&lt;li>ä½œä¸ºåµŒå…¥å†…éƒ¨ç±»å‹çš„å‰¯ä½œç”¨ï¼Œä»å¤–éƒ¨ç±»å‹å…¬å¼€ä¸ç›¸å…³çš„å‡½æ•°æˆ–å­—æ®µã€‚&lt;/li>
&lt;li>å…¬å¼€æœªå¯¼å‡ºçš„ç±»å‹ã€‚&lt;/li>
&lt;li>å½±å“å¤–éƒ¨ç±»å‹çš„å¤åˆ¶å½¢å¼ã€‚&lt;/li>
&lt;li>æ›´æ”¹å¤–éƒ¨ç±»å‹çš„APIæˆ–ç±»å‹è¯­ä¹‰ã€‚&lt;/li>
&lt;li>åµŒå…¥å†…éƒ¨ç±»å‹çš„éè§„èŒƒå½¢å¼ã€‚&lt;/li>
&lt;li>å…¬å¼€å¤–éƒ¨ç±»å‹çš„å®ç°è¯¦ç»†ä¿¡æ¯ã€‚&lt;/li>
&lt;li>å…è®¸ç”¨æˆ·è§‚å¯Ÿæˆ–æ§åˆ¶ç±»å‹å†…éƒ¨ã€‚&lt;/li>
&lt;li>é€šè¿‡åŒ…è£…çš„æ–¹å¼æ”¹å˜å†…éƒ¨å‡½æ•°çš„ä¸€èˆ¬è¡Œä¸ºï¼Œè¿™ç§åŒ…è£…æ–¹å¼ä¼šç»™ç”¨æˆ·å¸¦æ¥ä¸€äº›æ„æ–™ä¹‹å¤–æƒ…å†µã€‚&lt;/li>
&lt;/ul>
&lt;p>ç®€å•åœ°è¯´ï¼Œæœ‰æ„è¯†åœ°å’Œæœ‰ç›®çš„åœ°åµŒå…¥ã€‚ä¸€ç§å¾ˆå¥½çš„æµ‹è¯•ä½“éªŒæ˜¯ï¼Œ
&amp;quot;æ˜¯å¦æ‰€æœ‰è¿™äº›å¯¼å‡ºçš„å†…éƒ¨æ–¹æ³•/å­—æ®µéƒ½å°†ç›´æ¥æ·»åŠ åˆ°å¤–éƒ¨ç±»å‹&amp;quot;
å¦‚æœç­”æ¡ˆæ˜¯&lt;code>some&lt;/code>æˆ–&lt;code>no&lt;/code>ï¼Œä¸è¦åµŒå…¥å†…éƒ¨ç±»å‹-è€Œæ˜¯ä½¿ç”¨å­—æ®µã€‚&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">A&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Bad: A.Lock() and A.Unlock() ç°åœ¨å¯ç”¨
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// ä¸æä¾›ä»»ä½•åŠŸèƒ½æ€§å¥½å¤„ï¼Œå¹¶å…è®¸ç”¨æˆ·æ§åˆ¶æœ‰å…³Açš„å†…éƒ¨ç»†èŠ‚ã€‚
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">sync&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Mutex&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">countingWriteCloser&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Good: Write() åœ¨å¤–å±‚æä¾›ç”¨äºç‰¹å®šç›®çš„ï¼Œ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// å¹¶ä¸”å§”æ‰˜å·¥ä½œåˆ°å†…éƒ¨ç±»å‹çš„Write()ä¸­ã€‚
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">io&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">WriteCloser&lt;/span>
&lt;span class="nx">count&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">w&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">countingWriteCloser&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">bs&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">w&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">count&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">bs&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">w&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">WriteCloser&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">bs&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Book&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Bad: æŒ‡é’ˆæ›´æ”¹é›¶å€¼çš„æœ‰ç”¨æ€§
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">io&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ReadWriter&lt;/span>
&lt;span class="c1">// other fields
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="c1">// later
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">var&lt;/span> &lt;span class="nx">b&lt;/span> &lt;span class="nx">Book&lt;/span>
&lt;span class="nx">b&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Read&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// panic: nil pointer
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">b&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">String&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="c1">// panic: nil pointer
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">b&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// panic: nil pointer
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Book&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Good: æœ‰ç”¨çš„é›¶å€¼
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">bytes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Buffer&lt;/span>
&lt;span class="c1">// other fields
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="c1">// later
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">var&lt;/span> &lt;span class="nx">b&lt;/span> &lt;span class="nx">Book&lt;/span>
&lt;span class="nx">b&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Read&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// ok
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">b&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">String&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="c1">// ok
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">b&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// ok
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Client&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">sync&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Mutex&lt;/span>
&lt;span class="nx">sync&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">WaitGroup&lt;/span>
&lt;span class="nx">bytes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Buffer&lt;/span>
&lt;span class="nx">url&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">URL&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Client&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">mtx&lt;/span> &lt;span class="nx">sync&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Mutex&lt;/span>
&lt;span class="nx">wg&lt;/span> &lt;span class="nx">sync&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">WaitGroup&lt;/span>
&lt;span class="nx">buf&lt;/span> &lt;span class="nx">bytes&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Buffer&lt;/span>
&lt;span class="nx">url&lt;/span> &lt;span class="nx">url&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">URL&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;h3 id="ä½¿ç”¨å­—æ®µååˆå§‹åŒ–ç»“æ„ä½“">ä½¿ç”¨å­—æ®µååˆå§‹åŒ–ç»“æ„ä½“&lt;/h3>
&lt;p>åˆå§‹åŒ–ç»“æ„ä½“æ—¶ï¼Œåº”è¯¥æŒ‡å®šå­—æ®µåç§°ã€‚ç°åœ¨ç”± &lt;a href="https://golang.org/cmd/vet/">&lt;code>go vet&lt;/code>&lt;/a> å¼ºåˆ¶æ‰§è¡Œã€‚&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">k&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">User&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="s">&amp;#34;John&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;Doe&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">k&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">User&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">FirstName&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;John&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">LastName&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;Doe&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Admin&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;p>ä¾‹å¤–ï¼šå¦‚æœæœ‰ 3 ä¸ªæˆ–æ›´å°‘çš„å­—æ®µï¼Œåˆ™å¯ä»¥åœ¨æµ‹è¯•è¡¨ä¸­çœç•¥å­—æ®µåç§°ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">tests&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kd">struct&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">op&lt;/span> &lt;span class="nx">Operation&lt;/span>
&lt;span class="nx">want&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="p">}{&lt;/span>
&lt;span class="p">{&lt;/span>&lt;span class="nx">Add&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;add&amp;#34;&lt;/span>&lt;span class="p">},&lt;/span>
&lt;span class="p">{&lt;/span>&lt;span class="nx">Subtract&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;subtract&amp;#34;&lt;/span>&lt;span class="p">},&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="æœ¬åœ°å˜é‡å£°æ˜">æœ¬åœ°å˜é‡å£°æ˜&lt;/h3>
&lt;p>å¦‚æœå°†å˜é‡æ˜ç¡®è®¾ç½®ä¸ºæŸä¸ªå€¼ï¼Œåˆ™åº”ä½¿ç”¨çŸ­å˜é‡å£°æ˜å½¢å¼ (&lt;code>:=&lt;/code>)ã€‚&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">var&lt;/span> &lt;span class="nx">s&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">&amp;#34;foo&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">s&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="s">&amp;#34;foo&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;p>ä½†æ˜¯ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œ&lt;code>var&lt;/code> ä½¿ç”¨å…³é”®å­—æ—¶é»˜è®¤å€¼ä¼šæ›´æ¸…æ™°ã€‚ä¾‹å¦‚ï¼Œå£°æ˜ç©ºåˆ‡ç‰‡ã€‚&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">f&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">list&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">filtered&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">list&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">v&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="mi">10&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">filtered&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">filtered&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">f&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">list&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">filtered&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">int&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">list&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">v&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="mi">10&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">filtered&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">filtered&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;h3 id="nil-æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„-slice">nil æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ slice&lt;/h3>
&lt;p>&lt;code>nil&lt;/code> æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„é•¿åº¦ä¸º 0 çš„ sliceï¼Œè¿™æ„å‘³ç€ï¼Œ&lt;/p>
&lt;ul>
&lt;li>
&lt;p>æ‚¨ä¸åº”æ˜ç¡®è¿”å›é•¿åº¦ä¸ºé›¶çš„åˆ‡ç‰‡ã€‚åº”è¯¥è¿”å›&lt;code>nil&lt;/code> æ¥ä»£æ›¿ã€‚&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="k">if&lt;/span> &lt;span class="nx">x&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="k">if&lt;/span> &lt;span class="nx">x&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;/li>
&lt;li>
&lt;p>è¦æ£€æŸ¥åˆ‡ç‰‡æ˜¯å¦ä¸ºç©ºï¼Œè¯·å§‹ç»ˆä½¿ç”¨&lt;code>len(s) == 0&lt;/code>ã€‚è€Œé &lt;code>nil&lt;/code>ã€‚&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">isEmpty&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">bool&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">s&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">isEmpty&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">bool&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;/li>
&lt;li>
&lt;p>é›¶å€¼åˆ‡ç‰‡ï¼ˆç”¨&lt;code>var&lt;/code>å£°æ˜çš„åˆ‡ç‰‡ï¼‰å¯ç«‹å³ä½¿ç”¨ï¼Œæ— éœ€è°ƒç”¨&lt;code>make()&lt;/code>åˆ›å»ºã€‚&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">nums&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="c1">// or, nums := make([]int)
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">add1&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">nums&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">nums&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">add2&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">nums&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">nums&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">var&lt;/span> &lt;span class="nx">nums&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">int&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">add1&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">nums&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">nums&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">add2&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">nums&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">nums&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;/li>
&lt;/ul>
&lt;p>è®°ä½ï¼Œè™½ç„¶nilåˆ‡ç‰‡æ˜¯æœ‰æ•ˆçš„åˆ‡ç‰‡ï¼Œä½†å®ƒä¸ç­‰äºé•¿åº¦ä¸º0çš„åˆ‡ç‰‡ï¼ˆä¸€ä¸ªä¸ºnilï¼Œå¦ä¸€ä¸ªä¸æ˜¯ï¼‰ï¼Œå¹¶ä¸”åœ¨ä¸åŒçš„æƒ…å†µä¸‹ï¼ˆä¾‹å¦‚åºåˆ—åŒ–ï¼‰ï¼Œè¿™ä¸¤ä¸ªåˆ‡ç‰‡çš„å¤„ç†æ–¹å¼å¯èƒ½ä¸åŒã€‚&lt;/p>
&lt;h3 id="ç¼©å°å˜é‡ä½œç”¨åŸŸ">ç¼©å°å˜é‡ä½œç”¨åŸŸ&lt;/h3>
&lt;p>å¦‚æœæœ‰å¯èƒ½ï¼Œå°½é‡ç¼©å°å˜é‡ä½œç”¨èŒƒå›´ã€‚é™¤éå®ƒä¸ &lt;a href="https://yusank.github.io/posts/go-standard/#%E5%87%8F%E5%B0%91%E5%B5%8C%E5%A5%97">å‡å°‘åµŒå¥—&lt;/a>çš„è§„åˆ™å†²çªã€‚&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">ioutil&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WriteFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">data&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mo">0644&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">ioutil&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WriteFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">data&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mo">0644&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;p>å¦‚æœéœ€è¦åœ¨ if ä¹‹å¤–ä½¿ç”¨å‡½æ•°è°ƒç”¨çš„ç»“æœï¼Œåˆ™ä¸åº”å°è¯•ç¼©å°èŒƒå›´ã€‚&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="k">if&lt;/span> &lt;span class="nx">data&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">ioutil&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ReadFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">cfg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Decode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">data&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">cfg&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">data&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">ioutil&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ReadFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">cfg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Decode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">data&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">cfg&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;h3 id="é¿å…å‚æ•°è¯­ä¹‰ä¸æ˜ç¡®avoid-naked-parameters">é¿å…å‚æ•°è¯­ä¹‰ä¸æ˜ç¡®(Avoid Naked Parameters)&lt;/h3>
&lt;p>å‡½æ•°è°ƒç”¨ä¸­çš„&lt;code>æ„ä¹‰ä¸æ˜ç¡®çš„å‚æ•°&lt;/code>å¯èƒ½ä¼šæŸå®³å¯è¯»æ€§ã€‚å½“å‚æ•°åç§°çš„å«ä¹‰ä¸æ˜æ˜¾æ—¶ï¼Œè¯·ä¸ºå‚æ•°æ·»åŠ  C æ ·å¼æ³¨é‡Š (&lt;code>/* ... */&lt;/code>)&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// func printInfo(name string, isLocal, done bool)
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="nf">printInfo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;foo&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// func printInfo(name string, isLocal, done bool)
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="nf">printInfo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;foo&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">true&lt;/span> &lt;span class="cm">/* isLocal */&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">true&lt;/span> &lt;span class="cm">/* done */&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;p>å¯¹äºä¸Šé¢çš„ç¤ºä¾‹ä»£ç ï¼Œè¿˜æœ‰ä¸€ç§æ›´å¥½çš„å¤„ç†æ–¹å¼æ˜¯å°†ä¸Šé¢çš„ &lt;code>bool&lt;/code> ç±»å‹æ¢æˆè‡ªå®šä¹‰ç±»å‹ã€‚å°†æ¥ï¼Œè¯¥å‚æ•°å¯ä»¥æ”¯æŒä¸ä»…ä»…å±€é™äºä¸¤ä¸ªçŠ¶æ€ï¼ˆtrue/falseï¼‰ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Region&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;span class="kd">const&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="nx">UnknownRegion&lt;/span> &lt;span class="nx">Region&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">iota&lt;/span>
&lt;span class="nx">Local&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">Status&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;span class="kd">const&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="nx">StatusReady&lt;/span> &lt;span class="nx">Status&lt;/span>&lt;span class="p">=&lt;/span> &lt;span class="kc">iota&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;span class="nx">StatusDone&lt;/span>
&lt;span class="c1">// Maybe we will have a StatusInProgress in the future.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">printInfo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">name&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">region&lt;/span> &lt;span class="nx">Region&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">status&lt;/span> &lt;span class="nx">Status&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="ä½¿ç”¨åŸå§‹å­—ç¬¦ä¸²å­—é¢å€¼é¿å…è½¬ä¹‰">ä½¿ç”¨åŸå§‹å­—ç¬¦ä¸²å­—é¢å€¼ï¼Œé¿å…è½¬ä¹‰&lt;/h3>
&lt;p>Go æ”¯æŒä½¿ç”¨ &lt;a href="https://golang.org/ref/spec#raw_string_lit">åŸå§‹å­—ç¬¦ä¸²å­—é¢å€¼&lt;/a>ï¼Œä¹Ÿå°±æ˜¯ &amp;quot; ` &amp;quot; æ¥è¡¨ç¤ºåŸç”Ÿå­—ç¬¦ä¸²ï¼Œåœ¨éœ€è¦è½¬ä¹‰çš„åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬åº”è¯¥å°½é‡ä½¿ç”¨è¿™ç§æ–¹æ¡ˆæ¥æ›¿æ¢ã€‚&lt;/p>
&lt;p>å¯ä»¥è·¨è¶Šå¤šè¡Œå¹¶åŒ…å«å¼•å·ã€‚ä½¿ç”¨è¿™äº›å­—ç¬¦ä¸²å¯ä»¥é¿å…æ›´éš¾é˜…è¯»çš„æ‰‹å·¥è½¬ä¹‰çš„å­—ç¬¦ä¸²ã€‚&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">wantError&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="s">&amp;#34;unknown name:\&amp;#34;test\&amp;#34;&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">wantError&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="s">`unknown error:&amp;#34;test&amp;#34;`&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;h3 id="åˆå§‹åŒ–-struct-å¼•ç”¨">åˆå§‹åŒ– Struct å¼•ç”¨&lt;/h3>
&lt;p>åœ¨åˆå§‹åŒ–ç»“æ„å¼•ç”¨æ—¶ï¼Œè¯·ä½¿ç”¨&lt;code>&amp;amp;T{}&lt;/code>ä»£æ›¿&lt;code>new(T)&lt;/code>ï¼Œä»¥ä½¿å…¶ä¸ç»“æ„ä½“åˆå§‹åŒ–ä¸€è‡´ã€‚&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">sval&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">T&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">Name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;foo&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="c1">// inconsistent
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">sptr&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">T&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">sptr&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Name&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">&amp;#34;bar&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">sval&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">T&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">Name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;foo&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="nx">sptr&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">T&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">Name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;bar&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;h3 id="åˆå§‹åŒ–-maps">åˆå§‹åŒ– Maps&lt;/h3>
&lt;p>å¯¹äºç©º map è¯·ä½¿ç”¨ &lt;code>make(..)&lt;/code> åˆå§‹åŒ–ï¼Œ å¹¶ä¸” map æ˜¯é€šè¿‡ç¼–ç¨‹æ–¹å¼å¡«å……çš„ã€‚
è¿™ä½¿å¾— map åˆå§‹åŒ–åœ¨è¡¨ç°ä¸Šä¸åŒäºå£°æ˜ï¼Œå¹¶ä¸”å®ƒè¿˜å¯ä»¥æ–¹ä¾¿åœ°åœ¨ make åæ·»åŠ å¤§å°æç¤ºã€‚&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">var&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="c1">// m1 è¯»å†™å®‰å…¨;
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// m2 åœ¨å†™å…¥æ—¶ä¼š panic
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">m1&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">T1&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="nx">T2&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="nx">m2&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">T1&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="nx">T2&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">var&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="c1">// m1 è¯»å†™å®‰å…¨;
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// m2 åœ¨å†™å…¥æ—¶ä¼š panic
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">m1&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">T1&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="nx">T2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">m2&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">T1&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="nx">T2&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;tr>&lt;td>
&lt;p>å£°æ˜å’Œåˆå§‹åŒ–çœ‹èµ·æ¥éå¸¸ç›¸ä¼¼çš„ã€‚&lt;/p>
&lt;/td>&lt;td>
&lt;p>å£°æ˜å’Œåˆå§‹åŒ–çœ‹èµ·æ¥å·®åˆ«éå¸¸å¤§ã€‚&lt;/p>
&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;p>åœ¨å°½å¯èƒ½çš„æƒ…å†µä¸‹ï¼Œè¯·åœ¨åˆå§‹åŒ–æ—¶æä¾› map å®¹é‡å¤§å°ï¼Œè¯¦ç»†è¯·çœ‹ &lt;a href="https://yusank.github.io/posts/go-standard/#%E6%8C%87%E5%AE%9AMap%E5%AE%B9%E9%87%8F%E6%8F%90%E7%A4%BA">æŒ‡å®šMapå®¹é‡æç¤º&lt;/a>ã€‚&lt;/p>
&lt;p>å¦å¤–ï¼Œå¦‚æœ map åŒ…å«å›ºå®šçš„å…ƒç´ åˆ—è¡¨ï¼Œåˆ™ä½¿ç”¨ map literals(map åˆå§‹åŒ–åˆ—è¡¨) åˆå§‹åŒ–æ˜ å°„ã€‚&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">m&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">T1&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="nx">T2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">m&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">k1&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">v1&lt;/span>
&lt;span class="nx">m&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">k2&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">v2&lt;/span>
&lt;span class="nx">m&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">k3&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">v3&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">m&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">T1&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="nx">T2&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">k1&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">v1&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">k2&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">v2&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">k3&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">v3&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;p>åŸºæœ¬å‡†åˆ™æ˜¯ï¼šåœ¨åˆå§‹åŒ–æ—¶ä½¿ç”¨ map åˆå§‹åŒ–åˆ—è¡¨ æ¥æ·»åŠ ä¸€ç»„å›ºå®šçš„å…ƒç´ ã€‚å¦åˆ™ä½¿ç”¨ &lt;code>make&lt;/code> (å¦‚æœå¯ä»¥ï¼Œè¯·å°½é‡æŒ‡å®š map å®¹é‡)ã€‚&lt;/p>
&lt;h2 id="ç¼–ç¨‹æ¨¡å¼">ç¼–ç¨‹æ¨¡å¼&lt;/h2>
&lt;h3 id="è¡¨é©±åŠ¨æµ‹è¯•">è¡¨é©±åŠ¨æµ‹è¯•&lt;/h3>
&lt;p>å½“æµ‹è¯•é€»è¾‘æ˜¯é‡å¤çš„æ—¶å€™ï¼Œé€šè¿‡ &lt;a href="https://blog.golang.org/subtests">subtests&lt;/a> ä½¿ç”¨ table é©±åŠ¨çš„æ–¹å¼ç¼–å†™ case ä»£ç çœ‹ä¸Šå»ä¼šæ›´ç®€æ´ã€‚è€Œä¸”ç›®å‰ç¼–è¯‘å™¨å¯ä»¥é€šè¿‡å¿«æ·é”®å¿«é€Ÿç”Ÿæˆå•å…ƒæµ‹è¯•æ–¹æ³•ï¼Œå¯ä»¥å¸®åŠ©å…»æˆè‰¯å¥½ä¹ æƒ¯ã€‚&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// func TestSplitHostPort(t *testing.T)
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="nx">host&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">port&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SplitHostPort&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;192.0.2.0:8000&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">require&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NoError&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">assert&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Equal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;192.0.2.0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">host&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">assert&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Equal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;8000&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">port&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">host&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">port&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SplitHostPort&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;192.0.2.0:http&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">require&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NoError&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">assert&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Equal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;192.0.2.0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">host&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">assert&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Equal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;http&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">port&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">host&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">port&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SplitHostPort&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;:8000&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">require&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NoError&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">assert&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Equal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">host&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">assert&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Equal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;8000&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">port&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">host&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">port&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SplitHostPort&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;1:8&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">require&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NoError&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">assert&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Equal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">host&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">assert&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Equal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;8&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">port&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// func TestSplitHostPort(t *testing.T)
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="nx">tests&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kd">struct&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">give&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="nx">wantHost&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="nx">wantPort&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="p">}{&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="nx">give&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;192.0.2.0:8000&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">wantHost&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;192.0.2.0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">wantPort&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;8000&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">},&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="nx">give&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;192.0.2.0:http&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">wantHost&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;192.0.2.0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">wantPort&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;http&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">},&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="nx">give&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;:8000&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">wantHost&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">wantPort&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;8000&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">},&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="nx">give&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;1:8&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">wantHost&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">wantPort&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;8&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">},&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">tt&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">tests&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">t&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Run&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">tt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">give&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">testing&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">T&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">host&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">port&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SplitHostPort&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">tt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">give&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">require&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NoError&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">assert&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Equal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">tt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">wantHost&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">host&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">assert&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Equal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">tt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">wantPort&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">port&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">})&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;p>å¾ˆæ˜æ˜¾ï¼Œä½¿ç”¨ test table çš„æ–¹å¼åœ¨ä»£ç é€»è¾‘æ‰©å±•çš„æ—¶å€™ï¼Œæ¯”å¦‚æ–°å¢ test caseï¼Œéƒ½ä¼šæ˜¾å¾—æ›´åŠ çš„æ¸…æ™°ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬éµå¾ªè¿™æ ·çš„çº¦å®šï¼šå°†ç»“æ„ä½“åˆ‡ç‰‡ç§°ä¸º&lt;code>tests&lt;/code>ã€‚ æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹ç§°ä¸º&lt;code>tt&lt;/code>ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬é¼“åŠ±ä½¿ç”¨&lt;code>give&lt;/code>å’Œ&lt;code>want&lt;/code>å‰ç¼€è¯´æ˜æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹çš„è¾“å…¥å’Œè¾“å‡ºå€¼ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">tests&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kd">struct&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">give&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="nx">wantHost&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="nx">wantPort&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="p">}{&lt;/span>
&lt;span class="c1">// ...
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">tt&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">tests&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// ...
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="åŠŸèƒ½é€‰é¡¹">åŠŸèƒ½é€‰é¡¹&lt;/h3>
&lt;p>åŠŸèƒ½é€‰é¡¹æ˜¯ä¸€ç§æ¨¡å¼ï¼Œæ‚¨å¯ä»¥åœ¨å…¶ä¸­å£°æ˜ä¸€ä¸ªä¸é€æ˜ Option ç±»å‹ï¼Œè¯¥ç±»å‹åœ¨æŸäº›å†…éƒ¨ç»“æ„ä¸­è®°å½•ä¿¡æ¯ã€‚æ‚¨æ¥å—è¿™äº›é€‰é¡¹çš„å¯å˜ç¼–å·ï¼Œå¹¶æ ¹æ®å†…éƒ¨ç»“æ„ä¸Šçš„é€‰é¡¹è®°å½•çš„å…¨éƒ¨ä¿¡æ¯é‡‡å–è¡ŒåŠ¨ã€‚&lt;/p>
&lt;p>å°†æ­¤æ¨¡å¼ç”¨äºæ‚¨éœ€è¦æ‰©å±•çš„æ„é€ å‡½æ•°å’Œå…¶ä»–å…¬å…± API ä¸­çš„å¯é€‰å‚æ•°ï¼Œå°¤å…¶æ˜¯åœ¨è¿™äº›åŠŸèƒ½ä¸Šå·²ç»å…·æœ‰ä¸‰ä¸ªæˆ–æ›´å¤šå‚æ•°çš„æƒ…å†µä¸‹ã€‚&lt;/p>
&lt;table>
&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>
&lt;tbody>
&lt;tr>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// package db
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">Open&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nx">addr&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">cache&lt;/span> &lt;span class="kt">bool&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">logger&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">zap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Logger&lt;/span>
&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">Connection&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// ...
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// package db
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">Option&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// ...
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">WithCache&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="kt">bool&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">Option&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// ...
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">WithLogger&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">log&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">zap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Logger&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">Option&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// ...
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="c1">// Open creates a connection.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">Open&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nx">addr&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">opts&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="nx">Option&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">Connection&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// ...
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;tr>&lt;td>
&lt;p>å¿…é¡»å§‹ç»ˆæä¾›ç¼“å­˜å’Œè®°å½•å™¨å‚æ•°ï¼Œå³ä½¿ç”¨æˆ·å¸Œæœ›ä½¿ç”¨é»˜è®¤å€¼ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">addr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DefaultCache&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">zap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewNop&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">addr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">DefaultCache&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">log&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">addr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">false&lt;/span> &lt;span class="cm">/* cache */&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">zap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewNop&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">addr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">false&lt;/span> &lt;span class="cm">/* cache */&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">log&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;td>
&lt;p>åªæœ‰åœ¨éœ€è¦æ—¶æ‰æä¾›é€‰é¡¹ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">addr&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">addr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WithLogger&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">addr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WithCache&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Open&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nx">addr&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WithCache&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="nx">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WithLogger&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">log&lt;/span>&lt;span class="p">),&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/td>&lt;/tr>
&lt;/tbody>&lt;/table>
&lt;p>Our suggested way of implementing this pattern is with an &lt;code>Option&lt;/code> interface
that holds an unexported method, recording options on an unexported &lt;code>options&lt;/code>
struct.&lt;/p>
&lt;p>æˆ‘ä»¬å»ºè®®å®ç°æ­¤æ¨¡å¼çš„æ–¹æ³•æ˜¯ä½¿ç”¨ä¸€ä¸ª &lt;code>Option&lt;/code> æ¥å£ï¼Œè¯¥æ¥å£ä¿å­˜ä¸€ä¸ªæœªå¯¼å‡ºçš„æ–¹æ³•ï¼Œåœ¨ä¸€ä¸ªæœªå¯¼å‡ºçš„ &lt;code>options&lt;/code> ç»“æ„ä¸Šè®°å½•é€‰é¡¹ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">options&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">cache&lt;/span> &lt;span class="kt">bool&lt;/span>
&lt;span class="nx">logger&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">zap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Logger&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">Option&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">apply&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">options&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">cacheOption&lt;/span> &lt;span class="kt">bool&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="nx">cacheOption&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">apply&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">opts&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">options&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">opts&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">cache&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">bool&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">WithCache&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="kt">bool&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">Option&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nf">cacheOption&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">loggerOption&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">Log&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">zap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Logger&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">l&lt;/span> &lt;span class="nx">loggerOption&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">apply&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">opts&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">options&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">opts&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">logger&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">l&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Log&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">WithLogger&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">log&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">zap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Logger&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">Option&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">loggerOption&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">Log&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">log&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// Open creates a connection.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">Open&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nx">addr&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">opts&lt;/span> &lt;span class="o">...&lt;/span>&lt;span class="nx">Option&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">Connection&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">options&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">options&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">cache&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">defaultCache&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">logger&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">zap&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewNop&lt;/span>&lt;span class="p">(),&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">o&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">opts&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">o&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">apply&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">options&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// ...
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ³¨æ„: è¿˜æœ‰ä¸€ç§ä½¿ç”¨é—­åŒ…å®ç°è¿™ä¸ªæ¨¡å¼çš„æ–¹æ³•ï¼Œä½†æ˜¯æˆ‘ä»¬ç›¸ä¿¡ä¸Šé¢çš„æ¨¡å¼ä¸ºä½œè€…æä¾›äº†æ›´å¤šçš„çµæ´»æ€§ï¼Œå¹¶ä¸”æ›´å®¹æ˜“å¯¹ç”¨æˆ·è¿›è¡Œè°ƒè¯•å’Œæµ‹è¯•ã€‚ç‰¹åˆ«æ˜¯ï¼Œåœ¨ä¸å¯èƒ½è¿›è¡Œæ¯”è¾ƒçš„æƒ…å†µä¸‹å®ƒå…è®¸åœ¨æµ‹è¯•å’Œæ¨¡æ‹Ÿä¸­å¯¹é€‰é¡¹è¿›è¡Œæ¯”è¾ƒã€‚æ­¤å¤–ï¼Œå®ƒè¿˜å…è®¸é€‰é¡¹å®ç°å…¶ä»–æ¥å£ï¼ŒåŒ…æ‹¬ &lt;code>fmt.Stringer&lt;/code>ï¼Œå…è®¸ç”¨æˆ·è¯»å–é€‰é¡¹çš„å­—ç¬¦ä¸²è¡¨ç¤ºå½¢å¼ã€‚&lt;/p>
&lt;p>è¿˜å¯ä»¥å‚è€ƒä¸‹é¢èµ„æ–™ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;a href="https://commandcenter.blogspot.com/2014/01/self-referential-functions-and-design.html">Self-referential functions and the design of options&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://dave.cheney.net/2014/10/17/functional-options-for-friendly-apis">Functional options for friendly APIs&lt;/a>&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="linting">Linting&lt;/h2>
&lt;p>æ¯”ä»»ä½• &amp;quot;blessed&amp;quot; linter é›†æ›´é‡è¦çš„æ˜¯ï¼Œlintåœ¨ä¸€ä¸ªä»£ç åº“ä¸­å§‹ç»ˆä¿æŒä¸€è‡´ã€‚&lt;/p>
&lt;p>å»ºè®®è‡³å°‘ä½¿ç”¨ä»¥ä¸‹lintersï¼Œå› ä¸ºæˆ‘è®¤ä¸ºå®ƒä»¬æœ‰åŠ©äºå‘ç°æœ€å¸¸è§çš„é—®é¢˜ï¼Œå¹¶åœ¨ä¸éœ€è¦è§„å®šçš„æƒ…å†µä¸‹ä¸ºä»£ç è´¨é‡å»ºç«‹ä¸€ä¸ªé«˜æ ‡å‡†ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;a href="https://github.com/kisielk/errcheck">errcheck&lt;/a> ä»¥ç¡®ä¿é”™è¯¯å¾—åˆ°å¤„ç†&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://godoc.org/golang.org/x/tools/cmd/goimports">goimports&lt;/a> æ ¼å¼åŒ–ä»£ç å’Œç®¡ç† imports&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://github.com/golang/lint">golint&lt;/a> æŒ‡å‡ºå¸¸è§çš„æ–‡ä½“é”™è¯¯&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://golang.org/cmd/vet/">govet&lt;/a> åˆ†æä»£ç ä¸­çš„å¸¸è§é”™è¯¯&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://staticcheck.io/">staticcheck&lt;/a> å„ç§é™æ€åˆ†ææ£€æŸ¥&lt;/p>
&lt;/li>
&lt;/ul></content><category scheme="https://yusank.github.io/categories/%E6%8A%80%E6%9C%AF/" term="æŠ€æœ¯" label="æŠ€æœ¯"/><category scheme="https://yusank.github.io/categories/%E8%A7%84%E8%8C%83/" term="è§„èŒƒ" label="è§„èŒƒ"/><category scheme="https://yusank.github.io/tags/go/" term="go" label="go"/></entry><entry><title type="text">Go Map æºç è§£è¯»</title><link rel="alternate" type="text/html" href="https://yusank.github.io/posts/go-map/"/><id>https://yusank.github.io/posts/go-map/</id><updated>2021-09-18T06:24:55+00:00</updated><published>2020-06-14T16:24:41+08:00</published><author><name>yusank</name><uri>https://yusank.github.io/</uri><email>yusankurban@gmail.com</email></author><summary type="html">Go çš„ map ä½œä¸ºè¯¥è¯­è¨€æœ€å¸¸è§çš„åŸºç¡€æ•°æ®ç»“æ„ä¹‹ä¸€ã€‚ æºç è§£è¯» Go è¯­è¨€å®ç°çš„ map å¹¶éæ˜¯å®Œå…¨çš„å“ˆå¸Œâ€¦â€¦</summary><content type="html">&lt;p>Go çš„ &lt;code>map&lt;/code> ä½œä¸ºè¯¥è¯­è¨€æœ€å¸¸è§çš„åŸºç¡€æ•°æ®ç»“æ„ä¹‹ä¸€ã€‚&lt;/p>
&lt;h2 id="æºç è§£è¯»">æºç è§£è¯»&lt;/h2>
&lt;p>Go è¯­è¨€å®ç°çš„ map å¹¶éæ˜¯å®Œå…¨çš„å“ˆå¸Œ map ï¼Œæ˜¯ä¸€ç§ç±»ä¼¼ä¸¤å±‚æ ‘çŠ¶çš„ç»“æ„ï¼Œæ ¹æ® key çš„å“ˆå¸Œå€¼çš„ä½å…«ä½ å†³å®šç¬¬ä¸€å±‚çš„ä½ç½®ï¼Œæ ¹æ®é«˜å…«ä½å†³å®šç¬¬äºŒå±‚ï¼Œå¦‚æœç¬¬äºŒå±‚æ‰€åœ¨å†²çªäº†åˆ™ä¼šæœ‰ä¸€ä¸ªé¢å¤–çš„ä½ç½® ç”¨äºå­˜å‚¨å“ˆå¸Œç¢°æ’çš„ kvã€‚çœ‹å›¾ä¼šå¸®åŠ©ç†è§£ï¼š&lt;/p>
&lt;h3 id="å›¾è§£">å›¾è§£ï¼š&lt;/h3>
&lt;p>&lt;img src="http://blog.linkinstars.com/mweb/15593603213325.jpg" alt="å›¾è§£">&lt;/p>
&lt;h3 id="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„&lt;/h3>
&lt;p>æºç åœ¨ &lt;code>go/src/runtime/map.go&lt;/code> æ–‡ä»¶ä¸­ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// map çš„å®ç°
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">hmap&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">count&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="c1">// å·²ä½¿ç”¨ä½ç½®æ•°ï¼ˆå³ len() æ–¹æ³•ä¼šè¿”å›è¯¥å€¼ï¼‰ï¼Œä¹‹æ‰€ä»¥è¯´å·²ä½¿ç”¨çš„æ˜¯å› ä¸ºå¹¶éæ‰€æœ‰çš„ä½ç½®éƒ½å­˜æ”¾ä½ç½®
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">flags&lt;/span> &lt;span class="kt">uint8&lt;/span> &lt;span class="c1">// mapçš„çŠ¶æ€ï¼Œé€šè¿‡è¯¥å­—æ®µåˆ¤æ–­å½“å‰æ˜¯å¦è¢«æŸä¸ªè¿›ç¨‹è¿›è¡Œå†™æ“ä½œ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">B&lt;/span> &lt;span class="kt">uint8&lt;/span> &lt;span class="c1">// 2^B ä¸ºæ¡¶çš„æ•°é‡ï¼Œ Bä¸º 3 æ—¶ 2^3 ä¸€å…± 8 ä¸ªæ¡¶
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">noverflow&lt;/span> &lt;span class="kt">uint16&lt;/span> &lt;span class="c1">// æº¢å‡ºçš„æ¡¶æ•°é‡
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">hash0&lt;/span> &lt;span class="kt">uint32&lt;/span> &lt;span class="c1">// hash seed
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="nx">buckets&lt;/span> &lt;span class="nx">unsafe&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Pointer&lt;/span> &lt;span class="c1">// æ¡¶çš„æ•°ç»„
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">oldbuckets&lt;/span> &lt;span class="nx">unsafe&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Pointer&lt;/span> &lt;span class="c1">// æ—§æ¡¶çš„æ•°ç»„ã€‚map æ‰©å®¹æ—¶ åŸ buckets å˜æˆ oldbuckets å¹¶å°†æ•°æ®é€æ­¥è¿ç§»ï¼Œå¹¶éä¸€æ¬¡æ€§è¿ç§»
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">nevacuate&lt;/span> &lt;span class="kt">uintptr&lt;/span> &lt;span class="c1">// æ‰©å®¹è¿›åº¦è®°å½•
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="nx">extra&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">mapextra&lt;/span> &lt;span class="c1">// é¢å¤–ä¿¡æ¯ã€‚å­˜å‚¨éæŒ‡é’ˆæ•°æ®ï¼ˆä¸ºäº†ä¼˜åŒ–ç©ºé—´ï¼‰
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">mapextra&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// ä¸ºäº†ä¼˜åŒ–ç©ºé—´ å°†éæŒ‡é’ˆæ•°æ®å­˜å‚¨åœ¨ mapextraé‡Œ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">overflow&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">[]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">bmap&lt;/span> &lt;span class="c1">// å¯¹åº” hmap.buckets
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">oldoverflow&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">[]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">bmap&lt;/span> &lt;span class="c1">// å¯¹åº” hmap.oldbuckets
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="c1">// æŒ‡å‘ä¸‹ä¸€ä¸ªç©ºé—²çš„ bucket
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">nextOverflow&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">bmap&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// bucket å³æ¡¶
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">bmap&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// tophash å­˜å‚¨æ¯ä¸ª key çš„ tophash å³ key çš„å‰å…«ä½ï¼Œç”¨äºåˆ¤æ–­è¯»å–çš„ key æ˜¯å¦åœ¨å½“å‰æ¡¶é‡Œã€‚
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">tophash&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="nx">bucketCnt&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">uint8&lt;/span>
&lt;span class="c1">// ä¹‹åæ˜¯ key-value çš„æ ¼å­ï¼Œæ¯ä¸ªæ¡¶æœ€å¤šåªèƒ½å­˜ 8 ä¸ªä¸” ä»¥ key1...key8value1...value8 çš„å½¢å¼å­˜å‚¨ã€‚
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// è¿˜æœ‰ä¸€ä¸ª overflow ç”¨äºæŒ‡å‘ä¸‹ä¸€ä¸ªæ¡¶ã€‚
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="è¯»å–">è¯»å–&lt;/h3>
&lt;h4 id="æŒ‰-key-è¯»å–">æŒ‰ key è¯»å–&lt;/h4>
&lt;h4 id="éå†">éå†&lt;/h4>
&lt;h3 id="å†™å…¥">å†™å…¥&lt;/h3>
&lt;h3 id="åˆ é™¤">åˆ é™¤&lt;/h3>
&lt;blockquote>
&lt;p>coming soon&lt;/p>
&lt;/blockquote></content><category scheme="https://yusank.github.io/categories/%E6%8A%80%E6%9C%AF/" term="æŠ€æœ¯" label="æŠ€æœ¯"/><category scheme="https://yusank.github.io/tags/go/" term="go" label="go"/></entry><entry><title type="text">Go Channel æºç è§£è¯»</title><link rel="alternate" type="text/html" href="https://yusank.github.io/posts/go-channel/"/><id>https://yusank.github.io/posts/go-channel/</id><updated>2021-09-18T06:24:55+00:00</updated><published>2020-03-06T17:24:41+08:00</published><author><name>yusank</name><uri>https://yusank.github.io/</uri><email>yusankurban@gmail.com</email></author><summary type="html">Go çš„ channel ä½œä¸ºè¯¥è¯­è¨€å¾ˆé‡è¦çš„ç‰¹æ€§ï¼Œä½œä¸ºä¸€ä¸ª gopher æœ‰å¿…è¦è¯¦ç»†äº†è§£å…¶å®ç°åŸç†ã€‚ åŸç†è§£è¯» Go è¯­è¨€â€¦â€¦</summary><content type="html">&lt;p>Go çš„ &lt;code>channel&lt;/code> ä½œä¸ºè¯¥è¯­è¨€å¾ˆé‡è¦çš„ç‰¹æ€§ï¼Œä½œä¸ºä¸€ä¸ª gopher æœ‰å¿…è¦è¯¦ç»†äº†è§£å…¶å®ç°åŸç†ã€‚&lt;/p>
&lt;h1 id="åŸç†è§£è¯»">åŸç†è§£è¯»&lt;/h1>
&lt;p>Go è¯­è¨€çš„ &lt;code>channel&lt;/code> å®ç°æºç åœ¨&lt;code>go/src/runtime/chan.go&lt;/code> æ–‡ä»¶é‡Œã€‚ï¼ˆgo version ï¼š1.13.4ï¼‰&lt;/p>
&lt;h2 id="æ•°æ®ç»“æ„">æ•°æ®ç»“æ„&lt;/h2>
&lt;p>é¦–å…ˆçœ‹ä¸€ä¸‹åŸºç¡€æ•°æ®ç»“æ„ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// go è¯­è¨€çš„ channel ç»“æ„ä»¥é˜Ÿåˆ—çš„å½¢å¼å®ç°
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">hchan&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">qcount&lt;/span> &lt;span class="kt">uint&lt;/span> &lt;span class="c1">// total data in the queueï¼Œé˜Ÿåˆ—ä¸­å…ƒç´ æ€»æ•°
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">dataqsiz&lt;/span> &lt;span class="kt">uint&lt;/span> &lt;span class="c1">// size of the circular queueï¼Œå¾ªç¯é˜Ÿåˆ—çš„å¤§å°
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">buf&lt;/span> &lt;span class="nx">unsafe&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Pointer&lt;/span> &lt;span class="c1">// points to an array of dataqsiz elementsï¼Œ æŒ‡å‘å¾ªç¯é˜Ÿåˆ—ä¸­å…ƒç´ çš„æŒ‡é’ˆ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">elemsize&lt;/span> &lt;span class="kt">uint16&lt;/span> &lt;span class="c1">// å…ƒç´  size
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">closed&lt;/span> &lt;span class="kt">uint32&lt;/span> &lt;span class="c1">// channel æ˜¯å¦å…³é—­æ ‡å¿—
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">elemtype&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">_type&lt;/span> &lt;span class="c1">// element type // channel å…ƒç´ ç±»å‹
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">sendx&lt;/span> &lt;span class="kt">uint&lt;/span> &lt;span class="c1">// send index // å†™å…¥ channel å…ƒç´ çš„ç´¢å¼•
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">recvx&lt;/span> &lt;span class="kt">uint&lt;/span> &lt;span class="c1">// receive index // ä» channel è¯»å–çš„å…ƒç´ ç´¢å¼•
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">recvq&lt;/span> &lt;span class="nx">waitq&lt;/span> &lt;span class="c1">// list of recv waiters // è¯»å– channel çš„ç­‰å¾…é˜Ÿåˆ—ï¼ˆå³é˜»å¡çš„åç¨‹ï¼‰
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">sendq&lt;/span> &lt;span class="nx">waitq&lt;/span> &lt;span class="c1">// list of send waiters // å†™å…¥ channel çš„ç­‰å¾…é˜Ÿåˆ—
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="c1">// lock protects all fields in hchan, as well as several
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// fields in sudogs blocked on this channel.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">lock&lt;/span> &lt;span class="nx">mutex&lt;/span> &lt;span class="c1">// äº’æ–¥é”
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="c1">// åŒå‘é“¾è¡¨ç»“æ„ï¼Œå…¶ä¸­æ¯ä¸€ä¸ªå…ƒç´ ä»£è¡¨ç€ç­‰å¾…è¯»å–æˆ–å†™å…¥ channel çš„åç¨‹
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">waitq&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">first&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">sudog&lt;/span>
&lt;span class="nx">last&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">sudog&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€šè¿‡æºç æ•°æ®ç»“æ„ï¼Œå¯¹ go çš„ channel å®ç°æœ‰äº†åˆæ­¥çš„äº†è§£ï¼Œè§£ç­”äº†åœ¨æˆ‘ä»¬è¯»å–æˆ–å†™å…¥ channel æ—¶ï¼Œå…¶ä¸­å…ƒç´ åœ¨å“ªå„¿ï¼Œæˆ‘ä»¬çš„åç¨‹åœ¨å“ªå„¿ç­‰å¾…ç­‰æ•°æ®ç›¸å…³é—®é¢˜ã€‚&lt;/p>
&lt;ul>
&lt;li>channel åº•å±‚å®ç°æ˜¯ä»¥é˜Ÿåˆ—ä½œä¸ºè½½ä½“ï¼Œé€šè¿‡äº’æ–¥é”ä¿è¯åœ¨åŒä¸€ä¸ªæ—¶é—´ç‚¹ï¼Œåªæœ‰ä¸€ä¸ªå¾…è¯»å–çš„åç¨‹è¯»å…ƒç´ æˆ–å¾…å†™å…¥çš„åç¨‹å†™å…¥å…ƒç´ ã€‚&lt;/li>
&lt;li>å¦‚æœæœ‰å¤šä¸ªåç¨‹åŒæ—¶è¯»å– channel æ—¶ï¼Œä»–ä»¬ä¼šè¿›å…¥è¯»å–ç­‰å¾…é˜Ÿåˆ—ï¼š&lt;code>recvq&lt;/code>ï¼Œåä¹‹è¿›å…¥å†™å…¥ç­‰å¾…é˜Ÿåˆ—ï¼š&lt;code>sendq&lt;/code>ã€‚&lt;/li>
&lt;li>&lt;code>buf&lt;/code> ä½œä¸ºæŒ‡é’ˆï¼ŒæŒ‡å‘ channel ä¸­å­˜å‚¨å…ƒç´ çš„æ•°ç»„çš„åœ°å€ã€‚&lt;/li>
&lt;li>&lt;code>sendx&lt;/code>,&lt;code>recvx&lt;/code> ä½œä¸ºchannel é˜Ÿåˆ—ä¸­å†™å…¥å’Œè¯»å–åˆ°å…ƒç´ çš„ç´¢å¼•å€¼ã€‚&lt;/li>
&lt;li>&lt;code>closed&lt;/code> ä¸º channel å½“å‰æ˜¯å¦å·²è¢«å…³é—­æ ‡å¿—ã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="ä¸»è¦æ–¹æ³•func">ä¸»è¦æ–¹æ³•ï¼ˆfuncï¼‰&lt;/h2>
&lt;p>ä»¥æˆ‘ä»¬å¸¸ç”¨çš„ &lt;code>make(chan Type)&lt;/code>, å†™å…¥å…ƒç´ (&lt;code>chan &amp;lt;- element&lt;/code>)å’Œè¯»å–å…ƒç´ (&lt;code>&amp;lt;-chan&lt;/code>)ä¸ºä¾‹&lt;/p>
&lt;h3 id="åˆå§‹åŒ–make">åˆå§‹åŒ–ï¼ˆmakeï¼‰&lt;/h3>
&lt;p>åœ¨å®é™…ä½¿ç”¨ä¸­ æˆ‘ä¼šç”¨ä¸‹é¢çš„ä»£ç åˆå§‹åŒ–ä¸€ä¸ª channelï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="nx">Type&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">size&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å…¶å®ç°æºç å…¥ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// t ä¸º channel ç±»å‹ï¼Œsize ä¸ºæˆ‘ä»¬ä¼ å…¥ channel å¤§å°
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">makechan&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">chantype&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">size&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">hchan&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">elem&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">t&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">elem&lt;/span>
&lt;span class="c1">// å¦‚æœ size è¶…è¿‡å£°æ˜ç±»å‹æœ€å¤§å€¼ ç¼–è¯‘çš„æ—¶å€™ä¼šæŠ¥é”™ï¼Œä½†æ˜¯è¿™é‡Œå¤šä¸€æ¬¡åˆ¤æ–­ä¸ºäº†æ›´å®‰å…¨
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">elem&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">size&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="o">&amp;lt;&amp;lt;&lt;/span>&lt;span class="mi">16&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// æŠ›å‡ºå¼‚å¸¸
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">throw&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;makechan: invalid channel element type&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// align ä¸ºç±»å‹çš„å¯¹é½ç³»æ•°ï¼Œä¸åŒå¹³å°ä¸Šå¯¹å…¶ç³»æ•°ä¸å®Œå…¨ä¸€æ ·ï¼Œä½†æ˜¯éƒ½æœ€å¤§å€¼ maxAlign=8
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// ä¸åŒç±»å‹çš„å¯¹é½ç³»æ•°ä¸ä¸€æ · ä½†æ˜¯å‡ä»¥ 2^N å½¢å¼
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">hchanSize&lt;/span>&lt;span class="o">%&lt;/span>&lt;span class="nx">maxAlign&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nx">elem&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">align&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="nx">maxAlign&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">throw&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;makechan: bad alignment&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// æ£€æŸ¥æ˜¯å¦channel å¤§å°å€¼æ˜¯å¦æº¢å‡º
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">mem&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">overflow&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">math&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">MulUintptr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">elem&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">size&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">uintptr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">size&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">overflow&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nx">mem&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="nx">maxAlloc&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="nx">hchanSize&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nx">size&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nf">plainError&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;makechan: size out of range&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// æ ¹æ® size å’ŒåŸå§‹æ˜¯å¦ä¸ºæŒ‡é’ˆæƒ…å†µï¼Œåˆ†é…å†…å­˜åˆå§‹åŒ– channel
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">var&lt;/span> &lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">hchan&lt;/span>
&lt;span class="k">switch&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// channel size ä¸º 0
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">case&lt;/span> &lt;span class="nx">mem&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">c&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">hchan&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="nf">mallocgc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">hchanSize&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">buf&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">raceaddr&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nx">elem&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ptrdata&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="c1">// å…ƒç´ ä¸åŒ…å«æŒ‡é’ˆï¼Œåˆ™å°†ä¸ºå…ƒç´ åˆ†é…å†…å­˜ï¼Œå¹¶å°† buf æŒ‡å‘è¯¥åœ°å€
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">c&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">hchan&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="nf">mallocgc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">hchanSize&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="nx">mem&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">buf&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">unsafe&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Pointer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nx">hchanSize&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">default&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="c1">// å…ƒç´ åŒ…å«æŒ‡é’ˆï¼Œbuf æŒ‡å‘è¯¥æŒ‡é’ˆæŒ‡å‘åœ°å€
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">c&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">hchan&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">buf&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">mallocgc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">mem&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">elem&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">elemsize&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">uint16&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">elem&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">size&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">elemtype&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">elem&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">dataqsiz&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">uint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">size&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">c&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯ä»¥çœ‹å‡ºï¼Œchannel ä¸­çš„å…ƒç´ æœ€ç»ˆéƒ½æ˜¯ä»¥æŒ‡é’ˆçš„æ–¹å¼å­˜å‚¨ï¼Œå³ä¾¿åˆå§‹åŒ–æ—¶ ç”¨éæŒ‡é’ˆç±»å‹ï¼ˆå¦‚ stringï¼‰ï¼Œåœ¨åˆå§‹åŒ–è¯çš„æ—¶å€™ ä¼šå…ˆåˆ†é…å†…å­˜ å¹¶å°† channel çš„å…ƒç´ æŒ‡é’ˆå­—æ®µæŒ‡å‘è¯¥åœ°å€ã€‚&lt;/p>
&lt;h3 id="å†™å…¥">å†™å…¥&lt;/h3>
&lt;p>å…ˆç»™å‡ºæºç ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt"> 10
&lt;/span>&lt;span class="lnt"> 11
&lt;/span>&lt;span class="lnt"> 12
&lt;/span>&lt;span class="lnt"> 13
&lt;/span>&lt;span class="lnt"> 14
&lt;/span>&lt;span class="lnt"> 15
&lt;/span>&lt;span class="lnt"> 16
&lt;/span>&lt;span class="lnt"> 17
&lt;/span>&lt;span class="lnt"> 18
&lt;/span>&lt;span class="lnt"> 19
&lt;/span>&lt;span class="lnt"> 20
&lt;/span>&lt;span class="lnt"> 21
&lt;/span>&lt;span class="lnt"> 22
&lt;/span>&lt;span class="lnt"> 23
&lt;/span>&lt;span class="lnt"> 24
&lt;/span>&lt;span class="lnt"> 25
&lt;/span>&lt;span class="lnt"> 26
&lt;/span>&lt;span class="lnt"> 27
&lt;/span>&lt;span class="lnt"> 28
&lt;/span>&lt;span class="lnt"> 29
&lt;/span>&lt;span class="lnt"> 30
&lt;/span>&lt;span class="lnt"> 31
&lt;/span>&lt;span class="lnt"> 32
&lt;/span>&lt;span class="lnt"> 33
&lt;/span>&lt;span class="lnt"> 34
&lt;/span>&lt;span class="lnt"> 35
&lt;/span>&lt;span class="lnt"> 36
&lt;/span>&lt;span class="lnt"> 37
&lt;/span>&lt;span class="lnt"> 38
&lt;/span>&lt;span class="lnt"> 39
&lt;/span>&lt;span class="lnt"> 40
&lt;/span>&lt;span class="lnt"> 41
&lt;/span>&lt;span class="lnt"> 42
&lt;/span>&lt;span class="lnt"> 43
&lt;/span>&lt;span class="lnt"> 44
&lt;/span>&lt;span class="lnt"> 45
&lt;/span>&lt;span class="lnt"> 46
&lt;/span>&lt;span class="lnt"> 47
&lt;/span>&lt;span class="lnt"> 48
&lt;/span>&lt;span class="lnt"> 49
&lt;/span>&lt;span class="lnt"> 50
&lt;/span>&lt;span class="lnt"> 51
&lt;/span>&lt;span class="lnt"> 52
&lt;/span>&lt;span class="lnt"> 53
&lt;/span>&lt;span class="lnt"> 54
&lt;/span>&lt;span class="lnt"> 55
&lt;/span>&lt;span class="lnt"> 56
&lt;/span>&lt;span class="lnt"> 57
&lt;/span>&lt;span class="lnt"> 58
&lt;/span>&lt;span class="lnt"> 59
&lt;/span>&lt;span class="lnt"> 60
&lt;/span>&lt;span class="lnt"> 61
&lt;/span>&lt;span class="lnt"> 62
&lt;/span>&lt;span class="lnt"> 63
&lt;/span>&lt;span class="lnt"> 64
&lt;/span>&lt;span class="lnt"> 65
&lt;/span>&lt;span class="lnt"> 66
&lt;/span>&lt;span class="lnt"> 67
&lt;/span>&lt;span class="lnt"> 68
&lt;/span>&lt;span class="lnt"> 69
&lt;/span>&lt;span class="lnt"> 70
&lt;/span>&lt;span class="lnt"> 71
&lt;/span>&lt;span class="lnt"> 72
&lt;/span>&lt;span class="lnt"> 73
&lt;/span>&lt;span class="lnt"> 74
&lt;/span>&lt;span class="lnt"> 75
&lt;/span>&lt;span class="lnt"> 76
&lt;/span>&lt;span class="lnt"> 77
&lt;/span>&lt;span class="lnt"> 78
&lt;/span>&lt;span class="lnt"> 79
&lt;/span>&lt;span class="lnt"> 80
&lt;/span>&lt;span class="lnt"> 81
&lt;/span>&lt;span class="lnt"> 82
&lt;/span>&lt;span class="lnt"> 83
&lt;/span>&lt;span class="lnt"> 84
&lt;/span>&lt;span class="lnt"> 85
&lt;/span>&lt;span class="lnt"> 86
&lt;/span>&lt;span class="lnt"> 87
&lt;/span>&lt;span class="lnt"> 88
&lt;/span>&lt;span class="lnt"> 89
&lt;/span>&lt;span class="lnt"> 90
&lt;/span>&lt;span class="lnt"> 91
&lt;/span>&lt;span class="lnt"> 92
&lt;/span>&lt;span class="lnt"> 93
&lt;/span>&lt;span class="lnt"> 94
&lt;/span>&lt;span class="lnt"> 95
&lt;/span>&lt;span class="lnt"> 96
&lt;/span>&lt;span class="lnt"> 97
&lt;/span>&lt;span class="lnt"> 98
&lt;/span>&lt;span class="lnt"> 99
&lt;/span>&lt;span class="lnt">100
&lt;/span>&lt;span class="lnt">101
&lt;/span>&lt;span class="lnt">102
&lt;/span>&lt;span class="lnt">103
&lt;/span>&lt;span class="lnt">104
&lt;/span>&lt;span class="lnt">105
&lt;/span>&lt;span class="lnt">106
&lt;/span>&lt;span class="lnt">107
&lt;/span>&lt;span class="lnt">108
&lt;/span>&lt;span class="lnt">109
&lt;/span>&lt;span class="lnt">110
&lt;/span>&lt;span class="lnt">111
&lt;/span>&lt;span class="lnt">112
&lt;/span>&lt;span class="lnt">113
&lt;/span>&lt;span class="lnt">114
&lt;/span>&lt;span class="lnt">115
&lt;/span>&lt;span class="lnt">116
&lt;/span>&lt;span class="lnt">117
&lt;/span>&lt;span class="lnt">118
&lt;/span>&lt;span class="lnt">119
&lt;/span>&lt;span class="lnt">120
&lt;/span>&lt;span class="lnt">121
&lt;/span>&lt;span class="lnt">122
&lt;/span>&lt;span class="lnt">123
&lt;/span>&lt;span class="lnt">124
&lt;/span>&lt;span class="lnt">125
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">
&lt;span class="c1">// entry point for c &amp;lt;- x from compiled code
&lt;/span>&lt;span class="c1">// ä»£ç é‡ `c &amp;lt;- x` ç¼–è¯‘æ—¶ï¼Œä¼šç¼–è¯‘æˆè¯¥æ–¹æ³•ä»è€Œè¢«è°ƒç”¨
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">chansend1&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">hchan&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">elem&lt;/span> &lt;span class="nx">unsafe&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Pointer&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">chansend&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">elem&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nf">getcallerpc&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="cm">/*
&lt;/span>&lt;span class="cm"> * generic single channel send/recv
&lt;/span>&lt;span class="cm"> * If block is not nil,
&lt;/span>&lt;span class="cm"> * then the protocol will not
&lt;/span>&lt;span class="cm"> * sleep but return if it could
&lt;/span>&lt;span class="cm"> * not complete.
&lt;/span>&lt;span class="cm"> *
&lt;/span>&lt;span class="cm"> * sleep can wake up with g.param == nil
&lt;/span>&lt;span class="cm"> * when a channel involved in the sleep has
&lt;/span>&lt;span class="cm"> * been closed. it is easiest to loop and re-run
&lt;/span>&lt;span class="cm"> * the operation; we&amp;#39;ll see that it&amp;#39;s now closed.
&lt;/span>&lt;span class="cm"> */&lt;/span>
&lt;span class="c1">// å‘ channel å†™å…¥
&lt;/span>&lt;span class="c1">// c: channel
&lt;/span>&lt;span class="c1">// ep: å†™å…¥å…ƒç´ åœ°å€
&lt;/span>&lt;span class="c1">// block: è¡¨ç¤ºè¯¥ channel æ˜¯å¦è¢«é˜»å¡
&lt;/span>&lt;span class="c1">// callerpc:
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">chansend&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">hchan&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ep&lt;/span> &lt;span class="nx">unsafe&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Pointer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">block&lt;/span> &lt;span class="kt">bool&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">callerpc&lt;/span> &lt;span class="kt">uintptr&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">bool&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">c&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// return or panic
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">raceenabled&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// ä¸åŒåç¨‹ä¹‹å‰ç«äº‰å†™å…¥
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">racereadpc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">raceaddr&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nx">callerpc&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nf">funcPC&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">chansend&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// æ²¡æœ‰é˜»å¡ &amp;amp;&amp;amp; æœªå…³é—­ &amp;amp;&amp;amp; ï¼ˆchannel ä¸ºç©ºä¸”æ²¡æœ‰åç¨‹è¯»å– æˆ– channel å·²æ»¡ï¼Œç›´æ¥è¿”å› falseï¼‰
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">block&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">closed&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">dataqsiz&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">recvq&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">first&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">||&lt;/span>
&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">dataqsiz&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">qcount&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">dataqsiz&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">t0&lt;/span> &lt;span class="kt">int64&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">blockprofilerate&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">t0&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">cputicks&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// ä¸Šé” å‡†å¤‡å†™
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">lock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">lock&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// å·²å…³é—­ è§£é”å¹¶ panic
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">closed&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">unlock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">lock&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nf">plainError&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;send on closed channel&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// ä»ç­‰å¾…è¯»å–çš„é˜Ÿåˆ—ä¸­ æ‹¿å‡ºç¬¬ä¸€ä¸ªåç¨‹ï¼Œå†™å…¥å¹¶å‘é€åˆ°è¯¥åç¨‹
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">sg&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">recvq&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">dequeue&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="nx">sg&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Found a waiting receiver. We pass the value we want to send
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// directly to the receiver, bypassing the channel buffer (if any).
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">send&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">sg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ep&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nf">unlock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">lock&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">},&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// å¦‚æœ channel ç¼“å­˜æœ‰ç©ºé—´ï¼Œåˆ™å‘ç¼“å­˜ä¸­å†™å…¥
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// æ­¤æ—¶æ˜¯ channel æ˜¯æœ‰ buffer channel
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">qcount&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">dataqsiz&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Space is available in the channel buffer. Enqueue the element to send.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">qp&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">chanbuf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sendx&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// åº”è¯¥æ˜¯åç¨‹ä¹‹é—´ç«äº‰ï¼Œæš‚æ—¶æ²¡æœ‰å®Œå…¨ææ‡‚
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">raceenabled&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">raceacquire&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">qp&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nf">racerelease&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">qp&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// å†™å…¥ç¼“å­˜
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">typedmemmove&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">elemtype&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">qp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ep&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// å†™å…¥ä½ç½®åŠ ä¸€
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sendx&lt;/span>&lt;span class="o">++&lt;/span>
&lt;span class="c1">// å¦‚æœå†™å®Œ buffer æ»¡äº†ï¼Œå°†ä½ç½®ç½®ä½ 0
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sendx&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">dataqsiz&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sendx&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// channel æ•°æ®æ€»æ•°åŠ ä¸€
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">qcount&lt;/span>&lt;span class="o">++&lt;/span>
&lt;span class="c1">// è§£é”
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">unlock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">lock&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// å¦‚æœæ˜¯éé˜»å¡ç±»å‹ channelï¼Œåˆ™åªè¿”å›
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">block&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">unlock&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">lock&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// å¦‚æœæ˜¯é˜»å¡ç±»å‹ï¼Œåˆ™ä¸€ç›´é˜»å¡ä¸€ç›´åˆ°è¢«è¯»å–ï¼Œä¿è¯æ•°æ®åœ¨è¢«è¯»å–ä¹‹å‰ä¸è¢«å†…å­˜å›æ”¶
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="c1">// Block on the channel. Some receiver will complete our operation for us.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">gp&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">getg&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">mysg&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">acquireSudog&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">mysg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">releasetime&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">t0&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">mysg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">releasetime&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nf">KeepAlive&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ep&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// someone woke us up.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">mysg&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="nx">gp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">waiting&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">throw&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;G waiting list is corrupted&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">gp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">waiting&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">gp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">param&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">closed&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">throw&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;chansend: spurious wakeup&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nf">plainError&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;send on closed channel&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">gp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">param&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">mysg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">releasetime&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">blockevent&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">mysg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">releasetime&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="nx">t0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">mysg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="nf">releaseSudog&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">mysg&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="è¯»å–">è¯»å–&lt;/h3>
&lt;blockquote>
&lt;p>è¿‘æœŸè¡¥å……ã€‚ã€‚ã€‚&lt;/p>
&lt;/blockquote>
&lt;h1 id="ä½¿ç”¨">ä½¿ç”¨&lt;/h1>
&lt;p>Channelæ˜¯Goä¸­çš„ä¸€ä¸ªæ ¸å¿ƒç±»å‹ï¼Œä½ å¯ä»¥æŠŠå®ƒçœ‹æˆä¸€ä¸ªç®¡é“ï¼Œé€šè¿‡å®ƒå¹¶å‘æ ¸å¿ƒå•å…ƒå°±å¯ä»¥å‘é€æˆ–è€…æ¥æ”¶æ•°æ®è¿›è¡Œé€šè®¯(communication)ã€‚&lt;/p>
&lt;p>å®ƒçš„æ“ä½œç¬¦æ˜¯ç®­å¤´Â &lt;strong>&amp;lt;-&lt;/strong>Â ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">ch&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="nx">v&lt;/span>
&lt;span class="nx">v&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">ch&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>(ç®­å¤´çš„æŒ‡å‘å°±æ˜¯æ•°æ®çš„æµå‘)&lt;/p>
&lt;p>å°±åƒ map å’Œ slice æ•°æ®ç±»å‹ä¸€æ ·, channelå¿…é¡»å…ˆåˆ›å»ºå†ä½¿ç”¨:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">ch&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="channel-ç±»å‹">Channel ç±»å‹&lt;/h2>
&lt;p>Channelç±»å‹çš„å®šä¹‰æ ¼å¼å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">ChannelType&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">(&lt;/span> &lt;span class="s">&amp;#34;chan&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="s">&amp;#34;chan&amp;#34;&lt;/span> &lt;span class="s">&amp;#34;&amp;lt;-&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="s">&amp;#34;&amp;lt;-&amp;#34;&lt;/span> &lt;span class="s">&amp;#34;chan&amp;#34;&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="nx">ElementType&lt;/span> &lt;span class="p">.&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å®ƒåŒ…æ‹¬ä¸‰ç§ç±»å‹çš„å®šä¹‰ã€‚å¯é€‰çš„&lt;code>&amp;lt;-&lt;/code>ä»£è¡¨channelçš„æ–¹å‘ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šæ–¹å‘ï¼Œé‚£ä¹ˆChannelå°±æ˜¯åŒå‘çš„ï¼Œæ—¢å¯ä»¥æ¥æ”¶æ•°æ®ï¼Œä¹Ÿå¯ä»¥å‘é€æ•°æ®ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">chan&lt;/span> &lt;span class="nx">T&lt;/span> &lt;span class="c1">// å¯ä»¥æ¥æ”¶å’Œå‘é€ç±»å‹ä¸º T çš„æ•°æ®
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">chan&lt;/span>&lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="kt">float64&lt;/span> &lt;span class="c1">// åªå¯ä»¥ç”¨æ¥å‘é€ float64 ç±»å‹çš„æ•°æ®
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="c1">// åªå¯ä»¥ç”¨æ¥æ¥æ”¶ int ç±»å‹çš„æ•°æ®
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>&amp;lt;-&lt;/code>æ€»æ˜¯ä¼˜å…ˆå’Œæœ€å·¦è¾¹çš„ç±»å‹ç»“åˆã€‚(The &amp;lt;- operator associates with the leftmost chan possible)&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">chan&lt;/span>&lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="c1">// ç­‰ä»· chan&amp;lt;- (chan int)
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">chan&lt;/span>&lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="c1">// ç­‰ä»· chan&amp;lt;- (&amp;lt;-chan int)
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="c1">// ç­‰ä»· &amp;lt;-chan (&amp;lt;-chan int)
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä½¿ç”¨&lt;code>make&lt;/code>åˆå§‹åŒ–Channel,å¹¶ä¸”å¯ä»¥è®¾ç½®å®¹é‡:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å®¹é‡(capacity)ä»£è¡¨Channelå®¹çº³çš„æœ€å¤šçš„å…ƒç´ çš„æ•°é‡ï¼Œä»£è¡¨Channelçš„ç¼“å­˜çš„å¤§å°ã€‚
å¦‚æœæ²¡æœ‰è®¾ç½®å®¹é‡ï¼Œæˆ–è€…å®¹é‡è®¾ç½®ä¸º0, è¯´æ˜Channelæ²¡æœ‰ç¼“å­˜ï¼Œåªæœ‰senderå’Œreceiveréƒ½å‡†å¤‡å¥½äº†åå®ƒä»¬çš„é€šè®¯(communication)æ‰ä¼šå‘ç”Ÿ(Blocking)ã€‚å¦‚æœè®¾ç½®äº†ç¼“å­˜ï¼Œå°±æœ‰å¯èƒ½ä¸å‘ç”Ÿé˜»å¡ï¼Œ åªæœ‰bufferæ»¡äº†å sendæ‰ä¼šé˜»å¡ï¼Œ è€Œåªæœ‰ç¼“å­˜ç©ºäº†åreceiveæ‰ä¼šé˜»å¡ã€‚ä¸€ä¸ªnil channelä¸ä¼šé€šä¿¡ã€‚&lt;/p>
&lt;p>å¯ä»¥é€šè¿‡å†…å»ºçš„&lt;code>close&lt;/code>æ–¹æ³•å¯ä»¥å…³é—­Channelã€‚&lt;/p>
&lt;p>ä½ å¯ä»¥åœ¨å¤šä¸ªgoroutineä»/å¾€ ä¸€ä¸ªchannel ä¸­ receive/send æ•°æ®, ä¸å¿…è€ƒè™‘é¢å¤–çš„åŒæ­¥æªæ–½ã€‚&lt;/p>
&lt;p>Channelå¯ä»¥ä½œä¸ºä¸€ä¸ªå…ˆå…¥å…ˆå‡º(FIFO)çš„é˜Ÿåˆ—ï¼Œæ¥æ”¶çš„æ•°æ®å’Œå‘é€çš„æ•°æ®çš„é¡ºåºæ˜¯ä¸€è‡´çš„ã€‚&lt;/p>
&lt;p>channelçš„ receiveæ”¯æŒÂ &lt;em>multi-valued assignment&lt;/em>ï¼Œå¦‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">v&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">ch&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å®ƒå¯ä»¥ç”¨æ¥æ£€æŸ¥Channelæ˜¯å¦å·²ç»è¢«å…³é—­äº†ã€‚&lt;/p>
&lt;ol>
&lt;li>&lt;strong>sendè¯­å¥&lt;/strong>
sendè¯­å¥ç”¨æ¥å¾€Channelä¸­å‘é€æ•°æ®ï¼Œ å¦‚&lt;code>ch &amp;lt;- 3&lt;/code>ã€‚
å®ƒçš„å®šä¹‰å¦‚ä¸‹:&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">SendStmt&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">Channel&lt;/span> &lt;span class="s">&amp;#34;&amp;lt;-&amp;#34;&lt;/span> &lt;span class="nx">Expression&lt;/span> &lt;span class="p">.&lt;/span>
&lt;span class="nx">Channel&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">Expression&lt;/span> &lt;span class="p">.&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨é€šè®¯(communication)å¼€å§‹å‰channelå’Œexpressionå¿…é€‰å…ˆæ±‚å€¼å‡ºæ¥(evaluated)ï¼Œæ¯”å¦‚ä¸‹é¢çš„(3+4)å…ˆè®¡ç®—å‡º7ç„¶åå†å‘é€ç»™channelã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">c&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nb">close&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nx">c&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="mi">3&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">4&lt;/span> &lt;span class="p">}()&lt;/span>
&lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">c&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>sendè¢«æ‰§è¡Œå‰(proceed)é€šè®¯(communication)ä¸€ç›´è¢«é˜»å¡ç€ã€‚å¦‚å‰æ‰€è¨€ï¼Œæ— ç¼“å­˜çš„channelåªæœ‰åœ¨receiverå‡†å¤‡å¥½åsendæ‰è¢«æ‰§è¡Œã€‚å¦‚æœæœ‰ç¼“å­˜ï¼Œå¹¶ä¸”ç¼“å­˜æœªæ»¡ï¼Œåˆ™sendä¼šè¢«æ‰§è¡Œã€‚&lt;/p>
&lt;p>å¾€ä¸€ä¸ªå·²ç»è¢«closeçš„channelä¸­ç»§ç»­å‘é€æ•°æ®ä¼šå¯¼è‡´&lt;strong>run-time panic&lt;/strong>ã€‚&lt;/p>
&lt;p>å¾€nil channelä¸­å‘é€æ•°æ®ä¼šä¸€è‡´è¢«é˜»å¡ç€ã€‚&lt;/p>
&lt;ol>
&lt;li>receive æ“ä½œç¬¦
&lt;code>&amp;lt;-ch&lt;/code>ç”¨æ¥ä»channel chä¸­æ¥æ”¶æ•°æ®ï¼Œè¿™ä¸ªè¡¨è¾¾å¼ä¼šä¸€ç›´è¢«block,ç›´åˆ°æœ‰æ•°æ®å¯ä»¥æ¥æ”¶ã€‚&lt;/li>
&lt;/ol>
&lt;p>ä»ä¸€ä¸ªnil channelä¸­æ¥æ”¶æ•°æ®ä¼šä¸€ç›´è¢«blockã€‚&lt;/p>
&lt;p>ä»ä¸€ä¸ªè¢«closeçš„channelä¸­æ¥æ”¶æ•°æ®ä¸ä¼šè¢«é˜»å¡ï¼Œè€Œæ˜¯ç«‹å³è¿”å›ï¼Œæ¥æ”¶å®Œå·²å‘é€çš„æ•°æ®åä¼šè¿”å›å…ƒç´ ç±»å‹çš„é›¶å€¼(zero value)ã€‚&lt;/p>
&lt;p>å¦‚å‰æ‰€è¿°ï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸€ä¸ªé¢å¤–çš„è¿”å›å‚æ•°æ¥æ£€æŸ¥channelæ˜¯å¦å…³é—­ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">x&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">ch&lt;/span>
&lt;span class="nx">x&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">ch&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">x&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">ch&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="blocking">blocking&lt;/h2>
&lt;p>ç¼ºçœæƒ…å†µä¸‹ï¼Œå‘é€å’Œæ¥æ”¶ä¼šä¸€ç›´é˜»å¡ç€ï¼ŒçŸ¥é“å¦ä¸€æ–¹å‡†å¤‡å¥½ã€‚è¿™ç§æ–¹å¼å¯ä»¥ç”¨æ¥åœ¨gororutineä¸­è¿›è¡ŒåŒæ­¥ï¼Œè€Œä¸å¿…ä½¿ç”¨æ˜¾ç¤ºçš„é”æˆ–è€…æ¡ä»¶å˜é‡ã€‚&lt;/p>
&lt;p>å¦‚å®˜æ–¹çš„ä¾‹å­ä¸­&lt;code>x, y := &amp;lt;-c, &amp;lt;-c&lt;/code>è¿™å¥ä¼šä¸€ç›´ç­‰å¾…è®¡ç®—ç»“æœå‘é€åˆ°channelä¸­ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">import&lt;/span> &lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">sum&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">c&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">sum&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">s&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">sum&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="nx">v&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">c&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="nx">sum&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">s&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="mi">7&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">9&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="nx">c&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="nf">sum&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span>&lt;span class="p">[:&lt;/span>&lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="nf">sum&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">:],&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">x&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">y&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="c1">// receive from c
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">x&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">x&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="nx">y&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="buffered-channels">Buffered Channels&lt;/h2>
&lt;p>makeçš„ç¬¬äºŒä¸ªå‚æ•°æŒ‡å®šç¼“å­˜çš„å¤§å°ï¼š&lt;code>ch := make(chan int, 100)&lt;/code>ã€‚&lt;/p>
&lt;p>é€šè¿‡ç¼“å­˜çš„ä½¿ç”¨ï¼Œå¯ä»¥å°½é‡é¿å…é˜»å¡ï¼Œæä¾›åº”ç”¨çš„æ€§èƒ½ã€‚&lt;/p>
&lt;h2 id="range">Range&lt;/h2>
&lt;p>&lt;code>for â€¦â€¦ range&lt;/code>è¯­å¥å¯ä»¥å¤„ç†Channelã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Hour&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}()&lt;/span>
&lt;span class="nx">c&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">c&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="nx">i&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nb">close&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}()&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">c&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Finished&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>range c&lt;/code>äº§ç”Ÿçš„è¿­ä»£å€¼ä¸ºChannelä¸­å‘é€çš„å€¼ï¼Œå®ƒä¼šä¸€ç›´è¿­ä»£çŸ¥é“channelè¢«å…³é—­ã€‚ä¸Šé¢çš„ä¾‹å­ä¸­å¦‚æœæŠŠ&lt;code>close(c)&lt;/code>æ³¨é‡Šæ‰ï¼Œç¨‹åºä¼šä¸€ç›´é˜»å¡åœ¨&lt;code>for â€¦â€¦ range&lt;/code>é‚£ä¸€è¡Œã€‚&lt;/p>
&lt;h2 id="select">select&lt;/h2>
&lt;p>&lt;code>select&lt;/code>è¯­å¥é€‰æ‹©ä¸€ç»„å¯èƒ½çš„sendæ“ä½œå’Œreceiveæ“ä½œå»å¤„ç†ã€‚å®ƒç±»ä¼¼&lt;code>switch&lt;/code>,ä½†æ˜¯åªæ˜¯ç”¨æ¥å¤„ç†é€šè®¯(communication)æ“ä½œã€‚
å®ƒçš„&lt;code>case&lt;/code>å¯ä»¥æ˜¯sendè¯­å¥ï¼Œä¹Ÿå¯ä»¥æ˜¯receiveè¯­å¥ï¼Œäº¦æˆ–è€…&lt;code>default&lt;/code>ã€‚&lt;/p>
&lt;p>&lt;code>receive&lt;/code>è¯­å¥å¯ä»¥å°†å€¼èµ‹å€¼ç»™ä¸€ä¸ªæˆ–è€…ä¸¤ä¸ªå˜é‡ã€‚å®ƒå¿…é¡»æ˜¯ä¸€ä¸ªreceiveæ“ä½œã€‚&lt;/p>
&lt;p>æœ€å¤šå…è®¸æœ‰ä¸€ä¸ª&lt;code>default case&lt;/code>,å®ƒå¯ä»¥æ”¾åœ¨caseåˆ—è¡¨çš„ä»»ä½•ä½ç½®ï¼Œå°½ç®¡æˆ‘ä»¬å¤§éƒ¨åˆ†ä¼šå°†å®ƒæ”¾åœ¨æœ€åã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">import&lt;/span> &lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">fibonacci&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">quit&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">x&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">y&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">select&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nx">c&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="nx">x&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">x&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">y&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">x&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="nx">y&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">quit&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;quit&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">c&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">quit&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">quit&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="p">}()&lt;/span>
&lt;span class="nf">fibonacci&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">quit&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœæœ‰åŒæ—¶å¤šä¸ªcaseå»å¤„ç†,æ¯”å¦‚åŒæ—¶æœ‰å¤šä¸ªchannelå¯ä»¥æ¥æ”¶æ•°æ®ï¼Œé‚£ä¹ˆGoä¼šä¼ªéšæœºçš„é€‰æ‹©ä¸€ä¸ªcaseå¤„ç†(pseudo-random)ã€‚å¦‚æœæ²¡æœ‰caseéœ€è¦å¤„ç†ï¼Œåˆ™ä¼šé€‰æ‹©&lt;code>default&lt;/code>å»å¤„ç†ï¼Œå¦‚æœ&lt;code>default case&lt;/code>å­˜åœ¨çš„æƒ…å†µä¸‹ã€‚å¦‚æœæ²¡æœ‰&lt;code>default case&lt;/code>ï¼Œåˆ™&lt;code>select&lt;/code>è¯­å¥ä¼šé˜»å¡ï¼Œç›´åˆ°æŸä¸ªcaseéœ€è¦å¤„ç†ã€‚&lt;/p>
&lt;p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œnil channelä¸Šçš„æ“ä½œä¼šä¸€ç›´è¢«é˜»å¡ï¼Œå¦‚æœæ²¡æœ‰default case,åªæœ‰nil channelçš„selectä¼šä¸€ç›´è¢«é˜»å¡ã€‚&lt;/p>
&lt;p>&lt;code>select&lt;/code>è¯­å¥å’Œ&lt;code>switch&lt;/code>è¯­å¥ä¸€æ ·ï¼Œå®ƒä¸æ˜¯å¾ªç¯ï¼Œå®ƒåªä¼šé€‰æ‹©ä¸€ä¸ªcaseæ¥å¤„ç†ï¼Œå¦‚æœæƒ³ä¸€ç›´å¤„ç†channelï¼Œä½ å¯ä»¥åœ¨å¤–é¢åŠ ä¸€ä¸ªæ— é™çš„forå¾ªç¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="k">for&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">select&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nx">c&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="nx">x&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">x&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">y&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">x&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="nx">y&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">quit&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;quit&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="timeout">timeout&lt;/h3>
&lt;p>&lt;code>select&lt;/code>æœ‰å¾ˆé‡è¦çš„ä¸€ä¸ªåº”ç”¨å°±æ˜¯è¶…æ—¶å¤„ç†ã€‚ å› ä¸ºä¸Šé¢æˆ‘ä»¬æåˆ°ï¼Œå¦‚æœæ²¡æœ‰caseéœ€è¦å¤„ç†ï¼Œselectè¯­å¥å°±ä¼šä¸€ç›´é˜»å¡ç€ã€‚è¿™æ—¶å€™æˆ‘ä»¬å¯èƒ½å°±éœ€è¦ä¸€ä¸ªè¶…æ—¶æ“ä½œï¼Œç”¨æ¥å¤„ç†è¶…æ—¶çš„æƒ…å†µã€‚
ä¸‹é¢è¿™ä¸ªä¾‹å­æˆ‘ä»¬ä¼šåœ¨2ç§’åå¾€channel c1ä¸­å‘é€ä¸€ä¸ªæ•°æ®ï¼Œä½†æ˜¯&lt;code>select&lt;/code>è®¾ç½®ä¸º1ç§’è¶…æ—¶,å› æ­¤æˆ‘ä»¬ä¼šæ‰“å°å‡º&lt;code>timeout 1&lt;/code>,è€Œä¸æ˜¯&lt;code>result 1&lt;/code>ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">import&lt;/span> &lt;span class="s">&amp;#34;time&amp;#34;&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">c1&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">c1&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="s">&amp;#34;result 1&amp;#34;&lt;/span>
&lt;span class="p">}()&lt;/span>
&lt;span class="k">select&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="nx">res&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">c1&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">res&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">After&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;timeout 1&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å…¶å®å®ƒåˆ©ç”¨çš„æ˜¯&lt;code>time.After&lt;/code>æ–¹æ³•ï¼Œå®ƒè¿”å›ä¸€ä¸ªç±»å‹ä¸º&lt;code>&amp;lt;-chan Time&lt;/code>çš„å•å‘çš„channelï¼Œåœ¨æŒ‡å®šçš„æ—¶é—´å‘é€ä¸€ä¸ªå½“å‰æ—¶é—´ç»™è¿”å›çš„channelä¸­ã€‚&lt;/p>
&lt;h2 id="timer-å’Œ-ticker">Timer å’Œ Ticker&lt;/h2>
&lt;p>æˆ‘ä»¬çœ‹ä¸€ä¸‹å…³äºæ—¶é—´çš„ä¸¤ä¸ªChannelã€‚
timeræ˜¯ä¸€ä¸ªå®šæ—¶å™¨ï¼Œä»£è¡¨æœªæ¥çš„ä¸€ä¸ªå•ä¸€äº‹ä»¶ï¼Œä½ å¯ä»¥å‘Šè¯‰timerä½ è¦ç­‰å¾…å¤šé•¿æ—¶é—´ï¼Œå®ƒæä¾›ä¸€ä¸ªChannelï¼Œåœ¨å°†æ¥çš„é‚£ä¸ªæ—¶é—´é‚£ä¸ªChannelæä¾›äº†ä¸€ä¸ªæ—¶é—´å€¼ã€‚ä¸‹é¢çš„ä¾‹å­ä¸­ç¬¬äºŒè¡Œä¼šé˜»å¡2ç§’é’Ÿå·¦å³çš„æ—¶é—´ï¼Œç›´åˆ°æ—¶é—´åˆ°äº†æ‰ä¼šç»§ç»­æ‰§è¡Œã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">timer1&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewTimer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">timer1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">C&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Timer 1 expired&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å½“ç„¶å¦‚æœä½ åªæ˜¯æƒ³å•çº¯çš„ç­‰å¾…çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨&lt;code>time.Sleep&lt;/code>æ¥å®ç°ã€‚&lt;/p>
&lt;p>ä½ è¿˜å¯ä»¥ä½¿ç”¨&lt;code>timer.Stop&lt;/code>æ¥åœæ­¢è®¡æ—¶å™¨ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">timer2&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewTimer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">timer2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">C&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Timer 2 expired&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}()&lt;/span>
&lt;span class="nx">stop2&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">timer2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Stop&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">stop2&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Timer 2 stopped&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>ticker&lt;/code>æ˜¯ä¸€ä¸ªå®šæ—¶è§¦å‘çš„è®¡æ—¶å™¨ï¼Œå®ƒä¼šä»¥ä¸€ä¸ªé—´éš”(interval)å¾€Channelå‘é€ä¸€ä¸ªäº‹ä»¶(å½“å‰æ—¶é—´)ï¼Œè€ŒChannelçš„æ¥æ”¶è€…å¯ä»¥ä»¥å›ºå®šçš„æ—¶é—´é—´éš”ä»Channelä¸­è¯»å–äº‹ä»¶ã€‚ä¸‹é¢çš„ä¾‹å­ä¸­tickeræ¯500æ¯«ç§’è§¦å‘ä¸€æ¬¡ï¼Œä½ å¯ä»¥è§‚å¯Ÿè¾“å‡ºçš„æ—¶é—´ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">ticker&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewTicker&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Millisecond&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">500&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">t&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">ticker&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">C&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Tick at&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">t&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}()&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç±»ä¼¼timer, tickerä¹Ÿå¯ä»¥é€šè¿‡&lt;code>Stop&lt;/code>æ–¹æ³•æ¥åœæ­¢ã€‚ä¸€æ—¦å®ƒåœæ­¢ï¼Œæ¥æ”¶è€…ä¸å†ä¼šä»channelä¸­æ¥æ”¶æ•°æ®äº†ã€‚&lt;/p>
&lt;h2 id="close">close&lt;/h2>
&lt;p>å†…å»ºçš„closeæ–¹æ³•å¯ä»¥ç”¨æ¥å…³é—­channelã€‚&lt;/p>
&lt;p>æ€»ç»“ä¸€ä¸‹channelå…³é—­åsenderçš„receiveræ“ä½œã€‚
å¦‚æœchannel cå·²ç»è¢«å…³é—­,ç»§ç»­å¾€å®ƒå‘é€æ•°æ®ä¼šå¯¼è‡´&lt;code>panic: send on closed channel&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">import&lt;/span> &lt;span class="s">&amp;#34;time&amp;#34;&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Hour&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}()&lt;/span>
&lt;span class="nx">c&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">c&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;span class="nx">c&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="mi">2&lt;/span>
&lt;span class="nb">close&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">c&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="mi">3&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä½†æ˜¯ä»è¿™ä¸ªå…³é—­çš„channelä¸­ä¸ä½†å¯ä»¥è¯»å–å‡ºå·²å‘é€çš„æ•°æ®ï¼Œè¿˜å¯ä»¥ä¸æ–­çš„è¯»å–é›¶å€¼:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">c&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">c&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;span class="nx">c&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="mi">2&lt;/span>
&lt;span class="nb">close&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">//1
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">//2
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">//0
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">//0
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä½†æ˜¯å¦‚æœé€šè¿‡&lt;code>range&lt;/code>è¯»å–ï¼Œchannelå…³é—­åforå¾ªç¯ä¼šè·³å‡ºï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">c&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">c&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;span class="nx">c&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="mi">2&lt;/span>
&lt;span class="nb">close&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">c&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€šè¿‡&lt;code>i, ok := &amp;lt;-c&lt;/code>å¯ä»¥æŸ¥çœ‹Channelçš„çŠ¶æ€ï¼Œåˆ¤æ–­å€¼æ˜¯é›¶å€¼è¿˜æ˜¯æ­£å¸¸è¯»å–çš„å€¼ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">c&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nb">close&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">c&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;%d, %t&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">//0, false
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="åŒæ­¥">åŒæ­¥&lt;/h2>
&lt;p>channelå¯ä»¥ç”¨åœ¨goroutineä¹‹é—´çš„åŒæ­¥ã€‚
ä¸‹é¢çš„ä¾‹å­ä¸­main goroutineé€šè¿‡done channelç­‰å¾…workerå®Œæˆä»»åŠ¡ã€‚ workeråšå®Œä»»åŠ¡ååªéœ€å¾€channelå‘é€ä¸€ä¸ªæ•°æ®å°±å¯ä»¥é€šçŸ¥main goroutineä»»åŠ¡å®Œæˆã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;time&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">worker&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">done&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="kt">bool&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// é€šçŸ¥ä»»åŠ¡å·²å®Œæˆ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">done&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">done&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kt">bool&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="nf">worker&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">done&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// ç­‰å¾…ä»»åŠ¡å®Œæˆ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">done&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>[å‚è€ƒèµ„æ–™]ï¼š&lt;/strong>&lt;/p>
&lt;ol>
&lt;li>&lt;a href="https://gobyexample.com/channels">https://gobyexample.com/channels&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://tour.golang.org/concurrency/2">https://tour.golang.org/concurrency/2&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://golang.org/ref/spec#Select_statements">https://golang.org/ref/spec#Select_statements&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/a8m/go-lang-cheat-sheet">https://github.com/a8m/go-lang-cheat-sheet&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://devs.cloudimmunity.com/gotchas-and-common-mistakes-in-go-golang/">http://devs.cloudimmunity.com/gotchas-and-common-mistakes-in-go-golang/&lt;/a>&lt;/li>
&lt;/ol></content><category scheme="https://yusank.github.io/categories/%E6%8A%80%E6%9C%AF/" term="æŠ€æœ¯" label="æŠ€æœ¯"/><category scheme="https://yusank.github.io/tags/go/" term="go" label="go"/><category scheme="https://yusank.github.io/tags/channel/" term="channel" label="channel"/></entry><entry><title type="text">æ–°çš„ç¯‡ç« </title><link rel="alternate" type="text/html" href="https://yusank.github.io/posts/my-first-post/"/><id>https://yusank.github.io/posts/my-first-post/</id><updated>2021-09-18T06:24:55+00:00</updated><published>2020-03-06T16:14:29+08:00</published><author><name>yusank</name><uri>https://yusank.github.io/</uri><email>yusankurban@gmail.com</email></author><summary type="html">ç”±äºä¸Šä¸€ä¸ªåšå®¢é¡¹ç›®çš„åŸæ–‡ä»¶ä¸¢å¤±ï¼Œæ— æ³•ç»§ç»­æ›´æ–°ï¼Œåªä¼šé‡æ–°å¼€å¯æ–°çš„åšå®¢é¡¹ç›®ï¼Œé‡æ–°åšèµ·â€¦â€¦</summary><content type="html">&lt;p>ç”±äºä¸Šä¸€ä¸ªåšå®¢é¡¹ç›®çš„åŸæ–‡ä»¶ä¸¢å¤±ï¼Œæ— æ³•ç»§ç»­æ›´æ–°ï¼Œåªä¼šé‡æ–°å¼€å¯æ–°çš„åšå®¢é¡¹ç›®ï¼Œé‡æ–°åšèµ·~&lt;/p>
&lt;p>æŠ€æœ¯åŸå› åŸåšå®¢å·²ä¸‹çº¿ï¼ŒåŸåšå®¢æŠ€æœ¯æ–‡æ¡£ä¼šé€æ­¥åŒæ­¥åˆ°æ–°åšå®¢ä¸Šã€‚&lt;/p></content></entry><entry><title type="text">Go Image</title><link rel="alternate" type="text/html" href="https://yusank.github.io/posts/go-image/"/><id>https://yusank.github.io/posts/go-image/</id><updated>2021-09-18T06:24:55+00:00</updated><published>2017-08-22T12:20:00+08:00</published><author><name>yusank</name><uri>https://yusank.github.io/</uri><email>yusankurban@gmail.com</email></author><summary type="html">ç”¨ GO å®ç°å›¾ç‰‡å¤„ç†å’Œæ–‡å­—åˆæˆ Go çš„å›¾ç‰‡å¤„ç† æœ€è¿‘éœ€è¦ä¸€ä¸ªåˆæˆæ˜ä¿¡ç‰‡çš„å·¥å…·ï¼Œå³å¾€èƒŒæ™¯å›¾çš„â€¦â€¦</summary><content type="html">&lt;p>ç”¨ GO å®ç°å›¾ç‰‡å¤„ç†å’Œæ–‡å­—åˆæˆ&lt;/p>
&lt;h1 id="go-çš„å›¾ç‰‡å¤„ç†">Go çš„å›¾ç‰‡å¤„ç†&lt;/h1>
&lt;p>æœ€è¿‘éœ€è¦ä¸€ä¸ªåˆæˆæ˜ä¿¡ç‰‡çš„å·¥å…·ï¼Œå³å¾€èƒŒæ™¯å›¾çš„å›ºå®šä½ç½®ä¸Šæ·»åŠ ä¸€ä¸ªå›¾ç‰‡å’Œä¸€æ®µæ–‡å­—ï¼Œ æœ€ååˆæˆä¸€å¼ å›¾ç‰‡ã€‚ç”±äºæ˜¯ go ç¨‹åºçš„ä¸€ä¸ªå­åŠŸèƒ½ï¼Œæ‰€ä»¥æˆ‘æƒ³æˆ‘åªåŠ æ‹¿ go å†™å¥½äº†ï¼Œæ­£å¥½æœ‰ go çš„ &lt;code>image&lt;/code> åº“ï¼Œæ‹¿æ¥ç»ƒç»ƒã€‚&lt;/p>
&lt;h2 id="å›¾ç‰‡åˆæˆ">å›¾ç‰‡åˆæˆ&lt;/h2>
&lt;p>å›¾ç‰‡åˆæˆæˆ‘ç”¨åˆ°äº†è¿™ä¸ªåº“ &lt;code>github.com/disintegration/imaging&lt;/code>&lt;/p>
&lt;p>ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;image&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/disintegration/imaging&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">HandleUserImage&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">fileName&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">m&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">imaging&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;target.jpg&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;open file failed&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">bm&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">imaging&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;bg.jpg&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;open file failed&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// å›¾ç‰‡æŒ‰æ¯”ä¾‹ç¼©æ”¾
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">dst&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">imaging&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Resize&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">200&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">200&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">imaging&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Lanczos&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// å°†å›¾ç‰‡ç²˜è´´åˆ°èƒŒæ™¯å›¾çš„å›ºå®šä½ç½®
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">result&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">imaging&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Overlay&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">bm&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">dst&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">image&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Pt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">120&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">140&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">fileName&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;%d.jpg&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fileName&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">imaging&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Save&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">result&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fileName&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">fileName&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä»¥ä¸Šæ˜¯å°† &lt;code>target.jpg&lt;/code> æ–‡ä»¶å…ˆè¿›è¡Œç¼©æ”¾ï¼Œå†è´´åˆ° &lt;code>bg.jpg&lt;/code> æ–‡ä»¶çš„ ï¼ˆ120ï¼Œ140ï¼‰ä½ç½®ï¼Œæœ€åä¿å­˜æˆæ–‡ä»¶ã€‚&lt;/p>
&lt;h2 id="å›¾ç‰‡ä¸Šå†™æ–‡å­—">å›¾ç‰‡ä¸Šå†™æ–‡å­—&lt;/h2>
&lt;p>ä»¥ä¸‹æ˜¯å†™æ–‡å­—å’Œè´´å›¾çš„ä¸€å—ç”¨çš„å®ä¾‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;span class="lnt">70
&lt;/span>&lt;span class="lnt">71
&lt;/span>&lt;span class="lnt">72
&lt;/span>&lt;span class="lnt">73
&lt;/span>&lt;span class="lnt">74
&lt;/span>&lt;span class="lnt">75
&lt;/span>&lt;span class="lnt">76
&lt;/span>&lt;span class="lnt">77
&lt;/span>&lt;span class="lnt">78
&lt;/span>&lt;span class="lnt">79
&lt;/span>&lt;span class="lnt">80
&lt;/span>&lt;span class="lnt">81
&lt;/span>&lt;span class="lnt">82
&lt;/span>&lt;span class="lnt">83
&lt;/span>&lt;span class="lnt">84
&lt;/span>&lt;span class="lnt">85
&lt;/span>&lt;span class="lnt">86
&lt;/span>&lt;span class="lnt">87
&lt;/span>&lt;span class="lnt">88
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;image&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;image/color&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;io/ioutil&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/disintegration/imaging&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/golang/freetype&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/golang/freetype/truetype&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;golang.org/x/image/font&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">HandleUserImage&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// HandleUserImage paste user image onto background
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">HandleUserImage&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">m&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">imaging&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;target.png&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;open file failed&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">bm&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">imaging&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;bg.jpg&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;open file failed&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// å›¾ç‰‡æŒ‰æ¯”ä¾‹ç¼©æ”¾
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">dst&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">imaging&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Resize&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">200&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">200&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">imaging&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Lanczos&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// å°†å›¾ç‰‡ç²˜è´´åˆ°èƒŒæ™¯å›¾çš„å›ºå®šä½ç½®
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">result&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">imaging&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Overlay&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">bm&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">dst&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">image&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Pt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">120&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">140&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nf">writeOnImage&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">result&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">fileName&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;%d.jpg&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1234&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">imaging&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Save&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">result&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">fileName&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">fileName&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">dpi&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">flag&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Float64&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;dpi&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">256&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;screen resolution&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">writeOnImage&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">target&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">image&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">NRGBA&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">c&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">freetype&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewContext&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetDPI&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">dpi&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetClip&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">target&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Bounds&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetDst&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">target&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetHinting&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">font&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">HintingFull&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// è®¾ç½®æ–‡å­—é¢œè‰²ã€å­—ä½“ã€å­—å¤§å°
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetSrc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">image&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewUniform&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">color&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RGBA&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">R&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">240&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">G&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">240&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">B&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">245&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">A&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">180&lt;/span>&lt;span class="p">}))&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetFontSize&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">16&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">fontFam&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">getFontFamily&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;get font family error&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetFont&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">fontFam&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">pt&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">freetype&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Pt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">500&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">400&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">DrawString&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;æˆ‘æ˜¯æ°´å°&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">pt&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;draw error: %v \n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">getFontFamily&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">truetype&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Font&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// è¿™é‡Œéœ€è¦è¯»å–ä¸­æ–‡å­—ä½“ï¼Œå¦åˆ™ä¸­æ–‡æ–‡å­—ä¼šå˜æˆæ–¹æ ¼
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">fontBytes&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">ioutil&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ReadFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Hei.ttc&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;read file error:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">truetype&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Font&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">f&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">freetype&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ParseFont&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">fontBytes&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;parse font error:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">truetype&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Font&lt;/span>&lt;span class="p">{},&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">f&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æœ€åæ¥ä¸€å¼ æ•ˆæœå›¾
&lt;img src="http://oid1xlj7h.bkt.clouddn.com/image/jpg/1234.jpg" alt="">&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>åšçš„è¿‡ç¨‹ä¸­ï¼Œåˆä½œè¿™ä¸€å—æ¯”è¾ƒå¥½åšï¼Œä½†æ˜¯å›¾ç‰‡ä¸Šå†™æ–‡å­—ï¼Œç›¸å¯¹æ¯”è¾ƒéº»çƒ¦ï¼Œè€Œä¸” &lt;code>freetype&lt;/code> åº“å¹¶æ²¡æœ‰é»˜è®¤çš„ä¸­è‹±æ–‡å­—ä½“ï¼Œå¦‚æœä¸æŒ‡å®šå­—ä½“ä¼šæŠ¥é”™ï¼Œè€Œä¸”å­—ä½“æ ¼å¼åªé™åˆ¶äº &lt;code>ttf&lt;/code> å’Œ &lt;code>ttc&lt;/code> ä¸¤ç§ã€‚&lt;/p></content><category scheme="https://yusank.github.io/categories/%E6%8A%80%E6%9C%AF/" term="æŠ€æœ¯" label="æŠ€æœ¯"/><category scheme="https://yusank.github.io/tags/go/" term="go" label="go"/><category scheme="https://yusank.github.io/tags/%E5%9B%BE%E7%89%87%E5%A4%84%E7%90%86/" term="å›¾ç‰‡å¤„ç†" label="å›¾ç‰‡å¤„ç†"/></entry><entry><title type="text">Go UDP Socket</title><link rel="alternate" type="text/html" href="https://yusank.github.io/posts/go-udp/"/><id>https://yusank.github.io/posts/go-udp/</id><updated>2021-09-18T06:24:55+00:00</updated><published>2017-08-02T19:00:01+08:00</published><author><name>yusank</name><uri>https://yusank.github.io/</uri><email>yusankurban@gmail.com</email></author><summary type="html">udp å’Œ tcp çš„ç®€å•æ¯”è¾ƒå’Œç”¨ go å®ç°æœ€ç®€å•çš„ udp å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ ...... ç”¨ go å®ç°ç®€å•çš„ udp ç”¨æˆ·æ•°æ®åŒ…åâ€¦â€¦</summary><content type="html">&lt;p>udp å’Œ tcp çš„ç®€å•æ¯”è¾ƒå’Œç”¨ go å®ç°æœ€ç®€å•çš„ udp å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ ......&lt;/p>
&lt;h1 id="ç”¨-go-å®ç°ç®€å•çš„-udp">ç”¨ go å®ç°ç®€å•çš„ udp&lt;/h1>
&lt;p>ç”¨æˆ·æ•°æ®åŒ…åè®®ï¼ˆè‹±è¯­ï¼šUser Datagram Protocolï¼Œç¼©å†™ä¸ºUDPï¼‰ï¼Œåˆç§°ç”¨æˆ·æ•°æ®æŠ¥æ–‡åè®®ï¼Œæ˜¯ä¸€ä¸ªç®€å•çš„é¢å‘æ•°æ®æŠ¥çš„ä¼ è¾“å±‚åè®®ï¼Œæ­£å¼è§„èŒƒä¸ºRFC 768ã€‚
åœ¨TCP/IPæ¨¡å‹ä¸­ï¼ŒUDPä¸ºç½‘ç»œå±‚ä»¥ä¸Šå’Œåº”ç”¨å±‚ä»¥ä¸‹æä¾›äº†ä¸€ä¸ªç®€å•çš„æ¥å£ã€‚UDPåªæä¾›æ•°æ®çš„ä¸å¯é ä¼ é€’ï¼Œå®ƒä¸€æ—¦æŠŠåº”ç”¨ç¨‹åºå‘ç»™ç½‘ç»œå±‚çš„æ•°æ®å‘é€å‡ºå»ï¼Œå°±ä¸ä¿ç•™æ•°æ®å¤‡ä»½ï¼ˆæ‰€ä»¥UDPæœ‰æ—¶å€™ä¹Ÿè¢«è®¤ä¸ºæ˜¯ä¸å¯é çš„æ•°æ®æŠ¥åè®®ï¼‰ã€‚UDPåœ¨IPæ•°æ®æŠ¥çš„å¤´éƒ¨ä»…ä»…åŠ å…¥äº†å¤ç”¨å’Œæ•°æ®æ ¡éªŒï¼ˆå­—æ®µï¼‰ã€‚&lt;/p>
&lt;h2 id="udp-ä¸-tcp-çš„æ¯”è¾ƒ">UDP ä¸ TCP çš„æ¯”è¾ƒ&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>UDP -- ç”¨æˆ·æ•°æ®åè®®åŒ…ï¼Œæ˜¯ä¸€ä¸ªç®€å•çš„é¢å‘æ•°æ®æŠ¥çš„è¿è¾“å±‚åè®®ã€‚UDP ä¸æä¾›å¯é æ€§ï¼Œå®ƒåªæ˜¯æŠŠåº”ç”¨ç¨‹åºç»™ IP å±‚çš„æ•°æ®æŠ¥å‘é€å‡ºå»ï¼Œä½†æ˜¯å¹¶ä¸èƒ½ä¿è¯ä»–ä»¬èƒ½è¾¾åˆ°ç›®çš„åœ°ã€‚ç”±äº UDP åœ¨ä¼ è¾“æ•°æ®æŠ¥ä¹‹å‰ä¸ç”¨åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¹‹é—´å»ºç«‹è¿æ¥ï¼Œä¸”æ²¡æœ‰è¶…æ—¶æœºåˆ¶ï¼Œæ•…è€Œä¼ è¾“é€Ÿåº¦å¾ˆå¿«ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>TCP -- ä¼ è¾“æ§åˆ¶åè®®ï¼Œæä¾›çš„æ˜¯é¢å‘è¿æ¥ï¼Œå¯é çš„å­—èŠ‚æµæœåŠ¡ã€‚å½“å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å½¼æ­¤äº¤æ¢æ•°æ®å‰ï¼Œå¿…é¡»å…ˆåœ¨åŒæ–¹ä¹‹é—´å»ºç«‹ TCP è¿æ¥ï¼Œä¹‹åæ‰èƒ½ä¼ è¾“æ•°æ®ã€‚TCP æä¾›è¶…æ—¶é‡å‘ï¼Œä¸¢å¼ƒé‡å¤æ•°æ®ï¼Œæ£€éªŒæ•°æ®ï¼Œæµé‡æ§åˆ¶ç­‰åŠŸèƒ½ï¼Œä¿è¯æ•°æ®èƒ½ä»ä¸€æ®µä¼ åˆ°å¦ä¸€ç«¯ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>-&lt;/th>
&lt;th>TCP&lt;/th>
&lt;th>UDP&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>æ˜¯å¦è¿æ¥&lt;/td>
&lt;td>é¢å‘è¿æ¥&lt;/td>
&lt;td>é¢å‘éè¿æ¥&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ä¼ è¾“å¯é æ€§&lt;/td>
&lt;td>å¯é &lt;/td>
&lt;td>ä¼šä¸¢åŒ…ï¼Œä¸å¯é &lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>åº”ç”¨åœºæ™¯&lt;/td>
&lt;td>ä¼ è¾“æ•°æ®é‡å¤§&lt;/td>
&lt;td>ä¼ è¾“æ•°æ®é‡å°&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>é€Ÿåº¦&lt;/td>
&lt;td>æ…¢&lt;/td>
&lt;td>å¿«&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h2 id="tcp-ä¸-udp-çš„é€‰æ‹©">TCP ä¸ UDP çš„é€‰æ‹©&lt;/h2>
&lt;p>å½“æ•°æ®ä¼ è¾“çš„æ€§èƒ½å¿…é¡»è®©ä½äºæ•°æ®ä¼ è¾“çš„å®Œæ•´æ€§ã€å¯æ§åˆ¶æ€§å’Œå¯é æ€§æ—¶ï¼ŒTCPåè®®æ˜¯å½“ç„¶çš„é€‰æ‹©ã€‚å½“å¼ºè°ƒä¼ è¾“æ€§èƒ½è€Œä¸æ˜¯ä¼ è¾“çš„å®Œæ•´æ€§æ—¶ï¼Œå¦‚ï¼šéŸ³é¢‘å’Œå¤šåª’ä½“åº”ç”¨ï¼ŒUDPæ˜¯æœ€å¥½çš„é€‰æ‹©ã€‚åœ¨æ•°æ®ä¼ è¾“æ—¶é—´å¾ˆçŸ­ï¼Œä»¥è‡³äºæ­¤å‰çš„è¿æ¥è¿‡ç¨‹æˆä¸ºæ•´ä¸ªæµé‡ä¸»ä½“çš„æƒ…å†µä¸‹ï¼ŒUDPä¹Ÿæ˜¯ä¸€ä¸ªå¥½çš„é€‰æ‹©ï¼Œå¦‚ï¼šDNSäº¤æ¢ã€‚æŠŠSNMPå»ºç«‹åœ¨UDPä¸Šçš„éƒ¨åˆ†åŸå› æ˜¯è®¾è®¡è€…è®¤ä¸ºå½“å‘ç”Ÿç½‘ç»œé˜»å¡æ—¶ï¼ŒUDPè¾ƒä½çš„å¼€é”€ä½¿å…¶æœ‰æ›´å¥½çš„æœºä¼šå»ä¼ é€ç®¡ç†æ•°æ®ã€‚TCPä¸°å¯Œçš„åŠŸèƒ½æœ‰æ—¶ä¼šå¯¼è‡´ä¸å¯é¢„æ–™çš„æ€§èƒ½ä½ä¸‹ï¼Œä½†æ˜¯æˆ‘ä»¬ç›¸ä¿¡åœ¨ä¸è¿œçš„å°†æ¥ï¼ŒTCPå¯é çš„ç‚¹å¯¹ç‚¹è¿æ¥å°†ä¼šç”¨äºç»å¤§å¤šæ•°çš„ç½‘ç»œåº”ç”¨ã€‚&lt;/p>
&lt;h2 id="udp-ä½¿ç”¨åœºæ™¯">UDP ä½¿ç”¨åœºæ™¯&lt;/h2>
&lt;p>åœ¨é€‰æ‹©ä½¿ç”¨åè®®çš„æ—¶å€™ï¼Œé€‰æ‹©UDPå¿…é¡»è¦è°¨æ…ã€‚åœ¨ç½‘ç»œè´¨é‡ä»¤äººååˆ†ä¸æ»¡æ„çš„ç¯å¢ƒä¸‹ï¼ŒUDPåè®®æ•°æ®åŒ…ä¸¢å¤±ä¼šæ¯”è¾ƒä¸¥é‡ã€‚ä½†æ˜¯ç”±äºUDPçš„ç‰¹æ€§ï¼šå®ƒä¸å±äºè¿æ¥å‹åè®®ï¼Œå› è€Œå…·æœ‰èµ„æºæ¶ˆè€—å°ï¼Œå¤„ç†é€Ÿåº¦å¿«çš„ä¼˜ç‚¹ï¼Œæ‰€ä»¥é€šå¸¸éŸ³é¢‘ã€è§†é¢‘å’Œæ™®é€šæ•°æ®åœ¨ä¼ é€æ—¶ä½¿ç”¨UDPè¾ƒå¤šï¼Œå› ä¸ºå®ƒä»¬å³ä½¿å¶å°”ä¸¢å¤±ä¸€ä¸¤ä¸ªæ•°æ®åŒ…ï¼Œä¹Ÿä¸ä¼šå¯¹æ¥æ”¶ç»“æœäº§ç”Ÿå¤ªå¤§å½±å“ã€‚è€Œä¸”å¦‚æœåœ¨å†…ç½‘çš„æƒ…å†µä¸‹ï¼Œä¸¢åŒ…ç‡ä¹Ÿå¾ˆä½ï¼Œæ‰€ä»¥å†…ç½‘çš„æ•°æ®ä¼ è¾“ä¹Ÿå¯ä»¥ç”¨ UDP åè®®ã€‚æˆ‘ä»¬å¸¸ç”¨çš„ QQï¼Œä¸€éƒ¨åˆ†æ•°æ®ä¼ è¾“åŠŸèƒ½ä¹Ÿæ˜¯ç”¨ UDPåè®®æ¥å®ç°çš„ã€‚&lt;/p>
&lt;h2 id="å®ç°">å®ç°&lt;/h2>
&lt;p>ä¸‹é¢åˆ†åˆ«æ˜¯æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯å®ç°ä»£ç ï¼š
æœåŠ¡ç«¯ä»£ç  &lt;code>server.go&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;net&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// è§£æåœ°å€
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">addr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ResolveUDPAddr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;udp&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;:3017&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Can&amp;#39;t resolve addr:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// ç›‘å¬ç«¯å£
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">conn&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ListenUDP&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;udp&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">addr&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;listen error:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">conn&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">handlerClient&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">conn&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">handlerClient&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">conn&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">UDPConn&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">data&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1024&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">// ä» UDP ä¸­è¯»å–å†…å®¹å¹¶å†™åˆ° data
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">remoteAddr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">conn&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ReadFromUDP&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">data&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;read udp msg failed with:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// ç»™æ”¶åˆ°æ¶ˆæ¯çš„ client å†™å›ä¿¡æ¯
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">conn&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WriteToUDP&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="nb">byte&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;a&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nx">remoteAddr&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å®¢æˆ·ç«¯ä»£ç &lt;code>client.go&lt;/code>ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">client&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;net&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="c1">// Connection *net.UDPConn
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Connection&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">UDPConn&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="c1">// Client åˆ›å»ºä¸€ä¸ª UDP è¿æ¥
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">Client&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">addr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ResolveUDPAddr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;udp&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;127.0.0.1:3017&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Can&amp;#39;t resolve address: &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">conn&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">DialUDP&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;udp&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">addr&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Can&amp;#39;t dial: &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">Connection&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">Connection&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">conn&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// WriteTo åƒä¼ å…¥å‚æ•° conn å†™æ•°æ®
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">WriteTo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">conn&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">UDPConn&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">conn&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Write&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="nb">byte&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;hello from the other site&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;failed:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">data&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1024&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">conn&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Read&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">data&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;failed to read UDP msg because of &amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>ä»¥ä¸Šæ˜¯ä¸€ä¸ªæœ€ç®€å•çš„ UDP å®¢æˆ·ç«¯æœåŠ¡å™¨çš„ä»£ç ï¼Œåªæœ‰å¯åŠ¨æœåŠ¡å’Œæ”¶å‘æ¶ˆæ¯çš„åŠŸèƒ½ï¼Œä½†å®é™…åº”ç”¨ UDP åè®®åˆ°å…·ä½“éœ€æ±‚çš„æ—¶å€™ï¼Œéœ€è¦è€ƒè™‘çš„é—®é¢˜å¾ˆå¤šï¼Œæ¯”å¦‚åŒ…çš„è®¾è®¡ï¼ŒåŒ…å¤´çš„è®¾è®¡ï¼Œé”™è¯¯å¤„ç†ï¼Œä¸¢åŒ…å¤„ç†ï¼ŒåŒ…é¡ºåºè°ƒæ¢å¤„ç†ç­‰ã€‚æ‰€ä»¥éœ€è¦ç”¨åˆ°ä¼ è¾“æ•°æ®åè®®çš„æ—¶å€™ï¼Œè¯·è€ƒè™‘å¥½éœ€æ±‚å’Œå¯èƒ½é‡åˆ°çš„é—®é¢˜ï¼Œä»¥åŠå¯¹é—®é¢˜çš„å¤„ç†æ–¹æ¡ˆã€‚&lt;/p></content><category scheme="https://yusank.github.io/categories/%E6%8A%80%E6%9C%AF/" term="æŠ€æœ¯" label="æŠ€æœ¯"/><category scheme="https://yusank.github.io/tags/go/" term="go" label="go"/><category scheme="https://yusank.github.io/tags/udp/" term="udp" label="udp"/><category scheme="https://yusank.github.io/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" term="ç½‘ç»œç¼–ç¨‹" label="ç½‘ç»œç¼–ç¨‹"/></entry><entry><title type="text">Go TCP Socket</title><link rel="alternate" type="text/html" href="https://yusank.github.io/posts/go-tcp/"/><id>https://yusank.github.io/posts/go-tcp/</id><updated>2021-09-18T06:24:55+00:00</updated><published>2017-07-31T10:00:01+08:00</published><author><name>yusank</name><uri>https://yusank.github.io/</uri><email>yusankurban@gmail.com</email></author><summary type="html">è½¬è½½æ–‡ç«  Goè¯­è¨€TCP Socketç¼–ç¨‹ æ–‡ç« åŸå§‹åœ°å€: http://tonybai.com/2015/11/17/tcp-programming-in-golang/ Golangçš„ä¸»è¦ è®¾è®¡ç›®æ ‡â€¦â€¦</summary><content type="html">&lt;p>&lt;code>è½¬è½½æ–‡ç« &lt;/code>&lt;/p>
&lt;h1 id="goè¯­è¨€tcp-socketç¼–ç¨‹">Goè¯­è¨€TCP Socketç¼–ç¨‹&lt;/h1>
&lt;p>&lt;strong>æ–‡ç« åŸå§‹åœ°å€:&lt;/strong> &lt;a href="http://tonybai.com/2015/11/17/tcp-programming-in-golang/">http://tonybai.com/2015/11/17/tcp-programming-in-golang/&lt;/a>&lt;/p>
&lt;p>&lt;a href="http://tonybai.com/tag/go">Golang&lt;/a>çš„ä¸»è¦ è®¾è®¡ç›®æ ‡ä¹‹ä¸€å°±æ˜¯é¢å‘å¤§è§„æ¨¡åç«¯æœåŠ¡ç¨‹åºï¼Œç½‘ç»œé€šä¿¡è¿™å—æ˜¯æœåŠ¡ç«¯ ç¨‹åºå¿…ä¸å¯å°‘ä¹Ÿæ˜¯è‡³å…³é‡è¦çš„ä¸€éƒ¨åˆ†ã€‚åœ¨æ—¥å¸¸åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°Goä¸­çš„netä»¥åŠå…¶subdirectoriesä¸‹çš„åŒ…å‡æ˜¯â€œé«˜é¢‘+åˆšéœ€â€ï¼Œè€ŒTCP socketåˆ™æ˜¯ç½‘ç»œç¼–ç¨‹çš„ä¸»æµï¼Œå³ä¾¿æ‚¨æ²¡æœ‰ç›´æ¥ä½¿ç”¨åˆ°netä¸­æœ‰å…³TCP Socketæ–¹é¢çš„æ¥å£ï¼Œä½†net/httpæ€»æ˜¯ç”¨åˆ°äº†å§ï¼Œhttpåº•å±‚ä¾æ—§æ˜¯ç”¨tcp socketå®ç°çš„ã€‚&lt;/p>
&lt;p>ç½‘ç»œç¼–ç¨‹æ–¹é¢ï¼Œæˆ‘ä»¬æœ€å¸¸ç”¨çš„å°±æ˜¯tcp socketç¼–ç¨‹äº†ï¼Œåœ¨posixæ ‡å‡†å‡ºæ¥åï¼Œsocketåœ¨å„å¤§ä¸»æµOSå¹³å°ä¸Šéƒ½å¾—åˆ°äº†å¾ˆå¥½çš„æ”¯æŒã€‚å…³äºtcp programmingï¼Œæœ€å¥½çš„èµ„æ–™è«è¿‡äº&lt;a href="http://en.wikipedia.org/wiki/W._Richard_Stevens">W. Richard Stevens&lt;/a> çš„ç½‘ç»œç¼–ç¨‹åœ£ç»ã€Š&lt;a href="http://book.douban.com/subject/4859464/">UNIXç½‘ç»œ ç¼–ç¨‹ å·1ï¼šå¥—æ¥å­—è”ç½‘API&lt;/a>ã€‹ äº†ï¼Œä¹¦ä¸­å…³äºtcp socketæ¥å£çš„å„ç§ä½¿ç”¨ã€è¡Œä¸ºæ¨¡å¼ã€å¼‚å¸¸å¤„ç†è®²è§£çš„ååˆ†ç»†è‡´ã€‚Goæ˜¯è‡ªå¸¦runtimeçš„è·¨å¹³å°ç¼–ç¨‹è¯­è¨€ï¼ŒGoä¸­æš´éœ²ç»™è¯­è¨€ä½¿ç”¨è€…çš„tcp socket apiæ˜¯å»ºç«‹OSåŸç”Ÿtcp socketæ¥å£ä¹‹ä¸Šçš„ã€‚ç”±äºGo runtimeè°ƒåº¦çš„éœ€è¦ï¼Œgolang tcp socketæ¥å£åœ¨è¡Œä¸ºç‰¹ç‚¹ä¸å¼‚å¸¸å¤„ç†æ–¹é¢ä¸OSåŸç”Ÿæ¥å£æœ‰ç€ä¸€äº›å·®åˆ«ã€‚è¿™ç¯‡åšæ–‡çš„ç›®æ ‡å°±æ˜¯æ•´ç†å‡ºå…³äºGo tcp socketåœ¨å„ä¸ªåœºæ™¯ä¸‹çš„ä½¿ç”¨æ–¹æ³•ã€è¡Œä¸ºç‰¹ç‚¹ä»¥åŠæ³¨æ„äº‹é¡¹ã€‚&lt;/p>
&lt;h2 id="ä¸€æ¨¡å‹">ä¸€ã€æ¨¡å‹&lt;/h2>
&lt;p>ä»tcp socketè¯ç”Ÿåï¼Œç½‘ç»œç¼–ç¨‹æ¶æ„æ¨¡å‹ä¹Ÿå‡ ç»æ¼”åŒ–ï¼Œå¤§è‡´æ˜¯ï¼šâ€œæ¯è¿›ç¨‹ä¸€ä¸ªè¿æ¥â€ â€“&amp;gt; â€œæ¯çº¿ç¨‹ä¸€ä¸ªè¿æ¥â€ â€“&amp;gt; â€œNon-Block + I/Oå¤šè·¯å¤ç”¨(linux epoll/windows iocp/freebsd darwin kqueue/solaris Event Port)â€ã€‚ä¼´éšç€æ¨¡å‹çš„æ¼”åŒ–ï¼ŒæœåŠ¡ç¨‹åºæ„ˆåŠ å¼ºå¤§ï¼Œå¯ä»¥æ”¯æŒæ›´å¤šçš„è¿æ¥ï¼Œè·å¾—æ›´å¥½çš„å¤„ç†æ€§èƒ½ã€‚&lt;/p>
&lt;p>ç›®å‰ä¸»æµweb serverä¸€èˆ¬å‡é‡‡ç”¨çš„éƒ½æ˜¯â€Non-Block + I/Oå¤šè·¯å¤ç”¨â€ï¼ˆæœ‰çš„ä¹Ÿç»“åˆäº†å¤šçº¿ç¨‹ã€å¤šè¿›ç¨‹ï¼‰ã€‚ä¸è¿‡I/Oå¤šè·¯å¤ç”¨ä¹Ÿç»™ä½¿ç”¨è€…å¸¦æ¥äº†ä¸å°çš„å¤æ‚åº¦ï¼Œä»¥è‡³äºåç»­å‡ºç°äº†è®¸å¤šé«˜æ€§èƒ½çš„I/Oå¤šè·¯å¤ç”¨æ¡†æ¶ï¼Œ æ¯”å¦‚&lt;a href="http://libevent.org/">libevent&lt;/a>ã€&lt;a href="http://software.schmorp.de/pkg/libev.html">libev&lt;/a>ã€&lt;a href="https://github.com/joyent/libuv">libuv&lt;/a>ç­‰ï¼Œä»¥å¸®åŠ©å¼€å‘è€…ç®€åŒ–å¼€å‘å¤æ‚æ€§ï¼Œé™ä½å¿ƒæ™ºè´Ÿæ‹…ã€‚ä¸è¿‡Goçš„è®¾è®¡è€…ä¼¼ä¹è®¤ä¸ºI/Oå¤šè·¯å¤ç”¨çš„è¿™ç§é€šè¿‡å›è°ƒæœºåˆ¶å‰²è£‚æ§åˆ¶æµ çš„æ–¹å¼ä¾æ—§å¤æ‚ï¼Œä¸”æœ‰æ‚–äºâ€œä¸€èˆ¬é€»è¾‘â€è®¾è®¡ï¼Œä¸ºæ­¤Goè¯­è¨€å°†è¯¥â€œå¤æ‚æ€§â€éšè—åœ¨Runtimeä¸­äº†ï¼šGoå¼€å‘è€…æ— éœ€å…³æ³¨socketæ˜¯å¦æ˜¯ non-blockçš„ï¼Œä¹Ÿæ— éœ€äº²è‡ªæ³¨å†Œæ–‡ä»¶æè¿°ç¬¦çš„å›è°ƒï¼Œåªéœ€åœ¨æ¯ä¸ªè¿æ¥å¯¹åº”çš„goroutineä¸­ä»¥**â€œblock I/Oâ€**çš„æ–¹å¼å¯¹å¾…socketå¤„ç†å³å¯ï¼Œè¿™å¯ä»¥è¯´å¤§å¤§é™ä½äº†å¼€å‘äººå‘˜çš„å¿ƒæ™ºè´Ÿæ‹…ã€‚ä¸€ä¸ªå…¸å‹çš„Go serverç«¯ç¨‹åºå¤§è‡´å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//go-tcpsock/server.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">handleConn&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="nx">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Conn&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// read from the connection
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// ... ...
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// write to the connection
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//... ...
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">l&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Listen&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;tcp&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;:8888&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;listen error:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">l&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Accept&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;accept error:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">break&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// start a new goroutine to handle
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// the new connection.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">go&lt;/span> &lt;span class="nf">handleConn&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç”¨æˆ·å±‚çœ¼ä¸­çœ‹åˆ°çš„goroutineä¸­çš„â€œblock socketâ€ï¼Œå®é™…ä¸Šæ˜¯é€šè¿‡Go runtimeä¸­çš„netpolleré€šè¿‡Non-block socket + I/Oå¤šè·¯å¤ç”¨æœºåˆ¶â€œæ¨¡æ‹Ÿâ€å‡ºæ¥çš„ï¼ŒçœŸå®çš„underlying socketå®é™…ä¸Šæ˜¯non-blockçš„ï¼Œåªæ˜¯runtimeæ‹¦æˆªäº†åº•å±‚socketç³»ç»Ÿè°ƒç”¨çš„é”™è¯¯ç ï¼Œå¹¶é€šè¿‡netpollerå’Œgoroutine è°ƒåº¦è®©goroutineâ€œé˜»å¡â€åœ¨ç”¨æˆ·å±‚å¾—åˆ°çš„Socket fdä¸Šã€‚æ¯”å¦‚ï¼šå½“ç”¨æˆ·å±‚é’ˆå¯¹æŸä¸ªsocket fdå‘èµ·readæ“ä½œæ—¶ï¼Œå¦‚æœè¯¥socket fdä¸­å°šæ— æ•°æ®ï¼Œé‚£ä¹ˆruntimeä¼šå°†è¯¥socket fdåŠ å…¥åˆ°netpollerä¸­ç›‘å¬ï¼ŒåŒæ—¶å¯¹åº”çš„goroutineè¢«æŒ‚èµ·ï¼Œç›´åˆ°runtimeæ”¶åˆ°socket fd æ•°æ®readyçš„é€šçŸ¥ï¼Œruntimeæ‰ä¼šé‡æ–°å”¤é†’ç­‰å¾…åœ¨è¯¥socket fdä¸Šå‡†å¤‡readçš„é‚£ä¸ªGoroutineã€‚è€Œè¿™ä¸ªè¿‡ç¨‹ä»Goroutineçš„è§†è§’æ¥çœ‹ï¼Œå°±åƒæ˜¯readæ“ä½œä¸€ç›´blockåœ¨é‚£ä¸ªsocket fdä¸Šä¼¼çš„ã€‚å…·ä½“å®ç°ç»†èŠ‚åœ¨åç»­åœºæ™¯ä¸­ä¼šæœ‰è¡¥å……æè¿°ã€‚&lt;/p>
&lt;h2 id="äºŒtcpè¿æ¥çš„å»ºç«‹">äºŒã€TCPè¿æ¥çš„å»ºç«‹&lt;/h2>
&lt;p>ä¼—æ‰€å‘¨çŸ¥ï¼ŒTCP Socketçš„è¿æ¥çš„å»ºç«‹éœ€è¦ç»å†å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„ä¸‰æ¬¡æ¡æ‰‹çš„è¿‡ç¨‹ã€‚è¿æ¥å»ºç«‹è¿‡ç¨‹ä¸­ï¼ŒæœåŠ¡ç«¯æ˜¯ä¸€ä¸ªæ ‡å‡†çš„Listen + Acceptçš„ç»“æ„(å¯å‚è€ƒä¸Šé¢çš„ä»£ç )ï¼Œè€Œåœ¨å®¢æˆ·ç«¯Goè¯­è¨€ä½¿ç”¨net.Dialæˆ–DialTimeoutè¿›è¡Œè¿æ¥å»ºç«‹ï¼š&lt;/p>
&lt;p>é˜»å¡Dialï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">conn&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Dial&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;tcp&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;google.com:80&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">//handle error
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="c1">// read or write on conn
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æˆ–æ˜¯å¸¦ä¸Šè¶…æ—¶æœºåˆ¶çš„Dialï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">conn&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">DialTimeout&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;tcp&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;:8080&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">//handle error
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="c1">// read or write on conn
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯¹äºå®¢æˆ·ç«¯è€Œè¨€ï¼Œè¿æ¥çš„å»ºç«‹ä¼šé‡åˆ°å¦‚ä¸‹å‡ ç§æƒ…å½¢ï¼š&lt;/p>
&lt;h3 id="1ç½‘ç»œä¸å¯è¾¾æˆ–å¯¹æ–¹æœåŠ¡æœªå¯åŠ¨">1ã€ç½‘ç»œä¸å¯è¾¾æˆ–å¯¹æ–¹æœåŠ¡æœªå¯åŠ¨&lt;/h3>
&lt;p>å¦‚æœä¼ ç»™Dialçš„Addræ˜¯å¯ä»¥ç«‹å³åˆ¤æ–­å‡ºç½‘ç»œä¸å¯è¾¾ï¼Œæˆ–è€…Addrä¸­ç«¯å£å¯¹åº”çš„æœåŠ¡æ²¡æœ‰å¯åŠ¨ï¼Œç«¯å£æœªè¢«ç›‘å¬ï¼ŒDialä¼šå‡ ä¹ç«‹å³è¿”å›é”™è¯¯ï¼Œæ¯”å¦‚ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//go-tcpsock/conn_establish/client1.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="o">...&lt;/span> &lt;span class="o">...&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;begin dial...&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">conn&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Dial&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;tcp&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;:8888&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;dial error:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">conn&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;dial ok&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœæœ¬æœº8888ç«¯å£æœªæœ‰æœåŠ¡ç¨‹åºç›‘å¬ï¼Œé‚£ä¹ˆæ‰§è¡Œä¸Šé¢ç¨‹åºï¼ŒDialä¼šå¾ˆå¿«è¿”å›é”™è¯¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="nv">$go&lt;/span> run client1.go
2015/11/16 14:37:41 begin dial...
2015/11/16 14:37:41 dial error: dial tcp :8888: getsockopt: connection refused
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="2å¯¹æ–¹æœåŠ¡çš„listen-backlogæ»¡">2ã€å¯¹æ–¹æœåŠ¡çš„listen backlogæ»¡&lt;/h3>
&lt;p>è¿˜æœ‰ä¸€ç§åœºæ™¯å°±æ˜¯å¯¹æ–¹æœåŠ¡å™¨å¾ˆå¿™ï¼Œç¬é—´æœ‰å¤§é‡clientç«¯è¿æ¥å°è¯•å‘serverå»ºç«‹ï¼Œserverç«¯çš„listen backlogé˜Ÿåˆ—æ»¡ï¼Œserver acceptä¸åŠæ—¶((å³ä¾¿ä¸acceptï¼Œé‚£ä¹ˆåœ¨backlogæ•°é‡èŒƒç•´é‡Œé¢ï¼Œconnectéƒ½ä¼šæ˜¯æˆåŠŸçš„ï¼Œå› ä¸ºnew connå·²ç»åŠ å…¥åˆ°server sideçš„listen queueä¸­äº†ï¼Œacceptåªæ˜¯ä»queueä¸­å–å‡ºä¸€ä¸ªconnè€Œå·²)ï¼Œè¿™å°†å¯¼è‡´clientç«¯Dialé˜»å¡ã€‚æˆ‘ä»¬è¿˜æ˜¯é€šè¿‡ä¾‹å­æ„Ÿå—Dialçš„è¡Œä¸ºç‰¹ç‚¹ï¼š&lt;/p>
&lt;p>æœåŠ¡ç«¯ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//go-tcpsock/conn_establish/server2.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="o">...&lt;/span> &lt;span class="o">...&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">l&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Listen&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;tcp&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;:8888&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;error listen:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">l&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;listen ok&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">l&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Accept&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;accept error:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">break&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;%d: accept a new connection\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å®¢æˆ·ç«¯ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//go-tcpsock/conn_establish/client2.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="o">...&lt;/span> &lt;span class="o">...&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">establishConn&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">i&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Conn&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">conn&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Dial&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;tcp&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;:8888&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;%d: dial error: %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;:connect to server ok&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">conn&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">sl&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Conn&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="mi">1000&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">conn&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">establishConn&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">conn&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">sl&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">sl&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">conn&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">10000&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä»ç¨‹åºå¯ä»¥çœ‹å‡ºï¼ŒæœåŠ¡ç«¯åœ¨listenæˆåŠŸåï¼Œæ¯éš”10sé’Ÿacceptä¸€æ¬¡ã€‚å®¢æˆ·ç«¯åˆ™æ˜¯ä¸²è¡Œçš„å°è¯•å»ºç«‹è¿æ¥ã€‚è¿™ä¸¤ä¸ªç¨‹åºåœ¨Darwinä¸‹çš„æ‰§è¡Œ ç»“æœï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="nv">$go&lt;/span> run server2.go
2015/11/16 21:55:41 listen ok
2015/11/16 21:55:51 1: accept a new connection
2015/11/16 21:56:01 2: accept a new connection
... ...
&lt;span class="nv">$go&lt;/span> run client2.go
2015/11/16 21:55:44 &lt;span class="m">1&lt;/span> :connect to server ok
2015/11/16 21:55:44 &lt;span class="m">2&lt;/span> :connect to server ok
2015/11/16 21:55:44 &lt;span class="m">3&lt;/span> :connect to server ok
... ...
2015/11/16 21:55:44 &lt;span class="m">126&lt;/span> :connect to server ok
2015/11/16 21:55:44 &lt;span class="m">127&lt;/span> :connect to server ok
2015/11/16 21:55:44 &lt;span class="m">128&lt;/span> :connect to server ok
2015/11/16 21:55:52 &lt;span class="m">129&lt;/span> :connect to server ok
2015/11/16 21:56:03 &lt;span class="m">130&lt;/span> :connect to server ok
2015/11/16 21:56:14 &lt;span class="m">131&lt;/span> :connect to server ok
... ...
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯ä»¥çœ‹å‡ºClientåˆå§‹æ—¶æˆåŠŸåœ°ä¸€æ¬¡æ€§å»ºç«‹äº†128ä¸ªè¿æ¥ï¼Œç„¶ååç»­æ¯é˜»å¡è¿‘10sæ‰èƒ½æˆåŠŸå»ºç«‹ä¸€æ¡è¿æ¥ã€‚ä¹Ÿå°±æ˜¯è¯´åœ¨serverç«¯ backlogæ»¡æ—¶(æœªåŠæ—¶accept)ï¼Œå®¢æˆ·ç«¯å°†é˜»å¡åœ¨Dialä¸Šï¼Œç›´åˆ°serverç«¯è¿›è¡Œä¸€æ¬¡acceptã€‚è‡³äºä¸ºä»€ä¹ˆæ˜¯128ï¼Œè¿™ä¸darwin ä¸‹çš„é»˜è®¤è®¾ç½®æœ‰å…³ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="nv">$sysctl&lt;/span> -a&lt;span class="p">|&lt;/span>grep kern.ipc.somaxconn
kern.ipc.somaxconn: &lt;span class="m">128&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœæˆ‘åœ¨ubuntu 14.04ä¸Šè¿è¡Œä¸Šè¿°serverç¨‹åºï¼Œæˆ‘ä»¬çš„clientç«¯åˆå§‹å¯ä»¥æˆåŠŸå»ºç«‹499æ¡è¿æ¥ã€‚&lt;/p>
&lt;p>å¦‚æœserverä¸€ç›´ä¸acceptï¼Œclientç«¯ä¼šä¸€ç›´é˜»å¡ä¹ˆï¼Ÿæˆ‘ä»¬å»æ‰acceptåçš„ç»“æœæ˜¯ï¼šåœ¨Darwinä¸‹ï¼Œclientç«¯ä¼šé˜»å¡å¤§ çº¦1åˆ†å¤šé’Ÿæ‰ä¼šè¿”å›timeoutï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">2015/11/16 22:03:31 &lt;span class="m">128&lt;/span> :connect to server ok
2015/11/16 22:04:48 129: dial error: dial tcp :8888: getsockopt: operation timed out
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è€Œå¦‚æœserverè¿è¡Œåœ¨ubuntu 14.04ä¸Šï¼Œclientä¼¼ä¹ä¸€ç›´é˜»å¡ï¼Œæˆ‘ç­‰äº†10å¤šåˆ†é’Ÿä¾æ—§æ²¡æœ‰è¿”å›ã€‚ é˜»å¡ä¸å¦çœ‹æ¥ä¸serverç«¯çš„ç½‘ç»œå®ç°å’Œè®¾ç½®æœ‰å…³ã€‚&lt;/p>
&lt;h3 id="3ç½‘ç»œå»¶è¿Ÿè¾ƒå¤§dialé˜»å¡å¹¶è¶…æ—¶">3ã€ç½‘ç»œå»¶è¿Ÿè¾ƒå¤§ï¼ŒDialé˜»å¡å¹¶è¶…æ—¶&lt;/h3>
&lt;p>å¦‚æœç½‘ç»œå»¶è¿Ÿè¾ƒå¤§ï¼ŒTCPæ¡æ‰‹è¿‡ç¨‹å°†æ›´åŠ è‰°éš¾åå·ï¼ˆå„ç§ä¸¢åŒ…ï¼‰ï¼Œæ—¶é—´æ¶ˆè€—çš„è‡ªç„¶ä¹Ÿä¼šæ›´é•¿ã€‚Dialè¿™æ—¶ä¼šé˜»å¡ï¼Œå¦‚æœé•¿æ—¶é—´ä¾æ—§æ— æ³•å»ºç«‹è¿æ¥ï¼Œåˆ™Dialä¹Ÿä¼šè¿”å›â€œ getsockopt: operation timed outâ€é”™è¯¯ã€‚&lt;/p>
&lt;p>åœ¨è¿æ¥å»ºç«‹é˜¶æ®µï¼Œå¤šæ•°æƒ…å†µä¸‹ï¼ŒDialæ˜¯å¯ä»¥æ»¡è¶³éœ€æ±‚çš„ï¼Œå³ä¾¿é˜»å¡ä¸€å°ä¼šå„¿ã€‚ä½†å¯¹äºæŸäº›ç¨‹åºè€Œè¨€ï¼Œéœ€è¦æœ‰ä¸¥æ ¼çš„è¿æ¥æ—¶é—´é™å®šï¼Œå¦‚æœä¸€å®šæ—¶é—´å†…æ²¡èƒ½æˆåŠŸå»ºç«‹è¿æ¥ï¼Œç¨‹åºå¯èƒ½ä¼šéœ€è¦æ‰§è¡Œä¸€æ®µâ€œå¼‚å¸¸â€å¤„ç†é€»è¾‘ï¼Œä¸ºæ­¤æˆ‘ä»¬å°±éœ€è¦DialTimeoutäº†ã€‚ä¸‹é¢çš„ä¾‹å­å°†Dialçš„æœ€é•¿é˜»å¡æ—¶é—´é™åˆ¶åœ¨2så†…ï¼Œè¶…å‡ºè¿™ä¸ªæ—¶é•¿ï¼ŒDialå°†è¿”å›timeout errorï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//go-tcpsock/conn_establish/client3.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="o">...&lt;/span> &lt;span class="o">...&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;begin dial...&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">conn&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">DialTimeout&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;tcp&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;104.236.176.96:80&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;dial error:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">conn&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;dial ok&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼ˆéœ€è¦æ¨¡æ‹Ÿä¸€ä¸ªå»¶è¿Ÿè¾ƒå¤§çš„ç½‘ç»œç¯å¢ƒï¼‰ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="nv">$go&lt;/span> run client3.go
2015/11/17 09:28:34 begin dial...
2015/11/17 09:28:36 dial error: dial tcp 104.236.176.96:80: i/o timeout
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="ä¸‰socketè¯»å†™">ä¸‰ã€Socketè¯»å†™&lt;/h2>
&lt;p>è¿æ¥å»ºç«‹èµ·æ¥åï¼Œæˆ‘ä»¬å°±è¦åœ¨connä¸Šè¿›è¡Œè¯»å†™ï¼Œä»¥å®Œæˆä¸šåŠ¡é€»è¾‘ã€‚å‰é¢è¯´è¿‡Go runtimeéšè—äº†I/Oå¤šè·¯å¤ç”¨çš„å¤æ‚æ€§ã€‚è¯­è¨€ä½¿ç”¨è€…åªéœ€é‡‡ç”¨goroutine+Block I/Oçš„æ¨¡å¼å³å¯æ»¡è¶³å¤§éƒ¨åˆ†åœºæ™¯éœ€æ±‚ã€‚DialæˆåŠŸåï¼Œæ–¹æ³•è¿”å›ä¸€ä¸ªnet.Connæ¥å£ç±»å‹å˜é‡å€¼ï¼Œè¿™ä¸ªæ¥å£å˜é‡çš„åŠ¨æ€ç±»å‹ä¸ºä¸€ä¸ª*TCPConnï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//$GOROOT/src/net/tcpsock_posix.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">TCPConn&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">conn&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>TCPConnå†…åµŒäº†ä¸€ä¸ªunexportedç±»å‹ï¼šconnï¼Œå› æ­¤TCPConnâ€ç»§æ‰¿â€äº†connçš„Readå’ŒWriteæ–¹æ³•ï¼Œåç»­é€šè¿‡Dialè¿”å›å€¼è°ƒç”¨çš„Writeå’ŒReadæ–¹æ³•å‡æ˜¯net.connçš„æ–¹æ³•ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//$GOROOT/src/net/net.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">conn&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fd&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">netFD&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">conn&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">ok&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">bool&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="nx">c&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">fd&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="c1">// Implementation of the Conn interface.
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="c1">// Read implements the Conn Read method.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">conn&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Read&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">b&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ok&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">syscall&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">EINVAL&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">fd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Read&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">b&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="nx">io&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">EOF&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">OpError&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">Op&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;read&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">Net&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">fd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">net&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">Source&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">fd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">laddr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">Addr&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">fd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">raddr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">Err&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// Write implements the Conn Write method.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">conn&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">b&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">ok&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">syscall&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">EINVAL&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">fd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">b&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">OpError&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">Op&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;write&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">Net&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">fd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">net&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">Source&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">fd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">laddr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">Addr&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">fd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">raddr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">Err&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¸‹é¢æˆ‘ä»¬å…ˆæ¥é€šè¿‡å‡ ä¸ªåœºæ™¯æ¥æ€»ç»“ä¸€ä¸‹conn.Readçš„è¡Œä¸ºç‰¹ç‚¹ã€‚&lt;/p>
&lt;h3 id="1socketä¸­æ— æ•°æ®">1ã€Socketä¸­æ— æ•°æ®&lt;/h3>
&lt;p>è¿æ¥å»ºç«‹åï¼Œå¦‚æœå¯¹æ–¹æœªå‘é€æ•°æ®åˆ°socketï¼Œæ¥æ”¶æ–¹(Server)ä¼šé˜»å¡åœ¨Readæ“ä½œä¸Šï¼Œè¿™å’Œå‰é¢æåˆ°çš„â€œæ¨¡å‹â€åŸç†æ˜¯ä¸€è‡´çš„ã€‚æ‰§è¡Œè¯¥Readæ“ä½œçš„goroutineä¹Ÿä¼šè¢«æŒ‚èµ·ã€‚runtimeä¼šç›‘è§†è¯¥socketï¼Œç›´åˆ°å…¶æœ‰æ•°æ®æ‰ä¼šé‡æ–°
è°ƒåº¦è¯¥socketå¯¹åº”çš„Goroutineå®Œæˆreadã€‚ç”±äºç¯‡å¹…åŸå› ï¼Œè¿™é‡Œå°±ä¸åˆ—ä»£ç äº†ï¼Œä¾‹å­å¯¹åº”çš„ä»£ç æ–‡ä»¶ï¼šgo-tcpsock/read_writeä¸‹çš„client1.goå’Œserver1.goã€‚&lt;/p>
&lt;h3 id="2socketä¸­æœ‰éƒ¨åˆ†æ•°æ®">2ã€Socketä¸­æœ‰éƒ¨åˆ†æ•°æ®&lt;/h3>
&lt;p>å¦‚æœsocketä¸­æœ‰éƒ¨åˆ†æ•°æ®ï¼Œä¸”é•¿åº¦å°äºä¸€æ¬¡Readæ“ä½œæ‰€æœŸæœ›è¯»å‡ºçš„æ•°æ®é•¿åº¦ï¼Œé‚£ä¹ˆReadå°†ä¼šæˆåŠŸè¯»å‡ºè¿™éƒ¨åˆ†æ•°æ®å¹¶è¿”å›ï¼Œè€Œä¸æ˜¯ç­‰å¾…æ‰€æœ‰æœŸæœ›æ•°æ®å…¨éƒ¨è¯»å–åå†è¿”å›ã€‚&lt;/p>
&lt;p>Clientç«¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//go-tcpsock/read_write/client2.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="o">...&lt;/span> &lt;span class="o">...&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Args&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;usage: go run client2.go YOUR_CONTENT&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;begin dial...&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">conn&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Dial&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;tcp&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;:8888&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;dial error:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">conn&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;dial ok&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">data&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Args&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="nx">conn&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Write&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="nb">byte&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">data&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">10000&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Serverç«¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//go-tcpsock/read_write/server2.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="o">...&lt;/span> &lt;span class="o">...&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">handleConn&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="nx">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Conn&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// read from the connection
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">var&lt;/span> &lt;span class="nx">buf&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;start to read from conn&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Read&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;conn read error:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;read %d bytes, content is %s\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">string&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">[:&lt;/span>&lt;span class="nx">n&lt;/span>&lt;span class="p">]))&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="o">...&lt;/span> &lt;span class="o">...&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æˆ‘ä»¬é€šè¿‡&lt;code>client2.go&lt;/code>å‘é€â€hiâ€åˆ°Serverç«¯ï¼š
è¿è¡Œç»“æœ:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="nv">$go&lt;/span> run client2.go hi
2015/11/17 13:30:53 begin dial...
2015/11/17 13:30:53 dial ok
&lt;span class="nv">$go&lt;/span> run server2.go
2015/11/17 13:33:45 accept a new connection
2015/11/17 13:33:45 start to &lt;span class="nb">read&lt;/span> from conn
2015/11/17 13:33:47 &lt;span class="nb">read&lt;/span> &lt;span class="m">2&lt;/span> bytes, content is hi
...
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Clientå‘socketä¸­å†™å…¥ä¸¤ä¸ªå­—èŠ‚æ•°æ®(â€œhiâ€)ï¼ŒServerç«¯åˆ›å»ºä¸€ä¸ªlen = 10çš„sliceï¼Œç­‰å¾…Readå°†è¯»å–çš„æ•°æ®æ”¾å…¥sliceï¼›Serveréšåè¯»å–åˆ°é‚£ä¸¤ä¸ªå­—èŠ‚ï¼šâ€hiâ€ã€‚ReadæˆåŠŸè¿”å›ï¼Œn =2 ï¼Œerr = nilã€‚&lt;/p>
&lt;h3 id="3socketä¸­æœ‰è¶³å¤Ÿæ•°æ®">3ã€Socketä¸­æœ‰è¶³å¤Ÿæ•°æ®&lt;/h3>
&lt;p>å¦‚æœsocketä¸­æœ‰æ•°æ®ï¼Œä¸”é•¿åº¦å¤§äºç­‰äºä¸€æ¬¡Readæ“ä½œæ‰€æœŸæœ›è¯»å‡ºçš„æ•°æ®é•¿åº¦ï¼Œé‚£ä¹ˆReadå°†ä¼šæˆåŠŸè¯»å‡ºè¿™éƒ¨åˆ†æ•°æ®å¹¶è¿”å›ã€‚è¿™ä¸ªæƒ…æ™¯æ˜¯æœ€ç¬¦åˆæˆ‘ä»¬å¯¹Readçš„æœŸå¾…çš„äº†ï¼šReadå°†ç”¨Socketä¸­çš„æ•°æ®å°†æˆ‘ä»¬ä¼ å…¥çš„sliceå¡«æ»¡åè¿”å›ï¼šn = 10, err = nilã€‚&lt;/p>
&lt;p>æˆ‘ä»¬é€šè¿‡client2.goå‘Server2å‘é€å¦‚ä¸‹å†…å®¹ï¼šabcdefghij12345ï¼Œæ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="nv">$go&lt;/span> run client2.go abcdefghij12345
2015/11/17 13:38:00 begin dial...
2015/11/17 13:38:00 dial ok
&lt;span class="nv">$go&lt;/span> run server2.go
2015/11/17 13:38:00 accept a new connection
2015/11/17 13:38:00 start to &lt;span class="nb">read&lt;/span> from conn
2015/11/17 13:38:02 &lt;span class="nb">read&lt;/span> &lt;span class="m">10&lt;/span> bytes, content is abcdefghij
2015/11/17 13:38:02 start to &lt;span class="nb">read&lt;/span> from conn
2015/11/17 13:38:02 &lt;span class="nb">read&lt;/span> &lt;span class="m">5&lt;/span> bytes, content is &lt;span class="m">12345&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>clientç«¯å‘é€çš„å†…å®¹é•¿åº¦ä¸º15ä¸ªå­—èŠ‚ï¼ŒServerç«¯Read bufferçš„é•¿åº¦ä¸º10ï¼Œå› æ­¤Server Readç¬¬ä¸€æ¬¡è¿”å›æ—¶åªä¼šè¯»å–10ä¸ªå­—èŠ‚ï¼›Socketä¸­è¿˜å‰©ä½™5ä¸ªå­—èŠ‚æ•°æ®ï¼ŒServerå†æ¬¡Readæ—¶ä¼šæŠŠå‰©ä½™æ•°æ®è¯»å‡ºï¼ˆå¦‚ï¼šæƒ…å½¢2ï¼‰ã€‚&lt;/p>
&lt;h3 id="4socketå…³é—­">4ã€Socketå…³é—­&lt;/h3>
&lt;p>å¦‚æœclientç«¯ä¸»åŠ¨å…³é—­äº†socketï¼Œé‚£ä¹ˆServerçš„Readå°†ä¼šè¯»åˆ°ä»€ä¹ˆå‘¢ï¼Ÿè¿™é‡Œåˆ†ä¸ºâ€œæœ‰æ•°æ®å…³é—­â€å’Œâ€œæ— æ•°æ®å…³é—­â€ã€‚&lt;/p>
&lt;p>â€œæœ‰æ•°æ®å…³é—­â€æ˜¯æŒ‡åœ¨clientå…³é—­æ—¶ï¼Œsocketä¸­è¿˜æœ‰serverç«¯æœªè¯»å–çš„æ•°æ®ï¼Œæˆ‘ä»¬åœ¨go-tcpsock/read_write/client3.goå’Œserver3.goä¸­æ¨¡æ‹Ÿè¿™ç§æƒ…å†µï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="nv">$go&lt;/span> run client3.go hello
2015/11/17 13:50:57 begin dial...
2015/11/17 13:50:57 dial ok
&lt;span class="nv">$go&lt;/span> run server3.go
2015/11/17 13:50:57 accept a new connection
2015/11/17 13:51:07 start to &lt;span class="nb">read&lt;/span> from conn
2015/11/17 13:51:07 &lt;span class="nb">read&lt;/span> &lt;span class="m">5&lt;/span> bytes, content is hello
2015/11/17 13:51:17 start to &lt;span class="nb">read&lt;/span> from conn
2015/11/17 13:51:17 conn &lt;span class="nb">read&lt;/span> error: EOF
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä»è¾“å‡ºç»“æœæ¥çœ‹ï¼Œå½“clientç«¯close socketé€€å‡ºåï¼Œserver3ä¾æ—§æ²¡æœ‰å¼€å§‹Readï¼Œ10såç¬¬ä¸€æ¬¡ReadæˆåŠŸè¯»å‡ºäº†5ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œå½“ç¬¬äºŒæ¬¡Readæ—¶ï¼Œç”±äºclientç«¯ socketå…³é—­ï¼ŒReadè¿”å›EOF errorã€‚&lt;/p>
&lt;p>é€šè¿‡ä¸Šé¢è¿™ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çŒœæµ‹å‡ºâ€œæ— æ•°æ®å…³é—­â€æƒ…å½¢ä¸‹çš„ç»“æœï¼Œé‚£å°±æ˜¯Readç›´æ¥è¿”å›EOF errorã€‚&lt;/p>
&lt;h3 id="5è¯»å–æ“ä½œè¶…æ—¶">5ã€è¯»å–æ“ä½œè¶…æ—¶&lt;/h3>
&lt;p>æœ‰äº›åœºåˆå¯¹Readçš„é˜»å¡æ—¶é—´æœ‰ä¸¥æ ¼é™åˆ¶ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒReadçš„è¡Œä¸ºåˆ°åº•æ˜¯ä»€ä¹ˆæ ·çš„å‘¢ï¼Ÿåœ¨è¿”å›è¶…æ—¶é”™è¯¯æ—¶ï¼Œæ˜¯å¦ä¹ŸåŒæ—¶Readäº†ä¸€éƒ¨åˆ†æ•°æ®äº†å‘¢ï¼Ÿè¿™ä¸ªå®éªŒæ¯”è¾ƒéš¾äºæ¨¡æ‹Ÿï¼Œä¸‹é¢çš„æµ‹è¯•ç»“æœä¹Ÿæœªå¿…èƒ½åæ˜ å‡ºæ‰€æœ‰å¯èƒ½ç»“æœã€‚æˆ‘ä»¬ç¼–å†™äº†&lt;code>client4.go&lt;/code>å’Œ&lt;code>server4.go&lt;/code>æ¥æ¨¡æ‹Ÿè¿™ä¸€æƒ…å½¢ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//go-tcpsock/read_write/client4.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="o">...&lt;/span> &lt;span class="o">...&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;begin dial...&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">conn&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Dial&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;tcp&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;:8888&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;dial error:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">conn&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;dial ok&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">data&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">65536&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">conn&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">data&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">10000&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//go-tcpsock/read_write/server4.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="o">...&lt;/span> &lt;span class="o">...&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">handleConn&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="nx">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Conn&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// read from the connection
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">10&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">buf&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">65536&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;start to read from conn&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetReadDeadline&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Now&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">Add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Microsecond&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="nx">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Read&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;conn read %d bytes, error: %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">nerr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="nx">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Error&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nx">nerr&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Timeout&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">continue&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;read %d bytes, content is %s\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">string&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">[:&lt;/span>&lt;span class="nx">n&lt;/span>&lt;span class="p">]))&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨Serverç«¯æˆ‘ä»¬é€šè¿‡Connçš„SetReadDeadlineæ–¹æ³•è®¾ç½®äº†10å¾®ç§’çš„è¯»è¶…æ—¶æ—¶é—´ï¼ŒServerçš„æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="nv">$go&lt;/span> run server4.go
2015/11/17 14:21:17 accept a new connection
2015/11/17 14:21:27 start to &lt;span class="nb">read&lt;/span> from conn
2015/11/17 14:21:27 conn &lt;span class="nb">read&lt;/span> &lt;span class="m">0&lt;/span> bytes, error: &lt;span class="nb">read&lt;/span> tcp 127.0.0.1:8888-&amp;gt;127.0.0.1:60970: i/o timeout
2015/11/17 14:21:37 start to &lt;span class="nb">read&lt;/span> from conn
2015/11/17 14:21:37 &lt;span class="nb">read&lt;/span> &lt;span class="m">65536&lt;/span> bytes, content is
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è™½ç„¶æ¯æ¬¡éƒ½æ˜¯10å¾®ç§’è¶…æ—¶ï¼Œä½†ç»“æœä¸åŒï¼Œç¬¬ä¸€æ¬¡Readè¶…æ—¶ï¼Œè¯»å‡ºæ•°æ®é•¿åº¦ä¸º0ï¼›ç¬¬äºŒæ¬¡è¯»å–æ‰€æœ‰æ•°æ®æˆåŠŸï¼Œæ²¡æœ‰è¶…æ—¶ã€‚åå¤æ‰§è¡Œäº†å¤šæ¬¡ï¼Œæ²¡èƒ½å‡ºç°â€œè¯»å‡ºéƒ¨åˆ†æ•°æ®ä¸”è¿”å›è¶…æ—¶é”™è¯¯â€çš„æƒ…å†µã€‚&lt;/p>
&lt;p>å’Œè¯»ç›¸æ¯”ï¼ŒWriteé‡åˆ°çš„æƒ…å½¢ä¸€æ ·ä¸å°‘ï¼Œæˆ‘ä»¬ä¹Ÿé€ä¸€çœ‹ä¸€ä¸‹ã€‚&lt;/p>
&lt;h3 id="1æˆåŠŸå†™">1ã€æˆåŠŸå†™&lt;/h3>
&lt;p>å‰é¢ä¾‹å­ç€é‡äºReadï¼Œclientç«¯åœ¨Writeæ—¶å¹¶æœªåˆ¤æ–­Writeçš„è¿”å›å€¼ã€‚æ‰€è°“â€œæˆåŠŸå†™â€æŒ‡çš„å°±æ˜¯Writeè°ƒç”¨è¿”å›çš„nä¸é¢„æœŸè¦å†™å…¥çš„æ•°æ®é•¿åº¦ç›¸ç­‰ï¼Œä¸”error = nilã€‚è¿™æ˜¯æˆ‘ä»¬åœ¨è°ƒç”¨Writeæ—¶é‡åˆ°çš„æœ€å¸¸è§çš„æƒ…å½¢ï¼Œè¿™é‡Œä¸å†ä¸¾ä¾‹äº†ã€‚&lt;/p>
&lt;h3 id="2å†™é˜»å¡">2ã€å†™é˜»å¡&lt;/h3>
&lt;p>TCPè¿æ¥é€šä¿¡ä¸¤ç«¯çš„OSéƒ½ä¼šä¸ºè¯¥è¿æ¥ä¿ç•™æ•°æ®ç¼“å†²ï¼Œä¸€ç«¯è°ƒç”¨Writeåï¼Œå®é™…ä¸Šæ•°æ®æ˜¯å†™å…¥åˆ°OSçš„åè®®æ ˆçš„æ•°æ®ç¼“å†²çš„ã€‚TCPæ˜¯å…¨åŒå·¥é€šä¿¡ï¼Œå› æ­¤æ¯ä¸ªæ–¹å‘éƒ½æœ‰ç‹¬ç«‹çš„æ•°æ®ç¼“å†²ã€‚å½“å‘é€æ–¹å°†å¯¹æ–¹çš„æ¥æ”¶ç¼“å†²åŒºä»¥åŠè‡ªèº«çš„å‘é€ç¼“å†²åŒºå†™æ»¡åï¼ŒWriteå°±ä¼šé˜»å¡ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼šclient5.goå’Œserver.goã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//go-tcpsock/read_write/client5.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="o">...&lt;/span> &lt;span class="o">...&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;begin dial...&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">conn&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Dial&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;tcp&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;:8888&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;dial error:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">conn&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;dial ok&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">data&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">65536&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">total&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">conn&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">data&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">total&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="nx">n&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;write %d bytes, error:%s\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">break&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">total&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="nx">n&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;write %d bytes this time, %d bytes in total\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">total&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;write %d bytes in total\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">total&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">10000&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//go-tcpsock/read_write/server5.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="o">...&lt;/span> &lt;span class="o">...&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">handleConn&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="nx">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Conn&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// read from the connection
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">5&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">buf&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">60000&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;start to read from conn&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Read&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;conn read %d bytes, error: %s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">nerr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="nx">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Error&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nx">nerr&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Timeout&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">continue&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;read %d bytes, content is %s\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">string&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">[:&lt;/span>&lt;span class="nx">n&lt;/span>&lt;span class="p">]))&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="o">...&lt;/span> &lt;span class="o">...&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Server5åœ¨å‰10sä¸­å¹¶ä¸Readæ•°æ®ï¼Œå› æ­¤å½“client5ä¸€ç›´å°è¯•å†™å…¥æ—¶ï¼Œå†™åˆ°ä¸€å®šé‡åå°±ä¼šå‘ç”Ÿé˜»å¡ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="nv">$go&lt;/span> run client5.go
2015/11/17 14:57:33 begin dial...
2015/11/17 14:57:33 dial ok
2015/11/17 14:57:33 write &lt;span class="m">65536&lt;/span> bytes this time, &lt;span class="m">65536&lt;/span> bytes in total
2015/11/17 14:57:33 write &lt;span class="m">65536&lt;/span> bytes this time, &lt;span class="m">131072&lt;/span> bytes in total
2015/11/17 14:57:33 write &lt;span class="m">65536&lt;/span> bytes this time, &lt;span class="m">196608&lt;/span> bytes in total
2015/11/17 14:57:33 write &lt;span class="m">65536&lt;/span> bytes this time, &lt;span class="m">262144&lt;/span> bytes in total
2015/11/17 14:57:33 write &lt;span class="m">65536&lt;/span> bytes this time, &lt;span class="m">327680&lt;/span> bytes in total
2015/11/17 14:57:33 write &lt;span class="m">65536&lt;/span> bytes this time, &lt;span class="m">393216&lt;/span> bytes in total
2015/11/17 14:57:33 write &lt;span class="m">65536&lt;/span> bytes this time, &lt;span class="m">458752&lt;/span> bytes in total
2015/11/17 14:57:33 write &lt;span class="m">65536&lt;/span> bytes this time, &lt;span class="m">524288&lt;/span> bytes in total
2015/11/17 14:57:33 write &lt;span class="m">65536&lt;/span> bytes this time, &lt;span class="m">589824&lt;/span> bytes in total
2015/11/17 14:57:33 write &lt;span class="m">65536&lt;/span> bytes this time, &lt;span class="m">655360&lt;/span> bytes in total
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨Darwinä¸Šï¼Œè¿™ä¸ªsizeå¤§çº¦åœ¨679468bytesã€‚åç»­å½“server5æ¯éš”5sè¿›è¡ŒReadæ—¶ï¼ŒOS socketç¼“å†²åŒºè…¾å‡ºäº†ç©ºé—´ï¼Œclient5å°±åˆå¯ä»¥å†™å…¥äº†ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="nv">$go&lt;/span> run server5.go
2015/11/17 15:07:01 accept a new connection
2015/11/17 15:07:16 start to &lt;span class="nb">read&lt;/span> from conn
2015/11/17 15:07:16 &lt;span class="nb">read&lt;/span> &lt;span class="m">60000&lt;/span> bytes, content is
2015/11/17 15:07:21 start to &lt;span class="nb">read&lt;/span> from conn
2015/11/17 15:07:21 &lt;span class="nb">read&lt;/span> &lt;span class="m">60000&lt;/span> bytes, content is
2015/11/17 15:07:26 start to &lt;span class="nb">read&lt;/span> from conn
2015/11/17 15:07:26 &lt;span class="nb">read&lt;/span> &lt;span class="m">60000&lt;/span> bytes, content is
....
clientç«¯ï¼š
2015/11/17 15:07:01 write &lt;span class="m">65536&lt;/span> bytes this time, &lt;span class="m">720896&lt;/span> bytes in total
2015/11/17 15:07:06 write &lt;span class="m">65536&lt;/span> bytes this time, &lt;span class="m">786432&lt;/span> bytes in total
2015/11/17 15:07:16 write &lt;span class="m">65536&lt;/span> bytes this time, &lt;span class="m">851968&lt;/span> bytes in total
2015/11/17 15:07:16 write &lt;span class="m">65536&lt;/span> bytes this time, &lt;span class="m">917504&lt;/span> bytes in total
2015/11/17 15:07:27 write &lt;span class="m">65536&lt;/span> bytes this time, &lt;span class="m">983040&lt;/span> bytes in total
2015/11/17 15:07:27 write &lt;span class="m">65536&lt;/span> bytes this time, &lt;span class="m">1048576&lt;/span> bytes in total
.... ...
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="3å†™å…¥éƒ¨åˆ†æ•°æ®">3ã€å†™å…¥éƒ¨åˆ†æ•°æ®&lt;/h3>
&lt;p>Writeæ“ä½œå­˜åœ¨å†™å…¥éƒ¨åˆ†æ•°æ®çš„æƒ…å†µï¼Œæ¯”å¦‚ä¸Šé¢ä¾‹å­ä¸­ï¼Œå½“clientç«¯è¾“å‡ºæ—¥å¿—åœç•™åœ¨â€œwrite 65536 bytes this time, 655360 bytes in totalâ€æ—¶ï¼Œæˆ‘ä»¬æ€æ‰server5ï¼Œè¿™æ—¶æˆ‘ä»¬ä¼šçœ‹åˆ°client5è¾“å‡ºä»¥ä¸‹æ—¥å¿—ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">...
2015/11/17 15:19:14 write &lt;span class="m">65536&lt;/span> bytes this time, &lt;span class="m">655360&lt;/span> bytes in total
2015/11/17 15:19:16 write &lt;span class="m">24108&lt;/span> bytes, error:write tcp 127.0.0.1:62245-&amp;gt;127.0.0.1:8888: write: broken pipe
2015/11/17 15:19:16 write &lt;span class="m">679468&lt;/span> bytes in total
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ˜¾ç„¶Writeå¹¶éåœ¨655360è¿™ä¸ªåœ°æ–¹é˜»å¡çš„ï¼Œè€Œæ˜¯åç»­åˆå†™å…¥24108åå‘ç”Ÿäº†é˜»å¡ï¼Œserverç«¯socketå…³é—­åï¼Œæˆ‘ä»¬çœ‹åˆ°Wroteè¿”å›er != nilä¸”n = 24108ï¼Œç¨‹åºéœ€è¦å¯¹è¿™éƒ¨åˆ†å†™å…¥çš„24108å­—èŠ‚åšç‰¹å®šå¤„ç†ã€‚&lt;/p>
&lt;h3 id="4å†™å…¥è¶…æ—¶">4ã€å†™å…¥è¶…æ—¶&lt;/h3>
&lt;p>å¦‚æœéè¦ç»™Writeå¢åŠ ä¸€ä¸ªæœŸé™ï¼Œé‚£æˆ‘ä»¬å¯ä»¥è°ƒç”¨SetWriteDeadlineæ–¹æ³•ã€‚æˆ‘ä»¬copyä¸€ä»½client5.goï¼Œå½¢æˆclient6.goï¼Œåœ¨client6.goçš„Writeä¹‹å‰å¢åŠ ä¸€è¡Œtimeoutè®¾ç½®ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">conn&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetWriteDeadline&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Now&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="nf">Add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Microsecond&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯åŠ¨server6.goï¼Œå¯åŠ¨client6.goï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å†™å…¥è¶…æ—¶çš„æƒ…å†µä¸‹ï¼ŒWriteçš„è¿”å›ç»“æœï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="nv">$go&lt;/span> run client6.go
2015/11/17 15:26:34 begin dial...
2015/11/17 15:26:34 dial ok
2015/11/17 15:26:34 write &lt;span class="m">65536&lt;/span> bytes this time, &lt;span class="m">65536&lt;/span> bytes in total
... ...
2015/11/17 15:26:34 write &lt;span class="m">65536&lt;/span> bytes this time, &lt;span class="m">655360&lt;/span> bytes in total
2015/11/17 15:26:34 write &lt;span class="m">24108&lt;/span> bytes, error:write tcp 127.0.0.1:62325-&amp;gt;127.0.0.1:8888: i/o timeout
2015/11/17 15:26:34 write &lt;span class="m">679468&lt;/span> bytes in total
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ°åœ¨å†™å…¥è¶…æ—¶æ—¶ï¼Œä¾æ—§å­˜åœ¨éƒ¨åˆ†æ•°æ®å†™å…¥çš„æƒ…å†µã€‚&lt;/p>
&lt;p>ç»¼ä¸Šä¾‹å­ï¼Œè™½ç„¶Goç»™æˆ‘ä»¬æä¾›äº†é˜»å¡I/Oçš„ä¾¿åˆ©ï¼Œä½†åœ¨è°ƒç”¨Readå’ŒWriteæ—¶ä¾æ—§è¦ç»¼åˆéœ€è¦æ–¹æ³•è¿”å›çš„nå’Œerrçš„ç»“æœï¼Œä»¥åšå‡ºæ­£ç¡®å¤„ç†ã€‚net.connå®ç°äº†io.Readerå’Œio.Writeræ¥å£ï¼Œå› æ­¤å¯ä»¥è¯•ç”¨ä¸€äº›wrapperåŒ…è¿›è¡Œsocketè¯»å†™ï¼Œæ¯”å¦‚bufioåŒ…ä¸‹é¢çš„Writerå’ŒReaderã€io/ioutilä¸‹çš„å‡½æ•°ç­‰ã€‚&lt;/p>
&lt;h3 id="goroutine-safe">Goroutine safe&lt;/h3>
&lt;p>åŸºäºgoroutineçš„ç½‘ç»œæ¶æ„æ¨¡å‹ï¼Œå­˜åœ¨åœ¨ä¸åŒgoroutineé—´å…±äº«connçš„æƒ…å†µï¼Œé‚£ä¹ˆconnçš„è¯»å†™æ˜¯å¦æ˜¯goroutine safeçš„å‘¢ï¼Ÿåœ¨æ·±å…¥è¿™ä¸ªé—®é¢˜ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆä»åº”ç”¨æ„ä¹‰ä¸Šæ¥çœ‹readæ“ä½œå’Œwriteæ“ä½œçš„goroutine-safeå¿…è¦æ€§ã€‚&lt;/p>
&lt;p>å¯¹äºreadæ“ä½œè€Œè¨€ï¼Œç”±äºTCPæ˜¯é¢å‘å­—èŠ‚æµï¼Œconn.Readæ— æ³•æ­£ç¡®åŒºåˆ†æ•°æ®çš„ä¸šåŠ¡è¾¹ç•Œï¼Œå› æ­¤å¤šä¸ªgoroutineå¯¹åŒä¸€ä¸ªconnè¿›è¡Œreadçš„æ„ä¹‰ä¸å¤§ï¼Œgoroutineè¯»åˆ°ä¸å®Œæ•´çš„ä¸šåŠ¡åŒ…åå€’æ˜¯å¢åŠ äº†ä¸šåŠ¡å¤„ç†çš„éš¾åº¦ã€‚å¯¹ä¸Writeæ“ä½œè€Œè¨€ï¼Œå€’æ˜¯æœ‰å¤šä¸ªgoroutineå¹¶å‘å†™çš„æƒ…å†µã€‚ä¸è¿‡connè¯»å†™æ˜¯å¦goroutine-safeçš„æµ‹è¯•ä¸æ˜¯å¾ˆå¥½åšï¼Œæˆ‘ä»¬å…ˆæ·±å…¥ä¸€ä¸‹runtimeä»£ç ï¼Œå…ˆä»ç†è®ºä¸Šç»™è¿™ä¸ªé—®é¢˜å®šä¸ªæ€§ï¼š&lt;/p>
&lt;p>net.connåªæ˜¯*netFDçš„wrapperç»“æ„ï¼Œæœ€ç»ˆWriteå’ŒReadéƒ½ä¼šè½åœ¨å…¶ä¸­çš„fdä¸Šï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">type conn struct {
fd *netFD
}
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>netFDåœ¨ä¸åŒå¹³å°ä¸Šæœ‰ç€ä¸åŒçš„å®ç°ï¼Œæˆ‘ä»¬ä»¥net/fd_unix.goä¸­çš„netFDä¸ºä¾‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// Network file descriptor.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">netFD&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// locking/lifetime of sysfd + serialize access to Read and Write methods
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">fdmu&lt;/span> &lt;span class="nx">fdMutex&lt;/span>
&lt;span class="c1">// immutable until Close
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">sysfd&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;span class="nx">family&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;span class="nx">sotype&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;span class="nx">isConnected&lt;/span> &lt;span class="kt">bool&lt;/span>
&lt;span class="nx">net&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="nx">laddr&lt;/span> &lt;span class="nx">Addr&lt;/span>
&lt;span class="nx">raddr&lt;/span> &lt;span class="nx">Addr&lt;/span>
&lt;span class="c1">// wait server
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">pd&lt;/span> &lt;span class="nx">pollDesc&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æˆ‘ä»¬çœ‹åˆ°netFDä¸­åŒ…å«äº†ä¸€ä¸ªruntimeå®ç°çš„fdMutexç±»å‹å­—æ®µï¼Œä»æ³¨é‡Šä¸Šæ¥çœ‹ï¼Œè¯¥fdMutexç”¨æ¥ä¸²è¡ŒåŒ–å¯¹è¯¥netFDå¯¹åº”çš„sysfdçš„Writeå’ŒReadæ“ä½œã€‚ä»è¿™ä¸ªæ³¨é‡Šä¸Šæ¥çœ‹ï¼Œæ‰€æœ‰å¯¹connçš„Readå’ŒWriteæ“ä½œéƒ½æ˜¯æœ‰fdMutexäº’æ–¥çš„ï¼Œä»netFDçš„Readå’ŒWriteæ–¹æ³•çš„å®ç°ä¹Ÿè¯å®äº†è¿™ä¸€ç‚¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">fd&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">netFD&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Read&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">n&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">fd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">readLock&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">fd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">readUnlock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">fd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">pd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">PrepareRead&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">syscall&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Read&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">fd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sysfd&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">p&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">n&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nx">syscall&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">EAGAIN&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">fd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">pd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WaitRead&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">continue&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">fd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">eofError&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">break&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="nx">syscall&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Errno&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewSyscallError&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;read&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">fd&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">netFD&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">nn&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">fd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">writeLock&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">fd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">writeUnlock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">fd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">pd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">PrepareWrite&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">n&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;span class="nx">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">syscall&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">fd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">sysfd&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">p&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">nn&lt;/span>&lt;span class="p">:])&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">n&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">nn&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="nx">n&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">nn&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">break&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nx">syscall&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">EAGAIN&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">fd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">pd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WaitWrite&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">continue&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">break&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">n&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">io&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ErrUnexpectedEOF&lt;/span>
&lt;span class="k">break&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="nx">syscall&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Errno&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">NewSyscallError&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;write&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">nn&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ¯æ¬¡Writeæ“ä½œéƒ½æ˜¯å—lockä¿æŠ¤ï¼Œç›´åˆ°æ­¤æ¬¡æ•°æ®å…¨éƒ¨writeå®Œã€‚å› æ­¤åœ¨åº”ç”¨å±‚é¢ï¼Œè¦æƒ³ä¿è¯å¤šä¸ªgoroutineåœ¨ä¸€ä¸ªconnä¸Šwriteæ“ä½œçš„Safeï¼Œéœ€è¦ä¸€æ¬¡writeå®Œæ•´å†™å…¥ä¸€ä¸ªâ€œä¸šåŠ¡åŒ…â€ï¼›ä¸€æ—¦å°†ä¸šåŠ¡åŒ…çš„å†™å…¥æ‹†åˆ†ä¸ºå¤šæ¬¡writeï¼Œé‚£å°±æ— æ³•ä¿è¯æŸä¸ªGoroutineçš„æŸâ€œä¸šåŠ¡åŒ…â€æ•°æ®åœ¨connå‘é€çš„è¿ç»­æ€§ã€‚&lt;/p>
&lt;p>åŒæ—¶ä¹Ÿå¯ä»¥çœ‹å‡ºå³ä¾¿æ˜¯Readæ“ä½œï¼Œä¹Ÿæ˜¯lockä¿æŠ¤çš„ã€‚å¤šä¸ªGoroutineå¯¹åŒä¸€connçš„å¹¶å‘è¯»ä¸ä¼šå‡ºç°è¯»å‡ºå†…å®¹é‡å çš„æƒ…å†µï¼Œä½†å†…å®¹æ–­ç‚¹æ˜¯ä¾ runtimeè°ƒåº¦æ¥éšæœºç¡®å®šçš„ã€‚å­˜åœ¨ä¸€ä¸ªä¸šåŠ¡åŒ…æ•°æ®ï¼Œ1/3å†…å®¹è¢«goroutine-1è¯»èµ°ï¼Œå¦å¤–2/3è¢«å¦å¤–ä¸€ä¸ªgoroutine-2è¯» èµ°çš„æƒ…å†µã€‚æ¯”å¦‚ä¸€ä¸ªå®Œæ•´åŒ…ï¼šworldï¼Œå½“goroutineçš„read slice size &amp;lt; 5æ—¶ï¼Œå­˜åœ¨å¯èƒ½ï¼šä¸€ä¸ªgoroutineè¯»åˆ° â€œworlâ€,å¦å¤–ä¸€ä¸ªgoroutineè¯»å‡ºâ€dâ€ã€‚&lt;/p>
&lt;h2 id="å››socketå±æ€§">å››ã€Socketå±æ€§&lt;/h2>
&lt;p>åŸç”ŸSocket APIæä¾›äº†ä¸°å¯Œçš„sockoptè®¾ç½®æ¥å£ï¼Œä½†Golangæœ‰è‡ªå·±çš„ç½‘ç»œæ¶æ„æ¨¡å‹ï¼Œgolangæä¾›çš„socket optionsæ¥å£ä¹Ÿæ˜¯åŸºäºä¸Šè¿°æ¨¡å‹çš„å¿…è¦çš„å±æ€§è®¾ç½®ã€‚åŒ…æ‹¬&lt;/p>
&lt;ul>
&lt;li>SetKeepAlive&lt;/li>
&lt;li>SetKeepAlivePeriod&lt;/li>
&lt;li>SetLinger&lt;/li>
&lt;li>SetNoDelay ï¼ˆé»˜è®¤no delayï¼‰&lt;/li>
&lt;li>SetWriteBuffer&lt;/li>
&lt;li>SetReadBuffer&lt;/li>
&lt;/ul>
&lt;p>ä¸è¿‡ä¸Šé¢çš„Methodæ˜¯TCPConnçš„ï¼Œè€Œä¸æ˜¯Connçš„ï¼Œè¦ä½¿ç”¨ä¸Šé¢çš„Methodçš„ï¼Œéœ€è¦type assertionï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">tcpConn&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">TCPConn&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">ok&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">//error handle
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="nx">tcpConn&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">SetNoDelay&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯¹äºlistener socket, golangé»˜è®¤é‡‡ç”¨äº† SO_REUSEADDRï¼Œè¿™æ ·å½“ä½ é‡å¯ listenerç¨‹åºæ—¶ï¼Œä¸ä¼šå› ä¸ºaddress in useçš„é”™è¯¯è€Œå¯åŠ¨å¤±è´¥ã€‚è€Œlisten backlogçš„é»˜è®¤å€¼æ˜¯é€šè¿‡è·å–ç³»ç»Ÿçš„è®¾ç½®å€¼å¾—åˆ°çš„ã€‚ä¸åŒç³»ç»Ÿä¸åŒï¼šmac 128, linux 512ç­‰ã€‚&lt;/p>
&lt;h2 id="äº”å…³é—­è¿æ¥">äº”ã€å…³é—­è¿æ¥&lt;/h2>
&lt;p>å’Œå‰é¢çš„æ–¹æ³•ç›¸æ¯”ï¼Œå…³é—­è¿æ¥ç®—æ˜¯æœ€ç®€å•çš„æ“ä½œäº†ã€‚ç”±äºsocketæ˜¯å…¨åŒå·¥çš„ï¼Œclientå’Œserverç«¯åœ¨å·±æ–¹å·²å…³é—­çš„socketå’Œå¯¹æ–¹å…³é—­çš„socketä¸Šæ“ä½œçš„ç»“æœæœ‰ä¸åŒã€‚çœ‹ä¸‹é¢ä¾‹å­ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//go-tcpsock/conn_close/client1.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="o">...&lt;/span> &lt;span class="o">...&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;begin dial...&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">conn&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Dial&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;tcp&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;:8888&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;dial error:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">conn&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;close ok&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">buf&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">32&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">conn&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Read&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;read error:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;read % bytes, content is %s\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">string&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">[:&lt;/span>&lt;span class="nx">n&lt;/span>&lt;span class="p">]))&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">conn&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;write error:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;write % bytes, content is %s\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">string&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">[:&lt;/span>&lt;span class="nx">n&lt;/span>&lt;span class="p">]))&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sleep&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">1000&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">//go-tcpsock/conn_close/server1.go
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="o">...&lt;/span> &lt;span class="o">...&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">handleConn&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="nx">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Conn&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="c1">// read from the connection
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">var&lt;/span> &lt;span class="nx">buf&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;start to read from conn&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Read&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;conn read error:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;read %d bytes, content is %s\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">string&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">[:&lt;/span>&lt;span class="nx">n&lt;/span>&lt;span class="p">]))&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;conn write error:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;write %d bytes, content is %s\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">string&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">[:&lt;/span>&lt;span class="nx">n&lt;/span>&lt;span class="p">]))&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="o">...&lt;/span> &lt;span class="o">...&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¸Šè¿°ä¾‹å­çš„æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="nv">$go&lt;/span> run server1.go
2015/11/17 17:00:51 accept a new connection
2015/11/17 17:00:51 start to &lt;span class="nb">read&lt;/span> from conn
2015/11/17 17:00:51 conn &lt;span class="nb">read&lt;/span> error: EOF
2015/11/17 17:00:51 write &lt;span class="m">10&lt;/span> bytes, content is
&lt;span class="nv">$go&lt;/span> run client1.go
2015/11/17 17:00:51 begin dial...
2015/11/17 17:00:51 close ok
2015/11/17 17:00:51 &lt;span class="nb">read&lt;/span> error: &lt;span class="nb">read&lt;/span> tcp 127.0.0.1:64195-&amp;gt;127.0.0.1:8888: use of closed network connection
2015/11/17 17:00:51 write error: write tcp 127.0.0.1:64195-&amp;gt;127.0.0.1:8888: use of closed network connection
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä»client1çš„ç»“æœæ¥çœ‹ï¼Œåœ¨å·±æ–¹å·²ç»å…³é—­çš„socketä¸Šå†è¿›è¡Œreadå’Œwriteæ“ä½œï¼Œä¼šå¾—åˆ°â€use of closed network connectionâ€ errorï¼›
ä»server1çš„æ‰§è¡Œç»“æœæ¥çœ‹ï¼Œåœ¨å¯¹æ–¹å…³é—­çš„socketä¸Šæ‰§è¡Œreadæ“ä½œä¼šå¾—åˆ°EOF errorï¼Œä½†writeæ“ä½œä¼šæˆåŠŸï¼Œå› ä¸ºæ•°æ®ä¼šæˆåŠŸå†™å…¥å·±æ–¹çš„å†…æ ¸socketç¼“å†²åŒºä¸­ï¼Œå³ä¾¿æœ€ç»ˆå‘ä¸åˆ°å¯¹æ–¹socketç¼“å†²åŒºäº†ï¼Œå› ä¸ºå·±æ–¹socketå¹¶æœªå…³é—­ã€‚å› æ­¤å½“å‘ç°å¯¹æ–¹socketå…³é—­åï¼Œå·±æ–¹åº”è¯¥æ­£ç¡®åˆç†å¤„ç†è‡ªå·±çš„socketï¼Œå†ç»§ç»­writeå·²ç»æ— ä»»ä½•æ„ä¹‰äº†ã€‚&lt;/p>
&lt;h2 id="å…­å°ç»“">å…­ã€å°ç»“&lt;/h2>
&lt;p>æœ¬æ–‡æ¯”è¾ƒåŸºç¡€ï¼Œä½†å´å¾ˆé‡è¦ï¼Œæ¯•ç«Ÿgolangæ˜¯é¢å‘å¤§è§„æ¨¡æœåŠ¡åç«¯çš„ï¼Œå¯¹é€šä¿¡ç¯èŠ‚çš„ç»†èŠ‚çš„æ·±å…¥ç†è§£ä¼šå¤§æœ‰è£¨ç›Šã€‚å¦å¤–Goçš„goroutine+é˜»å¡é€šä¿¡çš„ç½‘ç»œé€šä¿¡æ¨¡å‹é™ä½äº†å¼€å‘è€…å¿ƒæ™ºè´Ÿæ‹…ï¼Œç®€åŒ–äº†é€šä¿¡çš„å¤æ‚æ€§ï¼Œè¿™ç‚¹å°¤ä¸ºé‡è¦ã€‚&lt;/p>
&lt;p>æœ¬æ–‡ä»£ç å®éªŒç¯å¢ƒï¼šgo 1.5.1 on Darwin amd64ä»¥åŠéƒ¨åˆ†åœ¨ubuntu 14.04 amd64ã€‚&lt;/p>
&lt;p>æœ¬æ–‡demoä»£ç åœ¨&lt;a href="https://github.com/bigwhite/experiments/tree/master/go-tcpsock">è¿™é‡Œ&lt;/a>å¯ä»¥æ‰¾åˆ°ã€‚&lt;/p>
&lt;p>Â© 2015, &lt;a href="http://tonybai.com/">bigwhite&lt;/a>. ç‰ˆæƒæ‰€æœ‰.&lt;/p></content><category scheme="https://yusank.github.io/categories/%E6%8A%80%E6%9C%AF/" term="æŠ€æœ¯" label="æŠ€æœ¯"/><category scheme="https://yusank.github.io/tags/go/" term="go" label="go"/><category scheme="https://yusank.github.io/tags/tcp/" term="tcp" label="tcp"/><category scheme="https://yusank.github.io/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" term="ç½‘ç»œç¼–ç¨‹" label="ç½‘ç»œç¼–ç¨‹"/></entry><entry><title type="text">Docker åŸºç¡€çŸ¥è¯†å’ŒåŸºæœ¬æ“ä½œ</title><link rel="alternate" type="text/html" href="https://yusank.github.io/posts/docker/"/><id>https://yusank.github.io/posts/docker/</id><updated>2021-09-18T06:24:55+00:00</updated><published>2017-07-17T15:52:00+08:00</published><author><name>yusank</name><uri>https://yusank.github.io/</uri><email>yusankurban@gmail.com</email></author><summary type="html">å…³äº å®¹å™¨ã€Docker çš„åŸºç¡€çŸ¥è¯†ã€åŸºç¡€æ“ä½œå’Œå¸¸ç”¨çš„å‘½ä»¤ã€‚ Docker åŸºç¡€çŸ¥è¯†å’Œä½¿ç”¨ å…³äºDoâ€¦â€¦</summary><content type="html">&lt;p>å…³äº å®¹å™¨ã€Docker çš„åŸºç¡€çŸ¥è¯†ã€åŸºç¡€æ“ä½œå’Œå¸¸ç”¨çš„å‘½ä»¤ã€‚&lt;/p>
&lt;h1 id="docker-åŸºç¡€çŸ¥è¯†å’Œä½¿ç”¨">Docker åŸºç¡€çŸ¥è¯†å’Œä½¿ç”¨&lt;/h1>
&lt;h2 id="å…³äºdocker">å…³äºDocker&lt;/h2>
&lt;h3 id="å®¹å™¨æŠ€æœ¯">å®¹å™¨æŠ€æœ¯&lt;/h3>
&lt;p>å¯¹äºå®¹å™¨ï¼Œç›®å‰å¹¶æ²¡æœ‰ä¸€ä¸ªä¸¥æ ¼çš„å®šä¹‰ï¼Œä½†æ˜¯æ™®éè¢«è®¤å¯çš„è¯´æ³•æ˜¯ï¼Œå®ƒé¦–å…ˆå¿…é¡»æ˜¯ä¸€ä¸ªç›¸å¯¹ç‹¬ç«‹çš„ç¯å¢ƒï¼Œåœ¨è¿™ä¸€ç‚¹ä¸Šæœ‰ç‚¹ç±»ä¼¼è™šæ‹Ÿæœºï¼Œä½†æ˜¯æ²¡æœ‰è™šæ‹Ÿæœºé‚£ä¹ˆå½»åº•ã€‚å¦å¤–ï¼Œåœ¨ä¸€ä¸ªå®¹å™¨ç¯å¢ƒä¸­ï¼Œåº”è¯¥æœ€å°åŒ–å…¶å¯¹å¤–ç•Œçš„å½±å“ï¼Œæ¯”å¦‚ä¸èƒ½åœ¨å®¹å™¨ä¸­å§hostä¸Šçš„èµ„æºè€—å°½ï¼Œè¿™å°±æ˜¯èµ„æºçš„æ§åˆ¶ã€‚&lt;/p>
&lt;p>å®¹å™¨æŠ€æœ¯ä¹‹æ‰€ä»¥å—æ¬¢è¿ï¼Œä¸€ä¸ªé‡è¦çš„åŸå› æ˜¯å®ƒå·²ç»é›†æˆåˆ°äº† Linux å†…æ ¸ä¸­ï¼Œå·²ç»è¢«å½“ä½œ Linux å†…æ ¸åŸç”Ÿæä¾›çš„ç‰¹å¾ã€‚å½“ç„¶å…¶ä»–å¹³å°ä¹Ÿæœ‰ç›¸åº”çš„å®¹å™¨æŠ€æœ¯ï¼Œä½†æ˜¯æˆ‘ä»¬è®¨è®ºçš„ä»¥åŠDockeræ¶‰åŠçš„éƒ½æ˜¯æŒ‡ Linux å¹³å°ä¸Šçš„å®¹å™¨æŠ€æœ¯ã€‚&lt;/p>
&lt;p>ä¸€èˆ¬æ¥è¯´ï¼Œå®¹å™¨æŠ€æœ¯ä¸»è¦åŒ…æ‹¬Namespaceå’ŒCgroupä¸¤ä¸ªå†…æ ¸ç‰¹å¾ã€‚&lt;/p>
&lt;ul>
&lt;li>Namespace å‘½åç©ºé—´ï¼Œå®ƒä¸»è¦åšçš„æ˜¯è®¿é—®éš”ç¦»ã€‚å…¶åŸç†æ˜¯å¯¹ä¸€ç±»èµ„æºè¿›è¡ŒæŠ½è±¡ï¼Œå¹¶å°†å…¶å°è£…åœ¨ä¸€èµ·æä¾›ç»™å®¹å™¨ä½¿ç”¨ï¼Œå¯¹äºè¿™ç±»èµ„æºï¼Œå› ä¸ºæ¯ä¸ªå®¹å™¨éƒ½æœ‰è‡ªå·±çš„æŠ½è±¡ï¼Œè€Œä»–ä»¬å½¼æ­¤ä¹‹é—´æ˜¯ä¸å¯è§çš„ï¼Œæ‰€ä»¥å°±åšåˆ°è®¿é—®éš”ç¦»ã€‚&lt;/li>
&lt;li>Cgroupæ˜¯ control group çš„ç®€ç§°ï¼Œåˆç§°ä¸ºæ§åˆ¶ç»„ï¼Œå®ƒä¸»è¦æ˜¯æ§åˆ¶èµ„æºæ§åˆ¶ã€‚å…¶åŸç†æ˜¯å°†ä¸€ç»„è¿›ç¨‹æ”¾åœ¨ä¸€ä¸ªæ§åˆ¶ç»„é‡Œï¼Œé€šè¿‡ç»™è¿™ä¸ªæ§åˆ¶ç»„åˆ†é…æŒ‡å®šçš„å¯ç”¨èµ„æºï¼Œè¾¾åˆ°æ§åˆ¶è¿™ä¸€ç»„è¿›ç¨‹å¯ç”¨èµ„æºçš„ç›®çš„ã€‚&lt;/li>
&lt;/ul>
&lt;p>å®¹å™¨æœ€æ ¸å¿ƒæŠ€æœ¯æ˜¯ Namespace+Cgroupï¼Œä½†æ˜¯å…‰æœ‰è¿™ä¸¤ä¸ªæŠ½è±¡çš„æŠ€æœ¯æ¦‚å¿µæ˜¯æ— æ³•ç»„æˆä¸€ä¸ªå®Œæ•´çš„å®¹å™¨çš„ã€‚
å¯¹äº linux å®¹å™¨çš„æœ€å°ç»„æˆï¼Œæ˜¯ç”±ä¸€ä¸‹å››ä¸ªéƒ¨åˆ†æ„æˆï¼š&lt;/p>
&lt;ul>
&lt;li>Cgroupï¼š èµ„æºæ§åˆ¶ã€‚&lt;/li>
&lt;li>Namespaceï¼š è®¿é—®éš”ç¦»ã€‚&lt;/li>
&lt;li>rootfsï¼š ç³»ç»Ÿæ–‡ä»¶éš”ç¦»ã€‚&lt;/li>
&lt;li>å®¹å™¨å¼•æ“ï¼š ç”Ÿå‘½å‘¨æœŸæ§åˆ¶ã€‚&lt;/li>
&lt;/ul>
&lt;h3 id="å®¹å™¨çš„åˆ›å»ºåŸç†">å®¹å™¨çš„åˆ›å»ºåŸç†&lt;/h3>
&lt;p>ä»£ç ä¸€&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="n">pid&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">clone&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fun&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">stack&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">flags&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">clone_arg&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">(&lt;/span>&lt;span class="nl">flags&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">CLONE_NEWPID&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">CLONE_NEWNS&lt;/span> &lt;span class="o">|&lt;/span>
&lt;span class="n">CLONE_NEWUSER&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">CLONE_NEWNET&lt;/span> &lt;span class="o">|&lt;/span>
&lt;span class="n">CLONE_NEWIPC&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="n">CLONE_NEWUTS&lt;/span> &lt;span class="o">|&lt;/span>
&lt;span class="p">...)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>å¯¹äºä»¥ä¸Šä»£ç ï¼Œé€šè¿‡cloneç³»ç»Ÿè°ƒç”¨ï¼Œå¹¶ä¼ å…¥å„ä¸ªNamespaceå¯¹åº”çš„clone flagï¼Œåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„å­è¿›ç¨‹ï¼Œè¯¥è¿›ç¨‹æ‹¥æœ‰è‡ªå·±çš„Namespaceã€‚ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œè¯¥è¿›ç¨‹æ‹¥æœ‰è‡ªå·±çš„pid,mount,user,net,ipc,uts namespace ã€‚&lt;/li>
&lt;/ul>
&lt;p>ä»£ç äºŒï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="nb">echo&lt;/span> &lt;span class="nv">$pid&lt;/span> &amp;gt; /sys/fs/cgroup/cpu/tasks
&lt;span class="nb">echo&lt;/span> &lt;span class="nv">$pid&lt;/span> &amp;gt; /sys/fs/cgroup/cpuset/tasks
&lt;span class="nb">echo&lt;/span> &lt;span class="nv">$pid&lt;/span> &amp;gt; /sys/fs/cgroup/blkio/tasks
&lt;span class="nb">echo&lt;/span> &lt;span class="nv">$pid&lt;/span> &amp;gt; /sys/fs/cgroup/memory/tasks
&lt;span class="nb">echo&lt;/span> &lt;span class="nv">$pid&lt;/span> &amp;gt; /sys/fs/cgroup/devices/tasks
&lt;span class="nb">echo&lt;/span> &lt;span class="nv">$pid&lt;/span> &amp;gt; /sys/fs/cgroup/freezer/tasks
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>å¯¹äºä»£ç äºŒï¼Œå°†ä»£ç ä¸€ä¸­çš„pidå†™å…¥å„ä¸ªCgroupå­ç³»ç»Ÿä¸­ï¼Œè¿™æ ·è¯¥è¿›ç¨‹å°±å¯ä»¥å—åˆ°ç›¸åº”Cgroupå­ç³»ç»Ÿçš„æ§åˆ¶ã€‚&lt;/li>
&lt;/ul>
&lt;p>ä»£ç ä¸‰ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">fun &lt;span class="o">()&lt;/span>
&lt;span class="o">{&lt;/span>
...
pivot_root&lt;span class="o">(&lt;/span>&lt;span class="s2">&amp;#34;path_of_rootfs/&amp;#34;&lt;/span>, path&lt;span class="o">)&lt;/span>&lt;span class="p">;&lt;/span>
...
exec&lt;span class="o">(&lt;/span>&lt;span class="s2">&amp;#34;/bin/bash&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>&lt;span class="p">;&lt;/span>
...
&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>å¯¹äºä»£ç ä¸‰ï¼Œè¯¥funå‡½æ•°ç”±ä¸Šé¢ç”Ÿæˆçš„æ–°è¿›ç¨‹æ‰§è¡Œï¼Œåœ¨funå‡½æ•°ä¸­ï¼Œé€šè¿‡&lt;code>pivot_root&lt;/code>ç³»ç»Ÿè°ƒç”¨ï¼Œä½¿è¿›ç¨‹è¿›å…¥æ–°çš„&lt;code>rootfs&lt;/code>ï¼Œä¹‹åé€šè¿‡&lt;code>exec&lt;/code>ç³»ç»Ÿè°ƒç”¨ï¼Œåœ¨æ–°çš„&lt;code>Namespace&lt;/code>,&lt;code>Cgroup&lt;/code>,&lt;code>rootfs&lt;/code>ä¸­æ‰§è¡Œ&lt;code>&amp;quot;/bin/bash&amp;quot;&lt;/code>ç¨‹åºã€‚&lt;/li>
&lt;/ul>
&lt;p>é€šè¿‡ä»¥ä¸Šæ“ä½œï¼ŒæˆåŠŸåœ¨ä¸€ä¸ªâ€œå®¹å™¨â€ä¸­è¿è¡Œäº†ä¸€ä¸ªbashç¨‹åºã€‚å¯¹äºCgroupå’ŒNamespaceçš„æŠ€æœ¯ç»†èŠ‚ï¼Œæˆ‘ä»¬ä¸‹ä¸€èŠ‚è¯¦ç»†æè¿°&lt;/p>
&lt;h3 id="cgroup">Cgroup&lt;/h3>
&lt;h4 id="cgroup-æ˜¯ä»€ä¹ˆ">Cgroup æ˜¯ä»€ä¹ˆ&lt;/h4>
&lt;p>Cgroupæ˜¯control group çš„ç®€å†™ï¼Œå±äº Linux å†…æ ¸æä¾›çš„ä¸€ä¸ªç‰¹æ€§ï¼Œç”¨äºé™åˆ¶å’Œéš”ç¦»ä¸€ç»„è¿›ç¨‹å¯¹ç³»ç»Ÿèµ„æºçš„ä½¿ç”¨ã€‚è¿™äº›èµ„æºä¸»è¦åŒ…æ‹¬ CPUï¼Œ å†…å­˜ï¼Œ block I/Oï¼ˆæ•°æ®å— I/Oï¼‰ å’Œç½‘ç»œå®½å¸¦ã€‚
Cgroup ä» 2.6.24ç‰ˆæœ¬è¿›å…¥å†…æ ¸ä¸»çº¿ï¼Œç›®å‰å„å¤§å‘è¡Œç‰ˆlinuxéƒ½é»˜è®¤æ‰“å¼€äº† Cgroup ç‰¹æ€§&lt;/p>
&lt;p>ä»å®ç°çš„è§’åº¦æ¥çœ‹ï¼ŒCgroup å®ç°äº†ä¸€ä¸ªé€šç”¨çš„è¿›ç¨‹åˆ†ç»„çš„æ¡†æ¶ï¼Œè€Œä¸åŒèµ„æºçš„å…·ä½“ç®¡ç†åˆ™æ˜¯ç”±å„ä¸ª Cgroup å­ç³»ç»Ÿå®ç°çš„ã€‚æˆªæ­¢å†…æ ¸4.1ç‰ˆæœ¬ï¼ŒCgroup ä¸­å®ç°çš„å­ç³»ç»Ÿçš„åŠå…¶ä½œç”¨å¦‚ä¸‹ï¼š&lt;/p>
&lt;ul>
&lt;li>devicesï¼š è®¾å¤‡æƒé™æ§åˆ¶&lt;/li>
&lt;li>cpusetï¼š åˆ†é…æŒ‡å®šçš„CPUå’Œå†…å­˜èŠ‚ç‚¹&lt;/li>
&lt;li>cpuï¼š æ§åˆ¶ CPU å ç”¨ç‡&lt;/li>
&lt;li>cpuacctï¼š ç»Ÿè®¡ CPU ä½¿ç”¨æƒ…å†µ&lt;/li>
&lt;li>memoryï¼š é™åˆ¶å†…å­˜çš„ä½¿ç”¨ä¸Šé™&lt;/li>
&lt;li>freezerï¼š å†»ç»“ï¼ˆæš‚åœï¼‰Cgroup ä¸­çš„è¿›ç¨‹&lt;/li>
&lt;li>net_clsï¼š é…åˆtcï¼ˆtraffic controllerï¼‰é™åˆ¶ç½‘ç»œå®½å¸¦&lt;/li>
&lt;li>net_prioï¼š è®¾ç½®è¿›ç¨‹çš„ç½‘ç»œæµé‡ä¼˜å…ˆçº§&lt;/li>
&lt;li>huge_tlbï¼š é™åˆ¶HugeTLBï¼ˆå—è¡¨ç¼“å†²åŒºï¼‰çš„ä½¿ç”¨&lt;/li>
&lt;li>perf_eventï¼š å…è®¸ Perf å·¥å…·åŸºäºCgroupåˆ†ç»„åšæ€§èƒ½æµ‹è¯•&lt;/li>
&lt;/ul>
&lt;h3 id="namespace">Namespace&lt;/h3>
&lt;h4 id="namespace-æ˜¯ä»€ä¹ˆ">Namespace æ˜¯ä»€ä¹ˆ&lt;/h4>
&lt;p>Namespace æ˜¯å°†å†…æ ¸çš„å…¨å±€èµ„æºåšå°è£…ï¼Œä½¿å¾—æ¯ä¸ªNamespaceéƒ½æœ‰æœ‰ä¸€ä»½ç‹¬ç«‹çš„èµ„æºï¼Œå› æ­¤ä¸åŒçš„è¿›ç¨‹å„è‡ªçš„ Namespace å†…å¯¹åŒä¸€ä¸ªèµ„æºçš„ä½¿ç”¨ä¸ä¼šäº’ç›¸å¹²æ‰°ã€‚
ä¸¾ä¸ªä¾‹å­ï¼Œæ‰§è¡Œ sethostname è¿™ä¸ªç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œå¯ä»¥æ”¹å˜ç³»ç»Ÿçš„ä¸»æœºåï¼Œè¿™ä¸ªä¸»æœºåå°±æ˜¯ä¸€ä¸ªå†…æ ¸çš„å…¨å±€èµ„æºã€‚å†…æ ¸é€šè¿‡å®ç° UTS Namespaceï¼Œå¯ä»¥å°†ä¸åŒçš„è¿›ç¨‹åˆ†éš”åœ¨ä¸åŒçš„ UTS Namespace ä¸­ï¼Œåœ¨æŸä¸ª Namespace ä¿®æ”¹ä¸»æœºåæ—¶ï¼Œå¦ä¸€ä¸ª Namespace çš„ä¸»æœºåè¿˜æ˜¯ä¿æŒä¸å˜ã€‚&lt;/p>
&lt;p>ç›®å‰ Linux å†…æ ¸æ€»å…±å®ç°äº†6ç§ Namespaceï¼š&lt;/p>
&lt;ul>
&lt;li>IPCï¼š éš”ç¦» System V IPC å’Œ POSIX æ¶ˆæ¯é˜Ÿåˆ—&lt;/li>
&lt;li>Networkï¼š éš”ç¦»ç½‘ç»œèµ„æº&lt;/li>
&lt;li>Mountï¼š éš”ç¦»æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ç‚¹&lt;/li>
&lt;li>PIDï¼š éš”ç¦»è¿›ç¨‹ ID&lt;/li>
&lt;li>UTSï¼š éš”ç¦»ä¸»æœºåå’ŒåŸŸå&lt;/li>
&lt;li>Userï¼š éš”ç¦»ç”¨æˆ· ID å’Œ ç»„ ID&lt;/li>
&lt;/ul>
&lt;p>Namespace å’Œ Cgroup çš„ä½¿ç”¨æ˜¯çµæ´»çš„ï¼ŒåŒæ—¶ä¹Ÿæœ‰ä¸å°‘éœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼Œå› æ­¤ç›´æ¥æ“ä½œ Namespace å’Œ Cgroup å¹¶ä¸æ˜¯å¾ˆå®¹æ˜“ã€‚æ­£æ˜¯å› ä¸ºè¿™äº›åŸå› ï¼ŒDocker é€šè¿‡ Libcontainer æ¥å¤„ç†è¿™äº›åº•å±‚çš„äº‹æƒ…ã€‚è¿™æ ·ä¸€æ¥ï¼ŒDocker åªéœ€ç®€å•åœ°è°ƒç”¨ Libcontainer çš„ API ï¼Œå°±èƒ½å°†å®Œæ•´çš„å®¹å™¨æ­å»ºèµ·æ¥ã€‚è€Œä½œä¸º Docker çš„ç”¨æˆ·ï¼Œå°±æ›´ä¸ç”¨æ“å¿ƒè¿™äº›äº‹æƒ…äº†ã€‚&lt;/p>
&lt;h3 id="å®¹å™¨é€ å°±-docker">å®¹å™¨é€ å°± Docker&lt;/h3>
&lt;p>å…³äºå®¹å™¨æ˜¯å¦æ˜¯ Docker çš„æŠ€æœ¯æ ¸å¿ƒæŠ€æœ¯ï¼Œä¸šç•Œä¸€ç›´å­˜åœ¨ç€äº‰è®®ã€‚&lt;/p>
&lt;p>åœ¨ç†è§£äº†å®¹å™¨ï¼Œç†è§£äº†å®¹å™¨çš„æ ¸å¿ƒæŠ€æœ¯ Cgroup å’Œ Namespaceï¼Œç†è§£äº†å®¹å™¨æŠ€æœ¯å¦‚ä½•å·§å¦™ä¸”è½»é‡åœ°å®ç°â€œå®¹å™¨â€æœ¬èº«çš„èµ„æºæ§åˆ¶å’Œè®¿é—®éš”ç¦»ä¹‹åï¼Œå¯ä»¥çœ‹åˆ° Docker å’Œå®¹å™¨æ˜¯ä¸€ç§å®Œç¾çš„èåˆå’Œè¾…åŠ©ç›¸æˆçš„å…³ç³»ï¼Œå®ƒä»¬ä¸æ˜¯å”¯ä¸€çš„æ­é…ï¼Œä½†ä¸€å®šæ˜¯æœ€å®Œç¾çš„ç»“åˆï¼ˆç›®å‰æ¥è¯´ï¼‰ã€‚ä¸å…¶è¯´æ˜¯å®¹å™¨é€ å°±äº† Docker ï¼Œ ä¸å¦‚è¯´æ˜¯å®ƒä»¬é€ å°±äº†å½¼æ­¤ï¼Œå®¹å™¨æŠ€æœ¯è®© Docker å¾—åˆ°æ›´å¤šçš„åº”ç”¨å’Œæ¨å¹¿ï¼ŒDocker ä¹Ÿä½¿å¾—å®¹å™¨æŠ€æœ¯è¢«æ›´å¤šäººç†ŸçŸ¥ã€‚&lt;/p>
&lt;h2 id="åŸºæœ¬æ“ä½œ">åŸºæœ¬æ“ä½œ&lt;/h2>
&lt;h3 id="å¯åŠ¨å®¹å™¨">å¯åŠ¨å®¹å™¨&lt;/h3>
&lt;h4 id="æ–°å»ºå¹¶å¯åŠ¨">æ–°å»ºå¹¶å¯åŠ¨&lt;/h4>
&lt;p>æ‰€éœ€çš„å‘½ä»¤æ˜¯ &lt;code>docker run&lt;/code>&lt;/p>
&lt;p>ä¾‹å¦‚ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ docker run ubuntu:14.04 /bin/echo &lt;span class="s1">&amp;#39;hello, worl&amp;#39;&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å®¹å™¨æ‰§è¡Œåé¢çš„å‘½ä»¤ç›´æ¥å°±ä¼šç»ˆæ­¢ .&lt;/p>
&lt;p>ä¸‹é¢çš„å‘½ä»¤ä¼šå¯åŠ¨å®¹å™¨å¹¶èµ·ä¸€ä¸ª bash ç»ˆç«¯,å…è®¸ç”¨æˆ·è¿›è¡Œäº¤äº’&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ docker run -t -i ubuntu:14.04 /bin/bash
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å…¶ä¸­ &lt;code>-t&lt;/code> è®© Docker åˆ†é…ä¸€ä¸ªä¼ªç»ˆç«¯ (pseudo-tty) å¹¶ç»‘å®šåˆ°å®¹å™¨çš„æ ‡å‡†è¾“å…¥ä¸Š, &lt;code>-i&lt;/code> åˆ™è®©å®¹å™¨çš„æ ‡å‡†è¾“å…¥ä¿æŒæ‰“å¼€ .&lt;/p>
&lt;p>åˆ©ç”¨ docker run æ¥åˆ›å»ºå®¹å™¨æ˜¯, Docker åœ¨åå°è¿è¡Œçš„æ ‡å‡†æ“ä½œåŒ…æ‹¬:&lt;/p>
&lt;ul>
&lt;li>æ£€æŸ¥æœ¬åœ°æ˜¯å¦å­˜åœ¨æŒ‡å®šçš„é•œåƒ,ä¸å­˜åœ¨å°±ä»å…±æœ‰ä»“åº“ä¸‹è½½&lt;/li>
&lt;li>åˆ©ç”¨é•œåƒåˆ›å»ºå¹¶å¯åŠ¨ä¸€ä¸ªå®¹å™¨&lt;/li>
&lt;li>åˆ†é…ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿå¹¶åœ¨åªè¯»çš„é•œåƒå±‚å¤–é¢æŒ‚è½½ä¸€å±‚å¯è¯»å†™å±‚&lt;/li>
&lt;li>åœ¨å®¿ä¸»ä¸»æœºé…ç½®çš„ç½‘æ¡¥æ¥å£ä¸­æ¡¥æ¥ä¸€ä¸ªè™šæ‹Ÿæ¥å£åˆ°å®¹å™¨ä¸­å»&lt;/li>
&lt;li>ä»åœ°å€æ± é…ç½®ä¸€ä¸ª ip åœ°å€ç»™å®¹å™¨&lt;/li>
&lt;li>æ‰§è¡Œç”¨æˆ·æŒ‡å®šçš„åº”ç”¨ç¨‹åº&lt;/li>
&lt;li>æ‰§è¡Œå®Œæ¯•åå®¹å™¨ç»ˆæ­¢&lt;/li>
&lt;/ul>
&lt;h4 id="å¯åŠ¨å·²ç»ˆæ­¢å®¹å™¨">å¯åŠ¨å·²ç»ˆæ­¢å®¹å™¨&lt;/h4>
&lt;p>å¯ä»¥åˆ©ç”¨ &lt;code>docker start&lt;/code> å‘½ä»¤,ç›´æ¥å°†ä¸€ä¸ªå·²ç»ç»ˆæ­¢çš„å®¹å™¨å¯åŠ¨è¿è¡Œ .&lt;/p>
&lt;p>å¯ä»¥é€šè¿‡ &lt;code>docker ps -a&lt;/code> æŸ¥çœ‹æ‰€æœ‰çš„å®¹å™¨å’Œå…¶çŠ¶æ€&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES
aada74689bf7 cockroachdb/cockroach &lt;span class="s2">&amp;#34;/cockroach/cockro...&amp;#34;&lt;/span> &lt;span class="m">3&lt;/span> weeks ago Exited &lt;span class="o">(&lt;/span>137&lt;span class="o">)&lt;/span> &lt;span class="m">3&lt;/span> weeks ago roach_master
2e9eb6cf3f66 owncloud &lt;span class="s2">&amp;#34;/entrypoint.sh ap...&amp;#34;&lt;/span> &lt;span class="m">3&lt;/span> weeks ago Up &lt;span class="m">3&lt;/span> weeks 0.0.0.0:80-&amp;gt;80/tcp owncloud
91290c737c73 postgres &lt;span class="s2">&amp;#34;docker-entrypoint...&amp;#34;&lt;/span> &lt;span class="m">3&lt;/span> weeks ago Up &lt;span class="m">3&lt;/span> weeks 5432/tcp owncloud-postgres
8f546ec65e61 mysql &lt;span class="s2">&amp;#34;docker-entrypoint...&amp;#34;&lt;/span> &lt;span class="m">3&lt;/span> weeks ago Up &lt;span class="m">3&lt;/span> weeks 0.0.0.0:3306-&amp;gt;3306/tcp mysql
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¸éš¾å‘ç° name ä¸º roch_master çš„å®¹å™¨å·²ç»ç»ˆæ­¢äº†,æƒ³é‡æ–°å¯åŠ¨å®ƒ,å¯ä»¥æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ docker start aada74689bf7
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å‚æ•°ä¸ºå®¹å™¨çš„ id .&lt;/p>
&lt;h3 id="åå°-background-è¿è¡Œ">åå°( background )è¿è¡Œ&lt;/h3>
&lt;p>åœ¨å¾ˆå¤šæ—¶å€™,æˆ‘ä»¬éœ€è¦è®© docker åœ¨åå°è¿è¡Œè€Œå¹¶ä¸æ˜¯æŠŠæ‰§è¡Œç»“æœç›´æ¥è¾“å‡ºå‡ºæ¥.&lt;/p>
&lt;p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥æ·»åŠ  &lt;code>-d&lt;/code> å‚æ•°æ¥å®ç°&lt;/p>
&lt;p>å¦‚æœä½¿ç”¨ &lt;code>-d&lt;/code> å‚æ•°è¿è¡Œå®¹å™¨&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ docker run -d mysql:5.7.17
77b2dc01fe0f3f1265df143181e7b9af5e05279a884f4776ee75350ea9d8017a
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åªä¼šè¾“å‡ºè¿è¡Œçš„å®¹å™¨ id, è€Œè¾“å‡ºç»“æœå¯ä»¥ç”¨ docker logs æŸ¥çœ‹ .&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ docker logs &lt;span class="o">[&lt;/span>container ID or NAMES&lt;span class="o">]&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="ç»ˆæ­¢å®¹å™¨">ç»ˆæ­¢å®¹å™¨&lt;/h3>
&lt;p>å¯ä»¥ä½¿ç”¨ &lt;code>docker stop&lt;/code> æ¥ç»ˆæ­¢æ­£åœ¨è¿è¡Œçš„å®¹å™¨ .&lt;/p>
&lt;p>æ­¤å¤–,å½“ Docker å®¹å™¨ä¸­æŒ‡å®šçš„åº”ç”¨ç»ˆç»“æ—¶, å®¹å™¨ä¹Ÿè‡ªåŠ¨ç»ˆæ­¢ . ä¾‹å¦‚è¿è¡Œä¸€ä¸ªå®¹å™¨æ—¶,æŒ‡å®šäº†ä¸€ä¸ªç»ˆç«¯å,å½“é€€å‡ºç»ˆç«¯çš„æ—¶å€™,æ‰€åˆ›å»ºçš„å®¹å™¨ä¹Ÿä¼šç«‹åˆ»ç»ˆæ­¢ .&lt;/p>
&lt;p>ç»ˆæ­¢çŠ¶æ€çš„å®¹å™¨, å¯ä»¥é€šè¿‡ &lt;code>docker start&lt;/code> æ¥é‡æ–°å¯åŠ¨ .&lt;/p>
&lt;p>æ­¤å¤–,&lt;code>docker restart&lt;/code> å‘½ä»¤ä¼šå°†ä¸€ä¸ªè¿è¡Œæ€çš„å®¹å™¨ç»ˆæ­¢,ç„¶åé‡æ–°å¯åŠ¨å®ƒ .&lt;/p>
&lt;h3 id="è¿›å…¥å®¹å™¨">è¿›å…¥å®¹å™¨&lt;/h3>
&lt;p>åœ¨ä½¿ç”¨ &lt;code>-d&lt;/code> å‚æ•°æ—¶, docker å®¹å™¨ä¼šåœ¨åå°è¿è¡Œ. æœ‰äº›æ—¶å€™éœ€è¦è¿›å…¥å®¹å™¨,å¦‚è¿è¡Œæ•°æ®åº“æ—¶,éœ€è¦è¿›å…¥å¢åˆ æ”¹æŸ¥åº“é‡Œçš„å†…å®¹. è¿›å…¥å®¹å™¨æœ‰å¾ˆå¤šç§åŠæ³•.&lt;/p>
&lt;h4 id="attach-å‘½ä»¤">attach å‘½ä»¤&lt;/h4>
&lt;p>&lt;code>docker attach&lt;/code> æ˜¯ Docker è‡ªå¸¦çš„å‘½ä»¤,ç”¨æ³•&lt;/p>
&lt;p>ä½†æ˜¯ä½¿ç”¨ &lt;code>attach&lt;/code> å‘½ä»¤æœ‰ä¸ªç¼ºé™·,å³å¤šä¸ªçª—å£åŒæ—¶ç”¨ attach å‘½ä»¤åˆ°åŒä¸€ä¸ªå®¹å™¨çš„æ—¶å€™,æ‰€æœ‰çš„çª—å£éƒ½æ˜¯åŒæ­¥æ˜¾ç¤ºçš„,å¦‚æœå…¶ä¸­ä¸€ä¸ªçª—å£é˜»å¡çš„æ—¶å€™,å…¶ä»–çª—å£ä¹Ÿæ— æ³•ä½¿ç”¨ .&lt;/p>
&lt;h4 id="nsenter-å‘½ä»¤">nsenter å‘½ä»¤&lt;/h4>
&lt;p>è¿™ä¸ªå·¥å…·éœ€è¦ç”¨å¦‚ä¸‹å‘½ä»¤å®‰è£…&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ docker run --rm -v /usr/local/bin:/target jpetazzo/nsenter
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä½¿ç”¨æ–¹æ³•ä¹Ÿæ¯”è¾ƒç®€å•,é¦–å…ˆæ˜¯ä½ è¦è¿›å…¥çš„å®¹å™¨çš„ ID&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ &lt;span class="nv">PID&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>docker inspect --format &lt;span class="o">{{&lt;/span>.State.Pid&lt;span class="o">}}&lt;/span> &amp;lt;container ID or NAMES&amp;gt;&lt;span class="k">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç„¶åé€šè¿‡è¿™ä¸ª PID è¿›å…¥å®¹å™¨&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ nsenter --target &lt;span class="nv">$PID&lt;/span> --mount --uts --ipc --net --pid
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœæ— æ³•é€šè¿‡ä¸Šè¿°çš„å‘½ä»¤è¿æ¥åˆ°å®¹å™¨,æœ‰å¯èƒ½æ˜¯å› ä¸ºå®¿ä¸»çš„é»˜è®¤ shell åœ¨å®¹å™¨ä¸­å¹¶ä¸å­˜åœ¨,æ¯”å¦‚ zsh, å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æ˜¾ç¤ºåœ°ä½¿ç”¨ bash .&lt;/p>
&lt;h4 id="exec-å‘½ä»¤">exec å‘½ä»¤&lt;/h4>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="nv">$docker&lt;/span> &lt;span class="nb">exec&lt;/span> -it &lt;span class="o">[&lt;/span>container ID or NAMES&lt;span class="o">]&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>-i&lt;/code> &lt;code>-t&lt;/code> å‰é¢è¯´è¿‡ä¸ºäº†æ ‡å‡†è¾“å…¥è¾“å‡ºä¿æŒæ‰“å¼€ .&lt;/p>
&lt;h3 id="å¯¼å‡ºå’Œå¯¼å…¥å®¹å™¨">å¯¼å‡ºå’Œå¯¼å…¥å®¹å™¨&lt;/h3>
&lt;h4 id="å¯¼å‡ºå®¹å™¨">å¯¼å‡ºå®¹å™¨&lt;/h4>
&lt;p>å¦‚æœè¦å¯¼å‡ºæœ¬åœ°æŸä¸ªå®¹å™¨,å¯ä»¥ä½¿ç”¨ &lt;code>docker export&lt;/code> å‘½ä»¤ .&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ docker &lt;span class="nb">export&lt;/span> &lt;span class="o">[&lt;/span>container ID or NAMES&lt;span class="o">]&lt;/span> &amp;gt; target.tar
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¿™æ ·å°†å¯¼å‡ºå®¹å™¨å¿«ç…§åˆ°æœ¬åœ°æ–‡ä»¶ .&lt;/p>
&lt;h4 id="å¯¼å…¥å®¹å™¨å¿«ç…§">å¯¼å…¥å®¹å™¨å¿«ç…§&lt;/h4>
&lt;p>å¯ä»¥ä½¿ç”¨ &lt;code>docker import&lt;/code> ä»å®¹å™¨å¿«ç…§æ–‡ä»¶å¯¼å…¥é•œåƒ,&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ cat target.tar &lt;span class="p">|&lt;/span> docker import - test/mysql:v1.0
$ sudo docker images
REPOSITORY TAG IMAGE ID CREATED VIRTUAL SIZE
test/ubuntu v1.0 9d37a6082e97 About a minute ago 171.3 MB
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ­¤å¤–,è¿˜å¯ä»¥é€šè¿‡æŒ‡å®š URL æˆ–è€…æŸä¸ªç›®å½•æ¥å¯¼å…¥&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ docker import http://example.com/exampleimage.tgz example/imagerepo
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>*æ³¨ï¼šç”¨æˆ·æ—¢å¯ä»¥ä½¿ç”¨ docker load æ¥å¯¼å…¥é•œåƒå­˜å‚¨æ–‡ä»¶åˆ°æœ¬åœ°é•œåƒåº“,ä¹Ÿå¯ä»¥ä½¿ç”¨ docker import æ¥å¯¼å…¥ä¸€ä¸ªå®¹å™¨å¿«ç…§åˆ°æœ¬åœ°é•œåƒåº“ .è¿™ä¸¤è€…çš„åŒºåˆ«åœ¨äºå®¹å™¨å¿«ç…§æ–‡ä»¶å°†ä¸¢å¼ƒæ‰€æœ‰çš„å†å²è®°å½•å’Œå…ƒæ•°æ®ä¿¡æ¯ï¼ˆå³ä»…ä¿å­˜å®¹å™¨å½“æ—¶çš„å¿«ç…§çŠ¶æ€ï¼‰,è€Œé•œåƒå­˜å‚¨æ–‡ä»¶å°†ä¿å­˜å®Œæ•´è®°å½•,ä½“ç§¯ä¹Ÿè¦å¤§ .æ­¤å¤–,ä»å®¹å™¨å¿«ç…§æ–‡ä»¶å¯¼å…¥æ—¶å¯ä»¥é‡æ–°æŒ‡å®šæ ‡ç­¾ç­‰å…ƒæ•°æ®ä¿¡æ¯ .&lt;/p>
&lt;h3 id="åˆ é™¤å®¹å™¨">åˆ é™¤å®¹å™¨&lt;/h3>
&lt;h4 id="å•ç‹¬åˆ é™¤">å•ç‹¬åˆ é™¤&lt;/h4>
&lt;p>å¯ä»¥ä½¿ç”¨ &lt;code>docker rm&lt;/code> æ¥åˆ é™¤ä¸€ä¸ªå¤„äºç»ˆæ­¢çŠ¶æ€çš„å®¹å™¨ .&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ docker rm &lt;span class="o">[&lt;/span>container ID or NAMES&lt;span class="o">]&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœè¦åˆ é™¤ä¸€ä¸ªè¿è¡Œä¸­çš„å®¹å™¨,å¯ä»¥æ·»åŠ  &lt;code>-f&lt;/code> å‚æ•° .Docker ä¼šå‘é€ &lt;code>SIGKILL&lt;/code> ä¿¡å·ç»™å®¹å™¨ .&lt;/p>
&lt;h4 id="æ¸…ç†æ‰€æœ‰å¤„äºç»ˆæ­¢çŠ¶æ€çš„å®¹å™¨">æ¸…ç†æ‰€æœ‰å¤„äºç»ˆæ­¢çŠ¶æ€çš„å®¹å™¨&lt;/h4>
&lt;p>ç”¨ &lt;code>docker ps -a&lt;/code> å‘½ä»¤å¯ä»¥æŸ¥çœ‹æ‰€æœ‰å·²åˆ›å»ºçš„åŒ…æ‹¬ç»ˆæ­¢çŠ¶æ€çš„å®¹å™¨,å¦‚æœæƒ³æ‰¹é‡åˆ é™¤å¤šä¸ªå®¹å™¨çš„è¯(å½“ç„¶æ˜¯ç»ˆæ­¢çŠ¶æ€çš„å®¹å™¨) ,å¯ä»¥ç”¨è¿™ä¸ªå‘½ä»¤&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ docker rm &lt;span class="k">$(&lt;/span>docker ps -a -q&lt;span class="k">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>*æ³¨æ„ï¼šè¿™ä¸ªå‘½ä»¤å…¶å®ä¼šè¯•å›¾åˆ é™¤æ‰€æœ‰çš„åŒ…æ‹¬è¿˜åœ¨è¿è¡Œä¸­çš„å®¹å™¨,ä¸è¿‡å°±åƒä¸Šé¢æè¿‡çš„ docker rm é»˜è®¤å¹¶ä¸ä¼šåˆ é™¤è¿è¡Œä¸­çš„å®¹å™¨ .&lt;/p>
&lt;h2 id="è®¿é—®ä»“åº“">è®¿é—®ä»“åº“&lt;/h2>
&lt;p>ä»“åº“ï¼ˆRepositoryï¼‰æ˜¯é›†ä¸­å­˜æ”¾é•œåƒçš„åœ°æ–¹ .&lt;/p>
&lt;p>ä¸€ä¸ªå®¹æ˜“æ··æ·†çš„æ¦‚å¿µæ˜¯æ³¨å†ŒæœåŠ¡å™¨ï¼ˆRegistryï¼‰ .å®é™…ä¸Šæ³¨å†ŒæœåŠ¡å™¨æ˜¯ç®¡ç†ä»“åº“çš„å…·ä½“æœåŠ¡å™¨,æ¯ä¸ªæœåŠ¡å™¨ä¸Šå¯ä»¥æœ‰å¤šä¸ªä»“åº“,è€Œæ¯ä¸ªä»“åº“ä¸‹é¢æœ‰å¤šä¸ªé•œåƒ .ä»è¿™æ–¹é¢æ¥è¯´,ä»“åº“å¯ä»¥è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªå…·ä½“çš„é¡¹ç›®æˆ–ç›®å½• .ä¾‹å¦‚å¯¹äºä»“åº“åœ°å€dl.dockerpool.com/ubuntu æ¥è¯´, dl.dockerpool.com æ˜¯æ³¨å†ŒæœåŠ¡å™¨åœ°å€, ubuntu æ˜¯ä»“åº“å .&lt;/p>
&lt;p>å¤§éƒ¨åˆ†æ—¶å€™,å¹¶ä¸éœ€è¦ä¸¥æ ¼åŒºåˆ†è¿™ä¸¤è€…çš„æ¦‚å¿µ .&lt;/p>
&lt;h3 id="docker-hub">Docker Hub&lt;/h3>
&lt;p>ç›®å‰ Docker å®˜æ–¹ç»´æŠ¤äº†ä¸€ä¸ªå…¬å…±ä»“åº“ &lt;a href="https://hub.docker.com/explore/">Docker Hub&lt;/a>, ä½†æ˜¯å¼€å§‹æŠŠé˜µåœ°ç§»åˆ° &lt;a href="https://store.docker.com/">Docker Store&lt;/a> è¿™ä¸ªå¹³å°ä¸Š,å…¶ä¸Šèƒ½æ‰¾åˆ°å‡ ä¹æ‰€æœ‰çš„èƒ½æƒ³å¾—åˆ°çš„å®¹å™¨, ä¸å¯å°è§‘ .&lt;/p>
&lt;h4 id="ç™»å½•">ç™»å½•&lt;/h4>
&lt;p>å¯ä»¥é€šè¿‡æ‰§è¡Œ docker login å‘½ä»¤æ¥è¾“å…¥ç”¨æˆ·åã€å¯†ç å’Œé‚®ç®±æ¥å®Œæˆæ³¨å†Œå’Œç™»å½• . æ³¨å†ŒæˆåŠŸå,æœ¬åœ°ç”¨æˆ·ç›®å½•çš„.dockercfg ä¸­å°†ä¿å­˜ç”¨æˆ·çš„è®¤è¯ä¿¡æ¯ .&lt;/p>
&lt;h4 id="åŸºæœ¬æ“ä½œ-1">åŸºæœ¬æ“ä½œ&lt;/h4>
&lt;p>ç”¨æˆ·æ— éœ€ç™»å½•å³å¯é€šè¿‡ &lt;code>docker search&lt;/code> å‘½ä»¤æ¥æŸ¥æ‰¾å®˜æ–¹ä»“åº“ä¸­çš„é•œåƒ, å¹¶åˆ©ç”¨ &lt;code>docker pull&lt;/code> å‘½ä»¤æ¥å°†å®ƒä¸‹è½½åˆ°æœ¬åœ° .&lt;/p>
&lt;p>ä»¥æœç´¢ mongo ä¸ºå…³é”®å­—æœç´¢:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ docker search mongo
NAME DESCRIPTION STARS OFFICIAL AUTOMATED
mongo MongoDB document databases provide high av... &lt;span class="m">3427&lt;/span> &lt;span class="o">[&lt;/span>OK&lt;span class="o">]&lt;/span>
mongo-express Web-based MongoDB admin interface, written... &lt;span class="m">168&lt;/span> &lt;span class="o">[&lt;/span>OK&lt;span class="o">]&lt;/span>
mvertes/alpine-mongo light MongoDB container &lt;span class="m">51&lt;/span> &lt;span class="o">[&lt;/span>OK&lt;span class="o">]&lt;/span>
mongoclient/mongoclient Official docker image &lt;span class="k">for&lt;/span> Mongoclient, fea... &lt;span class="m">29&lt;/span> &lt;span class="o">[&lt;/span>OK&lt;span class="o">]&lt;/span>
torusware/speedus-mongo Always updated official MongoDB docker ima... &lt;span class="m">9&lt;/span> &lt;span class="o">[&lt;/span>OK&lt;span class="o">]&lt;/span>
mongooseim/mongooseim-docker MongooseIM server the latest stable version &lt;span class="m">9&lt;/span> &lt;span class="o">[&lt;/span>OK&lt;span class="o">]&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>â€‹æœç´¢ç»“æœå¯ä»¥çœ‹åˆ°å¾ˆå¤šåŒ…å«å…³é”®å­—çš„é•œåƒ,å…¶ä¸­åŒ…æ‹¬é•œåƒåå­—ã€æè¿°ã€æ˜Ÿæ•°ï¼ˆè¡¨ç¤ºè¯¥é•œåƒçš„å—æ¬¢è¿ç¨‹åº¦ï¼‰ã€æ˜¯å¦å®˜æ–¹åˆ›å»ºã€æ˜¯å¦è‡ªåŠ¨åˆ›å»º . å®˜æ–¹çš„é•œåƒè¯´æ˜æ˜¯å®˜æ–¹é¡¹ç›®ç»„åˆ›å»ºå’Œç»´æŠ¤çš„,automated èµ„æºå…è®¸ç”¨æˆ·éªŒè¯é•œåƒçš„æ¥æºå’Œå†…å®¹ .&lt;/p>
&lt;p>â€‹æ ¹æ®æ˜¯å¦ä¸ºå®˜æ–¹æä¾›, é•œåƒèµ„æºå¯åˆ†ä¸ºä¸¤ç±» . ä¸€ç±»æ˜¯ç´¯ç±»ä¼¼ mongoè¿™æ ·çš„åŸºç¡€é•œåƒ . è¿™äº›é•œåƒç”± Docker çš„ç”¨æˆ·åˆ›å»ºã€éªŒè¯ã€æ”¯æŒã€æä¾› . è¿™æ ·çš„é•œåƒå¾€å¾€æ˜¯ä½¿ç”¨å•ä¸ªå•è¯ä½œä¸ºåå­— .&lt;/p>
&lt;p>å¦ä¸€ç§ç±»å‹,æ¯”å¦‚&lt;code>mvertes/alpine-mongo&lt;/code> é•œåƒ,å®ƒæ˜¯ç”± Docker çš„ç”¨æˆ·åˆ›å»ºå¹¶ç»´æŠ¤çš„,å¾€å¾€å¸¦æœ‰ç”¨æˆ·åç§°å‰ç¼€ . å¯ä»¥é€šè¿‡å‰ç¼€ &lt;code>user_name/&lt;/code> æ¥æŒ‡å®šä½¿ç”¨æŸä¸ªç”¨æˆ·æä¾›çš„é•œåƒ .&lt;/p>
&lt;p>å¦å¤–,åœ¨æŸ¥æ‰¾çš„æ—¶å€™é€šè¿‡ &lt;code>-s N&lt;/code> å‚æ•°å¯ä»¥æŒ‡å®šä»…æ˜¾ç¤ºæ˜Ÿæ•°ä¸º N ä»¥ä¸Šçš„é•œåƒ ï¼ˆæ–°ç‰ˆæœ¬çš„ Docker æ¨èä½¿ç”¨ &lt;code>--flter=stars=N&lt;/code> å‚æ•°ï¼‰ .&lt;/p>
&lt;p>ä¸‹è½½é•œåƒåˆ°æœ¬åœ°&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ sudo docker pull centos
Pulling repository centos
0b443ba03958: Download &lt;span class="nb">complete&lt;/span>
539c0211cd76: Download &lt;span class="nb">complete&lt;/span>
511136ea3c5a: Download &lt;span class="nb">complete&lt;/span>
7064731afe90: Download &lt;span class="nb">complete&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç”¨æˆ·ä¹Ÿå¯ä»¥ç™»å½•ä¹‹åé€šè¿‡ &lt;code>docker push&lt;/code> å‘½ä»¤æ¥è®²é•œåƒæ¨é€åˆ° Docker Hub .&lt;/p>
&lt;h4 id="è‡ªåŠ¨åˆ›å»º">è‡ªåŠ¨åˆ›å»º&lt;/h4>
&lt;p>â€‹è‡ªåŠ¨åˆ›å»ºï¼ˆautomated buildsï¼‰åŠŸèƒ½å¯¹äºéœ€è¦ç»å¸¸å‡çº§é•œåƒå†…ç¨‹åºæ¥è¯´,ååˆ†æ–¹ä¾¿ .æœ‰æ—¶å€™,ç”¨æˆ·åˆ›å»ºäº†é•œåƒå®‰è£…äº†æŸä¸ªè½¯ä»¶,å¦‚æœè½¯ä»¶å‘å¸ƒæ–°ç‰ˆæœ¬åˆ™éœ€è¦æ‰‹åŠ¨æ›´æ–°é•œåƒ . .è€Œè‡ªåŠ¨åˆ›å»ºå…è®¸ç”¨æˆ·é€šè¿‡ Docker Hub æŒ‡å®šè·Ÿè¸ªä¸€ä¸ªç›®æ ‡ç½‘ç«™ï¼ˆç›®å‰æ”¯æŒ GitHubæˆ– BitBucketï¼‰ä¸Šçš„é¡¹ç›®,ä¸€æ—¦é¡¹ç›®å‘ç”Ÿæ–°çš„æäº¤,åˆ™è‡ªåŠ¨æ‰§è¡Œåˆ›å»º .&lt;/p>
&lt;p>è¦é…ç½®è‡ªåŠ¨åˆ›å»º,åŒ…æ‹¬å¦‚ä¸‹çš„æ­¥éª¤ï¼š&lt;/p>
&lt;ul>
&lt;li>åˆ›å»ºå¹¶ç™»å½• Docker Hub,ä»¥åŠç›®æ ‡ç½‘ç«™ï¼›&lt;/li>
&lt;li>åœ¨ç›®æ ‡ç½‘ç«™ä¸­è¿æ¥å¸æˆ·åˆ° Docker Hubï¼›&lt;/li>
&lt;li>åœ¨ Docker Hub ä¸­ é…ç½®ä¸€ä¸ªè‡ªåŠ¨åˆ›å»ºï¼›&lt;/li>
&lt;li>é€‰å–ä¸€ä¸ªç›®æ ‡ç½‘ç«™ä¸­çš„é¡¹ç›®ï¼ˆéœ€è¦å« Dockerfileï¼‰å’Œåˆ†æ”¯ï¼›&lt;/li>
&lt;li>æŒ‡å®š Dockerfile çš„ä½ç½®,å¹¶æäº¤åˆ›å»º .&lt;/li>
&lt;/ul>
&lt;p>ä¹‹å,å¯ä»¥ åœ¨Docker Hub çš„ è‡ªåŠ¨åˆ›å»ºé¡µé¢ ä¸­è·Ÿè¸ªæ¯æ¬¡åˆ›å»ºçš„çŠ¶æ€ .&lt;/p>
&lt;h3 id="ç§æœ‰ä»“åº“">ç§æœ‰ä»“åº“&lt;/h3>
&lt;p>æœ‰æ—¶å€™ä½¿ç”¨ Docker Hub è¿™æ ·çš„å…¬å…±ä»“åº“ç”±äºç½‘ç»œç­‰åŸå› å¯èƒ½ä¸æ–¹ä¾¿,ç”¨æˆ·å¯ä»¥åˆ›å»ºä¸€ä¸ªæœ¬åœ°ä»“åº“ä¾›ç§äººä½¿ç”¨ .&lt;/p>
&lt;p>éœ€è¦ç”¨åˆ° &lt;code>docker-registry&lt;/code> å·¥å…· .&lt;/p>
&lt;p>&lt;code>docker-registry&lt;/code> æ˜¯å®˜æ–¹æä¾›çš„å·¥å…·,å¯ä»¥ç”¨äºæ„å»ºç§æœ‰çš„é•œåƒä»“åº“ .&lt;/p>
&lt;h4 id="å®‰è£…è¿è¡Œ-docker-registry">å®‰è£…è¿è¡Œ docker-registry&lt;/h4>
&lt;h5 id="å®¹å™¨è¿è¡Œ">å®¹å™¨è¿è¡Œ&lt;/h5>
&lt;p>åœ¨å®‰è£…äº† Docker å,å¯ä»¥é€šè¿‡è·å–å®˜æ–¹ registry é•œåƒæ¥è¿è¡Œ .&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ docker run -d -p 5000:5000 registry
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¿™å°†ä½¿ç”¨å®˜æ–¹çš„ registry é•œåƒæ¥å¯åŠ¨æœ¬åœ°çš„ç§æœ‰ä»“åº“ .ç”¨æˆ·å¯ä»¥é€šè¿‡åˆ¶å®šå‚æ•°æ¥é…ç½®ç§æœ‰ä»“åº“ä½ç½®,ä¾‹å¦‚é…ç½®é•œåƒå­˜å‚¨åˆ° Amazon S3 æœåŠ¡ .&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ sudo docker run &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span>-e &lt;span class="nv">SETTINGS_FLAVOR&lt;/span>&lt;span class="o">=&lt;/span>s3 &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span>-e &lt;span class="nv">AWS_BUCKET&lt;/span>&lt;span class="o">=&lt;/span>acme-docker &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span>-e &lt;span class="nv">STORAGE_PATH&lt;/span>&lt;span class="o">=&lt;/span>/registry &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span>-e &lt;span class="nv">AWS_KEY&lt;/span>&lt;span class="o">=&lt;/span>AKIAHSHB43HS3J92MXZ &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span>-e &lt;span class="nv">AWS_SECRET&lt;/span>&lt;span class="o">=&lt;/span>xdDowwlK7TJajV1Y7EoOZrmuPEJlHYcNP2k4j49T
&lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span>-e &lt;span class="nv">SEARCH_BACKEND&lt;/span>&lt;span class="o">=&lt;/span>sqlalchemy &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span>-p 5000:5000 &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span>registry
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ­¤å¤–,è¿˜å¯ä»¥æŒ‡å®šæœ¬åœ°è·¯å¾„ï¼ˆå¦‚&lt;code>/home/user/registry-conf&lt;/code> ï¼‰ä¸‹çš„é…ç½®æ–‡ä»¶ .&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ sudo docker run -d -p 5000:5000 -v /home/user/registry-conf:/r
egistry-conf -e &lt;span class="nv">DOCKER_REGISTRY_CONFIG&lt;/span>&lt;span class="o">=&lt;/span>/registry-conf/config.yml
registry
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é»˜è®¤æƒ…å†µä¸‹,ä»“åº“ä¼šè¢«åˆ›å»ºåœ¨å®¹å™¨çš„ &lt;code>/var/lib/registry&lt;/code> ä¸‹ .å¯ä»¥é€šè¿‡ &lt;code>-v&lt;/code> å‚æ•°æ¥å°†é•œåƒæ–‡ä»¶å­˜æ”¾åœ¨æœ¬åœ°çš„æŒ‡å®šè·¯å¾„ . ä¾‹å¦‚ä¸‹é¢çš„ä¾‹å­å°†ä¸Šä¼ çš„é•œåƒæ”¾åˆ° &lt;code>/opt/data/registy&lt;/code> ç›®å½• .&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ sudo docker run -d -p 5000:5000 -v /opt/data/registry:/var/lib
/registry registry
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="æœ¬åœ°å®‰è£…">æœ¬åœ°å®‰è£…&lt;/h4>
&lt;p>å¯¹äº Ubuntu æˆ– CentOS ç­‰å‘è¡Œç‰ˆ,å¯ä»¥ç›´æ¥å®‰è£… .&lt;/p>
&lt;ul>
&lt;li>Ubuntu&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ sudo apt-get install -y build-essential python-dev libevent-dev python-pip liblzma-dev
$ sudo pip install docker-registry
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>CentOS&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ sudo yum install -y python-devel libevent-devel python-pip gcc xz-devel
$ sudo python-pip install docker-registry
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¹Ÿå¯ä»¥ä» docker-registry é¡¹ç›®ä¸‹è½½æºç è¿›è¡Œå®‰è£… .&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ sudo apt-get install build-essential python-dev libevent-dev python-pip libssl-dev liblzma-dev libffi-dev
$ git clone https://github.com/docker/docker-registry.git
$ &lt;span class="nb">cd&lt;/span> docker-registry
$ sudo python setup.py install
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç„¶åä¿®æ”¹é…ç½®æ–‡ä»¶,ä¸»è¦ä¿®æ”¹ dev æ¨¡æ¿æ®µçš„ &lt;code>storage_path&lt;/code> åˆ°æœ¬åœ°çš„å­˜å‚¨ä»“åº“çš„è·¯å¾„ .&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ cp config/config_sample.yml config/config.yml
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¹‹åå¯åŠ¨ web æœåŠ¡ .&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ sudo gunicorn -c contrib/gunicorn.py docker_registry.wsgi:application
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æˆ–è€…&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ sudo gunicorn --access-logfile - --error-logfile - -k gevent -b 0.0.0.0:5000 -w &lt;span class="m">4&lt;/span> --max-requests &lt;span class="m">100&lt;/span> docker_registry.wsgi:application
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ­¤æ—¶ä½¿ç”¨ crul è®¿é—®æœ¬åœ°çš„ 5000 ç«¯å£,çœ‹åˆ°è¾“å‡º docker-registry çš„ç‰ˆæœ¬ä¿¡æ¯è¯´æ˜è¿è¡ŒæˆåŠŸ .&lt;/p>
&lt;p>*æ³¨ ï¼š &lt;code>config/config_sample.yml&lt;/code> æ–‡ä»¶æ—¶ç¤ºä¾‹é…ç½®æ–‡ä»¶&lt;/p>
&lt;h4 id="åœ¨ç§æœ‰ä»“åº“ä¸Šä¼ ä¸‹è½½æœç´¢é•œåƒ">åœ¨ç§æœ‰ä»“åº“ä¸Šä¼ ã€ä¸‹è½½ã€æœç´¢é•œåƒ&lt;/h4>
&lt;p>åˆ›å»ºå¥½ç§æœ‰ä»“åº“ä¹‹å,å°±å¯ä»¥ä½¿ç”¨ &lt;code>docker tag&lt;/code> æ¥æ ‡è®°ä¸€ä¸ªé•œåƒ,ç„¶åæ¨é€å®ƒåˆ°ä»“åº“,åˆ«çš„æœºå™¨ä¸Šå°±å¯ä»¥ä¸‹è½½äº† .å¦‚ ç§æœ‰ä»“åº“åœ°å€ä¸º &lt;code>1192.168.7.26:5000&lt;/code>&lt;/p>
&lt;p>å…ˆåœ¨æœ¬æœºä¸ŠæŸ¥çœ‹å·²æœ‰çš„é•œåƒ .&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ docker images
REPOSITORY TAG IMAGE ID CREATED SIZE
node latest f93ba6280cbd &lt;span class="m">3&lt;/span> weeks ago 667MB
cockroachdb/cockroach latest 404f7ee26d38 &lt;span class="m">4&lt;/span> weeks ago 163MB
postgres latest ca3a55649cfc &lt;span class="m">7&lt;/span> weeks ago 269MB
tomcat latest 0785a1d16826 &lt;span class="m">7&lt;/span> weeks ago 367MB
owncloud latest 2327c8d59618 &lt;span class="m">8&lt;/span> weeks ago 572MB
mysql latest e799c7f9ae9c &lt;span class="m">2&lt;/span> months ago 407MB
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä½¿ç”¨ &lt;code>docker tag&lt;/code> å°† &lt;code>tomcat&lt;/code> è¿™ä¸ªé•œåƒæ ‡è®°ä¸º &lt;code>192.168.7.26ï¼š5000/test&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="o">[&lt;/span>root@vultr ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># docker tag tomcat 192.168.7.26:5000/test&lt;/span>
&lt;span class="o">[&lt;/span>root@vultr ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># docker images&lt;/span>
REPOSITORY TAG IMAGE ID CREATED SIZE
node latest f93ba6280cbd &lt;span class="m">3&lt;/span> weeks ago 667MB
cockroachdb/cockroach latest 404f7ee26d38 &lt;span class="m">4&lt;/span> weeks ago 163MB
postgres latest ca3a55649cfc &lt;span class="m">7&lt;/span> weeks ago 269MB
192.168.7.26:5000/test latest 0785a1d16826 &lt;span class="m">7&lt;/span> weeks ago 367MB
tomcat latest 0785a1d16826 &lt;span class="m">7&lt;/span> weeks ago 367MB
owncloud latest 2327c8d59618 &lt;span class="m">8&lt;/span> weeks ago 572MB
mysql latest e799c7f9ae9c &lt;span class="m">2&lt;/span> months ago 407MB
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç”¨ &lt;code>docker push&lt;/code> ä¸Šä¼ æ ‡è®°çš„é•œåƒ .&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ docker push 192.168.7.26:5000/test
The push refers to a repository &lt;span class="o">[&lt;/span>192.168.7.26:5000/test&lt;span class="o">]&lt;/span> &lt;span class="o">(&lt;/span>len: 1&lt;span class="o">)&lt;/span>
Sending image list
Pushing repository 192.168.7.26:5000/test &lt;span class="o">(&lt;/span>&lt;span class="m">1&lt;/span> tags&lt;span class="o">)&lt;/span>
Image 511136ea3c5a already pushed, skipping
Image 9bad880da3d2 already pushed, skipping
Image 25f11f5fb0cb already pushed, skipping
Image ebc34468f71d already pushed, skipping
Image 2318d26665ef already pushed, skipping
Image ba5877dc9bec already pushed, skipping
Pushing tag &lt;span class="k">for&lt;/span> rev &lt;span class="o">[&lt;/span>ba5877dc9bec&lt;span class="o">]&lt;/span> on &lt;span class="o">{&lt;/span>http://192.168.7.26:5000/
v1/repositories/test/tags/latest&lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç”¨ &lt;code>curl&lt;/code> æŸ¥çœ‹ä»“åº“ä¸­çš„é•œåƒ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">curl http://192.168.7.26:5000/v1/search
&lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;num_results&amp;#34;&lt;/span>: 7, &lt;span class="s2">&amp;#34;query&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;results&amp;#34;&lt;/span>: &lt;span class="o">[{&lt;/span>&lt;span class="s2">&amp;#34;description&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;name&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;library/miaxis_j2ee&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span>, &lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;description&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;name&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;library/tomcat&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span>, &lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;description&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;name&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;library/ubuntu&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span>, &lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;description&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;name&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;library/ubuntu_office&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span>, &lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;description&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;name&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;library/desktop_ubu&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span>, &lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;description&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;name&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;dockerfile/ubuntu&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span>, &lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;description&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;name&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;library/test&amp;#34;&lt;/span>&lt;span class="o">}]}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¿™é‡Œå¯ä»¥çœ‹åˆ° &lt;code>{&amp;quot;description&amp;quot;: &amp;quot;&amp;quot;, &amp;quot;name&amp;quot;: &amp;quot;library/test&amp;quot;}&lt;/code> ,è¡¨é¢é•œåƒå·²ç»ä¸Šä¼ æˆåŠŸäº† .&lt;/p>
&lt;p>ä¸‹è½½å¯ä»¥ç”¨å¦ä¸€å°æœºå™¨å»ä¸‹è½½è¿™ä¸ªé•œåƒ .&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ docker pull 192.168.7.26:5000/test
Pulling repository 192.168.7.26:5000/test
ba5877dc9bec: Download &lt;span class="nb">complete&lt;/span>
511136ea3c5a: Download &lt;span class="nb">complete&lt;/span>
9bad880da3d2: Download &lt;span class="nb">complete&lt;/span>
25f11f5fb0cb: Download &lt;span class="nb">complete&lt;/span>
ebc34468f71d: Download &lt;span class="nb">complete&lt;/span>
2318d26665ef: Download &lt;span class="nb">complete&lt;/span>
$ docker images
REPOSITORY TAG IMAGE ID
CREATED VIRTUAL SIZE
192.168.7.26:5000/test latest ba5877dc9bec
&lt;span class="m">6&lt;/span> weeks ago 192.7 MB
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="ä»“åº“é…ç½®æ–‡ä»¶">ä»“åº“é…ç½®æ–‡ä»¶&lt;/h3>
&lt;p>Docker çš„ registry åˆ©ç”¨é…ç½®æ–‡ä»¶æä¾› äº†ä¸€äº›ä»“åº“çš„æ¨¡æ¿ï¼ˆflavorï¼‰,ç”¨æˆ·å¯ä»¥ç›´æ¥ä½¿ç”¨å®ƒä»¬æ¥è¿›è¡Œå¼€å‘æˆ–èº«äº§ç¯å¢ƒ .&lt;/p>
&lt;h4 id="æ¨¡æ¿">æ¨¡æ¿&lt;/h4>
&lt;p>åœ¨ &lt;code>config_sample.yml&lt;/code> æ–‡ä»¶ä¸­,å¯ä»¥çœ‹åˆ°ä¸€äº›ç°æˆçš„æ¨¡æ¿æ®µï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>common&lt;/code> ï¼šåŸºç¡€é…ç½®&lt;/li>
&lt;li>&lt;code>local&lt;/code> ï¼šå­˜å‚¨æ•°æ®åˆ°æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ&lt;/li>
&lt;li>&lt;code>s3&lt;/code> ï¼šå­˜å‚¨æ•°æ®åˆ° AWS S3 ä¸­&lt;/li>
&lt;li>&lt;code>dev&lt;/code> ï¼šä½¿ç”¨ local æ¨¡æ¿çš„åŸºæœ¬é…ç½®&lt;/li>
&lt;li>&lt;code>test&lt;/code> ï¼šå•å…ƒæµ‹è¯•ä½¿ç”¨&lt;/li>
&lt;li>&lt;code>prod&lt;/code> ï¼šç”Ÿäº§ç¯å¢ƒé…ç½®ï¼ˆåŸºæœ¬ä¸Šè·Ÿs3é…ç½®ç±»ä¼¼ï¼‰&lt;/li>
&lt;li>&lt;code>gcs&lt;/code> ï¼šå­˜å‚¨æ•°æ®åˆ° Google çš„äº‘å­˜å‚¨&lt;/li>
&lt;li>&lt;code>swift&lt;/code> ï¼šå­˜å‚¨æ•°æ®åˆ° OpenStack Swift æœåŠ¡&lt;/li>
&lt;li>&lt;code>glance&lt;/code> ï¼šå­˜å‚¨æ•°æ®åˆ° OpenStack Glance æœåŠ¡,æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸ºåå¤‡&lt;/li>
&lt;li>&lt;code>glance-swift &lt;/code>ï¼šå­˜å‚¨æ•°æ®åˆ° OpenStack Glance æœåŠ¡,Swift ä¸ºåå¤‡&lt;/li>
&lt;li>&lt;code>elliptics&lt;/code> ï¼šå­˜å‚¨æ•°æ®åˆ° Elliptics key/value å­˜å‚¨&lt;/li>
&lt;/ul>
&lt;p>ç”¨æˆ·å¯ä»¥æ·»åŠ è‡ªå®šä¹‰çš„æ¨¡æ¿æ®µ .&lt;/p>
&lt;p>é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨çš„æ¨¡æ¿æ˜¯ &lt;code>dev&lt;/code> ,è¦æ˜¯ä½¿ç”¨æŸä¸ªæ¨¡æ¿ä½œä¸ºé»˜è®¤å€¼,å¯ä»¥æ·»åŠ  &lt;code>SETTING-FLAVOR&lt;/code> åˆ°ç¯å¢ƒå˜é‡ä¸­å»,&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="nb">export&lt;/span> &lt;span class="nv">SETTING_FLAVOR&lt;/span>&lt;span class="o">=&lt;/span>dev
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦å¤–,é…ç½®æ–‡ä»¶ä¸­æ”¯æŒä»ç¯å¢ƒå˜é‡ä¸­åŠ è½½,è¯­æ³•æ ¼å¼ä¸º&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">_env:VARIABLENAME&lt;span class="o">[&lt;/span>:DEFAULT&lt;span class="o">]&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="ç¤ºä¾‹é…ç½®">ç¤ºä¾‹é…ç½®&lt;/h4>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">common:
loglevel: info
search_backend: &lt;span class="s2">&amp;#34;_env:SEARCH_BACKEND:&amp;#34;&lt;/span>
sqlalchemy_index_database:
&lt;span class="s2">&amp;#34;_env:SQLALCHEMY_INDEX_DATABASE:sqlite:////tmp/docker-re
&lt;/span>&lt;span class="s2">gistry.db&amp;#34;&lt;/span>
prod:
loglevel: warn
storage: s3
s3_access_key: _env:AWS_S3_ACCESS_KEY
s3_secret_key: _env:AWS_S3_SECRET_KEY
s3_bucket: _env:AWS_S3_BUCKET
boto_bucket: _env:AWS_S3_BUCKET
storage_path: /srv/docker
smtp_host: localhost
from_addr: docker@myself.com
to_addr: my@myself.com
dev:
loglevel: debug
storage: &lt;span class="nb">local&lt;/span>
storage_path: /home/myself/docker
test:
storage: &lt;span class="nb">local&lt;/span>
storage_path: /tmp/tmpdockertmp
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="docker-æ•°æ®ç®¡ç†">Docker æ•°æ®ç®¡ç†&lt;/h2>
&lt;p>åœ¨å®¹å™¨ç®¡ç†ä¸­æ•°æ®ä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼š&lt;/p>
&lt;ul>
&lt;li>æ•°æ®å· ï¼ˆData volumesï¼‰&lt;/li>
&lt;li>æ•°æ®å·å®¹å™¨ ï¼ˆData volume containersï¼‰&lt;/li>
&lt;/ul>
&lt;h3 id="æ•°æ®å·">æ•°æ®å·&lt;/h3>
&lt;p>æ•°æ®å·æ˜¯ä¸€ä¸ªå¯æä¾›ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ä½¿ç”¨çš„ç‰¹æ®Šç›®å½•,å®ƒç»•è¿‡ UFS, å¯ä»¥æä¾›å¾ˆå¤šæœ‰ç”¨çš„ç‰¹å¾ï¼š&lt;/p>
&lt;ul>
&lt;li>æ•°æ®å·å¯ä»¥å†è£æœŸé—´å…±äº«å’Œé‡ç”¨&lt;/li>
&lt;li>å¯¹æ•°æ®å·çš„ä¿®æ”¹ç«‹é©¬ç”Ÿæ•ˆ&lt;/li>
&lt;li>å¯¹æ•°æ®åŠçš„æ›´æ–°,ä¸ä¼šå½±å“é•œåƒ&lt;/li>
&lt;li>æ•°æ®å·é»˜è®¤ä¼šä¸€ç›´å­˜åœ¨,å³ä½¿å®¹å™¨è¢«åˆ é™¤&lt;/li>
&lt;/ul>
&lt;p>&lt;em>æ³¨ï¼šæ•°æ®å·çš„ä½¿ç”¨,ç±»ä¼¼äºLinux ä¸‹å¯¹ç›®å½•æˆ–æ–‡ä»¶è¿›è¡Œ mount, é•œåƒä¸­çš„è¢«æŒ‡å®šä¸ºæŒ‚è½½ç‚¹çš„ç›®å½•ä¸­çš„æ–‡ä»¶ä¼šéšè—æ‰,èƒ½æ˜¾ç¤ºçœ‹çš„æ˜¯æŒ‚è½½çš„æ•°æ®å·&lt;/em>&lt;/p>
&lt;h4 id="åˆ›å»ºä¸€ä¸ªæ•°æ®å·">åˆ›å»ºä¸€ä¸ªæ•°æ®å·&lt;/h4>
&lt;p>â€‹åœ¨ä½¿ç”¨ &lt;code>docker run &lt;/code> å‘½ä»¤çš„æ—¶å€™,ä½¿ç”¨ &lt;code>-v&lt;/code> å‚æ•°æ¥åˆ›å»ºä¸€ä¸ªæ•°æ®å·å¹¶æŒ‚è½½åˆ°å®¹å™¨é‡Œ .åœ¨ä¸€æ¬¡ run ä¸­å¯ä»¥æŒ‚è½½å¤šä¸ªæ•°æ®å· .&lt;/p>
&lt;p>ä¸‹é¢åˆ›å»ºä¸€ä¸ªåä¸º web çš„å®¹å™¨,å¹¶åŠ è½½ä¸€ä¸ªæ•°æ®å·åˆ°å®¹å™¨çš„ &lt;code>/webapp&lt;/code> ç›®å½• .&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ docker run -d -p --name web -v /webapp training/webapp python app.py
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;em>æ³¨ï¼šä¹Ÿå¯ä»¥åœ¨ Docker ä¸­ä½¿ç”¨ &lt;code>volume&lt;/code> æ¥æ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªæ–°çš„å·åˆ°æœ‰è¯¥é•œåƒåˆ›å»ºçš„ä»»æ„å®¹å™¨ .&lt;/em>&lt;/p>
&lt;h4 id="åˆ é™¤æ•°æ®å·">åˆ é™¤æ•°æ®å·&lt;/h4>
&lt;p>æ•°æ®å·æ˜¯è¢«è®¾è®¡ç”¨æ¥æŒä¹…åŒ–æ•°æ®çš„,å®ƒçš„ç”Ÿå‘½å‘¨æœŸç‹¬ç«‹äºå®¹å™¨,Docker ä¸ä¼šåœ¨å®¹å™¨è¢«åˆ é™¤åè‡ªåŠ¨åˆ é™¤æ•°æ®å·,å¹¶ä¸”ä¹Ÿä¸å­˜åœ¨åƒåœ¾å›æ”¶è¿™æ ·çš„æœºåˆ¶æ¥å¤„ç†æ²¡æœ‰ä»»ä½•å®¹å™¨å¼•ç”¨çš„æ•°æ®å· .æ—¥å…‰éœ€è¦åœ¨åˆ é™¤å®¹å™¨çš„åŒæ—¶ç§»é™¤æ•°æ®å·,å¯ä»¥å†åˆ é™¤å®¹å™¨çš„æ—¶å€™ä½¿ç”¨ &lt;code>docker rm -v&lt;/code> è¿™ä¸ªå‘½ä»¤ .&lt;/p>
&lt;h4 id="æŒ‚è½½ä¸€ä¸ªä¸»å¥ç›®å½•ä½œä¸ºæ•°æ®å·">æŒ‚è½½ä¸€ä¸ªä¸»å¥ç›®å½•ä½œä¸ºæ•°æ®å·&lt;/h4>
&lt;p>ä½¿ç”¨ &lt;code>-v&lt;/code> å‚æ•°ä¹Ÿå¯ä»¥æŒ‡å®šæŒ‚è½½ä¸€ä¸ªæœ¬åœ°ä¸»æœºçš„ç›®å½•åˆ°å®¹å™¨ä¸­å» .&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ sudo docker run -d -P --name web -v /src/webapp:/opt/webapp training/webapp python app.py
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>â€‹ ä¸Šé¢çš„å‘½ä»¤åŠ è½½ä¸»æœºçš„ &lt;code>/src/webapp&lt;/code> ç›®å½•åˆ°å®¹å™¨çš„ &lt;code>/opt/webapp&lt;/code> ç›®å½• .è¿™ä¸ªåŠŸèƒ½åœ¨è¿›è¡Œæµ‹è¯•çš„æ—¶å€™ååˆ†æ–¹ä¾¿,æ¯”å¦‚ç”¨æˆ·å¯ä»¥æ”¾ç½®ä¸€äº›ç¨‹åºåˆ°æœ¬åœ°ç›®å½•ä¸­,æ¥æŸ¥çœ‹å®¹å™¨æ˜¯å¦æ­£å¸¸å·¥ä½œ .æœ¬åœ°ç›®å½•çš„è·¯å¾„å¿…é¡»æ˜¯ç»å¯¹è·¯å¾„,å¦‚æœç›®å½•ä¸å­˜åœ¨ Dockerä¼šè‡ªåŠ¨ä¸ºä½ åˆ›å»ºå®ƒ .&lt;/p>
&lt;p>&lt;em>æ³¨ï¼šDockerfile ä¸­ä¸æ”¯æŒè¿™ç§ç”¨æ³•,å› ä¸º Dockerfile æ˜¯ä¸ºäº†ç§»æ¤å’Œåˆ†äº«ç”¨çš„ . ç„¶è€Œ,ä¸åŒçš„æ“ä½œç³»ç»Ÿçš„è·¯å¾„æ ¼å¼ä¸ä¸€æ ·,æ‰€ä»¥ç›®å‰è¿˜ä¸æ”¯æŒ&lt;/em>&lt;/p>
&lt;p>Docker æŒ‚è½½æ•°æ®å·çš„é»˜è®¤æƒé™æ˜¯è¯»å†™, ç”¨æˆ·ä¹Ÿå¯ä»¥é€šè¿‡ &lt;code>:ro&lt;/code> æŒ‡å®šä¸ºåªè¯»&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ sudo docker run -d -P --name web -v /src/webapp:/opt/webapp:ro training/webapp python app.py
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åŠ äº† &lt;code>:ro&lt;/code> ä¹‹å,å°±æŒ‚è½½ä¸ºåªè¯»äº† .&lt;/p>
&lt;h4 id="æŸ¥çœ‹æ•°æ®å·çš„å…·ä½“ä¿¡æ¯">æŸ¥çœ‹æ•°æ®å·çš„å…·ä½“ä¿¡æ¯&lt;/h4>
&lt;p>åœ¨ä¸»æœºé‡Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯ä»¥æŸ¥çœ‹æŒ‡å®šå®¹å™¨çš„ä¿¡æ¯&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ docker inspect web
...
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨è¾“å‡ºçš„å†…å®¹ä¸­æ‰¾åˆ°å…¶ä¸­å’Œæ•°æ®å·ç›¸å…³çš„éƒ¨åˆ†,å¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„æ•°æ®å·éƒ½æ˜¯åˆ›å»ºåœ¨ä¸»å¥çš„ &lt;code>/var/lib/docker/volumes/&lt;/code> ä¸‹é¢çš„&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="s2">&amp;#34;Volumes&amp;#34;&lt;/span>: &lt;span class="o">{&lt;/span>
&lt;span class="s2">&amp;#34;/webapp&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;/var/lib/docker/volumes/fac362...80535&amp;#34;&lt;/span>
&lt;span class="o">}&lt;/span>,
&lt;span class="s2">&amp;#34;VolumesRW&amp;#34;&lt;/span>: &lt;span class="o">{&lt;/span>
&lt;span class="s2">&amp;#34;/webapp&amp;#34;&lt;/span>: &lt;span class="nb">true&lt;/span>
&lt;span class="o">}&lt;/span>
...
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;em>æ³¨ï¼šä» Docker 1.8.0 èµ·,æ•°æ®å·é…ç½®åœ¨ â€œMountsâ€ Key ä¸‹é¢, å¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„æ•°æ®å·éƒ½æ˜¯åˆ›å»ºåœ¨ä¸»æœºçš„ &lt;code>/mnt/sda1/var/lib/docker/volumes/...&lt;/code> ä¸‹é¢äº† .&lt;/em>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="s2">&amp;#34;Mounts&amp;#34;&lt;/span>&lt;span class="err">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="nt">&amp;#34;Name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;b53ebd40054dae599faf7c9666acfe205c3e922
&lt;/span>&lt;span class="s2">fc3e8bc3f2fd178ed788f1c29&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nt">&amp;#34;Source&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;/mnt/sda1/var/lib/docker/volumes/b53e
&lt;/span>&lt;span class="s2">bd40054dae599faf7c9666acfe205c3e922fc3e8bc3f2fd178ed788f1c29/_data&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nt">&amp;#34;Destination&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;/webapp&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nt">&amp;#34;Driver&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;local&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nt">&amp;#34;Mode&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nt">&amp;#34;RW&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nt">&amp;#34;Propagation&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">]&lt;/span>
&lt;span class="err">...&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="æŒ‚è½½ä¸€ä¸ªæœ¬åœ°ä¸»æœºæ–‡ä»¶ä½œä¸ºæ•°æ®å·">æŒ‚è½½ä¸€ä¸ªæœ¬åœ°ä¸»æœºæ–‡ä»¶ä½œä¸ºæ•°æ®å·&lt;/h4>
&lt;p>&lt;code>-v&lt;/code> å‚æ•°ä¹Ÿå¯ä»¥ä»ä¸»æœºæŒ‚è½½å•ä¸ªæ–‡ä»¶åˆ°æ–‡ä»¶åˆ°å®¹å™¨ä¸­&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ sudo docker run --rm -it -v ~/.bash_history:/.bash_history ubuntu /bin/bash
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¿™æ ·å°±å¯ä»¥è®°å½•åœ¨å®¹å™¨è¾“å…¥è¿‡å¾—å‘½ä»¤äº† .&lt;/p>
&lt;h3 id="æ•°æ®å·å®¹å™¨">æ•°æ®å·å®¹å™¨&lt;/h3>
&lt;p>å¦‚æœä½ æœ‰ä¸€äº›æŒç»­æ›´æ–°çš„æ•°æ®éœ€è¦åœ¨å®¹å™¨ä¹‹é—´å…±äº«,æœ€å¥½åˆ›å»ºæ•°æ®å·å®¹å™¨ .&lt;/p>
&lt;p>æ•°æ®å·å®¹å™¨,å…¶å®å°±æ˜¯ä¸€ä¸ªæ­£å¸¸çš„å®¹å™¨,ä¸“é—¨ç”¨æ¥æä¾›æ•°æ®å·ä¾›å…¶ä»–å®¹å™¨æŒ‚è½½çš„ .&lt;/p>
&lt;p>é¦–å…ˆ,åˆ›å»ºä¸€ä¸ªåä¸º dbdata çš„æ•°æ®å·å®¹å™¨ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ sudo docker run -d -v /dbdata --name dbdata training/postgres &lt;span class="nb">echo&lt;/span> Data-only container &lt;span class="k">for&lt;/span> postgres
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç„¶å,åœ¨å…¶ä»–å®¹å™¨ä¸­ä½¿ç”¨ &lt;code>--volumes-from&lt;/code> æ¥æŒ‚è½½ dbdata å®¹å™¨ä¸­çš„æ•°æ®å· .&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ sudo docker run -d --volumes-form dbdata --name db1 training/postgres
$ sudo docker run -d --volumes-form dbdata --name db2 training/postgres
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯ä»¥ä½¿ç”¨è¶…è¿‡ä¸€ä¸ªçš„&lt;code>--volumes-from&lt;/code> å‚æ•°æ¥æŒ‡å®šä»å¤šä¸ªå®¹å™¨æŒ‚è½½ä¸åŒçš„æ•°æ®å· . ä¹Ÿå¯ä»¥ä»å…¶ä»–å·²ç»æŒ‚è½½äº†æ•°æ®å·çš„å®¹å™¨æ¥çº§è”æŒ‚è½½æ•°æ®å· .&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ docker run -d --name db3 --volumes-from db1 training/postgres
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;em>æ³¨ï¼šä½¿ç”¨ &lt;code>--volumes-from&lt;/code> å‚æ•°æ‰€æŒ‚è½½æ•°æ®å·çš„å®¹å™¨è‡ªå·±å¹¶ä¸éœ€è¦ä¿æŒè¿è¡ŒçŠ¶æ€&lt;/em>&lt;/p>
&lt;p>å¦‚æœåˆ é™¤äº†æŒ‚è½½çš„å®¹å™¨ï¼ˆåŒ…æ‹¬ dbdataã€db1 å’Œ db2 ï¼‰,æ•°æ®å·å¹¶ä¸ä¼šè¢«è‡ªåŠ¨åˆ é™¤ .å¦‚æœåˆ é™¤ä¸€ä¸ªæ•°æ®å·,å¿…é¡»åœ¨åˆ é™¤æœ€åä¸€ä¸ªè¿˜æŒ‚ç€å®ƒçš„å®¹å™¨æ—¶ä½¿ç”¨ &lt;code>docker rm -v&lt;/code> å‘½ä»¤æ¥æŒ‡å®šåŒæ—¶åˆ é™¤å…³è”çš„å®¹å™¨ .è¿™å¯ä»¥è®©ç”¨æˆ·åœ¨å®¹å™¨ä¹‹é—´å‡çº§å’Œç§»åˆ°æ•°æ®å· .&lt;/p>
&lt;h4 id="åˆ©ç”¨æ•°æ®å·å®¹å™¨æ¥å¤‡ä»½æ¢å¤è¿ç§»æ•°æ®å·">åˆ©ç”¨æ•°æ®å·å®¹å™¨æ¥å¤‡ä»½ã€æ¢å¤ã€è¿ç§»æ•°æ®å·&lt;/h4>
&lt;p>å¯ä»¥åˆ©ç”¨æ•°æ®å·å¯¹å…¶ä¸­çš„æ•°æ®è¿›è¡Œå¤‡ä»½ã€æ¢å¤å’Œè¿ç§» .&lt;/p>
&lt;h5 id="å¤‡ä»½">å¤‡ä»½&lt;/h5>
&lt;p>é¦–å…ˆä½¿ç”¨ &lt;code>--volumes-from&lt;/code> æ ‡è®°æ¥åˆ›å»ºä¸€ä¸ªåŠ è½½ dbdata æ•°æ®å·çš„å®¹å™¨,å¹¶ä»ä¸»æœºæŒ‚è½½å½“å‰ç›®å½•åˆ°å®¹å™¨çš„ /backup ç›®å½• .å‘½ä»¤å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ sudo docker run --volumes-from dbdata -v&lt;span class="k">$(&lt;/span>&lt;span class="nb">pwd&lt;/span>&lt;span class="k">)&lt;/span>:/backup ubuntu tar cvf /backup/backup.tar /dbdata
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å®¹å™¨å¯åŠ¨å,ä½¿ç”¨äº† &lt;code>tar&lt;/code> å‘½ä»¤æ¥å°† dbdata å·å¤‡ä»½ä¸ºå®¹å™¨ä¸­ /backup/backup.tar æ–‡ä»¶,ä¹Ÿå°±æ˜¯ä¸»æœºå½“å‰ç›®å½•ä¸‹çš„åä¸º backup.tar çš„æ–‡ä»¶ .&lt;/p>
&lt;h5 id="æ¢å¤">æ¢å¤&lt;/h5>
&lt;p>å¦‚æœè¦æ¢å¤æ•°æ®åˆ°ä¸€ä¸ªå®¹å™¨,é¦–å…ˆåˆ›å»ºä¸€ä¸ªå¸¦æœ‰ç©ºæ•°æ®å·çš„å®¹å™¨ dbdata2 .&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ docker run -v /dbdata --name dbdata2 ubuntu /bin/bash
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç„¶ååˆ›å»ºå¦ä¸€ä¸ªå®¹å™¨,æŒ‚è½½ dbdata2 å®¹å™¨å·ä¸­çš„æ•°æ®å·,å¹¶ä½¿ç”¨ &lt;code>untar&lt;/code> è§£å‹å¤‡ä»½æ–‡ä»¶åˆ°æŒ‚è½½çš„å®¹å™¨å·ä¸­ .&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ sudo docker run --volumes-form dbdata2 -v &lt;span class="k">$(&lt;/span>&lt;span class="nb">pwd&lt;/span>&lt;span class="k">)&lt;/span>:/backup busybox tar xvf
/backup/backup.tar
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¸ºäº†æŸ¥çœ‹/éªŒè¯æ¢å¤çš„æ•°æ®,å¯ä»¥å†å¯åŠ¨ä¸€ä¸ªå®¹å™¨æŒ‚è½½åŒæ ·çš„å®¹å™¨å·æ¥æŸ¥çœ‹&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ docker run --volumes-from dbdata2 busybox /bin/ls dbdata
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h5 id="è¿ç§»æ•°æ®å·">è¿ç§»æ•°æ®å·&lt;/h5>
&lt;p>ä»£å†™ . . .&lt;/p>
&lt;h1 id="docker-ä¸­çš„ç½‘ç»œ">Docker ä¸­çš„ç½‘ç»œ&lt;/h1>
&lt;p>Docker å…è®¸é€šè¿‡å¤–éƒ¨è®¿é—®å®¹å™¨æˆ–å®¹å™¨äº’è”çš„æ–¹å¼æ¥æä¾›ç½‘ç»œæœåŠ¡ .&lt;/p>
&lt;h2 id="å¤–éƒ¨è®¿é—®å®¹å™¨">å¤–éƒ¨è®¿é—®å®¹å™¨&lt;/h2>
&lt;p>å®¹å™¨ä¸­å¯ä»¥ä¸è¿è¡Œä¸€äº›ç½‘ç»œåº”ç”¨,è¦è®©å¤–éƒ¨ä¹Ÿå¯ä»¥è®¿é—®è¿™äº›åº”ç”¨,å¯ä»¥é€šè¿‡ &lt;code>-P&lt;/code> æˆ– &lt;code>-p&lt;/code> å‚æ•°æ¥æŒ‡å®šç«¯å£æ˜ å°„ .&lt;/p>
&lt;p>å½“ä½¿ç”¨ &lt;code>-P&lt;/code> å‚æ•°æ—¶,Docker ä¼šéšæœºæ˜ å°„ä¸€ä¸ª &lt;code>49000~49900&lt;/code> çš„ç«¯å£åˆ°å†…éƒ¨å®¹å™¨å¼€æ”¾çš„ç½‘ç»œç«¯å£ .&lt;/p>
&lt;p>ä½¿ç”¨ &lt;code>docker ps&lt;/code> å¯ä»¥çœ‹åˆ°,æœ¬åœ°ä¸»æœºçš„49155 è¢«æ˜ å°„åˆ°äº†å®¹å™¨çš„5000 ç«¯å£ .&lt;/p>
&lt;p>æ­¤æ—¶è®¿é—®æœ¬æœºçš„49155 ç«¯å£å³å¯è®¿é—®å®¹å™¨å†… web åº”ç”¨æä¾›çš„ç•Œé¢ .&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ sudo docker run -d -P training/webapp python app.py
$ sudo docker ps -l
CONTAINER ID IMAGE COMMAND CREATED
STATUS PORTS NAMES
bc533791f3f5 training/webapp:latest python app.py &lt;span class="m">5&lt;/span> seconds ag
o Up &lt;span class="m">2&lt;/span> seconds 0.0.0.0:49155-&amp;gt;5000/tcp nostalgic_morse
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>-P&lt;/code> ï¼ˆå°å†™ï¼‰åˆ™å¯ä»¥æŒ‡å®šè¦æ˜ å°„çš„ç«¯å£,å¹¶ä¸”åœ¨ä¸€ä¸ªæŒ‡å®šç«¯å£ä¸Šåªå¯ä»¥ç»‘å®šä¸€ä¸ªå®¹å™¨ .æ”¯æŒçš„æ ¼å¼æœ‰&lt;/p>
&lt;ul>
&lt;li>&lt;code>ip:HostPort:containerPort&lt;/code>&lt;/li>
&lt;li>&lt;code>ip::containerPort&lt;/code>&lt;/li>
&lt;li>&lt;code>hostPort:containerPort&lt;/code>&lt;/li>
&lt;/ul>
&lt;h3 id="æ˜ å°„æ‰€æœ‰æ¥å£åœ°å€">æ˜ å°„æ‰€æœ‰æ¥å£åœ°å€&lt;/h3>
&lt;p>ä½¿ç”¨ &lt;code>hostPort ï¼šcontainerPort&lt;/code> æ ¼å¼æœ¬åœ°çš„5000ç«¯å£æ˜ å°„åˆ°å®¹å™¨çš„5000ç«¯å£,å¯ä»¥æ‰§è¡Œ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ docker run -d -p 5000:5000 training/webapp python app.py
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ­¤æ—¶é»˜è®¤ä¼šç»‘å®šæœ¬åœ°æ‰€æœ‰æ¥å£ä¸Šçš„æ‰€æœ‰æ¥å£ .&lt;/p>
&lt;h3 id="æ˜ å°„åˆ°æŒ‡å®šåœ°å€çš„æŒ‡å®šç«¯å£">æ˜ å°„åˆ°æŒ‡å®šåœ°å€çš„æŒ‡å®šç«¯å£&lt;/h3>
&lt;p>å¯ä»¥ä½¿ç”¨ &lt;code>ip:hostPort:containerPort&lt;/code> æ ¼å¼æŒ‡å®šæ˜ å°„ä½¿ç”¨ä¸€ä¸ªç‰¹å®šåœ°å€,æ¯”å¦‚ localhost åœ°å€ 127.0.0.1&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ sudo docker run -d -p 127.0.0.1:5000:5000 training/webapp python app.py
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="æŸ¥çœ‹æ˜ å°„ç«¯å£é…ç½®">æŸ¥çœ‹æ˜ å°„ç«¯å£é…ç½®&lt;/h3>
&lt;p>ä½¿ç”¨ &lt;code>docker port &lt;/code> æ¥æŸ¥çœ‹å½“å‰æ˜ å°„çš„ç«¯å£é…ç½®,ä¹Ÿå¯ä»¥æŸ¥çœ‹åˆ°ç»‘å®šçš„åœ°å€&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ docker port gogs
22/tcp -&amp;gt; 0.0.0.0:10022
3000/tcp -&amp;gt; 0.0.0.0:10080
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ° &lt;code>gogs&lt;/code> æœ‰ä¸¤ä¸ªå®¹å™¨å†…çš„ç«¯å£ 22, 3000 åˆ†åˆ«æ˜ å°„ä¸»æœºçš„10022,10080 ç«¯å£ .&lt;/p>
&lt;p>&lt;em>æ³¨ï¼š -p å¯ä»¥å¤šæ¬¡ä½¿ç”¨æ¥ç»‘å®šå¤šä¸ªç«¯å£,ä¹Ÿå°±æ˜¯è¯´ä¸€æ¡å‘½ä»¤å¯ä»¥æœ‰å¤šä¸ª -p ,å¦‚ï¼šä¸Šé¢ğŸ‘†çš„ gogs å®¹å™¨å°±ç»‘å®šäº†ä¿©ç«¯å£&lt;/em>&lt;/p>
&lt;h2 id="å®¹å™¨äº’è”">å®¹å™¨äº’è”&lt;/h2>
&lt;p>å®¹å™¨çš„è¿æ¥ï¼ˆlinkingï¼‰ç³»ç»Ÿæ˜¯é™¤äº†ç«¯å£æ˜ å°„å¤–,å¦ä¸€ç§è·Ÿå®¹å™¨ä¸­åº”ç”¨äº¤äº’çš„æ–¹å¼ .è¯¥ç³»ç»Ÿä¼šåœ¨æºå’Œæ¥å—å®¹å™¨ä¹‹é—´åˆ›å»ºä¸€ä¸ªé€šé“,æ¥å—å®¹å™¨å¯ä»¥çœ‹åˆ°æºå®¹å™¨æŒ‡å®šçš„ä¿¡æ¯ .&lt;/p>
&lt;h3 id="è‡ªå®šä¹‰å®¹å™¨å‘½å">è‡ªå®šä¹‰å®¹å™¨å‘½å&lt;/h3>
&lt;p>è¿æ¥ç³»ç»Ÿä¾æ®å®¹å™¨çš„åç§°æ¥æ‰§è¡Œ .å› æ­¤,é¦–å…ˆéœ€è¦è‡ªå®šä¹‰ä¸€ä¸ªå¥½è®°çš„å®¹å™¨å‘½å .&lt;/p>
&lt;p>è™½ç„¶åˆ›å»ºå®¹å™¨çš„æ—¶å€™,ç³»ç»Ÿé»˜è®¤ä¼šåˆ†é…ç»™ä¸€ä¸ªåå­— .ä½†æ˜¯è‡ªå®šä¹‰å‘½åå®¹å™¨çš„è¯,ç¬¬ä¸€,å¥½è®°,ç¬¬äºŒ,å¯ä»¥ä½œä¸ºæœ‰ç”¨çš„å‚è€ƒçš„ .&lt;/p>
&lt;p>ä½¿ç”¨ &lt;code>--name&lt;/code> å‚æ•°å¯ä»¥ä¸ºå®¹å™¨è‡ªå®šä¹‰å‘½å .&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ docker run -d -p 8181:4040 --name own-cloud owncloud
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä½¿ç”¨ &lt;code>docker ps&lt;/code> æ¥æŸ¥çœ‹æ­£è¿è¡Œçš„å®¹å™¨&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES
2c2e766e86fd owncloud &lt;span class="s2">&amp;#34;/entrypoint.sh ap...&amp;#34;&lt;/span> &lt;span class="m">23&lt;/span> hours ago Up &lt;span class="m">23&lt;/span> hours 80/tcp, 0.0.0.0:8181-&amp;gt;4040/tcp own-cloud
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä½¿ç”¨ &lt;code>docker inspect&lt;/code> å‘½ä»¤æ¥æŸ¥çœ‹å®¹å™¨åå­—&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ docker inspect -f &lt;span class="s2">&amp;#34;{{.Name}}&amp;#34;&lt;/span> 2c2e766e86fd
/own-cloud
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;em>æ³¨ï¼šå®¹å™¨çš„åç§°æ˜¯å”¯ä¸€çš„ .å¦‚æœå·²ç»å‘½åäº†ä¸€ä¸ªå« own-cloud çš„å®¹å™¨,å½“ä½ å†æ¬¡ä½¿ç”¨è¿™ä¸ªåè¯çš„æ—¶å€™,éœ€è¦å…ˆæŠŠä¹‹å‰çš„çš„åŒåå®¹å™¨åˆ é™¤&lt;/em>&lt;/p>
&lt;p>&lt;em>tipsï¼šåœ¨æ‰§è¡Œ &lt;code>docker run&lt;/code> çš„æ—¶å€™å¯ä»¥æ·»åŠ  &lt;code>â€”rm&lt;/code> å‚æ•°,è¿™æ ·å®¹å™¨åœ¨ç»ˆæ­¢åç«‹åˆ»åˆ é™¤ .æ³¨æ„,&lt;code>â€”rm&lt;/code> å’Œ &lt;code>-d&lt;/code> å‚æ•°ä¸èƒ½åŒæ—¶ä½¿ç”¨ .&lt;/em>&lt;/p>
&lt;h3 id="å®¹å™¨äº’è”-1">å®¹å™¨äº’è”&lt;/h3>
&lt;p>ä½¿ç”¨ &lt;code>--link&lt;/code> å‚æ•°å¯ä»¥è®©å®¹å™¨ä¹‹é—´å®‰å…¨çš„è¿›è¡Œäº¤äº’ .&lt;/p>
&lt;p>ä¸‹é¢æ˜¯,è¿è¡Œ &lt;code>Nginx&lt;/code> å®¹å™¨çš„æ—¶å€™æŠŠ &lt;code>gogs&lt;/code> è¿™ä¸ªå®¹å™¨è¿æ¥ä¸Š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">docker run -d --name my_nginx --link gogs:app --link own-cloud:app2 -p 80:80 -v /root/nginx/config:/etc/nginx/conf.d nginx
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ­¤æ—¶,gogs å®¹å™¨å’Œ my_nginx å®¹å™¨å»ºç«‹äº’è”å…³ç³»&lt;/p>
&lt;p>&lt;code>--link&lt;/code> å‚æ•°çš„æ ¼å¼ä¸º &lt;code>--link name:alias&lt;/code> ,å…¶ä¸­ name æ˜¯è¦è¿æ¥çš„å®¹å™¨åç§°, alias æ˜¯è¿™ä¸ªè¿æ¥çš„åˆ«å .&lt;/p>
&lt;p>å¯ä»¥é€šè¿‡ &lt;code>docker inspect &lt;/code> å‘½ä»¤æŸ¥çœ‹ my_nginx å®¹å™¨ä¿¡æ¯,å°±ä¼šå‘ç°æœ‰è¿™ä¹ˆä¸€æ®µä¿¡æ¯&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="s2">&amp;#34;Links&amp;#34;&lt;/span>: &lt;span class="o">[&lt;/span>
&lt;span class="s2">&amp;#34;/gogs:/trusting_brown/app&amp;#34;&lt;/span>,
&lt;span class="s2">&amp;#34;/own-cloud:/trusting_brown/app2&amp;#34;&lt;/span>
&lt;span class="o">]&lt;/span>,
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¡¨é¢æ­¤å®¹å™¨å·²ç»è¿ä¸Šä¸¤ä¸ªå®¹å™¨, gogs å’Œ own-cloud,trusting_brown æ˜¯ç³»ç»Ÿåˆ†é…ç»™ Nginx çš„åç§°,è¿æ¥åç§°åˆ†åˆ«æ˜¯ app å’Œ app2 .&lt;/p>
&lt;p>Docker åœ¨ä¸¤ä¸ªäº’è”çš„å®¹å™¨ä¹‹é—´åˆ›å»ºäº†ä¸€ä¸ªå®‰å…¨çš„éš§é“,è€Œä¸”ä¸ç”¨æ˜ å°„åˆ°å®ƒä»¬çš„ç«¯å£åˆ°ä¸»æœºä¸Š .åœ¨å¯åŠ¨è¢«è¿æ¥çš„å®¹å™¨çš„æ—¶å€™ä¸ç”¨æ·»åŠ  -p æˆ– -P å‚æ•°,ä»è€Œé¿å…æš´éœ²ç«¯å£åˆ°å¤–éƒ¨ç½‘ç»œä¸Š .&lt;/p>
&lt;p>è¿æ¥ä¹‹å,åœ¨ Nginx å®¹å™¨é‡Œ,å°±ä¼šå‘ç”Ÿä¸¤ä¸ªå˜åŒ– .&lt;/p>
&lt;p>ä¸€æ˜¯ç¯å¢ƒå˜é‡ .åœ¨ Nginx å®¹å™¨ä¸­ä¼šå‡ºç°6ä¸ªæ–°å¢çš„ç¯å¢ƒå˜é‡,è¿™äº›ç¯å¢ƒå˜é‡çš„åç§°åˆ†è´æ—¶ç”±è¢«è¿æ¥çš„æœåŠ¡åˆ«åã€ç«¯å£ç­‰æ‹¼æ¥è€Œæˆçš„ .&lt;/p>
&lt;p>&lt;em>ç”±äºèµ·å¾— gogs å®¹å™¨æœ‰ä¸¤ä¸ªç«¯å£,æ‰€ä»¥å…¶ä¸­ APP_PORTã€APP_NAMEã€APP_ENV_GOGS_CUSTOM æ˜¯å…¬ç”¨çš„,å…¶å®ƒ8ä¸ªå˜é‡æ¯å››ä¸ªçš„åˆ†åˆ«å¯¹åº”22, 3000 ç«¯å£&lt;/em>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># env | grep APP&lt;/span>
&lt;span class="nv">APP_PORT_3000_TCP&lt;/span>&lt;span class="o">=&lt;/span>tcp://172.17.0.2:3000
&lt;span class="nv">APP_PORT_22_TCP_PROTO&lt;/span>&lt;span class="o">=&lt;/span>tcp
&lt;span class="nv">APP_ENV_GOGS_CUSTOM&lt;/span>&lt;span class="o">=&lt;/span>/data/gogs
&lt;span class="nv">APP_PORT_3000_TCP_ADDR&lt;/span>&lt;span class="o">=&lt;/span>172.17.0.2
&lt;span class="nv">APP_PORT_3000_TCP_PROTO&lt;/span>&lt;span class="o">=&lt;/span>tcp
&lt;span class="nv">APP_PORT_22_TCP_PORT&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">22&lt;/span>
&lt;span class="nv">APP_PORT_3000_TCP_PORT&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">3000&lt;/span>
&lt;span class="nv">APP_PORT&lt;/span>&lt;span class="o">=&lt;/span>tcp://172.17.0.2:22
&lt;span class="nv">APP_NAME&lt;/span>&lt;span class="o">=&lt;/span>/my_nginx/app
&lt;span class="nv">APP_PORT_22_TCP&lt;/span>&lt;span class="o">=&lt;/span>tcp://172.17.0.2:22
&lt;span class="nv">APP_PORT_22_TCP_ADDR&lt;/span>&lt;span class="o">=&lt;/span>172.17.0.2
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>äºŒæ˜¯ hosts æ–‡ä»¶ .åœ¨ Nginx å®¹å™¨çš„ hosts æ–‡ä»¶çœ‹åˆ°ä¸‹é¢çš„è®°å½• .è¿™å°±æ˜¯è¯´,ä¸€åˆ‡è®¿é—® è¿æ¥åˆ«åï¼ˆappï¼‰ã€å®¹å™¨ IDï¼ˆac4c0cf35adfï¼‰å’Œå®¹å™¨åï¼ˆgogsï¼‰çš„è¯·æ±‚éƒ½ä¼šè¢«é‡æ–°å¯¼å‘åˆ°å®æ—¶å®é™…çš„ app çš„ ip åœ°å€ä¸Š .&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="c1"># cat /etc/hosts | grep app&lt;/span>
172.17.0.2 app ac4c0cf35adf gogs
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="é«˜çº§ç½‘ç»œé…ç½®">é«˜çº§ç½‘ç»œé…ç½®&lt;/h2>
&lt;p>å½“ Docker å¯åŠ¨æ—¶,ä¼šè‡ªåŠ¨çš„ä¸»æœºä¸Šåˆ›å»ºä¸€ä¸ª &lt;code>docker0&lt;/code> è™šæ‹Ÿç½‘æ¡¥,å®é™…ä¸Šæ˜¯ Linux çš„ä¸€ä¸ª bridge,å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªè½¯ä»¶äº¤æ¢æœº .å®ƒä¼šæŒ‚è½½åˆ°å®ƒçš„ç½‘å£ä¹‹é—´è¿›è¡Œè½¬å‘ .&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ ip addr &lt;span class="p">|&lt;/span> grep docker0
docker0: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu &lt;span class="m">1500&lt;/span> qdisc noqueue state UP
link/ether 02:42:23:c6:3f:1c brd ff:ff:ff:ff:ff:ff
inet 172.17.0.1/16 scope global docker0
valid_lft forever preferred_lft forever
inet6 fe80::42:23ff:fec6:3f1c/64 scope link
valid_lft forever preferred_lft forever
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åŒæ—¶,Docker éšæœºåˆ†ä¸€ä¸ªæœ¬åœ°æœªå ç”¨çš„ç§æœ‰ç½‘æ®µï¼ˆåœ¨ &lt;a href="https://tools.ietf.org/html/rfc1918">RFC1919&lt;/a> ä¸­å®šä¹‰ï¼‰ä¸­çš„ä¸€ä¸ªåœ°å€ç»™ &lt;code>docker0&lt;/code> æ¥å£ .æ¯”å¦‚æˆ‘çš„ä¸»æœºä¸Šçš„ docker0 ip ä¸º &lt;code>172.17.0.1&lt;/code> ,æ©ç ä¸º &lt;code>255.255.0.0&lt;/code> .æ­¤åå¯åŠ¨çš„å®¹å™¨å†…çš„ç½‘å£ä¹Ÿä¼šè‡ªåŠ¨åˆ†é…æœ‰ä¸ªä¸€ä¸ªåŒä¸€ç½‘æ®µï¼ˆ&lt;code>172.17.0.0/16&lt;/code>ï¼‰çš„åœ°å€ .&lt;/p>
&lt;p>å½“åˆ›å»ºä¸€ä¸ª Docker å®¹å™¨çš„æ—¶å€™,åŒæ—¶ä¼šåˆ›å»ºä¸€å¯¹ &lt;code>vath pair&lt;/code> æ¥å£ï¼ˆå½“æ•°æ®åŒ…å‘é€åˆ°ä¸€ä¸ªæ¥å£,å¦ä¸€ä¸ªæ¥å£ä¹Ÿå¯ä»¥æ”¶åˆ°ç›¸åŒçš„æ•°æ®åŒ…ï¼‰ .è¿™å¯¹æ¥å£ä¸€æ®µåœ¨å®¹å™¨å†…,å³ &lt;code>eth0&lt;/code> ï¼›å¦ä¸€ç«¯åœ¨æœ¬åœ°å¹¶æŒ‚è½½åˆ° docker0 ç½‘æ¡¥,åç§°ä»¥ &lt;code>veth&lt;/code> å¼€å¤´ .é€šè¿‡è¿™ç§æ–¹å¼,ä¸»æœºå¯ä»¥è·Ÿå®¹å™¨é€šä¿¡,å®¹å™¨ä¹‹é—´ä¹Ÿå¯ä»¥ç›¸äº’é€šä¿¡ . Docker å°±åˆ›å»ºäº†åœ¨ä¸»æœºå’Œæ‰€æœ‰å®¹å™¨ä¹‹é—´ä¸€ä¸ªè™šæ‹Ÿå…±äº«ç½‘ç»œ .&lt;/p>
&lt;p>&lt;img src="http://oid1xlj7h.bkt.clouddn.com/network.png" alt="Docker ç½‘ç»œ">&lt;/p>
&lt;p>â€‹ å›¾ i.i docker ç½‘ç»œ&lt;/p>
&lt;p>æ¥ä¸‹æ¥éƒ¨åˆ†å°†ä»‹ç»åœ¨ä¸€äº›åœºæ™¯ä¸­,Docker æ‰€æœ‰çš„ç½‘ç»œå®šåˆ¶é…ç½® .ä»¥åŠé€šè¿‡ Linux å‘½ä»¤æ¥è°ƒæ•´ã€è¡¥å……ã€ç”šè‡³æ›¿æ¢ Docker é»˜è®¤çš„ç½‘ç»œé…ç½® .&lt;/p>
&lt;h3 id="å¿«é€Ÿé…ç½®">å¿«é€Ÿé…ç½®&lt;/h3>
&lt;p>ä¸‹é¢æ˜¯ä¸€ä¸ªè·Ÿ Docker ç½‘ç»œç›¸å…³çš„å‘½ä»¤åˆ—è¡¨ .&lt;/p>
&lt;p>å…¶ä¸­æœ‰äº›å‘½ä»¤é€‰é¡¹åªæœ‰åœ¨ Docker æœåŠ¡å¯åŠ¨çš„æ—¶å€™æ‰èƒ½é…ç½®,è€Œä¸”ä¸èƒ½é©¬ä¸Šç”Ÿæ•ˆ .&lt;/p>
&lt;ul>
&lt;li>&lt;code>-b BRIDGE or --bridge==BRIDGE&lt;/code> --æŒ‡å®šå®¹å™¨æŒ‚è½½çš„ç½‘æ¡¥&lt;/li>
&lt;li>&lt;code>--bip=CIDR&lt;/code> â€” å®šåˆ¶ docker0 çš„æ©ç &lt;/li>
&lt;li>&lt;code>-H SOCKET... or --host=SOCKETâ€¦&lt;/code> â€”Docker æœåŠ¡ç«¯æ¥å—å‘½ä»¤çš„é€šé“&lt;/li>
&lt;li>&lt;code>--icc=true|false&lt;/code> --æ˜¯å¦æ”¯æŒå®¹å™¨ä¹‹é—´è¿›è¡Œé€šä¿¡&lt;/li>
&lt;li>&lt;code>--ip-forward=true|false&lt;/code> â€”å®¹å™¨æ˜¯å¦èƒ½è®¿é—®å¤–ç½‘ï¼ˆè¯¦ç»†è§£æè¯·çœ‹ä¸‹æ–‡çš„å®¹å™¨é€šä¿¡ï¼‰&lt;/li>
&lt;li>&lt;code>--iptables=true|false&lt;/code> --æ˜¯å¦å…è®¸ Docker æ·»åŠ  iptables è§„åˆ™&lt;/li>
&lt;li>&lt;code>--mtu=BYTES&lt;/code> â€”å®¹å™¨ç½‘ç»œä¸­çš„ MTU&lt;/li>
&lt;/ul>
&lt;p>ä¸‹é¢çš„ä¸¤ä¸ªå‘½ä»¤æ—¢å¯ä»¥åœ¨æœåŠ¡å¯åŠ¨æ—¶æŒ‡å®š,ä¹Ÿå¯ä»¥ Docker å®¹å™¨å¯åŠ¨ï¼ˆdocker run ï¼‰æ—¶å€™æŒ‡å®š .&lt;/p>
&lt;p>åœ¨ Docker æœåŠ¡å¯åŠ¨çš„æ—¶å€™æŒ‡å®šåˆ™ä¼šæˆä¸ºé»˜è®¤å€¼,åé¢æ‰§è¡Œ&lt;code>docker run &lt;/code>æ—¶å¯ä»¥è¦†ç›–è®¾ç½®çš„é»˜è®¤å€¼ .&lt;/p>
&lt;ul>
&lt;li>&lt;code>--dns=IP_ADDRESSâ€¦&lt;/code> â€”ä½¿ç”¨æŒ‡å®šçš„ DNS æœåŠ¡å™¨&lt;/li>
&lt;li>&lt;code>--dns-search=DOMAIN...&lt;/code> æŒ‡å®š DNS æœç´¢åŸŸ&lt;/li>
&lt;/ul>
&lt;p>æœ€åè¿™äº›é€‰é¡¹åªæœ‰åœ¨ docker run æ‰§è¡Œæ—¶ä½¿ç”¨,å› ä¸ºå®ƒæ˜¯é’ˆå¯¹å®¹å™¨çš„ç‰¹æ€§å†…å®¹ .&lt;/p>
&lt;ul>
&lt;li>&lt;code>-h HOSTNAME or --hostname=HOSTNAME&lt;/code> --é…ç½®å®¹å™¨ä¸»æœºå&lt;/li>
&lt;li>&lt;code>--link=CONRATAINER_NAME:ALIAS&lt;/code> â€”æ·»åŠ åˆ°å¦ä¸€ä¸ªå®¹å™¨çš„è¿æ¥&lt;/li>
&lt;/ul></content><category scheme="https://yusank.github.io/categories/%E6%8A%80%E6%9C%AF/" term="æŠ€æœ¯" label="æŠ€æœ¯"/><category scheme="https://yusank.github.io/tags/go/" term="go" label="go"/><category scheme="https://yusank.github.io/tags/docker/" term="docker" label="docker"/></entry><entry><title type="text">GO interface</title><link rel="alternate" type="text/html" href="https://yusank.github.io/posts/go-interface/"/><id>https://yusank.github.io/posts/go-interface/</id><updated>2021-09-18T06:24:55+00:00</updated><published>2017-06-08T15:07:00+08:00</published><author><name>yusank</name><uri>https://yusank.github.io/</uri><email>yusankurban@gmail.com</email></author><summary type="html">go çš„ interface çš„å®ç°å’ŒåŸç†ã€‚ Go interface interface åœ¨ Golang ä¸­ interface æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„æ¦‚å¿µå’Œç‰¹æ€§ã€‚ ä»€ä¹ˆæ˜¯ interfaâ€¦â€¦</summary><content type="html">&lt;p>go çš„ interface çš„å®ç°å’ŒåŸç†ã€‚&lt;/p>
&lt;h1 id="go-interface">Go interface&lt;/h1>
&lt;h2 id="interface">interface&lt;/h2>
&lt;p>åœ¨ Golang ä¸­ interface æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„æ¦‚å¿µå’Œç‰¹æ€§ã€‚&lt;/p>
&lt;h3 id="ä»€ä¹ˆæ˜¯-interface">ä»€ä¹ˆæ˜¯ interfaceï¼Ÿ&lt;/h3>
&lt;blockquote>
&lt;p>In &lt;a href="https://en.wikipedia.org/wiki/Object-oriented_programming">object-oriented programming&lt;/a>, a &lt;strong>protocol&lt;/strong> or &lt;strong>interface&lt;/strong> is a common means for unrelated &lt;a href="https://en.wikipedia.org/wiki/Object_(computer_science)">objects&lt;/a> to communicate with each other. These are definitions of &lt;a href="https://en.wikipedia.org/wiki/Method_(computer_science)">methods&lt;/a> and values which the objects agree upon in order to co-operate. â€” wikipedia&lt;/p>
&lt;/blockquote>
&lt;p>è¿™æ˜¯ wikipedia å…³äº protocal çš„å®šä¹‰ï¼Œå°† interface ç±»æ¯”å¦‚ protocal æ˜¯ä¸€ç§éå¸¸åŠ©äºç†è§£çš„æ–¹å¼ã€‚protocolï¼Œä¸­æ–‡ä¸€èˆ¬å«åšåè®®ï¼Œæ¯”å¦‚ç½‘ç»œä¼ è¾“ä¸­çš„ TCP åè®®ã€‚protocol å¯ä»¥è®¤ä¸ºæ˜¯ä¸€ç§åŒæ–¹ä¸ºäº†äº¤æµè€Œåšå‡ºçš„çº¦å®šï¼Œinterface å¯ä»¥ç±»æ¯”å¦‚æ­¤ã€‚&lt;/p>
&lt;p>åœ¨ Golang ä¸­ï¼Œinterface æ˜¯ä¸€ç§æŠ½è±¡ç±»å‹ï¼Œç›¸å¯¹äºæŠ½è±¡ç±»å‹çš„æ˜¯å…·ä½“ç±»å‹ï¼ˆconcrete typeï¼‰ï¼šintï¼Œstringã€‚å¦‚ä¸‹æ˜¯ io åŒ…é‡Œé¢çš„ä¾‹å­ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// Writer is the interface that wraps the basic Write method.
&lt;/span>&lt;span class="c1">//
&lt;/span>&lt;span class="c1">// Write writes len(p) bytes from p to the underlying data stream.
&lt;/span>&lt;span class="c1">// It returns the number of bytes written from p (0 &amp;lt;= n &amp;lt;= len(p))
&lt;/span>&lt;span class="c1">// and any error encountered that caused the write to stop early.
&lt;/span>&lt;span class="c1">// Write must return a non-nil error if it returns n &amp;lt; len(p).
&lt;/span>&lt;span class="c1">// Write must not modify the slice data, even temporarily.
&lt;/span>&lt;span class="c1">//
&lt;/span>&lt;span class="c1">// Implementations must not retain p.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">Writer&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">Write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">n&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// Closer is the interface that wraps the basic Close method.
&lt;/span>&lt;span class="c1">//
&lt;/span>&lt;span class="c1">// The behavior of Close after the first call is undefined.
&lt;/span>&lt;span class="c1">// Specific implementations may document their own behavior.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">Closer&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨ Golang ä¸­ï¼Œinterface æ˜¯ä¸€ç»„ method çš„é›†åˆï¼Œæ˜¯ &lt;a href="https://zh.wikipedia.org/wiki/%E9%B8%AD%E5%AD%90%E7%B1%BB%E5%9E%8B">duck-type programming&lt;/a> (é¸­å­ç±»å‹)çš„ä¸€ç§ä½“ç°ã€‚ä¸å…³å¿ƒå±æ€§ï¼ˆæ•°æ®ï¼‰ï¼Œåªå…³å¿ƒè¡Œä¸ºï¼ˆæ–¹æ³•ï¼‰ã€‚å…·ä½“ä½¿ç”¨ä¸­ä½ å¯ä»¥è‡ªå®šä¹‰è‡ªå·±çš„ structï¼Œå¹¶æä¾›ç‰¹å®šçš„ interface é‡Œé¢çš„ method å°±å¯ä»¥æŠŠå®ƒå½“æˆ interface æ¥ä½¿ç”¨ã€‚ä¸‹é¢æ˜¯ä¸€ç§ interface çš„å…¸å‹ç”¨æ³•ï¼Œå®šä¹‰å‡½æ•°çš„æ—¶å€™å‚æ•°å®šä¹‰æˆ interfaceï¼Œè°ƒç”¨å‡½æ•°çš„æ—¶å€™å°±å¯ä»¥åšåˆ°éå¸¸çš„çµæ´»ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">MyInterface&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nf">Print&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">TestFunc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">x&lt;/span> &lt;span class="nx">MyInterface&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">MyStruct&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">me&lt;/span> &lt;span class="nx">MyStruct&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Print&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">me&lt;/span> &lt;span class="nx">MyStruct&lt;/span>
&lt;span class="nf">TestFunc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">me&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="ä¸ºä»€ä¹ˆ-interface">ä¸ºä»€ä¹ˆ interface&lt;/h3>
&lt;p>Gopher China ä¸Šç»™å‡ºäº†ä¸‹é¢çš„ä¸‰ä¸ªç†ç”±ï¼š&lt;/p>
&lt;ul>
&lt;li>writing generic algorithm ï¼ˆæ³›å‹ç¼–ç¨‹ï¼‰&lt;/li>
&lt;li>hiding implementation detail ï¼ˆéšè—å…·ä½“å®ç°ï¼‰&lt;/li>
&lt;li>providing interception points ï¼ˆæä¾›ç›‘å¬ç‚¹/æ‹¦æˆªç‚¹ï¼Ÿï¼‰&lt;/li>
&lt;/ul>
&lt;h4 id="write-generic-algorithm">write generic algorithm&lt;/h4>
&lt;p>ä¸¥æ ¼æ¥è¯´ï¼Œåœ¨ Golang ä¸­å¹¶ä¸æ”¯æŒæ³›å‹ç¼–ç¨‹ã€‚åœ¨ C++ ç­‰é«˜çº§è¯­è¨€ä¸­ä½¿ç”¨æ³›å‹ç¼–ç¨‹éå¸¸çš„ç®€å•ï¼Œæ‰€ä»¥æ³›å‹ç¼–ç¨‹ä¸€ç›´æ˜¯ Golang è¯Ÿç—…æœ€å¤šçš„åœ°æ–¹ã€‚ä½†æ˜¯ä½¿ç”¨ interface æˆ‘ä»¬å¯ä»¥å®ç°æ³›å‹ç¼–ç¨‹ï¼Œæˆ‘è¿™é‡Œç®€å•è¯´ä¸€ä¸‹ï¼Œå…·ä½“å¯ä»¥å‚è€ƒæˆ‘å‰é¢ç»™å‡ºæ¥çš„é‚£ç¯‡æ–‡ç« ã€‚æ¯”å¦‚æˆ‘ä»¬ç°åœ¨è¦å†™ä¸€ä¸ªæ³›å‹ç®—æ³•ï¼Œå½¢å‚å®šä¹‰é‡‡ç”¨ interface å°±å¯ä»¥äº†ï¼Œä»¥æ ‡å‡†åº“çš„ sort ä¸ºä¾‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">sort&lt;/span>
&lt;span class="c1">// A type, typically a collection, that satisfies sort.Interface can be
&lt;/span>&lt;span class="c1">// sorted by the routines in this package. The methods require that the
&lt;/span>&lt;span class="c1">// elements of the collection be enumerated by an integer index.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">Interface&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Len is the number of elements in the collection.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Len&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;span class="c1">// Less reports whether the element with
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// index i should sort before the element with index j.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Less&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">j&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">bool&lt;/span>
&lt;span class="c1">// Swap swaps the elements with indexes i and j.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Swap&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">j&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="o">...&lt;/span>
&lt;span class="c1">// Sort sorts data.
&lt;/span>&lt;span class="c1">// It makes one call to data.Len to determine n, and O(n*log(n)) calls to
&lt;/span>&lt;span class="c1">// data.Less and data.Swap. The sort is not guaranteed to be stable.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">Sort&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">data&lt;/span> &lt;span class="nx">Interface&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// Switch to heapsort if depth of 2*ceil(lg(n+1)) is reached.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">n&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">data&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Len&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">maxDepth&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">n&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">&amp;gt;&amp;gt;=&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">maxDepth&lt;/span>&lt;span class="o">++&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">maxDepth&lt;/span> &lt;span class="o">*=&lt;/span> &lt;span class="mi">2&lt;/span>
&lt;span class="nf">quickSort&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">data&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">maxDepth&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Sort å‡½æ•°çš„å½¢å‚æ˜¯ä¸€ä¸ª interfaceï¼ŒåŒ…å«äº†ä¸‰ä¸ªæ–¹æ³•ï¼š&lt;code>Len()&lt;/code>ï¼Œ&lt;code>Less(i,j int)&lt;/code>ï¼Œ&lt;code>Swap(i, j int)&lt;/code>ã€‚ä½¿ç”¨çš„æ—¶å€™ä¸ç®¡æ•°ç»„çš„å…ƒç´ ç±»å‹æ˜¯ä»€ä¹ˆç±»å‹ï¼ˆint, float, stringâ€¦ï¼‰ï¼Œåªè¦æˆ‘ä»¬å®ç°äº†è¿™ä¸‰ä¸ªæ–¹æ³•å°±å¯ä»¥ä½¿ç”¨ Sort å‡½æ•°ï¼Œè¿™æ ·å°±å®ç°äº†â€œæ³›å‹ç¼–ç¨‹â€ã€‚æœ‰ä¸€ç‚¹æ¯”è¾ƒéº»çƒ¦çš„æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦å°†æ•°ç»„è‡ªå®šä¹‰ä¸€ä¸‹ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Person&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">Name&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="nx">Age&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span> &lt;span class="nx">Person&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">String&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;%s: %d&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">p&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">p&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Age&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// ByAge implements sort.Interface for []Person based on
&lt;/span>&lt;span class="c1">// the Age field.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">ByAge&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">Person&lt;/span> &lt;span class="c1">//è‡ªå®šä¹‰
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span> &lt;span class="nx">ByAge&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Len&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span> &lt;span class="nx">ByAge&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Swap&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">j&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">j&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">j&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span> &lt;span class="nx">ByAge&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Less&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">j&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">bool&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="nx">Age&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">j&lt;/span>&lt;span class="p">].&lt;/span>&lt;span class="nx">Age&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">people&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="nx">Person&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="p">{&lt;/span>&lt;span class="s">&amp;#34;Bob&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">31&lt;/span>&lt;span class="p">},&lt;/span>
&lt;span class="p">{&lt;/span>&lt;span class="s">&amp;#34;John&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">42&lt;/span>&lt;span class="p">},&lt;/span>
&lt;span class="p">{&lt;/span>&lt;span class="s">&amp;#34;Michael&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">17&lt;/span>&lt;span class="p">},&lt;/span>
&lt;span class="p">{&lt;/span>&lt;span class="s">&amp;#34;Jenny&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">26&lt;/span>&lt;span class="p">},&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">people&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">sort&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sort&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nf">ByAge&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">people&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">people&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦å¤– Gopher China ä¸Šè¿˜æåˆ°äº†ä¸€ä¸ªæ¯”è¾ƒæœ‰è¶£çš„ä¸œè¥¿å’Œå¤§å®¶åˆ†äº«ä¸€ä¸‹ã€‚åœ¨æˆ‘ä»¬è®¾è®¡å‡½æ•°çš„æ—¶å€™ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¥½çš„å‡†åˆ™ã€‚&lt;/p>
&lt;blockquote>
&lt;p>Be &lt;strong>conservative&lt;/strong> in what you send, be &lt;strong>liberal&lt;/strong> in what you accept. â€” Robustness Principle&lt;/p>
&lt;/blockquote>
&lt;p>å¯¹åº”åˆ° Golang å°±æ˜¯ï¼š&lt;/p>
&lt;blockquote>
&lt;p>Return &lt;strong>concrete types&lt;/strong>, receive &lt;strong>interfaces&lt;/strong> as parameter. â€” Robustness Principle applied to Go&lt;/p>
&lt;/blockquote>
&lt;p>è¯è¯´è¿™ä¹ˆè¯´ï¼Œä½†æ˜¯å½“æˆ‘ä»¬ç¿»é˜… Golang æºç çš„æ—¶å€™ï¼Œæœ‰äº›å‡½æ•°çš„è¿”å›å€¼ä¹Ÿæ˜¯ interfaceã€‚&lt;/p>
&lt;h4 id="hiding-implement-detail">hiding implement detail&lt;/h4>
&lt;p>éšè—å…·ä½“å®ç°ï¼Œè¿™ä¸ªå¾ˆå¥½ç†è§£ã€‚æ¯”å¦‚æˆ‘è®¾è®¡ä¸€ä¸ªå‡½æ•°ç»™ä½ è¿”å›ä¸€ä¸ª interfaceï¼Œé‚£ä¹ˆä½ åªèƒ½é€šè¿‡ interface é‡Œé¢çš„æ–¹æ³•æ¥åšä¸€äº›æ“ä½œï¼Œä½†æ˜¯å†…éƒ¨çš„å…·ä½“å®ç°æ˜¯å®Œå…¨ä¸çŸ¥é“çš„ã€‚Francesc ä¸¾äº†ä¸ª context çš„ä¾‹å­ã€‚ context æœ€å…ˆç”± google æä¾›ï¼Œç°åœ¨å·²ç»çº³å…¥äº†æ ‡å‡†åº“ï¼Œè€Œä¸”åœ¨åŸæœ‰ context çš„åŸºç¡€ä¸Šå¢åŠ äº†ï¼šcancelCtxï¼ŒtimerCtxï¼ŒvalueCtxã€‚è¯­è¨€çš„è¡¨è¾¾æœ‰æ—¶å€™ç•¥æ˜¾è‹ç™½æ— åŠ›ï¼Œçœ‹ä¸€ä¸‹ context åŒ…çš„ä»£ç å§ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">WithCancel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">parent&lt;/span> &lt;span class="nx">Context&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">cancel&lt;/span> &lt;span class="nx">CancelFunc&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">c&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">newCancelCtx&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">parent&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nf">propagateCancel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">parent&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">cancel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">Canceled&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¡¨æ˜ä¸Š WithCancel å‡½æ•°è¿”å›çš„è¿˜æ˜¯ä¸€ä¸ª Context interfaceï¼Œä½†æ˜¯è¿™ä¸ª interface çš„å…·ä½“å®ç°æ˜¯ cancelCtx structã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// newCancelCtx returns an initialized cancelCtx.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">newCancelCtx&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">parent&lt;/span> &lt;span class="nx">Context&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nx">cancelCtx&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">cancelCtx&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">Context&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">parent&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">done&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kd">struct&lt;/span>&lt;span class="p">{}),&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// A cancelCtx can be canceled. When canceled, it also cancels any children
&lt;/span>&lt;span class="c1">// that implement canceler.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">cancelCtx&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">Context&lt;/span> &lt;span class="c1">//æ³¨æ„ä¸€ä¸‹è¿™ä¸ªåœ°æ–¹
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="nx">done&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="kd">struct&lt;/span>&lt;span class="p">{}&lt;/span> &lt;span class="c1">// closed by the first cancel call.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">mu&lt;/span> &lt;span class="nx">sync&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Mutex&lt;/span>
&lt;span class="nx">children&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">canceler&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kd">struct&lt;/span>&lt;span class="p">{}&lt;/span> &lt;span class="c1">// set to nil by the first cancel call
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="c1">// set to non-nil by the first cancel call
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">cancelCtx&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Done&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="kd">struct&lt;/span>&lt;span class="p">{}&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">done&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">cancelCtx&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Err&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">mu&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Lock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">mu&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unlock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">cancelCtx&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">String&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sprintf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;%v.WithCancel&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å°½ç®¡å†…éƒ¨å®ç°ä¸Šä¸‹é¢ä¸‰ä¸ªå‡½æ•°è¿”å›çš„å…·ä½“ struct ï¼ˆéƒ½å®ç°äº† Context interfaceï¼‰ä¸åŒï¼Œä½†æ˜¯å¯¹äºä½¿ç”¨è€…æ¥è¯´æ˜¯å®Œå…¨æ— æ„ŸçŸ¥çš„ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">WithCancel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">parent&lt;/span> &lt;span class="nx">Context&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">ctx&lt;/span> &lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">cancel&lt;/span> &lt;span class="nx">CancelFunc&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">//è¿”å› cancelCtx
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">WithDeadline&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">parent&lt;/span> &lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">deadline&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Time&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">CancelFunc&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">//è¿”å› timerCtx
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">WithValue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">parent&lt;/span> &lt;span class="nx">Context&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">val&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="nx">Context&lt;/span> &lt;span class="c1">//è¿”å› valueCtx
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="providing-interception-points">providing interception points&lt;/h4>
&lt;p>è¿™é‡Œçš„ interception æƒ³è¡¨è¾¾çš„æ„æ€åº”è¯¥æ˜¯ wrapper æˆ–è€…è£…é¥°å™¨ï¼Œä»–ç»™å‡ºäº†ä¸€ä¸ªä¾‹å­å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">header&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">rt&lt;/span> &lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">RoundTripper&lt;/span>
&lt;span class="nx">v&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">string&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">h&lt;/span> &lt;span class="nx">header&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">RoundTrip&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">r&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Request&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">http&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Response&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">k&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">h&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">v&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">r&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Header&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">k&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="nx">v&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">h&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">rt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">RoundTrip&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">r&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€šè¿‡ interfaceï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç±»ä¼¼è¿™ç§æ–¹å¼å®ç°åŠ¨æ€åˆ†é… (dynamic dispatch)ã€‚&lt;/p>
&lt;h3 id="éä¾µå…¥å¼">éä¾µå…¥å¼&lt;/h3>
&lt;p>ä»€ä¹ˆæ˜¯ä¾µå…¥å¼å‘¢ï¼Ÿæ¯”å¦‚ Java çš„ interface å®ç°éœ€è¦æ˜¾ç¤ºçš„å£°æ˜ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="kd">public&lt;/span> &lt;span class="kd">class&lt;/span> &lt;span class="nc">MyWriter&lt;/span> &lt;span class="kd">implements&lt;/span> &lt;span class="n">io&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="na">Writer&lt;/span> &lt;span class="o">{}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¿™æ ·å°±æ„å‘³ç€å¦‚æœè¦å®ç°å¤šä¸ª interface éœ€è¦æ˜¾ç¤ºåœ°å†™å¾ˆå¤šéï¼ŒåŒæ—¶ package çš„ä¾èµ–è¿˜éœ€è¦è¿›è¡Œç®¡ç†ã€‚Dependency is evilã€‚æ¯”å¦‚æˆ‘è¦å®ç° io åŒ…é‡Œé¢çš„ Readerï¼ŒWriterï¼ŒReadWriter æ¥å£ï¼Œä»£ç å¯ä»¥åƒä¸‹é¢è¿™æ ·å†™ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">MyIO&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">io&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">MyIO&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Read&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">n&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">io&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">MyIO&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">n&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="c1">// io package
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">Reader&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">Read&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">n&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">Writer&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">Write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">n&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">ReadWriter&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">Reader&lt;/span>
&lt;span class="nx">Writer&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¿™ç§å†™æ³•çœŸçš„å¾ˆæ–¹ä¾¿ï¼Œè€Œä¸”ä¸ç”¨å»æ˜¾ç¤ºçš„ import io packageï¼Œinterface åº•å±‚å®ç°çš„æ—¶å€™ä¼šåŠ¨æ€çš„æ£€æµ‹ã€‚è¿™æ ·ä¹Ÿä¼šå¼•å…¥ä¸€äº›é—®é¢˜ï¼š&lt;/p>
&lt;ol>
&lt;li>æ€§èƒ½ä¸‹é™ã€‚ä½¿ç”¨ interface ä½œä¸ºå‡½æ•°å‚æ•°ï¼Œruntime çš„æ—¶å€™ä¼šåŠ¨æ€çš„ç¡®å®šè¡Œä¸ºã€‚è€Œä½¿ç”¨ struct ä½œä¸ºå‚æ•°ï¼Œç¼–è¯‘æœŸé—´å°±å¯ä»¥ç¡®å®šäº†ã€‚&lt;/li>
&lt;li>ä¸çŸ¥é“ struct å®ç°å“ªäº› interfaceã€‚è¿™ä¸ªé—®é¢˜å¯ä»¥ä½¿ç”¨ guru å·¥å…·æ¥è§£å†³ã€‚&lt;/li>
&lt;/ol>
&lt;p>ç»¼ä¸Šï¼ŒGolang interface çš„è¿™ç§éä¾µå…¥å®ç°çœŸçš„å¾ˆéš¾è¯´å®ƒæ˜¯å¥½ï¼Œè¿˜æ˜¯åã€‚ä½†æ˜¯å¯ä»¥è‚¯å®šçš„ä¸€ç‚¹æ˜¯ï¼Œå¯¹å¼€å‘äººå‘˜æ¥è¯´ä»£ç å†™èµ·æ¥æ›´ç®€å•äº†ã€‚&lt;/p>
&lt;h3 id="interface-type-assertion">interface type assertion&lt;/h3>
&lt;p>interface åƒå…¶ä»–ç±»å‹è½¬æ¢çš„æ—¶å€™ä¸€èˆ¬æˆ‘ä»¬ç§°ä½œæ–­è¨€ï¼Œä¸¾ä¸ªä¾‹å­ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">do&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">v&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">n&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// might panic
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¿™æ ·å†™çš„åå¤„åœ¨äºï¼šä¸€æ—¦æ–­è¨€å¤±è´¥ï¼Œç¨‹åºå°†ä¼š panicã€‚ä¸€ç§é¿å… panic çš„å†™æ³•æ˜¯ä½¿ç”¨ type assertionã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">do&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">v&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">.(&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">ok&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// æ–­è¨€å¤±è´¥å¤„ç†
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯¹äº interface çš„æ“ä½œå¯ä»¥ä½¿ç”¨ reflect åŒ…æ¥å¤„ç†ï¼Œå…³äº reflect åŒ…çš„åŸç†å’Œä½¿ç”¨å¯ä»¥å‚è€ƒæˆ‘çš„æ–‡ç« ã€‚&lt;/p>
&lt;h3 id="æ€»ç»“">æ€»ç»“&lt;/h3>
&lt;p>interface æ˜¯ Golang çš„ä¸€ç§é‡è¦çš„ç‰¹æ€§ï¼Œä½†æ˜¯è¿™æ˜¯ä»¥ runtime ä¸ºä»£ä»·çš„ï¼Œä¹Ÿå°±æ„å‘³ç€æ€§èƒ½çš„æŸå¤±ï¼ˆå…³äº interface çš„åº•å±‚å®ç°ä¹‹åæœ‰æ—¶é—´å†å†™ï¼‰ã€‚æŠ›å¼€æ€§èƒ½ä¸è°ˆï¼Œinterface å¯¹äºå¦‚ä½•è®¾è®¡æˆ‘ä»¬çš„ä»£ç ç¡®å®ç»™äº†ä¸€ä¸ªå¾ˆå¥½çš„æ€è€ƒã€‚&lt;/p>
&lt;h2 id="å‚è€ƒ">å‚è€ƒ&lt;/h2>
&lt;ol>
&lt;li>&lt;a href="http://legendtkl.com/2015/11/25/go-generic-programming/">Golang â€œæ³›å‹ç¼–ç¨‹â€&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://legendtkl.com/2015/11/28/go-interface-reflect/">è°ˆä¸€è°ˆ Golang çš„ interface å’Œ reflect&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.youtube.com/watch?v=F4wUrj6pmSI&amp;amp;t=2319s">understanding golang interface(Gopher China) â€” youtube&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/gopherchina/conference/blob/master/2017/1.4%20interface.presented.pdf">understanding golang interface(Gopher China) â€” slide&lt;/a>&lt;/li>
&lt;/ol></content><category scheme="https://yusank.github.io/categories/%E6%8A%80%E6%9C%AF/" term="æŠ€æœ¯" label="æŠ€æœ¯"/><category scheme="https://yusank.github.io/tags/go/" term="go" label="go"/></entry><entry><title type="text">Go Format</title><link rel="alternate" type="text/html" href="https://yusank.github.io/posts/go-format/"/><id>https://yusank.github.io/posts/go-format/</id><updated>2021-09-18T06:24:55+00:00</updated><published>2017-06-04T17:59:00+08:00</published><author><name>yusank</name><uri>https://yusank.github.io/</uri><email>yusankurban@gmail.com</email></author><summary type="html">go ä»£ç çš„ä¸€äº›è§„èŒƒå’Œå‘½åè§„åˆ™...... Golang ä»£ç è§„èŒƒ é¡¹ç›®ç›®å½•ç»“æ„ 1 2 3 4 5 6 7 8 9 10â€¦â€¦</summary><content type="html">&lt;p>go ä»£ç çš„ä¸€äº›è§„èŒƒå’Œå‘½åè§„åˆ™......&lt;/p>
&lt;h1 id="golang-ä»£ç è§„èŒƒ">Golang ä»£ç è§„èŒƒ&lt;/h1>
&lt;h2 id="é¡¹ç›®ç›®å½•ç»“æ„">é¡¹ç›®ç›®å½•ç»“æ„&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">PROJECT_NAME
â”œâ”€â”€ README.md ä»‹ç»è½¯ä»¶åŠæ–‡æ¡£å…¥å£
â”œâ”€â”€ bin ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶,æ‰§è¡Œ./build.shè‡ªåŠ¨ç”Ÿæˆï¼Œè¯¥ç›®å½•ä¹Ÿç”¨äºç¨‹åºæ‰“åŒ…
â”œâ”€â”€ build.sh è‡ªåŠ¨ç¼–è¯‘çš„è„šæœ¬
â”œâ”€â”€ doc è¯¥é¡¹ç›®çš„æ–‡æ¡£
â”œâ”€â”€ pack æ‰“åŒ…åçš„ç¨‹åºæ”¾åœ¨æ­¤å¤„
â”œâ”€â”€ pack.sh è‡ªåŠ¨æ‰“åŒ…çš„è„šæœ¬ï¼Œç”Ÿæˆç±»ä¼¼xxxx.20170713_14:45:35.tar.gzçš„æ–‡ä»¶ï¼Œæ”¾åœ¨packæ–‡ä»¶ä¸‹
â””â”€â”€ src è¯¥é¡¹ç›®çš„æºä»£ç 
â”œâ”€â”€ main é¡¹ç›®ä¸»å‡½æ•°
â”œâ”€â”€ model é¡¹ç›®ä»£ç 
â”œâ”€â”€ research åœ¨å®ç°è¯¥é¡¹ç›®ä¸­æ¢ç©¶çš„ä¸€äº›ç¨‹åº
â””â”€â”€ vendor å­˜æ”¾goçš„åº“
â”œâ”€â”€ github.com/xxx ç¬¬ä¸‰æ–¹åº“
â””â”€â”€ xxx.com/obc å…¬å¸å†…éƒ¨çš„å…¬å…±åº“
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é¡¹ç›®çš„ç›®å½•ç»“æ„å°½é‡åšåˆ°ç®€æ˜ã€å±‚æ¬¡æ˜ç¡®ã€‚&lt;/p>
&lt;h2 id="å‘½åè§„èŒƒ">å‘½åè§„èŒƒ&lt;/h2>
&lt;h3 id="æ–‡ä»¶åå‘½åè§„èŒƒ">æ–‡ä»¶åå‘½åè§„èŒƒ&lt;/h3>
&lt;p>ç”¨å°å†™ï¼Œå°½é‡è§åæ€ä¹‰ï¼Œçœ‹è§æ–‡ä»¶åå°±å¯ä»¥çŸ¥é“è¿™ä¸ªæ–‡ä»¶ä¸‹çš„å¤§æ¦‚å†…å®¹ï¼Œå¯¹äºæºä»£ç é‡Œçš„æ–‡ä»¶ï¼Œæ–‡ä»¶åè¦å¾ˆå¥½çš„ä»£è¡¨äº†ä¸€ä¸ªæ¨¡å—å®ç°çš„åŠŸèƒ½ã€‚&lt;/p>
&lt;h3 id="åŒ…å">åŒ…å&lt;/h3>
&lt;p>åŒ…åç”¨å°å†™ï¼Œä½¿ç”¨çŸ­å‘½åï¼Œå°½é‡ä¸è¦å’Œæ ‡å‡†åº“å†²çªã€‚&lt;/p>
&lt;h3 id="æ¥å£å">æ¥å£å&lt;/h3>
&lt;p>å•ä¸ªå‡½æ•°çš„æ¥å£ä»¥ &lt;code>er&lt;/code> ä½œä¸ºåç¼€ï¼Œå¦‚ Readerï¼Œ Writer&lt;/p>
&lt;p>æ¥å£çš„å®ç°åˆ™å»æ‰åç¼€&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Reader&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">Read&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¸¤ä¸ªå‡½æ•°çš„æ¥å£åç»¼åˆä¸¤ä¸ªå‡½æ•°å&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">WriteFlusher&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">Write&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nf">Flush&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¸‰ä¸ªä»¥ä¸Šå‡½æ•°çš„æ¥å£åï¼Œç±»ä¼¼äºç»“æ„ä½“å&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Car&lt;/span> &lt;span class="kd">interface&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">Start&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nf">Stop&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">error&lt;/span>
&lt;span class="nf">Recover&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="å˜é‡">å˜é‡&lt;/h3>
&lt;p>å…¨å±€å˜é‡ï¼šé‡‡ç”¨é©¼å³°å‘½åæ³•ï¼Œä»…é™åœ¨åŒ…å†…çš„å…¨å±€å˜é‡ï¼ŒåŒ…å¤–å¼•ç”¨éœ€è¦å†™æ¥å£ï¼Œæä¾›è°ƒç”¨ï¼›&lt;/p>
&lt;p>å±€éƒ¨å˜é‡ï¼šé©¼å³°å¼ï¼Œç¬¬ä¸€ä¸ªå•è¯çš„é¦–å­—æ¯å°å†™ï¼Œå¦‚æœ‰ä¸¤ä¸ªä»¥ä¸Šå•è¯ç»„æˆçš„å˜é‡åï¼Œç¬¬äºŒä¸ªå•è¯å¼€å§‹é¦–å­—æ¯å¤§å†™ã€‚&lt;/p>
&lt;h3 id="å¸¸é‡">å¸¸é‡&lt;/h3>
&lt;p>å…¨å±€ï¼šé©¼å³°å‘½åï¼Œæ¯ä¸ªå•è¯çš„é¦–å­—æ¯å¤§å†™&lt;/p>
&lt;p>å±€éƒ¨ï¼šä¸å˜é‡çš„é£æ ¼ä¸€æ ·&lt;/p>
&lt;h2 id="å‡½æ•°å">å‡½æ•°å&lt;/h2>
&lt;p>å‡½æ•°åé‡‡ç”¨é©¼å³°å‘½åæ³•ï¼Œä¸è¦ä½¿ç”¨ä¸‹åˆ’çº¿ã€‚&lt;/p>
&lt;h2 id="import-è§„èŒƒ">import è§„èŒƒ&lt;/h2>
&lt;p>importåœ¨å¤šè¡Œçš„æƒ…å†µä¸‹ï¼Œgoimports ä¼šè‡ªåŠ¨å¸®ä½ æ ¼å¼åŒ–ï¼Œåœ¨ä¸€ä¸ªæ–‡ä»¶é‡Œé¢å¼•å…¥äº†ä¸€ä¸ªpackageï¼Œå»ºè®®é‡‡ç”¨å¦‚ä¸‹æ ¼å¼ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœä½ çš„åŒ…å¼•å…¥äº†ä¸‰ç§ç±»å‹çš„åŒ…ï¼Œæ ‡å‡†åº“åŒ…ï¼Œç¨‹åºå†…éƒ¨åŒ…ï¼Œç¬¬ä¸‰æ–¹åŒ…ï¼Œå»ºè®®é‡‡ç”¨å¦‚ä¸‹æ–¹å¼è¿›è¡Œç»„ç»‡ä½ çš„åŒ…ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">import&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="s">&amp;#34;net&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;strings&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;github.com/astaxie/beego&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;gopkg.in/mgo.v2&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;myproject/models&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;myproject/utils&amp;#34;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é¡¹ç›®ä¸­æœ€å¥½ä¸è¦ä½¿ç”¨ç›¸å¯¹è·¯å¾„å¯¼å…¥åŒ…ï¼š&lt;/p>
&lt;p>// è¿™æ˜¯ä¸å¥½çš„å¯¼å…¥&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">import&lt;/span> &lt;span class="err">â€œ&lt;/span>&lt;span class="p">..&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">net&lt;/span>&lt;span class="err">â€&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>// è¿™æ˜¯æ­£ç¡®çš„åšæ³•&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">import&lt;/span> &lt;span class="err">â€œ&lt;/span>&lt;span class="nx">xxxx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">com&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">proj&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nx">net&lt;/span>&lt;span class="err">â€&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="é”™è¯¯å¤„ç†">é”™è¯¯å¤„ç†&lt;/h2>
&lt;p>errorä½œä¸ºå‡½æ•°çš„å€¼è¿”å›,å¿…é¡»å°½å¿«å¯¹errorè¿›è¡Œå¤„ç†&lt;/p>
&lt;p>é‡‡ç”¨ç‹¬ç«‹çš„é”™è¯¯æµè¿›è¡Œå¤„ç†&lt;/p>
&lt;p>ä¸è¦é‡‡ç”¨è¿™ç§æ–¹å¼&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// error handling
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// normal code
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è€Œé‡‡ç”¨ä»¥ä¸‹æ–¹å¼&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go"> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// error handling
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="c1">// or continue, etc.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="c1">// normal code
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœè¿”å›å€¼éœ€è¦åˆå§‹åŒ–ï¼Œåˆ™é‡‡ç”¨ä»¥ä¸‹æ–¹å¼&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">x&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">f&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="c1">// error handling
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// use x
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="panic">panic&lt;/h3>
&lt;p>åœ¨é€»è¾‘å¤„ç†ä¸­ç¦ç”¨panic&lt;/p>
&lt;p>åœ¨ main åŒ…ä¸­åªæœ‰å½“å®åœ¨ä¸å¯è¿è¡Œçš„æƒ…å†µé‡‡ç”¨ panicï¼Œä¾‹å¦‚æ–‡ä»¶æ— æ³•æ‰“å¼€ï¼Œæ•°æ®åº“æ— æ³•è¿æ¥å¯¼è‡´ç¨‹åºæ— æ³• æ­£å¸¸è¿è¡Œï¼Œä½†æ˜¯å¯¹äºå…¶ä»–çš„ package å¯¹å¤–çš„æ¥å£ä¸èƒ½æœ‰ panicï¼Œåªèƒ½åœ¨åŒ…å†…é‡‡ç”¨ã€‚ å»ºè®®åœ¨ main åŒ…ä¸­ä½¿ç”¨ log.Fatal æ¥è®°å½•é”™è¯¯ï¼Œè¿™æ ·å°±å¯ä»¥ç”± log æ¥ç»“æŸç¨‹åºã€‚&lt;/p>
&lt;h2 id="recover">Recover&lt;/h2>
&lt;p>recover ç”¨äºæ•è· runtime çš„å¼‚å¸¸ï¼Œç¦æ­¢æ»¥ç”¨ recoverï¼Œåœ¨å¼€å‘æµ‹è¯•é˜¶æ®µå°½é‡ä¸è¦ç”¨ recoverï¼Œrecover ä¸€èˆ¬æ”¾åœ¨ä½ è®¤ä¸ºä¼šæœ‰ä¸å¯é¢„æœŸçš„å¼‚å¸¸çš„åœ°æ–¹ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">server&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">workChan&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="kd">chan&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Work&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">work&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">workChan&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">go&lt;/span> &lt;span class="nf">safelyDo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">work&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">safelyDo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">work&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Work&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">recover&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">log&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;work failed:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}()&lt;/span>
&lt;span class="c1">// do å‡½æ•°å¯èƒ½ä¼šæœ‰ä¸å¯é¢„æœŸçš„å¼‚å¸¸
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">do&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">work&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="defer">Defer&lt;/h2>
&lt;p>defer åœ¨å‡½æ•° return ä¹‹å‰æ‰§è¡Œï¼Œå¯¹äºä¸€äº›èµ„æºçš„å›æ”¶ç”¨ defer æ˜¯å¥½çš„ï¼Œä½†ä¹Ÿç¦æ­¢æ»¥ç”¨ deferï¼Œdefer æ˜¯éœ€è¦æ¶ˆè€—æ€§èƒ½çš„,æ‰€ä»¥é¢‘ç¹è°ƒç”¨çš„å‡½æ•°å°½é‡ä¸è¦ä½¿ç”¨ deferã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">// Contents returns the file&amp;#39;s contents as a string.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">func&lt;/span> &lt;span class="nf">Contents&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">filename&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">f&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">filename&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">f&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="c1">// f.Close will run when we&amp;#39;re finished.
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">result&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>
&lt;span class="nx">buf&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">f&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Read&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">:])&lt;/span>
&lt;span class="nx">result&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">result&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">buf&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="nx">n&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">...&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// append is discussed later.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nx">io&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">EOF&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">break&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="c1">// f will be closed if we return here.
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nb">string&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">result&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="c1">// f will be closed if we return here.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="æ§åˆ¶ç»“æ„">æ§åˆ¶ç»“æ„&lt;/h2>
&lt;h3 id="if">if&lt;/h3>
&lt;p>ifæ¥å—åˆå§‹åŒ–è¯­å¥ï¼Œçº¦å®šå¦‚ä¸‹æ–¹å¼å»ºç«‹å±€éƒ¨å˜é‡&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Chmod&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mo">0664&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="for">for&lt;/h3>
&lt;p>é‡‡ç”¨çŸ­å£°æ˜å»ºç«‹å±€éƒ¨å˜é‡&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">sum&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">sum&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="nx">i&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="range">range&lt;/h3>
&lt;p>å¦‚æœåªéœ€è¦ç¬¬ä¸€é¡¹ï¼ˆkeyï¼‰ï¼Œå°±ä¸¢å¼ƒç¬¬äºŒä¸ªï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="k">for&lt;/span> &lt;span class="nx">key&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">m&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">key&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">expired&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">delete&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">key&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœåªéœ€è¦ç¬¬äºŒé¡¹ï¼Œåˆ™æŠŠç¬¬ä¸€é¡¹ç½®ä¸ºä¸‹åˆ’çº¿&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">sum&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">value&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="k">range&lt;/span> &lt;span class="nx">array&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">sum&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="nx">value&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="return">return&lt;/h3>
&lt;p>å°½æ—©returnï¼šä¸€æ—¦æœ‰é”™è¯¯å‘ç”Ÿï¼Œé©¬ä¸Šè¿”å›&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="nx">f&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">name&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">d&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">f&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Stat&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">f&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">err&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nf">codeUsing&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">f&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">d&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="æ–¹æ³•æ¥æ”¶å™¨">æ–¹æ³•æ¥æ”¶å™¨&lt;/h2>
&lt;p>åç§°ä¸€èˆ¬é‡‡ç”¨ struct çš„ç¬¬ä¸€ä¸ªå­—æ¯ä¸”ä¸ºå°å†™ï¼Œ è€Œä¸æ˜¯ thisï¼Œme æˆ– self&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Transfer&lt;/span> &lt;span class="kd">struct&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Transfer&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Get&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœæ¥æ”¶è€…æ˜¯ mapï¼Œ slice æˆ–è€… chanï¼Œä¸è¦ç”¨æŒ‡é’ˆä¼ é€’&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//Map
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">mp&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">string&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span> &lt;span class="nx">mp&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">k&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">m&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">k&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">v&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">m&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">mp&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;k&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;v&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//Channel
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">ch&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="nx">ch&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Push&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">i&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{})&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">c&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span> &lt;span class="nx">i&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span> &lt;span class="nx">ch&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Pop&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kd">interface&lt;/span>&lt;span class="p">{}&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">c&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">c&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ch&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Push&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;i&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Pop&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœéœ€è¦å¯¹ slice è¿›è¡Œä¿®æ”¹ï¼Œé€šè¿‡è¿”å›å€¼çš„æ–¹å¼é‡æ–°å¤åˆ¶&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//Slice
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">slice&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">s&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">slice&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">s&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">addOne&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">42&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span> &lt;span class="nx">slice&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">addOne&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">b&lt;/span> &lt;span class="kt">byte&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">byte&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nb">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">b&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœæ¥æ”¶è€…æ˜¯å«æœ‰ sync.Mutex æˆ–è€…ç±»ä¼¼åŒæ­¥å­—æ®µçš„ç»“æ„ä½“ï¼Œå¿…é¡»ä½¿ç”¨æŒ‡é’ˆä¼ é€’é¿å…å¤åˆ¶&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;sync&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">T&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">m&lt;/span> &lt;span class="nx">sync&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Mutex&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">T&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">lock&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">t&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">m&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Lock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="cm">/*
&lt;/span>&lt;span class="cm">Wrong !!!
&lt;/span>&lt;span class="cm">func (t T) lock() {
&lt;/span>&lt;span class="cm"> t.m.Lock()
&lt;/span>&lt;span class="cm">}
&lt;/span>&lt;span class="cm">*/&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">t&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">T&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">t&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">lock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœæ¥æ”¶è€…æ˜¯å¤§çš„ç»“æ„ä½“æˆ–è€…æ•°ç»„ï¼Œä½¿ç”¨æŒ‡é’ˆä¼ é€’ä¼šæ›´æœ‰æ•ˆç‡ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">T&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">data&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">1024&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">byte&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">T&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">Get&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">byte&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">t&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">data&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">t&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">T&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Get&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="ä¸€é”®ä»£ç è§„èŒƒ">ä¸€é”®ä»£ç è§„èŒƒ&lt;/h2>
&lt;p>ä½¿ç”¨ JetBrain ç³»åˆ— IDE çš„åŒå­¦ï¼Œå¯ä»¥æŒ‰å¿«æ·é”®æˆ–è€…é¼ æ ‡å³é”®æ¥ä¸€é”®ä½¿ç”¨ go æä¾›çš„ &lt;code>format&lt;/code> å‘½ä»¤;&lt;/p>
&lt;p>å¿«æ·é”®ï¼š&lt;/p>
&lt;p>cmd + option + shift + f å¯¹å½“å‰æ–‡ä»¶è¿›è¡Œ format&lt;/p>
&lt;p>cmd + option + shift + p å¯¹å½“å‰é¡¹ç›®æ‰€æœ‰ go æ–‡ä»¶è¿›è¡Œ format&lt;/p>
&lt;p>é¼ æ ‡å³é”®ï¼š&lt;/p>
&lt;p>åœ¨ IDE å†…ç‚¹å‡»é¼ æ ‡å³é”®ï¼Œé€‰æ‹© &lt;code>Go Tools&lt;/code>,ç„¶åå¯ä»¥é€‰æ‹©å¯¹å•ä¸ªæ–‡ä»¶æˆ–é¡¹ç›®è¿›è¡Œ formatã€‚&lt;/p>
&lt;p>ç”¨ vscode çš„åŒå­¦ï¼Œåœ¨è®¾ç½®é‡Œé¢åŠ ä¸Šä»¥ä¸‹è¯­å¥å³å¯ä»¥ä¿å­˜æ–‡ä»¶åè‡ªåŠ¨è¿›è¡Œ format&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="s2">&amp;#34;go.formatOnSave&amp;#34;&lt;/span>&lt;span class="err">:&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>ä»£ç é£æ ¼å’Œä»£ç è§„èŒƒæ˜¯ä½“ç°ä¸€ä¸ªç¨‹åºå‘˜çš„åŸºæœ¬ç´ è´¨çš„ä¸€é¡¹æŒ‡æ ‡ï¼Œä¹Ÿæ˜¯å¯¹è‡ªå·±çš„ä»£ç å’Œä»–äººçš„ä¸€ä¸ªæœ€åŸºæœ¬çš„å°Šé‡ã€‚&lt;/p></content><category scheme="https://yusank.github.io/categories/%E6%8A%80%E6%9C%AF/" term="æŠ€æœ¯" label="æŠ€æœ¯"/><category scheme="https://yusank.github.io/tags/go/" term="go" label="go"/><category scheme="https://yusank.github.io/tags/%E4%BB%A3%E7%A0%81%E8%A7%84%E8%8C%83/" term="ä»£ç è§„èŒƒ" label="ä»£ç è§„èŒƒ"/></entry><entry><title type="text">GO test</title><link rel="alternate" type="text/html" href="https://yusank.github.io/posts/go-test/"/><id>https://yusank.github.io/posts/go-test/</id><updated>2021-09-18T06:24:55+00:00</updated><published>2017-06-01T15:07:00+08:00</published><author><name>yusank</name><uri>https://yusank.github.io/</uri><email>yusankurban@gmail.com</email></author><summary type="html">Go æµ‹è¯•ç”¨ä¾‹ å¼€å‘ç¨‹åºå…¶ä¸­å¾ˆé‡è¦çš„ä¸€ç‚¹æ˜¯æµ‹è¯•ï¼Œæˆ‘ä»¬å¦‚ä½•ä¿è¯ä»£ç çš„è´¨é‡ï¼Œå¦‚ä½•ä¿è¯æ¯ä¸ªå‡½â€¦â€¦</summary><content type="html">&lt;h1 id="go-æµ‹è¯•ç”¨ä¾‹">Go æµ‹è¯•ç”¨ä¾‹&lt;/h1>
&lt;p>å¼€å‘ç¨‹åºå…¶ä¸­å¾ˆé‡è¦çš„ä¸€ç‚¹æ˜¯æµ‹è¯•ï¼Œæˆ‘ä»¬å¦‚ä½•ä¿è¯ä»£ç çš„è´¨é‡ï¼Œå¦‚ä½•ä¿è¯æ¯ä¸ªå‡½æ•°æ˜¯å¯è¿è¡Œï¼Œè¿è¡Œç»“æœæ˜¯æ­£ç¡®çš„ï¼Œåˆå¦‚ä½•ä¿è¯å†™å‡ºæ¥çš„ä»£ç æ€§èƒ½æ˜¯å¥½çš„ï¼Œæˆ‘ä»¬çŸ¥é“å•å…ƒæµ‹è¯•çš„é‡ç‚¹åœ¨äºå‘ç°ç¨‹åºè®¾è®¡æˆ–å®ç°çš„é€»è¾‘é”™è¯¯ï¼Œä½¿é—®é¢˜åŠæ—©æš´éœ²ï¼Œä¾¿äºé—®é¢˜çš„å®šä½è§£å†³ï¼Œè€Œæ€§èƒ½æµ‹è¯•çš„é‡ç‚¹åœ¨äºå‘ç°ç¨‹åºè®¾è®¡ä¸Šçš„ä¸€äº›é—®é¢˜ï¼Œè®©çº¿ä¸Šçš„ç¨‹åºèƒ½å¤Ÿåœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹è¿˜èƒ½ä¿æŒç¨³å®šã€‚æœ¬å°èŠ‚å°†å¸¦ç€è¿™ä¸€è¿ä¸²çš„é—®é¢˜æ¥è®²è§£Goè¯­è¨€ä¸­å¦‚ä½•æ¥å®ç°å•å…ƒæµ‹è¯•å’Œæ€§èƒ½æµ‹è¯•ã€‚&lt;/p>
&lt;p>Goè¯­è¨€ä¸­è‡ªå¸¦æœ‰ä¸€ä¸ªè½»é‡çº§çš„æµ‹è¯•æ¡†æ¶&lt;code>testing&lt;/code>å’Œè‡ªå¸¦çš„&lt;code>go test&lt;/code>å‘½ä»¤æ¥å®ç°å•å…ƒæµ‹è¯•å’Œæ€§èƒ½æµ‹è¯•ï¼Œ&lt;code>testing&lt;/code>æ¡†æ¶å’Œå…¶ä»–è¯­è¨€ä¸­çš„æµ‹è¯•æ¡†æ¶ç±»ä¼¼ï¼Œä½ å¯ä»¥åŸºäºè¿™ä¸ªæ¡†æ¶å†™é’ˆå¯¹ç›¸åº”å‡½æ•°çš„æµ‹è¯•ç”¨ä¾‹ï¼Œä¹Ÿå¯ä»¥åŸºäºè¯¥æ¡†æ¶å†™ç›¸åº”çš„å‹åŠ›æµ‹è¯•ç”¨ä¾‹ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥è®©æˆ‘ä»¬ä¸€ä¸€æ¥çœ‹ä¸€ä¸‹æ€ä¹ˆå†™ã€‚&lt;/p>
&lt;p>å¦å¤–å»ºè®®å®‰è£…&lt;a href="https://github.com/cweill/gotests">gotests&lt;/a>æ’ä»¶è‡ªåŠ¨ç”Ÿæˆæµ‹è¯•ä»£ç :&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">go get -u -v github.com/cweill/gotests/...
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="å¦‚ä½•ç¼–å†™æµ‹è¯•ç”¨ä¾‹">å¦‚ä½•ç¼–å†™æµ‹è¯•ç”¨ä¾‹&lt;/h2>
&lt;p>ç”±äº&lt;code>go test&lt;/code>å‘½ä»¤åªèƒ½åœ¨ä¸€ä¸ªç›¸åº”çš„ç›®å½•ä¸‹æ‰§è¡Œæ‰€æœ‰æ–‡ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¥ä¸‹æ¥æ–°å»ºä¸€ä¸ªé¡¹ç›®ç›®å½•&lt;code>gotest&lt;/code>,è¿™æ ·æˆ‘ä»¬æ‰€æœ‰çš„ä»£ç å’Œæµ‹è¯•ä»£ç éƒ½åœ¨è¿™ä¸ªç›®å½•ä¸‹ã€‚&lt;/p>
&lt;p>æ¥ä¸‹æ¥æˆ‘ä»¬åœ¨è¯¥ç›®å½•ä¸‹é¢åˆ›å»ºä¸¤ä¸ªæ–‡ä»¶ï¼šgotest.goå’Œgotest_test.go&lt;/p>
&lt;ol>
&lt;li>gotest.go:è¿™ä¸ªæ–‡ä»¶é‡Œé¢æˆ‘ä»¬æ˜¯åˆ›å»ºäº†ä¸€ä¸ªåŒ…ï¼Œé‡Œé¢æœ‰ä¸€ä¸ªå‡½æ•°å®ç°äº†é™¤æ³•è¿ç®—:&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">gotest&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;errors&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">Division&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">a&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">b&lt;/span> &lt;span class="kt">float64&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">float64&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">error&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">b&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">errors&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;é™¤æ•°ä¸èƒ½ä¸º0&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="nx">a&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="nx">b&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">nil&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="2">
&lt;li>gotest_test.go:è¿™æ˜¯æˆ‘ä»¬çš„å•å…ƒæµ‹è¯•æ–‡ä»¶ï¼Œä½†æ˜¯è®°ä½ä¸‹é¢çš„è¿™äº›åŸåˆ™ï¼š&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>æ–‡ä»¶åå¿…é¡»æ˜¯&lt;code>_test.go&lt;/code>ç»“å°¾çš„ï¼Œè¿™æ ·åœ¨æ‰§è¡Œ&lt;code>go test&lt;/code>çš„æ—¶å€™æ‰ä¼šæ‰§è¡Œåˆ°ç›¸åº”çš„ä»£ç &lt;/li>
&lt;li>ä½ å¿…é¡»import &lt;code>testing&lt;/code>è¿™ä¸ªåŒ…&lt;/li>
&lt;li>æ‰€æœ‰çš„æµ‹è¯•ç”¨ä¾‹å‡½æ•°å¿…é¡»æ˜¯&lt;code>Test&lt;/code>å¼€å¤´&lt;/li>
&lt;li>æµ‹è¯•ç”¨ä¾‹ä¼šæŒ‰ç…§æºä»£ç ä¸­å†™çš„é¡ºåºä¾æ¬¡æ‰§è¡Œ&lt;/li>
&lt;li>æµ‹è¯•å‡½æ•°&lt;code>TestXxx()&lt;/code>çš„å‚æ•°æ˜¯&lt;code>testing.T&lt;/code>ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¯¥ç±»å‹æ¥è®°å½•é”™è¯¯æˆ–è€…æ˜¯æµ‹è¯•çŠ¶æ€&lt;/li>
&lt;li>æµ‹è¯•æ ¼å¼ï¼š&lt;code>func TestXxx (t *testing.T)&lt;/code>,&lt;code>Xxx&lt;/code>éƒ¨åˆ†å¯ä»¥ä¸ºä»»æ„çš„å­—æ¯æ•°å­—çš„ç»„åˆï¼Œä½†æ˜¯é¦–å­—æ¯ä¸èƒ½æ˜¯å°å†™å­—æ¯[a-z]ï¼Œä¾‹å¦‚&lt;code>Testintdiv&lt;/code>æ˜¯é”™è¯¯çš„å‡½æ•°åã€‚&lt;/li>
&lt;li>å‡½æ•°ä¸­é€šè¿‡è°ƒç”¨&lt;code>testing.T&lt;/code>çš„&lt;code>Error&lt;/code>, &lt;code>Errorf&lt;/code>, &lt;code>FailNow&lt;/code>, &lt;code>Fatal&lt;/code>, &lt;code>FatalIf&lt;/code>æ–¹æ³•ï¼Œè¯´æ˜æµ‹è¯•ä¸é€šè¿‡ï¼Œè°ƒç”¨&lt;code>Log&lt;/code>æ–¹æ³•ç”¨æ¥è®°å½•æµ‹è¯•çš„ä¿¡æ¯ã€‚&lt;/li>
&lt;/ul>
&lt;p>ä¸‹é¢æ˜¯æˆ‘ä»¬çš„æµ‹è¯•ç”¨ä¾‹çš„ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">gotest&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;testing&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">Test_Division_1&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">testing&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">T&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">e&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">Division&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">6&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">3&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nx">e&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">//try a unit test on function
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">t&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;é™¤æ³•å‡½æ•°æµ‹è¯•æ²¡é€šè¿‡&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// å¦‚æœä¸æ˜¯å¦‚é¢„æœŸçš„é‚£ä¹ˆå°±æŠ¥é”™
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">t&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;ç¬¬ä¸€ä¸ªæµ‹è¯•é€šè¿‡äº†&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">//è®°å½•ä¸€äº›ä½ æœŸæœ›è®°å½•çš„ä¿¡æ¯
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">Test_Division_2&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">testing&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">T&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">t&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;å°±æ˜¯ä¸é€šè¿‡&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æˆ‘ä»¬åœ¨é¡¹ç›®ç›®å½•ä¸‹é¢æ‰§è¡Œ&lt;code>go test&lt;/code>,å°±ä¼šæ˜¾ç¤ºå¦‚ä¸‹ä¿¡æ¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">--- FAIL: Test_Division_2 &lt;span class="o">(&lt;/span>0.00 seconds&lt;span class="o">)&lt;/span>
gotest_test.go:16: å°±æ˜¯ä¸é€šè¿‡
FAIL
&lt;span class="nb">exit&lt;/span> status &lt;span class="m">1&lt;/span>
FAIL gotest 0.013s
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä»è¿™ä¸ªç»“æœæ˜¾ç¤ºæµ‹è¯•æ²¡æœ‰é€šè¿‡ï¼Œå› ä¸ºåœ¨ç¬¬äºŒä¸ªæµ‹è¯•å‡½æ•°ä¸­æˆ‘ä»¬å†™æ­»äº†æµ‹è¯•ä¸é€šè¿‡çš„ä»£ç &lt;code>t.Error&lt;/code>ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªå‡½æ•°æ‰§è¡Œçš„æƒ…å†µæ€ä¹ˆæ ·å‘¢ï¼Ÿé»˜è®¤æƒ…å†µä¸‹æ‰§è¡Œ&lt;code>go test&lt;/code>æ˜¯ä¸ä¼šæ˜¾ç¤ºæµ‹è¯•é€šè¿‡çš„ä¿¡æ¯çš„ï¼Œæˆ‘ä»¬éœ€è¦å¸¦ä¸Šå‚æ•°&lt;code>go test -v&lt;/code>ï¼Œè¿™æ ·å°±ä¼šæ˜¾ç¤ºå¦‚ä¸‹ä¿¡æ¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="o">===&lt;/span> RUN Test_Division_1
--- PASS: Test_Division_1 &lt;span class="o">(&lt;/span>0.00 seconds&lt;span class="o">)&lt;/span>
gotest_test.go:11: &lt;span class="nv">ç¬¬ä¸€ä¸ªæµ‹è¯•é€šè¿‡äº†&lt;/span>
&lt;span class="o">===&lt;/span> RUN Test_Division_2
--- FAIL: Test_Division_2 &lt;span class="o">(&lt;/span>0.00 seconds&lt;span class="o">)&lt;/span>
gotest_test.go:16: å°±æ˜¯ä¸é€šè¿‡
FAIL
&lt;span class="nb">exit&lt;/span> status &lt;span class="m">1&lt;/span>
FAIL gotest 0.012s
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¸Šé¢çš„è¾“å‡ºè¯¦ç»†çš„å±•ç¤ºäº†è¿™ä¸ªæµ‹è¯•çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬çœ‹åˆ°æµ‹è¯•å‡½æ•°1&lt;code>Test_Division_1&lt;/code>æµ‹è¯•é€šè¿‡ï¼Œè€Œæµ‹è¯•å‡½æ•°2&lt;code>Test_Division_2&lt;/code>æµ‹è¯•å¤±è´¥äº†ï¼Œæœ€åå¾—å‡ºç»“è®ºæµ‹è¯•ä¸é€šè¿‡ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æŠŠæµ‹è¯•å‡½æ•°2ä¿®æ”¹æˆå¦‚ä¸‹ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">Test_Division_2&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">testing&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">T&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">_&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">e&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">Division&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">6&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">e&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">//try a unit test on function
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">t&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Division did not work as expected.&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// å¦‚æœä¸æ˜¯å¦‚é¢„æœŸçš„é‚£ä¹ˆå°±æŠ¥é”™
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">t&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Log&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;one test passed.&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">e&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">//è®°å½•ä¸€äº›ä½ æœŸæœ›è®°å½•çš„ä¿¡æ¯
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç„¶åæˆ‘ä»¬æ‰§è¡Œ&lt;code>go test -v&lt;/code>ï¼Œå°±æ˜¾ç¤ºå¦‚ä¸‹ä¿¡æ¯ï¼Œæµ‹è¯•é€šè¿‡äº†ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">=== RUN Test_Division_1
--- PASS: Test_Division_1 (0.00 seconds)
gotest_test.go:11: ç¬¬ä¸€ä¸ªæµ‹è¯•é€šè¿‡äº†
=== RUN Test_Division_2
--- PASS: Test_Division_2 (0.00 seconds)
gotest_test.go:20: one test passed. é™¤æ•°ä¸èƒ½ä¸º0
PASS
ok gotest 0.013s
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="å¦‚ä½•ç¼–å†™å‹åŠ›æµ‹è¯•">å¦‚ä½•ç¼–å†™å‹åŠ›æµ‹è¯•&lt;/h2>
&lt;p>å‹åŠ›æµ‹è¯•ç”¨æ¥æ£€æµ‹å‡½æ•°(æ–¹æ³•ï¼‰çš„æ€§èƒ½ï¼Œå’Œç¼–å†™å•å…ƒåŠŸèƒ½æµ‹è¯•çš„æ–¹æ³•ç±»ä¼¼,æ­¤å¤„ä¸å†èµ˜è¿°ï¼Œä½†éœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š&lt;/p>
&lt;ul>
&lt;li>å‹åŠ›æµ‹è¯•ç”¨ä¾‹å¿…é¡»éµå¾ªå¦‚ä¸‹æ ¼å¼ï¼Œå…¶ä¸­XXXå¯ä»¥æ˜¯ä»»æ„å­—æ¯æ•°å­—çš„ç»„åˆï¼Œä½†æ˜¯é¦–å­—æ¯ä¸èƒ½æ˜¯å°å†™å­—æ¯&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">func&lt;/span> &lt;span class="nf">BenchmarkXXX&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">b&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">testing&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">B&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="o">...&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>&lt;code>go test&lt;/code>ä¸ä¼šé»˜è®¤æ‰§è¡Œå‹åŠ›æµ‹è¯•çš„å‡½æ•°ï¼Œå¦‚æœè¦æ‰§è¡Œå‹åŠ›æµ‹è¯•éœ€è¦å¸¦ä¸Šå‚æ•°&lt;code>-test.bench&lt;/code>ï¼Œè¯­æ³•:&lt;code>-test.bench=&amp;quot;test_name_regex&amp;quot;&lt;/code>,ä¾‹å¦‚&lt;code>go test -test.bench=&amp;quot;.*&amp;quot;&lt;/code>è¡¨ç¤ºæµ‹è¯•å…¨éƒ¨çš„å‹åŠ›æµ‹è¯•å‡½æ•°&lt;/li>
&lt;li>åœ¨å‹åŠ›æµ‹è¯•ç”¨ä¾‹ä¸­,è¯·è®°å¾—åœ¨å¾ªç¯ä½“å†…ä½¿ç”¨&lt;code>testing.B.N&lt;/code>,ä»¥ä½¿æµ‹è¯•å¯ä»¥æ­£å¸¸çš„è¿è¡Œ&lt;/li>
&lt;li>æ–‡ä»¶åä¹Ÿå¿…é¡»ä»¥&lt;code>_test.go&lt;/code>ç»“å°¾&lt;/li>
&lt;/ul>
&lt;p>ä¸‹é¢æˆ‘ä»¬æ–°å»ºä¸€ä¸ªå‹åŠ›æµ‹è¯•æ–‡ä»¶webbench_test.goï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">gotest&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;testing&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">Benchmark_Division&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">b&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">testing&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">B&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nx">b&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">N&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="c1">//use b.N for looping
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nf">Division&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">Benchmark_TimeConsumingFunction&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">b&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">testing&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">B&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">b&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">StopTimer&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="c1">//è°ƒç”¨è¯¥å‡½æ•°åœæ­¢å‹åŠ›æµ‹è¯•çš„æ—¶é—´è®¡æ•°
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="c1">//åšä¸€äº›åˆå§‹åŒ–çš„å·¥ä½œ,ä¾‹å¦‚è¯»å–æ–‡ä»¶æ•°æ®,æ•°æ®åº“è¿æ¥ä¹‹ç±»çš„,
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//è¿™æ ·è¿™äº›æ—¶é—´ä¸å½±å“æˆ‘ä»¬æµ‹è¯•å‡½æ•°æœ¬èº«çš„æ€§èƒ½
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="nx">b&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">StartTimer&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="c1">//é‡æ–°å¼€å§‹æ—¶é—´
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nx">b&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">N&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nf">Division&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æˆ‘ä»¬æ‰§è¡Œå‘½ä»¤&lt;code>go test -file webbench_test.go -test.bench=&amp;quot;.*&amp;quot;&lt;/code>ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹ç»“æœï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">PASS
Benchmark_Division 500000000 7.76 ns/op
Benchmark_TimeConsumingFunction 500000000 7.80 ns/op
ok gotest 9.364s
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¸Šé¢çš„ç»“æœæ˜¾ç¤ºæˆ‘ä»¬æ²¡æœ‰æ‰§è¡Œä»»ä½•&lt;code>TestXXX&lt;/code>çš„å•å…ƒæµ‹è¯•å‡½æ•°ï¼Œæ˜¾ç¤ºçš„ç»“æœåªæ‰§è¡Œäº†å‹åŠ›æµ‹è¯•å‡½æ•°ï¼Œç¬¬ä¸€æ¡æ˜¾ç¤ºäº†&lt;code>Benchmark_Division&lt;/code>æ‰§è¡Œäº†500000000æ¬¡ï¼Œæ¯æ¬¡çš„æ‰§è¡Œå¹³å‡æ—¶é—´æ˜¯7.76çº³ç§’ï¼Œç¬¬äºŒæ¡æ˜¾ç¤ºäº†&lt;code>Benchmark_TimeConsumingFunction&lt;/code>æ‰§è¡Œäº†500000000ï¼Œæ¯æ¬¡çš„å¹³å‡æ‰§è¡Œæ—¶é—´æ˜¯7.80çº³ç§’ã€‚æœ€åä¸€æ¡æ˜¾ç¤ºæ€»å…±çš„æ‰§è¡Œæ—¶é—´ã€‚&lt;/p>
&lt;h2 id="å°ç»“">å°ç»“&lt;/h2>
&lt;p>é€šè¿‡ä¸Šé¢å¯¹å•å…ƒæµ‹è¯•å’Œå‹åŠ›æµ‹è¯•çš„å­¦ä¹ ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°&lt;code>testing&lt;/code>åŒ…å¾ˆè½»é‡ï¼Œç¼–å†™å•å…ƒæµ‹è¯•å’Œå‹åŠ›æµ‹è¯•ç”¨ä¾‹éå¸¸ç®€å•ï¼Œé…åˆå†…ç½®çš„&lt;code>go test&lt;/code>å‘½ä»¤å°±å¯ä»¥éå¸¸æ–¹ä¾¿çš„è¿›è¡Œæµ‹è¯•ï¼Œè¿™æ ·åœ¨æˆ‘ä»¬æ¯æ¬¡ä¿®æ”¹å®Œä»£ç ,æ‰§è¡Œä¸€ä¸‹go testå°±å¯ä»¥ç®€å•çš„å®Œæˆå›å½’æµ‹è¯•äº†ã€‚&lt;/p></content><category scheme="https://yusank.github.io/tags/go/" term="go" label="go"/></entry><entry><title type="text">Go æ–‡ä»¶æ“ä½œ</title><link rel="alternate" type="text/html" href="https://yusank.github.io/posts/go-file/"/><id>https://yusank.github.io/posts/go-file/</id><updated>2021-09-18T06:24:55+00:00</updated><published>2017-05-22T12:20:00+08:00</published><author><name>yusank</name><uri>https://yusank.github.io/</uri><email>yusankurban@gmail.com</email></author><summary type="html">GO æ–‡ä»¶æ“ä½œ åœ¨ä»»ä½•è®¡ç®—æœºè®¾å¤‡ä¸­ï¼Œæ–‡ä»¶æ˜¯éƒ½æ˜¯å¿…é¡»çš„å¯¹è±¡ï¼Œè€Œåœ¨Webç¼–ç¨‹ä¸­,æ–‡ä»¶çš„æ“ä½œâ€¦â€¦</summary><content type="html">&lt;h1 id="go-æ–‡ä»¶æ“ä½œ">GO æ–‡ä»¶æ“ä½œ&lt;/h1>
&lt;p>åœ¨ä»»ä½•è®¡ç®—æœºè®¾å¤‡ä¸­ï¼Œæ–‡ä»¶æ˜¯éƒ½æ˜¯å¿…é¡»çš„å¯¹è±¡ï¼Œè€Œåœ¨Webç¼–ç¨‹ä¸­,æ–‡ä»¶çš„æ“ä½œä¸€ç›´æ˜¯Webç¨‹åºå‘˜ç»å¸¸é‡åˆ°çš„é—®é¢˜,æ–‡ä»¶æ“ä½œåœ¨Webåº”ç”¨ä¸­æ˜¯å¿…é¡»çš„,éå¸¸æœ‰ç”¨çš„,æˆ‘ä»¬ç»å¸¸é‡åˆ°ç”Ÿæˆæ–‡ä»¶ç›®å½•,æ–‡ä»¶(å¤¹)ç¼–è¾‘ç­‰æ“ä½œ,ç°åœ¨æˆ‘ä»¬æ¥çœ‹çœ‹ go å¯¹æ–‡ä»¶æ˜¯æ€ä¹ˆæ“ä½œçš„ã€‚&lt;/p>
&lt;h2 id="ç›®å½•æ“ä½œ">ç›®å½•æ“ä½œ&lt;/h2>
&lt;p>æ–‡ä»¶æ“ä½œçš„å¤§å¤šæ•°å‡½æ•°éƒ½æ˜¯åœ¨osåŒ…é‡Œé¢ï¼Œä¸‹é¢åˆ—ä¸¾äº†å‡ ä¸ªç›®å½•æ“ä½œçš„ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>func Mkdir(name string, perm FileMode) error&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>åˆ›å»ºåç§°ä¸ºnameçš„ç›®å½•ï¼Œæƒé™è®¾ç½®æ˜¯permï¼Œä¾‹å¦‚0777&lt;/p>
&lt;ul>
&lt;li>&lt;code>func MkdirAll(path string, perm FileMode) error&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>æ ¹æ®pathåˆ›å»ºå¤šçº§å­ç›®å½•ï¼Œä¾‹å¦‚ test/test1/test2ã€‚&lt;/p>
&lt;ul>
&lt;li>&lt;code>func Remove(name string) error&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>åˆ é™¤åç§°ä¸ºnameçš„ç›®å½•ï¼Œå½“ç›®å½•ä¸‹æœ‰æ–‡ä»¶æˆ–è€…å…¶ä»–ç›®å½•æ—¶ä¼šå‡ºé”™&lt;/p>
&lt;ul>
&lt;li>&lt;code>func RemoveAll(path string) error&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>æ ¹æ®pathåˆ é™¤å¤šçº§å­ç›®å½•ï¼Œå¦‚æœpathæ˜¯å•ä¸ªåç§°ï¼Œé‚£ä¹ˆè¯¥ç›®å½•ä¸‹çš„å­ç›®å½•å…¨éƒ¨åˆ é™¤ã€‚&lt;/p>
&lt;p>ä»¥ä¸‹æ˜¯ç®€å•çš„ä½¿ç”¨ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;os&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Mkdir&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;test&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mo">0777&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">MkdirAll&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;test/test1/test2&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mo">0777&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Remove&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;test&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;crash with error %v \n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">RemoveAll&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;test&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="æ–‡ä»¶æ“ä½œ">æ–‡ä»¶æ“ä½œ&lt;/h2>
&lt;h3 id="å»ºç«‹ä¸æ‰“å¼€æ–‡ä»¶">å»ºç«‹ä¸æ‰“å¼€æ–‡ä»¶&lt;/h3>
&lt;p>æ–°å»ºæ–‡ä»¶å¯ä»¥é€šè¿‡å¦‚ä¸‹ä¸¤ä¸ªæ–¹æ³•&lt;/p>
&lt;ul>
&lt;li>&lt;code>func Create(name string) (file *File, err Error)&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>æ ¹æ®æä¾›çš„æ–‡ä»¶ååˆ›å»ºæ–°çš„æ–‡ä»¶ï¼Œè¿”å›ä¸€ä¸ªæ–‡ä»¶å¯¹è±¡ï¼Œé»˜è®¤æƒé™æ˜¯0666çš„æ–‡ä»¶ï¼Œè¿”å›çš„æ–‡ä»¶å¯¹è±¡æ˜¯å¯è¯»å†™çš„ã€‚&lt;/p>
&lt;ul>
&lt;li>&lt;code>func NewFile(fd uintptr, name string) *File&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>æ ¹æ®æ–‡ä»¶æè¿°ç¬¦åˆ›å»ºç›¸åº”çš„æ–‡ä»¶ï¼Œè¿”å›ä¸€ä¸ªæ–‡ä»¶å¯¹è±¡&lt;/p>
&lt;p>é€šè¿‡å¦‚ä¸‹ä¸¤ä¸ªæ–¹æ³•æ¥æ‰“å¼€æ–‡ä»¶ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>func Open(name string) (file *File, err Error)&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>è¯¥æ–¹æ³•æ‰“å¼€ä¸€ä¸ªåç§°ä¸ºnameçš„æ–‡ä»¶ï¼Œä½†æ˜¯æ˜¯åªè¯»æ–¹å¼ï¼Œå†…éƒ¨å®ç°å…¶å®è°ƒç”¨äº†OpenFileã€‚&lt;/p>
&lt;ul>
&lt;li>&lt;code>func OpenFile(name string, flag int, perm uint32) (file *File, err Error)&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>æ‰“å¼€åç§°ä¸ºnameçš„æ–‡ä»¶ï¼Œflagæ˜¯æ‰“å¼€çš„æ–¹å¼ï¼Œåªè¯»ã€è¯»å†™ç­‰ï¼Œpermæ˜¯æƒé™&lt;/p>
&lt;h3 id="å†™æ–‡ä»¶">å†™æ–‡ä»¶&lt;/h3>
&lt;p>å†™æ–‡ä»¶å‡½æ•°ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>func (file *File) Write(b []byte) (n int, err Error)&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>å†™å…¥byteç±»å‹çš„ä¿¡æ¯åˆ°æ–‡ä»¶&lt;/p>
&lt;ul>
&lt;li>&lt;code>func (file *File) WriteAt(b []byte, off int64) (n int, err Error)&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>åœ¨æŒ‡å®šä½ç½®å¼€å§‹å†™å…¥byteç±»å‹çš„ä¿¡æ¯&lt;/p>
&lt;ul>
&lt;li>&lt;code>func (file *File) WriteString(s string) (ret int, err Error)&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>å†™å…¥stringä¿¡æ¯åˆ°æ–‡ä»¶&lt;/p>
&lt;p>å†™æ–‡ä»¶çš„ç¤ºä¾‹ä»£ç &lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">
&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;os&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">userFile&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="s">&amp;#34;yusank.txt&amp;#34;&lt;/span>
&lt;span class="nx">fout&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Create&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">userFile&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">userFile&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">fout&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fout&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WriteString&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Just a test!\r\n&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">fout&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Write&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="nb">byte&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Just a test!\r\n&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="è¯»æ–‡ä»¶">è¯»æ–‡ä»¶&lt;/h3>
&lt;p>è¯»æ–‡ä»¶å‡½æ•°ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>func (file *File) Read(b []byte) (n int, err Error)&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>è¯»å–æ•°æ®åˆ°bä¸­&lt;/p>
&lt;ul>
&lt;li>&lt;code>func (file *File) ReadAt(b []byte, off int64) (n int, err Error)&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>ä» off å¼€å§‹è¯»å–æ•°æ®åˆ° b ä¸­&lt;/p>
&lt;p>è¯»æ–‡ä»¶çš„ç¤ºä¾‹ä»£ç :&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">
&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;os&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">userFile&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="s">&amp;#34;yusank.txt&amp;#34;&lt;/span>
&lt;span class="nx">fl&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">userFile&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">userFile&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">fl&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">buf&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1024&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">_&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">fl&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Read&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nx">n&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">break&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Stdout&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">[:&lt;/span>&lt;span class="nx">n&lt;/span>&lt;span class="p">])&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="åˆ é™¤æ–‡ä»¶">åˆ é™¤æ–‡ä»¶&lt;/h3>
&lt;p>Goè¯­è¨€é‡Œé¢åˆ é™¤æ–‡ä»¶å’Œåˆ é™¤æ–‡ä»¶å¤¹æ˜¯åŒä¸€ä¸ªå‡½æ•°&lt;/p>
&lt;ul>
&lt;li>&lt;code>func Remove(name string) Error&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>è°ƒç”¨è¯¥å‡½æ•°å°±å¯ä»¥åˆ é™¤æ–‡ä»¶åä¸ºnameçš„æ–‡ä»¶&lt;/p>
&lt;h3 id="è®¡ç®—æ–‡ä»¶å“ˆå¸Œå€¼">è®¡ç®—æ–‡ä»¶å“ˆå¸Œå€¼&lt;/h3>
&lt;p>åœ¨ç½‘ç»œä¸Šä¼ è¾“æ–‡ä»¶å®Œæˆåï¼Œå¾€å¾€éƒ½ä¼šæœ‰ä¸€æ­¥æ–‡ä»¶çš„æ ¡éªŒã€‚éœ€è¦ç¡®è®¤ä¼ è¿‡æ¥çš„æ–‡ä»¶æ˜¯å¦æ˜¯æŸåçš„ã€‚&lt;/p>
&lt;h4 id="å°æ–‡ä»¶">å°æ–‡ä»¶&lt;/h4>
&lt;p>ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;crypto/md5&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;io&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;os&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">testFile&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="s">&amp;#34;/path/to/file&amp;#34;&lt;/span>
&lt;span class="nx">file&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">testFile&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// ä»¥ä¸Šæ˜¯ä¸ºäº†è·çš„ os.File å¯¹è±¡
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="nx">md5h&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">md5&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">io&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Copy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">md5h&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">file&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;%x&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">md5h&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sum&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="nb">byte&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">)))&lt;/span> &lt;span class="c1">// æ‰“å°å‡ºæ¥çš„æ˜¯ MD5 ç®—æ³•ä¸‹çš„å“ˆå¸Œç»“æœ
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="å¤§æ–‡ä»¶">å¤§æ–‡ä»¶&lt;/h4>
&lt;p>ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="s">&amp;#34;crypto/md5&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;io&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;math&amp;#34;&lt;/span>
&lt;span class="s">&amp;#34;os&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">const&lt;/span> &lt;span class="nx">filechunk&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">8192&lt;/span> &lt;span class="c1">// å‡å®š 8KB ä»¥ä¸Šä¸ºå¤§æ–‡ä»¶
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">file&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">os&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;utf8.txt&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Error&lt;/span>&lt;span class="p">())&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">defer&lt;/span> &lt;span class="nx">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Close&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="c1">// è®¡ç®—å¤§å°
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">info&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">_&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Stat&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">filesize&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">info&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Size&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">blocks&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">uint64&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">math&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Ceil&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">float64&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">filesize&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="nb">float64&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">filechunk&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;span class="nx">hash&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">md5&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">uint64&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nx">blocks&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">blocksize&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">math&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Min&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">filechunk&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">float64&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">filesize&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="nb">int64&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="nx">filechunk&lt;/span>&lt;span class="p">))))&lt;/span>
&lt;span class="nx">buf&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="kt">byte&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">blocksize&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Read&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="nx">io&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">WriteString&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">hash&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">string&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">buf&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="c1">// append into the hash
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;%s checksum is %x\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Name&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="nx">hash&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Sum&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">nil&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä»£ç å†…å®¹æ˜¯æ‰“å¼€æœ¬åœ°æ–‡ä»¶åˆ†å—è¯»å–è¿›è¡Œå“ˆå¸Œè®¡ç®—ï¼Œåœ¨ç½‘ç»œä¼ è¾“ä¸­ï¼Œå¯ä»¥æ¯æ¬¡ä¼ å…¥ä¸€åŒ…çš„æ–‡ä»¶ï¼Œå…ˆç”¨ io.WriteString() æ–¹æ³•æ·»åŠ åˆ°å“ˆå¸Œå¹¶åœ¨æœ€åè¿›è¡Œ hash.Sum() æ“ä½œ&lt;/p></content><category scheme="https://yusank.github.io/categories/%E6%8A%80%E6%9C%AF/" term="æŠ€æœ¯" label="æŠ€æœ¯"/><category scheme="https://yusank.github.io/tags/go/" term="go" label="go"/></entry><entry><title type="text">Unix ç½‘ç»œç¼–ç¨‹</title><link rel="alternate" type="text/html" href="https://yusank.github.io/posts/unix-network/"/><id>https://yusank.github.io/posts/unix-network/</id><updated>2021-09-18T06:24:55+00:00</updated><published>2017-04-22T16:52:00+08:00</published><author><name>yusank</name><uri>https://yusank.github.io/</uri><email>yusankurban@gmail.com</email></author><summary type="html">Unix ç½‘ç»œç¼–ç¨‹ â€‹ å·II - è¿›ç¨‹é—´é€šä¿¡ IPCæ˜¯è¿›ç¨‹é—´é€šä¿¡ï¼ˆinterprocess comâ€¦â€¦</summary><content type="html">&lt;h1 id="unix-ç½‘ç»œç¼–ç¨‹">Unix ç½‘ç»œç¼–ç¨‹&lt;/h1>
&lt;p>â€‹ &lt;strong>å·II - è¿›ç¨‹é—´é€šä¿¡&lt;/strong>&lt;/p>
&lt;p>IPCæ˜¯è¿›ç¨‹é—´é€šä¿¡ï¼ˆinterprocess communicationï¼‰çš„ç®€ç§°ã€‚ä¼ ç»Ÿä¸Šè¯¥æœ¯è¯­æè¿°çš„æ˜¯è¿è¡Œåœ¨æŸä¸ªæ“ä½œç³»ç»Ÿä¹‹ä¸Šçš„ä¸åŒè¿›ç¨‹é—´å„ç§æ¶ˆæ¯ä¼ é€’ï¼ˆ&lt;em>message passing&lt;/em>ï¼‰çš„æ–¹å¼ã€‚&lt;/p>
&lt;p>è¿›ç¨‹é—´çš„é€šä¿¡ä¸€èˆ¬æ˜¯ä¸€ä¸‹å››ç§å½¢å¼ï¼š&lt;/p>
&lt;ul>
&lt;li>æ¶ˆæ¯ä¼ é€’ï¼ˆç®¡é“ã€FIFOå’Œæ¶ˆæ¯é˜Ÿåˆ—ï¼‰ï¼›&lt;/li>
&lt;li>åŒæ­¥ï¼ˆäº’æ–¥é‡ã€æ¡ä»¶å˜é‡ã€è¯»å†™é”ã€æ–‡ä»¶å’Œè®°å½•é”ã€ä¿¡å·é‡ï¼‰ï¼›&lt;/li>
&lt;li>å…±äº«å†…å­˜ï¼ˆåŒ¿åçš„å’Œå…·åçš„ï¼‰ï¼›&lt;/li>
&lt;li>è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼ˆSolaris é—¨å’Œ Sun RPCï¼‰ã€‚&lt;/li>
&lt;/ul>
&lt;h1 id="æ¶ˆæ¯é˜Ÿåˆ—">æ¶ˆæ¯é˜Ÿåˆ—&lt;/h1>
&lt;p>&lt;strong>æ¶ˆæ¯ä¼ é€’ï¼š&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>ç®¡é“å’ŒFIFOï¼›&lt;/li>
&lt;li>Posix æ¶ˆæ¯é˜Ÿåˆ—ï¼›&lt;/li>
&lt;li>System Væ¶ˆæ¯é˜Ÿåˆ—ã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="ç®¡é“å’Œfifo">ç®¡é“å’ŒFIFO&lt;/h2>
&lt;p>ç®¡é“æ˜¯æœ€åˆçš„Unix IPC å½¢å¼ã€‚ç”±äºç®¡é“æ²¡æœ‰åå­—ï¼Œæ‰€ä»¥å®ƒåªèƒ½ç”¨äºæœ‰äº²ç¼˜å…³ç³»çš„è¿›ç¨‹é—´çš„é€šä¿¡ã€‚&lt;/p>
&lt;p>&lt;strong>å®ç°æœºåˆ¶ï¼š&lt;/strong>&lt;/p>
&lt;p>ç®¡é“æ˜¯ç”±å†…æ ¸ç®¡ç†çš„ä¸€ä¸ªç¼“å†²åŒºï¼Œç›¸å½“äºæˆ‘ä»¬æ”¾å…¥å†…å­˜ä¸­çš„ä¸€ä¸ªçº¸æ¡ã€‚ç®¡é“çš„ä¸€ç«¯è¿æ¥ä¸€ä¸ªè¿›ç¨‹çš„è¾“å‡ºã€‚è¿™ä¸ªè¿›ç¨‹ä¼šå‘ç®¡é“ä¸­æ”¾å…¥ä¿¡æ¯ã€‚ç®¡é“çš„å¦ä¸€ç«¯è¿æ¥ä¸€ä¸ªè¿›ç¨‹çš„è¾“å…¥ï¼Œè¿™ä¸ªè¿›ç¨‹å–å‡ºè¢«æ”¾å…¥ç®¡é“çš„ä¿¡æ¯ã€‚ä¸€ä¸ªç¼“å†²åŒºä¸éœ€è¦å¾ˆå¤§ï¼Œå®ƒ&lt;strong>è¢«è®¾è®¡æˆä¸ºç¯å½¢çš„æ•°æ®ç»“æ„&lt;/strong>ï¼Œä»¥ä¾¿ç®¡é“å¯ä»¥è¢«å¾ªç¯åˆ©ç”¨ã€‚å½“ç®¡é“ä¸­æ²¡æœ‰ä¿¡æ¯çš„è¯ï¼Œä»ç®¡é“ä¸­è¯»å–çš„è¿›ç¨‹ä¼šç­‰å¾…ï¼Œç›´åˆ°å¦ä¸€ç«¯çš„è¿›ç¨‹æ”¾å…¥ä¿¡æ¯ã€‚å½“ç®¡é“è¢«æ”¾æ»¡ä¿¡æ¯çš„æ—¶å€™ï¼Œå°è¯•æ”¾å…¥ä¿¡æ¯çš„è¿›ç¨‹ä¼šç­‰å¾…ï¼Œç›´åˆ°å¦ä¸€ç«¯çš„è¿›ç¨‹å–å‡ºä¿¡æ¯ã€‚å½“ä¸¤ä¸ªè¿›ç¨‹éƒ½ç»ˆç»“çš„æ—¶å€™ï¼Œç®¡é“ä¹Ÿè‡ªåŠ¨æ¶ˆå¤±ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;unistd.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">pipe&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">fd&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">])&lt;/span> &lt;span class="c1">//è¿”å›ï¼šè‹¥æˆåŠŸè¿”å›0ï¼Œè‹¥å‡ºé”™è¿”å›-1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¯¥å‡½æ•°è¿”å›ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼šfd[0] å’Œ fd[1]ã€‚å‰è€…æ‰“å¼€æ¥è¯»ï¼Œåè€…æ‰“å¼€æ¥å†™ã€‚&lt;/p>
&lt;p>ç®¡é“å°½ç®¡æ˜¯å•ä¸ªè¿›ç¨‹åˆ›å»ºï¼Œä½†æ˜¯ç®¡é“çš„å…¸å‹ç”¨é€”æ˜¯ä¸ºä¸¤ä¸ªä¸åŒçš„è¿›ç¨‹ï¼ˆä¸€ä¸ªçˆ¶è¿›ç¨‹ï¼Œä¸€ä¸ªå­è¿›ç¨‹ï¼‰æä¾›è¿›ç¨‹é—´çš„é€šä¿¡æ‰‹æ®µã€‚&lt;/p>
&lt;p>&lt;img src="http://oid1xlj7h.bkt.clouddn.com/Screen%20Shot%202017-02-22%20at%2011.49.01%20AM.png" alt="Screen Shot 2017-02-22 at 11.49.01 AM">&lt;/p>
&lt;p>â€‹ æ•°æ®æµ &amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&lt;/p>
&lt;p>é¦–å…ˆæ˜¯ï¼Œç”±ä¸€ä¸ªè¿›ç¨‹ï¼ˆå®ƒå°†æˆä¸ºçˆ¶è¿›ç¨‹ï¼‰åˆ›å»ºä¸€ä¸ª pipe åè°ƒç”¨ fork æ´¾ç”Ÿä¸€ä¸ªè‡ªèº«çš„å‰¯æœ¬ï¼Œæ¥ç€å…³é—­ç€ä¸ª pipe çš„è¯»æˆç«¯ï¼Œå­è¿›ç¨‹å…³é—­åŒä¸€ä¸ª pipe çš„å†™å…¥ç«¯ã€‚è¿™å°±æ˜¯è¿›ç¨‹é—´æä¾›äº†ä¸€ä¸ªå•å‘æ•°æ®æµï¼Œå¦‚ä¸‹å›¾ã€‚&lt;/p>
&lt;p>&lt;img src="http://oid1xlj7h.bkt.clouddn.com/Screen%20Shot%202017-02-22%20at%2011.56.11%20AM.png" alt="Screen Shot 2017-02-22 at 11.56.11 AM">&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="kt">int&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">n&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">fd&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">];&lt;/span>
&lt;span class="n">pid_t&lt;/span> &lt;span class="n">pid&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="kt">char&lt;/span> &lt;span class="n">line&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">MAXLINE&lt;/span>&lt;span class="p">];&lt;/span>
&lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pipe&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fd&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">===&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">){&lt;/span> &lt;span class="c1">// å…ˆå»ºç«‹ç®¡é“å¾—åˆ°ä¸€å¯¹æ–‡ä»¶æè¿°ç¬¦
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="n">pid&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">fork&lt;/span>&lt;span class="p">())&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// çˆ¶è¿›ç¨‹æŠŠæ–‡ä»¶æè¿°ç¬¦å¤åˆ¶ç»™å­è¿›ç¨‹
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pid&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">){&lt;/span> &lt;span class="c1">// çˆ¶è¿›ç¨‹å†™
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">close&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fd&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]);&lt;/span> &lt;span class="c1">// å…³é—­è¯»æè¿°ç¬¦
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fd&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="s">&amp;#34;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">hello world&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">14&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">else&lt;/span>&lt;span class="p">{&lt;/span> &lt;span class="c1">// å­è¿›ç¨‹è¯»
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">close&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fd&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]);&lt;/span> &lt;span class="c1">// å…³é—­å†™ç«¯
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">n&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">read&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fd&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="n">line&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">MAXLINE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">STDOUT_FILENO&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">line&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">n&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="n">exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;em>technicallyï¼Œè‡ªä»å¯ä»¥åœ¨è¿›ç¨‹é—´ä¼ é€’æè¿°ç¬¦åï¼Œç®¡é“ä¹Ÿèƒ½ç”¨äºæ— äº²ç¼˜å…³ç³»çš„è¿›ç¨‹é—´ï¼Œè€Œç°å®ä¸­ç®¡é“é€šå¸¸ç”¨äºå…·æœ‰å…±åŒç¥–å…ˆçš„è¿›ç¨‹é—´ã€‚&lt;/em>&lt;/p>
&lt;p>&lt;strong>FIFOï¼šå‘½åç®¡é“(named PIPE)&lt;/strong>&lt;/p>
&lt;p>ç®¡é“å°½ç®¡å¯¹å¾ˆå¤šæ“ä½œæ¥è¯´æ˜¯å¾ˆæœ‰ç”¨çš„ï¼Œä½†æ˜¯å®ƒçš„æ ¹æœ¬å±€é™æ€§åœ¨äºæ²¡æœ‰åå­—ï¼Œä»è€Œåªèƒ½ç”±äº²ç¼˜å…³ç³»çš„è¿›ç¨‹ï¼ˆçˆ¶å­è¿›ç¨‹ï¼‰ä½¿ç”¨ã€‚ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜ï¼ŒLinuxæä¾›äº†FIFOæ–¹å¼è¿æ¥è¿›ç¨‹ã€‚æœ‰äº†FIFOä¹‹åè¿™ä¸€ç¼ºç‚¹å¾—ä»¥æ”¹æ­£ã€‚FIFOæœ‰æ—¶ä¹Ÿç§°ä¹‹ä¸ºæœ‰åç®¡é“ï¼ˆnamed pipeï¼‰ã€‚FIFOé™¤äº†æœ‰ç®¡é“çš„åŠŸèƒ½å¤–ï¼Œå®ƒè¿˜å…è®¸æ— äº²ç¼˜å…³ç³»çš„è¿›ç¨‹çš„é€šä¿¡ã€‚pipe å’Œ FIFO éƒ½æ˜¯ä½¿ç”¨é€šå¸¸çš„ read å’Œ write å‡½æ•°è®¿é—®çš„ã€‚&lt;/p>
&lt;p>FIFO (First in, First out)ä¸ºä¸€ç§ç‰¹æ®Šçš„æ–‡ä»¶ç±»å‹ï¼Œå®ƒåœ¨æ–‡ä»¶ç³»ç»Ÿä¸­æœ‰å¯¹åº”çš„è·¯å¾„ã€‚å½“ä¸€ä¸ªè¿›ç¨‹ä»¥è¯»(r)çš„æ–¹å¼æ‰“å¼€è¯¥æ–‡ä»¶ï¼Œè€Œå¦ä¸€ä¸ªè¿›ç¨‹ä»¥å†™(w)çš„æ–¹å¼æ‰“å¼€è¯¥æ–‡ä»¶ï¼Œé‚£ä¹ˆå†…æ ¸å°±ä¼šåœ¨è¿™ä¸¤ä¸ªè¿›ç¨‹ä¹‹é—´å»ºç«‹ç®¡é“ï¼Œæ‰€ä»¥FIFOå®é™…ä¸Šä¹Ÿç”±å†…æ ¸ç®¡ç†ï¼Œä¸ä¸ç¡¬ç›˜æ‰“äº¤é“ã€‚ä¹‹æ‰€ä»¥å«FIFOï¼Œæ˜¯å› ä¸ºç®¡é“æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—æ•°æ®ç»“æ„ï¼Œæœ€æ—©æ”¾å…¥çš„æ•°æ®è¢«æœ€å…ˆè¯»å‡ºæ¥ï¼Œä»è€Œä¿è¯ä¿¡æ¯äº¤æµçš„é¡ºåºã€‚FIFOåªæ˜¯å€Ÿç”¨äº†æ–‡ä»¶ç³»ç»Ÿ(file system,å‘½åç®¡é“æ˜¯ä¸€ç§ç‰¹æ®Šç±»å‹çš„æ–‡ä»¶ï¼Œå› ä¸ºLinuxä¸­æ‰€æœ‰äº‹ç‰©éƒ½æ˜¯æ–‡ä»¶ï¼Œå®ƒåœ¨æ–‡ä»¶ç³»ç»Ÿä¸­ä»¥æ–‡ä»¶åçš„å½¢å¼å­˜åœ¨ã€‚)æ¥ä¸ºç®¡é“å‘½åã€‚å†™æ¨¡å¼çš„è¿›ç¨‹å‘FIFOæ–‡ä»¶ä¸­å†™å…¥ï¼Œè€Œè¯»æ¨¡å¼çš„è¿›ç¨‹ä»FIFOæ–‡ä»¶ä¸­è¯»å‡ºã€‚å½“åˆ é™¤FIFOæ–‡ä»¶æ—¶ï¼Œç®¡é“è¿æ¥ä¹Ÿéšä¹‹æ¶ˆå¤±ã€‚&lt;strong>FIFOçš„å¥½å¤„åœ¨äºæˆ‘ä»¬å¯ä»¥é€šè¿‡æ–‡ä»¶çš„è·¯å¾„æ¥è¯†åˆ«ç®¡é“ï¼Œä»è€Œè®©æ²¡æœ‰äº²ç¼˜å…³ç³»çš„è¿›ç¨‹ä¹‹é—´å»ºç«‹è¿æ¥&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;sys/types.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;sys/stat.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="nf">mkfifo&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">pathname&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">mode_t&lt;/span> &lt;span class="n">mode&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// è¿”å›ï¼š æˆåŠŸè¿”å›0ï¼Œå‡ºé”™è¿”å› -1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å…¶ä¸­ &lt;em>pathname&lt;/em> æ˜¯ä¸€ä¸ªæ™®é€šçš„ Unix è·¯å¾„åï¼Œå®ƒæ˜¯è¯¥ FIFO çš„åå­—ã€‚&lt;/p>
&lt;p>mkfifo å‡½æ•°ä¸­å‚æ•° &lt;em>mode&lt;/em> æŒ‡å®š FIFO çš„è¯»å†™æƒé™ã€‚&lt;/p>
&lt;p>mkfifo å‡½æ•°æ˜¯è¦ä¹ˆåˆ›å»ºä¸€ä¸ªæ–°çš„ FIFO ï¼Œè¦ä¹ˆè¿”å›ä¸€ä¸ª EEXIST é”™è¯¯ï¼ˆå¦‚æœè¯¥ FIFO å·²å­˜åœ¨ï¼‰ï¼Œå¦‚æœä¸å¸Œæœ›åˆ›å»ºä¸€ä¸ªæ–°çš„ FIFO é‚£å°±ç”¨ open å‡½æ•°å°±å¯ä»¥ã€‚&lt;/p>
&lt;p>FIFO ä¸èƒ½æ‰“å¼€æ—¢å†™åˆè¯»ã€‚&lt;/p>
&lt;p>å¦‚æœä¸€ä¸ª FIFO åªè¯»ä¸å†™ï¼Œåªå†™ä¸è¯»éƒ½ä¼šå½¢æˆé˜»å¡ã€‚&lt;/p>
&lt;p>ä¸‹è¾¹æ˜¯ä¸€ä¸ªç®€å•åœ°ä¾‹å­ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;stdio.h&amp;gt; &lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;stdlib.h&amp;gt; &lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;sys/types.h&amp;gt; &lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;sys/stat.h&amp;gt; &lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="cp"># define FIFO1 &amp;#34;/tmp/my_fifo&amp;#34;
&lt;/span>&lt;span class="cp">&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">res&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">mkfifo&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/tmp/my_fifo&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mo">0777&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">res&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="n">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;FIFO created/n&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// æ‰“å¼€FIFO
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//writefd = Open(FIFO1, O_WRONLY | O_NONBLOCK, 0)
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//readfd = Open(FIFO1, O_RDONLY, 0)
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">EXIT_SUCCESS&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;em>open&lt;/em> ç¬¬äºŒä¸ªå‚æ•°ä¸­çš„é€‰é¡¹O_NONBLOCKï¼Œé€‰é¡¹O_NONBLOCKè¡¨ç¤ºéé˜»å¡ï¼ŒåŠ ä¸Šè¿™ä¸ªé€‰é¡¹åï¼Œè¡¨ç¤ºopenè°ƒç”¨æ˜¯éé˜»å¡çš„ï¼Œå¦‚æœæ²¡æœ‰è¿™ä¸ªé€‰é¡¹ï¼Œåˆ™è¡¨ç¤ºopenè°ƒç”¨æ˜¯é˜»å¡çš„ã€‚&lt;/p>
&lt;ul>
&lt;li>å¯¹äºä»¥åªè¯»æ–¹å¼ï¼ˆO_RDONLYï¼‰æ‰“å¼€çš„FIFOæ–‡ä»¶ï¼Œå¦‚æœopenè°ƒç”¨æ˜¯é˜»å¡çš„ï¼ˆå³ç¬¬äºŒä¸ªå‚æ•°ä¸ºO_RDONLYï¼‰ï¼Œé™¤éæœ‰ä¸€ä¸ªè¿›ç¨‹ä»¥å†™æ–¹å¼æ‰“å¼€åŒä¸€ä¸ªFIFOï¼Œå¦åˆ™å®ƒä¸ä¼šè¿”å›ï¼›å¦‚æœopenè°ƒç”¨æ˜¯éé˜»å¡çš„çš„ï¼ˆå³ç¬¬äºŒä¸ªå‚æ•°ä¸ºO_RDONLY|O_NONBLOCKï¼‰ï¼Œåˆ™å³ä½¿æ²¡æœ‰å…¶ä»–è¿›ç¨‹ä»¥å†™æ–¹å¼æ‰“å¼€åŒä¸€ä¸ªFIFOæ–‡ä»¶ï¼Œopenè°ƒç”¨å°†æˆåŠŸå¹¶ç«‹å³è¿”å›ã€‚&lt;/li>
&lt;li>å¯¹äºä»¥åªå†™æ–¹å¼ï¼ˆO_WRONLYï¼‰æ‰“å¼€çš„FIFOæ–‡ä»¶ï¼Œå¦‚æœopenè°ƒç”¨æ˜¯é˜»å¡çš„ï¼ˆå³ç¬¬äºŒä¸ªå‚æ•°ä¸ºO_WRONLYï¼‰ï¼Œopenè°ƒç”¨å°†è¢«é˜»å¡ï¼Œç›´åˆ°æœ‰ä¸€ä¸ªè¿›ç¨‹ä»¥åªè¯»æ–¹å¼æ‰“å¼€åŒä¸€ä¸ªFIFOæ–‡ä»¶ä¸ºæ­¢ï¼›å¦‚æœopenè°ƒç”¨æ˜¯éé˜»å¡çš„ï¼ˆå³ç¬¬äºŒä¸ªå‚æ•°ä¸ºO_WRONLY|O_NONBLOCKï¼‰ï¼Œopenæ€»ä¼šç«‹å³è¿”å›ï¼Œä½†å¦‚æœæ²¡æœ‰å…¶ä»–è¿›ç¨‹ä»¥åªè¯»æ–¹å¼æ‰“å¼€åŒä¸€ä¸ªFIFOæ–‡ä»¶ï¼Œopenè°ƒç”¨å°†è¿”å›-1ï¼Œå¹¶ä¸”FIFOä¹Ÿä¸ä¼šè¢«æ‰“å¼€ã€‚&lt;/li>
&lt;/ul>
&lt;p>å…³äºç®¡é“æˆ– FIFO çš„è¯»å†™çš„è‹¥å¹²è§„åˆ™ï¼š&lt;/p>
&lt;ul>
&lt;li>å¦‚æœè¯·æ±‚è¯»å‡ºçš„æ•°æ®é‡å¤šäºç®¡é“æˆ– FIFO ä¸­å½“å‰çš„å¯ç”¨æ•°æ®é‡ï¼Œé‚£ä¹ˆåªä¼šè¿”å›è¿™äº›å¯ç”¨çš„æ•°æ®ã€‚&lt;/li>
&lt;li>å¦‚æœè¯·æ±‚ä½ å†™å…¥çš„æ•°æ®çš„å­—èŠ‚æ•°å°äºæˆ–ç­‰äº PIPE_BUF (å¯åŸå­åœ°å†™å…¥å¾€ä¸€ä¸ªç®¡é“æˆ– FIFO çš„æœ€å¤§æ•°æ®é‡ï¼Œ Posix è¦æ±‚è‡³å°‘ä¸º512)ï¼Œé‚£ä¹ˆ write æ“ä½œä¿è¯æ˜¯åŸå­çš„ã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœä¸¤ä¸ªè¿›ç¨‹å·®ä¸å¤šåŒæ—¶å¾€åŒä¸€ä¸ªç®¡é“æˆ– FIFO å†™ï¼Œé‚£ä¹ˆä¸ç®¡æ˜¯å…ˆå†™å…¥æ¥è‡ªç¬¬ä¸€ä¸ªè¿›ç¨‹çš„æ‰€æœ‰æ•°æ®å†å†™ç¬¬äºŒä¸ªï¼Œè¿˜æ˜¯é¡ºåºé¢ å€’è¿‡æ¥ã€‚ç³»ç»Ÿéƒ½ä¸ä¼šç›¸äº’æ··æ‚æ¥è‡ªä¸¤ä¸ªè¿›ç¨‹çš„æ•°æ®ã€‚ç„¶è€Œå¦‚æœæ•°æ®çš„å­—èŠ‚æ•°å¤§äº PIPE_BUF ï¼Œé‚£ä¹ˆ write æ“ä½œä¸èƒ½ä¿è¯æ˜¯åŸå­çš„ã€‚&lt;/li>
&lt;li>ä¸æ­¢ä»¥ä¸Šè¿™äº›ã€‚ã€‚ã€‚&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>å°ç»“&lt;/strong>ï¼š FIFO ä¸ç®¡é“ç±»ä¼¼ï¼Œä½†æ˜¯å®ƒç”¨ mkfifo åˆ›å»ºï¼Œä¹‹åéœ€è¦open æ‰“å¼€ã€‚æ‰“å¼€ç®¡é“å¿…é¡»å°å¿ƒï¼Œå› ä¸ºè®¸å¤šè§„åˆ™ï¼ˆread åªå†™ç®¡é“ã€write åªè¯»ç®¡é“ã€ä»ç©ºçš„ç®¡é“æˆ–FIFO read ç­‰çš„æƒ…å†µçš„è¿”å›ç»“æœã€‚ï¼‰åˆ¶çº¦ç€ open çš„é˜»å¡ä¸å¦ã€‚&lt;/p>
&lt;h2 id="posix-ipc">Posix IPC&lt;/h2>
&lt;p>Posix--å¯ç§»æ¤æ€§æ“ä½œç³»ç»Ÿæ¥å£ï¼ˆProtable operating system interfaceï¼‰&lt;/p>
&lt;p>æœ‰å…³Unixæ ‡å‡†åŒ–çš„å¤§å¤šæ•°æ´»åŠ¨æ˜¯ç”± Posix å’Œ Open Group åšçš„ã€‚&lt;/p>
&lt;p>Posix ä¸æ˜¯å•ä¸€çš„æ ‡å‡†ï¼Œæ˜¯ä¸€ç³»åˆ—çš„æ ‡å‡†ã€‚&lt;/p>
&lt;p>ä»¥ä¸‹ä¸‰ç§ç±»å‹çš„IPCåˆæˆä¸ºâ€œPosix IPCâ€&lt;/p>
&lt;ul>
&lt;li>Posix æ¶ˆæ¯é˜Ÿåˆ—&lt;/li>
&lt;li>Posix ä¿¡å·é‡&lt;/li>
&lt;li>Posix å…±äº«å†…å­˜åŒº&lt;/li>
&lt;/ul>
&lt;h2 id="posix-æ¶ˆæ¯é˜Ÿåˆ—">Posix æ¶ˆæ¯é˜Ÿåˆ—&lt;/h2>
&lt;p>æ¶ˆæ¯é˜Ÿåˆ—å¯è®¤ä¸ºæ˜¯ä¸ªæ¶ˆæ¯é“¾è¡¨ã€‚æœ‰è¶³å¤Ÿå†™æƒé™çš„è¿›ç¨‹å¯å¾€é˜Ÿåˆ—æ”¾ç½®ä¿¡æ¯ï¼Œæœ‰è¶³å¤Ÿè¯»æƒé™çš„è¿›ç¨‹å¯ä»é˜Ÿåˆ—è¯»å–ä¿¡æ¯ã€‚æ¯ä¸€ä¸ªä¿¡æ¯éƒ½æ˜¯ä¸€æ¡è®°å½•ï¼Œå®ƒæ˜¯ç”±å‘é€è€…èµ‹äºˆä¸€ä¸ªä¼˜å…ˆçº§ã€‚åœ¨æŸä¸ªè¿›ç¨‹å¾€ä¸€ä¸ªé˜Ÿåˆ—å†™å…¥æ¶ˆæ¯ä¹‹å‰ï¼Œå¹¶ä¸éœ€è¦å¦ä¸€ä¸ªè¿›ç¨‹åœ¨è¯¥é˜Ÿåˆ—ä¸Šç­‰å¾…æ¶ˆæ¯çš„åˆ°è¾¾ã€‚è¿™æ ¹ç®¡é“å’Œ FIFO æ˜¯ç›¸åçš„ã€‚&lt;/p>
&lt;p>ä¸€ä¸ªè¿›ç¨‹å¯ä»¥å¾€æŸäº›é˜Ÿåˆ—å†™å…¥ä¸€äº›ä¿¡æ¯ï¼Œç„¶åç»ˆæ­¢ï¼Œå†è®©å¦å¤–ä¸€ä¸ªè¿›ç¨‹åœ¨ä»¥åçš„æŸä¸ªæ—¶åˆ»è¯»å–è¿™äº›ä¿¡æ¯ã€‚&lt;/p>
&lt;p>Posix æ¶ˆæ¯é˜Ÿåˆ—å’Œä¸‹é¢è®²çš„System V æ¶ˆæ¯é˜Ÿåˆ—æœ‰è®¸å¤šçš„ç›¸ä¼¼æ€§ã€‚ä»¥ä¸‹æ˜¯ä¸»è¦çš„å·®åˆ«ï¼š&lt;/p>
&lt;ul>
&lt;li>å¯¹ Posix æ¶ˆæ¯é˜Ÿåˆ—çš„è¯»æ€»æ˜¯è¿”å›æœ€é«˜ä¼˜å…ˆçº§çš„æœ€æ—©æ¶ˆæ¯ï¼Œå¯¹ System V æ¶ˆæ¯é˜Ÿåˆ—çš„è¯»åˆ™å¯ä»¥è¿”å›ä»»æ„æŒ‡å®šä¼˜å…ˆçº§çš„æ¶ˆæ¯ï¼›&lt;/li>
&lt;li>å½“å¾€ä¸€ä¸ªç©ºé˜Ÿåˆ—æ”¾ç½®ä¸€ä¸ªä¿¡æ¯æ—¶ï¼ŒPosix æ¶ˆæ¯é˜Ÿåˆ—å…è®¸äº§ç”Ÿä¸€ä¸ªä¿¡å·æˆ–å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ï¼ŒSystem Væ¶ˆæ¯é˜Ÿåˆ—åˆ™æ˜¯ä¸æä¾›ç±»ä¼¼çš„æœºåˆ¶ã€‚&lt;/li>
&lt;/ul>
&lt;p>é˜Ÿåˆ—ä¸­çš„æ¯ä¸€ä¸ªæ¶ˆæ¯éƒ½æœ‰å¦‚ä¸‹å±æ€§ï¼š&lt;/p>
&lt;ul>
&lt;li>ä¸€ä¸ªæ— ç¬¦å·æ•´æ•°ä¼˜å…ˆçº§ï¼ˆPosixï¼‰æˆ– ä¸€ä¸ªé•¿æ•´æ•°ç±»å‹ï¼ˆsystem Vï¼‰ï¼›&lt;/li>
&lt;li>æ¶ˆæ¯çš„æ•°æ®éƒ¨åˆ†é•¿åº¦ï¼ˆå¯ä»¥ä¸º0ï¼‰ï¼›&lt;/li>
&lt;li>æ•°æ®æœ¬èº«ï¼ˆå¦‚æœé•¿åº¦å¤§äº0ï¼‰ã€‚&lt;/li>
&lt;/ul>
&lt;p>ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—çš„å¯èƒ½å¸ƒå±€ã€‚&lt;/p>
&lt;p>&lt;img src="http://oid1xlj7h.bkt.clouddn.com/unix%20%E7%BD%91%E7%BB%9C.png" alt="unix ç½‘ç»œ">&lt;/p>
&lt;p>æˆ‘ä»¬æ‰€è®¾æƒ³çš„æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œè¯¥é“¾è¡¨çš„æœ‰ä¸­å«æœ‰å½“å‰é˜Ÿåˆ—çš„ä¸¤ä¸ªå±æ€§ï¼šé˜Ÿåˆ—ä¸­å…è®¸çš„æœ€å¤§å¼€é”€æ•°ä»¥åŠæ¯ä¸€ä¸ªæ¶ˆæ¯çš„æœ€å¤§å¤§å°ã€‚&lt;/p>
&lt;p>**mq_open ,mq_close å’Œ mq_unlink å‡½æ•° **ï¼š&lt;/p>
&lt;p>mq_open å‡½æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„æ¶ˆæ¯é˜Ÿåˆ—æˆ–æ‰“å¼€ä¸€ä¸ªå·²å­˜åœ¨çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="cp"># include &amp;lt;mqueue.h&amp;gt;
&lt;/span>&lt;span class="cp">&lt;/span>&lt;span class="n">mqd_t&lt;/span> &lt;span class="nf">mq_open&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">oflag&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">...&lt;/span>
&lt;span class="cm">/* mode_t mode, struct mq_attr *attr */&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="c1">//è¿”å›ï¼š æˆåŠŸè¿”å›æ¶ˆæ¯å¯¹åˆ—æè¿°ç¬¦ï¼Œå‡ºé”™è¿”å›-1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å…¶ä¸­ &lt;em>name&lt;/em> æœ‰è‡ªå·±çš„ä¸€å¥—å‘½åè§„åˆ™ï¼Œå› ä¸º Posix IPC ä½¿ç”¨â€œPosix IPC åå­—â€è¿›è¡Œæ ‡è¯†ã€‚ä¸ºæ–¹ä¾¿äºç§»æ¤èµ·è§ï¼ŒPosix IPC åå­—å¿…é¡»ä»¥æ–œæ ç¬¦å¼€å¤´å¹¶ä¸”ä¸èƒ½å†åŒ…å«ä»»ä½•æ–œæ ç¬¦ã€‚&lt;/p>
&lt;p>&lt;em>oflag&lt;/em> æ˜¯O_RDONLYã€O_WRONLY æˆ– O_RDWR ä¹‹ä¸€ï¼Œ å¯èƒ½æŒ‰ä½æˆ–ä¸ŠO_CREATE(è‹¥ä¸å­˜åœ¨åˆ™åˆ›å»º)ã€O_EXCL(ä¸O_CREATEä¸€èµ·ï¼Œè‹¥å·²å­˜åœ¨è¿”å›EEXIST é”™è¯¯)æˆ– O_NONBLOCKï¼ˆéé˜»å¡æ ‡è¯†ç¬¦ï¼‰ã€‚&lt;/p>
&lt;p>å½“å®é™…æ“ä½œåˆ›å»ºä¸€ä¸ªæ–°çš„æ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼ˆæŒ‡å®šO_CREATEæ ‡å¿—ï¼Œä¸”è¯·æ±‚çš„é˜Ÿåˆ—ä¸å­˜åœ¨ï¼‰ï¼Œ&lt;em>mode&lt;/em> å’Œ &lt;em>attr&lt;/em> å‚æ•°æ˜¯éœ€è¦çš„ã€‚modeä¸Šé¢ä»‹ç»è¿‡ã€‚attrå‚æ•°ç”¨äºç»™æ–°é˜Ÿåˆ—æŒ‡å®šæŸäº›å±æ€§ã€‚&lt;/p>
&lt;p>mq_open è¿”å›å€¼ç§°ä¸º&lt;strong>æ¶ˆæ¯é˜Ÿåˆ—æè¿°ç¬¦ï¼ˆmessage queue descriptorï¼‰&lt;/strong>ï¼Œè¿™ä¸ªå€¼ç”¨ä½œå…¶ä»–æ¶ˆæ¯é˜Ÿåˆ—å‡½æ•°çš„ç¬¬ä¸€å‚æ•°ã€‚&lt;/p>
&lt;p>å·²æ‰“å¼€çš„æ¶ˆæ¯é˜Ÿåˆ—æ˜¯ç”± mq_close å…³é—­çš„ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;mqueue.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">mq_close&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">mqd_t&lt;/span> &lt;span class="n">mqdes&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">//è¿”å›ï¼š æˆåŠŸè¿”å›0ï¼Œå‡ºé”™è¿”å›-1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å…³é—­ä¹‹åè°ƒç”¨è¿›ç¨‹ä¸å†ä½¿ç”¨è¯¥æè¿°ç¬¦ï¼Œä½†å…¶æ¶ˆæ¯é˜Ÿåˆ—å¹¶ä¸ä»ç³»ç»Ÿä¸­åˆ é™¤ã€‚ä¸€ä¸ªè¿›ç¨‹ç»ˆæ­¢æ—¶ï¼Œå®ƒæ‰“å¼€ç€çš„æ¶ˆæ¯é˜Ÿåˆ—éƒ½å…³é—­ï¼Œå°±åƒè°ƒç”¨mq_close ä¸€æ ·ã€‚&lt;/p>
&lt;p>è¦ä»ç³»ç»Ÿä¸­åˆ é™¤æ¶ˆæ¯é˜Ÿåˆ—åˆ™ç”¨mq_unlink å‡½æ•°ï¼Œå…¶ç¬¬ä¸€å‚æ•°ä¸º mq_open çš„ç¬¬ä¸€å‚æ•° &lt;em>name&lt;/em>ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="cp"># include &amp;lt;mqueue.h&amp;gt;
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">mq_unlink&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">//è¿”å›ï¼š æˆåŠŸè¿”å›0ï¼Œå‡ºé”™è¿”å›-1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>mq_getattr å’Œ mq_setattr å‡½æ•°&lt;/strong>&lt;/p>
&lt;p>æ¶ˆæ¯é˜Ÿåˆ—æœ‰å››ä¸ªå±æ€§ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°æ˜¯è·å–å’Œä¿®æ”¹è¿™äº›å±æ€§ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="n">mq_flags&lt;/span> &lt;span class="c1">//é˜Ÿåˆ—é˜»å¡æ ‡å¿—ä½
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">mq_maxmsg&lt;/span> &lt;span class="c1">//é˜Ÿåˆ—æœ€å¤§å…è®¸æ¶ˆæ¯æ•°
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">mq_msgsize&lt;/span> &lt;span class="c1">//é˜Ÿåˆ—æ¶ˆæ¯æœ€å¤§å­—èŠ‚æ•°
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">mq_curmsgs&lt;/span> &lt;span class="c1">//é˜Ÿåˆ—å½“å‰æ¶ˆæ¯æ¡æ•°
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;mqueue.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="nf">mq_getattr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">mqd_t&lt;/span> &lt;span class="n">mqdes&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">mq_attr&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">attr&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="nf">mq_setattr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">mqd_t&lt;/span> &lt;span class="n">mqdes&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">mq_attr&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">attr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">mq_attr&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">oattr&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">//è¿”å›ï¼šå‡æˆåŠŸè¿”å›0ï¼Œå‡ºé”™è¿”å›-1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>mq_send å’Œ mq_receive å‡½æ•°&lt;/strong>&lt;/p>
&lt;p>â€‹ è¿™ä¸¤ä¸ªå‡½æ•°åˆ†åˆ«å¾€ä¸€ä¸ªé˜Ÿåˆ—æ”¾ç½®ä¸€ä¸ªä¿¡æ¯å’Œä»ä¸€ä¸ªé˜Ÿåˆ—å–èµ°ä¸€ä¸ªæ¶ˆæ¯ã€‚æ¯ä¸€ä¸ªæ¶ˆæ¯éƒ½æœ‰ä¼˜å…ˆçº§ï¼Œå®ƒæ˜¯ä¸€ä¸ªå°äºMQ_PRIO_MAX çš„æ— ç¬¦å·æ•´æ•°ã€‚Posixè¦æ±‚è¿™ä¸ªä¸Šé™è‡³å°‘ä¸º32.&lt;/p>
&lt;p>â€‹ mq_receive æ€»æ˜¯è¿”å›æ‰€æŒ‡å®šé˜Ÿåˆ—ä¸­ä¼˜å…ˆçº§æœ€é«˜çš„çš„æœ€æ—©æ¶ˆæ¯ï¼Œè€Œä¸”è¯¥ä¼˜å…ˆçº§èƒ½éšè¯¥æ¶ˆæ¯çš„å†…å®¹åŠå…¶é•¿åº¦ä¸€åŒè¿”å›ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;mqueue.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="nf">mq_send&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">mqd_t&lt;/span> &lt;span class="n">mqdes&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">ptr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">size_t&lt;/span> &lt;span class="n">len&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">unsigned&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">prio&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">//è¿”å›ï¼š æˆåŠŸè¿”å›0ï¼Œå‡ºé”™è¿”å›-1
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="n">ssize_t&lt;/span> &lt;span class="nf">mq_reccevie&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">mqd_t&lt;/span> &lt;span class="n">mqdes&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">ptr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">size_t&lt;/span> &lt;span class="n">len&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">unsigned&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">priop&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">//è¿”å›ï¼š æˆåŠŸè¿”å›æ¶ˆæ¯ä¸­çš„å­—èŠ‚æ•°ï¼Œå‡ºé”™è¿”å›-1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>mq_receive çš„ &lt;em>len&lt;/em> å‚æ•°çš„å€¼ä¸èƒ½å°äºèƒ½åŠ åˆ°æ‰€æŒ‡å®šé˜Ÿåˆ—ä¸­çš„æœ€å¤§å¤§å°ï¼ˆè¯¥é˜Ÿåˆ— mq_attr ç»“æ„çš„ mq_msgsize ï¼‰ã€‚è¦æ˜¯ &lt;em>len&lt;/em> å°äºè¯¥å€¼ï¼Œ mq_receiveç«‹å³è¿”å› EMSGSIZE é”™è¯¯ã€‚&lt;/p>
&lt;p>mq_send çš„ &lt;em>prio&lt;/em> å‚æ•°æ˜¯å¾…å‘ä¿¡æ¯çš„ä¼˜å…ˆçº§ï¼Œå…¶å€¼å¿…é¡»å°äº MQ_PRIO_MAX ã€‚å¦‚æœ mq_receive çš„ &lt;em>priop&lt;/em> å‚æ•°æ˜¯ä¸€ä¸ªéç©ºæŒ‡é’ˆï¼Œæ‰€è¿”å›æ¶ˆæ¯çš„ä¼˜å…ˆçº§å°±é€šè¿‡è¯¥æŒ‡é’ˆå­˜æ”¾ã€‚å¦‚æœåº”ç”¨ä¸å¿…ä½¿ç”¨ä¼˜å…ˆçº§ä¸åŒçš„æ¶ˆæ¯ï¼Œé‚£å°±ç»™mq_send æŒ‡é’ˆå€¼ä¸º0çš„ä¼˜å…ˆçº§ï¼Œç»™ mq_receive æŒ‡å®šä¸€ä¸ªç©ºæŒ‡é’ˆä½œä¸ºå…¶æœ€åä¸€ä¸ªå‚æ•°ã€‚&lt;/p>
&lt;p>å¾€æŸä¸ªé˜Ÿåˆ—ä¸­å¢åŠ ä¸€ä¸ªæ¶ˆæ¯&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;mqueue.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="kt">int&lt;/span>
&lt;span class="nf">main&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">argc&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">**&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="n">mqd_t&lt;/span> &lt;span class="n">mqd&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//æè¿°ç¬¦
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">ptr&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//æŒ‡å‘ç¼“å†²åŒºçš„æŒ‡é’ˆ
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">size_t&lt;/span> &lt;span class="n">len&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//é•¿åº¦
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">uint_t&lt;/span> &lt;span class="n">prio&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//ä¼˜å…ˆåº¦
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">argc&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">err_quit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;usage: mqsend &amp;lt;name&amp;gt; &amp;lt;#bytes&amp;gt; &amp;lt;priority&amp;gt;&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">len&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">atoi&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;span class="n">prio&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">atoi&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;span class="n">mqd&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Mq_open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="n">O_WRONLY&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// åˆ›å»ºä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—
&lt;/span>&lt;span class="c1">&lt;/span>
&lt;span class="n">ptr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Calloc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">len&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">sizeof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">char&lt;/span>&lt;span class="p">));&lt;/span>&lt;span class="c1">// æ‰€ç”¨çš„ç¼“å†²åŒºç”¨collocåˆ†é…ï¼Œè¯¥å‡½æ•°ä¼šæŠŠè¯¥ç¼“å†²åŒºåˆå§‹åŒ–ä¸º0
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">Mq_send&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">mqd&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ptr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">len&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">prio&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¾…å‘æ¶ˆæ¯çš„å¤§å°å’Œä¼˜å…ˆçº§å¿…é¡»ä½œä¸ºå‘½ä»¤è¡Œå‚æ•°æŒ‡å®šã€‚&lt;/p>
&lt;p>ä»æŸé˜Ÿåˆ—è¯»å‡ºä¸‹ä¸€ä¸ªä¿¡æ¯&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;#34;unpipc.h&amp;#34;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>
&lt;span class="kt">int&lt;/span>
&lt;span class="nf">main&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">argc&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">**&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="kt">int&lt;/span> &lt;span class="n">c&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">flags&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">mqd_t&lt;/span> &lt;span class="n">maq&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">ssize_t&lt;/span> &lt;span class="n">n&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">uint_t&lt;/span> &lt;span class="n">prio&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">buff&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">struct&lt;/span> &lt;span class="n">mq_attr&lt;/span> &lt;span class="n">attr&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="n">flags&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">O_RDONLY&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">c&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Getopt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">argc&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">argv&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;n&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">switch&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">c&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="sc">&amp;#39;n&amp;#39;&lt;/span>&lt;span class="o">:&lt;/span>
&lt;span class="n">flags&lt;/span> &lt;span class="o">|=&lt;/span> &lt;span class="n">O_NONBLOCK&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">optind&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="n">argc&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">err_quit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;usage: mqreceive [-n] &amp;lt;name&amp;gt;&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">mqd&lt;/span> &lt;span class="o">=&lt;/span>&lt;span class="n">Mq_open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">argv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">optind&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="n">flags&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">Mq_getattr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">mqd&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">attr&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">buff&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Malloc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">attr&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">mq_msgsize&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">n&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Mq_receive&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">mqd&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">buff&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">attr&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">mq_msgsize&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">prio&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;read %ld bytes, priority = %u&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">long&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">prio&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="n">exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å‘½ä»¤è¡Œé€‰é¡¹ -n æŒ‡å®šéé˜»å¡å±æ€§ï¼Œè¿™æ ·å¦‚æœæ‰€æŒ‡å®šçš„é˜Ÿåˆ—ä¸­æ²¡æœ‰æ¶ˆæ¯ï¼Œ åˆ™è¿”å›ä¸€ä¸ªé”™è¯¯ã€‚&lt;/p>
&lt;p>è°ƒç”¨ mq_getattr æ‰“å¼€é˜Ÿåˆ—å¹¶å–å¾—å±æ€§ã€‚éœ€è¦ç¡®å®šæœ€å¤§æ¶ˆæ¯å¤§å°ï¼Œå› ä¸ºå¿…é¡»ä¸ºè°ƒç”¨çš„ mq_receive åˆ†é…ä¸€ä¸ªè¿™æ ·å¤§å°çš„ç¼“å†²åŒºã€‚æœ€åè¾“å‡ºæ‰€è¯»å‡ºæ¶ˆæ¯çš„å¤§å°åŠå…¶å±æ€§ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">solaris %mqcreate /test1 åˆ›å»ºå¹¶è·å–å±æ€§
solaris %mqgetattr /test1
max
solaris % mqsend /test1 &lt;span class="m">100&lt;/span> 9999 ä»¥æ— æ•ˆçš„ä¼˜å…ˆçº§å‘é€
mq_send error: Invalid argument
solaris % mqsend /test1 &lt;span class="m">100&lt;/span> 6 100å­—èŠ‚ï¼Œä¼˜å…ˆçº§6
solaris % mqsend /test1 &lt;span class="m">50&lt;/span> &lt;span class="m">18&lt;/span> 50å­—èŠ‚ï¼Œä¼˜å…ˆçº§18
solaris % mqsend /test1 &lt;span class="m">33&lt;/span> &lt;span class="m">18&lt;/span> 33å­—èŠ‚ï¼Œä¼˜å…ˆçº§18
solaris % mqreceive /test1
&lt;span class="nb">read&lt;/span> &lt;span class="m">50&lt;/span> bytes, &lt;span class="nv">priority&lt;/span> &lt;span class="o">=&lt;/span> 18 è¿”å›ä¼˜å…ˆçº§æœ€é«˜çš„æœ€æ—©æ¶ˆæ¯
solaris % mqreceive /test1
&lt;span class="nb">read&lt;/span> &lt;span class="m">33&lt;/span> bytes, &lt;span class="nv">priority&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">18&lt;/span>
solaris % mqreceive /test1
&lt;span class="nb">read&lt;/span> &lt;span class="m">100&lt;/span> bytes, &lt;span class="nv">priority&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">6&lt;/span>
solaris % mqreceive /test1 æŒ‡å®šéé˜»å¡å±æ€§ï¼Œé˜Ÿåˆ—ä¸ºç©º
mq_recevie error: Resource temporarily unavalibale
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ¶ˆæ¯é˜Ÿåˆ—é™åˆ¶ï¼š&lt;/p>
&lt;ul>
&lt;li>mq_mqxmsg é˜Ÿåˆ—çš„æœ€å¤§æ¶ˆæ¯æ•°&lt;/li>
&lt;li>mq_msgsize ç»™å®šæ¶ˆæ¯çš„æœ€å¤§å­—èŠ‚æ•°&lt;/li>
&lt;li>MQ_OPEN_MAX ä¸€ä¸ªè¿›ç¨‹èƒ½å¤ŸåŒæ—¶æ‹¥æœ‰çš„æ‰“å¼€ç€æ¶ˆæ¯é˜Ÿåˆ—çš„ç»„å¤§æ•°ç›®ï¼ˆPosixè¦æ±‚è‡³å°‘ä¸º8ï¼‰&lt;/li>
&lt;li>MQ_PRIO_MAX ä»»æ„æ¶ˆæ¯çš„æœ€å¤§ä¼˜å…ˆçº§å€¼åŠ 1ï¼ˆPosixè¦æ±‚è‡³å°‘ä¸º32ï¼‰&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>mq_notify å‡½æ•°&lt;/strong>&lt;/p>
&lt;p>Posix æ¶ˆæ¯é˜Ÿåˆ—å…è®¸å¼‚æ­¥äº‹ä»¶é€šçŸ¥ï¼ˆ &lt;em>asynchronous event notifiction&lt;/em>ï¼‰ï¼Œä»¥å‘ŠçŸ¥ä½•æ—¶æœ‰ä¸€ä¸ªæ¶ˆæ¯æ”¾ç½®åˆ°äº†æŸä¸ªç©ºæ¶ˆæ¯é˜Ÿåˆ—ä¸­ã€‚&lt;/p>
&lt;h2 id="system-v-æ¶ˆæ¯é˜Ÿåˆ—">System V æ¶ˆæ¯é˜Ÿåˆ—&lt;/h2>
&lt;p>ä»¥ä¸‹ä¸‰ç§ç±»å‹çš„IPCç§°ä¸º System V IPCï¼š&lt;/p>
&lt;ul>
&lt;li>System V æ¶ˆæ¯é˜Ÿåˆ—ï¼›&lt;/li>
&lt;li>System V ä¿¡å·é‡ï¼›&lt;/li>
&lt;li>System V å…±äº«å†…å­˜åŒºã€‚&lt;/li>
&lt;/ul>
&lt;p>è¿™ä¸ªç§°ä¸ºä½œä¸ºè¿™ä¸‰ä¸ªIPCæœºåˆ¶çš„é€šç§°æ˜¯å› ä¸ºå®ƒä»¬æºè‡ª System V Unix ã€‚è¿™ä¸‰ç§IPCæœ€å…ˆå‡ºç°åœ¨AT&amp;amp;T System v UNIXä¸Šé¢ï¼Œå¹¶éµå¾ªXSIæ ‡å‡†ï¼Œæœ‰æ—¶å€™ä¹Ÿè¢«ç§°ä¸ºXSI IPCã€‚&lt;/p>
&lt;p>System V æ¶ˆæ¯é˜Ÿåˆ—ä½¿ç”¨&lt;em>æ¶ˆæ¯é˜Ÿåˆ—æ ‡è¯†ç¬¦ï¼ˆmessage queue identifierï¼‰&lt;/em> æ ‡è¯†ã€‚æœ‰è¶³å¤Ÿæƒé™çš„ä»»ä½•è¿›ç¨‹å¯å¾€é˜Ÿåˆ—æ”¾ç½®ä¿¡æ¯ï¼Œæœ‰è¶³å¤Ÿæƒé™çš„ä»»ä½•è¿›ç¨‹å¯ä»é˜Ÿåˆ—è¯»å–ä¿¡æ¯ã€‚è·Ÿ Posix ä¸€æ ·ï¼Œåœ¨æŸä¸ªè¿›ç¨‹å¾€ä¸€ä¸ªé˜Ÿåˆ—å†™å…¥æ¶ˆæ¯ä¹‹å‰ï¼Œä¸æ±‚å¦å¤–æŸä¸ªè¿›ç¨‹æ­£åœ¨ç­‰å¾…è¯¥é˜Ÿåˆ—ä¸Šä¸€ä¸ªæ¶ˆæ¯çš„åˆ°è¾¾ã€‚&lt;/p>
&lt;p>å¯¹äºç³»ç»Ÿçš„æ¯ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå†…æ ¸ç»´æŠ¤ä¸€ä¸ªå®šä¹‰åœ¨ &lt;code>&amp;lt;sys/msg.h&amp;gt;&lt;/code> å¤´æ–‡ä»¶ä¸­çš„ä¿¡æ¯ç»“æ„.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="k">struct&lt;/span> &lt;span class="n">msqid_ds&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">struct&lt;/span> &lt;span class="n">ipc_perm&lt;/span> &lt;span class="n">msg_perm&lt;/span> &lt;span class="c1">//operation permission structure
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">msg&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">msg_frist&lt;/span> &lt;span class="c1">//ptr to frist message on queue
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">msg&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">msg_last&lt;/span> &lt;span class="c1">//ptr to last message on queue
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">msglen_t&lt;/span> &lt;span class="n">msg_cbytes&lt;/span> &lt;span class="c1">//current #bytes on queue
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">msgqnum_t&lt;/span> &lt;span class="n">msg_qnum&lt;/span> &lt;span class="c1">//number of messages currently on queue
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">msglen_t&lt;/span> &lt;span class="n">msg_qbytes&lt;/span> &lt;span class="c1">//maximum number of bytes allowed on queue
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">pid_t&lt;/span> &lt;span class="n">msg_lspid&lt;/span> &lt;span class="c1">//process ID of last msgsnd()
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">pid_t&lt;/span> &lt;span class="n">msg_lrpid&lt;/span> &lt;span class="c1">//process ID of last msgrcv()
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">time_t&lt;/span> &lt;span class="n">msg_stime&lt;/span> &lt;span class="c1">//time of last msgsnd()
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">time_t&lt;/span> &lt;span class="n">msg_rtime&lt;/span> &lt;span class="c1">//time of last msgrcv()
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="n">time_t&lt;/span> &lt;span class="n">msg_ctime&lt;/span> &lt;span class="c1">//time of last change
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;em>Unix 98 ä¸è¦æ±‚æœ‰ msg_fristã€msg_last å’Œ msg_cbytes æˆå‘˜ã€‚ç„¶è€Œæ™®é€šçš„æºè‡ª &lt;a href="http://pubs.opengroup.org/onlinepubs/7908799/xsh/sysmsg.h.html">System V&lt;/a> çš„å®ç°ä¸­å¯ä»¥æ‰¾åˆ°è¿™ä¸‰ä¸ªæˆå‘˜ã€‚å°±ç®—æä¾›äº†è¿™ä¸¤ä¸ªæŒ‡é’ˆï¼Œé‚£ä¹ˆå®ƒä»¬æŒ‡å‘çš„æ˜¯å†…æ ¸å†…å­˜ç©ºé—´ï¼Œå¯¹äºåº”ç”¨æ¥è¯´åŸºæœ¬æ²¡æœ‰ä½œç”¨çš„ã€‚&lt;/em>&lt;/p>
&lt;p>&lt;img src="http://oid1xlj7h.bkt.clouddn.com/unix%20%E7%BD%91%E7%BB%9C%20%281%29.png" alt="unix ç½‘ç»œ (1)">&lt;/p>
&lt;p>æˆ‘ä»¬å¯ä»¥å°†å†…æ ¸ä¸­æŸä¸ªç‰¹å®šçš„æ¶ˆæ¯é˜Ÿåˆ—ç”»ä¸ºä¸€ä¸ªæ¶ˆæ¯é“¾è¡¨ï¼Œå¦‚å›¾ã€‚&lt;/p>
&lt;p>&lt;strong>msgget å‡½æ•°&lt;/strong>&lt;/p>
&lt;p>msgget å‡½æ•°ç”¨äºåˆ›å»ºä¸€ä¸ªæ–°çš„æ¶ˆæ¯é˜Ÿåˆ—æˆ–è®¿é—®ä¸€ä¸ªå·²å­˜åœ¨çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="cp">#include&lt;/span> &lt;span class="cpf">&amp;lt;sys/msg.h&amp;gt;&lt;/span>&lt;span class="cp">
&lt;/span>&lt;span class="cp">&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">msgget&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">key_t&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">oflag&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1">//è¿”å›ï¼š æˆåŠŸè¿”å›éè´Ÿæ ‡è¯†ç¬¦ï¼Œå‡ºé”™è¿”å›-1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¿”å›å€¼æ˜¯ä¸€ä¸ªæ•´æ•°æ ‡è¯†ç¬¦ï¼Œå…¶ä»–ä¸‰ä¸ªmsgå‡½æ•°å°±ç”¨å®ƒæ¥æŒ‡ä»£è¯¥é˜Ÿåˆ—ã€‚&lt;/p>
&lt;p>oflagæ˜¯è¯»å†™æƒé™çš„ç»„åˆã€‚ï¼ˆç¨å¾®å¤æ‚ã€‚ã€‚ã€‚ï¼‰&lt;/p>
&lt;p>å½“åˆ›å»ºä¸€ä¸ªæ–°çš„æ¶ˆæ¯é˜Ÿåˆ—çš„æ—¶ï¼Œmsqid_ds ç»“æ„çš„å¦‚ä¸‹æˆå‘˜è¢«åˆå§‹åŒ–ã€‚&lt;/p>
&lt;ul>
&lt;li>
&lt;p>msg_perm ç»“æ„çš„ uid å’Œ cuid æˆå‘˜è¢«è®¾ç½®æˆå½“å‰è¿›ç¨‹çš„æœ‰æ•ˆç”¨æˆ·IDï¼Œgid å’Œ cgid æˆå‘˜è¢«è®¾ç½®æˆå½“å‰çš„è¿›ç¨‹çš„æœ‰æ•ˆç»„IDã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>oflag ä¸­çš„è¯»å†™æƒé™ä½å­˜æ”¾åœ¨msg_perm.mode ä¸­ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>msg_qnumã€msg_lspidï¼Œmsg_lrpidã€msg_stime å’Œ msg_rtime è¢«è®¾ç½®ä¸º0.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>msg_ctime è¢«è®¾ç½®ä¸ºå½“å‰æ—¶é—´ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>msg_qbytes è¢«è®¾ç½®æˆç³»ç»Ÿé™åˆ¶å€¼ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="k">struct&lt;/span> &lt;span class="n">ipc_perm&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="n">key_t&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="cm">/*è°ƒç”¨shmget()æ—¶ç»™å‡ºçš„å…³é”®å­—*/&lt;/span>
&lt;span class="n">uid_t&lt;/span> &lt;span class="n">uid&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="cm">/*å…±äº«å†…å­˜æ‰€æœ‰è€…çš„æœ‰æ•ˆç”¨æˆ·ID */&lt;/span>
&lt;span class="n">gid_t&lt;/span> &lt;span class="n">gid&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="cm">/* å…±äº«å†…å­˜æ‰€æœ‰è€…æ‰€å±ç»„çš„æœ‰æ•ˆç»„ID*/&lt;/span>
&lt;span class="n">uid_t&lt;/span> &lt;span class="n">cuid&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="cm">/* å…±äº«å†…å­˜åˆ›å»º è€…çš„æœ‰æ•ˆç”¨æˆ·ID*/&lt;/span>
&lt;span class="n">gid_t&lt;/span> &lt;span class="n">cgid&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="cm">/* å…±äº«å†…å­˜åˆ›å»ºè€…æ‰€å±ç»„çš„æœ‰æ•ˆç»„ID*/&lt;/span>
&lt;span class="n">mode_t&lt;/span> &lt;span class="n">mode&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="cm">/* Permissions + SHM_DESTå’ŒSHM_LOCKEDæ ‡å¿—*/&lt;/span>
&lt;span class="n">ulong_t&lt;/span> &lt;span class="n">seq&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="cm">/* åºåˆ—å·*/&lt;/span>
&lt;span class="p">};&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>â€‹&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>msgsnd å‡½æ•°&lt;/strong>&lt;/p>
&lt;p>ä½¿ç”¨ msgget å‡½æ•°æ‰“å¼€ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—åï¼Œä½¿ç”¨ msgsnd å‡½æ•°å¾€å…¶ä¸Šæ”¾ç½®ä¸€ä¸ªæ¶ˆæ¯ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="cp"># include &amp;lt;sys/msg.h&amp;gt;
&lt;/span>&lt;span class="cp">&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="nf">msgsnd&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">msqid&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">ptr&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">size_t&lt;/span> &lt;span class="n">length&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">flag&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å…¶ä¸­msqid æ˜¯ç”±msgget å‡½æ•°è¿”å›çš„æ ‡è¯†ç¬¦ã€‚ptr æ˜¯ä¸€ä¸ªç»“æ„æŒ‡é’ˆï¼Œè¯¥ç»“æ„å…·æœ‰å¦‚ä¸‹çš„æ¨¡æ¿ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="k">struct&lt;/span> &lt;span class="n">msgbuf&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="kt">long&lt;/span> &lt;span class="n">mtype&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// message type ,must be &amp;gt; 0
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="n">mtext&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c1">// message data
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">};&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;em>æ¶ˆæ¯ç±»å‹å¿…é¡»å¤§äº0ï¼Œå› ä¸ºå¯¹äº msgrcv å‡½æ•°æ¥è¯´ï¼Œéæ­£çš„æ¶ˆæ¯ç±»å‹ç”¨ä½œç‰¹æ®Šçš„æŒ‡ç¤ºå™¨ã€‚&lt;/em>&lt;/p>
&lt;p>&lt;em>mtextè™½ç„¶èµ·åæ˜¯ text ï¼Œä½†æ˜¯æ¶ˆæ¯ç±»å‹å¹¶ä¸å±€é™äºæ–‡æœ¬ã€‚ä»»ä½•å½¢å¼çš„æ•°æ®éƒ½æ˜¯å…è®¸çš„ã€‚å†…æ ¸æ ¹æœ¬ä¸è§£é‡Šæ¶ˆ æ¯æ•°æ®çš„å†…å®¹ã€‚ptr æ‰€æŒ‡å‘çš„æ˜¯ä¸€ä¸ªå«æœ‰æ¶ˆæ¯ç±»å‹çš„é•¿æ•´æ•°ï¼Œæ¶ˆæ¯æœ¬èº«åˆ™ç´§è·Ÿç€å®ƒä¹‹åã€‚&lt;/em>&lt;/p>
&lt;p>msgsnd çš„ &lt;em>length&lt;/em> å‚æ•°ä»¥å­—èŠ‚ä¸ºå•ä½æŒ‡å®šå¾…å‘é€æ¶ˆæ¯çš„é•¿åº¦ã€‚æ˜¯ç”¨æˆ·è‡ªå®šä¹‰çš„ï¼Œå¯ä»¥æ˜¯0.&lt;/p>
&lt;p>&lt;em>flag&lt;/em> å‚æ•°æ—¢å¯ä»¥æ˜¯0ï¼Œä¹Ÿå¯ä»¥æ˜¯IPC_NOWAIT ã€‚IPC_NOWAIT æ ‡å¿—ä½¿å¾— msgsnd è°ƒç”¨éé˜»å¡ï¼šå¦‚æœæ²¡æœ‰å­˜æ”¾æ–°æ¶ˆæ¯çš„å¯ç”¨ç©ºé—´ï¼Œè¯¥å‡½æ•°é©¬ä¸Šè¿”å›ã€‚è¿™ä¸ªæ¡ä»¶å¯èƒ½å‘ç”Ÿçš„æƒ…å†µåŒ…æ‹¬ï¼š&lt;/p>
&lt;ul>
&lt;li>åœ¨æŒ‡å®šçš„é˜Ÿåˆ—ä¸­å·²æœ‰å¤ªå¤šçš„å­—èŠ‚ï¼ˆå¯¹åº” è¯¥é˜Ÿåˆ—çš„msqid_ds ç»“æ„ä¸­çš„msg_qbytes å€¼ï¼‰ï¼›&lt;/li>
&lt;li>åœ¨ç³»ç»ŸèŒƒå›´å­˜åœ¨å¤ªå¤šçš„æ¶ˆæ¯ã€‚&lt;/li>
&lt;/ul>
&lt;p>å¦‚æœä¸¤ä¸ªæ¡ä»¶ä¸€ä¸ªå­˜åœ¨ï¼Œè€Œä¸”IPC_NOWAITæ ‡å¿—å·²æŒ‡å®šï¼Œmsgsnd å°±è¿”å›ä¸€ä¸ªEAGAIN é”™è¯¯ã€‚å¦‚æœä¸¤ä¸ªæ¡ä»¶ä¸€ä¸ªå­˜åœ¨ï¼Œæ ‡å¿—æœªæŒ‡å®šï¼Œé‚£ä¹ˆè°ƒç”¨çº¿ç¨‹å°±è¢«æŠ•å…¥ç¡çœ ï¼Œç›´åˆ°ï¼š&lt;/p>
&lt;ul>
&lt;li>å…·å¤‡å­˜æ”¾æ–°æ¶ˆæ¯çš„ç©ºé—´ï¼›&lt;/li>
&lt;li>ç”± msqgid æ ‡è¯†çš„æ¶ˆæ¯é˜Ÿåˆ—ä»ç³»ç»Ÿä¸­åˆ é™¤ï¼ˆè¿™ä¸ªæƒ…å†µä¸‹å›è¿”å›ä¸€ä¸ªEIDRM é”™è¯¯ï¼‰ï¼›&lt;/li>
&lt;li>è°ƒç”¨çº¿ç¨‹è¢«æŸä¸ªæ•è·çš„ä¿¡æ¯æ‰€ä¸­æ–­ã€‚&lt;/li>
&lt;/ul></content><category scheme="https://yusank.github.io/categories/%E6%8A%80%E6%9C%AF/" term="æŠ€æœ¯" label="æŠ€æœ¯"/><category scheme="https://yusank.github.io/tags/unix/" term="Unix" label="Unix"/><category scheme="https://yusank.github.io/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" term="ç½‘ç»œç¼–ç¨‹" label="ç½‘ç»œç¼–ç¨‹"/></entry><entry><title type="text">è·¨åŸŸèµ„æºå…±äº« CORS è¯¦è§£</title><link rel="alternate" type="text/html" href="https://yusank.github.io/posts/cors/"/><id>https://yusank.github.io/posts/cors/</id><updated>2021-09-18T06:24:55+00:00</updated><published>2017-01-30T15:07:00+08:00</published><author><name>yusank</name><uri>https://yusank.github.io/</uri><email>yusankurban@gmail.com</email></author><summary type="html">è·¨åŸŸèµ„æºå…±äº« CORS è¯¦è§£ CORSæ˜¯ä¸€ä¸ªW3Cæ ‡å‡†ï¼Œå…¨ç§°æ˜¯&amp;quot;è·¨åŸŸèµ„æºå…±äº«&amp;quâ€¦â€¦</summary><content type="html">&lt;h1 id="è·¨åŸŸèµ„æºå…±äº«-cors-è¯¦è§£">è·¨åŸŸèµ„æºå…±äº« CORS è¯¦è§£&lt;/h1>
&lt;p>CORSæ˜¯ä¸€ä¸ªW3Cæ ‡å‡†ï¼Œå…¨ç§°æ˜¯&amp;quot;è·¨åŸŸèµ„æºå…±äº«&amp;quot;ï¼ˆCross-origin resource sharingï¼‰ã€‚
å®ƒå…è®¸æµè§ˆå™¨å‘è·¨æºæœåŠ¡å™¨ï¼Œå‘å‡º&lt;code>XMLHttpRequest&lt;/code>è¯·æ±‚ï¼Œä»è€Œå…‹æœäº†AJAXåªèƒ½&lt;strong>åŒæº&lt;/strong>ä½¿ç”¨çš„é™åˆ¶ã€‚
æœ¬æ–‡è¯¦ç»†ä»‹ç»CORSçš„å†…éƒ¨æœºåˆ¶ã€‚&lt;/p>
&lt;h2 id="ä¸€ç®€ä»‹">ä¸€ã€ç®€ä»‹&lt;/h2>
&lt;p>CORSéœ€è¦æµè§ˆå™¨å’ŒæœåŠ¡å™¨åŒæ—¶æ”¯æŒã€‚ç›®å‰ï¼Œæ‰€æœ‰æµè§ˆå™¨éƒ½æ”¯æŒè¯¥åŠŸèƒ½ï¼ŒIEæµè§ˆå™¨ä¸èƒ½ä½äºIE10ã€‚&lt;/p>
&lt;p>æ•´ä¸ªCORSé€šä¿¡è¿‡ç¨‹ï¼Œéƒ½æ˜¯æµè§ˆå™¨è‡ªåŠ¨å®Œæˆï¼Œä¸éœ€è¦ç”¨æˆ·å‚ä¸ã€‚å¯¹äºå¼€å‘è€…æ¥è¯´ï¼ŒCORSé€šä¿¡ä¸åŒæºçš„AJAXé€šä¿¡æ²¡æœ‰å·®åˆ«ï¼Œä»£ç å®Œå…¨ä¸€æ ·ã€‚æµè§ˆå™¨ä¸€æ—¦å‘ç°AJAXè¯·æ±‚è·¨æºï¼Œå°±ä¼šè‡ªåŠ¨æ·»åŠ ä¸€äº›é™„åŠ çš„å¤´ä¿¡æ¯ï¼Œæœ‰æ—¶è¿˜ä¼šå¤šå‡ºä¸€æ¬¡é™„åŠ çš„è¯·æ±‚ï¼Œä½†ç”¨æˆ·ä¸ä¼šæœ‰æ„Ÿè§‰ã€‚&lt;/p>
&lt;p>å› æ­¤ï¼Œå®ç°CORSé€šä¿¡çš„å…³é”®æ˜¯æœåŠ¡å™¨ã€‚åªè¦æœåŠ¡å™¨å®ç°äº†CORSæ¥å£ï¼Œå°±å¯ä»¥è·¨æºé€šä¿¡ã€‚&lt;/p>
&lt;h2 id="äºŒä¸¤ç§è¯·æ±‚">äºŒã€ä¸¤ç§è¯·æ±‚&lt;/h2>
&lt;p>æµè§ˆå™¨å°†CORSè¯·æ±‚åˆ†æˆä¸¤ç±»ï¼šç®€å•è¯·æ±‚ï¼ˆsimple requestï¼‰å’Œéç®€å•è¯·æ±‚ï¼ˆnot-so-simple requestï¼‰ã€‚&lt;/p>
&lt;p>åªè¦åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸¤å¤§æ¡ä»¶ï¼Œå°±å±äºç®€å•è¯·æ±‚ã€‚&lt;/p>
&lt;blockquote>
&lt;ol>
&lt;li>è¯·æ±‚æ–¹æ³•æ˜¯ä»¥ä¸‹ä¸‰ç§æ–¹æ³•ä¹‹ä¸€ï¼š&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>HEAD&lt;/li>
&lt;li>GET&lt;/li>
&lt;li>POST&lt;/li>
&lt;/ul>
&lt;p>ï¼ˆ2ï¼‰HTTPçš„å¤´ä¿¡æ¯ä¸è¶…å‡ºä»¥ä¸‹å‡ ç§å­—æ®µï¼š&lt;/p>
&lt;ul>
&lt;li>Accept&lt;/li>
&lt;li>Accept-Language&lt;/li>
&lt;li>Content-Language&lt;/li>
&lt;li>Last-Event-ID&lt;/li>
&lt;li>Content-Typeï¼šåªé™äºä¸‰ä¸ªå€¼&lt;code>application/x-www-form-urlencoded&lt;/code>ã€&lt;code>multipart/form-data&lt;/code>ã€&lt;code>text/plain&lt;/code>&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>å‡¡æ˜¯ä¸åŒæ—¶æ»¡è¶³ä¸Šé¢ä¸¤ä¸ªæ¡ä»¶ï¼Œå°±å±äºéç®€å•è¯·æ±‚ã€‚&lt;/p>
&lt;p>æµè§ˆå™¨å¯¹è¿™ä¸¤ç§è¯·æ±‚çš„å¤„ç†ï¼Œæ˜¯ä¸ä¸€æ ·çš„ã€‚&lt;/p>
&lt;h2 id="ä¸‰ç®€å•è¯·æ±‚">ä¸‰ã€ç®€å•è¯·æ±‚&lt;/h2>
&lt;h3 id="31-åŸºæœ¬æµç¨‹">3.1 åŸºæœ¬æµç¨‹&lt;/h3>
&lt;p>å¯¹äºç®€å•è¯·æ±‚ï¼Œæµè§ˆå™¨ç›´æ¥å‘å‡ºCORSè¯·æ±‚ã€‚å…·ä½“æ¥è¯´ï¼Œå°±æ˜¯åœ¨å¤´ä¿¡æ¯ä¹‹ä¸­ï¼Œå¢åŠ ä¸€ä¸ª&lt;code>Origin&lt;/code>å­—æ®µã€‚&lt;/p>
&lt;p>ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼Œæµè§ˆå™¨å‘ç°è¿™æ¬¡è·¨æºAJAXè¯·æ±‚æ˜¯ç®€å•è¯·æ±‚ï¼Œå°±è‡ªåŠ¨åœ¨å¤´ä¿¡æ¯ä¹‹ä¸­ï¼Œæ·»åŠ ä¸€ä¸ª&lt;code>Origin&lt;/code>å­—æ®µã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-http" data-lang="http">&lt;span class="nf">GET&lt;/span> &lt;span class="nn">/cors&lt;/span> &lt;span class="kr">HTTP&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="m">1.1&lt;/span>
&lt;span class="n">Origin&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="l">http://api.bob.com&lt;/span>
&lt;span class="n">Host&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="l">api.alice.com&lt;/span>
&lt;span class="n">Accept-Language&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="l">en-US&lt;/span>
&lt;span class="n">Connection&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="l">keep-alive&lt;/span>
&lt;span class="n">User-Agent&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="l">Mozilla/5.0...&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¸Šé¢çš„å¤´ä¿¡æ¯ä¸­ï¼Œ&lt;code>Origin&lt;/code>å­—æ®µç”¨æ¥è¯´æ˜ï¼Œæœ¬æ¬¡è¯·æ±‚æ¥è‡ªå“ªä¸ªæºï¼ˆåè®® + åŸŸå + ç«¯å£ï¼‰ã€‚æœåŠ¡å™¨æ ¹æ®è¿™ä¸ªå€¼ï¼Œå†³å®šæ˜¯å¦åŒæ„è¿™æ¬¡è¯·æ±‚ã€‚&lt;/p>
&lt;p>å¦‚æœ&lt;code>Origin&lt;/code>æŒ‡å®šçš„æºï¼Œä¸åœ¨è®¸å¯èŒƒå›´å†…ï¼ŒæœåŠ¡å™¨ä¼šè¿”å›ä¸€ä¸ªæ­£å¸¸çš„HTTPå›åº”ã€‚æµè§ˆå™¨å‘ç°ï¼Œè¿™ä¸ªå›åº”çš„å¤´ä¿¡æ¯æ²¡æœ‰åŒ…å«&lt;code>Access-Control-Allow-Origin&lt;/code>å­—æ®µï¼ˆè¯¦è§ä¸‹æ–‡ï¼‰ï¼Œå°±çŸ¥é“å‡ºé”™äº†ï¼Œä»è€ŒæŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œè¢«&lt;code>XMLHttpRequest&lt;/code>çš„&lt;code>onerror&lt;/code>å›è°ƒå‡½æ•°æ•è·ã€‚æ³¨æ„ï¼Œè¿™ç§é”™è¯¯æ— æ³•é€šè¿‡çŠ¶æ€ç è¯†åˆ«ï¼Œå› ä¸ºHTTPå›åº”çš„çŠ¶æ€ç æœ‰å¯èƒ½æ˜¯200ã€‚&lt;/p>
&lt;p>å¦‚æœ&lt;code>Origin&lt;/code>æŒ‡å®šçš„åŸŸååœ¨è®¸å¯èŒƒå›´å†…ï¼ŒæœåŠ¡å™¨è¿”å›çš„å“åº”ï¼Œä¼šå¤šå‡ºå‡ ä¸ªå¤´ä¿¡æ¯å­—æ®µã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-http" data-lang="http">&lt;span class="err">Access-Control-Allow-Origin: http://api.bob.com
&lt;/span>&lt;span class="err">Access-Control-Allow-Credentials: true
&lt;/span>&lt;span class="err">Access-Control-Expose-Headers: FooBar
&lt;/span>&lt;span class="err">Content-Type: text/html; charset=utf-8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¸Šé¢çš„å¤´ä¿¡æ¯ä¹‹ä¸­ï¼Œæœ‰ä¸‰ä¸ªä¸CORSè¯·æ±‚ç›¸å…³çš„å­—æ®µï¼Œéƒ½ä»¥&lt;code>Access-Control-&lt;/code>å¼€å¤´ã€‚&lt;/p>
&lt;p>&lt;strong>ï¼ˆ1ï¼‰Access-Control-Allow-Origin&lt;/strong>&lt;/p>
&lt;p>è¯¥å­—æ®µæ˜¯å¿…é¡»çš„ã€‚å®ƒçš„å€¼è¦ä¹ˆæ˜¯è¯·æ±‚æ—¶&lt;code>Origin&lt;/code>å­—æ®µçš„å€¼ï¼Œè¦ä¹ˆæ˜¯ä¸€ä¸ª&lt;code>*&lt;/code>ï¼Œè¡¨ç¤ºæ¥å—ä»»æ„åŸŸåçš„è¯·æ±‚ã€‚&lt;/p>
&lt;p>&lt;strong>ï¼ˆ2ï¼‰Access-Control-Allow-Credentials&lt;/strong>&lt;/p>
&lt;p>è¯¥å­—æ®µå¯é€‰ã€‚å®ƒçš„å€¼æ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæ˜¯å¦å…è®¸å‘é€Cookieã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒCookieä¸åŒ…æ‹¬åœ¨CORSè¯·æ±‚ä¹‹ä¸­ã€‚è®¾ä¸º&lt;code>true&lt;/code>ï¼Œå³è¡¨ç¤ºæœåŠ¡å™¨æ˜ç¡®è®¸å¯ï¼ŒCookieå¯ä»¥åŒ…å«åœ¨è¯·æ±‚ä¸­ï¼Œä¸€èµ·å‘ç»™æœåŠ¡å™¨ã€‚è¿™ä¸ªå€¼ä¹Ÿåªèƒ½è®¾ä¸º&lt;code>true&lt;/code>ï¼Œå¦‚æœæœåŠ¡å™¨ä¸è¦æµè§ˆå™¨å‘é€Cookieï¼Œåˆ é™¤è¯¥å­—æ®µå³å¯ã€‚&lt;/p>
&lt;p>&lt;strong>ï¼ˆ3ï¼‰Access-Control-Expose-Headers&lt;/strong>&lt;/p>
&lt;p>è¯¥å­—æ®µå¯é€‰ã€‚CORSè¯·æ±‚æ—¶ï¼Œ&lt;code>XMLHttpRequest&lt;/code>å¯¹è±¡çš„&lt;code>getResponseHeader()&lt;/code>æ–¹æ³•åªèƒ½æ‹¿åˆ°6ä¸ªåŸºæœ¬å­—æ®µï¼š&lt;code>Cache-Control&lt;/code>ã€&lt;code>Content-Language&lt;/code>ã€&lt;code>Content-Type&lt;/code>ã€&lt;code>Expires&lt;/code>ã€&lt;code>Last-Modified&lt;/code>ã€&lt;code>Pragma&lt;/code>ã€‚å¦‚æœæƒ³æ‹¿åˆ°å…¶ä»–å­—æ®µï¼Œå°±å¿…é¡»åœ¨&lt;code>Access-Control-Expose-Headers&lt;/code>é‡Œé¢æŒ‡å®šã€‚ä¸Šé¢çš„ä¾‹å­æŒ‡å®šï¼Œ&lt;code>getResponseHeader('FooBar')&lt;/code>å¯ä»¥è¿”å›&lt;code>FooBar&lt;/code>å­—æ®µçš„å€¼ã€‚&lt;/p>
&lt;h3 id="32-withcredentials-å±æ€§">3.2 withCredentials å±æ€§&lt;/h3>
&lt;p>ä¸Šé¢è¯´åˆ°ï¼ŒCORSè¯·æ±‚é»˜è®¤ä¸å‘é€Cookieå’ŒHTTPè®¤è¯ä¿¡æ¯ã€‚å¦‚æœè¦æŠŠCookieå‘åˆ°æœåŠ¡å™¨ï¼Œä¸€æ–¹é¢è¦æœåŠ¡å™¨åŒæ„ï¼ŒæŒ‡å®š&lt;code>Access-Control-Allow-Credentials&lt;/code>å­—æ®µã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-http" data-lang="http">&lt;span class="err">Access-Control-Allow-Credentials: true
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦ä¸€æ–¹é¢ï¼Œå¼€å‘è€…å¿…é¡»åœ¨AJAXè¯·æ±‚ä¸­æ‰“å¼€&lt;code>withCredentials&lt;/code>å±æ€§ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-javascript" data-lang="javascript">&lt;span class="kd">var&lt;/span> &lt;span class="nx">xhr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">XMLHttpRequest&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="nx">xhr&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">withCredentials&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦åˆ™ï¼Œå³ä½¿æœåŠ¡å™¨åŒæ„å‘é€Cookieï¼Œæµè§ˆå™¨ä¹Ÿä¸ä¼šå‘é€ã€‚æˆ–è€…ï¼ŒæœåŠ¡å™¨è¦æ±‚è®¾ç½®Cookieï¼Œæµè§ˆå™¨ä¹Ÿä¸ä¼šå¤„ç†ã€‚&lt;/p>
&lt;p>ä½†æ˜¯ï¼Œå¦‚æœçœç•¥&lt;code>withCredentials&lt;/code>è®¾ç½®ï¼Œæœ‰çš„æµè§ˆå™¨è¿˜æ˜¯ä¼šä¸€èµ·å‘é€Cookieã€‚è¿™æ—¶ï¼Œå¯ä»¥æ˜¾å¼å…³é—­&lt;code>withCredentials&lt;/code>ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-javascript" data-lang="javascript">&lt;span class="nx">xhr&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">withCredentials&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœè¦å‘é€Cookieï¼Œ&lt;code>Access-Control-Allow-Origin&lt;/code>å°±ä¸èƒ½è®¾ä¸ºæ˜Ÿå·ï¼Œå¿…é¡»æŒ‡å®šæ˜ç¡®çš„ã€ä¸è¯·æ±‚ç½‘é¡µä¸€è‡´çš„åŸŸåã€‚åŒæ—¶ï¼ŒCookieä¾ç„¶éµå¾ªåŒæºæ”¿ç­–ï¼Œåªæœ‰ç”¨æœåŠ¡å™¨åŸŸåè®¾ç½®çš„Cookieæ‰ä¼šä¸Šä¼ ï¼Œå…¶ä»–åŸŸåçš„Cookieå¹¶ä¸ä¼šä¸Šä¼ ï¼Œä¸”ï¼ˆè·¨æºï¼‰åŸç½‘é¡µä»£ç ä¸­çš„&lt;code>document.cookie&lt;/code>ä¹Ÿæ— æ³•è¯»å–æœåŠ¡å™¨åŸŸåä¸‹çš„Cookieã€‚&lt;/p>
&lt;h2 id="å››éç®€å•è¯·æ±‚">å››ã€éç®€å•è¯·æ±‚&lt;/h2>
&lt;h3 id="41-é¢„æ£€è¯·æ±‚">4.1 é¢„æ£€è¯·æ±‚&lt;/h3>
&lt;p>éç®€å•è¯·æ±‚æ˜¯é‚£ç§å¯¹æœåŠ¡å™¨æœ‰ç‰¹æ®Šè¦æ±‚çš„è¯·æ±‚ï¼Œæ¯”å¦‚è¯·æ±‚æ–¹æ³•æ˜¯&lt;code>PUT&lt;/code>æˆ–&lt;code>DELETE&lt;/code>ï¼Œæˆ–è€…&lt;code>Content-Type&lt;/code>å­—æ®µçš„ç±»å‹æ˜¯&lt;code>application/json&lt;/code>ã€‚&lt;/p>
&lt;p>éç®€å•è¯·æ±‚çš„CORSè¯·æ±‚ï¼Œä¼šåœ¨æ­£å¼é€šä¿¡ä¹‹å‰ï¼Œå¢åŠ ä¸€æ¬¡HTTPæŸ¥è¯¢è¯·æ±‚ï¼Œç§°ä¸º&amp;quot;é¢„æ£€&amp;quot;è¯·æ±‚ï¼ˆpreflightï¼‰ã€‚&lt;/p>
&lt;p>æµè§ˆå™¨å…ˆè¯¢é—®æœåŠ¡å™¨ï¼Œå½“å‰ç½‘é¡µæ‰€åœ¨çš„åŸŸåæ˜¯å¦åœ¨æœåŠ¡å™¨çš„è®¸å¯åå•ä¹‹ä¸­ï¼Œä»¥åŠå¯ä»¥ä½¿ç”¨å“ªäº›HTTPåŠ¨è¯å’Œå¤´ä¿¡æ¯å­—æ®µã€‚åªæœ‰å¾—åˆ°è‚¯å®šç­”å¤ï¼Œæµè§ˆå™¨æ‰ä¼šå‘å‡ºæ­£å¼çš„&lt;code>XMLHttpRequest&lt;/code>è¯·æ±‚ï¼Œå¦åˆ™å°±æŠ¥é”™ã€‚&lt;/p>
&lt;p>ä¸‹é¢æ˜¯ä¸€æ®µæµè§ˆå™¨çš„JavaScriptè„šæœ¬ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-javascript" data-lang="javascript">&lt;span class="kd">var&lt;/span> &lt;span class="nx">url&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;http://api.alice.com/cors&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="kd">var&lt;/span> &lt;span class="nx">xhr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">XMLHttpRequest&lt;/span>&lt;span class="p">();&lt;/span>
&lt;span class="nx">xhr&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;PUT&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">url&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="nx">xhr&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">setRequestHeader&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;X-Custom-Header&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;value&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="nx">xhr&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">send&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¸Šé¢ä»£ç ä¸­ï¼ŒHTTPè¯·æ±‚çš„æ–¹æ³•æ˜¯&lt;code>PUT&lt;/code>ï¼Œå¹¶ä¸”å‘é€ä¸€ä¸ªè‡ªå®šä¹‰å¤´ä¿¡æ¯&lt;code>X-Custom-Header&lt;/code>ã€‚&lt;/p>
&lt;p>æµè§ˆå™¨å‘ç°ï¼Œè¿™æ˜¯ä¸€ä¸ªéç®€å•è¯·æ±‚ï¼Œå°±è‡ªåŠ¨å‘å‡ºä¸€ä¸ª&amp;quot;é¢„æ£€&amp;quot;è¯·æ±‚ï¼Œè¦æ±‚æœåŠ¡å™¨ç¡®è®¤å¯ä»¥è¿™æ ·è¯·æ±‚ã€‚ä¸‹é¢æ˜¯è¿™ä¸ª&amp;quot;é¢„æ£€&amp;quot;è¯·æ±‚çš„HTTPå¤´ä¿¡æ¯ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-http" data-lang="http">&lt;span class="nf">OPTIONS&lt;/span> &lt;span class="nn">/cors&lt;/span> &lt;span class="kr">HTTP&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="m">1.1&lt;/span>
&lt;span class="n">Origin&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="l">http://api.bob.com&lt;/span>
&lt;span class="n">Access-Control-Request-Method&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="l">PUT&lt;/span>
&lt;span class="n">Access-Control-Request-Headers&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="l">X-Custom-Header&lt;/span>
&lt;span class="n">Host&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="l">api.alice.com&lt;/span>
&lt;span class="n">Accept-Language&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="l">en-US&lt;/span>
&lt;span class="n">Connection&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="l">keep-alive&lt;/span>
&lt;span class="n">User-Agent&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="l">Mozilla/5.0...&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&amp;quot;é¢„æ£€&amp;quot;è¯·æ±‚ç”¨çš„è¯·æ±‚æ–¹æ³•æ˜¯&lt;code>OPTIONS&lt;/code>ï¼Œè¡¨ç¤ºè¿™ä¸ªè¯·æ±‚æ˜¯ç”¨æ¥è¯¢é—®çš„ã€‚å¤´ä¿¡æ¯é‡Œé¢ï¼Œå…³é”®å­—æ®µæ˜¯&lt;code>Origin&lt;/code>ï¼Œè¡¨ç¤ºè¯·æ±‚æ¥è‡ªå“ªä¸ªæºã€‚&lt;/p>
&lt;p>é™¤äº†&lt;code>Origin&lt;/code>å­—æ®µï¼Œ&amp;quot;é¢„æ£€&amp;quot;è¯·æ±‚çš„å¤´ä¿¡æ¯åŒ…æ‹¬ä¸¤ä¸ªç‰¹æ®Šå­—æ®µã€‚&lt;/p>
&lt;p>&lt;strong>ï¼ˆ1ï¼‰Access-Control-Request-Method&lt;/strong>&lt;/p>
&lt;p>è¯¥å­—æ®µæ˜¯å¿…é¡»çš„ï¼Œç”¨æ¥åˆ—å‡ºæµè§ˆå™¨çš„CORSè¯·æ±‚ä¼šç”¨åˆ°å“ªäº›HTTPæ–¹æ³•ï¼Œä¸Šä¾‹æ˜¯&lt;code>PUT&lt;/code>ã€‚&lt;/p>
&lt;p>&lt;strong>ï¼ˆ2ï¼‰Access-Control-Request-Headers&lt;/strong>&lt;/p>
&lt;p>è¯¥å­—æ®µæ˜¯ä¸€ä¸ªé€—å·åˆ†éš”çš„å­—ç¬¦ä¸²ï¼ŒæŒ‡å®šæµè§ˆå™¨CORSè¯·æ±‚ä¼šé¢å¤–å‘é€çš„å¤´ä¿¡æ¯å­—æ®µï¼Œä¸Šä¾‹æ˜¯&lt;code>X-Custom-Header&lt;/code>ã€‚&lt;/p>
&lt;h3 id="42-é¢„æ£€è¯·æ±‚çš„å›åº”">4.2 é¢„æ£€è¯·æ±‚çš„å›åº”&lt;/h3>
&lt;p>æœåŠ¡å™¨æ”¶åˆ°&amp;quot;é¢„æ£€&amp;quot;è¯·æ±‚ä»¥åï¼Œæ£€æŸ¥äº†&lt;code>Origin&lt;/code>ã€&lt;code>Access-Control-Request-Method&lt;/code>å’Œ&lt;code>Access-Control-Request-Headers&lt;/code>å­—æ®µä»¥åï¼Œç¡®è®¤å…è®¸è·¨æºè¯·æ±‚ï¼Œå°±å¯ä»¥åšå‡ºå›åº”ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-http" data-lang="http">&lt;span class="kr">HTTP&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="m">1.1&lt;/span> &lt;span class="m">200&lt;/span> &lt;span class="ne">OK&lt;/span>
&lt;span class="n">Date&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="l">Mon, 01 Dec 2008 01:15:39 GMT&lt;/span>
&lt;span class="n">Server&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="l">Apache/2.0.61 (Unix)&lt;/span>
&lt;span class="n">Access-Control-Allow-Origin&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="l">http://api.bob.com&lt;/span>
&lt;span class="n">Access-Control-Allow-Methods&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="l">GET, POST, PUT&lt;/span>
&lt;span class="n">Access-Control-Allow-Headers&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="l">X-Custom-Header&lt;/span>
&lt;span class="n">Content-Type&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="l">text/html; charset=utf-8&lt;/span>
&lt;span class="n">Content-Encoding&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="l">gzip&lt;/span>
&lt;span class="n">Content-Length&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="l">0&lt;/span>
&lt;span class="n">Keep-Alive&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="l">timeout=2, max=100&lt;/span>
&lt;span class="n">Connection&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="l">Keep-Alive&lt;/span>
&lt;span class="n">Content-Type&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="l">text/plain&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¸Šé¢çš„HTTPå›åº”ä¸­ï¼Œå…³é”®çš„æ˜¯&lt;code>Access-Control-Allow-Origin&lt;/code>å­—æ®µï¼Œè¡¨ç¤º&lt;code>http://api.bob.com&lt;/code>å¯ä»¥è¯·æ±‚æ•°æ®ã€‚è¯¥å­—æ®µä¹Ÿå¯ä»¥è®¾ä¸ºæ˜Ÿå·ï¼Œè¡¨ç¤ºåŒæ„ä»»æ„è·¨æºè¯·æ±‚ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-http" data-lang="http">&lt;span class="err">Access-Control-Allow-Origin: *
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœæµè§ˆå™¨å¦å®šäº†&amp;quot;é¢„æ£€&amp;quot;è¯·æ±‚ï¼Œä¼šè¿”å›ä¸€ä¸ªæ­£å¸¸çš„HTTPå›åº”ï¼Œä½†æ˜¯æ²¡æœ‰ä»»ä½•CORSç›¸å…³çš„å¤´ä¿¡æ¯å­—æ®µã€‚è¿™æ—¶ï¼Œæµè§ˆå™¨å°±ä¼šè®¤å®šï¼ŒæœåŠ¡å™¨ä¸åŒæ„é¢„æ£€è¯·æ±‚ï¼Œå› æ­¤è§¦å‘ä¸€ä¸ªé”™è¯¯ï¼Œè¢«&lt;code>XMLHttpRequest&lt;/code>å¯¹è±¡çš„&lt;code>onerror&lt;/code>å›è°ƒå‡½æ•°æ•è·ã€‚æ§åˆ¶å°ä¼šæ‰“å°å‡ºå¦‚ä¸‹çš„æŠ¥é”™ä¿¡æ¯ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-http" data-lang="http">&lt;span class="err">XMLHttpRequest cannot load http://api.alice.com.
&lt;/span>&lt;span class="err">Origin http://api.bob.com is not allowed by Access-Control-Allow-Origin.
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æœåŠ¡å™¨å›åº”çš„å…¶ä»–CORSç›¸å…³å­—æ®µå¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-http" data-lang="http">&lt;span class="err">Access-Control-Allow-Methods: GET, POST, PUT
&lt;/span>&lt;span class="err">Access-Control-Allow-Headers: X-Custom-Header
&lt;/span>&lt;span class="err">Access-Control-Allow-Credentials: true
&lt;/span>&lt;span class="err">Access-Control-Max-Age: 1728000
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>ï¼ˆ1ï¼‰Access-Control-Allow-Methods&lt;/strong>&lt;/p>
&lt;p>è¯¥å­—æ®µå¿…éœ€ï¼Œå®ƒçš„å€¼æ˜¯é€—å·åˆ†éš”çš„ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¡¨æ˜æœåŠ¡å™¨æ”¯æŒçš„æ‰€æœ‰è·¨åŸŸè¯·æ±‚çš„æ–¹æ³•ã€‚æ³¨æ„ï¼Œè¿”å›çš„æ˜¯æ‰€æœ‰æ”¯æŒçš„æ–¹æ³•ï¼Œè€Œä¸å•æ˜¯æµè§ˆå™¨è¯·æ±‚çš„é‚£ä¸ªæ–¹æ³•ã€‚è¿™æ˜¯ä¸ºäº†é¿å…å¤šæ¬¡&amp;quot;é¢„æ£€&amp;quot;è¯·æ±‚ã€‚&lt;/p>
&lt;p>&lt;strong>ï¼ˆ2ï¼‰Access-Control-Allow-Headers&lt;/strong>&lt;/p>
&lt;p>å¦‚æœæµè§ˆå™¨è¯·æ±‚åŒ…æ‹¬&lt;code>Access-Control-Request-Headers&lt;/code>å­—æ®µï¼Œåˆ™&lt;code>Access-Control-Allow-Headers&lt;/code>å­—æ®µæ˜¯å¿…éœ€çš„ã€‚å®ƒä¹Ÿæ˜¯ä¸€ä¸ªé€—å·åˆ†éš”çš„å­—ç¬¦ä¸²ï¼Œè¡¨æ˜æœåŠ¡å™¨æ”¯æŒçš„æ‰€æœ‰å¤´ä¿¡æ¯å­—æ®µï¼Œä¸é™äºæµè§ˆå™¨åœ¨&amp;quot;é¢„æ£€&amp;quot;ä¸­è¯·æ±‚çš„å­—æ®µã€‚&lt;/p>
&lt;p>&lt;strong>ï¼ˆ3ï¼‰Access-Control-Allow-Credentials&lt;/strong>&lt;/p>
&lt;p>è¯¥å­—æ®µä¸ç®€å•è¯·æ±‚æ—¶çš„å«ä¹‰ç›¸åŒã€‚&lt;/p>
&lt;p>&lt;strong>ï¼ˆ4ï¼‰Access-Control-Max-Age&lt;/strong>&lt;/p>
&lt;p>è¯¥å­—æ®µå¯é€‰ï¼Œç”¨æ¥æŒ‡å®šæœ¬æ¬¡é¢„æ£€è¯·æ±‚çš„æœ‰æ•ˆæœŸï¼Œå•ä½ä¸ºç§’ã€‚ä¸Šé¢ç»“æœä¸­ï¼Œæœ‰æ•ˆæœŸæ˜¯20å¤©ï¼ˆ1728000ç§’ï¼‰ï¼Œå³å…è®¸ç¼“å­˜è¯¥æ¡å›åº”1728000ç§’ï¼ˆå³20å¤©ï¼‰ï¼Œåœ¨æ­¤æœŸé—´ï¼Œä¸ç”¨å‘å‡ºå¦ä¸€æ¡é¢„æ£€è¯·æ±‚ã€‚&lt;/p>
&lt;h3 id="43-æµè§ˆå™¨çš„æ­£å¸¸è¯·æ±‚å’Œå›åº”">4.3 æµè§ˆå™¨çš„æ­£å¸¸è¯·æ±‚å’Œå›åº”&lt;/h3>
&lt;p>ä¸€æ—¦æœåŠ¡å™¨é€šè¿‡äº†&amp;quot;é¢„æ£€&amp;quot;è¯·æ±‚ï¼Œä»¥åæ¯æ¬¡æµè§ˆå™¨æ­£å¸¸çš„CORSè¯·æ±‚ï¼Œå°±éƒ½è·Ÿç®€å•è¯·æ±‚ä¸€æ ·ï¼Œä¼šæœ‰ä¸€ä¸ª&lt;code>Origin&lt;/code>å¤´ä¿¡æ¯å­—æ®µã€‚æœåŠ¡å™¨çš„å›åº”ï¼Œä¹Ÿéƒ½ä¼šæœ‰ä¸€ä¸ª&lt;code>Access-Control-Allow-Origin&lt;/code>å¤´ä¿¡æ¯å­—æ®µã€‚&lt;/p>
&lt;p>ä¸‹é¢æ˜¯&amp;quot;é¢„æ£€&amp;quot;è¯·æ±‚ä¹‹åï¼Œæµè§ˆå™¨çš„æ­£å¸¸CORSè¯·æ±‚ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-http" data-lang="http">&lt;span class="nf">PUT&lt;/span> &lt;span class="nn">/cors&lt;/span> &lt;span class="kr">HTTP&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="m">1.1&lt;/span>
&lt;span class="n">Origin&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="l">http://api.bob.com&lt;/span>
&lt;span class="n">Host&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="l">api.alice.com&lt;/span>
&lt;span class="n">X-Custom-Header&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="l">value&lt;/span>
&lt;span class="n">Accept-Language&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="l">en-US&lt;/span>
&lt;span class="n">Connection&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="l">keep-alive&lt;/span>
&lt;span class="n">User-Agent&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="l">Mozilla/5.0...&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¸Šé¢å¤´ä¿¡æ¯çš„&lt;code>Origin&lt;/code>å­—æ®µæ˜¯æµè§ˆå™¨è‡ªåŠ¨æ·»åŠ çš„ã€‚&lt;/p>
&lt;p>ä¸‹é¢æ˜¯æœåŠ¡å™¨æ­£å¸¸çš„å›åº”ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-http" data-lang="http">&lt;span class="err">Access-Control-Allow-Origin: http://api.bob.com
&lt;/span>&lt;span class="err">Content-Type: text/html; charset=utf-8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¸Šé¢å¤´ä¿¡æ¯ä¸­ï¼Œ&lt;code>Access-Control-Allow-Origin&lt;/code>å­—æ®µæ˜¯æ¯æ¬¡å›åº”éƒ½å¿…å®šåŒ…å«çš„ã€‚&lt;/p>
&lt;h2 id="äº”ä¸jsonpçš„æ¯”è¾ƒ">äº”ã€ä¸JSONPçš„æ¯”è¾ƒ&lt;/h2>
&lt;p>CORSä¸JSONPçš„ä½¿ç”¨ç›®çš„ç›¸åŒï¼Œä½†æ˜¯æ¯”JSONPæ›´å¼ºå¤§ã€‚&lt;/p>
&lt;p>JSONPåªæ”¯æŒ&lt;code>GET&lt;/code>è¯·æ±‚ï¼ŒCORSæ”¯æŒæ‰€æœ‰ç±»å‹çš„HTTPè¯·æ±‚ã€‚JSONPçš„ä¼˜åŠ¿åœ¨äºæ”¯æŒè€å¼æµè§ˆå™¨ï¼Œä»¥åŠå¯ä»¥å‘ä¸æ”¯æŒCORSçš„ç½‘ç«™è¯·æ±‚æ•°æ®ã€‚&lt;/p>
&lt;p>ï¼ˆå®Œï¼‰&lt;/p></content><category scheme="https://yusank.github.io/categories/%E6%8A%80%E6%9C%AF/" term="æŠ€æœ¯" label="æŠ€æœ¯"/><category scheme="https://yusank.github.io/tags/go/" term="go" label="go"/><category scheme="https://yusank.github.io/tags/cors/" term="cors" label="cors"/></entry><entry><title type="text">linuxå‘½ä»¤</title><link rel="alternate" type="text/html" href="https://yusank.github.io/posts/linux-cmd/"/><id>https://yusank.github.io/posts/linux-cmd/</id><updated>2021-09-18T06:24:55+00:00</updated><published>2016-12-28T13:13:13+08:00</published><author><name>yusank</name><uri>https://yusank.github.io/</uri><email>yusankurban@gmail.com</email></author><summary type="html">welcome to learn terminal command!!! linuxå‘½ä»¤ æ°¸ï¼è¿œï¼ä¸ï¼è¦ï¼æ‰§ï¼è¡Œï¼ä½ ï¼ä¸ï¼æ¸…ï¼æ¥šï¼åœ¨ï¼å¹²ï¼å•¥ï¼çš„ï¼â€¦â€¦</summary><content type="html">&lt;p>welcome to learn terminal command!!!&lt;/p>
&lt;h1 id="linuxå‘½ä»¤">linuxå‘½ä»¤&lt;/h1>
&lt;h3 id="æ°¸è¿œä¸è¦æ‰§è¡Œä½ ä¸æ¸…æ¥šåœ¨å¹²å•¥çš„å‘½ä»¤">æ°¸ï¼è¿œï¼ä¸ï¼è¦ï¼æ‰§ï¼è¡Œï¼ä½ ï¼ä¸ï¼æ¸…ï¼æ¥šï¼åœ¨ï¼å¹²ï¼å•¥ï¼çš„ï¼å‘½ï¼ä»¤ï¼&lt;/h3>
&lt;h2 id="å®ç”¨æ€§">å®ç”¨æ€§&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ ls -l &lt;span class="p">|&lt;/span> sed &lt;span class="s1">&amp;#39;1d&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span> sort -n -k5 &lt;span class="p">|&lt;/span> awk &lt;span class="s1">&amp;#39;{printf &amp;#34;%15s %10s\n&amp;#34;, $9,$5}&amp;#39;&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æŒ‰æ–‡ä»¶å¤§å°å¢åºæ‰“å°å‡ºå½“å‰ç›®å½•ä¸‹çš„æ–‡ä»¶ååŠå…¶æ–‡ä»¶å¤§å°(å•ä½å­—èŠ‚ï¼‰&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ &lt;span class="nb">history&lt;/span> &lt;span class="p">|&lt;/span> awk &lt;span class="s1">&amp;#39;{print $2}&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span> sort &lt;span class="p">|&lt;/span> uniq -c &lt;span class="p">|&lt;/span> sort -rn &lt;span class="p">|&lt;/span> head -10
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¾“å‡ºä½ æœ€å¸¸ç”¨çš„åæ¡å‘½ä»¤&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ http POST http://localhost:4000/ &amp;lt; /&amp;lt;jsonæ–‡ä»¶è·¯å¾„&amp;gt;
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åšæµ‹è¯•çš„æ—¶å€™å¾ˆæœ‰ç”¨çš„ä¸€ä¸ªå‘½ä»¤ï¼Œéœ€è¦ä¸‹è½½http&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ brew install http
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ lsof -n -P -i TCP -s TCP:LISTEN
COMMAND PID USER FD TYPE DEVICE SIZE/OFF NODE NAME
QQ &lt;span class="m">290&lt;/span> smartestee 33u IPv4 0x2f3beaa58a62d73b 0t0 TCP 127.0.0.1:4300 &lt;span class="o">(&lt;/span>LISTEN&lt;span class="o">)&lt;/span>
QQ &lt;span class="m">290&lt;/span> smartestee 34u IPv4 0x2f3beaa58c69673b 0t0 TCP 127.0.0.1:4301 &lt;span class="o">(&lt;/span>LISTEN&lt;span class="o">)&lt;/span>
idea &lt;span class="m">3257&lt;/span> smartestee 164u IPv4 0x2f3beaa588d11e43 0t0 TCP 127.0.0.1:6942 &lt;span class="o">(&lt;/span>LISTEN&lt;span class="o">)&lt;/span>
idea &lt;span class="m">3257&lt;/span> smartestee 385u IPv4 0x2f3beaa58c69316b 0t0 TCP 127.0.0.1:63342 &lt;span class="o">(&lt;/span>LISTEN&lt;span class="o">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æŸ¥çœ‹ç«¯å£çš„ä½¿ç”¨æƒ…å†µ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ ps -ef
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æŸ¥çœ‹è¿›ç¨‹&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ &lt;span class="nb">kill&lt;/span> xxxx
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç«¯å£å†²çªæ—¶ï¼Œç”¨æ­¤å‘½ä»¤ï¼Œå…³é—­æŸä¸ªç«¯å£ã€‚ç”¨PIDæ›¿æ¢xxxx&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ &lt;span class="nb">history&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æŸ¥çœ‹å†å²å‘½ä»¤è®°å½•&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ &lt;span class="nb">pwd&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å½“å‰ä½ç½®&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ which xx
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>pathä½ç½®ï¼Œæ­å»ºç¯å¢ƒçš„æ—¶å€™è‚¯å®šä¼šç”¨å¾—åˆ°&lt;/p>
&lt;h3 id="linux-æ–‡ä»¶ç³»ç»Ÿå‘½ä»¤">Linux æ–‡ä»¶ç³»ç»Ÿå‘½ä»¤&lt;/h3>
&lt;p>ä¿®æ”¹é—®ä»·æ‹¥æœ‰è€…&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ chgrp -R ç»„å æ–‡ä»¶ / ç›®å½•
$ chown -R è´¦æˆ·å æ–‡ä»¶ / ç›®å½•
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¿®æ”¹æ–‡ä»¶æƒé™&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ chmod
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>ä½¿ç”¨æ•°å­—
&lt;ul>
&lt;li>rï¼š4, wï¼š2, xï¼š1&lt;/li>
&lt;li>æ¯ç§èº«ä»½çš„æƒé™çš„ç´¯åŠ çš„ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ chmod &lt;span class="m">777&lt;/span> &lt;span class="nb">test&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>
&lt;p>ä½¿ç”¨ç¬¦å·ä¿®æ”¹&lt;/p>
&lt;ul>
&lt;li>
&lt;p>u: user, g: group, o: others, a: all&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æ·»åŠ æƒé™ç”¨+ï¼Œ é™¤å»ç”¨-ï¼Œ è®¾ç½®ç”¨=&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ chmod &lt;span class="nv">u&lt;/span>&lt;span class="o">=&lt;/span>rwx, &lt;span class="nv">g&lt;/span>&lt;span class="o">=&lt;/span>rw, &lt;span class="nv">o&lt;/span>&lt;span class="o">=&lt;/span>r &lt;span class="nb">test&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ chmod a-x &lt;span class="nb">test&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ chmod go+r &lt;span class="nb">test&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>â€‹&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ sudo !!
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä»¥rootæƒé™æ‰§è¡Œä¸Šä¸€æ¡å‘½ä»¤ï¼ˆæ³¨æ„ä¸Šä¸€æ¡å‘½ä»¤çš„å†…å®¹ï¼Œä»¥å…å‘ç”Ÿæ„å¤–ï¼‰&lt;/p>
&lt;p>ä¾‹å¦‚ï¼šåœ¨Ubuntu å®‰è£…è½¯ä»¶æˆ–æ’ä»¶çš„æ—¶å€™éœ€è¦ç”¨åˆ°è¿™ä¸ªå‘½ä»¤&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ sudo apt-get install nginx
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æŸ¥çœ‹å’Œä¿®æ”¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ cat
$ more
$ less
$ head
$ tail
$ vi
$ vim
$ mkdir
$ touch
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="git">git&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ git
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å…ˆç»™å‡ºæ¯”è¾ƒå¸¸ç”¨çš„&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ git add &amp;lt;ä¸€ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶å&lt;span class="o">(&lt;/span>æ–‡ä»¶åä¹‹é—´æ˜¯ç”¨ç©ºæ ¼ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªç‚¹ï¼Œè¡¨ç¤ºæ·»åŠ å…¨éƒ¨&lt;span class="o">)&lt;/span>&amp;gt;
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ git commit -m &lt;span class="s2">&amp;#34;æ³¨é‡Š&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æœ¬åœ°æäº¤&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="p">$&lt;/span> &lt;span class="n">git&lt;/span> &lt;span class="n">checkout&lt;/span> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="n">åˆ†æ”¯åæˆ–master&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åˆ‡æ¢åˆ†æ”¯ä¸master&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ git branch &amp;lt;åˆ†æ”¯å&amp;gt;
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ–°å¼€ä¸€ä¸ªåˆ†æ”¯&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ git merge &amp;lt;åˆ†æ”¯å&amp;gt;
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¸»åˆ†æ”¯ä¸åˆ†æ”¯çš„åˆå¹¶&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ git push origin master
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æäº¤åˆ°githubä¸Š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ fuck
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>çº æ­£å‘½ä»¤è¡Œè¾“å…¥çš„é”™è¯¯ï¼Œæ¯”æ‰‹åŠ¨æ”¹å¿«ï¼Œå®ç”¨ã€‚&lt;/p>
&lt;p>å®‰è£…ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ brew install thefuck
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="å¨±ä¹">å¨±ä¹&lt;/h2>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ cmatrix
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ telnet towel.blinkenlights.nl
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>telnetæ˜¯åŸºäºTelnetåè®®çš„è¿œç¨‹ç™»å½•å®¢æˆ·ç«¯ç¨‹åº,ç»å¸¸ç”¨æ¥è¿œç¨‹ç™»å½•æœåŠ¡å™¨.é™¤æ­¤è¿˜å¯ä»¥ç”¨å®ƒæ¥è§‚çœ‹æ˜Ÿçƒå¤§æˆ˜&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">$ fortune
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>éšæœºè¾“å‡ºåè¨€æˆ–è€…ç¬‘è¯ï¼Œ&lt;/p>
&lt;p>è¿˜æœ‰å¾ˆå¤šï¼Œæœ‰å…´è¶£çš„å¯ä»¥é€šè¿‡è¿™ä¸ªé“¾æ¥å»çœ‹ï¼š&lt;a href="https://www.zhihu.com/question/20273259">çŸ¥ä¹&lt;/a>&lt;/p>
&lt;p>ä¸ªäººåšå®¢ &lt;a href="http://aa.yusank.space/2016/12/28/linux%E5%91%BD%E4%BB%A4/">yusank&lt;/a>&lt;/p>
&lt;p>æ¯”è¾ƒç‰›é€¼çš„ä¸€ä¸ªæŸ¥æ‰¾å‘½ä»¤çš„ç½‘ç«™ï¼šhttp://www.commandlinefu.com/commands/browse/sort-by-votes&lt;/p>
&lt;p>æ¯å¤©éƒ½æœ‰æ›´æ–°å„ç§å‘½ä»¤ç»„åˆ&lt;/p></content><category scheme="https://yusank.github.io/categories/%E6%8A%80%E6%9C%AF/" term="æŠ€æœ¯" label="æŠ€æœ¯"/><category scheme="https://yusank.github.io/tags/linux/" term="Linux" label="Linux"/></entry></feed>