<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>[ç³»åˆ—]å¾®æœåŠ¡Â·å¦‚ä½•é€šè¿‡ protobuf å®šä¹‰æ•°æ®å’ŒæœåŠ¡ - Yusank`s Site</title><meta name=Description content="è¿™æ˜¯æˆ‘çš„ä¸ªäººåšå®¢ï¼Œæˆ‘ä¼šåœ¨è¿™é‡Œåˆ†äº«å­¦ä¹ å’Œæˆé•¿è¿‡ç¨‹ä¸­çš„ç§¯ç´¯å’Œç»éªŒ."><meta property="og:title" content="[ç³»åˆ—]å¾®æœåŠ¡Â·å¦‚ä½•é€šè¿‡ protobuf å®šä¹‰æ•°æ®å’ŒæœåŠ¡"><meta property="og:description" content="
æœ¬æ–‡ä¸ºç³»åˆ—ç¯‡å¾®æœåŠ¡çš„å…³äº protobuf å®šä¹‰æ•°æ®å’ŒæœåŠ¡çš„æ–‡ç« ã€‚æœ¬ç¯‡å°†ä¼šä»‹ç»å¦‚ä½•é€šè¿‡ pb å®šä¹‰æ•°æ®ç»“æ„å’ŒæœåŠ¡ä»¥åŠ pb çš„ä¸€äº›å¦ç±»ç©æ³•ã€‚
"><meta property="og:type" content="article"><meta property="og:url" content="https://yusank.github.io/posts/microservices-protobuf/"><meta property="og:image" content="https://yusank.github.io/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-06-15T12:10:00+08:00"><meta property="article:modified_time" content="2022-06-16T17:58:21+08:00"><meta property="og:site_name" content="My cool site"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://yusank.github.io/logo.png"><meta name=twitter:title content="[ç³»åˆ—]å¾®æœåŠ¡Â·å¦‚ä½•é€šè¿‡ protobuf å®šä¹‰æ•°æ®å’ŒæœåŠ¡"><meta name=twitter:description content="
æœ¬æ–‡ä¸ºç³»åˆ—ç¯‡å¾®æœåŠ¡çš„å…³äº protobuf å®šä¹‰æ•°æ®å’ŒæœåŠ¡çš„æ–‡ç« ã€‚æœ¬ç¯‡å°†ä¼šä»‹ç»å¦‚ä½•é€šè¿‡ pb å®šä¹‰æ•°æ®ç»“æ„å’ŒæœåŠ¡ä»¥åŠ pb çš„ä¸€äº›å¦ç±»ç©æ³•ã€‚
"><meta name=application-name content="Yusank's Site"><meta name=apple-mobile-web-app-title content="Yusank's Site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel=icon href=https://yusank.github.io/images/logo.svg><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://yusank.github.io/posts/microservices-protobuf/><link rel=prev href=https://yusank.github.io/posts/brog-in-google/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload="this.onload=null,this.rel='stylesheet'"><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"[ç³»åˆ—]å¾®æœåŠ¡Â·å¦‚ä½•é€šè¿‡ protobuf å®šä¹‰æ•°æ®å’ŒæœåŠ¡","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/yusank.github.io\/posts\/microservices-protobuf\/"},"genre":"posts","keywords":"å¾®æœåŠ¡, ç³»åˆ—ç¯‡, protobuf, grpc","wordcount":6022,"url":"https:\/\/yusank.github.io\/posts\/microservices-protobuf\/","datePublished":"2022-06-15T12:10:00+08:00","dateModified":"2022-06-16T17:58:21+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Yusank"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':'auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark')&&document.body.setAttribute('theme','dark')</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Yusank`s Site"><img class="lazyload logo" src=/svg/loading.min.svg data-src=https://yusank.github.io/images/logo.svg data-srcset="https://yusank.github.io/images/logo.svg, https://yusank.github.io/images/logo.svg 1.5x, https://yusank.github.io/images/logo.svg 2x" data-sizes=auto alt=https://yusank.github.io/images/logo.svg title=https://yusank.github.io/images/logo.svg><span id=id-1 class=typeit></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>æ–‡ç«  </a><a class=menu-item href=/categories/>åˆ†ç±» </a><a class=menu-item href=/tags/>æ ‡ç­¾ </a><a class=menu-item href=/about/>å…³äº </a><a class=menu-item href=/links/>å‹é“¾ </a><a class=menu-item href=https://github.com/yusank title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw'></i> </a><a class=menu-item href=https://go-goim.github.io title=GoIM rel="noopener noreffer" target=_blank><i class='far fa-share-square'></i> GoIM </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title=åˆ‡æ¢ä¸»é¢˜>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Yusank`s Site"><img class="lazyload logo" src=/svg/loading.min.svg data-src=https://yusank.github.io/images/logo.svg data-srcset="https://yusank.github.io/images/logo.svg, https://yusank.github.io/images/logo.svg 1.5x, https://yusank.github.io/images/logo.svg 2x" data-sizes=auto alt=https://yusank.github.io/images/logo.svg title=https://yusank.github.io/images/logo.svg><span id=id-2 class=typeit></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>æ–‡ç« </a><a class=menu-item href=/categories/ title>åˆ†ç±»</a><a class=menu-item href=/tags/ title>æ ‡ç­¾</a><a class=menu-item href=/about/ title>å…³äº</a><a class=menu-item href=/links/ title>å‹é“¾</a><a class=menu-item href=https://github.com/yusank title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw'></i></a><a class=menu-item href=https://go-goim.github.io title=GoIM rel="noopener noreffer" target=_blank><i class='far fa-share-square'></i>GoIM</a><a href=javascript:void(0); class="menu-item theme-switch" title=åˆ‡æ¢ä¸»é¢˜>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>ç›®å½•</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">[ç³»åˆ—]å¾®æœåŠ¡Â·å¦‚ä½•é€šè¿‡ protobuf å®šä¹‰æ•°æ®å’ŒæœåŠ¡</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://github.com/yusank title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Yusank</a></span>&nbsp;<span class=post-category>æ”¶å½•äº <a href=/categories/microservice/><i class="far fa-folder fa-fw" aria-hidden=true></i>microservice</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2022-06-15>2022-06-15</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;çº¦ 6022 å­—&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;é¢„è®¡é˜…è¯» 13 åˆ†é’Ÿ&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>ç›®å½•</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#1-å‰è¨€>1. å‰è¨€</a></li><li><a href=#2-æ•°æ®å®šä¹‰>2. æ•°æ®å®šä¹‰</a><ul><li><a href=#21-åŸºç¡€ç”¨æ³•>2.1 åŸºç¡€ç”¨æ³•</a><ul><li><a href=#211-æšä¸¾>2.1.1 æšä¸¾</a></li><li><a href=#212-æ¶ˆæ¯>2.1.2 æ¶ˆæ¯</a></li></ul></li><li><a href=#22-é«˜çº§ç©æ³•>2.2 é«˜çº§ç©æ³•</a><ul><li><a href=#221-ç»„åˆä½¿ç”¨>2.2.1 ç»„åˆä½¿ç”¨</a></li><li><a href=#222-é¡¹ç›®å†…-proto-çš„å¼•ç”¨>2.2.2 é¡¹ç›®å†… proto çš„å¼•ç”¨</a></li><li><a href=#223-å¼•ç”¨ç¬¬ä¸‰æ–¹åŒ…>2.2.3 å¼•ç”¨ç¬¬ä¸‰æ–¹åŒ…</a></li></ul></li><li><a href=#23-æ¶ˆæ¯æ ¡éªŒ>2.3 æ¶ˆæ¯æ ¡éªŒ</a><ul><li><a href=#231-åŸºç¡€ç±»å‹>2.3.1 åŸºç¡€ç±»å‹</a></li><li><a href=#232-é«˜çº§ç±»å‹>2.3.2 é«˜çº§ç±»å‹</a></li><li><a href=#233-æ‰©å±•ç±»å‹>2.3.3 æ‰©å±•ç±»å‹</a></li></ul></li></ul></li><li><a href=#3-æœåŠ¡å®šä¹‰>3. æœåŠ¡å®šä¹‰</a><ul><li><a href=#31-å¸¸è§„æœåŠ¡å®šä¹‰>3.1 å¸¸è§„æœåŠ¡å®šä¹‰</a></li><li><a href=#32-stream-æµæœåŠ¡å®šä¹‰>3.2 stream æµæœåŠ¡å®šä¹‰</a></li><li><a href=#33-æœåŠ¡å®šä¹‰ä¸­åµŒå¥—-http-å®šä¹‰>3.3 æœåŠ¡å®šä¹‰ä¸­åµŒå¥— http å®šä¹‰</a></li></ul></li><li><a href=#4-æ€»ç»“>4. æ€»ç»“</a></li><li><a href=#5-é“¾æ¥>5. é“¾æ¥ğŸ”—</a></li></ul></nav></div></div><div class=content id=content><blockquote><p>æœ¬æ–‡ä¸ºç³»åˆ—ç¯‡<code>å¾®æœåŠ¡</code>çš„å…³äº protobuf å®šä¹‰æ•°æ®å’ŒæœåŠ¡çš„æ–‡ç« ã€‚æœ¬ç¯‡å°†ä¼šä»‹ç»å¦‚ä½•é€šè¿‡ pb å®šä¹‰æ•°æ®ç»“æ„å’ŒæœåŠ¡ä»¥åŠ pb çš„ä¸€äº›å¦ç±»ç©æ³•ã€‚</p></blockquote><h2 id=1-å‰è¨€>1. å‰è¨€</h2><div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw" aria-hidden=true></i>Definition by Google<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content><p>â€‚â€‚Protocol buffers provide a language-neutral, platform-neutral, extensible mechanism for serializing structured data in a forward-compatible and backward-compatible way. Itâ€™s like JSON, except it&rsquo;s smaller and faster, and it generates native language bindings.</p><p>â€‚â€‚Protocol buffers are a combination of the definition language (created in .proto files), the code that the proto compiler generates to interface with data, language-specific runtime libraries, and the serialization format for data that is written to a file (or sent across a network connection).</p></div></div></div><p><code>Protocol buffer</code>(ä¸‹é¢ä½¿ç”¨ pb æ¥ä»£æ›¿) æ˜¯ä¸€ä¸ª æ¥å£å®šä¹‰è¯­è¨€(<code>Interface Definition Language -- IDL</code>)å’Œæ¶ˆæ¯ç¼–ç æ ¼å¼ã€‚æ—¨åœ¨æä¾›ä¸€ç§ç®€å•ã€æ˜“äºä½¿ç”¨ã€å¯æ‰©å±•çš„æ–¹å¼æ¥å®šä¹‰æ•°æ®ç»“æ„å’ŒæœåŠ¡ã€‚pb æ˜¯ä¸€ç§çº¯æ–‡æœ¬æ ¼å¼ï¼Œè€Œå…¶å†…éƒ¨æ˜¯çº¯äºŒè¿›åˆ¶æ ¼å¼ï¼Œæ¯”å…¶ä»–ç¼–ç æ ¼å¼(å¦‚ï¼šjsonï¼Œxml)æ›´åŠ ç²¾ç‚¼ã€‚pb åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªæ¶ˆæ¯ç±»å‹ï¼Œæ¯ä¸ªæ¶ˆæ¯ç±»å‹åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªå­—æ®µã€‚å…¶ä¸»è¦ç‰¹æ€§ä¸ºï¼š</p><ul><li>ç¼–ç é€Ÿåº¦å¿«</li><li>ç¼–ç åæ•°æ®æ›´å°</li><li>æ ¹æ® pb ç”Ÿæˆå„ä¸ªè¯­è¨€ä»£ç (æœ¬æ–‡ä»¥ Go ä¸ºä¾‹)</li><li>æ”¯æŒç±»å‹å®šä¹‰</li><li>æ”¯æŒå®šä¹‰æœåŠ¡</li><li>è¯­æ³•ç®€å•</li></ul><p>è€Œ <code>gRPC</code> ä½œä¸º Google æ¨å‡ºçš„ rpc åè®®ï¼Œå°† pb ä½œä¸ºé»˜è®¤çš„æ•°æ®ä¼ è¾“æ ¼å¼ï¼Œä¹Ÿè¯´æ˜äº† pb ä½œä¸ºæ¶ˆæ¯ç¼–ç æ ¼å¼çš„ä¼˜ç§€æ€§ã€‚</p><div class="details admonition question open"><div class="details-summary admonition-title"><i class="icon fas fa-question-circle fa-fw" aria-hidden=true></i>Pb è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content><ol><li>pb æä¾›åºåˆ—åŒ–çš„æ¶ˆæ¯æ ¼å¼å®šä¹‰ï¼Œé€‚ç”¨äºçŸ­è¿æ¥å’Œé•¿è¿æ¥</li><li>é€‚ç”¨äºå¾®æœåŠ¡ä¸­æœåŠ¡ä¹‹é—´é€šä¿¡å’Œæ•°æ®è½ç›˜</li><li>æ¶ˆæ¯æ ¼å¼ç”±æœåŠ¡æä¾›è€…å®šä¹‰ï¼Œè€Œä½¿ç”¨è€…å¯æ ¹æ®è‡ªèº«æ¡ä»¶ç”Ÿæˆä¸åŒè¯­è¨€çš„ä»£ç ï¼Œå…å»ç¼–ç å’Œè§£ç çš„å·¥ä½œå’Œå…¶ä¸­å¯èƒ½å‡ºç°å„ç±»é—®é¢˜</li><li>æ¶ˆæ¯å®šä¹‰å¯ä»¥éšæ—¶ä¿®æ”¹ï¼Œè€Œä¸ä¼šå½±å“ä½¿ç”¨è€…çš„ä»£ç ï¼Œä½¿ç”¨è€…åªéœ€è¦ä¿æŒæœ€æ–°çš„ pb æ–‡ä»¶å³å¯</li></ol></div></div></div><p>ä¸‹é¢æˆ‘ä»¬ä»ç®€å•åˆ°å¤æ‚çš„ä»‹ç»ï¼Œå¦‚ä½•ä½¿ç”¨ pb å®šä¹‰æ•°æ®ç»“æ„å’ŒæœåŠ¡ã€‚</p><h2 id=2-æ•°æ®å®šä¹‰>2. æ•°æ®å®šä¹‰</h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦çœ‹ä¸€ä¸‹ pb æ”¯æŒçš„æ•°æ®ç±»å‹æœ‰å“ªäº›ï¼Œä»¥åŠè¿™äº›æ•°æ®ç±»å‹ç”Ÿæˆçš„ä»£ç ä¸­çš„ç±»å‹çš„å¯¹ç…§ã€‚</p><table><thead><tr><th style=text-align:left>Pb</th><th style=text-align:left>Go</th></tr></thead><tbody><tr><td style=text-align:left>double</td><td style=text-align:left>float64</td></tr><tr><td style=text-align:left>float</td><td style=text-align:left>float32</td></tr><tr><td style=text-align:left>int32</td><td style=text-align:left>int32</td></tr><tr><td style=text-align:left>int64</td><td style=text-align:left>int64</td></tr><tr><td style=text-align:left>uint32</td><td style=text-align:left>uint32</td></tr><tr><td style=text-align:left>uint64</td><td style=text-align:left>uint64</td></tr><tr><td style=text-align:left>sint32</td><td style=text-align:left>int32</td></tr><tr><td style=text-align:left>sint64</td><td style=text-align:left>int64</td></tr><tr><td style=text-align:left>fixed32</td><td style=text-align:left>uint32</td></tr><tr><td style=text-align:left>fixed64</td><td style=text-align:left>uint64</td></tr><tr><td style=text-align:left>sfixed32</td><td style=text-align:left>int32</td></tr><tr><td style=text-align:left>sfixed64</td><td style=text-align:left>int64</td></tr><tr><td style=text-align:left>bool</td><td style=text-align:left>bool</td></tr><tr><td style=text-align:left>string</td><td style=text-align:left>string</td></tr><tr><td style=text-align:left>bytes</td><td style=text-align:left>[]byte</td></tr><tr><td style=text-align:left>map</td><td style=text-align:left>map</td></tr><tr><td style=text-align:left>enum</td><td style=text-align:left>int32</td></tr><tr><td style=text-align:left>message</td><td style=text-align:left>struct</td></tr></tbody></table><p>å¯ä»¥çœ‹å‡º pb å®šä¹‰çš„æ•°æ®ç±»å‹å‡ ä¹ä¸å¤§éƒ¨åˆ†ç¼–ç¨‹è¯­è¨€å¾ˆç›¸ä¼¼ï¼Œå› æ­¤å…¥é—¨ pb çš„é—¨å£å¯ä»¥è¯´æ˜¯å¾ˆä½ã€‚</p><h3 id=21-åŸºç¡€ç”¨æ³•>2.1 åŸºç¡€ç”¨æ³•</h3><p>ä¸‹é¢åˆ†åˆ«ä»¥æšä¸¾å’Œæ¶ˆæ¯çš„è§’åº¦ï¼Œæ¥ä»‹ç» pb çš„åŸºæœ¬ç”¨æ³•ã€‚</p><div class="details admonition warning open"><div class="details-summary admonition-title"><i class="icon fas fa-exclamation-triangle fa-fw" aria-hidden=true></i>æ³¨æ„<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content><ol><li>ä¸‹é¢æ‰€æœ‰æåˆ°çš„ pb å®šä¹‰å‡æ˜¯ä»¥ <code>proto3</code>ä¸ºå‡†ï¼Œæœ¬æ–‡ä¸è®¨è®º <code>proto2</code> ä»¥åŠ <code>proto2</code> ä¸ <code>proto3</code> çš„åŒºåˆ«ã€‚</li><li>ä¸‹é¢æåˆ°çš„ä»£ç ç”Ÿæˆè§„åˆ™å‡æ˜¯åŸºäº <code>Go è¯­è¨€</code>ç‰ˆæœ¬çš„ï¼Œä¸”ç»è¿‡æœ¬äººæµ‹è¯•éªŒè¯ï¼Œä½†æ˜¯<strong>ä¸ä¼šå¯¹å…¶ä»–è¯­è¨€ç”Ÿæˆä»£ç è§„åˆ™åšä»»ä½•ä¿è¯ã€‚</strong></li><li>å†™æœ¬æ–‡æ—¶ï¼Œä½¿ç”¨çš„å·¥å…·ç‰ˆæœ¬å¦‚ä¸‹ï¼š<ol><li><code>protoc --version</code> :<code>libprotoc 3.19.4</code></li><li><code>protoc-gen-go</code> : <code>v1.28.0</code></li></ol></li></ol></div></div></div><p>åœ¨å®šä¹‰æ•°æ®ä¹‹å‰ï¼Œå…ˆè¯´ä¸€ä¸‹ <code>.proto</code> æ–‡ä»¶çš„å¤´éƒ¨è§„åˆ™ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-proto data-lang=proto><span class=line><span class=cl><span class=n>syntax</span> <span class=o>=</span> <span class=s>&#34;proto3&#34;</span><span class=p>;</span> <span class=c1>// è¡¨ç¤ºä½¿ç”¨ proto3 çš„è¯­æ³•
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c1>// åŒ…åï¼Œå¦‚æœå…¶ä»– proto æ–‡ä»¶å¼•ç”¨è¯¥æ–‡ä»¶æ—¶ï¼Œä½¿ç”¨è¯¥å€¼å»å¼•ç”¨ï¼Œ å¦‚ï¼š
</span></span></span><span class=line><span class=cl><span class=c1>//  import &#34;api.user.v1.proto&#34;;
</span></span></span><span class=line><span class=cl><span class=c1>//  message xxx {
</span></span></span><span class=line><span class=cl><span class=c1>//    api.user.v1.Person person= 1;
</span></span></span><span class=line><span class=cl><span class=c1>//    ...
</span></span></span><span class=line><span class=cl><span class=c1>//  } 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kn>package</span> <span class=nn>api</span><span class=o>.</span><span class=n>user.v1</span><span class=p>;</span> <span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c1>// go çš„åŒ…åï¼Œå¯ä»¥æ ¹æ®åœ¨å½“å‰é¡¹ç›®çš„è·¯å¾„å®šä¹‰ï¼Œéœ€è¦æ³¨æ„çš„æ—¶ï¼Œå¦‚æœå…¶ä»–åŒ…å¼•å…¥å½“å‰ proto æ–‡ä»¶ï¼Œ
</span></span></span><span class=line><span class=cl><span class=c1>// åˆ™å…¶ä»– proto æ–‡ä»¶ç”Ÿæˆ go ä»£ç æ—¶ï¼Œä¼šä»¥ go_package ä½œä¸ºåŒ…åŒ…åå¼•å…¥ä½¿ç”¨,å› æ­¤å¦‚æœå½“å‰é¡¹ç›®çš„ proto æ–‡ä»¶ä¼šè¢«å…¶ä»–é¡¹ç›®å¼•å…¥
</span></span></span><span class=line><span class=cl><span class=c1>// æˆ–è€… é¡¹ç›®åŒ…åæ˜¯ä»¥ github.com/xx/xx çš„æ–¹å¼å®šä¹‰ï¼Œé‚£è¿™é‡Œä¹ŸæŒ‰è¿™ä¸ªæ ¼å¼å®šä¹‰å®Œæ•´çš„è·¯å¾„
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>option</span> <span class=n>go_package</span> <span class=o>=</span> <span class=s>&#34;api/user/v1&#34;</span><span class=p>;</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=211-æšä¸¾>2.1.1 æšä¸¾</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-proto data-lang=proto><span class=line><span class=cl><span class=kd>enum</span> <span class=n>Sex</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=n>Unknown</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=n>Male</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=n>Female</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=n>Other</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=n>Alien</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>ä¸Šé¢æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªæšä¸¾ç±»å‹(<code>enum</code>) <code>Sex</code> ï¼Œå¹¶å®šä¹‰äº†å‡ ä¸ªæšä¸¾å€¼ã€‚è¿™ä¸ªæšä¸¾ç±»å‹å¯ä»¥ä½œä¸ºä¸€ä¸ªæ•°æ®ç±»å‹ï¼Œå¯ä»¥åœ¨å½“å‰ proto æ–‡ä»¶å†…è¢«å¼•ç”¨ã€‚å®šä¹‰ä½¿ç”¨æšä¸¾æœ‰å‡ ç‚¹éœ€è¦æ³¨æ„ï¼š</p><ol><li>æšä¸¾çš„å€¼åªèƒ½æ˜¯æ•´æ•°</li><li>æšä¸¾å€¼ä¸èƒ½é‡å¤</li><li>æšä¸¾çš„ç¬¬ä¸€ä¸ªå…ƒç´ çš„å€¼å¿…éœ€æ˜¯ 0ï¼Œä¸”ä¸èƒ½ä¸å®šä¹‰</li><li>ä»ç¬¬äºŒä¸ªå…ƒç´ å¼€å§‹ï¼Œå…¶å€¼å¯ä»¥ä¸ºä»»æ„æ•´æ•°ï¼Œä¸éœ€è¦ä¸¥æ ¼çš„é€’å¢ï¼Œç”šè‡³å¯ä»¥å®šä¹‰ä¸ºè´Ÿæ•°</li></ol><p>é€šè¿‡ <code>protoc</code> å‘½ä»¤è¡Œå·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ® <code>.proto</code> æ–‡ä»¶ä¸åŒè¯­è¨€çš„ä»£ç ï¼Œä¸‹é¢æ˜¯æ ¹æ®ä¸Šè¿°å®šä¹‰çš„æšä¸¾å€¼ç”Ÿæˆçš„ä»£ç ä¸€éƒ¨åˆ†ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Sex</span> <span class=kt>int32</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>Sex_Unknown</span> <span class=nx>Sex</span> <span class=p>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>  <span class=nx>Sex_Male</span>    <span class=nx>Sex</span> <span class=p>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>  <span class=nx>Sex_Female</span>  <span class=nx>Sex</span> <span class=p>=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>  <span class=nx>Sex_Other</span>   <span class=nx>Sex</span> <span class=p>=</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>  <span class=nx>Sex_Alien</span>   <span class=nx>Sex</span> <span class=p>=</span> <span class=o>-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Enum value maps for Sex.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>Sex_name</span> <span class=p>=</span> <span class=kd>map</span><span class=p>[</span><span class=kt>int32</span><span class=p>]</span><span class=kt>string</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=mi>0</span><span class=p>:</span>  <span class=s>&#34;Unknown&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mi>1</span><span class=p>:</span>  <span class=s>&#34;Male&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mi>2</span><span class=p>:</span>  <span class=s>&#34;Female&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mi>3</span><span class=p>:</span>  <span class=s>&#34;Other&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=o>-</span><span class=mi>1</span><span class=p>:</span> <span class=s>&#34;Alien&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>Sex_value</span> <span class=p>=</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>int32</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;Unknown&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;Male&#34;</span><span class=p>:</span>    <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;Female&#34;</span><span class=p>:</span>  <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;Other&#34;</span><span class=p>:</span>   <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;Alien&#34;</span><span class=p>:</span>   <span class=o>-</span><span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// è¿˜ä¼šç”Ÿæˆ Sex çš„ String() Type() ç­‰æ–¹æ³•ï¼Œè¿™é‡Œå¿½ç•¥ä¸è´´ä»£ç äº†
</span></span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°å®šä¹‰ <code>const</code> ç±»å‹å’Œå€¼ä¹‹å¤–ï¼Œè¿˜ä¼šç”Ÿæˆä¸¤ä¸ª mapï¼Œæšä¸¾çš„åå­—å’Œå€¼å¯äº’ç›¸è½¬æ¢ã€‚è¿™é‡Œä¹Ÿå¯ä»¥æ›´åŠ ç¡®å®šä¸ºä»€ä¹ˆæšä¸¾å€¼ä¸èƒ½é‡å¤çš„åŸå› äº†ã€‚</p><h4 id=212-æ¶ˆæ¯>2.1.2 æ¶ˆæ¯</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-proto data-lang=proto><span class=line><span class=cl><span class=kd>message</span> <span class=nc>Person</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kt>string</span> <span class=n>name</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=n>Sex</span> <span class=n>sex</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kt>int32</span> <span class=n>age</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kt>float</span> <span class=n>score</span> <span class=o>=</span> <span class=mi>4</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=n>map</span><span class=p>&lt;</span><span class=kt>string</span><span class=p>,</span><span class=kt>bytes</span><span class=p>&gt;</span> <span class=n>extra_data</span> <span class=o>=</span> <span class=mi>5</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªç®€å•çš„æ¶ˆæ¯(<code>message</code>)ä¸º <code>Person</code> å¹¶ä¸”åŒ…å«äº†ä¸Šé¢å®šä¹‰çš„æšä¸¾å€¼ã€‚å®šä¹‰æ¶ˆæ¯ä¹Ÿæ˜¯æœ‰ä¸€å¥—è‡ªå·±çš„è§„åˆ™ï¼š</p><ol><li>æ¶ˆæ¯çš„åå­—å¿…é¡»ä»¥å­—æ¯å¼€å¤´ï¼Œåé¢å¯ä»¥è·Ÿå­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ï¼Œä¸”å¤§å°å†™ä¸æ˜æ„Ÿï¼Œç”Ÿæˆçš„ä»£ç ä¸­ä¼šè‡ªåŠ¨å°†æ¶ˆæ¯åå­—è½¬æ¢ä¸ºå¤§å†™</li><li>æ¶ˆæ¯å­—æ®µå®šä¹‰æ˜¯ï¼Œå…ˆæŒ‡å®šç±»å‹ï¼Œå†æŒ‡å®šå­—æ®µåï¼Œæœ€åéœ€è¦æŒ‡å®šç´¢å¼•å€¼</li><li>æ¶ˆæ¯ç´¢å¼•å€¼å¿…é¡»æ˜¯æ•´æ•°ï¼Œä¸”ä¸é‡å¤å³å¯ï¼Œæ— éœ€è¦ä¸¥æ ¼çš„é€’å¢</li><li>æ¶ˆæ¯å­—æ®µåå¯ä»¥æ˜¯<code>å°å†™</code> æˆ– <code>snake case</code>,ç”Ÿæˆçš„ä»£ç ä¼šè½¬æ¢æˆé¦–å­—æ¯å¤§å†™çš„ <code>Camel Case</code></li></ol><p>ä¸‹é¢çœ‹ä¸€ä¸‹åŸºäºè¿™ä¸ªæ¶ˆæ¯ç»“æ„ç”Ÿæˆçš„ä»£ç ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Person</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>state</span>         <span class=nx>protoimpl</span><span class=p>.</span><span class=nx>MessageState</span>
</span></span><span class=line><span class=cl>  <span class=nx>sizeCache</span>     <span class=nx>protoimpl</span><span class=p>.</span><span class=nx>SizeCache</span>
</span></span><span class=line><span class=cl>  <span class=nx>unknownFields</span> <span class=nx>protoimpl</span><span class=p>.</span><span class=nx>UnknownFields</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>Name</span>      <span class=kt>string</span>            <span class=s>`protobuf:&#34;bytes,1,opt,name=name,proto3&#34; json:&#34;name,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>  <span class=nx>Sex</span>       <span class=nx>Sex</span>               <span class=s>`protobuf:&#34;varint,3,opt,name=sex,proto3,enum=api.user.session.v1.Sex&#34; json:&#34;sex,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>  <span class=nx>Age</span>       <span class=kt>int32</span>             <span class=s>`protobuf:&#34;varint,2,opt,name=age,proto3&#34; json:&#34;age,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>  <span class=nx>Score</span>     <span class=kt>float32</span>           <span class=s>`protobuf:&#34;fixed32,4,opt,name=score,proto3&#34; json:&#34;score,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>  <span class=nx>ExtraData</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>][]</span><span class=kt>byte</span> <span class=s>`protobuf:&#34;bytes,5,rep,name=extra_data,json=extraData,proto3&#34; json:&#34;extra_data,omitempty&#34; protobuf_key:&#34;bytes,1,opt,name=key,proto3&#34; protobuf_val:&#34;bytes,2,opt,name=value,proto3&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// åŒæ—¶ä¼šç”Ÿæˆä¸€å †æ–¹æ³•ï¼Œè¿™é‡Œå¿½ç•¥ä¸è´´ä»£ç äº†
</span></span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œæ¶ˆæ¯ä¼šç”Ÿæˆä¸€ä¸ªç»“æ„ä½“ï¼Œå¹¶æ¯ä¸ªå­—æ®µéƒ½ä¼šå¸¦ä¸Š <code>protobuf</code> å’Œ <code>json</code> çš„ tagï¼Œæ–¹ä¾¿åºåˆ—åŒ–æ›´æ–¹ä¾¿ã€‚<code>protobuf</code> tag ä¼šè¯¦ç»†è®°å½•å­—æ®µçš„åœ¨ <code>proto</code> æ–‡ä»¶å®šä¹‰çš„åå­—ï¼Œç´¢å¼•å€¼ã€proto ç‰ˆæœ¬ç­‰ä¿¡æ¯ï¼Œç”¨äºç¼–ç å’Œè§£ç ã€‚è€Œ <code>json</code> tag ä»…è®°å½•å­—æ®µåã€‚</p><h3 id=22-é«˜çº§ç©æ³•>2.2 é«˜çº§ç©æ³•</h3><h4 id=221-ç»„åˆä½¿ç”¨>2.2.1 ç»„åˆä½¿ç”¨</h4><p>ä¸Šé¢å®šä¹‰äº†äº›ç®€å•çš„ä½¿ç”¨æ–¹å¼ï¼Œä½†æ˜¯å®é™…å¼€å‘è¿‡ç¨‹ä¸­éœ€è¦æ›´å¤æ‚çš„åœºæ™¯ï¼Œä¸‹é¢æˆ‘ä»¬ä»¥ä¸€ä¸ªæ¯”è¾ƒå¤æ‚çš„åœºæ™¯ä¸ºä¾‹ï¼Œè®²è§£å¦‚ä½•å®šä¹‰å¤æ‚çš„æ¶ˆæ¯ç±»å‹ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-proto data-lang=proto><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>enum</span> <span class=n>Sex</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=n>Unknown</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=n>Male</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=n>Female</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=n>Other</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=n>Alien</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>School</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kt>string</span> <span class=n>name</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kt>string</span> <span class=n>grade</span>  <span class=o>=</span> <span class=mi>2</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kt>int64</span> <span class=n>graduated_at</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=k>repeated</span> <span class=kt>string</span> <span class=n>teachers</span> <span class=o>=</span> <span class=mi>4</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>Person</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=k>optional</span> <span class=kt>string</span> <span class=n>name</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=n>Sex</span> <span class=n>sex</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kt>int32</span> <span class=n>age</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kt>float</span> <span class=n>score</span> <span class=o>=</span> <span class=mi>4</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=n>map</span><span class=p>&lt;</span><span class=kt>string</span><span class=p>,</span><span class=kt>bytes</span><span class=p>&gt;</span> <span class=n>extra_data</span> <span class=o>=</span> <span class=mi>5</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=k>repeated</span> <span class=n>School</span> <span class=n>schools</span> <span class=o>=</span> <span class=mi>6</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=k>oneof</span> <span class=n>contact</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=n>email</span> <span class=o>=</span> <span class=mi>7</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=n>phone</span> <span class=o>=</span> <span class=mi>8</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kd>message</span> <span class=nc>Company</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=n>name</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=n>address</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>int32</span> <span class=n>salary</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=k>repeated</span> <span class=kt>string</span> <span class=n>employees</span> <span class=o>=</span> <span class=mi>4</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=n>Company</span> <span class=n>company</span> <span class=o>=</span> <span class=mi>9</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>åœ¨ä¹‹å‰çš„ <code>Person</code> åŸºç¡€ä¸Šåšäº†ä¸€ä¸ªæ›´å¤æ‚çš„æ¶ˆæ¯ç»“æ„ï¼Œæ–°å¢äº†<code>å­¦æ ¡</code>ã€<code>è”ç³»æ–¹å¼</code>ã€<code>å…¬å¸</code>ä¸‰ä¸ªå­—æ®µï¼Œå¹¶ä¸”å„ä¸ªå­—æ®µçš„ç±»å‹å¹¶ä¸ç›¸åŒï¼Œä¸‹é¢ä¸€ä¸ªä¸ªè¿›è¡Œè®²è§£ã€‚</p><p><strong>school</strong> è¿™ä¸ªå­—æ®µå¼•å…¥äº†ä¸¤ä¸ªç‰¹æ€§ï¼Œç¬¬ä¸€ä¸ªæ˜¯ <code>repeated</code> ï¼Œè¡¨ç¤ºè¿™ä¸ªå­—æ®µæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œè€Œæ•°ç»„çš„å…ƒç´ ç±»å‹å°±æ˜¯ <code>repeated</code> ä¹‹åçš„å€¼ <code>School</code>ã€‚ç¬¬äºŒä¸ªç‰¹æ€§æ˜¯æ¶ˆæ¯çš„åµŒå¥—ï¼Œå¯ä»¥çœ‹åˆ°ä¸Šé¢å·²ç»å®šä¹‰äº†ä¸€ä¸ª <code>School</code> çš„æ¶ˆæ¯ï¼Œç„¶ååœ¨<code>Person</code> æ¶ˆæ¯å†…åµŒå¥—ä½¿ç”¨ã€‚</p><p><strong>contact</strong> è¿™ä¸ªå­—æ®µå¼•å…¥äº† <code>oneof</code> è¿™ä¸ªç‰¹æ€§ï¼Œ<code>oneof</code> å¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ª <code>switch</code> çš„è¯­å¥ï¼Œå®ƒçš„ä½œç”¨æ˜¯æ ¹æ® <code>contact</code> å­—æ®µçš„å€¼ï¼Œæ¥é€‰æ‹©ä½¿ç”¨å“ªä¸ªå­—æ®µã€‚ä½ å¯ä»¥èµ‹å€¼ <code>email</code> ä¹Ÿå¯ä»¥èµ‹å€¼ <code>phone</code> æˆ–è€…å‡ä¸èµ‹å€¼ï¼Œåœ¨ç”Ÿæˆçš„ä»£ç é‡Œï¼Œæ˜¯æœ‰ <code>GetEmail()</code>, <code>GetPhone</code> æ–¹æ³•æ¥è·å–è¿™ä¸ªå­—æ®µçš„å€¼ã€‚</p><p><strong>company</strong> å­—æ®µå¼•å…¥äº†ä¸€ä¸ªç‰¹æ€§ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥åœ¨æ¶ˆæ¯å†…å®šä¹‰å¦ä¸€ä¸ªæ¶ˆæ¯å¹¶ç”¨åœ¨æŸä¸ªå­—æ®µä¸Šã€‚æœ€ç»ˆç”Ÿæˆçš„ä»£ç é‡Œä¼šæœ‰ä¸€ä¸ª <code>Person_Company</code> çš„ç»“æ„ä½“ï¼Œè¡¨ç¤ºè¿™ä¸ªç»“æ„ä½“å±äº <code>Person</code>.</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œ <code>name</code> å­—æ®µä¹ŸåŠ äº†ä¸€ä¸ª <code>option</code> çš„æ ‡è¯†ï¼Œåœ¨ç”Ÿæˆä»£ç æ—¶ä¼šç”Ÿæˆ <code>*string</code> çš„ç±»å‹ï¼Œå¯ä»¥åŒºåˆ†nil å’Œç©ºå€¼ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹ï¼Œç”Ÿæˆçš„ä»£ç ï¼ˆä»…å±•ç°æ ¸å¿ƒéƒ¨åˆ†,å¿½ç•¥å…¶ä»–æ— å…³éƒ¨åˆ†ï¼‰ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>School</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...ignored...
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>Name</span>        <span class=kt>string</span>   <span class=s>`protobuf:&#34;bytes,1,opt,name=name,proto3&#34; json:&#34;name,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>  <span class=nx>Grade</span>       <span class=kt>string</span>   <span class=s>`protobuf:&#34;bytes,2,opt,name=grade,proto3&#34; json:&#34;grade,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>  <span class=nx>GraduatedAt</span> <span class=kt>int64</span>    <span class=s>`protobuf:&#34;varint,3,opt,name=graduated_at,json=graduatedAt,proto3&#34; json:&#34;graduated_at,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>  <span class=nx>Teachers</span>    <span class=p>[]</span><span class=kt>string</span> <span class=s>`protobuf:&#34;bytes,4,rep,name=teachers,proto3&#34; json:&#34;teachers,omitempty&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Person</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...ignored...
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>Name</span>      <span class=o>*</span><span class=kt>string</span>           <span class=s>`protobuf:&#34;bytes,1,opt,name=name,proto3,oneof&#34; json:&#34;name,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>  <span class=nx>Sex</span>       <span class=nx>Sex</span>               <span class=s>`protobuf:&#34;varint,3,opt,name=sex,proto3,enum=api.user.session.v1.Sex&#34; json:&#34;sex,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>  <span class=nx>Age</span>       <span class=kt>int32</span>             <span class=s>`protobuf:&#34;varint,2,opt,name=age,proto3&#34; json:&#34;age,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>  <span class=nx>Score</span>     <span class=kt>float32</span>           <span class=s>`protobuf:&#34;fixed32,4,opt,name=score,proto3&#34; json:&#34;score,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>  <span class=nx>ExtraData</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>][]</span><span class=kt>byte</span> <span class=s>`protobuf:&#34;bytes,5,rep,name=extra_data,json=extraData,proto3&#34; json:&#34;extra_data,omitempty&#34; protobuf_key:&#34;bytes,1,opt,name=key,proto3&#34; protobuf_val:&#34;bytes,2,opt,name=value,proto3&#34;`</span>
</span></span><span class=line><span class=cl>  <span class=nx>Schools</span>   <span class=p>[]</span><span class=o>*</span><span class=nx>School</span>         <span class=s>`protobuf:&#34;bytes,6,rep,name=schools,proto3&#34; json:&#34;schools,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Types that are assignable to Contact:
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// *Person_Email
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// *Person_Phone
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>Contact</span> <span class=nx>isPerson_Contact</span> <span class=s>`protobuf_oneof:&#34;contact&#34;`</span> <span class=c1>// æ³¨æ„è¿™ä¸ªå­—æ®µ
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>Company</span> <span class=o>*</span><span class=nx>Person_Company</span>  <span class=s>`protobuf:&#34;bytes,9,opt,name=company,proto3&#34; json:&#34;company,omitempty&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>isPerson_Contact</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nf>isPerson_Contact</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Person_Email</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Email</span> <span class=kt>string</span> <span class=s>`protobuf:&#34;bytes,7,opt,name=email,proto3,oneof&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Person_Phone</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Phone</span> <span class=kt>string</span> <span class=s>`protobuf:&#34;bytes,8,opt,name=phone,proto3,oneof&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=o>*</span><span class=nx>Person_Email</span><span class=p>)</span> <span class=nf>isPerson_Contact</span><span class=p>()</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=o>*</span><span class=nx>Person_Phone</span><span class=p>)</span> <span class=nf>isPerson_Contact</span><span class=p>()</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Person_Company</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...ignored...
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>Name</span>      <span class=kt>string</span>   <span class=s>`protobuf:&#34;bytes,1,opt,name=name,proto3&#34; json:&#34;name,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>  <span class=nx>Address</span>   <span class=kt>string</span>   <span class=s>`protobuf:&#34;bytes,2,opt,name=address,proto3&#34; json:&#34;address,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>  <span class=nx>Salary</span>    <span class=kt>int32</span>    <span class=s>`protobuf:&#34;varint,3,opt,name=salary,proto3&#34; json:&#34;salary,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>  <span class=nx>Employees</span> <span class=p>[]</span><span class=kt>string</span> <span class=s>`protobuf:&#34;bytes,4,rep,name=employees,proto3&#34; json:&#34;employees,omitempty&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><div class="details admonition tip open"><div class="details-summary admonition-title"><i class="icon fas fa-lightbulb fa-fw" aria-hidden=true></i>å…³äº oneof<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content><p>éœ€è¦æ³¨æ„çš„æ—¶ä¸Šé¢ç”Ÿæˆçš„ contact çš„å­—æ®µå€¼ <code>isPerson_Contact</code> æ˜¯ä¸€ä¸ªæ¥å£å®šä¹‰ï¼Œå®ƒçš„å®ç°æ˜¯ <code>Person_Email</code> å’Œ <code>Person_Phone</code> ä¸¤ä¸ªç»“æ„ä½“ã€‚
è€Œ <code>Person</code> ç»“æ„ä¼šåŒæ—¶ç”Ÿæˆä¸€ä¸‹ä»£ç ï¼Œä»è€Œå®ç°äº† <code>oneof</code> çš„åŠŸèƒ½ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>m</span> <span class=o>*</span><span class=nx>Person</span><span class=p>)</span> <span class=nf>GetContact</span><span class=p>()</span> <span class=nx>isPerson_Contact</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>m</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>m</span><span class=p>.</span><span class=nx>Contact</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>x</span> <span class=o>*</span><span class=nx>Person</span><span class=p>)</span> <span class=nf>GetEmail</span><span class=p>()</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>x</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>x</span><span class=p>.</span><span class=nf>GetContact</span><span class=p>().(</span><span class=o>*</span><span class=nx>Person_Email</span><span class=p>);</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>x</span><span class=p>.</span><span class=nx>Email</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=s>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>x</span> <span class=o>*</span><span class=nx>Person</span><span class=p>)</span> <span class=nf>GetPhone</span><span class=p>()</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>x</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>x</span><span class=p>.</span><span class=nf>GetContact</span><span class=p>().(</span><span class=o>*</span><span class=nx>Person_Phone</span><span class=p>);</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>x</span><span class=p>.</span><span class=nx>Phone</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=s>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></div></div><h4 id=222-é¡¹ç›®å†…-proto-çš„å¼•ç”¨>2.2.2 é¡¹ç›®å†… proto çš„å¼•ç”¨</h4><p>ä½œä¸ºä¸€ä¸ªåˆæ ¼çš„ç¨‹åºå‘˜ï¼Œä»£ç æ˜¯éœ€è¦æ ¹æ®åŠŸèƒ½ã€ç±»å‹ç­‰å› ç´ è¿›è¡Œæ‹†åˆ†çš„ï¼Œæ¯ä¸ªæ–‡ä»¶/æ¨¡å— è´Ÿè´£ä¸€éƒ¨åˆ†çš„é€»è¾‘ï¼Œå„ä¸ªæ¨¡å—ä¹‹é—´å¯ä»¥æœ‰ç›¸äº’çš„ä¾èµ–å…³ç³»ã€‚</p><blockquote><p>å› æ­¤å¼•è¿›æ¥ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œæˆ‘ä¸åŒçš„ proto æ–‡ä»¶ä¹‹é—´å¦‚ä½•ç›¸äº’å¼•ç”¨ï¼Ÿå¦‚æœæœ‰ç¬¬ä¸‰æ–¹çš„ proto æ–‡ä»¶åˆæ€ä¹ˆå¼•å…¥ä½¿ç”¨å‘¢ï¼Ÿ</p></blockquote><p>ç­”æ¡ˆæ˜¯ï¼Œpb æ˜¯æ”¯æŒ import èƒ½åŠ›çš„ã€‚è‡ªå·±çš„ proto æ–‡ä»¶ä¹‹é—´å¯ä»¥äº’ç›¸å¼•ç”¨ï¼Œä¹Ÿå¯ä»¥å¼•å…¥å…¶ä»– proto æ–‡ä»¶ã€‚ä½†æ˜¯éœ€è¦æ³¨æ„ä¸è¦åœ¨ä¸åŒ package ä¹‹é—´å¾ªç¯å¼•ç”¨ï¼ˆå†™ go çš„éƒ½çŸ¥é“è¿™ä¸ªæ˜¯å‘ï¼Œä¸ç”¨è¿‡å¤šè§£é‡Šï¼‰ã€‚</p><p><strong>å…ˆè¯´ä¸€ä¸‹å¼•å…¥è‡ªå·±é¡¹ç›®å†…çš„å…¶ä»– proto æ–‡ä»¶çš„æƒ…å†µã€‚</strong></p><p>å‡è®¾æˆ‘ç°åœ¨æœ‰ä¸¤ä¸ª proto æ–‡ä»¶ï¼Œå…¶è·¯å¾„å…¥ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>api
</span></span><span class=line><span class=cl><span class=p>|</span>--user
</span></span><span class=line><span class=cl><span class=p>|</span>   <span class=p>|</span>--user.proto
</span></span><span class=line><span class=cl><span class=p>|</span>-- order
</span></span><span class=line><span class=cl><span class=p>|</span>   <span class=p>|</span>--order.proto
</span></span></code></pre></td></tr></table></div></div><p>è€Œè¿™ä¸ªé¡¹ç›®çš„ go mod å®šä¹‰æ˜¯ <code>github.com/a/b</code>, <code>order.proto</code> è¦å¼•å…¥ä½¿ç”¨ <code>user.proto</code> å®šä¹‰çš„æ¶ˆæ¯ã€‚</p><p>user.proto çš„å¤´éƒ¨å®šä¹‰çš„åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-proto data-lang=proto><span class=line><span class=cl><span class=n>syntax</span> <span class=o>=</span> <span class=s>&#34;proto3&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kn>package</span> <span class=nn>api</span><span class=o>.</span><span class=n>user</span><span class=p>;</span> <span class=c1>// é¡¹ç›®æ ¹ç›®å½•åˆ°å½“å‰æ–‡ä»¶ï¼Œè¿™æ ·å®šä¹‰æ–¹ä¾¿å¼•å…¥ï¼Œä½†æ˜¯ä¸æ˜¯å›ºå®šè§„åˆ™
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>option</span> <span class=n>go_package</span> <span class=o>=</span> <span class=s>&#34;github.com/a/b/user&#34;</span><span class=p>;</span> <span class=c1>// è¿™é‡Œè¯·ç¡®ä¿ä½ çš„é¡¹ç›®æ ¹ç›®å½•åˆ°å½“å‰æ–‡ä»¶çš„è·¯å¾„æ˜¯ä¸€è‡´çš„ï¼Œå¦åˆ™ä¼šå¯¼è‡´å¼•å…¥å¤±è´¥
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>User</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kt>string</span> <span class=n>name</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>order.proto çš„å¤´éƒ¨å®šä¹‰çš„åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-proto data-lang=proto><span class=line><span class=cl><span class=n>syntax</span> <span class=o>=</span> <span class=s>&#34;proto3&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kn>package</span> <span class=nn>api</span><span class=o>.</span><span class=n>order</span><span class=p>;</span> <span class=c1>// é¡¹ç›®æ ¹ç›®å½•åˆ°å½“å‰æ–‡ä»¶ï¼Œè¿™æ ·å®šä¹‰æ–¹ä¾¿å¼•å…¥ï¼Œä½†æ˜¯ä¸æ˜¯å›ºå®šè§„åˆ™
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>option</span> <span class=n>go_package</span> <span class=o>=</span> <span class=s>&#34;github.com/a/b/order&#34;</span><span class=p>;</span> <span class=c1>// è¿™é‡Œè¯·ç¡®ä¿ä½ çš„é¡¹ç›®æ ¹ç›®å½•åˆ°å½“å‰æ–‡ä»¶çš„è·¯å¾„æ˜¯ä¸€è‡´çš„ï¼Œå¦åˆ™ä¼šå¯¼è‡´å¼•å…¥å¤±è´¥
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>import</span> <span class=s>&#34;api.user.proto&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>Order</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=n>api.user.User</span> <span class=n>user</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>è¿™ç§æ–¹å¼å°±å¯ä»¥å®ç°é¡¹ç›®ä¸åŒåŒ…ä¹‹é—´çš„å¼•ç”¨ï¼Œ<code>order.proto</code> ç”Ÿæˆå¼•å…¥åŒ…ä»£ç å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>user</span> <span class=s>&#34;github.com/a/b/user&#34;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=223-å¼•ç”¨ç¬¬ä¸‰æ–¹åŒ…>2.2.3 å¼•ç”¨ç¬¬ä¸‰æ–¹åŒ…</h4><p>å¦‚æœä½ å¯¹ pb æ¯”è¾ƒç†Ÿæ‚‰çš„è¯ï¼Œåº”è¯¥å¯¹ pb å®˜æ–¹å¼€æºçš„è¿™ä¸ªé¡¹ç›®ä¸é™Œç”Ÿï¼š<a href=https://github.com/protocolbuffers/protobuf target=_blank rel="noopener noreffer">https://github.com/protocolbuffers/protobuf</a>,è¯¥é¡¹ç›®ä¸º pb çš„æºç ã€‚å½“ç„¶è¿™é‡Œä¸ä»‹ç»æºç ç›¸å…³çš„ä¸œè¥¿ï¼Œä½†æ˜¯åœ¨å…¶ <code>src/google/protobuf</code> ç›®å½•ä¸‹ï¼Œå®šä¹‰äº†å¾ˆå¤šé«˜çº§æ•°æ®ç±»å‹ï¼Œæ–¹ä¾¿æˆ‘ä»¬æ—¥å¸¸ä½¿ç”¨ã€‚</p><p>ä¸‹é¢ä»¥ <code>Duration ä¸ºä¾‹</code>ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-proto data-lang=proto><span class=line><span class=cl><span class=k>import</span> <span class=s>&#34;google/protobuf/duration.proto&#34;</span><span class=p>;</span> <span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c1>// éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œprotoc å‘½ä»¤é‡Œéœ€è¦æŒ‡å®šè¯¥åŒ…æ‰€åœ¨ç›®å½•ã€‚æˆ‘æ˜¯æ”¾åˆ°é¡¹ç›®å†… `third_party` ç›®å½•ä¸‹,å¹¶åœ¨ç”Ÿæˆä»£ç çš„ååˆ©æŒ‡å®š
</span></span></span><span class=line><span class=cl><span class=c1>//  `--proto_path=./third_party` å‚æ•°ã€‚
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>Config</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kt>string</span> <span class=n>addr</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=n>google.protobuf.Duration</span> <span class=n>timeout</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span> <span class=c1>// å®šä¹‰ä¸€ä¸ªè¶…æ—¶
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>æ­¤æ—¶ç”Ÿæˆä»£ç çš„æ—¶å€™ä¼šå‘ç°ï¼Œç”Ÿæˆå­—æ®µç±»å‹å¹¶éæ˜¯åŸç”Ÿ <code>time.Duration</code>ï¼Œè€Œæ˜¯ <code>google.protobuf.Duration</code>ã€‚è¿™é‡Œéœ€è¦æ³¨æ„ä¸‹ï¼Œä½†æ˜¯è¿™ä¸ªç±»å‹æœ‰ä¸ª
<code>AsDuration()</code> çš„æ–¹æ³•ï¼Œä¼šè¿”å›åŸç”Ÿ <code>time.Duration</code>ã€‚</p><p>ä¸æ­¤åŒæ—¶ï¼Œ<code>Google</code> çš„è¿™ä¸ªæ‰©å±•åŒ…ï¼Œæä¾›äº†å¾ˆå¤šå…¶ä»–çš„æ•°æ®ç±»å‹ï¼Œæ¯”å¦‚<code>Timestamp</code>ã€<code>FieldMask</code>ã€<code>StringValue</code>ã€<code>BytesValue</code> ç­‰ç­‰ã€‚ç”¨æ³•ä¸ä¸Šé¢ä¸€è‡´ï¼Œå¼•å…¥å¯¹åº”çš„åŒ…å³å¯ï¼Œå…·ä½“æœ‰å“ªäº›ç±»å‹ï¼Œå¯ä»å®˜æ–¹æ–‡æ¡£æŸ¥é˜…ï¼š<a href=https://developers.google.com/protocol-buffers/docs/reference/google.protobuf target=_blank rel="noopener noreffer">https://developers.google.com/protocol-buffers/docs/reference/google.protobuf</a> ã€‚</p><h3 id=23-æ¶ˆæ¯æ ¡éªŒ>2.3 æ¶ˆæ¯æ ¡éªŒ</h3><p>åœ¨ä¸šåŠ¡æ­£å¸¸çš„ä¸šåŠ¡å¼€å‘ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å¯¹æ¥å£ä¼ å‚çš„æ•°æ®è¿›è¡Œæ•°æ®åˆæ³•æ€§éªŒè¯ï¼Œä¸€èˆ¬æ˜¯é€šè¿‡ç»“æ„ä½“æ³¨å…¥ tag çš„æ–¹å¼ç»Ÿä¸€å¤„ç†ã€‚å¤§å®¶æœ€ç†Ÿæ‚‰çš„åº”è¯¥æ˜¯ <code>github.com/go-playground/validator</code> è¿™ä¸ªåŒ…ï¼Œé€šè¿‡åœ¨ tag ä¸Šå®šä¹‰éªŒè¯è§„åˆ™ï¼Œç„¶åç”¨ç»Ÿä¸€çš„æ–¹æ³•è¿›è¡Œè§„åˆ™éªŒè¯ã€‚ç”¨ä¹ æƒ¯äº†å¯ä»¥è¯´æ˜¯å¾ˆæ–¹ä¾¿ï¼Œè€Œä¸”å¾ˆå¤šä¸»æµçš„http æ¡†æ¶ä¹Ÿå¯¹è¿™ä¸ªåº“è¿›è¡Œæ”¯æŒçš„ï¼ˆæ¯”å¦‚ ginï¼‰ã€‚</p><p>ä½†æ˜¯åœ¨åŸºäº gRPC & pb çš„åœºæ™¯ä¸‹ï¼Œè¿™ä¸ªåº“å°±åªæ˜¯ä¸ªæ‘†è®¾äº†ï¼Œå› ä¸ºä»£ç æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œæ²¡åŠæ³•æ”¹åŠ¨ï¼Œæ›´æ²¡åŠæ³•æ³¨å…¥ tag ä¿¡æ¯ï¼ˆå½“ç„¶ä¸èƒ½è¯´ä¸è¡Œï¼Œä½ å¯ä»¥è‡ªå·±å¼€å‘ä¸€ä¸ª <code>protoc</code> çš„æ’ä»¶å»åšè¿™ä¸ªäº‹å„¿ï¼Œä½†æ˜¯è¿™ä¸ªè¿‡ç¨‹æ¯”ä½ æƒ³æƒ³çš„è¦éº»çƒ¦å¤šï¼Œå¯ä»¥çœ‹ä¸€ä¸‹ <a href=../go-protoc-http/ rel>å¦‚ä½•è‡ªå®šä¹‰ protoc æ’ä»¶</a> è¿™ç¯‡æ–‡ä»¶ï¼‰ã€‚</p><p>æ‰€ä»¥æƒ³éªŒè¯æ•°æ®çš„åˆæ³•æ€§å¥½åƒåªèƒ½æŒ¨ä¸ªå­—æ®µå»å»åˆ¤æ–­ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå‡ºç°å¦ä¸€ä¸ªéå¸¸ nb çš„æ’ä»¶ &ndash; <a href=https://github.com/envoyproxy/protoc-gen-validate target=_blank rel="noopener noreffer">github.com/envoyproxy/protoc-gen-validate</a>ã€‚</p><p>è¯¥åº“å®šä¹‰äº†æ¯ä¸ªåŸºç¡€ç±»å‹ï¼ˆåŒ…æ‹¬ Google æä¾› <code>duration</code>, <code>timestamp</code> ç­‰ç±»å‹ï¼‰çš„éªŒè¯è§„åˆ™ï¼Œå¹¶ç”Ÿæˆå¯¹åº”çš„ä»£ç ã€‚ä½¿ç”¨æ—¶ç›´æ¥è°ƒç”¨ç»“æ„ä½“çš„ <code>Validate()</code> æ–¹æ³•å³å¯ã€‚</p><h4 id=231-åŸºç¡€ç±»å‹>2.3.1 åŸºç¡€ç±»å‹</h4><p>å¯¹äº<strong>åŸºç¡€ç±»å‹</strong>ï¼Œæ¯”å¦‚ int32ã€int64ã€stringã€bool ç­‰ç­‰ï¼Œä¼šæœ‰å¤§äºå°äºç­‰äºï¼Œå¿…éœ€ï¼Œéå¿…éœ€ï¼Œç©ºï¼Œéç©ºç­‰ç­‰çš„éªŒè¯è§„åˆ™ã€‚</p><p>å¦‚ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-proto data-lang=proto><span class=line><span class=cl><span class=kd>message</span> <span class=nc>UpdateUserRequest</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kt>string</span> <span class=n>uid</span> <span class=o>=</span> <span class=mi>1</span> <span class=p>[(</span><span class=n>validate.rules</span><span class=p>)</span><span class=o>.</span><span class=kt>string</span> <span class=o>=</span> <span class=p>{</span><span class=n>min_len</span><span class=o>:</span> <span class=mi>20</span><span class=p>,</span> <span class=n>max_len</span><span class=o>:</span> <span class=mi>24</span><span class=p>}];</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kt>string</span> <span class=n>name</span> <span class=o>=</span> <span class=mi>2</span> <span class=p>[(</span><span class=n>validate.rules</span><span class=p>)</span><span class=o>.</span><span class=kt>string</span> <span class=o>=</span> <span class=p>{</span><span class=n>min_len</span><span class=o>:</span> <span class=mi>2</span><span class=p>,</span> <span class=n>max_len</span><span class=o>:</span> <span class=mi>20</span><span class=p>,</span> <span class=n>ignore_empty</span><span class=o>:</span> <span class=kc>true</span><span class=p>}];</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kt>string</span> <span class=n>email</span> <span class=o>=</span> <span class=mi>3</span> <span class=p>[(</span><span class=n>validate.rules</span><span class=p>)</span><span class=o>.</span><span class=kt>string</span> <span class=o>=</span> <span class=p>{</span><span class=n>email</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span><span class=n>ignore_empty</span><span class=o>:</span> <span class=kc>true</span><span class=p>}];</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kt>string</span> <span class=n>phone</span> <span class=o>=</span> <span class=mi>4</span> <span class=p>[(</span><span class=n>validate.rules</span><span class=p>)</span><span class=o>.</span><span class=kt>string</span> <span class=o>=</span> <span class=p>{</span><span class=n>pattern</span><span class=o>:</span> <span class=s>&#34;^1[3-9]\\d{9}$&#34;</span><span class=p>,</span> <span class=n>ignore_empty</span><span class=o>:</span> <span class=kc>true</span><span class=p>}];</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kt>string</span> <span class=n>avatar</span> <span class=o>=</span> <span class=mi>5</span> <span class=p>[(</span><span class=n>validate.rules</span><span class=p>)</span><span class=o>.</span><span class=kt>string</span> <span class=o>=</span> <span class=p>{</span><span class=n>max_len</span><span class=o>:</span><span class=mi>128</span><span class=p>,</span> <span class=n>ignore_empty</span><span class=o>:</span> <span class=kc>true</span><span class=p>}];</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>ç”Ÿæˆçš„ä»£ç æ¯”è¾ƒå¤šï¼Œå°±ä¸å†è¿™é‡Œå±•ç¤ºã€‚ä½†æ˜¯ç”Ÿæˆä»£ç é€»è¾‘æ˜¯ï¼Œä¸€ä¸ªä¸ªåˆ¤æ–­å­—æ®µä¸Šçš„è§„åˆ™ï¼Œä¸ç¬¦åˆè§„åˆ™æ—¶ï¼Œä¼šè¿”å›å¾ˆè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ï¼ŒåŒ…æ‹¬å­—æ®µåï¼Œè§„åˆ™ç­‰ï¼Œä¸€çœ¼å°±èƒ½çœ‹å‡ºå“ªä¸ªå­—æ®µä¸ç¬¦åˆå“ªä¸ªè§„åˆ™ã€‚</p><p>å…¶ä»–åŸºç¡€ç±»å‹ä¹Ÿç±»ä¼¼ï¼Œå»ºè®®é˜…è¯»å®˜æ–¹æ–‡æ¡£æˆ–è€…ç›´æ¥çœ‹ proto æ–‡ä»¶ï¼Œå› ä¸º proto æ–‡ä»¶æ¯”æ–‡æ¡£çœ‹èµ·æ¥æ›´ç®€å•æ˜äº†ã€‚</p><h4 id=232-é«˜çº§ç±»å‹>2.3.2 é«˜çº§ç±»å‹</h4><p>å¯¹äº <code>oneof</code>, <code>message</code> è¿™ç§<strong>é«˜çº§ç”¨æ³•</strong>ï¼Œä»–ä¹Ÿæœ‰å¯¹åº”çš„æ£€éªŒè§„åˆ™ï¼Œè¿™é‡Œæä¸€ä¸‹ <code>oneof</code>ã€‚å› ä¸ºåŸç”Ÿçš„ <code>oneof</code> å¯ä»¥ä¼ å…¶ä¸­ä¸€ä¸ªå­—æ®µæˆ–è€…ä¸ä¼ ï¼Œä½†æ˜¯æˆ‘ä»¬å¸Œæœ›æˆ‘å®šä¹‰äº† n ä¸ªï¼Œä½ å¿…é€‰ä¼ å…¶ä¸­ä¸€ä¸ªï¼Œè¿™ä¸ªæ—¶å€™åªéœ€è¦åœ¨ <code>oneof</code> ä¸Šç¬¬ä¸€è¡ŒåŠ ä¸Š <code>option (validate.required) = true;</code> å³å¯ã€‚å¦‚ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-proto data-lang=proto><span class=line><span class=cl><span class=k>oneof</span> <span class=n>id</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=c1>// either x, y, or z must be set.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>option</span> <span class=p>(</span><span class=n>validate.required</span><span class=p>)</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kt>string</span> <span class=n>x</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kt>int32</span>  <span class=n>y</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=n>Person</span> <span class=n>z</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=233-æ‰©å±•ç±»å‹>2.3.3 æ‰©å±•ç±»å‹</h4><p>å¯¹äº<strong>ç¬¬ä¸‰æ–¹åŒ…</strong>ï¼ˆå¦‚ <code>google/protobuf/duration</code>, <code>google/protobuf/timestamps</code>ï¼‰ä¹Ÿæ”¯æŒäº†è§„åˆ™é…ç½®ï¼Œå¯ä»¥è¦æ±‚å¿…ä¼ ï¼Œå¯ä»¥è¦æ±‚ä¼ çš„å€¼å¿…éœ€ç­‰äºæŸä¸ªæŒ‡å®šå€¼æˆ–è€…æ˜¯åœ¨ä¸€å®šçš„æ—¶é—´èŒƒå›´å†…ã€‚å¦‚ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-proto data-lang=proto><span class=line><span class=cl><span class=kd>message</span> <span class=nc>config</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=c1>// range [10ms, 10s]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>google.protobuf.Duration</span> <span class=n>dial_timeout_sec</span> <span class=o>=</span> <span class=mi>3</span> <span class=p>[(</span><span class=n>validate.rules</span><span class=p>)</span><span class=o>.</span><span class=n>duration</span> <span class=o>=</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=n>gte</span><span class=o>:</span> <span class=p>{</span><span class=n>nanos</span><span class=o>:</span> <span class=mi>1000000</span><span class=p>,</span> <span class=n>seconds</span><span class=o>:</span> <span class=mi>0</span><span class=p>},</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=n>lte</span><span class=o>:</span>  <span class=p>{</span><span class=n>seconds</span><span class=o>:</span> <span class=mi>10</span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=p>}];</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>è¯¥åŒ…çš„èƒ½åŠ›æ¯”è¾ƒå¼ºï¼Œç”±äºç¯‡å¹…åªè®²äº†å‡ ä¸ªç±»å‹ï¼Œæ‰€ä»¥ä¸å†å±•ç¤ºã€‚è¿™ä¸ªåº“çš„æ½œåŠ›æˆ‘ä¸ªäººè®¤ä¸ºæ˜¯å¾ˆå¤§çš„ï¼Œå¼ºçƒˆæ¨èå¤§å®¶ä½¿ç”¨ã€‚</p><h2 id=3-æœåŠ¡å®šä¹‰>3. æœåŠ¡å®šä¹‰</h2><h3 id=31-å¸¸è§„æœåŠ¡å®šä¹‰>3.1 å¸¸è§„æœåŠ¡å®šä¹‰</h3><p>èŠäº†è¿™ä¹ˆå¤š pb ä¸­æ¶ˆæ¯çš„å®šä¹‰ï¼Œç°åœ¨èŠä¸€èŠ pb ä¸­çš„æœåŠ¡å®šä¹‰ï¼Œæ¯•ç«ŸæœåŠ¡æ‰æ˜¯æ ¸å¿ƒéƒ¨åˆ†ã€‚</p><p>pb ä¸­æœåŠ¡å®šä¹‰æ˜¯å®šä¹‰ä¸€ä¸ªæœåŠ¡å’Œå…¶ä¸‹é¢çš„æ–¹æ³•ï¼Œè€Œè¿™äº›æ–¹æ³•éœ€è¦ä¸€ä¸ªè¯·æ±‚å’Œä¸€ä¸ªå“åº”ã€‚å¦‚ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-proto data-lang=proto><span class=line><span class=cl><span class=kd>service</span> <span class=n>UserService</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=k>rpc</span> <span class=n>CreateUser</span><span class=p>(</span><span class=n>CreateUserRequest</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>CreateUserResponse</span><span class=p>);</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>CreateUserRequest</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=n>Person</span> <span class=n>person</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>CreateUserResponse</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kt>string</span> <span class=n>id</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>è¿™æ˜¯ä¸€ä¸ªæœ€ç®€çš„æœåŠ¡å®šä¹‰ï¼Œå…¶åŒ…å«ä¸€ä¸ªåˆ›å»ºç”¨æˆ·çš„æ–¹æ³•ï¼Œè¾“å…¥è¾“å‡ºä¹Ÿåˆ†åˆ«å®šä¹‰äº†ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ–¹æ³•å¿…éœ€è¦æœ‰è¾“å…¥è¾“å‡ºä¸”ä¸æ”¯æŒå¤šä¸ªå‚æ•°ï¼Œå¦‚æœéœ€è¦å¤šä¸ªå‚æ•°ï¼Œè¯·åµŒå¥—ä¸€ä¸ªç»“æ„ä½“ã€‚å¦‚æœæ–¹æ³•æ²¡æœ‰è¿”å›å€¼ï¼Œåˆ™å¯ä»¥å®šä¹‰ä¸€ä¸ªç©ºçš„ <code>message</code> å³å¯ã€‚è€Œæˆ‘çš„åšæ³•æ˜¯å®šä¹‰ä¸€ä¸ªé€šç”¨çš„ responseï¼Œåœ¨æ²¡æœ‰è¿”å›å€¼çš„æ–¹æ³•è¿”å›è¿™ä¸ª responseï¼Œæœ‰è¿”å›å€¼çš„æ–¹æ³•åˆ™åµŒå¥—ä¸€å±‚ï¼Œresponse ä½œä¸ºå‚æ•°ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-proto data-lang=proto><span class=line><span class=cl><span class=c1>// BaseResponse use as define response code and message
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>message</span> <span class=nc>BaseResponse</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=n>Code</span> <span class=n>code</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kt>string</span> <span class=n>reason</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=kt>string</span> <span class=kd>message</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=32-stream-æµæœåŠ¡å®šä¹‰>3.2 stream æµæœåŠ¡å®šä¹‰</h3><p>å¤„äº†ä¸Šè¿°çš„å®šä¹‰æœåŠ¡ä¹‹å¤–ï¼Œè¿˜å¯ä»¥å®šä¹‰è¾“å…¥æˆ–è¾“å‡ºä½ stream çš„æ–¹æ³•ï¼Œå¦‚ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-proto data-lang=proto><span class=line><span class=cl><span class=kd>service</span> <span class=n>UserService</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=k>rpc</span> <span class=n>CreateUser1</span><span class=p>(</span><span class=n>stream</span> <span class=n>CreateUserRequest</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>CreateUserResponse</span><span class=p>);</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=k>rpc</span> <span class=n>CreateUser2</span><span class=p>(</span><span class=n>CreateUserRequest</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>stream</span> <span class=n>CreateUserResponse</span><span class=p>);</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=k>rpc</span> <span class=n>CreateUser3</span><span class=p>(</span><span class=n>stream</span> <span class=n>CreateUserRequest</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>stream</span> <span class=n>CreateUserResponse</span><span class=p>);</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>è¡¨ç¤ºè¯·æ±‚æˆ–å“åº”å¯ä»¥æ˜¯ä¸ª stream æµï¼Œè€Œä¸åŒçš„ stream çš„å®šä¹‰ç”Ÿæˆçš„ä»£ç ä¹Ÿä¸ä¸€æ ·ï¼Œå¦‚(ä»¥ client ç«¯ä»£ç ä¸ºä¾‹)ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// For semantics around ctx use and closing/ending streaming RPCs, please refer to https://pkg.go.dev/google.golang.org/grpc/?tab=doc#ClientConn.NewStream.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>UserServiceClient</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nf>CreateUser1</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>opts</span> <span class=o>...</span><span class=nx>grpc</span><span class=p>.</span><span class=nx>CallOption</span><span class=p>)</span> <span class=p>(</span><span class=nx>UserService_CreateUser1Client</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nf>CreateUser2</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>in</span> <span class=o>*</span><span class=nx>CreateUserRequest</span><span class=p>,</span> <span class=nx>opts</span> <span class=o>...</span><span class=nx>grpc</span><span class=p>.</span><span class=nx>CallOption</span><span class=p>)</span> <span class=p>(</span><span class=nx>UserService_CreateUser2Client</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nf>CreateUser3</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>opts</span> <span class=o>...</span><span class=nx>grpc</span><span class=p>.</span><span class=nx>CallOption</span><span class=p>)</span> <span class=p>(</span><span class=nx>UserService_CreateUser3Client</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>UserService_CreateUser1Client</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nf>Send</span><span class=p>(</span><span class=o>*</span><span class=nx>CreateUserRequest</span><span class=p>)</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>  <span class=nf>CloseAndRecv</span><span class=p>()</span> <span class=p>(</span><span class=o>*</span><span class=nx>CreateUserResponse</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>grpc</span><span class=p>.</span><span class=nx>ClientStream</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>UserService_CreateUser2Client</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nf>Recv</span><span class=p>()</span> <span class=p>(</span><span class=o>*</span><span class=nx>CreateUserResponse</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>grpc</span><span class=p>.</span><span class=nx>ClientStream</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>UserService_CreateUser3Client</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nf>Send</span><span class=p>(</span><span class=o>*</span><span class=nx>CreateUserRequest</span><span class=p>)</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>  <span class=nf>Recv</span><span class=p>()</span> <span class=p>(</span><span class=o>*</span><span class=nx>CreateUserResponse</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>grpc</span><span class=p>.</span><span class=nx>ClientStream</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ä¸‰ä¸ªæ–¹æ³•è¿”å›çš„å€¼å‡ä¸ä¸€æ ·ï¼Œåˆ†åˆ«ä¸ºï¼šå‘é€ç«¯ä¸º stream æµï¼Œæ¥æ”¶ç«¯ä¸º stream æµï¼ŒåŒå‘ stream æµã€‚åŒæ ·çš„ server ç«¯å®ç°è¿™äº›æ–¹å¼æ—¶ï¼Œä¹Ÿéœ€è¦å®ç°ç›¸åº”çš„æ¥å£ã€‚</p><h3 id=33-æœåŠ¡å®šä¹‰ä¸­åµŒå¥—-http-å®šä¹‰>3.3 æœåŠ¡å®šä¹‰ä¸­åµŒå¥— http å®šä¹‰</h3><p>åœ¨ <code>google/api/annotations.proto</code> åº“çš„æ”¯æŒä¸‹ï¼Œ pb æ”¯æŒæœåŠ¡ä¸­åµŒå¥— http å®šä¹‰ï¼Œå¦‚ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-proto data-lang=proto><span class=line><span class=cl><span class=k>import</span> <span class=s>&#34;google/api/annotations.proto&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>service</span> <span class=n>Hello</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=k>rpc</span> <span class=n>Add</span><span class=p>(</span><span class=n>AddRequest</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>AddResponse</span><span class=p>)</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=k>option</span> <span class=p>(</span><span class=n>google.api.http</span><span class=p>)</span> <span class=o>=</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>      <span class=n>post</span><span class=o>:</span> <span class=s>&#34;/api/hello/service/v1/add&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>      <span class=n>body</span><span class=o>:</span> <span class=s>&#34;*&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=p>};</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=k>rpc</span> <span class=n>Get</span><span class=p>(</span><span class=n>GetRequest</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>GetResponse</span><span class=p>)</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=k>option</span> <span class=p>(</span><span class=n>google.api.http</span><span class=p>)</span> <span class=o>=</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>      <span class=n>get</span><span class=o>:</span> <span class=s>&#34;/api/hello/service/v1/get&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=p>};</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  <span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>å¯ä»¥é€šè¿‡ <code>grpc-gateway</code> (å®˜æ–¹é¡¹ç›®)ç”Ÿæˆå¯¹åº”çš„ http æ¥å£å¹¶æ³¨å†Œåˆ° <code>grpc-gateway</code> ä¸­ã€‚ä¹Ÿå¯ä»¥é€šè¿‡å…¶ä»–æ’ä»¶å»ç”Ÿæˆ http ä»£ç ã€‚è€Œ <code>kratos</code> è¿™ä¸ªæ¡†æ¶å°±åšäº†è¿™ä¸ªäº‹å„¿ï¼Œå•ç‹¬ç”Ÿæˆ <code>.http.go</code> æ–‡ä»¶ï¼Œå¯ä»¥å°†ç”Ÿæˆçš„è·¯ç”±æ³¨å†Œåˆ° <code>kratos</code> ä¸­ã€‚æˆ‘ä¹‹å‰ä¹Ÿå†™è¿‡ç±»ä¼¼çš„æ’ä»¶ï¼Œå¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š<a href=../go-protoc-http/ rel>å¦‚ä½•è‡ªå®šä¹‰ protoc æ’ä»¶</a>ã€‚</p><p>ä¸ç®¡é‚£ç§æ–¹å¼ï¼Œæœ€ç»ˆç›®æ ‡éƒ½æ˜¯å¤šç”Ÿäº§ä¸€å¥— http æ¥å£ï¼Œæ–¹ä¾¿è°ƒè¯•æˆ–è€…å¯¹å¤–æä¾› grpc & http æœåŠ¡ã€‚</p><h2 id=4-æ€»ç»“>4. æ€»ç»“</h2><p>åˆ°è¿™é‡Œæœ¬ç¯‡æ–‡ç« å°±ç»“æŸäº†ï¼ŒåŸºæœ¬è®²å®Œæˆ‘å¯¹ pb çš„ç†è§£å’Œä½¿ç”¨ä¸Šé‡åˆ°çš„ç»éªŒéƒ½å†™å‡ºæ¥äº†ã€‚å½“ç„¶ç”±äºç¯‡å¹…åŸå› ï¼Œæ²¡æœ‰è®²è¿°å¤ªå¤š grpc ç›¸å…³çš„é—®é¢˜ï¼Œå› ä¸º grpc ä¹Ÿç®—æ˜¯ä¸ªå¤§å¤´ï¼Œæˆ‘æƒ³ä»¥åå•ç‹¬å†™ä¸€ç¯‡è®²è¿° grpc çš„åŸç†å’Œé€šä¿¡ä»¥åŠä½¿ç”¨çš„æ–‡ç« ã€‚</p><p>æœ¬ç¯‡ä¸»è¦è®²è¿°äº†ï¼š</p><ul><li>pb çš„å®šä¹‰å’Œè§£å†³çš„é—®é¢˜</li><li>pb çš„åŸºç¡€ç±»å‹å®šä¹‰å’ŒèŠ±æ ·ç©æ³•</li><li>pb ç±»å‹çš„æ•°æ®æ ¡éªŒï¼ˆä»‹ç»äº†ä¸€ä¸ªç¬¬ä¸‰æ–¹åº“ï¼š<a href=https://github.com/envoyproxy/protoc-gen-validate target=_blank rel="noopener noreffer">protoc-gen-validate</a>ï¼‰</li><li>pb å®šä¹‰æ™®é€šæœåŠ¡</li><li>pb å®šä¹‰ stream æµæœåŠ¡</li><li>pb å®šä¹‰ http æœåŠ¡</li></ul><p>å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜æˆ–è€…æœ‰ä¸ä¸€æ ·çš„æƒ³æ³•ï¼Œè¯·é€šè¿‡è¯„è®ºåŒºæˆ–è€…é‚®ä»¶è”ç³»æˆ‘ã€‚</p><div class="details admonition tip open"><div class="details-summary admonition-title"><i class="icon fas fa-lightbulb fa-fw" aria-hidden=true></i>å¦‚æœåœ¨ä½¿ç”¨ pb è¿‡ç¨‹ä¸­æœ‰ä»€ä¹ˆä¸æ˜ç™½çš„<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content><p>æœ¬æ–‡ä¸­çš„çŸ¥è¯†ç‚¹ï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯æˆ‘åœ¨å†™é¡¹ç›®çš„æ—¶å€™ç§¯ç´¯ä¸‹æ¥çš„ï¼Œå¦‚æœä½ æœ‰ä»€ä¹ˆä¸æ˜ç™½çš„åœ°æ–¹ï¼Œå¯ä»¥å‚è€ƒæˆ‘çš„ä¸€ä¸ªé¡¹ç›®: <a href=https://github.com/go-goim/api target=_blank rel="noopener noreffer">goim/api</a>ã€‚</p><p>æœ¬æ–‡æåˆ°çš„èƒ½åŠ›æˆ‘åœ¨è¿™ä¸ªé¡¹ç›®åŸºæœ¬éƒ½ç”¨åˆ°äº†ï¼Œä½ å¯ä»¥åŒæ—¶çœ‹ä»£ç å’Œæœ¬æ–‡ï¼Œåº”è¯¥å¯¹ä½ æœ‰ä¸€å®šçš„å¸®åŠ©ã€‚</p></div></div></div><h2 id=5-é“¾æ¥>5. é“¾æ¥ğŸ”—</h2><ul><li><a href=../../categories/microservice/ rel>ç³»åˆ—ç¯‡</a></li><li><a href=../go-protoc-http/ rel>å¦‚ä½•è‡ªå®šä¹‰ protoc æ’ä»¶</a></li><li><a href=https://developers.google.com/protocol-buffers/docs/overview target=_blank rel="noopener noreffer">https://developers.google.com/protocol-buffers/docs/overview</a></li><li><a href=https://www.grpc.io/docs/what-is-grpc/introduction/ target=_blank rel="noopener noreffer">https://www.grpc.io/docs/what-is-grpc/introduction/</a></li><li><a href=https://github.com/envoyproxy/protoc-gen-validate target=_blank rel="noopener noreffer">https://github.com/envoyproxy/protoc-gen-validate</a></li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>æ›´æ–°äº 2022-06-16</span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/posts/microservices-protobuf/index.md target=_blank>é˜…è¯»åŸå§‹æ–‡æ¡£</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="åˆ†äº«åˆ° Twitter" data-sharer=twitter data-url=https://yusank.github.io/posts/microservices-protobuf/ data-title="[ç³»åˆ—]å¾®æœåŠ¡Â·å¦‚ä½•é€šè¿‡ protobuf å®šä¹‰æ•°æ®å’ŒæœåŠ¡" data-hashtags=å¾®æœåŠ¡,ç³»åˆ—ç¯‡,protobuf,grpc><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° Facebook" data-sharer=facebook data-url=https://yusank.github.io/posts/microservices-protobuf/ data-hashtag=å¾®æœåŠ¡><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° Linkedin" data-sharer=linkedin data-url=https://yusank.github.io/posts/microservices-protobuf/><i class="fab fa-linkedin fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° WhatsApp" data-sharer=whatsapp data-url=https://yusank.github.io/posts/microservices-protobuf/ data-title="[ç³»åˆ—]å¾®æœåŠ¡Â·å¦‚ä½•é€šè¿‡ protobuf å®šä¹‰æ•°æ®å’ŒæœåŠ¡" data-web><i class="fab fa-whatsapp fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° Hacker News" data-sharer=hackernews data-url=https://yusank.github.io/posts/microservices-protobuf/ data-title="[ç³»åˆ—]å¾®æœåŠ¡Â·å¦‚ä½•é€šè¿‡ protobuf å®šä¹‰æ•°æ®å’ŒæœåŠ¡"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° Reddit" data-sharer=reddit data-url=https://yusank.github.io/posts/microservices-protobuf/><i class="fab fa-reddit fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° Line" data-sharer=line data-url=https://yusank.github.io/posts/microservices-protobuf/ data-title="[ç³»åˆ—]å¾®æœåŠ¡Â·å¦‚ä½•é€šè¿‡ protobuf å®šä¹‰æ•°æ®å’ŒæœåŠ¡"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@6.20.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° å¾®åš" data-sharer=weibo data-url=https://yusank.github.io/posts/microservices-protobuf/ data-title="[ç³»åˆ—]å¾®æœåŠ¡Â·å¦‚ä½•é€šè¿‡ protobuf å®šä¹‰æ•°æ®å’ŒæœåŠ¡" data-ralateuid=yusann><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° Blogger" data-sharer=blogger data-url=https://yusank.github.io/posts/microservices-protobuf/ data-title="[ç³»åˆ—]å¾®æœåŠ¡Â·å¦‚ä½•é€šè¿‡ protobuf å®šä¹‰æ•°æ®å’ŒæœåŠ¡" data-description><i class="fab fa-blogger fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° ç™¾åº¦" data-sharer=baidu data-url=https://yusank.github.io/posts/microservices-protobuf/ data-title="[ç³»åˆ—]å¾®æœåŠ¡Â·å¦‚ä½•é€šè¿‡ protobuf å®šä¹‰æ•°æ®å’ŒæœåŠ¡"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@6.20.0/icons/baidu.svg aria-hidden=true></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° Evernote" data-sharer=evernote data-url=https://yusank.github.io/posts/microservices-protobuf/ data-title="[ç³»åˆ—]å¾®æœåŠ¡Â·å¦‚ä½•é€šè¿‡ protobuf å®šä¹‰æ•°æ®å’ŒæœåŠ¡"><i class="fab fa-evernote fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/>å¾®æœåŠ¡</a>,&nbsp;<a href=/tags/%E7%B3%BB%E5%88%97%E7%AF%87/>ç³»åˆ—ç¯‡</a>,&nbsp;<a href=/tags/protobuf/>protobuf</a>,&nbsp;<a href=/tags/grpc/>grpc</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>è¿”å›</a></span>&nbsp;|&nbsp;<span><a href=/>ä¸»é¡µ</a></span></section></div><div class=post-nav><a href=/posts/brog-in-google/ class=prev rel=prev title=[è¯‘]ä½¿ç”¨Borgåœ¨Googleç®¡ç†å¤§è§„æ¨¡é›†ç¾¤><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>[è¯‘]ä½¿ç”¨Borgåœ¨Googleç®¡ç†å¤§è§„æ¨¡é›†ç¾¤</a></div></div><div id=comments><div id=utterances class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Keep learning and stay with lights.<br>â¤ yusank<br></div><div class=footer-line>ç”± <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.100.2">Hugo</a> å¼ºåŠ›é©±åŠ¨ | ä¸»é¢˜ - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2017 - 2022</span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by/4.0/deed.zh target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=å›åˆ°é¡¶éƒ¨><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title=æŸ¥çœ‹è¯„è®º><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/contrib/copy-tex.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.1/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/typeit@8.5.4/dist/index.umd.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"å¤åˆ¶åˆ°å‰ªè´´æ¿",maxShownLines:50},comment:{utterances:{darkTheme:"github-dark",issueTerm:"pathname",label:"Comment",lightTheme:"github-light",repo:"yusank/yusank.github.io"}},data:{"id-1":"usank`s Site","id-2":"usank`s Site"},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},typeit:{cursorChar:"|",cursorSpeed:1e3,data:{"id-1":["id-1"],"id-2":["id-2"]},duration:-1,speed:70}}</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-24P8ZSJHCQ',{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-24P8ZSJHCQ" async></script></body></html>