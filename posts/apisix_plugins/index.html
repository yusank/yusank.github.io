<!doctype html><html lang=zh-cn>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=robots content="noodp">
<meta http-equiv=x-ua-compatible content="IE=edge, chrome=1">
<title>apisix 开发自定义插件 - Yusank`s Site</title><meta name=Description content="这是我的个人博客，我会在这里分享学习和成长过程中的积累和经验."><meta property="og:title" content="apisix 开发自定义插件">
<meta property="og:description" content="分享如何在 docker 环境部署 apisix 和如何开发 lua 和 go 语言的插件以及如何使用这些自定义插件的过程">
<meta property="og:type" content="article">
<meta property="og:url" content="https://yusank.github.io/posts/apisix_plugins/"><meta property="og:image" content="https://yusank.github.io/logo.png"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-11-03T12:20:00+08:00">
<meta property="article:modified_time" content="2021-11-22T15:22:33+08:00">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://yusank.github.io/logo.png">
<meta name=twitter:title content="apisix 开发自定义插件">
<meta name=twitter:description content="分享如何在 docker 环境部署 apisix 和如何开发 lua 和 go 语言的插件以及如何使用这些自定义插件的过程">
<meta name=application-name content="LoveIt">
<meta name=apple-mobile-web-app-title content="LoveIt"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico>
<link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://yusank.github.io/posts/apisix_plugins/><link rel=prev href=https://yusank.github.io/posts/nginx-lua-plugins/><link rel=next href=https://yusank.github.io/posts/haproxy_lua_trouble/><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"apisix 开发自定义插件","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/yusank.github.io\/posts\/apisix_plugins\/"},"genre":"posts","keywords":"lua, go, apisix","wordcount":1892,"url":"https:\/\/yusank.github.io\/posts\/apisix_plugins\/","datePublished":"2021-11-03T12:20:00+08:00","dateModified":"2021-11-22T15:22:33+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Yusank"},"description":""}</script></head>
<body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':'auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark')&&document.body.setAttribute('theme','dark')</script>
<div id=mask></div><div class=wrapper><header class=desktop id=header-desktop>
<div class=header-wrapper>
<div class=header-title>
<a href=/ title="Yusank`s Site"><span id=id-1 class=typeit></span></a>
</div>
<div class=menu>
<div class=menu-inner><a class=menu-item href=/posts/> 文章 </a><a class=menu-item href=/categories/> 分类 </a><a class=menu-item href=/tags/> 标签 </a><a class=menu-item href=/about/> 关于 </a><a class=menu-item href=https://github.com/yusank title=GitHub rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i> </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i>
</a>
</div>
</div>
</div>
</header><header class=mobile id=header-mobile>
<div class=header-container>
<div class=header-wrapper>
<div class=header-title>
<a href=/ title="Yusank`s Site"><span id=id-2 class=typeit></span></a>
</div>
<div class=menu-toggle id=menu-toggle-mobile>
<span></span><span></span><span></span>
</div>
</div>
<div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/about/ title>关于</a><a class=menu-item href=https://github.com/yusank title=GitHub rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i></a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i>
</a></div>
</div>
</header>
<div class="search-dropdown desktop">
<div id=search-dropdown-desktop></div>
</div>
<div class="search-dropdown mobile">
<div id=search-dropdown-mobile></div>
</div>
<main class=main>
<div class=container><div class=toc id=toc-auto>
<h2 class=toc-title>目录</h2>
<div class=toc-content id=toc-content-auto></div>
</div><article class="page single"><h1 class="single-title animated flipInX">apisix 开发自定义插件</h1><div class=post-meta>
<div class=post-meta-line><span class=post-author><a href=https://github.com/yusank title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw"></i>Yusank</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/%E7%BD%91%E5%85%B3/><i class="far fa-folder fa-fw"></i>网关</a></span></div>
<div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2021-11-03>2021-11-03</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 1892 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 4 分钟&nbsp;</div>
</div><div class="details toc" id=toc-static kept>
<div class="details-summary toc-title">
<span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span>
</div>
<div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents>
<ul>
<li><a href=#如何部署>如何部署</a></li>
<li><a href=#配置>配置</a></li>
<li><a href=#插件>插件</a>
<ul>
<li><a href=#lua>lua</a></li>
<li><a href=#go>go</a></li>
<li><a href=#wasm>wasm</a></li>
</ul>
</li>
</ul>
</nav></div>
</div><div class=content id=content><blockquote>
<p>分享如何在 docker 环境部署 apisix 和如何开发 lua 和 go 语言的插件以及如何使用这些自定义插件的过程，希望能帮助到你。</p>
</blockquote>
<h2 id=如何部署>如何部署</h2>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=c1># 1. 下载官方 docker compose 项目</span>
$ git clone https://github.com/apache/apisix-docker.git
$ <span class=nb>cd</span> apisix-docker/example
<span class=c1># 2. run docker compose</span>
$ docker-compose -p docker-apisix up -d
<span class=c1># check docker ps</span>
$  docker ps
CONTAINER ID   IMAGE          COMMAND                  CREATED          STATUS          PORTS                                                                                                                                                 NAMES
629eb9d85656   627d00c649fc   <span class=s2>&#34;sh -c &#39;/usr/bin/api…&#34;</span>   <span class=m>24</span> seconds ago   Up <span class=m>20</span> seconds   0.0.0.0:9080-&gt;9080/tcp, :::9080-&gt;9080/tcp, 0.0.0.0:9091-9092-&gt;9091-9092/tcp, :::9091-9092-&gt;9091-9092/tcp, 0.0.0.0:9443-&gt;9443/tcp, :::9443-&gt;9443/tcp   docker-apisix_apisix_1
c3cbca636e65   13afb861111c   <span class=s2>&#34;/run.sh&#34;</span>                <span class=m>24</span> seconds ago   Up <span class=m>22</span> seconds   0.0.0.0:3000-&gt;3000/tcp, :::3000-&gt;3000/tcp                                                                                                             docker-apisix_grafana_1
4a5cb9ad6239   5b0292a5e821   <span class=s2>&#34;/usr/local/apisix-d…&#34;</span>   <span class=m>24</span> seconds ago   Up <span class=m>22</span> seconds   0.0.0.0:9000-&gt;9000/tcp, :::9000-&gt;9000/tcp                                                                                                             docker-apisix_apisix-dashboard_1
6430826c4095   8c7e00e786b8   <span class=s2>&#34;/opt/bitnami/script…&#34;</span>   <span class=m>24</span> seconds ago   Up <span class=m>21</span> seconds   0.0.0.0:2379-&gt;2379/tcp, :::2379-&gt;2379/tcp, 2380/tcp                                                                                                   docker-apisix_etcd_1
c086d6e4fbd9   a618f5685492   <span class=s2>&#34;/bin/prometheus --c…&#34;</span>   <span class=m>24</span> seconds ago   Up <span class=m>22</span> seconds   0.0.0.0:9090-&gt;9090/tcp, :::9090-&gt;9090/tcp                                                                                                             docker-apisix_prometheus_1
1e6ea10c008f   7d0cdcc60a96   <span class=s2>&#34;/docker-entrypoint.…&#34;</span>   <span class=m>24</span> seconds ago   Up <span class=m>21</span> seconds   0.0.0.0:9082-&gt;80/tcp, :::9082-&gt;80/tcp                                                                                                                 docker-apisix_web2_1
d4891bd0744e   7d0cdcc60a96   <span class=s2>&#34;/docker-entrypoint.…&#34;</span>   <span class=m>24</span> seconds ago   Up <span class=m>22</span> seconds   0.0.0.0:9081-&gt;80/tcp, :::9081-&gt;80/tcp                                                                                                                 docker-apisix_web1_1
</code></pre></td></tr></table>
</div>
</div><p>部署完成，可以通过 <code>localhost:9000</code> 访问 dashboard。</p>
<h2 id=配置>配置</h2>
<p>默认配置文件在 <code>apisix-docker/example/apisix_conf</code> 目录下。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apisix</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>node_listen</span><span class=p>:</span><span class=w> </span><span class=m>9080</span><span class=w>              </span><span class=c># APISIX listening port</span><span class=w>
</span><span class=w>  </span><span class=nt>enable_ipv6</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span><span class=w>
</span><span class=w>  </span><span class=nt>allow_admin</span><span class=p>:</span><span class=w>                  </span><span class=c># http://nginx.org/en/docs/http/ngx_http_access_module.html#allow</span><span class=w>
</span><span class=w>    </span>- <span class=m>0.0.0.0</span><span class=l>/0             </span><span class=w> </span><span class=c># We need to restrict ip access rules for security. 0.0.0.0/0 is for test.</span><span class=w>
</span><span class=w>
</span><span class=w>  </span><span class=nt>admin_key</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;admin&#34;</span><span class=w>
</span><span class=w>      </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>edd1c9f034335f136f87ad84b625c8f1</span><span class=w> </span><span class=c># 这个值需要改的否则有安全隐患</span><span class=w>
</span><span class=w>      </span><span class=nt>role: admin                 # admin</span><span class=p>:</span><span class=w> </span><span class=l>manage all configuration data</span><span class=w>
</span><span class=w>                                  </span><span class=c># viewer: only can view configuration data</span><span class=w>
</span><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;viewer&#34;</span><span class=w>
</span><span class=w>      </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>4054f7cf07e344346cd3f287985e76a2</span><span class=w>
</span><span class=w>      </span><span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>viewer</span><span class=w>
</span><span class=w>  
</span><span class=w>  </span><span class=nt>enable_control</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>  </span><span class=nt>control</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;0.0.0.0&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>9092</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=nt>etcd</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>host</span><span class=p>:</span><span class=w>                           </span><span class=c># it&#39;s possible to define multiple etcd hosts addresses of the same etcd cluster.</span><span class=w>
</span><span class=w>    </span>- <span class=s2>&#34;http://etcd:2379&#34;</span><span class=w>     </span><span class=c># multiple etcd address</span><span class=w>
</span><span class=w>  </span><span class=nt>prefix</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/apisix&#34;</span><span class=w>               </span><span class=c># apisix configurations prefix</span><span class=w>
</span><span class=w>  </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w>                     </span><span class=c># 30 seconds</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=nt>plugin_attr</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>prometheus</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>export_addr</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;0.0.0.0&#34;</span><span class=w>
</span><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>9091</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><h2 id=插件>插件</h2>
<h3 id=lua>lua</h3>
<p><a href=https://apisix.apache.org/docs/apisix/plugin-develop target=_blank rel="noopener noreffer">官方开发教程</a></p>
<p>示例插件：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-lua data-lang=lua><span class=kd>local</span> <span class=n>ngx</span> <span class=o>=</span> <span class=n>ngx</span>
<span class=kd>local</span> <span class=n>core</span> <span class=o>=</span> <span class=n>require</span><span class=p>(</span><span class=s2>&#34;apisix.core&#34;</span><span class=p>)</span>
<span class=kd>local</span> <span class=n>plugin</span> <span class=o>=</span> <span class=n>require</span><span class=p>(</span><span class=s2>&#34;apisix.plugin&#34;</span><span class=p>)</span>
<span class=kd>local</span> <span class=n>upstream</span> <span class=o>=</span> <span class=n>require</span><span class=p>(</span><span class=s2>&#34;apisix.upstream&#34;</span><span class=p>)</span>

<span class=c1>-- 定义配置，即使用插件时 配置一些自定义字段，如鉴权的 key，需要校验的 header 之类的</span>
<span class=kd>local</span> <span class=n>schema</span> <span class=o>=</span> <span class=p>{</span>
	<span class=n>type</span> <span class=o>=</span> <span class=s2>&#34;object&#34;</span><span class=p>,</span>
	<span class=n>properties</span> <span class=o>=</span> <span class=p>{</span>
		<span class=n>value</span> <span class=o>=</span> <span class=p>{</span><span class=n>type</span> <span class=o>=</span> <span class=s2>&#34;array&#34;</span><span class=p>,</span> <span class=n>minItems</span> <span class=o>=</span> <span class=mi>1</span><span class=p>}</span>
	<span class=p>},</span>
	<span class=n>required</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;value&#34;</span><span class=p>}</span>
<span class=p>}</span>

<span class=c1>-- 这个需要了解一下干什么的</span>
<span class=kd>local</span> <span class=n>metadata_schema</span> <span class=o>=</span> <span class=p>{</span>
	<span class=n>type</span> <span class=o>=</span> <span class=s2>&#34;object&#34;</span><span class=p>,</span>
	<span class=n>properties</span> <span class=o>=</span> <span class=p>{</span>
		<span class=n>ikey</span> <span class=o>=</span> <span class=p>{</span><span class=n>type</span> <span class=o>=</span> <span class=s2>&#34;number&#34;</span><span class=p>,</span> <span class=n>minimum</span> <span class=o>=</span> <span class=mi>0</span><span class=p>},</span>
		<span class=n>skey</span> <span class=o>=</span> <span class=p>{</span><span class=n>type</span> <span class=o>=</span> <span class=s2>&#34;string&#34;</span><span class=p>}</span>
	<span class=p>},</span>
	<span class=n>required</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;ikey&#34;</span><span class=p>,</span> <span class=s2>&#34;skey&#34;</span><span class=p>}</span>
<span class=p>}</span>

<span class=kd>local</span> <span class=n>plugin_name</span> <span class=o>=</span> <span class=s2>&#34;block_by_lua&#34;</span>

<span class=kd>local</span> <span class=n>_M</span> <span class=o>=</span> <span class=p>{</span>
	<span class=n>version</span> <span class=o>=</span> <span class=mf>0.1</span><span class=p>,</span>
	<span class=n>priority</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
	<span class=n>name</span> <span class=o>=</span> <span class=n>plugin_name</span><span class=p>,</span>
	<span class=n>schema</span> <span class=o>=</span> <span class=n>schema</span><span class=p>,</span>
	<span class=n>metadata_schema</span> <span class=o>=</span> <span class=n>metadata_schema</span>
<span class=p>}</span>

<span class=kr>function</span> <span class=nc>_M</span><span class=p>.</span><span class=nf>check_schema</span><span class=p>(</span><span class=n>conf</span><span class=p>,</span> <span class=n>schema_type</span><span class=p>)</span>
	<span class=kr>if</span> <span class=n>schema_type</span> <span class=o>==</span> <span class=n>core.schema</span><span class=p>.</span><span class=n>TYPE_METADATA</span> <span class=kr>then</span>
		<span class=kr>return</span> <span class=n>core.schema</span><span class=p>.</span><span class=n>check</span><span class=p>(</span><span class=n>metadata_schema</span><span class=p>,</span> <span class=n>conf</span><span class=p>)</span>
	<span class=kr>end</span>
	<span class=kr>return</span> <span class=n>core.schema</span><span class=p>.</span><span class=n>check</span><span class=p>(</span><span class=n>schema</span><span class=p>,</span> <span class=n>conf</span><span class=p>)</span>
<span class=kr>end</span>

<span class=kr>function</span> <span class=nc>_M</span><span class=p>.</span><span class=nf>init</span><span class=p>()</span>
	<span class=c1>-- call this function when plugin is loaded</span>
	<span class=n>core.log</span><span class=p>.</span><span class=n>info</span><span class=p>(</span><span class=n>plugin_name</span><span class=p>,</span> <span class=s2>&#34;loaded!&#34;</span><span class=p>)</span>
<span class=kr>end</span>

<span class=kr>function</span> <span class=nc>_M</span><span class=p>.</span><span class=nf>destroy</span><span class=p>()</span>
	<span class=c1>-- call this function when plugin is unloaded</span>
<span class=kr>end</span>

<span class=c1>-- uri 重写阶段 如果不需要就不用定义这个方法</span>
<span class=cm>--[[
</span><span class=cm>function _M.rewrite(conf, ctx)
</span><span class=cm>	core.log.warn(&#34;plugin rewrite phase, conf: &#34;, core.json.encode(conf))
</span><span class=cm>	core.log.warn(&#34;conf_type: &#34;, ctx.conf_type)
</span><span class=cm>	core.log.warn(&#34;conf_id: &#34;, ctx.conf_id)
</span><span class=cm>	core.log.warn(&#34;conf_version: &#34;, ctx.conf_version)
</span><span class=cm>end
</span><span class=cm>--]]</span>

<span class=c1>--命中服务 &amp; 调服务前</span>
<span class=kr>function</span> <span class=nc>_M</span><span class=p>.</span><span class=nf>access</span><span class=p>(</span><span class=n>conf</span><span class=p>,</span> <span class=n>ctx</span><span class=p>)</span>
	<span class=n>core.log</span><span class=p>.</span><span class=n>warn</span><span class=p>(</span><span class=s2>&#34;plugin access phase, conf: &#34;</span><span class=p>,</span> <span class=n>core.json</span><span class=p>.</span><span class=n>encode</span><span class=p>(</span><span class=n>conf</span><span class=p>))</span>
	<span class=n>core.log</span><span class=p>.</span><span class=n>warn</span><span class=p>(</span><span class=s2>&#34;plugin access phase, ctx: &#34;</span><span class=p>,</span> <span class=n>core.json</span><span class=p>.</span><span class=n>encode</span><span class=p>(</span><span class=n>ctx</span><span class=p>,</span> <span class=kc>true</span><span class=p>))</span>
	<span class=c1>-- return 200, {message = &#34;hit example plugin&#34;}</span>
	<span class=c1>-- 1. extract from header</span>
	<span class=kd>local</span> <span class=n>pass</span> <span class=o>=</span> <span class=n>core.request</span><span class=p>.</span><span class=n>header</span><span class=p>(</span><span class=n>ctx</span><span class=p>,</span> <span class=s2>&#34;X-Block-Pass&#34;</span><span class=p>)</span>
	<span class=kr>if</span> <span class=ow>not</span> <span class=n>pass</span> <span class=kr>then</span>
		<span class=n>core.response</span><span class=p>.</span><span class=n>set_header</span><span class=p>(</span><span class=s2>&#34;X-Block-Flag&#34;</span><span class=p>,</span> <span class=s2>&#34;Block By Lua Ext&#34;</span><span class=p>)</span>
        <span class=c1>-- 返回 http 状态码 则这次请求截止到当前插件，不会往下走</span>
		<span class=kr>return</span> <span class=mi>403</span><span class=p>,</span> <span class=p>{</span><span class=n>message</span> <span class=o>=</span> <span class=s2>&#34;Missing pass value in header&#34;</span><span class=p>}</span>
	<span class=kr>end</span>

	<span class=kr>for</span> <span class=n>_</span><span class=p>,</span> <span class=n>val</span> <span class=kr>in</span> <span class=n>pairs</span><span class=p>(</span><span class=n>conf.value</span><span class=p>)</span> <span class=kr>do</span>
		<span class=kr>if</span> <span class=n>val</span> <span class=o>==</span> <span class=n>pass</span> <span class=kr>then</span>
            <span class=c1>-- return 空表示通过 </span>
			<span class=kr>return</span>
		<span class=kr>end</span>
	<span class=kr>end</span>

	<span class=n>core.response</span><span class=p>.</span><span class=n>set_header</span><span class=p>(</span><span class=s2>&#34;X-Block-Flag&#34;</span><span class=p>,</span> <span class=s2>&#34;Block By Lua Ext&#34;</span><span class=p>)</span>
	<span class=kr>return</span> <span class=mi>403</span><span class=p>,</span> <span class=p>{</span><span class=n>message</span> <span class=o>=</span> <span class=s2>&#34;Invalid pass value in header.&#34;</span><span class=p>}</span>
<span class=kr>end</span>

<span class=kd>local</span> <span class=kr>function</span> <span class=nf>hello</span><span class=p>()</span>
	<span class=kd>local</span> <span class=n>args</span> <span class=o>=</span> <span class=n>ngx.req</span><span class=p>.</span><span class=n>get_uri_args</span><span class=p>()</span>
	<span class=kr>if</span> <span class=n>args</span><span class=p>[</span><span class=s2>&#34;json&#34;</span><span class=p>]</span> <span class=kr>then</span>
		<span class=kr>return</span> <span class=mi>200</span><span class=p>,</span> <span class=p>{</span><span class=n>msg</span> <span class=o>=</span> <span class=s2>&#34;world&#34;</span><span class=p>}</span>
	<span class=kr>else</span>
		<span class=kr>return</span> <span class=mi>200</span><span class=p>,</span> <span class=s2>&#34;world</span><span class=se>\n</span><span class=s2>&#34;</span>
	<span class=kr>end</span>
<span class=kr>end</span>

<span class=kr>function</span> <span class=nc>_M</span><span class=p>.</span><span class=nf>control_api</span><span class=p>()</span>
	<span class=kr>return</span> <span class=p>{</span>
		<span class=p>{</span>
            <span class=c1>-- 注册 controller api 用于探测插件是否插入成功，也可以用于内部一些返回 token 之类的用处</span>
			<span class=n>methods</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;GET&#34;</span><span class=p>},</span>
			<span class=n>uris</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;/v1/plugin/example-plugin/hello&#34;</span><span class=p>},</span>
			<span class=n>handler</span> <span class=o>=</span> <span class=n>hello</span>
		<span class=p>}</span>
	<span class=p>}</span>
<span class=kr>end</span>

<span class=kr>return</span> <span class=n>_M</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>如何安装：</strong></p>
<ol>
<li>创建目录</li>
</ol>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>├── example
│   └── apisix
│       ├── plugins
│       │   └── 3rd-party.lua
│       └── stream
│           └── plugins
│               └── 3rd-party.lua
</code></pre></td></tr></table>
</div>
</div><ol start=2>
<li>配置文件(config.yaml)添加插件目录</li>
</ol>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apisix</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=l>...</span><span class=w>
</span><span class=w>    </span><span class=nt>extra_lua_path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/path/to/example/?.lua&#34;</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><ol start=3>
<li>开启插件(config.yaml)</li>
</ol>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apisix</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=nn>...</span><span class=w>
</span><span class=w></span><span class=nt>plugins</span><span class=p>:</span><span class=w> </span><span class=c># 从 config-default.yaml 文件复制出来，然后加上自己的插件</span><span class=w>
</span><span class=w>  </span><span class=l>...</span><span class=w>
</span><span class=w>  </span>- <span class=l>your-plugin     </span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>Q:如何在dashboard 看到自己的插件？</p>
<p>A: 目前自定义插件不支持自动同步到 dashboard，需要手动添加，步骤如下：</p>
<ol>
<li>
<p>在 apisix 机器上执行如下命令获取最新 json scheme：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>$ curl 127.0.0.1:9092/v1/schema &gt; scheme.json
</code></pre></td></tr></table>
</div>
</div></li>
</ol>
<pre><code>2.  将 `scheme.json` 复制到 dashboard 机器上 `conf` 目录下与原有的文件替换，重启 dashboard 服务。
</code></pre>
<h3 id=go>go</h3>
<p><a href=https://apisix.apache.org/docs/go-plugin-runner/getting-started/ target=_blank rel="noopener noreffer">官方开发教程</a></p>
<p>示例代码：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>plugins</span>

<span class=kn>import</span> <span class=p>(</span>
	<span class=s>&#34;encoding/json&#34;</span>
	<span class=s>&#34;net/http&#34;</span>

	<span class=nx>pkgHTTP</span> <span class=s>&#34;github.com/apache/apisix-go-plugin-runner/pkg/http&#34;</span>
	<span class=s>&#34;github.com/apache/apisix-go-plugin-runner/pkg/log&#34;</span>
	<span class=s>&#34;github.com/apache/apisix-go-plugin-runner/pkg/plugin&#34;</span>
<span class=p>)</span>

<span class=c1>// 初始化
</span><span class=c1></span><span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
    <span class=c1>// 注册插件
</span><span class=c1></span>	<span class=nx>err</span> <span class=o>:=</span> <span class=nx>plugin</span><span class=p>.</span><span class=nf>RegisterPlugin</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>BlockReq</span><span class=p>{})</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;failed to register plugin block-req: %s&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
	<span class=p>}</span>
<span class=p>}</span>

<span class=c1>// LimitReq is a demo for a real world plugin
</span><span class=c1></span><span class=kd>type</span> <span class=nx>BlockReq</span> <span class=kd>struct</span> <span class=p>{</span>
<span class=p>}</span>

<span class=c1>// 与 lua 插件内 scheme 一样
</span><span class=c1></span><span class=kd>type</span> <span class=nx>BlockReqConf</span> <span class=kd>struct</span> <span class=p>{</span>
	<span class=nx>Key</span>   <span class=kt>string</span>   <span class=s>`json:&#34;key&#34;`</span>
	<span class=nx>Value</span> <span class=p>[]</span><span class=kt>string</span> <span class=s>`json:&#34;value&#34;`</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>BlockReq</span><span class=p>)</span> <span class=nf>Name</span><span class=p>()</span> <span class=kt>string</span> <span class=p>{</span>
	<span class=k>return</span> <span class=s>&#34;blcok-req&#34;</span>
<span class=p>}</span>

<span class=c1>// ParseConf is called when the configuration is changed. And its output is unique per route.
</span><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>BlockReq</span><span class=p>)</span> <span class=nf>ParseConf</span><span class=p>(</span><span class=nx>in</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>)</span> <span class=p>(</span><span class=kd>interface</span><span class=p>{},</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>conf</span> <span class=o>:=</span> <span class=nx>BlockReqConf</span><span class=p>{}</span>
	<span class=nx>err</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>(</span><span class=nx>in</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>conf</span><span class=p>)</span>

	<span class=k>return</span> <span class=nx>conf</span><span class=p>,</span> <span class=nx>err</span>
<span class=p>}</span>

<span class=c1>// Filter is called when a request hits the route
</span><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>BlockReq</span><span class=p>)</span> <span class=nf>Filter</span><span class=p>(</span><span class=nx>conf</span> <span class=kd>interface</span><span class=p>{},</span> <span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=nx>pkgHTTP</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>b</span> <span class=o>:=</span> <span class=nx>conf</span><span class=p>.(</span><span class=nx>BlockReqConf</span><span class=p>)</span>
	<span class=nx>val</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Header</span><span class=p>().</span><span class=nf>Get</span><span class=p>(</span><span class=nx>b</span><span class=p>.</span><span class=nx>Key</span><span class=p>)</span>
	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>v</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>b</span><span class=p>.</span><span class=nx>Value</span> <span class=p>{</span>
		<span class=k>if</span> <span class=nx>val</span> <span class=o>==</span> <span class=nx>v</span> <span class=p>{</span>
			<span class=nx>r</span><span class=p>.</span><span class=nf>Header</span><span class=p>().</span><span class=nf>Set</span><span class=p>(</span><span class=s>&#34;X-Block-Value&#34;</span><span class=p>,</span> <span class=nx>v</span><span class=p>)</span>
			<span class=k>return</span>
		<span class=p>}</span>
	<span class=p>}</span>
	<span class=c1>// block request
</span><span class=c1></span>    <span class=c1>// 只要写 response 的 header 或body，请求将停在这里不会往下传递，直接响应回去
</span><span class=c1></span>	<span class=nx>w</span><span class=p>.</span><span class=nf>Header</span><span class=p>().</span><span class=nf>Add</span><span class=p>(</span><span class=s>&#34;X-Block-Req&#34;</span><span class=p>,</span> <span class=s>&#34;Block by Go ext.&#34;</span><span class=p>)</span>
	<span class=nx>w</span><span class=p>.</span><span class=nf>WriteHeader</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusForbidden</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>编译部署</strong></p>
<ol>
<li>用官方提供的 <code>Makefile</code> 进行 build（注意编译环境和apisix 运行的环境，指定对应的 GOOS，GOARCH）</li>
<li>将编译好的二进制文件打包到 apisix 的容器内</li>
<li>修改配置文件</li>
</ol>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=nt>ext-plugin</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>cmd</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;/path/to/apisix-go-plugin-runner/go-runner&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;run&#34;</span><span class=p>]</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>注意：一个 go-runner 内可以注册多个插件，所以不需要拥有多个 go-runner ,所有的插件在一个项目里 然后统一编译部署即可</p>
<p><strong>使用</strong></p>
<p>非 <code>lua</code> 插件都运行在各自的 runner 内，所以使用的时候不能直接在 dashboard 中使用自定义的插件（lua 的自定义插件是可以的），需要在 <code>ext-plugin-pre-req</code>, <code>ext-plugin-post-req</code> 两个插件内配置使用，这两插件只有运行时间不一样，一个在所有插件之前 一个在所有插件之后。使用时配置如下:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=s2>&#34;plugins&#34;</span><span class=err>:</span> <span class=p>{</span>
    <span class=nt>&#34;ext-plugin-pre-req&#34;</span><span class=p>:</span> <span class=p>{</span>
      <span class=nt>&#34;conf&#34;</span><span class=p>:</span> <span class=p>[</span>
        <span class=p>{</span>
          <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;blcok-req&#34;</span><span class=p>,</span> <span class=c1>// 注册的 go 插件名字
</span><span class=c1></span>          <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;{\&#34;key\&#34;:\&#34;pass\&#34;, \&#34;value\&#34;:[\&#34;word\&#34;,\&#34;port\&#34;]}&#34;</span> <span class=c1>// 该插件的 conf，这里需要将 json 进行转义
</span><span class=c1></span>        <span class=p>}</span>
      <span class=p>],</span>
      <span class=nt>&#34;disable&#34;</span><span class=p>:</span> <span class=kc>false</span>
    <span class=p>}</span>
  <span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=wasm>wasm</h3>
<p>apisix 开始支持 wasm 插件，但是官方给出的示例和文档还不够完善，这块还在研究中，之后会补齐。</p>
</div><div class=post-footer id=post-footer>
<div class=post-info>
<div class=post-info-line>
<div class=post-info-mod>
<span>更新于 2021-11-22</span>
</div>
<div class=post-info-license></div>
</div>
<div class=post-info-line>
<div class=post-info-md><span>
<a class=link-to-markdown href=/posts/apisix_plugins/index.md target=_blank>阅读原始文档</a>
</span></div>
<div class=post-info-share>
<span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://yusank.github.io/posts/apisix_plugins/ data-title="apisix 开发自定义插件" data-hashtags=lua,go,apisix><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://yusank.github.io/posts/apisix_plugins/ data-hashtag=lua><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="分享到 Linkedin" data-sharer=linkedin data-url=https://yusank.github.io/posts/apisix_plugins/><i class="fab fa-linkedin fa-fw"></i></a><a href=javascript:void(0); title="分享到 WhatsApp" data-sharer=whatsapp data-url=https://yusank.github.io/posts/apisix_plugins/ data-title="apisix 开发自定义插件" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href=javascript:void(0); title="分享到 Hacker News" data-sharer=hackernews data-url=https://yusank.github.io/posts/apisix_plugins/ data-title="apisix 开发自定义插件"><i class="fab fa-hacker-news fa-fw"></i></a><a href=javascript:void(0); title="分享到 Reddit" data-sharer=reddit data-url=https://yusank.github.io/posts/apisix_plugins/><i class="fab fa-reddit fa-fw"></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://yusank.github.io/posts/apisix_plugins/ data-title="apisix 开发自定义插件"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/line.svg></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://yusank.github.io/posts/apisix_plugins/ data-title="apisix 开发自定义插件" data-ralateuid=yusann><i class="fab fa-weibo fa-fw"></i></a><a href=javascript:void(0); title="分享到 Myspace" data-sharer=myspace data-url=https://yusank.github.io/posts/apisix_plugins/ data-title="apisix 开发自定义插件" data-description><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/myspace.svg></i></a><a href=javascript:void(0); title="分享到 Blogger" data-sharer=blogger data-url=https://yusank.github.io/posts/apisix_plugins/ data-title="apisix 开发自定义插件" data-description><i class="fab fa-blogger fa-fw"></i></a><a href=javascript:void(0); title="分享到 百度" data-sharer=baidu data-url=https://yusank.github.io/posts/apisix_plugins/ data-title="apisix 开发自定义插件"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/baidu.svg></i></a><a href=javascript:void(0); title="分享到 Evernote" data-sharer=evernote data-url=https://yusank.github.io/posts/apisix_plugins/ data-title="apisix 开发自定义插件"><i class="fab fa-evernote fa-fw"></i></a></span>
</div>
</div>
</div>
<div class=post-info-more>
<section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/lua/>lua</a>,&nbsp;<a href=/tags/go/>go</a>,&nbsp;<a href=/tags/apisix/>apisix</a></section>
<section>
<span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span>
</section>
</div>
<div class=post-nav><a href=/posts/nginx-lua-plugins/ class=prev rel=prev title="nginx 中使用 lua 动态加载服务配置"><i class="fas fa-angle-left fa-fw"></i>nginx 中使用 lua 动态加载服务配置</a>
<a href=/posts/haproxy_lua_trouble/ class=next rel=next title="haproxy 开发 lua 插件过程遇到的坑">haproxy 开发 lua 插件过程遇到的坑<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id=comments><div id=disqus_thread class=comment></div><noscript>
Please enable JavaScript to view the comments powered by <a href=https://disqus.com/?ref_noscript>Disqus</a>.
</noscript></div></article></div>
</main><footer class=footer>
<div class=footer-container><div class=footer-line>Keep learning and stay with lights.<br>❤ yusank<br></div><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.90.1">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
</div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2017 - 2021</span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div>
</div>
</footer></div>
<div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部>
<i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论>
<i class="fas fa-comment fa-fw"></i>
</a>
</div><script type=text/javascript src=https://yusank.disqus.com/embed.js defer></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/typeit@7.0.4/dist/typeit.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:100},comment:{},data:{"id-1":"Yusank`s Site","id-2":"Yusank`s Site"},typeit:{cursorChar:"|",cursorSpeed:1e3,data:{"id-1":["id-1"],"id-2":["id-2"]},duration:-1,speed:70}}</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-24P8ZSJHCQ',{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-24P8ZSJHCQ" async></script></body>
</html>