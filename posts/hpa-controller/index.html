<!doctype html><html lang=zh-cn>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=robots content="noodp">
<meta http-equiv=x-ua-compatible content="IE=edge, chrome=1">
<title>HPA controller 源码解读 - Yusank`s Site</title><meta name=Description content="这是我的个人博客，我会在这里分享学习和成长过程中的积累和经验."><meta property="og:title" content="HPA controller 源码解读">
<meta property="og:description" content="
本篇讲述 kubernetes 的横向 pod 伸缩(HorizontalPodAutoscaler) 控制器的数据结构，逻辑处理，metrics 计算以及相关细节的源码解读。
">
<meta property="og:type" content="article">
<meta property="og:url" content="https://yusank.github.io/posts/hpa-controller/"><meta property="og:image" content="https://yusank.github.io/logo.png"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2022-01-20T10:50:00+08:00">
<meta property="article:modified_time" content="2022-01-20T17:06:31+08:00">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://yusank.github.io/logo.png">
<meta name=twitter:title content="HPA controller 源码解读">
<meta name=twitter:description content="
本篇讲述 kubernetes 的横向 pod 伸缩(HorizontalPodAutoscaler) 控制器的数据结构，逻辑处理，metrics 计算以及相关细节的源码解读。
">
<meta name=application-name content="Yusank's Site">
<meta name=apple-mobile-web-app-title content="Yusank's Site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel=icon href=https://yusank.github.io/images/logo.svg><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://yusank.github.io/posts/hpa-controller/><link rel=prev href=https://yusank.github.io/posts/shard-map/><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"HPA controller 源码解读","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/yusank.github.io\/posts\/hpa-controller\/"},"genre":"posts","keywords":"go, k8s, 源码解读","wordcount":5689,"url":"https:\/\/yusank.github.io\/posts\/hpa-controller\/","datePublished":"2022-01-20T10:50:00+08:00","dateModified":"2022-01-20T17:06:31+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Yusank"},"description":""}</script></head>
<body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':'auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark')&&document.body.setAttribute('theme','dark')</script>
<div id=mask></div><div class=wrapper><header class=desktop id=header-desktop>
<div class=header-wrapper>
<div class=header-title>
<a href=/ title="Yusank`s Site"><img class="lazyload logo" src=/svg/loading.min.svg data-src=https://yusank.github.io/images/logo.svg data-srcset="https://yusank.github.io/images/logo.svg, https://yusank.github.io/images/logo.svg 1.5x, https://yusank.github.io/images/logo.svg 2x" data-sizes=auto alt=https://yusank.github.io/images/logo.svg title=https://yusank.github.io/images/logo.svg><span id=id-1 class=typeit></span></a>
</div>
<div class=menu>
<div class=menu-inner><a class=menu-item href=/posts/> 文章 </a><a class=menu-item href=/categories/> 分类 </a><a class=menu-item href=/tags/> 标签 </a><a class=menu-item href=/about/> 关于 </a><a class=menu-item href=/links/> 友链 </a><a class=menu-item href=https://github.com/yusank title=GitHub rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i> </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i>
</a>
</div>
</div>
</div>
</header><header class=mobile id=header-mobile>
<div class=header-container>
<div class=header-wrapper>
<div class=header-title>
<a href=/ title="Yusank`s Site"><img class="lazyload logo" src=/svg/loading.min.svg data-src=https://yusank.github.io/images/logo.svg data-srcset="https://yusank.github.io/images/logo.svg, https://yusank.github.io/images/logo.svg 1.5x, https://yusank.github.io/images/logo.svg 2x" data-sizes=auto alt=https://yusank.github.io/images/logo.svg title=https://yusank.github.io/images/logo.svg><span id=id-2 class=typeit></span></a>
</div>
<div class=menu-toggle id=menu-toggle-mobile>
<span></span><span></span><span></span>
</div>
</div>
<div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/about/ title>关于</a><a class=menu-item href=/links/ title>友链</a><a class=menu-item href=https://github.com/yusank title=GitHub rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i></a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i>
</a></div>
</div>
</header>
<div class="search-dropdown desktop">
<div id=search-dropdown-desktop></div>
</div>
<div class="search-dropdown mobile">
<div id=search-dropdown-mobile></div>
</div>
<main class=main>
<div class=container><div class=toc id=toc-auto>
<h2 class=toc-title>目录</h2>
<div class=toc-content id=toc-content-auto></div>
</div><article class="page single"><h1 class="single-title animated flipInX">HPA controller 源码解读</h1><div class=post-meta>
<div class=post-meta-line><span class=post-author><a href=https://github.com/yusank title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw"></i>Yusank</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/kubernetes/><i class="far fa-folder fa-fw"></i>kubernetes</a></span></div>
<div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2022-01-20>2022-01-20</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 5689 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 12 分钟&nbsp;</div>
</div><div class="details toc" id=toc-static kept>
<div class="details-summary toc-title">
<span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span>
</div>
<div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents>
<ul>
<li><a href=#1-前言>1. 前言</a>
<ul>
<li><a href=#11-hpa>1.1. HPA</a></li>
<li><a href=#12-vpa>1.2. VPA</a></li>
</ul>
</li>
<li><a href=#2-基础用法>2. 基础用法</a></li>
<li><a href=#3-数据结构>3. 数据结构</a></li>
<li><a href=#4-控制器逻辑>4. 控制器逻辑</a>
<ul>
<li><a href=#41-伸缩过程>4.1. 伸缩过程</a>
<ul>
<li><a href=#411-从-queue-读取一条消息根据消息中的信息获取-hpa-对象>4.1.1. 从 <code>queue</code> 读取一条消息，根据消息中的信息，获取 <code>hpa</code> 对象</a></li>
<li><a href=#412-为了兼容老版本读取时-hpa-对象为-v1-版本读取后在代码里会先统一转换为-v2-版本从而之后的逻辑统一>4.1.2. 为了兼容老版本，读取时 hpa 对象为 v1 版本，读取后在代码里会先统一转换为 v2 版本,从而之后的逻辑统一</a></li>
<li><a href=#413-根据-hpaspecscaletargetref-信息读到需要伸缩的资源>4.1.3. 根据 <code>hpa.Spec.ScaleTargetRef</code> 信息读到需要伸缩的资源</a></li>
<li><a href=#414-确定当前副本数最大最小可伸缩的副本数>4.1.4. 确定当前副本数，最大最小可伸缩的副本数</a></li>
<li><a href=#415-计算并处理副本数>4.1.5. 计算并处理副本数</a></li>
<li><a href=#416-调整副本数>4.1.6. 调整副本数</a></li>
</ul>
</li>
<li><a href=#42-计算副本数过程>4.2. 计算副本数过程</a>
<ul>
<li><a href=#421-遍历-specmetrics-计算得出最大值>4.2.1. 遍历 <code>spec.Metrics</code> 计算得出最大值</a></li>
<li><a href=#422-计算单个-metric根据类型计算-metric>4.2.2. 计算单个 metric：根据类型计算 metric</a></li>
<li><a href=#423-根据计算类型执行对应的计算逻辑>4.2.3. 根据计算类型执行对应的计算逻辑</a></li>
</ul>
</li>
</ul>
</li>
<li><a href=#5-扩展用法>5. 扩展用法</a></li>
<li><a href=#6-总结>6. 总结</a></li>
<li><a href=#7-链接>7. 链接🔗</a></li>
</ul>
</nav></div>
</div><div class=content id=content><blockquote>
<p>本篇讲述 <code>kubernetes</code> 的横向 pod 伸缩(HorizontalPodAutoscaler) 控制器的数据结构，逻辑处理，metrics 计算以及相关细节的源码解读。</p>
</blockquote>
<h2 id=1-前言>1. 前言</h2>
<p>在 <code>k8s</code> 环境内弹性伸缩并不是一个陌生的概念，是一个常见且不难理解的事件。就是根据特定的事件或数据来触发可伸缩资源的伸缩能力。一般有 HPA 和 VPA 两个概念，HPA 全称 <a href=https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/ target=_blank rel="noopener noreffer">Horizontal Pod Autoscaler</a> 即横向 pod 的自动伸缩，VPA 全称 <a href=https://github.com/kubernetes/autoscaler/tree/master/vertical-pod-autoscaler target=_blank rel="noopener noreffer">Vertical Pod Autoscaler</a> 即纵向 pod 的自动伸缩。</p>
<h3 id=11-hpa>1.1. HPA</h3>
<p><code>HPA</code> 关注 pod 的数量，根据现有 pod 的数据(cpu, memory)或外部数据(metrics)来计算实际需要的 pod 数量，从而调整 pod 的总数。<code>HPA</code> 操作的对象需要实现 <code>ScaleInterface</code> 。</p>
<div class="details admonition quote open">
<div class="details-summary admonition-title">
<i class="icon fas fa-quote-right fa-fw"></i>ScaleInterface<i class="details-icon fas fa-angle-right fa-fw"></i>
</div>
<div class=details-content>
<div class=admonition-content><div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// ScaleInterface can fetch and update scales for
</span><span class=c1>// resources in a particular namespace which implement
</span><span class=c1>// the scale subresource.
</span><span class=c1></span><span class=kd>type</span> <span class=nx>ScaleInterface</span> <span class=kd>interface</span> <span class=p>{</span>
    <span class=c1>// Get fetches the scale of the given scalable resource.
</span><span class=c1></span>    <span class=nf>Get</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>resource</span> <span class=nx>schema</span><span class=p>.</span><span class=nx>GroupResource</span><span class=p>,</span> <span class=nx>name</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>opts</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>GetOptions</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>autoscalingapi</span><span class=p>.</span><span class=nx>Scale</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>

    <span class=c1>// Update updates the scale of the given scalable resource.
</span><span class=c1></span>    <span class=nf>Update</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>resource</span> <span class=nx>schema</span><span class=p>.</span><span class=nx>GroupResource</span><span class=p>,</span> <span class=nx>scale</span> <span class=o>*</span><span class=nx>autoscalingapi</span><span class=p>.</span><span class=nx>Scale</span><span class=p>,</span> <span class=nx>opts</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>UpdateOptions</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>autoscalingapi</span><span class=p>.</span><span class=nx>Scale</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>

    <span class=c1>// Patch patches the scale of the given scalable resource.
</span><span class=c1></span>    <span class=nf>Patch</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>gvr</span> <span class=nx>schema</span><span class=p>.</span><span class=nx>GroupVersionResource</span><span class=p>,</span> <span class=nx>name</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>pt</span> <span class=nx>types</span><span class=p>.</span><span class=nx>PatchType</span><span class=p>,</span> <span class=nx>data</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>,</span> <span class=nx>opts</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>PatchOptions</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>autoscalingapi</span><span class=p>.</span><span class=nx>Scale</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div></div>
</div>
</div>
<p>k8s 原生资源中 HPA 可操作性的对象是以下三个:</p>
<ul>
<li><code>Deployment</code></li>
<li><code>ReplicaSet</code></li>
<li><code>StatefulSet</code></li>
</ul>
<p>一般业务场景用 HPA 能满足需求，即业务高峰增加 pod 数更好处理业务，业务低峰降低pod 数节省资源。</p>
<h3 id=12-vpa>1.2. VPA</h3>
<p><code>VPA</code> 关注的是 pod 的资源，根据当前资源利用率等数据为 pod 提供更多的资源（cpu，memory 等）。本人对 VPA 也是表面理解，所以这里不做详细的解读。</p>
<p><code>VPA</code> 更适合大计算、离线计算、机器学习等场景，需要大量的 CPU，GPU，内存来进行计算。</p>
<h2 id=2-基础用法>2. 基础用法</h2>
<p>通过以下命令开启对某个资源的 HPA 能力：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>➜ kubectl autoscale <span class=o>(</span>-f FILENAME <span class=p>|</span> TYPE NAME <span class=p>|</span> TYPE/NAME<span class=o>)</span> <span class=o>[</span>--min<span class=o>=</span>MINPODS<span class=o>]</span> --max<span class=o>=</span>MAXPODS <span class=o>[</span>--cpu-percent<span class=o>=</span>CPU<span class=o>]</span> <span class=o>[</span>options<span class=o>]</span>
</code></pre></td></tr></table>
</div>
</div><div class="details admonition warning open">
<div class="details-summary admonition-title">
<i class="icon fas fa-exclamation-triangle fa-fw"></i>Warning<i class="details-icon fas fa-angle-right fa-fw"></i>
</div>
<div class=details-content>
<div class=admonition-content>需要开启 <code>metric server</code> 才能读取到cpu 利用率，默认是不开启的。详情请看官方文档: <a href=https://github.com/kubernetes-sigs/metrics-server target=_blank rel="noopener noreffer">https://github.com/kubernetes-sigs/metrics-server</a></div>
</div>
</div>
<p>实际使用如下：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=c1># 对 deployment/klyn-deploy 进行 CPU 监控，超过 10%的平均利用率即进行scale up，最大 3 个 pod 最小 1 个</span>
➜ kubectl autoscale deployment klyn-deploy --cpu-percent<span class=o>=</span><span class=m>10</span> --min<span class=o>=</span><span class=m>1</span> --max<span class=o>=</span><span class=m>3</span>
</code></pre></td></tr></table>
</div>
</div><p>然后可以通过 <code>describe</code> 命令查看创建后 HPA 的详情：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>➜ kubectl describe hpa klyn-deploy
Warning: autoscaling/v2beta2 HorizontalPodAutoscaler is deprecated in v1.23+, unavailable in v1.26+
Name:                                                  klyn-deploy
Namespace:                                             default
Labels:                                                &lt;none&gt;
Annotations:                                           &lt;none&gt;
CreationTimestamp:                                     Thu, <span class=m>20</span> Jan <span class=m>2022</span> 11:43:43 +0800
Reference:                                             Deployment/klyn-deploy
Metrics:                                               <span class=o>(</span> current / target <span class=o>)</span>
  resource cpu on pods  <span class=o>(</span>as a percentage of request<span class=o>)</span>:  4% <span class=o>(</span>10m<span class=o>)</span> / 10% <span class=c1># 可以看到已经读到 cpu 数据</span>
Min replicas:                                          <span class=m>1</span>
Max replicas:                                          <span class=m>3</span>
Deployment pods:                                       <span class=m>1</span> current / <span class=m>1</span> desired
Conditions:
  Type            Status  Reason              Message
  ----            ------  ------              -------
  AbleToScale     True    ReadyForNewScale    recommended size matches current size
  ScalingActive   True    ValidMetricFound    the HPA was able to successfully calculate a replica count from cpu resource utilization <span class=o>(</span>percentage of request<span class=o>)</span>
  ScalingLimited  False   DesiredWithinRange  the desired count is within the acceptable range
Events:           &lt;none&gt;
</code></pre></td></tr></table>
</div>
</div><p>可以从上述详情看到 HPA 资源的详细信息以及最下面的步骤信息，当进行伸缩时会同步伸缩过程和原因到 <code>Events</code> 字段上。</p>
<p>之后可以通过压测的方式将 cpu 的利用率提升然后可以到 <code>Deployment</code> 的 replicas 数量的提升，并压测结束一段时间(会有冷却时间)后又降到 1 个 replicas.</p>
<h2 id=3-数据结构>3. 数据结构</h2>
<p>HPA 资源 YAML 结构：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>autoscaling/v2</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>HorizontalPodAutoscaler</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2022-01-20T03:43:43Z&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>klyn-deploy</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w>  </span><span class=nt>resourceVersion</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;6602029&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>uid</span><span class=p>:</span><span class=w> </span><span class=l>385f4234-025b-453d-8270-788f7ce3ced6</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>maxReplicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span><span class=w>  </span><span class=nt>metrics</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>resource</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cpu</span><span class=w>
</span><span class=w>      </span><span class=nt>target</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>averageUtilization</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span><span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Utilization</span><span class=w>
</span><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Resource</span><span class=w>
</span><span class=w>  </span><span class=nt>minReplicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>  </span><span class=nt>scaleTargetRef</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>klyn-deploy</span><span class=w>
</span><span class=w></span><span class=nt>status</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>conditions</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>lastTransitionTime</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2022-01-20T03:43:58Z&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>message</span><span class=p>:</span><span class=w> </span><span class=l>recommended size matches current size</span><span class=w>
</span><span class=w>    </span><span class=nt>reason</span><span class=p>:</span><span class=w> </span><span class=l>ReadyForNewScale</span><span class=w>
</span><span class=w>    </span><span class=nt>status</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;True&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>AbleToScale</span><span class=w>
</span><span class=w>  </span>- <span class=nt>lastTransitionTime</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2022-01-20T03:43:58Z&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>message</span><span class=p>:</span><span class=w> </span><span class=l>the HPA was able to successfully calculate a replica count from cpu resource</span><span class=w>
</span><span class=w>      </span><span class=l>utilization (percentage of request)</span><span class=w>
</span><span class=w>    </span><span class=nt>reason</span><span class=p>:</span><span class=w> </span><span class=l>ValidMetricFound</span><span class=w>
</span><span class=w>    </span><span class=nt>status</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;True&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ScalingActive</span><span class=w>
</span><span class=w>  </span>- <span class=nt>lastTransitionTime</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2022-01-20T03:43:58Z&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>message</span><span class=p>:</span><span class=w> </span><span class=l>the desired count is within the acceptable range</span><span class=w>
</span><span class=w>    </span><span class=nt>reason</span><span class=p>:</span><span class=w> </span><span class=l>DesiredWithinRange</span><span class=w>
</span><span class=w>    </span><span class=nt>status</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;False&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ScalingLimited</span><span class=w>
</span><span class=w>  </span><span class=nt>currentMetrics</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>resource</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>current</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>averageUtilization</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span><span class=w>        </span><span class=nt>averageValue</span><span class=p>:</span><span class=w> </span><span class=l>9m</span><span class=w>
</span><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cpu</span><span class=w>
</span><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Resource</span><span class=w>
</span><span class=w>  </span><span class=nt>currentReplicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>  </span><span class=nt>desiredReplicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>  </span><span class=nt>lastScaleTime</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2022-01-20T03:51:44Z&#34;</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>上面对 <code>HPA</code> 的概念和如何使用有了一定的认知，从这里开始对 HPA Controller 的源码进行解读。</p>
<p>数据结构：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// HorizontalController is responsible for the synchronizing HPA objects stored
</span><span class=c1>// in the system with the actual deployments/replication controllers they
</span><span class=c1>// control.
</span><span class=c1></span><span class=kd>type</span> <span class=nx>HorizontalController</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=c1>// Scale 资源的读写（如 Deployment 的 Scale）
</span><span class=c1></span>    <span class=nx>scaleNamespacer</span> <span class=nx>scaleclient</span><span class=p>.</span><span class=nx>ScalesGetter</span>
    <span class=c1>// HorizontalPodAutoscaler 资源的读写
</span><span class=c1></span>    <span class=nx>hpaNamespacer</span>   <span class=nx>autoscalingclient</span><span class=p>.</span><span class=nx>HorizontalPodAutoscalersGetter</span>
    <span class=c1>// 用于根据类型和版本获取资源信息
</span><span class=c1></span>    <span class=nx>mapper</span>          <span class=nx>apimeta</span><span class=p>.</span><span class=nx>RESTMapper</span>
     
    <span class=c1>// 计算 replica 数量
</span><span class=c1></span>    <span class=nx>replicaCalc</span>   <span class=o>*</span><span class=nx>ReplicaCalculator</span>
    <span class=c1>// 订阅 HPA 资源，处理资源变化
</span><span class=c1></span>    <span class=nx>eventRecorder</span> <span class=nx>record</span><span class=p>.</span><span class=nx>EventRecorder</span>
 
    <span class=c1>// 每次缩容之间等待时间
</span><span class=c1></span>    <span class=nx>downscaleStabilisationWindow</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span>
 
    <span class=c1>// hpaLister is able to list/get HPAs from the shared cache from the informer passed in to
</span><span class=c1></span>    <span class=c1>// NewHorizontalController.
</span><span class=c1></span>    <span class=c1>// 用于读取 hpa 对象
</span><span class=c1></span>    <span class=nx>hpaLister</span>       <span class=nx>autoscalinglisters</span><span class=p>.</span><span class=nx>HorizontalPodAutoscalerLister</span>
    <span class=nx>hpaListerSynced</span> <span class=nx>cache</span><span class=p>.</span><span class=nx>InformerSynced</span>
 
    <span class=c1>// podLister is able to list/get Pods from the shared cache from the informer passed in to
</span><span class=c1></span>    <span class=c1>// NewHorizontalController.
</span><span class=c1></span>    <span class=c1>// 用于读取 pod 资源
</span><span class=c1></span>    <span class=nx>podLister</span>       <span class=nx>corelisters</span><span class=p>.</span><span class=nx>PodLister</span>
    <span class=nx>podListerSynced</span> <span class=nx>cache</span><span class=p>.</span><span class=nx>InformerSynced</span>
 
    <span class=c1>// Controllers that need to be synced
</span><span class=c1></span>    <span class=c1>// 只会启动一个 worker，即如果有大量的 HPA 资源时，一部分资源的扩缩容可能不那么及时
</span><span class=c1></span>    <span class=nx>queue</span> <span class=nx>workqueue</span><span class=p>.</span><span class=nx>RateLimitingInterface</span>
 
    <span class=c1>// Latest unstabilized recommendations for each autoscaler.
</span><span class=c1></span>    <span class=c1>// 记录推荐伸缩数量
</span><span class=c1></span>    <span class=nx>recommendations</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>][]</span><span class=nx>timestampedRecommendation</span>
 
    <span class=c1>// Latest autoscaler events
</span><span class=c1></span>    <span class=c1>// 记录伸缩事件
</span><span class=c1></span>    <span class=nx>scaleUpEvents</span>   <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>][]</span><span class=nx>timestampedScaleEvent</span>
    <span class=nx>scaleDownEvents</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>][]</span><span class=nx>timestampedScaleEvent</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id=4-控制器逻辑>4. 控制器逻辑</h2>
<h3 id=41-伸缩过程>4.1. 伸缩过程</h3>
<p>伸缩过程的触发不是实时的，而是从 <code>queue</code> 里消费数据，进行一次伸缩流程，再次将资源名放入 <code>queue</code>, 完成一次循环。</p>
<p>详细流程如下：</p>
<h4 id=411-从-queue-读取一条消息根据消息中的信息获取-hpa-对象>4.1.1. 从 <code>queue</code> 读取一条消息，根据消息中的信息，获取 <code>hpa</code> 对象</h4>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=p>(</span><span class=nx>a</span> <span class=o>*</span><span class=nx>HorizontalController</span><span class=p>)</span> <span class=nf>processNextWorkItem</span><span class=p>()</span> <span class=kt>bool</span> <span class=p>{</span>
    <span class=nx>key</span><span class=p>,</span> <span class=nx>quit</span> <span class=o>:=</span> <span class=nx>a</span><span class=p>.</span><span class=nx>queue</span><span class=p>.</span><span class=nf>Get</span><span class=p>()</span>
    <span class=k>if</span> <span class=nx>quit</span> <span class=p>{</span>
        <span class=k>return</span> <span class=kc>false</span>
    <span class=p>}</span>
    <span class=c1>// 处理完标记完成
</span><span class=c1></span>    <span class=k>defer</span> <span class=nx>a</span><span class=p>.</span><span class=nx>queue</span><span class=p>.</span><span class=nf>Done</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span>

    <span class=c1>// 处理函数入口
</span><span class=c1></span>    <span class=nx>deleted</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>a</span><span class=p>.</span><span class=nf>reconcileKey</span><span class=p>(</span><span class=nx>key</span><span class=p>.(</span><span class=kt>string</span><span class=p>))</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>utilruntime</span><span class=p>.</span><span class=nf>HandleError</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=c1>// Add request processing HPA to queue with resyncPeriod delay.
</span><span class=c1></span>    <span class=c1>// Requests are always added to queue with resyncPeriod delay. If there&#39;s already request
</span><span class=c1></span>    <span class=c1>// for the HPA in the queue then a new request is always dropped. Requests spend resyncPeriod
</span><span class=c1></span>    <span class=c1>// in queue so HPAs are processed every resyncPeriod.
</span><span class=c1></span>    <span class=c1>// Request is added here just in case last resync didn&#39;t insert request into the queue. This
</span><span class=c1></span>    <span class=c1>// happens quite often because there is race condition between adding request after resyncPeriod
</span><span class=c1></span>    <span class=c1>// and removing them from queue. Request can be added by resync before previous request is
</span><span class=c1></span>    <span class=c1>// removed from queue. If we didn&#39;t add request here then in this case one request would be dropped
</span><span class=c1></span>    <span class=c1>// and HPA would processed after 2 x resyncPeriod.
</span><span class=c1></span>    <span class=k>if</span> <span class=p>!</span><span class=nx>deleted</span> <span class=p>{</span>
        <span class=c1>// 如果 hpa 没有被删除，再次放回队列里，经过默认时间间隔（15s，k8s 启动参数可配置）后再读取处理一次
</span><span class=c1></span>        <span class=nx>a</span><span class=p>.</span><span class=nx>queue</span><span class=p>.</span><span class=nf>AddRateLimited</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=k>return</span> <span class=kc>true</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>a</span> <span class=o>*</span><span class=nx>HorizontalController</span><span class=p>)</span> <span class=nf>reconcileKey</span><span class=p>(</span><span class=nx>key</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>deleted</span> <span class=kt>bool</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>namespace</span><span class=p>,</span> <span class=nx>name</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>cache</span><span class=p>.</span><span class=nf>SplitMetaNamespaceKey</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=k>return</span> <span class=kc>true</span><span class=p>,</span> <span class=nx>err</span>
    <span class=p>}</span>

    <span class=c1>// 读取 hpa 对象 `*autoscalingv1.HorizontalPodAutoscaler`
</span><span class=c1></span>    <span class=nx>hpa</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>a</span><span class=p>.</span><span class=nx>hpaLister</span><span class=p>.</span><span class=nf>HorizontalPodAutoscalers</span><span class=p>(</span><span class=nx>namespace</span><span class=p>).</span><span class=nf>Get</span><span class=p>(</span><span class=nx>name</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>IsNotFound</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
        <span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Horizontal Pod Autoscaler %s has been deleted in %s&#34;</span><span class=p>,</span> <span class=nx>name</span><span class=p>,</span> <span class=nx>namespace</span><span class=p>)</span>
        <span class=nb>delete</span><span class=p>(</span><span class=nx>a</span><span class=p>.</span><span class=nx>recommendations</span><span class=p>,</span> <span class=nx>key</span><span class=p>)</span>
        <span class=nb>delete</span><span class=p>(</span><span class=nx>a</span><span class=p>.</span><span class=nx>scaleUpEvents</span><span class=p>,</span> <span class=nx>key</span><span class=p>)</span>
        <span class=nb>delete</span><span class=p>(</span><span class=nx>a</span><span class=p>.</span><span class=nx>scaleDownEvents</span><span class=p>,</span> <span class=nx>key</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>true</span><span class=p>,</span> <span class=kc>nil</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=k>return</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>err</span>
    <span class=p>}</span>

    <span class=c1>// 处理本次伸缩逻辑
</span><span class=c1></span>    <span class=k>return</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>a</span><span class=p>.</span><span class=nf>reconcileAutoscaler</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>key</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id=412-为了兼容老版本读取时-hpa-对象为-v1-版本读取后在代码里会先统一转换为-v2-版本从而之后的逻辑统一>4.1.2. 为了兼容老版本，读取时 hpa 对象为 v1 版本，读取后在代码里会先统一转换为 v2 版本,从而之后的逻辑统一</h4>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=p>(</span><span class=nx>a</span> <span class=o>*</span><span class=nx>HorizontalController</span><span class=p>)</span> <span class=nf>reconcileAutoscaler</span><span class=p>(</span><span class=nx>hpav1Shared</span> <span class=o>*</span><span class=nx>autoscalingv1</span><span class=p>.</span><span class=nx>HorizontalPodAutoscaler</span><span class=p>,</span> <span class=nx>key</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
    <span class=c1>// make a copy so that we never mutate the shared informer cache (conversion can mutate the object)
</span><span class=c1></span>    <span class=nx>hpav1</span> <span class=o>:=</span> <span class=nx>hpav1Shared</span><span class=p>.</span><span class=nf>DeepCopy</span><span class=p>()</span>
    <span class=c1>// then, convert to autoscaling/v2, which makes our lives easier when calculating metrics
</span><span class=c1></span>    <span class=nx>hpaRaw</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>unsafeConvertToVersionVia</span><span class=p>(</span><span class=nx>hpav1</span><span class=p>,</span> <span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>SchemeGroupVersion</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>a</span><span class=p>.</span><span class=nx>eventRecorder</span><span class=p>.</span><span class=nf>Event</span><span class=p>(</span><span class=nx>hpav1</span><span class=p>,</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>EventTypeWarning</span><span class=p>,</span> <span class=s>&#34;FailedConvertHPA&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
        <span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to convert the given HPA to %s: %v&#34;</span><span class=p>,</span> <span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>SchemeGroupVersion</span><span class=p>.</span><span class=nf>String</span><span class=p>(),</span> <span class=nx>err</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=nx>hpa</span> <span class=o>:=</span> <span class=nx>hpaRaw</span><span class=p>.(</span><span class=o>*</span><span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>HorizontalPodAutoscaler</span><span class=p>)</span>
    <span class=o>...</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id=413-根据-hpaspecscaletargetref-信息读到需要伸缩的资源>4.1.3. 根据 <code>hpa.Spec.ScaleTargetRef</code> 信息读到需要伸缩的资源</h4>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=p>(</span><span class=nx>a</span> <span class=o>*</span><span class=nx>HorizontalController</span><span class=p>)</span> <span class=nf>reconcileAutoscaler</span><span class=p>(</span><span class=nx>hpav1Shared</span> <span class=o>*</span><span class=nx>autoscalingv1</span><span class=p>.</span><span class=nx>HorizontalPodAutoscaler</span><span class=p>,</span> <span class=nx>key</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
    <span class=o>...</span>
    <span class=c1>// 省略部分代码
</span><span class=c1></span>    <span class=nx>hpa</span> <span class=o>:=</span> <span class=nx>hpaRaw</span><span class=p>.(</span><span class=o>*</span><span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>HorizontalPodAutoscaler</span><span class=p>)</span>

    <span class=nx>reference</span> <span class=o>:=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%s/%s/%s&#34;</span><span class=p>,</span> <span class=nx>hpa</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>ScaleTargetRef</span><span class=p>.</span><span class=nx>Kind</span><span class=p>,</span> <span class=nx>hpa</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span> <span class=nx>hpa</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>ScaleTargetRef</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>

    <span class=c1>// 解析资源 api version
</span><span class=c1></span>    <span class=nx>targetGV</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>schema</span><span class=p>.</span><span class=nf>ParseGroupVersion</span><span class=p>(</span><span class=nx>hpa</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>ScaleTargetRef</span><span class=p>.</span><span class=nx>APIVersion</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>a</span><span class=p>.</span><span class=nx>eventRecorder</span><span class=p>.</span><span class=nf>Event</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>EventTypeWarning</span><span class=p>,</span> <span class=s>&#34;FailedGetScale&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
        <span class=nf>setCondition</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>AbleToScale</span><span class=p>,</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>ConditionFalse</span><span class=p>,</span> <span class=s>&#34;FailedGetScale&#34;</span><span class=p>,</span> <span class=s>&#34;the HPA controller was unable to get the target&#39;s current scale: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
        <span class=nx>a</span><span class=p>.</span><span class=nf>updateStatusIfNeeded</span><span class=p>(</span><span class=nx>hpaStatusOriginal</span><span class=p>,</span> <span class=nx>hpa</span><span class=p>)</span>
        <span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;invalid API version in scale target reference: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=c1>// 资源类型
</span><span class=c1></span>    <span class=nx>targetGK</span> <span class=o>:=</span> <span class=nx>schema</span><span class=p>.</span><span class=nx>GroupKind</span><span class=p>{</span>
        <span class=nx>Group</span><span class=p>:</span> <span class=nx>targetGV</span><span class=p>.</span><span class=nx>Group</span><span class=p>,</span>
        <span class=nx>Kind</span><span class=p>:</span>  <span class=nx>hpa</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>ScaleTargetRef</span><span class=p>.</span><span class=nx>Kind</span><span class=p>,</span>
    <span class=p>}</span>

    <span class=c1>// 查询资源对象
</span><span class=c1></span>    <span class=nx>mappings</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>a</span><span class=p>.</span><span class=nx>mapper</span><span class=p>.</span><span class=nf>RESTMappings</span><span class=p>(</span><span class=nx>targetGK</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>a</span><span class=p>.</span><span class=nx>eventRecorder</span><span class=p>.</span><span class=nf>Event</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>EventTypeWarning</span><span class=p>,</span> <span class=s>&#34;FailedGetScale&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
        <span class=nf>setCondition</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>AbleToScale</span><span class=p>,</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>ConditionFalse</span><span class=p>,</span> <span class=s>&#34;FailedGetScale&#34;</span><span class=p>,</span> <span class=s>&#34;the HPA controller was unable to get the target&#39;s current scale: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
        <span class=nx>a</span><span class=p>.</span><span class=nf>updateStatusIfNeeded</span><span class=p>(</span><span class=nx>hpaStatusOriginal</span><span class=p>,</span> <span class=nx>hpa</span><span class=p>)</span>
        <span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;unable to determine resource for scale target reference: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=c1>// 根据 ns 资源类型 资源版本和资源名称 确定最终唯一的操作的对象 scale
</span><span class=c1></span>    <span class=c1>// scale 是一个抽象的概念，表示可伸缩的资源(Deployment, replicaSet StatefulSet 等等)
</span><span class=c1></span>    <span class=nx>scale</span><span class=p>,</span> <span class=nx>targetGR</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>a</span><span class=p>.</span><span class=nf>scaleForResourceMappings</span><span class=p>(</span><span class=nx>hpa</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span> <span class=nx>hpa</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>ScaleTargetRef</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>mappings</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>a</span><span class=p>.</span><span class=nx>eventRecorder</span><span class=p>.</span><span class=nf>Event</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>EventTypeWarning</span><span class=p>,</span> <span class=s>&#34;FailedGetScale&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
        <span class=nf>setCondition</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>AbleToScale</span><span class=p>,</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>ConditionFalse</span><span class=p>,</span> <span class=s>&#34;FailedGetScale&#34;</span><span class=p>,</span> <span class=s>&#34;the HPA controller was unable to get the target&#39;s current scale: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
        <span class=nx>a</span><span class=p>.</span><span class=nf>updateStatusIfNeeded</span><span class=p>(</span><span class=nx>hpaStatusOriginal</span><span class=p>,</span> <span class=nx>hpa</span><span class=p>)</span>
        <span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to query scale subresource for %s: %v&#34;</span><span class=p>,</span> <span class=nx>reference</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=c1>//  记录信息
</span><span class=c1></span>    <span class=nf>setCondition</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>AbleToScale</span><span class=p>,</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>ConditionTrue</span><span class=p>,</span> <span class=s>&#34;SucceededGetScale&#34;</span><span class=p>,</span> <span class=s>&#34;the HPA controller was able to get the target&#39;s current scale&#34;</span><span class=p>)</span>
    <span class=c1>// 获取当前副本数
</span><span class=c1></span>    <span class=nx>currentReplicas</span> <span class=o>:=</span> <span class=nx>scale</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Replicas</span>
    <span class=nx>a</span><span class=p>.</span><span class=nf>recordInitialRecommendation</span><span class=p>(</span><span class=nx>currentReplicas</span><span class=p>,</span> <span class=nx>key</span><span class=p>)</span>
    <span class=c1>// 省略部分代码
</span><span class=c1></span>    <span class=o>...</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id=414-确定当前副本数最大最小可伸缩的副本数>4.1.4. 确定当前副本数，最大最小可伸缩的副本数</h4>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go>
<span class=kd>func</span> <span class=p>(</span><span class=nx>a</span> <span class=o>*</span><span class=nx>HorizontalController</span><span class=p>)</span> <span class=nf>reconcileAutoscaler</span><span class=p>(</span><span class=nx>hpav1Shared</span> <span class=o>*</span><span class=nx>autoscalingv1</span><span class=p>.</span><span class=nx>HorizontalPodAutoscaler</span><span class=p>,</span> <span class=nx>key</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
    <span class=o>...</span>
    <span class=c1>// 省略部分代码
</span><span class=c1></span>    <span class=nx>currentReplicas</span> <span class=o>:=</span> <span class=nx>scale</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Replicas</span>

    <span class=kd>var</span> <span class=p>(</span>
        <span class=nx>metricStatuses</span>        <span class=p>[]</span><span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>MetricStatus</span>
        <span class=nx>metricDesiredReplicas</span> <span class=kt>int32</span>
        <span class=nx>metricName</span>            <span class=kt>string</span>
    <span class=p>)</span>

    <span class=nx>desiredReplicas</span> <span class=o>:=</span> <span class=nb>int32</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
    <span class=nx>rescaleReason</span> <span class=o>:=</span> <span class=s>&#34;&#34;</span>

    <span class=kd>var</span> <span class=nx>minReplicas</span> <span class=kt>int32</span>

    <span class=k>if</span> <span class=nx>hpa</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>MinReplicas</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>minReplicas</span> <span class=p>=</span> <span class=o>*</span><span class=nx>hpa</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>MinReplicas</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=c1>// Default value
</span><span class=c1></span>        <span class=nx>minReplicas</span> <span class=p>=</span> <span class=mi>1</span>
    <span class=p>}</span>

    <span class=nx>rescale</span> <span class=o>:=</span> <span class=kc>true</span>

    <span class=c1>// 如果当前副本数为 0 但是 hpa 定义的最小 replicas 不等0 时，被认识是关闭弹性伸缩的能力，不会进行伸缩操作
</span><span class=c1></span>    <span class=k>if</span> <span class=nx>scale</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Replicas</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nx>minReplicas</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
        <span class=c1>// Autoscaling is disabled for this resource
</span><span class=c1></span>        <span class=nx>desiredReplicas</span> <span class=p>=</span> <span class=mi>0</span>
        <span class=nx>rescale</span> <span class=p>=</span> <span class=kc>false</span>
        <span class=nf>setCondition</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>ScalingActive</span><span class=p>,</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>ConditionFalse</span><span class=p>,</span> <span class=s>&#34;ScalingDisabled&#34;</span><span class=p>,</span> <span class=s>&#34;scaling is disabled since the replica count of the target is zero&#34;</span><span class=p>)</span>
    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>currentReplicas</span> <span class=p>&gt;</span> <span class=nx>hpa</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>MaxReplicas</span> <span class=p>{</span>
        <span class=c1>// 如果当前副本数超过预设最大数，目标副本数设定为预设最大值，不会去进行计算操作
</span><span class=c1></span>        <span class=nx>rescaleReason</span> <span class=p>=</span> <span class=s>&#34;Current number of replicas above Spec.MaxReplicas&#34;</span>
        <span class=nx>desiredReplicas</span> <span class=p>=</span> <span class=nx>hpa</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>MaxReplicas</span>
    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>currentReplicas</span> <span class=p>&lt;</span> <span class=nx>minReplicas</span> <span class=p>{</span>
        <span class=c1>// 如果当前副本数超低于预设最小值，目标副本数设定为预设最小值，不会去进行计算操作
</span><span class=c1></span>        <span class=nx>rescaleReason</span> <span class=p>=</span> <span class=s>&#34;Current number of replicas below Spec.MinReplicas&#34;</span>
        <span class=nx>desiredReplicas</span> <span class=p>=</span> <span class=nx>minReplicas</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=c1>// 需要通过计算获得目标副本数
</span><span class=c1></span>        <span class=o>...</span>
    <span class=p>}</span>
    <span class=o>...</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id=415-计算并处理副本数>4.1.5. 计算并处理副本数</h4>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=o>...</span>
<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=kd>var</span> <span class=nx>metricTimestamp</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span>
    <span class=c1>// 获取 metric 数据并根据 metrics 计算目标副本数
</span><span class=c1></span>    <span class=nx>metricDesiredReplicas</span><span class=p>,</span> <span class=nx>metricName</span><span class=p>,</span> <span class=nx>metricStatuses</span><span class=p>,</span> <span class=nx>metricTimestamp</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>a</span><span class=p>.</span><span class=nf>computeReplicasForMetrics</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>scale</span><span class=p>,</span> <span class=nx>hpa</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Metrics</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>a</span><span class=p>.</span><span class=nf>setCurrentReplicasInStatus</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>currentReplicas</span><span class=p>)</span>
        <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>a</span><span class=p>.</span><span class=nf>updateStatusIfNeeded</span><span class=p>(</span><span class=nx>hpaStatusOriginal</span><span class=p>,</span> <span class=nx>hpa</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
            <span class=nx>utilruntime</span><span class=p>.</span><span class=nf>HandleError</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
        <span class=p>}</span>
        <span class=nx>a</span><span class=p>.</span><span class=nx>eventRecorder</span><span class=p>.</span><span class=nf>Event</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>EventTypeWarning</span><span class=p>,</span> <span class=s>&#34;FailedComputeMetricsReplicas&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
        <span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to compute desired number of replicas based on listed metrics for %s: %v&#34;</span><span class=p>,</span> <span class=nx>reference</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>4</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;proposing %v desired replicas (based on %s from %s) for %s&#34;</span><span class=p>,</span> <span class=nx>metricDesiredReplicas</span><span class=p>,</span> <span class=nx>metricName</span><span class=p>,</span> <span class=nx>metricTimestamp</span><span class=p>,</span> <span class=nx>reference</span><span class=p>)</span>

    <span class=nx>rescaleMetric</span> <span class=o>:=</span> <span class=s>&#34;&#34;</span>
    <span class=c1>// 此时 desiredReplicas == 0 
</span><span class=c1></span>    <span class=c1>// 如果计算出结果大于 0，则赋值给 desiredReplicas
</span><span class=c1></span>    <span class=k>if</span> <span class=nx>metricDesiredReplicas</span> <span class=p>&gt;</span> <span class=nx>desiredReplicas</span> <span class=p>{</span>
        <span class=nx>desiredReplicas</span> <span class=p>=</span> <span class=nx>metricDesiredReplicas</span>
        <span class=nx>rescaleMetric</span> <span class=p>=</span> <span class=nx>metricName</span>
    <span class=p>}</span>
    <span class=c1>// 准备 rescaleReason 用于记录到 hpa 的 Conditions 字段，可以查看
</span><span class=c1></span>    <span class=k>if</span> <span class=nx>desiredReplicas</span> <span class=p>&gt;</span> <span class=nx>currentReplicas</span> <span class=p>{</span>
        <span class=nx>rescaleReason</span> <span class=p>=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%s above target&#34;</span><span class=p>,</span> <span class=nx>rescaleMetric</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=nx>desiredReplicas</span> <span class=p>&lt;</span> <span class=nx>currentReplicas</span> <span class=p>{</span>
        <span class=nx>rescaleReason</span> <span class=p>=</span> <span class=s>&#34;All metrics below target&#34;</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=nx>hpa</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Behavior</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=c1>// 默认规则限制一次伸缩的数量 单次伸缩比例不会超过 Max(currentReplicas * 2, 4)
</span><span class=c1></span>        <span class=nx>desiredReplicas</span> <span class=p>=</span> <span class=nx>a</span><span class=p>.</span><span class=nf>normalizeDesiredReplicas</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>currentReplicas</span><span class=p>,</span> <span class=nx>desiredReplicas</span><span class=p>,</span> <span class=nx>minReplicas</span><span class=p>)</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=c1>// 如果 hpa.Spec.Behavior != nil 则处理是否需要配置的规则
</span><span class=c1></span>        <span class=c1>// 如果配置规则为禁用(可以单独禁用 scale up 或 scale down)，则返回 currentReplicas
</span><span class=c1></span>        <span class=c1>// 如果配合了 hpa.Spec.Behavior.Policies, 则按策略进行伸缩(可以配置一次伸缩的 pod 数量或者百分比，从而可以确保伸缩跨度不会一次性很大)
</span><span class=c1></span>        <span class=nx>desiredReplicas</span> <span class=p>=</span> <span class=nx>a</span><span class=p>.</span><span class=nf>normalizeDesiredReplicasWithBehaviors</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>currentReplicas</span><span class=p>,</span> <span class=nx>desiredReplicas</span><span class=p>,</span> <span class=nx>minReplicas</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=c1>// 判断是否需要伸缩，最终计算结果可能会当前副本数一致
</span><span class=c1></span>    <span class=nx>rescale</span> <span class=p>=</span> <span class=nx>desiredReplicas</span> <span class=o>!=</span> <span class=nx>currentReplicas</span>
<span class=p>}</span>
<span class=o>...</span>
</code></pre></td></tr></table>
</div>
</div><h4 id=416-调整副本数>4.1.6. 调整副本数</h4>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=p>(</span><span class=nx>a</span> <span class=o>*</span><span class=nx>HorizontalController</span><span class=p>)</span> <span class=nf>reconcileAutoscaler</span><span class=p>(</span><span class=nx>hpav1Shared</span> <span class=o>*</span><span class=nx>autoscalingv1</span><span class=p>.</span><span class=nx>HorizontalPodAutoscaler</span><span class=p>,</span> <span class=nx>key</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
    <span class=o>...</span>

    <span class=c1>// 需要伸缩
</span><span class=c1></span>    <span class=k>if</span> <span class=nx>rescale</span> <span class=p>{</span>
        <span class=nx>scale</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Replicas</span> <span class=p>=</span> <span class=nx>desiredReplicas</span>
        <span class=c1>// 更新 scale 对象，最终伸缩操作会由 scale 对应的 controller 去完成
</span><span class=c1></span>        <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>a</span><span class=p>.</span><span class=nx>scaleNamespacer</span><span class=p>.</span><span class=nf>Scales</span><span class=p>(</span><span class=nx>hpa</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>).</span><span class=nf>Update</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>TODO</span><span class=p>(),</span> <span class=nx>targetGR</span><span class=p>,</span> <span class=nx>scale</span><span class=p>,</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>UpdateOptions</span><span class=p>{})</span>
        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
            <span class=c1>// 记录日志和 event
</span><span class=c1></span>            <span class=nx>a</span><span class=p>.</span><span class=nx>eventRecorder</span><span class=p>.</span><span class=nf>Eventf</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>EventTypeWarning</span><span class=p>,</span> <span class=s>&#34;FailedRescale&#34;</span><span class=p>,</span> <span class=s>&#34;New size: %d; reason: %s; error: %v&#34;</span><span class=p>,</span> <span class=nx>desiredReplicas</span><span class=p>,</span> <span class=nx>rescaleReason</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
            <span class=nf>setCondition</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>AbleToScale</span><span class=p>,</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>ConditionFalse</span><span class=p>,</span> <span class=s>&#34;FailedUpdateScale&#34;</span><span class=p>,</span> <span class=s>&#34;the HPA controller was unable to update the target scale: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
            <span class=nx>a</span><span class=p>.</span><span class=nf>setCurrentReplicasInStatus</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>currentReplicas</span><span class=p>)</span>
            <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>a</span><span class=p>.</span><span class=nf>updateStatusIfNeeded</span><span class=p>(</span><span class=nx>hpaStatusOriginal</span><span class=p>,</span> <span class=nx>hpa</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
                <span class=nx>utilruntime</span><span class=p>.</span><span class=nf>HandleError</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
            <span class=p>}</span>
            <span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to rescale %s: %v&#34;</span><span class=p>,</span> <span class=nx>reference</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
        <span class=p>}</span>
        <span class=nf>setCondition</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>AbleToScale</span><span class=p>,</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>ConditionTrue</span><span class=p>,</span> <span class=s>&#34;SucceededRescale&#34;</span><span class=p>,</span> <span class=s>&#34;the HPA controller was able to update the target scale to %d&#34;</span><span class=p>,</span> <span class=nx>desiredReplicas</span><span class=p>)</span>
        <span class=nx>a</span><span class=p>.</span><span class=nx>eventRecorder</span><span class=p>.</span><span class=nf>Eventf</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>EventTypeNormal</span><span class=p>,</span> <span class=s>&#34;SuccessfulRescale&#34;</span><span class=p>,</span> <span class=s>&#34;New size: %d; reason: %s&#34;</span><span class=p>,</span> <span class=nx>desiredReplicas</span><span class=p>,</span> <span class=nx>rescaleReason</span><span class=p>)</span>
        <span class=nx>a</span><span class=p>.</span><span class=nf>storeScaleEvent</span><span class=p>(</span><span class=nx>hpa</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Behavior</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>currentReplicas</span><span class=p>,</span> <span class=nx>desiredReplicas</span><span class=p>)</span>
        <span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Successful rescale of %s, old size: %d, new size: %d, reason: %s&#34;</span><span class=p>,</span>
            <span class=nx>hpa</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>currentReplicas</span><span class=p>,</span> <span class=nx>desiredReplicas</span><span class=p>,</span> <span class=nx>rescaleReason</span><span class=p>)</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>4</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;decided not to scale %s to %v (last scale time was %s)&#34;</span><span class=p>,</span> <span class=nx>reference</span><span class=p>,</span> <span class=nx>desiredReplicas</span><span class=p>,</span> <span class=nx>hpa</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>LastScaleTime</span><span class=p>)</span>
        <span class=nx>desiredReplicas</span> <span class=p>=</span> <span class=nx>currentReplicas</span>
    <span class=p>}</span>

    <span class=c1>// 更新状态
</span><span class=c1></span>    <span class=nx>a</span><span class=p>.</span><span class=nf>setStatus</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>currentReplicas</span><span class=p>,</span> <span class=nx>desiredReplicas</span><span class=p>,</span> <span class=nx>metricStatuses</span><span class=p>,</span> <span class=nx>rescale</span><span class=p>)</span>
    <span class=k>return</span> <span class=nx>a</span><span class=p>.</span><span class=nf>updateStatusIfNeeded</span><span class=p>(</span><span class=nx>hpaStatusOriginal</span><span class=p>,</span> <span class=nx>hpa</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>至此，伸缩的大流程是完成了，剩下的就是对细节的了解了。比如如何计算目标副本数的，如何处理伸缩的策略等等。</p>
<figure><a class=lightgallery href=/posts/hpa-controller/hpa_controller.png title=/posts/hpa-controller/hpa_controller.png data-thumbnail=/posts/hpa-controller/hpa_controller.png data-sub-html="<h2>伸缩流程</h2>">
<img class=lazyload src=/svg/loading.min.svg data-src=hpa_controller.png data-srcset="/posts/hpa-controller/hpa_controller.png, hpa_controller.png 1.5x, /posts/hpa-controller/hpa_controller.png 2x" data-sizes=auto alt=/posts/hpa-controller/hpa_controller.png width=800>
</a><figcaption class=image-caption>伸缩流程</figcaption>
</figure>
<h3 id=42-计算副本数过程>4.2. 计算副本数过程</h3>
<p>可通过上面流程看到会有一个计算目标副本数的过程 <code>a.computeReplicasForMetrics</code>，看似简单其实内部相当丰富的一个过程，下面一起看一下如何去计算的。</p>
<h4 id=421-遍历-specmetrics-计算得出最大值>4.2.1. 遍历 <code>spec.Metrics</code> 计算得出最大值</h4>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// computeReplicasForMetrics computes the desired number of replicas for the metric specifications listed in the HPA,
</span><span class=c1>// returning the maximum  of the computed replica counts, a description of the associated metric, and the statuses of
</span><span class=c1>// all metrics computed.
</span><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>a</span> <span class=o>*</span><span class=nx>HorizontalController</span><span class=p>)</span> <span class=nf>computeReplicasForMetrics</span><span class=p>(</span><span class=nx>hpa</span> <span class=o>*</span><span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>HorizontalPodAutoscaler</span><span class=p>,</span> <span class=nx>scale</span> <span class=o>*</span><span class=nx>autoscalingv1</span><span class=p>.</span><span class=nx>Scale</span><span class=p>,</span>
    <span class=nx>metricSpecs</span> <span class=p>[]</span><span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>MetricSpec</span><span class=p>)</span> <span class=p>(</span><span class=nx>replicas</span> <span class=kt>int32</span><span class=p>,</span> <span class=nx>metric</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>statuses</span> <span class=p>[]</span><span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>MetricStatus</span><span class=p>,</span> <span class=nx>timestamp</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>

    <span class=cm>/*
</span><span class=cm>    * 省略了部分无关代码
</span><span class=cm>    */</span>
    <span class=k>if</span> <span class=nx>scale</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>Selector</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
        <span class=nx>errMsg</span> <span class=o>:=</span> <span class=s>&#34;selector is required&#34;</span>
        <span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>{},</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=nx>errMsg</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=nx>selector</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>labels</span><span class=p>.</span><span class=nf>Parse</span><span class=p>(</span><span class=nx>scale</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>Selector</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>{},</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=nx>errMsg</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=nx>specReplicas</span> <span class=o>:=</span> <span class=nx>scale</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Replicas</span>
    <span class=nx>statusReplicas</span> <span class=o>:=</span> <span class=nx>scale</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>Replicas</span>
    <span class=c1>// 记录每个 metric 的结果
</span><span class=c1></span>    <span class=nx>statuses</span> <span class=p>=</span> <span class=nb>make</span><span class=p>([]</span><span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>MetricStatus</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>metricSpecs</span><span class=p>))</span>

    <span class=nx>invalidMetricsCount</span> <span class=o>:=</span> <span class=mi>0</span>
    <span class=kd>var</span> <span class=nx>invalidMetricError</span> <span class=kt>error</span>
    <span class=kd>var</span> <span class=nx>invalidMetricCondition</span> <span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>HorizontalPodAutoscalerCondition</span>

    <span class=c1>// 遍历计算
</span><span class=c1></span>    <span class=k>for</span> <span class=nx>i</span><span class=p>,</span> <span class=nx>metricSpec</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>metricSpecs</span> <span class=p>{</span>
        <span class=c1>// 计算单个 metric 的方法
</span><span class=c1></span>        <span class=nx>replicaCountProposal</span><span class=p>,</span> <span class=nx>metricNameProposal</span><span class=p>,</span> <span class=nx>timestampProposal</span><span class=p>,</span> <span class=nx>condition</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>a</span><span class=p>.</span><span class=nf>computeReplicasForMetric</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>metricSpec</span><span class=p>,</span> <span class=nx>specReplicas</span><span class=p>,</span> <span class=nx>statusReplicas</span><span class=p>,</span> <span class=nx>selector</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>statuses</span><span class=p>[</span><span class=nx>i</span><span class=p>])</span>

        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
            <span class=k>if</span> <span class=nx>invalidMetricsCount</span> <span class=o>&lt;=</span> <span class=mi>0</span> <span class=p>{</span>
                <span class=nx>invalidMetricCondition</span> <span class=p>=</span> <span class=nx>condition</span>
                <span class=nx>invalidMetricError</span> <span class=p>=</span> <span class=nx>err</span>
            <span class=p>}</span>
            <span class=nx>invalidMetricsCount</span><span class=o>++</span>
        <span class=p>}</span>
        <span class=c1>// 取最大
</span><span class=c1></span>        <span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=nx>replicas</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>||</span> <span class=nx>replicaCountProposal</span> <span class=p>&gt;</span> <span class=nx>replicas</span><span class=p>)</span> <span class=p>{</span>
            <span class=nx>timestamp</span> <span class=p>=</span> <span class=nx>timestampProposal</span>
            <span class=nx>replicas</span> <span class=p>=</span> <span class=nx>replicaCountProposal</span>
            <span class=nx>metric</span> <span class=p>=</span> <span class=nx>metricNameProposal</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=c1>// If all metrics are invalid or some are invalid and we would scale down,
</span><span class=c1></span>    <span class=c1>// return an error and set the condition of the hpa based on the first invalid metric.
</span><span class=c1></span>    <span class=c1>// Otherwise set the condition as scaling active as we&#39;re going to scale
</span><span class=c1></span>    <span class=k>if</span> <span class=nx>invalidMetricsCount</span> <span class=o>&gt;=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>metricSpecs</span><span class=p>)</span> <span class=o>||</span> <span class=p>(</span><span class=nx>invalidMetricsCount</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nx>replicas</span> <span class=p>&lt;</span> <span class=nx>specReplicas</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>statuses</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>{},</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;invalid metrics (%v invalid out of %v), first error is: %v&#34;</span><span class=p>,</span> <span class=nx>invalidMetricsCount</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>metricSpecs</span><span class=p>),</span> <span class=nx>invalidMetricError</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=k>return</span> <span class=nx>replicas</span><span class=p>,</span> <span class=nx>metric</span><span class=p>,</span> <span class=nx>statuses</span><span class=p>,</span> <span class=nx>timestamp</span><span class=p>,</span> <span class=kc>nil</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id=422-计算单个-metric根据类型计算-metric>4.2.2. 计算单个 metric：根据类型计算 metric</h4>
<div class="details admonition inf open">
<div class="details-summary admonition-title">
<i class="icon fas fa-pencil-alt fa-fw"></i>名词解析<i class="details-icon fas fa-angle-right fa-fw"></i>
</div>
<div class=details-content>
<div class=admonition-content><p>hpa 对象的 <code>spac.metrics</code> 中的元素有个 <code>Type</code> 字段,记录 metric 数据源的类型，目前支持的以下几种：</p>
<table>
<thead>
<tr>
<th style=text-align:center>类型</th>
<th style=text-align:left>说明</th>
<th style=text-align:left>支持的计算类型</th>
<th style=text-align:left>不支持的计算类型</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:center>Object</td>
<td style=text-align:left>由 k8s 本身资源提供的数据，如 ingress 提供命中规则数量</td>
<td style=text-align:left>AverageValue <br> Value</td>
<td style=text-align:left>AverageUtilization</td>
</tr>
<tr>
<td style=text-align:center>Pods</td>
<td style=text-align:left>由 pod 提供的除 CPU 内存之外的数据</td>
<td style=text-align:left>AverageValue</td>
<td style=text-align:left>AverageUtilization <br> Value</td>
</tr>
<tr>
<td style=text-align:center>Resource</td>
<td style=text-align:left>pod 提供的系统资源（CPU 内存）</td>
<td style=text-align:left>AverageUtilization <br> AverageValue</td>
<td style=text-align:left>Value</td>
</tr>
<tr>
<td style=text-align:center>External</td>
<td style=text-align:left>外部提供的监控指标</td>
<td style=text-align:left>AverageValue <br> Value</td>
<td style=text-align:left>AverageUtilization</td>
</tr>
</tbody>
</table>
<ul>
<li>
<p>AverageValue：设定平均值，如qps，tps。计算时读取 metric 总和，与预设平均值✖️副本数进行对比，从而判断是否需要伸缩。</p>
</li>
<li>
<p>Value：设定固定值，如队列中消息数量，Redis 中 list 长度等。计算时直接拿 metric 和预设值进行对比。</p>
</li>
<li>
<p>AverageUtilization： 平均利用率，如 CPU 和内存。先计算 pod的基数的总和（totalMetric 和 totalRequest），最终计算利用率 → totalMetric/totalRequest</p>
</li>
</ul>
</div>
</div>
</div>
<p>源码：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// Computes the desired number of replicas for a specific hpa and metric specification,
</span><span class=c1>// returning the metric status and a proposed condition to be set on the HPA object.
</span><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>a</span> <span class=o>*</span><span class=nx>HorizontalController</span><span class=p>)</span> <span class=nf>computeReplicasForMetric</span><span class=p>(</span><span class=nx>hpa</span> <span class=o>*</span><span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>HorizontalPodAutoscaler</span><span class=p>,</span> <span class=nx>spec</span> <span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>MetricSpec</span><span class=p>,</span>
    <span class=nx>specReplicas</span><span class=p>,</span> <span class=nx>statusReplicas</span> <span class=kt>int32</span><span class=p>,</span> <span class=nx>selector</span> <span class=nx>labels</span><span class=p>.</span><span class=nx>Selector</span><span class=p>,</span> <span class=nx>status</span> <span class=o>*</span><span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>MetricStatus</span><span class=p>)</span> <span class=p>(</span><span class=nx>replicaCountProposal</span> <span class=kt>int32</span><span class=p>,</span> <span class=nx>metricNameProposal</span> <span class=kt>string</span><span class=p>,</span>
    <span class=nx>timestampProposal</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>,</span> <span class=nx>condition</span> <span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>HorizontalPodAutoscalerCondition</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>

    <span class=k>switch</span> <span class=nx>spec</span><span class=p>.</span><span class=nx>Type</span> <span class=p>{</span>
    <span class=k>case</span> <span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>ObjectMetricSourceType</span><span class=p>:</span>
        <span class=nx>metricSelector</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>metav1</span><span class=p>.</span><span class=nf>LabelSelectorAsSelector</span><span class=p>(</span><span class=nx>spec</span><span class=p>.</span><span class=nx>Object</span><span class=p>.</span><span class=nx>Metric</span><span class=p>.</span><span class=nx>Selector</span><span class=p>)</span>
        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
            <span class=nx>condition</span> <span class=o>:=</span> <span class=nx>a</span><span class=p>.</span><span class=nf>getUnableComputeReplicaCountCondition</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=s>&#34;FailedGetObjectMetric&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
            <span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>{},</span> <span class=nx>condition</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to get object metric value: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
        <span class=p>}</span>
        <span class=nx>replicaCountProposal</span><span class=p>,</span> <span class=nx>timestampProposal</span><span class=p>,</span> <span class=nx>metricNameProposal</span><span class=p>,</span> <span class=nx>condition</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>a</span><span class=p>.</span><span class=nf>computeStatusForObjectMetric</span><span class=p>(</span><span class=nx>specReplicas</span><span class=p>,</span> <span class=nx>statusReplicas</span><span class=p>,</span> <span class=nx>spec</span><span class=p>,</span> <span class=nx>hpa</span><span class=p>,</span> <span class=nx>selector</span><span class=p>,</span> <span class=nx>status</span><span class=p>,</span> <span class=nx>metricSelector</span><span class=p>)</span>
        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
            <span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>{},</span> <span class=nx>condition</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to get object metric value: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
        <span class=p>}</span>
    <span class=k>case</span> <span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>PodsMetricSourceType</span><span class=p>:</span>
        <span class=nx>metricSelector</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>metav1</span><span class=p>.</span><span class=nf>LabelSelectorAsSelector</span><span class=p>(</span><span class=nx>spec</span><span class=p>.</span><span class=nx>Pods</span><span class=p>.</span><span class=nx>Metric</span><span class=p>.</span><span class=nx>Selector</span><span class=p>)</span>
        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
            <span class=nx>condition</span> <span class=o>:=</span> <span class=nx>a</span><span class=p>.</span><span class=nf>getUnableComputeReplicaCountCondition</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=s>&#34;FailedGetPodsMetric&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
            <span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>{},</span> <span class=nx>condition</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to get pods metric value: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
        <span class=p>}</span>
        <span class=nx>replicaCountProposal</span><span class=p>,</span> <span class=nx>timestampProposal</span><span class=p>,</span> <span class=nx>metricNameProposal</span><span class=p>,</span> <span class=nx>condition</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>a</span><span class=p>.</span><span class=nf>computeStatusForPodsMetric</span><span class=p>(</span><span class=nx>specReplicas</span><span class=p>,</span> <span class=nx>spec</span><span class=p>,</span> <span class=nx>hpa</span><span class=p>,</span> <span class=nx>selector</span><span class=p>,</span> <span class=nx>status</span><span class=p>,</span> <span class=nx>metricSelector</span><span class=p>)</span>
        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
            <span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>{},</span> <span class=nx>condition</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to get pods metric value: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
        <span class=p>}</span>
    <span class=k>case</span> <span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>ResourceMetricSourceType</span><span class=p>:</span>
        <span class=nx>replicaCountProposal</span><span class=p>,</span> <span class=nx>timestampProposal</span><span class=p>,</span> <span class=nx>metricNameProposal</span><span class=p>,</span> <span class=nx>condition</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>a</span><span class=p>.</span><span class=nf>computeStatusForResourceMetric</span><span class=p>(</span><span class=nx>specReplicas</span><span class=p>,</span> <span class=nx>spec</span><span class=p>,</span> <span class=nx>hpa</span><span class=p>,</span> <span class=nx>selector</span><span class=p>,</span> <span class=nx>status</span><span class=p>)</span>
        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
            <span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>{},</span> <span class=nx>condition</span><span class=p>,</span> <span class=nx>err</span>
        <span class=p>}</span>
    <span class=k>case</span> <span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>ExternalMetricSourceType</span><span class=p>:</span>
        <span class=nx>replicaCountProposal</span><span class=p>,</span> <span class=nx>timestampProposal</span><span class=p>,</span> <span class=nx>metricNameProposal</span><span class=p>,</span> <span class=nx>condition</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>a</span><span class=p>.</span><span class=nf>computeStatusForExternalMetric</span><span class=p>(</span><span class=nx>specReplicas</span><span class=p>,</span> <span class=nx>statusReplicas</span><span class=p>,</span> <span class=nx>spec</span><span class=p>,</span> <span class=nx>hpa</span><span class=p>,</span> <span class=nx>selector</span><span class=p>,</span> <span class=nx>status</span><span class=p>)</span>
        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
            <span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>{},</span> <span class=nx>condition</span><span class=p>,</span> <span class=nx>err</span>
        <span class=p>}</span>
    <span class=k>default</span><span class=p>:</span>
        <span class=nx>errMsg</span> <span class=o>:=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;unknown metric source type %q&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>spec</span><span class=p>.</span><span class=nx>Type</span><span class=p>))</span>
        <span class=nx>err</span> <span class=p>=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=nx>errMsg</span><span class=p>)</span>
        <span class=nx>condition</span> <span class=o>:=</span> <span class=nx>a</span><span class=p>.</span><span class=nf>getUnableComputeReplicaCountCondition</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=s>&#34;InvalidMetricSourceType&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
        <span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>{},</span> <span class=nx>condition</span><span class=p>,</span> <span class=nx>err</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=nx>replicaCountProposal</span><span class=p>,</span> <span class=nx>metricNameProposal</span><span class=p>,</span> <span class=nx>timestampProposal</span><span class=p>,</span> <span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>HorizontalPodAutoscalerCondition</span><span class=p>{},</span> <span class=kc>nil</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>下面会以 <code>ExternalMetricSourceType</code> 为例。</p>
<h4 id=423-根据计算类型执行对应的计算逻辑>4.2.3. 根据计算类型执行对应的计算逻辑</h4>
<blockquote>
<p>下面以 External 的 AverageValue 为例</p>
</blockquote>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// GetExternalPerPodMetricReplicas calculates the desired replica count based on a
</span><span class=c1>// target metric value per pod (as a milli-value) for the external metric in the
</span><span class=c1>// given namespace, and the current replica count.
</span><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>ReplicaCalculator</span><span class=p>)</span> <span class=nf>GetExternalPerPodMetricReplicas</span><span class=p>(</span><span class=nx>statusReplicas</span> <span class=kt>int32</span><span class=p>,</span> <span class=nx>targetUtilizationPerPod</span> <span class=kt>int64</span><span class=p>,</span> <span class=nx>metricName</span><span class=p>,</span> <span class=nx>namespace</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>metricSelector</span> <span class=o>*</span><span class=nx>metav1</span><span class=p>.</span><span class=nx>LabelSelector</span><span class=p>)</span> <span class=p>(</span><span class=nx>replicaCount</span> <span class=kt>int32</span><span class=p>,</span> <span class=nx>utilization</span> <span class=kt>int64</span><span class=p>,</span> <span class=nx>timestamp</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// 构造 metric 查询 label
</span><span class=c1></span>    <span class=nx>metricLabelSelector</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>metav1</span><span class=p>.</span><span class=nf>LabelSelectorAsSelector</span><span class=p>(</span><span class=nx>metricSelector</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>{},</span> <span class=nx>err</span>
    <span class=p>}</span>
    <span class=c1>// 拉取 metrics
</span><span class=c1></span>    <span class=c1>// https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/#support-for-metrics-apis
</span><span class=c1></span>    <span class=nx>metrics</span><span class=p>,</span> <span class=nx>timestamp</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>metricsClient</span><span class=p>.</span><span class=nf>GetExternalMetric</span><span class=p>(</span><span class=nx>metricName</span><span class=p>,</span> <span class=nx>namespace</span><span class=p>,</span> <span class=nx>metricLabelSelector</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>{},</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;unable to get external metric %s/%s/%+v: %s&#34;</span><span class=p>,</span> <span class=nx>namespace</span><span class=p>,</span> <span class=nx>metricName</span><span class=p>,</span> <span class=nx>metricSelector</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=c1>// 计算总和
</span><span class=c1></span>    <span class=nx>utilization</span> <span class=p>=</span> <span class=mi>0</span>
    <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>val</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>metrics</span> <span class=p>{</span>
        <span class=nx>utilization</span> <span class=p>=</span> <span class=nx>utilization</span> <span class=o>+</span> <span class=nx>val</span>
    <span class=p>}</span>

    <span class=nx>replicaCount</span> <span class=p>=</span> <span class=nx>statusReplicas</span>
    <span class=c1>// 计算 伸缩比例
</span><span class=c1></span>    <span class=c1>// targetUtilizationPerPod 为配置的单个 pod 的预设值，所以需要乘以副本数
</span><span class=c1></span>    <span class=c1>// 如果当前 metric 查询数据为 100， 预设的单个 pod 的值为 20, 当前有3个副本数
</span><span class=c1></span>    <span class=c1>// 此时伸缩比例为 1.6667
</span><span class=c1></span>    <span class=nx>usageRatio</span> <span class=o>:=</span> <span class=nb>float64</span><span class=p>(</span><span class=nx>utilization</span><span class=p>)</span> <span class=o>/</span> <span class=p>(</span><span class=nb>float64</span><span class=p>(</span><span class=nx>targetUtilizationPerPod</span><span class=p>)</span> <span class=o>*</span> <span class=nb>float64</span><span class=p>(</span><span class=nx>replicaCount</span><span class=p>))</span>
    <span class=c1>// c.tolerance 容忍度，默认值为 0.1
</span><span class=c1></span>    <span class=c1>// 如果 1.0 - 伸缩比例 超过容忍度则认为需要伸缩。这里可以理解为查询到的 metric 数据与预设的值浮动小于 10% 时 不需要伸缩
</span><span class=c1></span>    <span class=k>if</span> <span class=nx>math</span><span class=p>.</span><span class=nf>Abs</span><span class=p>(</span><span class=mf>1.0</span><span class=o>-</span><span class=nx>usageRatio</span><span class=p>)</span> <span class=p>&gt;</span> <span class=nx>c</span><span class=p>.</span><span class=nx>tolerance</span> <span class=p>{</span>
        <span class=c1>// update number of replicas if the change is large enough
</span><span class=c1></span>        <span class=c1>// 继续上面的数据计算 新的 replica 数量为 100/20 -&gt; 5
</span><span class=c1></span>        <span class=nx>replicaCount</span> <span class=p>=</span> <span class=nb>int32</span><span class=p>(</span><span class=nx>math</span><span class=p>.</span><span class=nf>Ceil</span><span class=p>(</span><span class=nb>float64</span><span class=p>(</span><span class=nx>utilization</span><span class=p>)</span> <span class=o>/</span> <span class=nb>float64</span><span class=p>(</span><span class=nx>targetUtilizationPerPod</span><span class=p>)))</span>
    <span class=p>}</span>
    <span class=c1>// 计算当前的平均数据 100/3 -&gt; 33.33 这个值会在 HPA 对象的 日志里打印出来可以看到
</span><span class=c1></span>    <span class=nx>utilization</span> <span class=p>=</span> <span class=nb>int64</span><span class=p>(</span><span class=nx>math</span><span class=p>.</span><span class=nf>Ceil</span><span class=p>(</span><span class=nb>float64</span><span class=p>(</span><span class=nx>utilization</span><span class=p>)</span> <span class=o>/</span> <span class=nb>float64</span><span class=p>(</span><span class=nx>statusReplicas</span><span class=p>)))</span>
    <span class=k>return</span> <span class=nx>replicaCount</span><span class=p>,</span> <span class=nx>utilization</span><span class=p>,</span> <span class=nx>timestamp</span><span class=p>,</span> <span class=kc>nil</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>计算结果一路返回到 <code>reconcileAutoscaler</code> 方法进行最终伸缩。</p>
</blockquote>
<h2 id=5-扩展用法>5. 扩展用法</h2>
<p>在实际开发环境只用 <code>cpu</code>, <code>memory</code> 来作为弹性伸缩依据是远远不够的。大多数情况可能会根据 <code>qps</code>, <code>tps</code>, <code>平均延迟时间</code>, <code>MQ 中的消息数量</code>, <code>Redis 中的数据量</code> 等与业务息息相关的数据量判断伸缩的依据，这些都属于 HPA 的 External 类型的范畴。但是 External 类型的数据源需要对接 <code>Adapter</code> 的方式才能用到 HPA 对象内容(具体请查看: <a href=https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/#support-for-metrics-apis target=_blank rel="noopener noreffer">https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/#support-for-metrics-apis</a>) ，也就是说需要额外开发量的。</p>
<p>这里我推荐一个知名度比较高且支持的数据量比较广泛的 Adapter 的实现 &ndash; <a href=https://keda.sh/ target=_blank rel="noopener noreffer">KEDA</a>。基于事件驱动的autoscaler,且支持从 0 到 1 1 到 0 的伸缩，也就是说业务低峰或者无流量时可以降到 0 个副本数(这个在 HPA 被认为是禁用该功能 所以 KEDA 自己实现的 0 到 1 1 到 0 的伸缩的能力，剩余的情况它叫个 HPA 处理)。</p>
<p>目前 KEDA 支持事件类型如下：</p>
<figure><a class=lightgallery href=/posts/hpa-controller/keda.png title=/posts/hpa-controller/keda.png data-thumbnail=/posts/hpa-controller/keda.png data-sub-html="<h2>KEDA 支持的事件</h2>">
<img class=lazyload src=/svg/loading.min.svg data-src=keda.png data-srcset="/posts/hpa-controller/keda.png, keda.png 1.5x, /posts/hpa-controller/keda.png 2x" data-sizes=auto alt=/posts/hpa-controller/keda.png width=800>
</a><figcaption class=image-caption>KEDA 支持的事件</figcaption>
</figure>
<p>只需要创建 KEDA 的 CRD 资源，就能实现基于事件的弹性伸缩，KEDA 的 controller 会创建对应的 HPA 对象。</p>
<p>下面以 <code>Prometheus</code> 为例：</p>
<p>KEDA.ScaledObject:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>keda.sh/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ScaledObject</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prom-scaledobject</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>scaleTargetRef</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>klyn-deploy</span><span class=w>
</span><span class=w>  </span><span class=nt>triggers</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>serverAddress</span><span class=p>:</span><span class=w> </span><span class=l>http://10.103.255.235:9090</span><span class=w> </span><span class=c># Prometheus 查询接口</span><span class=w>
</span><span class=w>      </span><span class=nt>metricName</span><span class=p>:</span><span class=w> </span><span class=l>http_request_count</span><span class=w> </span><span class=c># 自定义名字</span><span class=w>
</span><span class=w>      </span><span class=nt>query</span><span class=p>:</span><span class=w> </span><span class=l>sum(rate(http_request_count{job=&#34;klyn-service&#34;}[2m]))</span><span class=w> </span><span class=c># 查询语句 2m 内的平均 qps</span><span class=w>
</span><span class=w>      </span><span class=nt>threshold</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;50&#39;</span><span class=w>
</span><span class=w>  </span><span class=nt>maxReplicaCount</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span><span class=w>  </span><span class=nt>minReplicaCount</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>  </span><span class=nt>pollingInterval</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>apply 该 yaml 后，会创建一个 <code>ScaledObject</code> 和 <code>HPA</code> 对象。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>➜ kubectl get ScaledObject      
NAME                SCALETARGETKIND      SCALETARGETNAME   MIN   MAX   TRIGGERS     AUTHENTICATION   READY   ACTIVE   FALLBACK   AGE
prom-scaledobject   apps/v1.Deployment   klyn-deploy       <span class=m>1</span>     <span class=m>5</span>     prometheus                    True    False    False      9d

<span class=c1>## 该 HPA 对象有 KEDA 的 controller 创建的</span>
➜ kubectl get hpa               
NAME                         REFERENCE                TARGETS      MINPODS   MAXPODS   REPLICAS   AGE
keda-hpa-prom-scaledobject   Deployment/klyn-deploy   0/50 <span class=o>(</span>avg<span class=o>)</span>   <span class=m>1</span>         <span class=m>5</span>         <span class=m>1</span>          9d
</code></pre></td></tr></table>
</div>
</div><p>这样一来，可以根据很多事件来控制伸缩的能力，这比单一来 cpu,内存利用率来看更灵活且及时。完全可以根据事件在服务的副本数不够用或者有一堆事件准备处理时，尽可能快速扩容，确保处理能力不会受损。</p>
<h2 id=6-总结>6. 总结</h2>
<p>这篇文章主要讲 HPA controller 的源码和如何使用 HPA 相关内容</p>
<ul>
<li><code>HPA/VPA</code> 的解释</li>
<li>如何使用 <code>HPA</code></li>
<li><code>HPA Controller</code> 如何处理一次伸缩事件的</li>
<li><code>HPA Controller</code> 如何计算目标实例数的</li>
<li>认识和使用 <code>KEDA</code> &ndash; 一个基于事件驱动的 autoscaler</li>
</ul>
<h2 id=7-链接>7. 链接🔗</h2>
<ul>
<li><a href=https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/ target=_blank rel="noopener noreffer">horizontal-pod-autoscale</a></li>
<li><a href=https://github.com/kubernetes/autoscaler/tree/master/vertical-pod-autoscaler target=_blank rel="noopener noreffer">pvertical-pod-autoscaler</a></li>
<li><a href=https://github.com/kubernetes-sigs/metrics-server target=_blank rel="noopener noreffer">metrics server</a></li>
<li><a href=https://keda.sh target=_blank rel="noopener noreffer">KEDA</a></li>
</ul></div><div class=post-footer id=post-footer>
<div class=post-info>
<div class=post-info-line>
<div class=post-info-mod>
<span>更新于 2022-01-20</span>
</div>
<div class=post-info-license></div>
</div>
<div class=post-info-line>
<div class=post-info-md><span>
<a class=link-to-markdown href=/posts/hpa-controller/index.md target=_blank>阅读原始文档</a>
</span></div>
<div class=post-info-share>
<span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://yusank.github.io/posts/hpa-controller/ data-title="HPA controller 源码解读" data-hashtags=go,k8s,源码解读><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://yusank.github.io/posts/hpa-controller/ data-hashtag=go><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="分享到 Linkedin" data-sharer=linkedin data-url=https://yusank.github.io/posts/hpa-controller/><i class="fab fa-linkedin fa-fw"></i></a><a href=javascript:void(0); title="分享到 WhatsApp" data-sharer=whatsapp data-url=https://yusank.github.io/posts/hpa-controller/ data-title="HPA controller 源码解读" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href=javascript:void(0); title="分享到 Hacker News" data-sharer=hackernews data-url=https://yusank.github.io/posts/hpa-controller/ data-title="HPA controller 源码解读"><i class="fab fa-hacker-news fa-fw"></i></a><a href=javascript:void(0); title="分享到 Reddit" data-sharer=reddit data-url=https://yusank.github.io/posts/hpa-controller/><i class="fab fa-reddit fa-fw"></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://yusank.github.io/posts/hpa-controller/ data-title="HPA controller 源码解读"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/line.svg></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://yusank.github.io/posts/hpa-controller/ data-title="HPA controller 源码解读" data-ralateuid=yusann><i class="fab fa-weibo fa-fw"></i></a><a href=javascript:void(0); title="分享到 Myspace" data-sharer=myspace data-url=https://yusank.github.io/posts/hpa-controller/ data-title="HPA controller 源码解读" data-description><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/myspace.svg></i></a><a href=javascript:void(0); title="分享到 Blogger" data-sharer=blogger data-url=https://yusank.github.io/posts/hpa-controller/ data-title="HPA controller 源码解读" data-description><i class="fab fa-blogger fa-fw"></i></a><a href=javascript:void(0); title="分享到 百度" data-sharer=baidu data-url=https://yusank.github.io/posts/hpa-controller/ data-title="HPA controller 源码解读"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/baidu.svg></i></a><a href=javascript:void(0); title="分享到 Evernote" data-sharer=evernote data-url=https://yusank.github.io/posts/hpa-controller/ data-title="HPA controller 源码解读"><i class="fab fa-evernote fa-fw"></i></a></span>
</div>
</div>
</div>
<div class=post-info-more>
<section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/go/>go</a>,&nbsp;<a href=/tags/k8s/>k8s</a>,&nbsp;<a href=/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/>源码解读</a></section>
<section>
<span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span>
</section>
</div>
<div class=post-nav><a href=/posts/shard-map/ class=prev rel=prev title="go 语言中的分片 map 的实现"><i class="fas fa-angle-left fa-fw"></i>go 语言中的分片 map 的实现</a></div>
</div>
<div id=comments><div id=utterances></div><noscript>
Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>Utterances</a>.
</noscript></div></article></div>
</main><footer class=footer>
<div class=footer-container><div class=footer-line>Keep learning and stay with lights.<br>❤ yusank<br></div><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.92.0">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
</div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2017 - 2022</span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by/4.0/deed.zh target=_blank>CC BY-NC 4.0</a></span></div>
</div>
</footer></div>
<div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部>
<i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论>
<i class="fas fa-comment fa-fw"></i>
</a>
</div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/copy-tex.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/typeit@7.0.4/dist/typeit.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:100},comment:{utterances:{darkTheme:"github-dark",issueTerm:"pathname",label:"Comment",lightTheme:"github-light",repo:"yusank/yusank.github.io"}},data:{"id-1":"usank`s Site","id-2":"usank`s Site"},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},typeit:{cursorChar:"|",cursorSpeed:1e3,data:{"id-1":["id-1"],"id-2":["id-2"]},duration:-1,speed:70}}</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-24P8ZSJHCQ',{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-24P8ZSJHCQ" async></script></body>
</html>