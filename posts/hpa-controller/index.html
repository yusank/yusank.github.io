<!doctype html><html lang=zh-cn>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=robots content="noodp">
<meta http-equiv=x-ua-compatible content="IE=edge, chrome=1">
<title>HPA controller æºç è§£è¯» - Yusank`s Site</title><meta name=Description content="è¿™æ˜¯æˆ‘çš„ä¸ªäººåšå®¢ï¼Œæˆ‘ä¼šåœ¨è¿™é‡Œåˆ†äº«å­¦ä¹ å’Œæˆé•¿è¿‡ç¨‹ä¸­çš„ç§¯ç´¯å’Œç»éªŒ."><meta property="og:title" content="HPA controller æºç è§£è¯»">
<meta property="og:description" content="
æœ¬ç¯‡è®²è¿° kubernetes çš„æ¨ªå‘ pod ä¼¸ç¼©(HorizontalPodAutoscaler) æ§åˆ¶å™¨çš„æ•°æ®ç»“æ„ï¼Œé€»è¾‘å¤„ç†ï¼Œmetrics è®¡ç®—ä»¥åŠç›¸å…³ç»†èŠ‚çš„æºç è§£è¯»ã€‚
">
<meta property="og:type" content="article">
<meta property="og:url" content="https://yusank.github.io/posts/hpa-controller/"><meta property="og:image" content="https://yusank.github.io/logo.png"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2022-01-20T10:50:00+08:00">
<meta property="article:modified_time" content="2022-01-20T17:06:31+08:00">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://yusank.github.io/logo.png">
<meta name=twitter:title content="HPA controller æºç è§£è¯»">
<meta name=twitter:description content="
æœ¬ç¯‡è®²è¿° kubernetes çš„æ¨ªå‘ pod ä¼¸ç¼©(HorizontalPodAutoscaler) æ§åˆ¶å™¨çš„æ•°æ®ç»“æ„ï¼Œé€»è¾‘å¤„ç†ï¼Œmetrics è®¡ç®—ä»¥åŠç›¸å…³ç»†èŠ‚çš„æºç è§£è¯»ã€‚
">
<meta name=application-name content="Yusank's Site">
<meta name=apple-mobile-web-app-title content="Yusank's Site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel=icon href=https://yusank.github.io/images/logo.svg><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://yusank.github.io/posts/hpa-controller/><link rel=prev href=https://yusank.github.io/posts/shard-map/><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"HPA controller æºç è§£è¯»","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/yusank.github.io\/posts\/hpa-controller\/"},"genre":"posts","keywords":"go, k8s, æºç è§£è¯»","wordcount":5689,"url":"https:\/\/yusank.github.io\/posts\/hpa-controller\/","datePublished":"2022-01-20T10:50:00+08:00","dateModified":"2022-01-20T17:06:31+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Yusank"},"description":""}</script></head>
<body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':'auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark')&&document.body.setAttribute('theme','dark')</script>
<div id=mask></div><div class=wrapper><header class=desktop id=header-desktop>
<div class=header-wrapper>
<div class=header-title>
<a href=/ title="Yusank`s Site"><img class="lazyload logo" src=/svg/loading.min.svg data-src=https://yusank.github.io/images/logo.svg data-srcset="https://yusank.github.io/images/logo.svg, https://yusank.github.io/images/logo.svg 1.5x, https://yusank.github.io/images/logo.svg 2x" data-sizes=auto alt=https://yusank.github.io/images/logo.svg title=https://yusank.github.io/images/logo.svg><span id=id-1 class=typeit></span></a>
</div>
<div class=menu>
<div class=menu-inner><a class=menu-item href=/posts/> æ–‡ç«  </a><a class=menu-item href=/categories/> åˆ†ç±» </a><a class=menu-item href=/tags/> æ ‡ç­¾ </a><a class=menu-item href=/about/> å…³äº </a><a class=menu-item href=/links/> å‹é“¾ </a><a class=menu-item href=https://github.com/yusank title=GitHub rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i> </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title=åˆ‡æ¢ä¸»é¢˜>
<i class="fas fa-adjust fa-fw"></i>
</a>
</div>
</div>
</div>
</header><header class=mobile id=header-mobile>
<div class=header-container>
<div class=header-wrapper>
<div class=header-title>
<a href=/ title="Yusank`s Site"><img class="lazyload logo" src=/svg/loading.min.svg data-src=https://yusank.github.io/images/logo.svg data-srcset="https://yusank.github.io/images/logo.svg, https://yusank.github.io/images/logo.svg 1.5x, https://yusank.github.io/images/logo.svg 2x" data-sizes=auto alt=https://yusank.github.io/images/logo.svg title=https://yusank.github.io/images/logo.svg><span id=id-2 class=typeit></span></a>
</div>
<div class=menu-toggle id=menu-toggle-mobile>
<span></span><span></span><span></span>
</div>
</div>
<div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>æ–‡ç« </a><a class=menu-item href=/categories/ title>åˆ†ç±»</a><a class=menu-item href=/tags/ title>æ ‡ç­¾</a><a class=menu-item href=/about/ title>å…³äº</a><a class=menu-item href=/links/ title>å‹é“¾</a><a class=menu-item href=https://github.com/yusank title=GitHub rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i></a><a href=javascript:void(0); class="menu-item theme-switch" title=åˆ‡æ¢ä¸»é¢˜>
<i class="fas fa-adjust fa-fw"></i>
</a></div>
</div>
</header>
<div class="search-dropdown desktop">
<div id=search-dropdown-desktop></div>
</div>
<div class="search-dropdown mobile">
<div id=search-dropdown-mobile></div>
</div>
<main class=main>
<div class=container><div class=toc id=toc-auto>
<h2 class=toc-title>ç›®å½•</h2>
<div class=toc-content id=toc-content-auto></div>
</div><article class="page single"><h1 class="single-title animated flipInX">HPA controller æºç è§£è¯»</h1><div class=post-meta>
<div class=post-meta-line><span class=post-author><a href=https://github.com/yusank title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw"></i>Yusank</a></span>&nbsp;<span class=post-category>æ”¶å½•äº <a href=/categories/kubernetes/><i class="far fa-folder fa-fw"></i>kubernetes</a></span></div>
<div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2022-01-20>2022-01-20</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;çº¦ 5689 å­—&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;é¢„è®¡é˜…è¯» 12 åˆ†é’Ÿ&nbsp;</div>
</div><div class="details toc" id=toc-static kept>
<div class="details-summary toc-title">
<span>ç›®å½•</span>
<span><i class="details-icon fas fa-angle-right"></i></span>
</div>
<div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents>
<ul>
<li><a href=#1-å‰è¨€>1. å‰è¨€</a>
<ul>
<li><a href=#11-hpa>1.1. HPA</a></li>
<li><a href=#12-vpa>1.2. VPA</a></li>
</ul>
</li>
<li><a href=#2-åŸºç¡€ç”¨æ³•>2. åŸºç¡€ç”¨æ³•</a></li>
<li><a href=#3-æ•°æ®ç»“æ„>3. æ•°æ®ç»“æ„</a></li>
<li><a href=#4-æ§åˆ¶å™¨é€»è¾‘>4. æ§åˆ¶å™¨é€»è¾‘</a>
<ul>
<li><a href=#41-ä¼¸ç¼©è¿‡ç¨‹>4.1. ä¼¸ç¼©è¿‡ç¨‹</a>
<ul>
<li><a href=#411-ä»-queue-è¯»å–ä¸€æ¡æ¶ˆæ¯æ ¹æ®æ¶ˆæ¯ä¸­çš„ä¿¡æ¯è·å–-hpa-å¯¹è±¡>4.1.1. ä» <code>queue</code> è¯»å–ä¸€æ¡æ¶ˆæ¯ï¼Œæ ¹æ®æ¶ˆæ¯ä¸­çš„ä¿¡æ¯ï¼Œè·å– <code>hpa</code> å¯¹è±¡</a></li>
<li><a href=#412-ä¸ºäº†å…¼å®¹è€ç‰ˆæœ¬è¯»å–æ—¶-hpa-å¯¹è±¡ä¸º-v1-ç‰ˆæœ¬è¯»å–ååœ¨ä»£ç é‡Œä¼šå…ˆç»Ÿä¸€è½¬æ¢ä¸º-v2-ç‰ˆæœ¬ä»è€Œä¹‹åçš„é€»è¾‘ç»Ÿä¸€>4.1.2. ä¸ºäº†å…¼å®¹è€ç‰ˆæœ¬ï¼Œè¯»å–æ—¶ hpa å¯¹è±¡ä¸º v1 ç‰ˆæœ¬ï¼Œè¯»å–ååœ¨ä»£ç é‡Œä¼šå…ˆç»Ÿä¸€è½¬æ¢ä¸º v2 ç‰ˆæœ¬,ä»è€Œä¹‹åçš„é€»è¾‘ç»Ÿä¸€</a></li>
<li><a href=#413-æ ¹æ®-hpaspecscaletargetref-ä¿¡æ¯è¯»åˆ°éœ€è¦ä¼¸ç¼©çš„èµ„æº>4.1.3. æ ¹æ® <code>hpa.Spec.ScaleTargetRef</code> ä¿¡æ¯è¯»åˆ°éœ€è¦ä¼¸ç¼©çš„èµ„æº</a></li>
<li><a href=#414-ç¡®å®šå½“å‰å‰¯æœ¬æ•°æœ€å¤§æœ€å°å¯ä¼¸ç¼©çš„å‰¯æœ¬æ•°>4.1.4. ç¡®å®šå½“å‰å‰¯æœ¬æ•°ï¼Œæœ€å¤§æœ€å°å¯ä¼¸ç¼©çš„å‰¯æœ¬æ•°</a></li>
<li><a href=#415-è®¡ç®—å¹¶å¤„ç†å‰¯æœ¬æ•°>4.1.5. è®¡ç®—å¹¶å¤„ç†å‰¯æœ¬æ•°</a></li>
<li><a href=#416-è°ƒæ•´å‰¯æœ¬æ•°>4.1.6. è°ƒæ•´å‰¯æœ¬æ•°</a></li>
</ul>
</li>
<li><a href=#42-è®¡ç®—å‰¯æœ¬æ•°è¿‡ç¨‹>4.2. è®¡ç®—å‰¯æœ¬æ•°è¿‡ç¨‹</a>
<ul>
<li><a href=#421-éå†-specmetrics-è®¡ç®—å¾—å‡ºæœ€å¤§å€¼>4.2.1. éå† <code>spec.Metrics</code> è®¡ç®—å¾—å‡ºæœ€å¤§å€¼</a></li>
<li><a href=#422-è®¡ç®—å•ä¸ª-metricæ ¹æ®ç±»å‹è®¡ç®—-metric>4.2.2. è®¡ç®—å•ä¸ª metricï¼šæ ¹æ®ç±»å‹è®¡ç®— metric</a></li>
<li><a href=#423-æ ¹æ®è®¡ç®—ç±»å‹æ‰§è¡Œå¯¹åº”çš„è®¡ç®—é€»è¾‘>4.2.3. æ ¹æ®è®¡ç®—ç±»å‹æ‰§è¡Œå¯¹åº”çš„è®¡ç®—é€»è¾‘</a></li>
</ul>
</li>
</ul>
</li>
<li><a href=#5-æ‰©å±•ç”¨æ³•>5. æ‰©å±•ç”¨æ³•</a></li>
<li><a href=#6-æ€»ç»“>6. æ€»ç»“</a></li>
<li><a href=#7-é“¾æ¥>7. é“¾æ¥ğŸ”—</a></li>
</ul>
</nav></div>
</div><div class=content id=content><blockquote>
<p>æœ¬ç¯‡è®²è¿° <code>kubernetes</code> çš„æ¨ªå‘ pod ä¼¸ç¼©(HorizontalPodAutoscaler) æ§åˆ¶å™¨çš„æ•°æ®ç»“æ„ï¼Œé€»è¾‘å¤„ç†ï¼Œmetrics è®¡ç®—ä»¥åŠç›¸å…³ç»†èŠ‚çš„æºç è§£è¯»ã€‚</p>
</blockquote>
<h2 id=1-å‰è¨€>1. å‰è¨€</h2>
<p>åœ¨ <code>k8s</code> ç¯å¢ƒå†…å¼¹æ€§ä¼¸ç¼©å¹¶ä¸æ˜¯ä¸€ä¸ªé™Œç”Ÿçš„æ¦‚å¿µï¼Œæ˜¯ä¸€ä¸ªå¸¸è§ä¸”ä¸éš¾ç†è§£çš„äº‹ä»¶ã€‚å°±æ˜¯æ ¹æ®ç‰¹å®šçš„äº‹ä»¶æˆ–æ•°æ®æ¥è§¦å‘å¯ä¼¸ç¼©èµ„æºçš„ä¼¸ç¼©èƒ½åŠ›ã€‚ä¸€èˆ¬æœ‰ HPA å’Œ VPA ä¸¤ä¸ªæ¦‚å¿µï¼ŒHPA å…¨ç§° <a href=https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/ target=_blank rel="noopener noreffer">Horizontal Pod Autoscaler</a> å³æ¨ªå‘ pod çš„è‡ªåŠ¨ä¼¸ç¼©ï¼ŒVPA å…¨ç§° <a href=https://github.com/kubernetes/autoscaler/tree/master/vertical-pod-autoscaler target=_blank rel="noopener noreffer">Vertical Pod Autoscaler</a> å³çºµå‘ pod çš„è‡ªåŠ¨ä¼¸ç¼©ã€‚</p>
<h3 id=11-hpa>1.1. HPA</h3>
<p><code>HPA</code> å…³æ³¨ pod çš„æ•°é‡ï¼Œæ ¹æ®ç°æœ‰ pod çš„æ•°æ®(cpu, memory)æˆ–å¤–éƒ¨æ•°æ®(metrics)æ¥è®¡ç®—å®é™…éœ€è¦çš„ pod æ•°é‡ï¼Œä»è€Œè°ƒæ•´ pod çš„æ€»æ•°ã€‚<code>HPA</code> æ“ä½œçš„å¯¹è±¡éœ€è¦å®ç° <code>ScaleInterface</code> ã€‚</p>
<div class="details admonition quote open">
<div class="details-summary admonition-title">
<i class="icon fas fa-quote-right fa-fw"></i>ScaleInterface<i class="details-icon fas fa-angle-right fa-fw"></i>
</div>
<div class=details-content>
<div class=admonition-content><div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// ScaleInterface can fetch and update scales for
</span><span class=c1>// resources in a particular namespace which implement
</span><span class=c1>// the scale subresource.
</span><span class=c1></span><span class=kd>type</span> <span class=nx>ScaleInterface</span> <span class=kd>interface</span> <span class=p>{</span>
    <span class=c1>// Get fetches the scale of the given scalable resource.
</span><span class=c1></span>    <span class=nf>Get</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>resource</span> <span class=nx>schema</span><span class=p>.</span><span class=nx>GroupResource</span><span class=p>,</span> <span class=nx>name</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>opts</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>GetOptions</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>autoscalingapi</span><span class=p>.</span><span class=nx>Scale</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>

    <span class=c1>// Update updates the scale of the given scalable resource.
</span><span class=c1></span>    <span class=nf>Update</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>resource</span> <span class=nx>schema</span><span class=p>.</span><span class=nx>GroupResource</span><span class=p>,</span> <span class=nx>scale</span> <span class=o>*</span><span class=nx>autoscalingapi</span><span class=p>.</span><span class=nx>Scale</span><span class=p>,</span> <span class=nx>opts</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>UpdateOptions</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>autoscalingapi</span><span class=p>.</span><span class=nx>Scale</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>

    <span class=c1>// Patch patches the scale of the given scalable resource.
</span><span class=c1></span>    <span class=nf>Patch</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>gvr</span> <span class=nx>schema</span><span class=p>.</span><span class=nx>GroupVersionResource</span><span class=p>,</span> <span class=nx>name</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>pt</span> <span class=nx>types</span><span class=p>.</span><span class=nx>PatchType</span><span class=p>,</span> <span class=nx>data</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>,</span> <span class=nx>opts</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>PatchOptions</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>autoscalingapi</span><span class=p>.</span><span class=nx>Scale</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div></div>
</div>
</div>
<p>k8s åŸç”Ÿèµ„æºä¸­ HPA å¯æ“ä½œæ€§çš„å¯¹è±¡æ˜¯ä»¥ä¸‹ä¸‰ä¸ª:</p>
<ul>
<li><code>Deployment</code></li>
<li><code>ReplicaSet</code></li>
<li><code>StatefulSet</code></li>
</ul>
<p>ä¸€èˆ¬ä¸šåŠ¡åœºæ™¯ç”¨ HPA èƒ½æ»¡è¶³éœ€æ±‚ï¼Œå³ä¸šåŠ¡é«˜å³°å¢åŠ  pod æ•°æ›´å¥½å¤„ç†ä¸šåŠ¡ï¼Œä¸šåŠ¡ä½å³°é™ä½pod æ•°èŠ‚çœèµ„æºã€‚</p>
<h3 id=12-vpa>1.2. VPA</h3>
<p><code>VPA</code> å…³æ³¨çš„æ˜¯ pod çš„èµ„æºï¼Œæ ¹æ®å½“å‰èµ„æºåˆ©ç”¨ç‡ç­‰æ•°æ®ä¸º pod æä¾›æ›´å¤šçš„èµ„æºï¼ˆcpuï¼Œmemory ç­‰ï¼‰ã€‚æœ¬äººå¯¹ VPA ä¹Ÿæ˜¯è¡¨é¢ç†è§£ï¼Œæ‰€ä»¥è¿™é‡Œä¸åšè¯¦ç»†çš„è§£è¯»ã€‚</p>
<p><code>VPA</code> æ›´é€‚åˆå¤§è®¡ç®—ã€ç¦»çº¿è®¡ç®—ã€æœºå™¨å­¦ä¹ ç­‰åœºæ™¯ï¼Œéœ€è¦å¤§é‡çš„ CPUï¼ŒGPUï¼Œå†…å­˜æ¥è¿›è¡Œè®¡ç®—ã€‚</p>
<h2 id=2-åŸºç¡€ç”¨æ³•>2. åŸºç¡€ç”¨æ³•</h2>
<p>é€šè¿‡ä»¥ä¸‹å‘½ä»¤å¼€å¯å¯¹æŸä¸ªèµ„æºçš„ HPA èƒ½åŠ›ï¼š</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>âœ kubectl autoscale <span class=o>(</span>-f FILENAME <span class=p>|</span> TYPE NAME <span class=p>|</span> TYPE/NAME<span class=o>)</span> <span class=o>[</span>--min<span class=o>=</span>MINPODS<span class=o>]</span> --max<span class=o>=</span>MAXPODS <span class=o>[</span>--cpu-percent<span class=o>=</span>CPU<span class=o>]</span> <span class=o>[</span>options<span class=o>]</span>
</code></pre></td></tr></table>
</div>
</div><div class="details admonition warning open">
<div class="details-summary admonition-title">
<i class="icon fas fa-exclamation-triangle fa-fw"></i>Warning<i class="details-icon fas fa-angle-right fa-fw"></i>
</div>
<div class=details-content>
<div class=admonition-content>éœ€è¦å¼€å¯ <code>metric server</code> æ‰èƒ½è¯»å–åˆ°cpu åˆ©ç”¨ç‡ï¼Œé»˜è®¤æ˜¯ä¸å¼€å¯çš„ã€‚è¯¦æƒ…è¯·çœ‹å®˜æ–¹æ–‡æ¡£: <a href=https://github.com/kubernetes-sigs/metrics-server target=_blank rel="noopener noreffer">https://github.com/kubernetes-sigs/metrics-server</a></div>
</div>
</div>
<p>å®é™…ä½¿ç”¨å¦‚ä¸‹ï¼š</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=c1># å¯¹ deployment/klyn-deploy è¿›è¡Œ CPU ç›‘æ§ï¼Œè¶…è¿‡ 10%çš„å¹³å‡åˆ©ç”¨ç‡å³è¿›è¡Œscale upï¼Œæœ€å¤§ 3 ä¸ª pod æœ€å° 1 ä¸ª</span>
âœ kubectl autoscale deployment klyn-deploy --cpu-percent<span class=o>=</span><span class=m>10</span> --min<span class=o>=</span><span class=m>1</span> --max<span class=o>=</span><span class=m>3</span>
</code></pre></td></tr></table>
</div>
</div><p>ç„¶åå¯ä»¥é€šè¿‡ <code>describe</code> å‘½ä»¤æŸ¥çœ‹åˆ›å»ºå HPA çš„è¯¦æƒ…ï¼š</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>âœ kubectl describe hpa klyn-deploy
Warning: autoscaling/v2beta2 HorizontalPodAutoscaler is deprecated in v1.23+, unavailable in v1.26+
Name:                                                  klyn-deploy
Namespace:                                             default
Labels:                                                &lt;none&gt;
Annotations:                                           &lt;none&gt;
CreationTimestamp:                                     Thu, <span class=m>20</span> Jan <span class=m>2022</span> 11:43:43 +0800
Reference:                                             Deployment/klyn-deploy
Metrics:                                               <span class=o>(</span> current / target <span class=o>)</span>
  resource cpu on pods  <span class=o>(</span>as a percentage of request<span class=o>)</span>:  4% <span class=o>(</span>10m<span class=o>)</span> / 10% <span class=c1># å¯ä»¥çœ‹åˆ°å·²ç»è¯»åˆ° cpu æ•°æ®</span>
Min replicas:                                          <span class=m>1</span>
Max replicas:                                          <span class=m>3</span>
Deployment pods:                                       <span class=m>1</span> current / <span class=m>1</span> desired
Conditions:
  Type            Status  Reason              Message
  ----            ------  ------              -------
  AbleToScale     True    ReadyForNewScale    recommended size matches current size
  ScalingActive   True    ValidMetricFound    the HPA was able to successfully calculate a replica count from cpu resource utilization <span class=o>(</span>percentage of request<span class=o>)</span>
  ScalingLimited  False   DesiredWithinRange  the desired count is within the acceptable range
Events:           &lt;none&gt;
</code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥ä»ä¸Šè¿°è¯¦æƒ…çœ‹åˆ° HPA èµ„æºçš„è¯¦ç»†ä¿¡æ¯ä»¥åŠæœ€ä¸‹é¢çš„æ­¥éª¤ä¿¡æ¯ï¼Œå½“è¿›è¡Œä¼¸ç¼©æ—¶ä¼šåŒæ­¥ä¼¸ç¼©è¿‡ç¨‹å’ŒåŸå› åˆ° <code>Events</code> å­—æ®µä¸Šã€‚</p>
<p>ä¹‹åå¯ä»¥é€šè¿‡å‹æµ‹çš„æ–¹å¼å°† cpu çš„åˆ©ç”¨ç‡æå‡ç„¶åå¯ä»¥åˆ° <code>Deployment</code> çš„ replicas æ•°é‡çš„æå‡ï¼Œå¹¶å‹æµ‹ç»“æŸä¸€æ®µæ—¶é—´(ä¼šæœ‰å†·å´æ—¶é—´)ååˆé™åˆ° 1 ä¸ª replicas.</p>
<h2 id=3-æ•°æ®ç»“æ„>3. æ•°æ®ç»“æ„</h2>
<p>HPA èµ„æº YAML ç»“æ„ï¼š</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>autoscaling/v2</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>HorizontalPodAutoscaler</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2022-01-20T03:43:43Z&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>klyn-deploy</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w>  </span><span class=nt>resourceVersion</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;6602029&#34;</span><span class=w>
</span><span class=w>  </span><span class=nt>uid</span><span class=p>:</span><span class=w> </span><span class=l>385f4234-025b-453d-8270-788f7ce3ced6</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>maxReplicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span><span class=w>  </span><span class=nt>metrics</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>resource</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cpu</span><span class=w>
</span><span class=w>      </span><span class=nt>target</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>averageUtilization</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span><span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Utilization</span><span class=w>
</span><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Resource</span><span class=w>
</span><span class=w>  </span><span class=nt>minReplicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>  </span><span class=nt>scaleTargetRef</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>klyn-deploy</span><span class=w>
</span><span class=w></span><span class=nt>status</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>conditions</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>lastTransitionTime</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2022-01-20T03:43:58Z&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>message</span><span class=p>:</span><span class=w> </span><span class=l>recommended size matches current size</span><span class=w>
</span><span class=w>    </span><span class=nt>reason</span><span class=p>:</span><span class=w> </span><span class=l>ReadyForNewScale</span><span class=w>
</span><span class=w>    </span><span class=nt>status</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;True&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>AbleToScale</span><span class=w>
</span><span class=w>  </span>- <span class=nt>lastTransitionTime</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2022-01-20T03:43:58Z&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>message</span><span class=p>:</span><span class=w> </span><span class=l>the HPA was able to successfully calculate a replica count from cpu resource</span><span class=w>
</span><span class=w>      </span><span class=l>utilization (percentage of request)</span><span class=w>
</span><span class=w>    </span><span class=nt>reason</span><span class=p>:</span><span class=w> </span><span class=l>ValidMetricFound</span><span class=w>
</span><span class=w>    </span><span class=nt>status</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;True&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ScalingActive</span><span class=w>
</span><span class=w>  </span>- <span class=nt>lastTransitionTime</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2022-01-20T03:43:58Z&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>message</span><span class=p>:</span><span class=w> </span><span class=l>the desired count is within the acceptable range</span><span class=w>
</span><span class=w>    </span><span class=nt>reason</span><span class=p>:</span><span class=w> </span><span class=l>DesiredWithinRange</span><span class=w>
</span><span class=w>    </span><span class=nt>status</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;False&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ScalingLimited</span><span class=w>
</span><span class=w>  </span><span class=nt>currentMetrics</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>resource</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>current</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>averageUtilization</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span><span class=w>        </span><span class=nt>averageValue</span><span class=p>:</span><span class=w> </span><span class=l>9m</span><span class=w>
</span><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cpu</span><span class=w>
</span><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Resource</span><span class=w>
</span><span class=w>  </span><span class=nt>currentReplicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>  </span><span class=nt>desiredReplicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>  </span><span class=nt>lastScaleTime</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2022-01-20T03:51:44Z&#34;</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šé¢å¯¹ <code>HPA</code> çš„æ¦‚å¿µå’Œå¦‚ä½•ä½¿ç”¨æœ‰äº†ä¸€å®šçš„è®¤çŸ¥ï¼Œä»è¿™é‡Œå¼€å§‹å¯¹ HPA Controller çš„æºç è¿›è¡Œè§£è¯»ã€‚</p>
<p>æ•°æ®ç»“æ„ï¼š</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// HorizontalController is responsible for the synchronizing HPA objects stored
</span><span class=c1>// in the system with the actual deployments/replication controllers they
</span><span class=c1>// control.
</span><span class=c1></span><span class=kd>type</span> <span class=nx>HorizontalController</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=c1>// Scale èµ„æºçš„è¯»å†™ï¼ˆå¦‚ Deployment çš„ Scaleï¼‰
</span><span class=c1></span>    <span class=nx>scaleNamespacer</span> <span class=nx>scaleclient</span><span class=p>.</span><span class=nx>ScalesGetter</span>
    <span class=c1>// HorizontalPodAutoscaler èµ„æºçš„è¯»å†™
</span><span class=c1></span>    <span class=nx>hpaNamespacer</span>   <span class=nx>autoscalingclient</span><span class=p>.</span><span class=nx>HorizontalPodAutoscalersGetter</span>
    <span class=c1>// ç”¨äºæ ¹æ®ç±»å‹å’Œç‰ˆæœ¬è·å–èµ„æºä¿¡æ¯
</span><span class=c1></span>    <span class=nx>mapper</span>          <span class=nx>apimeta</span><span class=p>.</span><span class=nx>RESTMapper</span>
     
    <span class=c1>// è®¡ç®— replica æ•°é‡
</span><span class=c1></span>    <span class=nx>replicaCalc</span>   <span class=o>*</span><span class=nx>ReplicaCalculator</span>
    <span class=c1>// è®¢é˜… HPA èµ„æºï¼Œå¤„ç†èµ„æºå˜åŒ–
</span><span class=c1></span>    <span class=nx>eventRecorder</span> <span class=nx>record</span><span class=p>.</span><span class=nx>EventRecorder</span>
 
    <span class=c1>// æ¯æ¬¡ç¼©å®¹ä¹‹é—´ç­‰å¾…æ—¶é—´
</span><span class=c1></span>    <span class=nx>downscaleStabilisationWindow</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span>
 
    <span class=c1>// hpaLister is able to list/get HPAs from the shared cache from the informer passed in to
</span><span class=c1></span>    <span class=c1>// NewHorizontalController.
</span><span class=c1></span>    <span class=c1>// ç”¨äºè¯»å– hpa å¯¹è±¡
</span><span class=c1></span>    <span class=nx>hpaLister</span>       <span class=nx>autoscalinglisters</span><span class=p>.</span><span class=nx>HorizontalPodAutoscalerLister</span>
    <span class=nx>hpaListerSynced</span> <span class=nx>cache</span><span class=p>.</span><span class=nx>InformerSynced</span>
 
    <span class=c1>// podLister is able to list/get Pods from the shared cache from the informer passed in to
</span><span class=c1></span>    <span class=c1>// NewHorizontalController.
</span><span class=c1></span>    <span class=c1>// ç”¨äºè¯»å– pod èµ„æº
</span><span class=c1></span>    <span class=nx>podLister</span>       <span class=nx>corelisters</span><span class=p>.</span><span class=nx>PodLister</span>
    <span class=nx>podListerSynced</span> <span class=nx>cache</span><span class=p>.</span><span class=nx>InformerSynced</span>
 
    <span class=c1>// Controllers that need to be synced
</span><span class=c1></span>    <span class=c1>// åªä¼šå¯åŠ¨ä¸€ä¸ª workerï¼Œå³å¦‚æœæœ‰å¤§é‡çš„ HPA èµ„æºæ—¶ï¼Œä¸€éƒ¨åˆ†èµ„æºçš„æ‰©ç¼©å®¹å¯èƒ½ä¸é‚£ä¹ˆåŠæ—¶
</span><span class=c1></span>    <span class=nx>queue</span> <span class=nx>workqueue</span><span class=p>.</span><span class=nx>RateLimitingInterface</span>
 
    <span class=c1>// Latest unstabilized recommendations for each autoscaler.
</span><span class=c1></span>    <span class=c1>// è®°å½•æ¨èä¼¸ç¼©æ•°é‡
</span><span class=c1></span>    <span class=nx>recommendations</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>][]</span><span class=nx>timestampedRecommendation</span>
 
    <span class=c1>// Latest autoscaler events
</span><span class=c1></span>    <span class=c1>// è®°å½•ä¼¸ç¼©äº‹ä»¶
</span><span class=c1></span>    <span class=nx>scaleUpEvents</span>   <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>][]</span><span class=nx>timestampedScaleEvent</span>
    <span class=nx>scaleDownEvents</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>][]</span><span class=nx>timestampedScaleEvent</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id=4-æ§åˆ¶å™¨é€»è¾‘>4. æ§åˆ¶å™¨é€»è¾‘</h2>
<h3 id=41-ä¼¸ç¼©è¿‡ç¨‹>4.1. ä¼¸ç¼©è¿‡ç¨‹</h3>
<p>ä¼¸ç¼©è¿‡ç¨‹çš„è§¦å‘ä¸æ˜¯å®æ—¶çš„ï¼Œè€Œæ˜¯ä» <code>queue</code> é‡Œæ¶ˆè´¹æ•°æ®ï¼Œè¿›è¡Œä¸€æ¬¡ä¼¸ç¼©æµç¨‹ï¼Œå†æ¬¡å°†èµ„æºåæ”¾å…¥ <code>queue</code>, å®Œæˆä¸€æ¬¡å¾ªç¯ã€‚</p>
<p>è¯¦ç»†æµç¨‹å¦‚ä¸‹ï¼š</p>
<h4 id=411-ä»-queue-è¯»å–ä¸€æ¡æ¶ˆæ¯æ ¹æ®æ¶ˆæ¯ä¸­çš„ä¿¡æ¯è·å–-hpa-å¯¹è±¡>4.1.1. ä» <code>queue</code> è¯»å–ä¸€æ¡æ¶ˆæ¯ï¼Œæ ¹æ®æ¶ˆæ¯ä¸­çš„ä¿¡æ¯ï¼Œè·å– <code>hpa</code> å¯¹è±¡</h4>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=p>(</span><span class=nx>a</span> <span class=o>*</span><span class=nx>HorizontalController</span><span class=p>)</span> <span class=nf>processNextWorkItem</span><span class=p>()</span> <span class=kt>bool</span> <span class=p>{</span>
    <span class=nx>key</span><span class=p>,</span> <span class=nx>quit</span> <span class=o>:=</span> <span class=nx>a</span><span class=p>.</span><span class=nx>queue</span><span class=p>.</span><span class=nf>Get</span><span class=p>()</span>
    <span class=k>if</span> <span class=nx>quit</span> <span class=p>{</span>
        <span class=k>return</span> <span class=kc>false</span>
    <span class=p>}</span>
    <span class=c1>// å¤„ç†å®Œæ ‡è®°å®Œæˆ
</span><span class=c1></span>    <span class=k>defer</span> <span class=nx>a</span><span class=p>.</span><span class=nx>queue</span><span class=p>.</span><span class=nf>Done</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span>

    <span class=c1>// å¤„ç†å‡½æ•°å…¥å£
</span><span class=c1></span>    <span class=nx>deleted</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>a</span><span class=p>.</span><span class=nf>reconcileKey</span><span class=p>(</span><span class=nx>key</span><span class=p>.(</span><span class=kt>string</span><span class=p>))</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>utilruntime</span><span class=p>.</span><span class=nf>HandleError</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=c1>// Add request processing HPA to queue with resyncPeriod delay.
</span><span class=c1></span>    <span class=c1>// Requests are always added to queue with resyncPeriod delay. If there&#39;s already request
</span><span class=c1></span>    <span class=c1>// for the HPA in the queue then a new request is always dropped. Requests spend resyncPeriod
</span><span class=c1></span>    <span class=c1>// in queue so HPAs are processed every resyncPeriod.
</span><span class=c1></span>    <span class=c1>// Request is added here just in case last resync didn&#39;t insert request into the queue. This
</span><span class=c1></span>    <span class=c1>// happens quite often because there is race condition between adding request after resyncPeriod
</span><span class=c1></span>    <span class=c1>// and removing them from queue. Request can be added by resync before previous request is
</span><span class=c1></span>    <span class=c1>// removed from queue. If we didn&#39;t add request here then in this case one request would be dropped
</span><span class=c1></span>    <span class=c1>// and HPA would processed after 2 x resyncPeriod.
</span><span class=c1></span>    <span class=k>if</span> <span class=p>!</span><span class=nx>deleted</span> <span class=p>{</span>
        <span class=c1>// å¦‚æœ hpa æ²¡æœ‰è¢«åˆ é™¤ï¼Œå†æ¬¡æ”¾å›é˜Ÿåˆ—é‡Œï¼Œç»è¿‡é»˜è®¤æ—¶é—´é—´éš”ï¼ˆ15sï¼Œk8s å¯åŠ¨å‚æ•°å¯é…ç½®ï¼‰åå†è¯»å–å¤„ç†ä¸€æ¬¡
</span><span class=c1></span>        <span class=nx>a</span><span class=p>.</span><span class=nx>queue</span><span class=p>.</span><span class=nf>AddRateLimited</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=k>return</span> <span class=kc>true</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>a</span> <span class=o>*</span><span class=nx>HorizontalController</span><span class=p>)</span> <span class=nf>reconcileKey</span><span class=p>(</span><span class=nx>key</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>deleted</span> <span class=kt>bool</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>namespace</span><span class=p>,</span> <span class=nx>name</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>cache</span><span class=p>.</span><span class=nf>SplitMetaNamespaceKey</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=k>return</span> <span class=kc>true</span><span class=p>,</span> <span class=nx>err</span>
    <span class=p>}</span>

    <span class=c1>// è¯»å– hpa å¯¹è±¡ `*autoscalingv1.HorizontalPodAutoscaler`
</span><span class=c1></span>    <span class=nx>hpa</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>a</span><span class=p>.</span><span class=nx>hpaLister</span><span class=p>.</span><span class=nf>HorizontalPodAutoscalers</span><span class=p>(</span><span class=nx>namespace</span><span class=p>).</span><span class=nf>Get</span><span class=p>(</span><span class=nx>name</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>IsNotFound</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
        <span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Horizontal Pod Autoscaler %s has been deleted in %s&#34;</span><span class=p>,</span> <span class=nx>name</span><span class=p>,</span> <span class=nx>namespace</span><span class=p>)</span>
        <span class=nb>delete</span><span class=p>(</span><span class=nx>a</span><span class=p>.</span><span class=nx>recommendations</span><span class=p>,</span> <span class=nx>key</span><span class=p>)</span>
        <span class=nb>delete</span><span class=p>(</span><span class=nx>a</span><span class=p>.</span><span class=nx>scaleUpEvents</span><span class=p>,</span> <span class=nx>key</span><span class=p>)</span>
        <span class=nb>delete</span><span class=p>(</span><span class=nx>a</span><span class=p>.</span><span class=nx>scaleDownEvents</span><span class=p>,</span> <span class=nx>key</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>true</span><span class=p>,</span> <span class=kc>nil</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=k>return</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>err</span>
    <span class=p>}</span>

    <span class=c1>// å¤„ç†æœ¬æ¬¡ä¼¸ç¼©é€»è¾‘
</span><span class=c1></span>    <span class=k>return</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>a</span><span class=p>.</span><span class=nf>reconcileAutoscaler</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>key</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id=412-ä¸ºäº†å…¼å®¹è€ç‰ˆæœ¬è¯»å–æ—¶-hpa-å¯¹è±¡ä¸º-v1-ç‰ˆæœ¬è¯»å–ååœ¨ä»£ç é‡Œä¼šå…ˆç»Ÿä¸€è½¬æ¢ä¸º-v2-ç‰ˆæœ¬ä»è€Œä¹‹åçš„é€»è¾‘ç»Ÿä¸€>4.1.2. ä¸ºäº†å…¼å®¹è€ç‰ˆæœ¬ï¼Œè¯»å–æ—¶ hpa å¯¹è±¡ä¸º v1 ç‰ˆæœ¬ï¼Œè¯»å–ååœ¨ä»£ç é‡Œä¼šå…ˆç»Ÿä¸€è½¬æ¢ä¸º v2 ç‰ˆæœ¬,ä»è€Œä¹‹åçš„é€»è¾‘ç»Ÿä¸€</h4>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=p>(</span><span class=nx>a</span> <span class=o>*</span><span class=nx>HorizontalController</span><span class=p>)</span> <span class=nf>reconcileAutoscaler</span><span class=p>(</span><span class=nx>hpav1Shared</span> <span class=o>*</span><span class=nx>autoscalingv1</span><span class=p>.</span><span class=nx>HorizontalPodAutoscaler</span><span class=p>,</span> <span class=nx>key</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
    <span class=c1>// make a copy so that we never mutate the shared informer cache (conversion can mutate the object)
</span><span class=c1></span>    <span class=nx>hpav1</span> <span class=o>:=</span> <span class=nx>hpav1Shared</span><span class=p>.</span><span class=nf>DeepCopy</span><span class=p>()</span>
    <span class=c1>// then, convert to autoscaling/v2, which makes our lives easier when calculating metrics
</span><span class=c1></span>    <span class=nx>hpaRaw</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>unsafeConvertToVersionVia</span><span class=p>(</span><span class=nx>hpav1</span><span class=p>,</span> <span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>SchemeGroupVersion</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>a</span><span class=p>.</span><span class=nx>eventRecorder</span><span class=p>.</span><span class=nf>Event</span><span class=p>(</span><span class=nx>hpav1</span><span class=p>,</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>EventTypeWarning</span><span class=p>,</span> <span class=s>&#34;FailedConvertHPA&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
        <span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to convert the given HPA to %s: %v&#34;</span><span class=p>,</span> <span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>SchemeGroupVersion</span><span class=p>.</span><span class=nf>String</span><span class=p>(),</span> <span class=nx>err</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=nx>hpa</span> <span class=o>:=</span> <span class=nx>hpaRaw</span><span class=p>.(</span><span class=o>*</span><span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>HorizontalPodAutoscaler</span><span class=p>)</span>
    <span class=o>...</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id=413-æ ¹æ®-hpaspecscaletargetref-ä¿¡æ¯è¯»åˆ°éœ€è¦ä¼¸ç¼©çš„èµ„æº>4.1.3. æ ¹æ® <code>hpa.Spec.ScaleTargetRef</code> ä¿¡æ¯è¯»åˆ°éœ€è¦ä¼¸ç¼©çš„èµ„æº</h4>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=p>(</span><span class=nx>a</span> <span class=o>*</span><span class=nx>HorizontalController</span><span class=p>)</span> <span class=nf>reconcileAutoscaler</span><span class=p>(</span><span class=nx>hpav1Shared</span> <span class=o>*</span><span class=nx>autoscalingv1</span><span class=p>.</span><span class=nx>HorizontalPodAutoscaler</span><span class=p>,</span> <span class=nx>key</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
    <span class=o>...</span>
    <span class=c1>// çœç•¥éƒ¨åˆ†ä»£ç 
</span><span class=c1></span>    <span class=nx>hpa</span> <span class=o>:=</span> <span class=nx>hpaRaw</span><span class=p>.(</span><span class=o>*</span><span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>HorizontalPodAutoscaler</span><span class=p>)</span>

    <span class=nx>reference</span> <span class=o>:=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%s/%s/%s&#34;</span><span class=p>,</span> <span class=nx>hpa</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>ScaleTargetRef</span><span class=p>.</span><span class=nx>Kind</span><span class=p>,</span> <span class=nx>hpa</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span> <span class=nx>hpa</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>ScaleTargetRef</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>

    <span class=c1>// è§£æèµ„æº api version
</span><span class=c1></span>    <span class=nx>targetGV</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>schema</span><span class=p>.</span><span class=nf>ParseGroupVersion</span><span class=p>(</span><span class=nx>hpa</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>ScaleTargetRef</span><span class=p>.</span><span class=nx>APIVersion</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>a</span><span class=p>.</span><span class=nx>eventRecorder</span><span class=p>.</span><span class=nf>Event</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>EventTypeWarning</span><span class=p>,</span> <span class=s>&#34;FailedGetScale&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
        <span class=nf>setCondition</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>AbleToScale</span><span class=p>,</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>ConditionFalse</span><span class=p>,</span> <span class=s>&#34;FailedGetScale&#34;</span><span class=p>,</span> <span class=s>&#34;the HPA controller was unable to get the target&#39;s current scale: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
        <span class=nx>a</span><span class=p>.</span><span class=nf>updateStatusIfNeeded</span><span class=p>(</span><span class=nx>hpaStatusOriginal</span><span class=p>,</span> <span class=nx>hpa</span><span class=p>)</span>
        <span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;invalid API version in scale target reference: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=c1>// èµ„æºç±»å‹
</span><span class=c1></span>    <span class=nx>targetGK</span> <span class=o>:=</span> <span class=nx>schema</span><span class=p>.</span><span class=nx>GroupKind</span><span class=p>{</span>
        <span class=nx>Group</span><span class=p>:</span> <span class=nx>targetGV</span><span class=p>.</span><span class=nx>Group</span><span class=p>,</span>
        <span class=nx>Kind</span><span class=p>:</span>  <span class=nx>hpa</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>ScaleTargetRef</span><span class=p>.</span><span class=nx>Kind</span><span class=p>,</span>
    <span class=p>}</span>

    <span class=c1>// æŸ¥è¯¢èµ„æºå¯¹è±¡
</span><span class=c1></span>    <span class=nx>mappings</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>a</span><span class=p>.</span><span class=nx>mapper</span><span class=p>.</span><span class=nf>RESTMappings</span><span class=p>(</span><span class=nx>targetGK</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>a</span><span class=p>.</span><span class=nx>eventRecorder</span><span class=p>.</span><span class=nf>Event</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>EventTypeWarning</span><span class=p>,</span> <span class=s>&#34;FailedGetScale&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
        <span class=nf>setCondition</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>AbleToScale</span><span class=p>,</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>ConditionFalse</span><span class=p>,</span> <span class=s>&#34;FailedGetScale&#34;</span><span class=p>,</span> <span class=s>&#34;the HPA controller was unable to get the target&#39;s current scale: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
        <span class=nx>a</span><span class=p>.</span><span class=nf>updateStatusIfNeeded</span><span class=p>(</span><span class=nx>hpaStatusOriginal</span><span class=p>,</span> <span class=nx>hpa</span><span class=p>)</span>
        <span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;unable to determine resource for scale target reference: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=c1>// æ ¹æ® ns èµ„æºç±»å‹ èµ„æºç‰ˆæœ¬å’Œèµ„æºåç§° ç¡®å®šæœ€ç»ˆå”¯ä¸€çš„æ“ä½œçš„å¯¹è±¡ scale
</span><span class=c1></span>    <span class=c1>// scale æ˜¯ä¸€ä¸ªæŠ½è±¡çš„æ¦‚å¿µï¼Œè¡¨ç¤ºå¯ä¼¸ç¼©çš„èµ„æº(Deployment, replicaSet StatefulSet ç­‰ç­‰)
</span><span class=c1></span>    <span class=nx>scale</span><span class=p>,</span> <span class=nx>targetGR</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>a</span><span class=p>.</span><span class=nf>scaleForResourceMappings</span><span class=p>(</span><span class=nx>hpa</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span> <span class=nx>hpa</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>ScaleTargetRef</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>mappings</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>a</span><span class=p>.</span><span class=nx>eventRecorder</span><span class=p>.</span><span class=nf>Event</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>EventTypeWarning</span><span class=p>,</span> <span class=s>&#34;FailedGetScale&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
        <span class=nf>setCondition</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>AbleToScale</span><span class=p>,</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>ConditionFalse</span><span class=p>,</span> <span class=s>&#34;FailedGetScale&#34;</span><span class=p>,</span> <span class=s>&#34;the HPA controller was unable to get the target&#39;s current scale: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
        <span class=nx>a</span><span class=p>.</span><span class=nf>updateStatusIfNeeded</span><span class=p>(</span><span class=nx>hpaStatusOriginal</span><span class=p>,</span> <span class=nx>hpa</span><span class=p>)</span>
        <span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to query scale subresource for %s: %v&#34;</span><span class=p>,</span> <span class=nx>reference</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=c1>//  è®°å½•ä¿¡æ¯
</span><span class=c1></span>    <span class=nf>setCondition</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>AbleToScale</span><span class=p>,</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>ConditionTrue</span><span class=p>,</span> <span class=s>&#34;SucceededGetScale&#34;</span><span class=p>,</span> <span class=s>&#34;the HPA controller was able to get the target&#39;s current scale&#34;</span><span class=p>)</span>
    <span class=c1>// è·å–å½“å‰å‰¯æœ¬æ•°
</span><span class=c1></span>    <span class=nx>currentReplicas</span> <span class=o>:=</span> <span class=nx>scale</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Replicas</span>
    <span class=nx>a</span><span class=p>.</span><span class=nf>recordInitialRecommendation</span><span class=p>(</span><span class=nx>currentReplicas</span><span class=p>,</span> <span class=nx>key</span><span class=p>)</span>
    <span class=c1>// çœç•¥éƒ¨åˆ†ä»£ç 
</span><span class=c1></span>    <span class=o>...</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id=414-ç¡®å®šå½“å‰å‰¯æœ¬æ•°æœ€å¤§æœ€å°å¯ä¼¸ç¼©çš„å‰¯æœ¬æ•°>4.1.4. ç¡®å®šå½“å‰å‰¯æœ¬æ•°ï¼Œæœ€å¤§æœ€å°å¯ä¼¸ç¼©çš„å‰¯æœ¬æ•°</h4>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go>
<span class=kd>func</span> <span class=p>(</span><span class=nx>a</span> <span class=o>*</span><span class=nx>HorizontalController</span><span class=p>)</span> <span class=nf>reconcileAutoscaler</span><span class=p>(</span><span class=nx>hpav1Shared</span> <span class=o>*</span><span class=nx>autoscalingv1</span><span class=p>.</span><span class=nx>HorizontalPodAutoscaler</span><span class=p>,</span> <span class=nx>key</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
    <span class=o>...</span>
    <span class=c1>// çœç•¥éƒ¨åˆ†ä»£ç 
</span><span class=c1></span>    <span class=nx>currentReplicas</span> <span class=o>:=</span> <span class=nx>scale</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Replicas</span>

    <span class=kd>var</span> <span class=p>(</span>
        <span class=nx>metricStatuses</span>        <span class=p>[]</span><span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>MetricStatus</span>
        <span class=nx>metricDesiredReplicas</span> <span class=kt>int32</span>
        <span class=nx>metricName</span>            <span class=kt>string</span>
    <span class=p>)</span>

    <span class=nx>desiredReplicas</span> <span class=o>:=</span> <span class=nb>int32</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
    <span class=nx>rescaleReason</span> <span class=o>:=</span> <span class=s>&#34;&#34;</span>

    <span class=kd>var</span> <span class=nx>minReplicas</span> <span class=kt>int32</span>

    <span class=k>if</span> <span class=nx>hpa</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>MinReplicas</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>minReplicas</span> <span class=p>=</span> <span class=o>*</span><span class=nx>hpa</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>MinReplicas</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=c1>// Default value
</span><span class=c1></span>        <span class=nx>minReplicas</span> <span class=p>=</span> <span class=mi>1</span>
    <span class=p>}</span>

    <span class=nx>rescale</span> <span class=o>:=</span> <span class=kc>true</span>

    <span class=c1>// å¦‚æœå½“å‰å‰¯æœ¬æ•°ä¸º 0 ä½†æ˜¯ hpa å®šä¹‰çš„æœ€å° replicas ä¸ç­‰0 æ—¶ï¼Œè¢«è®¤è¯†æ˜¯å…³é—­å¼¹æ€§ä¼¸ç¼©çš„èƒ½åŠ›ï¼Œä¸ä¼šè¿›è¡Œä¼¸ç¼©æ“ä½œ
</span><span class=c1></span>    <span class=k>if</span> <span class=nx>scale</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Replicas</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nx>minReplicas</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
        <span class=c1>// Autoscaling is disabled for this resource
</span><span class=c1></span>        <span class=nx>desiredReplicas</span> <span class=p>=</span> <span class=mi>0</span>
        <span class=nx>rescale</span> <span class=p>=</span> <span class=kc>false</span>
        <span class=nf>setCondition</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>ScalingActive</span><span class=p>,</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>ConditionFalse</span><span class=p>,</span> <span class=s>&#34;ScalingDisabled&#34;</span><span class=p>,</span> <span class=s>&#34;scaling is disabled since the replica count of the target is zero&#34;</span><span class=p>)</span>
    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>currentReplicas</span> <span class=p>&gt;</span> <span class=nx>hpa</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>MaxReplicas</span> <span class=p>{</span>
        <span class=c1>// å¦‚æœå½“å‰å‰¯æœ¬æ•°è¶…è¿‡é¢„è®¾æœ€å¤§æ•°ï¼Œç›®æ ‡å‰¯æœ¬æ•°è®¾å®šä¸ºé¢„è®¾æœ€å¤§å€¼ï¼Œä¸ä¼šå»è¿›è¡Œè®¡ç®—æ“ä½œ
</span><span class=c1></span>        <span class=nx>rescaleReason</span> <span class=p>=</span> <span class=s>&#34;Current number of replicas above Spec.MaxReplicas&#34;</span>
        <span class=nx>desiredReplicas</span> <span class=p>=</span> <span class=nx>hpa</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>MaxReplicas</span>
    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>currentReplicas</span> <span class=p>&lt;</span> <span class=nx>minReplicas</span> <span class=p>{</span>
        <span class=c1>// å¦‚æœå½“å‰å‰¯æœ¬æ•°è¶…ä½äºé¢„è®¾æœ€å°å€¼ï¼Œç›®æ ‡å‰¯æœ¬æ•°è®¾å®šä¸ºé¢„è®¾æœ€å°å€¼ï¼Œä¸ä¼šå»è¿›è¡Œè®¡ç®—æ“ä½œ
</span><span class=c1></span>        <span class=nx>rescaleReason</span> <span class=p>=</span> <span class=s>&#34;Current number of replicas below Spec.MinReplicas&#34;</span>
        <span class=nx>desiredReplicas</span> <span class=p>=</span> <span class=nx>minReplicas</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=c1>// éœ€è¦é€šè¿‡è®¡ç®—è·å¾—ç›®æ ‡å‰¯æœ¬æ•°
</span><span class=c1></span>        <span class=o>...</span>
    <span class=p>}</span>
    <span class=o>...</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id=415-è®¡ç®—å¹¶å¤„ç†å‰¯æœ¬æ•°>4.1.5. è®¡ç®—å¹¶å¤„ç†å‰¯æœ¬æ•°</h4>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=o>...</span>
<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=kd>var</span> <span class=nx>metricTimestamp</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span>
    <span class=c1>// è·å– metric æ•°æ®å¹¶æ ¹æ® metrics è®¡ç®—ç›®æ ‡å‰¯æœ¬æ•°
</span><span class=c1></span>    <span class=nx>metricDesiredReplicas</span><span class=p>,</span> <span class=nx>metricName</span><span class=p>,</span> <span class=nx>metricStatuses</span><span class=p>,</span> <span class=nx>metricTimestamp</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>a</span><span class=p>.</span><span class=nf>computeReplicasForMetrics</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>scale</span><span class=p>,</span> <span class=nx>hpa</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Metrics</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>a</span><span class=p>.</span><span class=nf>setCurrentReplicasInStatus</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>currentReplicas</span><span class=p>)</span>
        <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>a</span><span class=p>.</span><span class=nf>updateStatusIfNeeded</span><span class=p>(</span><span class=nx>hpaStatusOriginal</span><span class=p>,</span> <span class=nx>hpa</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
            <span class=nx>utilruntime</span><span class=p>.</span><span class=nf>HandleError</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
        <span class=p>}</span>
        <span class=nx>a</span><span class=p>.</span><span class=nx>eventRecorder</span><span class=p>.</span><span class=nf>Event</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>EventTypeWarning</span><span class=p>,</span> <span class=s>&#34;FailedComputeMetricsReplicas&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
        <span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to compute desired number of replicas based on listed metrics for %s: %v&#34;</span><span class=p>,</span> <span class=nx>reference</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>4</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;proposing %v desired replicas (based on %s from %s) for %s&#34;</span><span class=p>,</span> <span class=nx>metricDesiredReplicas</span><span class=p>,</span> <span class=nx>metricName</span><span class=p>,</span> <span class=nx>metricTimestamp</span><span class=p>,</span> <span class=nx>reference</span><span class=p>)</span>

    <span class=nx>rescaleMetric</span> <span class=o>:=</span> <span class=s>&#34;&#34;</span>
    <span class=c1>// æ­¤æ—¶ desiredReplicas == 0 
</span><span class=c1></span>    <span class=c1>// å¦‚æœè®¡ç®—å‡ºç»“æœå¤§äº 0ï¼Œåˆ™èµ‹å€¼ç»™ desiredReplicas
</span><span class=c1></span>    <span class=k>if</span> <span class=nx>metricDesiredReplicas</span> <span class=p>&gt;</span> <span class=nx>desiredReplicas</span> <span class=p>{</span>
        <span class=nx>desiredReplicas</span> <span class=p>=</span> <span class=nx>metricDesiredReplicas</span>
        <span class=nx>rescaleMetric</span> <span class=p>=</span> <span class=nx>metricName</span>
    <span class=p>}</span>
    <span class=c1>// å‡†å¤‡ rescaleReason ç”¨äºè®°å½•åˆ° hpa çš„ Conditions å­—æ®µï¼Œå¯ä»¥æŸ¥çœ‹
</span><span class=c1></span>    <span class=k>if</span> <span class=nx>desiredReplicas</span> <span class=p>&gt;</span> <span class=nx>currentReplicas</span> <span class=p>{</span>
        <span class=nx>rescaleReason</span> <span class=p>=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%s above target&#34;</span><span class=p>,</span> <span class=nx>rescaleMetric</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=nx>desiredReplicas</span> <span class=p>&lt;</span> <span class=nx>currentReplicas</span> <span class=p>{</span>
        <span class=nx>rescaleReason</span> <span class=p>=</span> <span class=s>&#34;All metrics below target&#34;</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=nx>hpa</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Behavior</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=c1>// é»˜è®¤è§„åˆ™é™åˆ¶ä¸€æ¬¡ä¼¸ç¼©çš„æ•°é‡ å•æ¬¡ä¼¸ç¼©æ¯”ä¾‹ä¸ä¼šè¶…è¿‡ Max(currentReplicas * 2, 4)
</span><span class=c1></span>        <span class=nx>desiredReplicas</span> <span class=p>=</span> <span class=nx>a</span><span class=p>.</span><span class=nf>normalizeDesiredReplicas</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>currentReplicas</span><span class=p>,</span> <span class=nx>desiredReplicas</span><span class=p>,</span> <span class=nx>minReplicas</span><span class=p>)</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=c1>// å¦‚æœ hpa.Spec.Behavior != nil åˆ™å¤„ç†æ˜¯å¦éœ€è¦é…ç½®çš„è§„åˆ™
</span><span class=c1></span>        <span class=c1>// å¦‚æœé…ç½®è§„åˆ™ä¸ºç¦ç”¨(å¯ä»¥å•ç‹¬ç¦ç”¨ scale up æˆ– scale down)ï¼Œåˆ™è¿”å› currentReplicas
</span><span class=c1></span>        <span class=c1>// å¦‚æœé…åˆäº† hpa.Spec.Behavior.Policies, åˆ™æŒ‰ç­–ç•¥è¿›è¡Œä¼¸ç¼©(å¯ä»¥é…ç½®ä¸€æ¬¡ä¼¸ç¼©çš„ pod æ•°é‡æˆ–è€…ç™¾åˆ†æ¯”ï¼Œä»è€Œå¯ä»¥ç¡®ä¿ä¼¸ç¼©è·¨åº¦ä¸ä¼šä¸€æ¬¡æ€§å¾ˆå¤§)
</span><span class=c1></span>        <span class=nx>desiredReplicas</span> <span class=p>=</span> <span class=nx>a</span><span class=p>.</span><span class=nf>normalizeDesiredReplicasWithBehaviors</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>currentReplicas</span><span class=p>,</span> <span class=nx>desiredReplicas</span><span class=p>,</span> <span class=nx>minReplicas</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=c1>// åˆ¤æ–­æ˜¯å¦éœ€è¦ä¼¸ç¼©ï¼Œæœ€ç»ˆè®¡ç®—ç»“æœå¯èƒ½ä¼šå½“å‰å‰¯æœ¬æ•°ä¸€è‡´
</span><span class=c1></span>    <span class=nx>rescale</span> <span class=p>=</span> <span class=nx>desiredReplicas</span> <span class=o>!=</span> <span class=nx>currentReplicas</span>
<span class=p>}</span>
<span class=o>...</span>
</code></pre></td></tr></table>
</div>
</div><h4 id=416-è°ƒæ•´å‰¯æœ¬æ•°>4.1.6. è°ƒæ•´å‰¯æœ¬æ•°</h4>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=p>(</span><span class=nx>a</span> <span class=o>*</span><span class=nx>HorizontalController</span><span class=p>)</span> <span class=nf>reconcileAutoscaler</span><span class=p>(</span><span class=nx>hpav1Shared</span> <span class=o>*</span><span class=nx>autoscalingv1</span><span class=p>.</span><span class=nx>HorizontalPodAutoscaler</span><span class=p>,</span> <span class=nx>key</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
    <span class=o>...</span>

    <span class=c1>// éœ€è¦ä¼¸ç¼©
</span><span class=c1></span>    <span class=k>if</span> <span class=nx>rescale</span> <span class=p>{</span>
        <span class=nx>scale</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Replicas</span> <span class=p>=</span> <span class=nx>desiredReplicas</span>
        <span class=c1>// æ›´æ–° scale å¯¹è±¡ï¼Œæœ€ç»ˆä¼¸ç¼©æ“ä½œä¼šç”± scale å¯¹åº”çš„ controller å»å®Œæˆ
</span><span class=c1></span>        <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>a</span><span class=p>.</span><span class=nx>scaleNamespacer</span><span class=p>.</span><span class=nf>Scales</span><span class=p>(</span><span class=nx>hpa</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>).</span><span class=nf>Update</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>TODO</span><span class=p>(),</span> <span class=nx>targetGR</span><span class=p>,</span> <span class=nx>scale</span><span class=p>,</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>UpdateOptions</span><span class=p>{})</span>
        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
            <span class=c1>// è®°å½•æ—¥å¿—å’Œ event
</span><span class=c1></span>            <span class=nx>a</span><span class=p>.</span><span class=nx>eventRecorder</span><span class=p>.</span><span class=nf>Eventf</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>EventTypeWarning</span><span class=p>,</span> <span class=s>&#34;FailedRescale&#34;</span><span class=p>,</span> <span class=s>&#34;New size: %d; reason: %s; error: %v&#34;</span><span class=p>,</span> <span class=nx>desiredReplicas</span><span class=p>,</span> <span class=nx>rescaleReason</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
            <span class=nf>setCondition</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>AbleToScale</span><span class=p>,</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>ConditionFalse</span><span class=p>,</span> <span class=s>&#34;FailedUpdateScale&#34;</span><span class=p>,</span> <span class=s>&#34;the HPA controller was unable to update the target scale: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
            <span class=nx>a</span><span class=p>.</span><span class=nf>setCurrentReplicasInStatus</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>currentReplicas</span><span class=p>)</span>
            <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>a</span><span class=p>.</span><span class=nf>updateStatusIfNeeded</span><span class=p>(</span><span class=nx>hpaStatusOriginal</span><span class=p>,</span> <span class=nx>hpa</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
                <span class=nx>utilruntime</span><span class=p>.</span><span class=nf>HandleError</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
            <span class=p>}</span>
            <span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to rescale %s: %v&#34;</span><span class=p>,</span> <span class=nx>reference</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
        <span class=p>}</span>
        <span class=nf>setCondition</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>AbleToScale</span><span class=p>,</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>ConditionTrue</span><span class=p>,</span> <span class=s>&#34;SucceededRescale&#34;</span><span class=p>,</span> <span class=s>&#34;the HPA controller was able to update the target scale to %d&#34;</span><span class=p>,</span> <span class=nx>desiredReplicas</span><span class=p>)</span>
        <span class=nx>a</span><span class=p>.</span><span class=nx>eventRecorder</span><span class=p>.</span><span class=nf>Eventf</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>EventTypeNormal</span><span class=p>,</span> <span class=s>&#34;SuccessfulRescale&#34;</span><span class=p>,</span> <span class=s>&#34;New size: %d; reason: %s&#34;</span><span class=p>,</span> <span class=nx>desiredReplicas</span><span class=p>,</span> <span class=nx>rescaleReason</span><span class=p>)</span>
        <span class=nx>a</span><span class=p>.</span><span class=nf>storeScaleEvent</span><span class=p>(</span><span class=nx>hpa</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Behavior</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>currentReplicas</span><span class=p>,</span> <span class=nx>desiredReplicas</span><span class=p>)</span>
        <span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Successful rescale of %s, old size: %d, new size: %d, reason: %s&#34;</span><span class=p>,</span>
            <span class=nx>hpa</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>currentReplicas</span><span class=p>,</span> <span class=nx>desiredReplicas</span><span class=p>,</span> <span class=nx>rescaleReason</span><span class=p>)</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>4</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;decided not to scale %s to %v (last scale time was %s)&#34;</span><span class=p>,</span> <span class=nx>reference</span><span class=p>,</span> <span class=nx>desiredReplicas</span><span class=p>,</span> <span class=nx>hpa</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>LastScaleTime</span><span class=p>)</span>
        <span class=nx>desiredReplicas</span> <span class=p>=</span> <span class=nx>currentReplicas</span>
    <span class=p>}</span>

    <span class=c1>// æ›´æ–°çŠ¶æ€
</span><span class=c1></span>    <span class=nx>a</span><span class=p>.</span><span class=nf>setStatus</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>currentReplicas</span><span class=p>,</span> <span class=nx>desiredReplicas</span><span class=p>,</span> <span class=nx>metricStatuses</span><span class=p>,</span> <span class=nx>rescale</span><span class=p>)</span>
    <span class=k>return</span> <span class=nx>a</span><span class=p>.</span><span class=nf>updateStatusIfNeeded</span><span class=p>(</span><span class=nx>hpaStatusOriginal</span><span class=p>,</span> <span class=nx>hpa</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>è‡³æ­¤ï¼Œä¼¸ç¼©çš„å¤§æµç¨‹æ˜¯å®Œæˆäº†ï¼Œå‰©ä¸‹çš„å°±æ˜¯å¯¹ç»†èŠ‚çš„äº†è§£äº†ã€‚æ¯”å¦‚å¦‚ä½•è®¡ç®—ç›®æ ‡å‰¯æœ¬æ•°çš„ï¼Œå¦‚ä½•å¤„ç†ä¼¸ç¼©çš„ç­–ç•¥ç­‰ç­‰ã€‚</p>
<figure><a class=lightgallery href=/posts/hpa-controller/hpa_controller.png title=/posts/hpa-controller/hpa_controller.png data-thumbnail=/posts/hpa-controller/hpa_controller.png data-sub-html="<h2>ä¼¸ç¼©æµç¨‹</h2>">
<img class=lazyload src=/svg/loading.min.svg data-src=hpa_controller.png data-srcset="/posts/hpa-controller/hpa_controller.png, hpa_controller.png 1.5x, /posts/hpa-controller/hpa_controller.png 2x" data-sizes=auto alt=/posts/hpa-controller/hpa_controller.png width=800>
</a><figcaption class=image-caption>ä¼¸ç¼©æµç¨‹</figcaption>
</figure>
<h3 id=42-è®¡ç®—å‰¯æœ¬æ•°è¿‡ç¨‹>4.2. è®¡ç®—å‰¯æœ¬æ•°è¿‡ç¨‹</h3>
<p>å¯é€šè¿‡ä¸Šé¢æµç¨‹çœ‹åˆ°ä¼šæœ‰ä¸€ä¸ªè®¡ç®—ç›®æ ‡å‰¯æœ¬æ•°çš„è¿‡ç¨‹ <code>a.computeReplicasForMetrics</code>ï¼Œçœ‹ä¼¼ç®€å•å…¶å®å†…éƒ¨ç›¸å½“ä¸°å¯Œçš„ä¸€ä¸ªè¿‡ç¨‹ï¼Œä¸‹é¢ä¸€èµ·çœ‹ä¸€ä¸‹å¦‚ä½•å»è®¡ç®—çš„ã€‚</p>
<h4 id=421-éå†-specmetrics-è®¡ç®—å¾—å‡ºæœ€å¤§å€¼>4.2.1. éå† <code>spec.Metrics</code> è®¡ç®—å¾—å‡ºæœ€å¤§å€¼</h4>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// computeReplicasForMetrics computes the desired number of replicas for the metric specifications listed in the HPA,
</span><span class=c1>// returning the maximum  of the computed replica counts, a description of the associated metric, and the statuses of
</span><span class=c1>// all metrics computed.
</span><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>a</span> <span class=o>*</span><span class=nx>HorizontalController</span><span class=p>)</span> <span class=nf>computeReplicasForMetrics</span><span class=p>(</span><span class=nx>hpa</span> <span class=o>*</span><span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>HorizontalPodAutoscaler</span><span class=p>,</span> <span class=nx>scale</span> <span class=o>*</span><span class=nx>autoscalingv1</span><span class=p>.</span><span class=nx>Scale</span><span class=p>,</span>
    <span class=nx>metricSpecs</span> <span class=p>[]</span><span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>MetricSpec</span><span class=p>)</span> <span class=p>(</span><span class=nx>replicas</span> <span class=kt>int32</span><span class=p>,</span> <span class=nx>metric</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>statuses</span> <span class=p>[]</span><span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>MetricStatus</span><span class=p>,</span> <span class=nx>timestamp</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>

    <span class=cm>/*
</span><span class=cm>    * çœç•¥äº†éƒ¨åˆ†æ— å…³ä»£ç 
</span><span class=cm>    */</span>
    <span class=k>if</span> <span class=nx>scale</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>Selector</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
        <span class=nx>errMsg</span> <span class=o>:=</span> <span class=s>&#34;selector is required&#34;</span>
        <span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>{},</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=nx>errMsg</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=nx>selector</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>labels</span><span class=p>.</span><span class=nf>Parse</span><span class=p>(</span><span class=nx>scale</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>Selector</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>{},</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=nx>errMsg</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=nx>specReplicas</span> <span class=o>:=</span> <span class=nx>scale</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Replicas</span>
    <span class=nx>statusReplicas</span> <span class=o>:=</span> <span class=nx>scale</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>Replicas</span>
    <span class=c1>// è®°å½•æ¯ä¸ª metric çš„ç»“æœ
</span><span class=c1></span>    <span class=nx>statuses</span> <span class=p>=</span> <span class=nb>make</span><span class=p>([]</span><span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>MetricStatus</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>metricSpecs</span><span class=p>))</span>

    <span class=nx>invalidMetricsCount</span> <span class=o>:=</span> <span class=mi>0</span>
    <span class=kd>var</span> <span class=nx>invalidMetricError</span> <span class=kt>error</span>
    <span class=kd>var</span> <span class=nx>invalidMetricCondition</span> <span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>HorizontalPodAutoscalerCondition</span>

    <span class=c1>// éå†è®¡ç®—
</span><span class=c1></span>    <span class=k>for</span> <span class=nx>i</span><span class=p>,</span> <span class=nx>metricSpec</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>metricSpecs</span> <span class=p>{</span>
        <span class=c1>// è®¡ç®—å•ä¸ª metric çš„æ–¹æ³•
</span><span class=c1></span>        <span class=nx>replicaCountProposal</span><span class=p>,</span> <span class=nx>metricNameProposal</span><span class=p>,</span> <span class=nx>timestampProposal</span><span class=p>,</span> <span class=nx>condition</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>a</span><span class=p>.</span><span class=nf>computeReplicasForMetric</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=nx>metricSpec</span><span class=p>,</span> <span class=nx>specReplicas</span><span class=p>,</span> <span class=nx>statusReplicas</span><span class=p>,</span> <span class=nx>selector</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>statuses</span><span class=p>[</span><span class=nx>i</span><span class=p>])</span>

        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
            <span class=k>if</span> <span class=nx>invalidMetricsCount</span> <span class=o>&lt;=</span> <span class=mi>0</span> <span class=p>{</span>
                <span class=nx>invalidMetricCondition</span> <span class=p>=</span> <span class=nx>condition</span>
                <span class=nx>invalidMetricError</span> <span class=p>=</span> <span class=nx>err</span>
            <span class=p>}</span>
            <span class=nx>invalidMetricsCount</span><span class=o>++</span>
        <span class=p>}</span>
        <span class=c1>// å–æœ€å¤§
</span><span class=c1></span>        <span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=nx>replicas</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>||</span> <span class=nx>replicaCountProposal</span> <span class=p>&gt;</span> <span class=nx>replicas</span><span class=p>)</span> <span class=p>{</span>
            <span class=nx>timestamp</span> <span class=p>=</span> <span class=nx>timestampProposal</span>
            <span class=nx>replicas</span> <span class=p>=</span> <span class=nx>replicaCountProposal</span>
            <span class=nx>metric</span> <span class=p>=</span> <span class=nx>metricNameProposal</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=c1>// If all metrics are invalid or some are invalid and we would scale down,
</span><span class=c1></span>    <span class=c1>// return an error and set the condition of the hpa based on the first invalid metric.
</span><span class=c1></span>    <span class=c1>// Otherwise set the condition as scaling active as we&#39;re going to scale
</span><span class=c1></span>    <span class=k>if</span> <span class=nx>invalidMetricsCount</span> <span class=o>&gt;=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>metricSpecs</span><span class=p>)</span> <span class=o>||</span> <span class=p>(</span><span class=nx>invalidMetricsCount</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nx>replicas</span> <span class=p>&lt;</span> <span class=nx>specReplicas</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>statuses</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>{},</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;invalid metrics (%v invalid out of %v), first error is: %v&#34;</span><span class=p>,</span> <span class=nx>invalidMetricsCount</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>metricSpecs</span><span class=p>),</span> <span class=nx>invalidMetricError</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=k>return</span> <span class=nx>replicas</span><span class=p>,</span> <span class=nx>metric</span><span class=p>,</span> <span class=nx>statuses</span><span class=p>,</span> <span class=nx>timestamp</span><span class=p>,</span> <span class=kc>nil</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id=422-è®¡ç®—å•ä¸ª-metricæ ¹æ®ç±»å‹è®¡ç®—-metric>4.2.2. è®¡ç®—å•ä¸ª metricï¼šæ ¹æ®ç±»å‹è®¡ç®— metric</h4>
<div class="details admonition inf open">
<div class="details-summary admonition-title">
<i class="icon fas fa-pencil-alt fa-fw"></i>åè¯è§£æ<i class="details-icon fas fa-angle-right fa-fw"></i>
</div>
<div class=details-content>
<div class=admonition-content><p>hpa å¯¹è±¡çš„ <code>spac.metrics</code> ä¸­çš„å…ƒç´ æœ‰ä¸ª <code>Type</code> å­—æ®µ,è®°å½• metric æ•°æ®æºçš„ç±»å‹ï¼Œç›®å‰æ”¯æŒçš„ä»¥ä¸‹å‡ ç§ï¼š</p>
<table>
<thead>
<tr>
<th style=text-align:center>ç±»å‹</th>
<th style=text-align:left>è¯´æ˜</th>
<th style=text-align:left>æ”¯æŒçš„è®¡ç®—ç±»å‹</th>
<th style=text-align:left>ä¸æ”¯æŒçš„è®¡ç®—ç±»å‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:center>Object</td>
<td style=text-align:left>ç”± k8s æœ¬èº«èµ„æºæä¾›çš„æ•°æ®ï¼Œå¦‚ ingress æä¾›å‘½ä¸­è§„åˆ™æ•°é‡</td>
<td style=text-align:left>AverageValue <br> Value</td>
<td style=text-align:left>AverageUtilization</td>
</tr>
<tr>
<td style=text-align:center>Pods</td>
<td style=text-align:left>ç”± pod æä¾›çš„é™¤ CPU å†…å­˜ä¹‹å¤–çš„æ•°æ®</td>
<td style=text-align:left>AverageValue</td>
<td style=text-align:left>AverageUtilization <br> Value</td>
</tr>
<tr>
<td style=text-align:center>Resource</td>
<td style=text-align:left>pod æä¾›çš„ç³»ç»Ÿèµ„æºï¼ˆCPU å†…å­˜ï¼‰</td>
<td style=text-align:left>AverageUtilization <br> AverageValue</td>
<td style=text-align:left>Value</td>
</tr>
<tr>
<td style=text-align:center>External</td>
<td style=text-align:left>å¤–éƒ¨æä¾›çš„ç›‘æ§æŒ‡æ ‡</td>
<td style=text-align:left>AverageValue <br> Value</td>
<td style=text-align:left>AverageUtilization</td>
</tr>
</tbody>
</table>
<ul>
<li>
<p>AverageValueï¼šè®¾å®šå¹³å‡å€¼ï¼Œå¦‚qpsï¼Œtpsã€‚è®¡ç®—æ—¶è¯»å– metric æ€»å’Œï¼Œä¸é¢„è®¾å¹³å‡å€¼âœ–ï¸å‰¯æœ¬æ•°è¿›è¡Œå¯¹æ¯”ï¼Œä»è€Œåˆ¤æ–­æ˜¯å¦éœ€è¦ä¼¸ç¼©ã€‚</p>
</li>
<li>
<p>Valueï¼šè®¾å®šå›ºå®šå€¼ï¼Œå¦‚é˜Ÿåˆ—ä¸­æ¶ˆæ¯æ•°é‡ï¼ŒRedis ä¸­ list é•¿åº¦ç­‰ã€‚è®¡ç®—æ—¶ç›´æ¥æ‹¿ metric å’Œé¢„è®¾å€¼è¿›è¡Œå¯¹æ¯”ã€‚</p>
</li>
<li>
<p>AverageUtilizationï¼š å¹³å‡åˆ©ç”¨ç‡ï¼Œå¦‚ CPU å’Œå†…å­˜ã€‚å…ˆè®¡ç®— podçš„åŸºæ•°çš„æ€»å’Œï¼ˆtotalMetric å’Œ totalRequestï¼‰ï¼Œæœ€ç»ˆè®¡ç®—åˆ©ç”¨ç‡ â†’ totalMetric/totalRequest</p>
</li>
</ul>
</div>
</div>
</div>
<p>æºç ï¼š</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// Computes the desired number of replicas for a specific hpa and metric specification,
</span><span class=c1>// returning the metric status and a proposed condition to be set on the HPA object.
</span><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>a</span> <span class=o>*</span><span class=nx>HorizontalController</span><span class=p>)</span> <span class=nf>computeReplicasForMetric</span><span class=p>(</span><span class=nx>hpa</span> <span class=o>*</span><span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>HorizontalPodAutoscaler</span><span class=p>,</span> <span class=nx>spec</span> <span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>MetricSpec</span><span class=p>,</span>
    <span class=nx>specReplicas</span><span class=p>,</span> <span class=nx>statusReplicas</span> <span class=kt>int32</span><span class=p>,</span> <span class=nx>selector</span> <span class=nx>labels</span><span class=p>.</span><span class=nx>Selector</span><span class=p>,</span> <span class=nx>status</span> <span class=o>*</span><span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>MetricStatus</span><span class=p>)</span> <span class=p>(</span><span class=nx>replicaCountProposal</span> <span class=kt>int32</span><span class=p>,</span> <span class=nx>metricNameProposal</span> <span class=kt>string</span><span class=p>,</span>
    <span class=nx>timestampProposal</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>,</span> <span class=nx>condition</span> <span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>HorizontalPodAutoscalerCondition</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>

    <span class=k>switch</span> <span class=nx>spec</span><span class=p>.</span><span class=nx>Type</span> <span class=p>{</span>
    <span class=k>case</span> <span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>ObjectMetricSourceType</span><span class=p>:</span>
        <span class=nx>metricSelector</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>metav1</span><span class=p>.</span><span class=nf>LabelSelectorAsSelector</span><span class=p>(</span><span class=nx>spec</span><span class=p>.</span><span class=nx>Object</span><span class=p>.</span><span class=nx>Metric</span><span class=p>.</span><span class=nx>Selector</span><span class=p>)</span>
        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
            <span class=nx>condition</span> <span class=o>:=</span> <span class=nx>a</span><span class=p>.</span><span class=nf>getUnableComputeReplicaCountCondition</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=s>&#34;FailedGetObjectMetric&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
            <span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>{},</span> <span class=nx>condition</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to get object metric value: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
        <span class=p>}</span>
        <span class=nx>replicaCountProposal</span><span class=p>,</span> <span class=nx>timestampProposal</span><span class=p>,</span> <span class=nx>metricNameProposal</span><span class=p>,</span> <span class=nx>condition</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>a</span><span class=p>.</span><span class=nf>computeStatusForObjectMetric</span><span class=p>(</span><span class=nx>specReplicas</span><span class=p>,</span> <span class=nx>statusReplicas</span><span class=p>,</span> <span class=nx>spec</span><span class=p>,</span> <span class=nx>hpa</span><span class=p>,</span> <span class=nx>selector</span><span class=p>,</span> <span class=nx>status</span><span class=p>,</span> <span class=nx>metricSelector</span><span class=p>)</span>
        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
            <span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>{},</span> <span class=nx>condition</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to get object metric value: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
        <span class=p>}</span>
    <span class=k>case</span> <span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>PodsMetricSourceType</span><span class=p>:</span>
        <span class=nx>metricSelector</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>metav1</span><span class=p>.</span><span class=nf>LabelSelectorAsSelector</span><span class=p>(</span><span class=nx>spec</span><span class=p>.</span><span class=nx>Pods</span><span class=p>.</span><span class=nx>Metric</span><span class=p>.</span><span class=nx>Selector</span><span class=p>)</span>
        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
            <span class=nx>condition</span> <span class=o>:=</span> <span class=nx>a</span><span class=p>.</span><span class=nf>getUnableComputeReplicaCountCondition</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=s>&#34;FailedGetPodsMetric&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
            <span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>{},</span> <span class=nx>condition</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to get pods metric value: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
        <span class=p>}</span>
        <span class=nx>replicaCountProposal</span><span class=p>,</span> <span class=nx>timestampProposal</span><span class=p>,</span> <span class=nx>metricNameProposal</span><span class=p>,</span> <span class=nx>condition</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>a</span><span class=p>.</span><span class=nf>computeStatusForPodsMetric</span><span class=p>(</span><span class=nx>specReplicas</span><span class=p>,</span> <span class=nx>spec</span><span class=p>,</span> <span class=nx>hpa</span><span class=p>,</span> <span class=nx>selector</span><span class=p>,</span> <span class=nx>status</span><span class=p>,</span> <span class=nx>metricSelector</span><span class=p>)</span>
        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
            <span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>{},</span> <span class=nx>condition</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to get pods metric value: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
        <span class=p>}</span>
    <span class=k>case</span> <span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>ResourceMetricSourceType</span><span class=p>:</span>
        <span class=nx>replicaCountProposal</span><span class=p>,</span> <span class=nx>timestampProposal</span><span class=p>,</span> <span class=nx>metricNameProposal</span><span class=p>,</span> <span class=nx>condition</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>a</span><span class=p>.</span><span class=nf>computeStatusForResourceMetric</span><span class=p>(</span><span class=nx>specReplicas</span><span class=p>,</span> <span class=nx>spec</span><span class=p>,</span> <span class=nx>hpa</span><span class=p>,</span> <span class=nx>selector</span><span class=p>,</span> <span class=nx>status</span><span class=p>)</span>
        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
            <span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>{},</span> <span class=nx>condition</span><span class=p>,</span> <span class=nx>err</span>
        <span class=p>}</span>
    <span class=k>case</span> <span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>ExternalMetricSourceType</span><span class=p>:</span>
        <span class=nx>replicaCountProposal</span><span class=p>,</span> <span class=nx>timestampProposal</span><span class=p>,</span> <span class=nx>metricNameProposal</span><span class=p>,</span> <span class=nx>condition</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>a</span><span class=p>.</span><span class=nf>computeStatusForExternalMetric</span><span class=p>(</span><span class=nx>specReplicas</span><span class=p>,</span> <span class=nx>statusReplicas</span><span class=p>,</span> <span class=nx>spec</span><span class=p>,</span> <span class=nx>hpa</span><span class=p>,</span> <span class=nx>selector</span><span class=p>,</span> <span class=nx>status</span><span class=p>)</span>
        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
            <span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>{},</span> <span class=nx>condition</span><span class=p>,</span> <span class=nx>err</span>
        <span class=p>}</span>
    <span class=k>default</span><span class=p>:</span>
        <span class=nx>errMsg</span> <span class=o>:=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;unknown metric source type %q&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>spec</span><span class=p>.</span><span class=nx>Type</span><span class=p>))</span>
        <span class=nx>err</span> <span class=p>=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=nx>errMsg</span><span class=p>)</span>
        <span class=nx>condition</span> <span class=o>:=</span> <span class=nx>a</span><span class=p>.</span><span class=nf>getUnableComputeReplicaCountCondition</span><span class=p>(</span><span class=nx>hpa</span><span class=p>,</span> <span class=s>&#34;InvalidMetricSourceType&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
        <span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>{},</span> <span class=nx>condition</span><span class=p>,</span> <span class=nx>err</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=nx>replicaCountProposal</span><span class=p>,</span> <span class=nx>metricNameProposal</span><span class=p>,</span> <span class=nx>timestampProposal</span><span class=p>,</span> <span class=nx>autoscalingv2</span><span class=p>.</span><span class=nx>HorizontalPodAutoscalerCondition</span><span class=p>{},</span> <span class=kc>nil</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>ä¸‹é¢ä¼šä»¥ <code>ExternalMetricSourceType</code> ä¸ºä¾‹ã€‚</p>
<h4 id=423-æ ¹æ®è®¡ç®—ç±»å‹æ‰§è¡Œå¯¹åº”çš„è®¡ç®—é€»è¾‘>4.2.3. æ ¹æ®è®¡ç®—ç±»å‹æ‰§è¡Œå¯¹åº”çš„è®¡ç®—é€»è¾‘</h4>
<blockquote>
<p>ä¸‹é¢ä»¥ External çš„ AverageValue ä¸ºä¾‹</p>
</blockquote>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// GetExternalPerPodMetricReplicas calculates the desired replica count based on a
</span><span class=c1>// target metric value per pod (as a milli-value) for the external metric in the
</span><span class=c1>// given namespace, and the current replica count.
</span><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>ReplicaCalculator</span><span class=p>)</span> <span class=nf>GetExternalPerPodMetricReplicas</span><span class=p>(</span><span class=nx>statusReplicas</span> <span class=kt>int32</span><span class=p>,</span> <span class=nx>targetUtilizationPerPod</span> <span class=kt>int64</span><span class=p>,</span> <span class=nx>metricName</span><span class=p>,</span> <span class=nx>namespace</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>metricSelector</span> <span class=o>*</span><span class=nx>metav1</span><span class=p>.</span><span class=nx>LabelSelector</span><span class=p>)</span> <span class=p>(</span><span class=nx>replicaCount</span> <span class=kt>int32</span><span class=p>,</span> <span class=nx>utilization</span> <span class=kt>int64</span><span class=p>,</span> <span class=nx>timestamp</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// æ„é€  metric æŸ¥è¯¢ label
</span><span class=c1></span>    <span class=nx>metricLabelSelector</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>metav1</span><span class=p>.</span><span class=nf>LabelSelectorAsSelector</span><span class=p>(</span><span class=nx>metricSelector</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>{},</span> <span class=nx>err</span>
    <span class=p>}</span>
    <span class=c1>// æ‹‰å– metrics
</span><span class=c1></span>    <span class=c1>// https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/#support-for-metrics-apis
</span><span class=c1></span>    <span class=nx>metrics</span><span class=p>,</span> <span class=nx>timestamp</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>metricsClient</span><span class=p>.</span><span class=nf>GetExternalMetric</span><span class=p>(</span><span class=nx>metricName</span><span class=p>,</span> <span class=nx>namespace</span><span class=p>,</span> <span class=nx>metricLabelSelector</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>{},</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;unable to get external metric %s/%s/%+v: %s&#34;</span><span class=p>,</span> <span class=nx>namespace</span><span class=p>,</span> <span class=nx>metricName</span><span class=p>,</span> <span class=nx>metricSelector</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=c1>// è®¡ç®—æ€»å’Œ
</span><span class=c1></span>    <span class=nx>utilization</span> <span class=p>=</span> <span class=mi>0</span>
    <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>val</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>metrics</span> <span class=p>{</span>
        <span class=nx>utilization</span> <span class=p>=</span> <span class=nx>utilization</span> <span class=o>+</span> <span class=nx>val</span>
    <span class=p>}</span>

    <span class=nx>replicaCount</span> <span class=p>=</span> <span class=nx>statusReplicas</span>
    <span class=c1>// è®¡ç®— ä¼¸ç¼©æ¯”ä¾‹
</span><span class=c1></span>    <span class=c1>// targetUtilizationPerPod ä¸ºé…ç½®çš„å•ä¸ª pod çš„é¢„è®¾å€¼ï¼Œæ‰€ä»¥éœ€è¦ä¹˜ä»¥å‰¯æœ¬æ•°
</span><span class=c1></span>    <span class=c1>// å¦‚æœå½“å‰ metric æŸ¥è¯¢æ•°æ®ä¸º 100ï¼Œ é¢„è®¾çš„å•ä¸ª pod çš„å€¼ä¸º 20, å½“å‰æœ‰3ä¸ªå‰¯æœ¬æ•°
</span><span class=c1></span>    <span class=c1>// æ­¤æ—¶ä¼¸ç¼©æ¯”ä¾‹ä¸º 1.6667
</span><span class=c1></span>    <span class=nx>usageRatio</span> <span class=o>:=</span> <span class=nb>float64</span><span class=p>(</span><span class=nx>utilization</span><span class=p>)</span> <span class=o>/</span> <span class=p>(</span><span class=nb>float64</span><span class=p>(</span><span class=nx>targetUtilizationPerPod</span><span class=p>)</span> <span class=o>*</span> <span class=nb>float64</span><span class=p>(</span><span class=nx>replicaCount</span><span class=p>))</span>
    <span class=c1>// c.tolerance å®¹å¿åº¦ï¼Œé»˜è®¤å€¼ä¸º 0.1
</span><span class=c1></span>    <span class=c1>// å¦‚æœ 1.0 - ä¼¸ç¼©æ¯”ä¾‹ è¶…è¿‡å®¹å¿åº¦åˆ™è®¤ä¸ºéœ€è¦ä¼¸ç¼©ã€‚è¿™é‡Œå¯ä»¥ç†è§£ä¸ºæŸ¥è¯¢åˆ°çš„ metric æ•°æ®ä¸é¢„è®¾çš„å€¼æµ®åŠ¨å°äº 10% æ—¶ ä¸éœ€è¦ä¼¸ç¼©
</span><span class=c1></span>    <span class=k>if</span> <span class=nx>math</span><span class=p>.</span><span class=nf>Abs</span><span class=p>(</span><span class=mf>1.0</span><span class=o>-</span><span class=nx>usageRatio</span><span class=p>)</span> <span class=p>&gt;</span> <span class=nx>c</span><span class=p>.</span><span class=nx>tolerance</span> <span class=p>{</span>
        <span class=c1>// update number of replicas if the change is large enough
</span><span class=c1></span>        <span class=c1>// ç»§ç»­ä¸Šé¢çš„æ•°æ®è®¡ç®— æ–°çš„ replica æ•°é‡ä¸º 100/20 -&gt; 5
</span><span class=c1></span>        <span class=nx>replicaCount</span> <span class=p>=</span> <span class=nb>int32</span><span class=p>(</span><span class=nx>math</span><span class=p>.</span><span class=nf>Ceil</span><span class=p>(</span><span class=nb>float64</span><span class=p>(</span><span class=nx>utilization</span><span class=p>)</span> <span class=o>/</span> <span class=nb>float64</span><span class=p>(</span><span class=nx>targetUtilizationPerPod</span><span class=p>)))</span>
    <span class=p>}</span>
    <span class=c1>// è®¡ç®—å½“å‰çš„å¹³å‡æ•°æ® 100/3 -&gt; 33.33 è¿™ä¸ªå€¼ä¼šåœ¨ HPA å¯¹è±¡çš„ æ—¥å¿—é‡Œæ‰“å°å‡ºæ¥å¯ä»¥çœ‹åˆ°
</span><span class=c1></span>    <span class=nx>utilization</span> <span class=p>=</span> <span class=nb>int64</span><span class=p>(</span><span class=nx>math</span><span class=p>.</span><span class=nf>Ceil</span><span class=p>(</span><span class=nb>float64</span><span class=p>(</span><span class=nx>utilization</span><span class=p>)</span> <span class=o>/</span> <span class=nb>float64</span><span class=p>(</span><span class=nx>statusReplicas</span><span class=p>)))</span>
    <span class=k>return</span> <span class=nx>replicaCount</span><span class=p>,</span> <span class=nx>utilization</span><span class=p>,</span> <span class=nx>timestamp</span><span class=p>,</span> <span class=kc>nil</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>è®¡ç®—ç»“æœä¸€è·¯è¿”å›åˆ° <code>reconcileAutoscaler</code> æ–¹æ³•è¿›è¡Œæœ€ç»ˆä¼¸ç¼©ã€‚</p>
</blockquote>
<h2 id=5-æ‰©å±•ç”¨æ³•>5. æ‰©å±•ç”¨æ³•</h2>
<p>åœ¨å®é™…å¼€å‘ç¯å¢ƒåªç”¨ <code>cpu</code>, <code>memory</code> æ¥ä½œä¸ºå¼¹æ€§ä¼¸ç¼©ä¾æ®æ˜¯è¿œè¿œä¸å¤Ÿçš„ã€‚å¤§å¤šæ•°æƒ…å†µå¯èƒ½ä¼šæ ¹æ® <code>qps</code>, <code>tps</code>, <code>å¹³å‡å»¶è¿Ÿæ—¶é—´</code>, <code>MQ ä¸­çš„æ¶ˆæ¯æ•°é‡</code>, <code>Redis ä¸­çš„æ•°æ®é‡</code> ç­‰ä¸ä¸šåŠ¡æ¯æ¯ç›¸å…³çš„æ•°æ®é‡åˆ¤æ–­ä¼¸ç¼©çš„ä¾æ®ï¼Œè¿™äº›éƒ½å±äº HPA çš„ External ç±»å‹çš„èŒƒç•´ã€‚ä½†æ˜¯ External ç±»å‹çš„æ•°æ®æºéœ€è¦å¯¹æ¥ <code>Adapter</code> çš„æ–¹å¼æ‰èƒ½ç”¨åˆ° HPA å¯¹è±¡å†…å®¹(å…·ä½“è¯·æŸ¥çœ‹: <a href=https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/#support-for-metrics-apis target=_blank rel="noopener noreffer">https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/#support-for-metrics-apis</a>) ï¼Œä¹Ÿå°±æ˜¯è¯´éœ€è¦é¢å¤–å¼€å‘é‡çš„ã€‚</p>
<p>è¿™é‡Œæˆ‘æ¨èä¸€ä¸ªçŸ¥ååº¦æ¯”è¾ƒé«˜ä¸”æ”¯æŒçš„æ•°æ®é‡æ¯”è¾ƒå¹¿æ³›çš„ Adapter çš„å®ç° &ndash; <a href=https://keda.sh/ target=_blank rel="noopener noreffer">KEDA</a>ã€‚åŸºäºäº‹ä»¶é©±åŠ¨çš„autoscaler,ä¸”æ”¯æŒä» 0 åˆ° 1 1 åˆ° 0 çš„ä¼¸ç¼©ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸šåŠ¡ä½å³°æˆ–è€…æ— æµé‡æ—¶å¯ä»¥é™åˆ° 0 ä¸ªå‰¯æœ¬æ•°(è¿™ä¸ªåœ¨ HPA è¢«è®¤ä¸ºæ˜¯ç¦ç”¨è¯¥åŠŸèƒ½ æ‰€ä»¥ KEDA è‡ªå·±å®ç°çš„ 0 åˆ° 1 1 åˆ° 0 çš„ä¼¸ç¼©çš„èƒ½åŠ›ï¼Œå‰©ä½™çš„æƒ…å†µå®ƒå«ä¸ª HPA å¤„ç†)ã€‚</p>
<p>ç›®å‰ KEDA æ”¯æŒäº‹ä»¶ç±»å‹å¦‚ä¸‹ï¼š</p>
<figure><a class=lightgallery href=/posts/hpa-controller/keda.png title=/posts/hpa-controller/keda.png data-thumbnail=/posts/hpa-controller/keda.png data-sub-html="<h2>KEDA æ”¯æŒçš„äº‹ä»¶</h2>">
<img class=lazyload src=/svg/loading.min.svg data-src=keda.png data-srcset="/posts/hpa-controller/keda.png, keda.png 1.5x, /posts/hpa-controller/keda.png 2x" data-sizes=auto alt=/posts/hpa-controller/keda.png width=800>
</a><figcaption class=image-caption>KEDA æ”¯æŒçš„äº‹ä»¶</figcaption>
</figure>
<p>åªéœ€è¦åˆ›å»º KEDA çš„ CRD èµ„æºï¼Œå°±èƒ½å®ç°åŸºäºäº‹ä»¶çš„å¼¹æ€§ä¼¸ç¼©ï¼ŒKEDA çš„ controller ä¼šåˆ›å»ºå¯¹åº”çš„ HPA å¯¹è±¡ã€‚</p>
<p>ä¸‹é¢ä»¥ <code>Prometheus</code> ä¸ºä¾‹ï¼š</p>
<p>KEDA.ScaledObject:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>keda.sh/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ScaledObject</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prom-scaledobject</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>scaleTargetRef</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>klyn-deploy</span><span class=w>
</span><span class=w>  </span><span class=nt>triggers</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>serverAddress</span><span class=p>:</span><span class=w> </span><span class=l>http://10.103.255.235:9090</span><span class=w> </span><span class=c># Prometheus æŸ¥è¯¢æ¥å£</span><span class=w>
</span><span class=w>      </span><span class=nt>metricName</span><span class=p>:</span><span class=w> </span><span class=l>http_request_count</span><span class=w> </span><span class=c># è‡ªå®šä¹‰åå­—</span><span class=w>
</span><span class=w>      </span><span class=nt>query</span><span class=p>:</span><span class=w> </span><span class=l>sum(rate(http_request_count{job=&#34;klyn-service&#34;}[2m]))</span><span class=w> </span><span class=c># æŸ¥è¯¢è¯­å¥ 2m å†…çš„å¹³å‡ qps</span><span class=w>
</span><span class=w>      </span><span class=nt>threshold</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;50&#39;</span><span class=w>
</span><span class=w>  </span><span class=nt>maxReplicaCount</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span><span class=w>  </span><span class=nt>minReplicaCount</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>  </span><span class=nt>pollingInterval</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>apply è¯¥ yaml åï¼Œä¼šåˆ›å»ºä¸€ä¸ª <code>ScaledObject</code> å’Œ <code>HPA</code> å¯¹è±¡ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>âœ kubectl get ScaledObject      
NAME                SCALETARGETKIND      SCALETARGETNAME   MIN   MAX   TRIGGERS     AUTHENTICATION   READY   ACTIVE   FALLBACK   AGE
prom-scaledobject   apps/v1.Deployment   klyn-deploy       <span class=m>1</span>     <span class=m>5</span>     prometheus                    True    False    False      9d

<span class=c1>## è¯¥ HPA å¯¹è±¡æœ‰ KEDA çš„ controller åˆ›å»ºçš„</span>
âœ kubectl get hpa               
NAME                         REFERENCE                TARGETS      MINPODS   MAXPODS   REPLICAS   AGE
keda-hpa-prom-scaledobject   Deployment/klyn-deploy   0/50 <span class=o>(</span>avg<span class=o>)</span>   <span class=m>1</span>         <span class=m>5</span>         <span class=m>1</span>          9d
</code></pre></td></tr></table>
</div>
</div><p>è¿™æ ·ä¸€æ¥ï¼Œå¯ä»¥æ ¹æ®å¾ˆå¤šäº‹ä»¶æ¥æ§åˆ¶ä¼¸ç¼©çš„èƒ½åŠ›ï¼Œè¿™æ¯”å•ä¸€æ¥ cpu,å†…å­˜åˆ©ç”¨ç‡æ¥çœ‹æ›´çµæ´»ä¸”åŠæ—¶ã€‚å®Œå…¨å¯ä»¥æ ¹æ®äº‹ä»¶åœ¨æœåŠ¡çš„å‰¯æœ¬æ•°ä¸å¤Ÿç”¨æˆ–è€…æœ‰ä¸€å †äº‹ä»¶å‡†å¤‡å¤„ç†æ—¶ï¼Œå°½å¯èƒ½å¿«é€Ÿæ‰©å®¹ï¼Œç¡®ä¿å¤„ç†èƒ½åŠ›ä¸ä¼šå—æŸã€‚</p>
<h2 id=6-æ€»ç»“>6. æ€»ç»“</h2>
<p>è¿™ç¯‡æ–‡ç« ä¸»è¦è®² HPA controller çš„æºç å’Œå¦‚ä½•ä½¿ç”¨ HPA ç›¸å…³å†…å®¹</p>
<ul>
<li><code>HPA/VPA</code> çš„è§£é‡Š</li>
<li>å¦‚ä½•ä½¿ç”¨ <code>HPA</code></li>
<li><code>HPA Controller</code> å¦‚ä½•å¤„ç†ä¸€æ¬¡ä¼¸ç¼©äº‹ä»¶çš„</li>
<li><code>HPA Controller</code> å¦‚ä½•è®¡ç®—ç›®æ ‡å®ä¾‹æ•°çš„</li>
<li>è®¤è¯†å’Œä½¿ç”¨ <code>KEDA</code> &ndash; ä¸€ä¸ªåŸºäºäº‹ä»¶é©±åŠ¨çš„ autoscaler</li>
</ul>
<h2 id=7-é“¾æ¥>7. é“¾æ¥ğŸ”—</h2>
<ul>
<li><a href=https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/ target=_blank rel="noopener noreffer">horizontal-pod-autoscale</a></li>
<li><a href=https://github.com/kubernetes/autoscaler/tree/master/vertical-pod-autoscaler target=_blank rel="noopener noreffer">pvertical-pod-autoscaler</a></li>
<li><a href=https://github.com/kubernetes-sigs/metrics-server target=_blank rel="noopener noreffer">metrics server</a></li>
<li><a href=https://keda.sh target=_blank rel="noopener noreffer">KEDA</a></li>
</ul></div><div class=post-footer id=post-footer>
<div class=post-info>
<div class=post-info-line>
<div class=post-info-mod>
<span>æ›´æ–°äº 2022-01-20</span>
</div>
<div class=post-info-license></div>
</div>
<div class=post-info-line>
<div class=post-info-md><span>
<a class=link-to-markdown href=/posts/hpa-controller/index.md target=_blank>é˜…è¯»åŸå§‹æ–‡æ¡£</a>
</span></div>
<div class=post-info-share>
<span><a href=javascript:void(0); title="åˆ†äº«åˆ° Twitter" data-sharer=twitter data-url=https://yusank.github.io/posts/hpa-controller/ data-title="HPA controller æºç è§£è¯»" data-hashtags=go,k8s,æºç è§£è¯»><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° Facebook" data-sharer=facebook data-url=https://yusank.github.io/posts/hpa-controller/ data-hashtag=go><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° Linkedin" data-sharer=linkedin data-url=https://yusank.github.io/posts/hpa-controller/><i class="fab fa-linkedin fa-fw"></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° WhatsApp" data-sharer=whatsapp data-url=https://yusank.github.io/posts/hpa-controller/ data-title="HPA controller æºç è§£è¯»" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° Hacker News" data-sharer=hackernews data-url=https://yusank.github.io/posts/hpa-controller/ data-title="HPA controller æºç è§£è¯»"><i class="fab fa-hacker-news fa-fw"></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° Reddit" data-sharer=reddit data-url=https://yusank.github.io/posts/hpa-controller/><i class="fab fa-reddit fa-fw"></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° Line" data-sharer=line data-url=https://yusank.github.io/posts/hpa-controller/ data-title="HPA controller æºç è§£è¯»"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/line.svg></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° å¾®åš" data-sharer=weibo data-url=https://yusank.github.io/posts/hpa-controller/ data-title="HPA controller æºç è§£è¯»" data-ralateuid=yusann><i class="fab fa-weibo fa-fw"></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° Myspace" data-sharer=myspace data-url=https://yusank.github.io/posts/hpa-controller/ data-title="HPA controller æºç è§£è¯»" data-description><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/myspace.svg></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° Blogger" data-sharer=blogger data-url=https://yusank.github.io/posts/hpa-controller/ data-title="HPA controller æºç è§£è¯»" data-description><i class="fab fa-blogger fa-fw"></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° ç™¾åº¦" data-sharer=baidu data-url=https://yusank.github.io/posts/hpa-controller/ data-title="HPA controller æºç è§£è¯»"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/baidu.svg></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° Evernote" data-sharer=evernote data-url=https://yusank.github.io/posts/hpa-controller/ data-title="HPA controller æºç è§£è¯»"><i class="fab fa-evernote fa-fw"></i></a></span>
</div>
</div>
</div>
<div class=post-info-more>
<section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/go/>go</a>,&nbsp;<a href=/tags/k8s/>k8s</a>,&nbsp;<a href=/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/>æºç è§£è¯»</a></section>
<section>
<span><a href=javascript:void(0); onclick=window.history.back()>è¿”å›</a></span>&nbsp;|&nbsp;<span><a href=/>ä¸»é¡µ</a></span>
</section>
</div>
<div class=post-nav><a href=/posts/shard-map/ class=prev rel=prev title="go è¯­è¨€ä¸­çš„åˆ†ç‰‡ map çš„å®ç°"><i class="fas fa-angle-left fa-fw"></i>go è¯­è¨€ä¸­çš„åˆ†ç‰‡ map çš„å®ç°</a></div>
</div>
<div id=comments><div id=utterances></div><noscript>
Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>Utterances</a>.
</noscript></div></article></div>
</main><footer class=footer>
<div class=footer-container><div class=footer-line>Keep learning and stay with lights.<br>â¤ yusank<br></div><div class=footer-line>ç”± <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.92.0">Hugo</a> å¼ºåŠ›é©±åŠ¨ | ä¸»é¢˜ - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
</div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2017 - 2022</span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by/4.0/deed.zh target=_blank>CC BY-NC 4.0</a></span></div>
</div>
</footer></div>
<div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=å›åˆ°é¡¶éƒ¨>
<i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=æŸ¥çœ‹è¯„è®º>
<i class="fas fa-comment fa-fw"></i>
</a>
</div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/copy-tex.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/typeit@7.0.4/dist/typeit.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"å¤åˆ¶åˆ°å‰ªè´´æ¿",maxShownLines:100},comment:{utterances:{darkTheme:"github-dark",issueTerm:"pathname",label:"Comment",lightTheme:"github-light",repo:"yusank/yusank.github.io"}},data:{"id-1":"usank`s Site","id-2":"usank`s Site"},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},typeit:{cursorChar:"|",cursorSpeed:1e3,data:{"id-1":["id-1"],"id-2":["id-2"]},duration:-1,speed:70}}</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-24P8ZSJHCQ',{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-24P8ZSJHCQ" async></script></body>
</html>