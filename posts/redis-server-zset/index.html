<!doctype html><html lang=zh-cn>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=robots content="noodp">
<meta http-equiv=x-ua-compatible content="IE=edge, chrome=1">
<title>[ç³»åˆ—]Redis Server å®ç°Â·æœ‰åºé›†åˆç¯‡ - Yusank`s Site</title><meta name=Description content="è¿™æ˜¯æˆ‘çš„ä¸ªäººåšå®¢ï¼Œæˆ‘ä¼šåœ¨è¿™é‡Œåˆ†äº«å­¦ä¹ å’Œæˆé•¿è¿‡ç¨‹ä¸­çš„ç§¯ç´¯å’Œç»éªŒ."><meta property="og:title" content="[ç³»åˆ—]Redis Server å®ç°Â·æœ‰åºé›†åˆç¯‡">
<meta property="og:description" content="
æœ¬ç¯‡è®²è¿° Redis ä¸­çš„åŸºç¡€æ•°æ®ç»“æ„ ZSet(SortedSet) çš„åº•å±‚å®ç°åŸç†å’Œå¦‚ä½•é€šè¿‡ go è¯­è¨€å®ç°ä¸€ä¸ª ZSet çš„è¿‡ç¨‹ä»¥åŠéœ€è¦æ³¨æ„çš„é—®é¢˜ã€‚
">
<meta property="og:type" content="article">
<meta property="og:url" content="https://yusank.github.io/posts/redis-server-zset/"><meta property="og:image" content="https://yusank.github.io/logo.png"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2022-01-07T10:50:00+08:00">
<meta property="article:modified_time" content="2022-01-07T21:19:06+08:00">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://yusank.github.io/logo.png">
<meta name=twitter:title content="[ç³»åˆ—]Redis Server å®ç°Â·æœ‰åºé›†åˆç¯‡">
<meta name=twitter:description content="
æœ¬ç¯‡è®²è¿° Redis ä¸­çš„åŸºç¡€æ•°æ®ç»“æ„ ZSet(SortedSet) çš„åº•å±‚å®ç°åŸç†å’Œå¦‚ä½•é€šè¿‡ go è¯­è¨€å®ç°ä¸€ä¸ª ZSet çš„è¿‡ç¨‹ä»¥åŠéœ€è¦æ³¨æ„çš„é—®é¢˜ã€‚
">
<meta name=application-name content="Yusank's Site">
<meta name=apple-mobile-web-app-title content="Yusank's Site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel=icon href=https://yusank.github.io/images/logo.svg><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://yusank.github.io/posts/redis-server-zset/><link rel=prev href=https://yusank.github.io/posts/redeis-server-list/><link rel=next href=https://yusank.github.io/posts/shard-map/><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"[ç³»åˆ—]Redis Server å®ç°Â·æœ‰åºé›†åˆç¯‡","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/yusank.github.io\/posts\/redis-server-zset\/"},"genre":"posts","keywords":"redis, ç³»åˆ—ç¯‡, æ•°æ®ç»“æ„","wordcount":6306,"url":"https:\/\/yusank.github.io\/posts\/redis-server-zset\/","datePublished":"2022-01-07T10:50:00+08:00","dateModified":"2022-01-07T21:19:06+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Yusank"},"description":""}</script></head>
<body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':'auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark')&&document.body.setAttribute('theme','dark')</script>
<div id=mask></div><div class=wrapper><header class=desktop id=header-desktop>
<div class=header-wrapper>
<div class=header-title>
<a href=/ title="Yusank`s Site"><img class="lazyload logo" src=/svg/loading.min.svg data-src=https://yusank.github.io/images/logo.svg data-srcset="https://yusank.github.io/images/logo.svg, https://yusank.github.io/images/logo.svg 1.5x, https://yusank.github.io/images/logo.svg 2x" data-sizes=auto alt=https://yusank.github.io/images/logo.svg title=https://yusank.github.io/images/logo.svg><span id=id-1 class=typeit></span></a>
</div>
<div class=menu>
<div class=menu-inner><a class=menu-item href=/posts/> æ–‡ç«  </a><a class=menu-item href=/categories/> åˆ†ç±» </a><a class=menu-item href=/tags/> æ ‡ç­¾ </a><a class=menu-item href=/about/> å…³äº </a><a class=menu-item href=/links/> å‹é“¾ </a><a class=menu-item href=https://github.com/yusank title=GitHub rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i> </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title=åˆ‡æ¢ä¸»é¢˜>
<i class="fas fa-adjust fa-fw"></i>
</a>
</div>
</div>
</div>
</header><header class=mobile id=header-mobile>
<div class=header-container>
<div class=header-wrapper>
<div class=header-title>
<a href=/ title="Yusank`s Site"><img class="lazyload logo" src=/svg/loading.min.svg data-src=https://yusank.github.io/images/logo.svg data-srcset="https://yusank.github.io/images/logo.svg, https://yusank.github.io/images/logo.svg 1.5x, https://yusank.github.io/images/logo.svg 2x" data-sizes=auto alt=https://yusank.github.io/images/logo.svg title=https://yusank.github.io/images/logo.svg><span id=id-2 class=typeit></span></a>
</div>
<div class=menu-toggle id=menu-toggle-mobile>
<span></span><span></span><span></span>
</div>
</div>
<div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>æ–‡ç« </a><a class=menu-item href=/categories/ title>åˆ†ç±»</a><a class=menu-item href=/tags/ title>æ ‡ç­¾</a><a class=menu-item href=/about/ title>å…³äº</a><a class=menu-item href=/links/ title>å‹é“¾</a><a class=menu-item href=https://github.com/yusank title=GitHub rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i></a><a href=javascript:void(0); class="menu-item theme-switch" title=åˆ‡æ¢ä¸»é¢˜>
<i class="fas fa-adjust fa-fw"></i>
</a></div>
</div>
</header>
<div class="search-dropdown desktop">
<div id=search-dropdown-desktop></div>
</div>
<div class="search-dropdown mobile">
<div id=search-dropdown-mobile></div>
</div>
<main class=main>
<div class=container><div class=toc id=toc-auto>
<h2 class=toc-title>ç›®å½•</h2>
<div class=toc-content id=toc-content-auto></div>
</div><article class="page single"><h1 class="single-title animated flipInX">[ç³»åˆ—]Redis Server å®ç°Â·æœ‰åºé›†åˆç¯‡</h1><div class=post-meta>
<div class=post-meta-line><span class=post-author><a href=https://github.com/yusank title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw"></i>Yusank</a></span>&nbsp;<span class=post-category>æ”¶å½•äº <a href=/categories/redis/><i class="far fa-folder fa-fw"></i>Redis</a></span></div>
<div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2022-01-07>2022-01-07</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;çº¦ 6306 å­—&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;é¢„è®¡é˜…è¯» 13 åˆ†é’Ÿ&nbsp;</div>
</div><div class="details toc" id=toc-static kept>
<div class="details-summary toc-title">
<span>ç›®å½•</span>
<span><i class="details-icon fas fa-angle-right"></i></span>
</div>
<div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents>
<ul>
<li><a href=#1-å‰è¨€>1 å‰è¨€</a></li>
<li><a href=#2-zset-æ”¯æŒçš„èƒ½åŠ›>2 zset æ”¯æŒçš„èƒ½åŠ›</a></li>
<li><a href=#3-zset-åº•å±‚åŸç†>3 zset åº•å±‚åŸç†</a>
<ul>
<li><a href=#31-å‹ç¼©åˆ—è¡¨-ziplist>3.1 å‹ç¼©åˆ—è¡¨-ziplist</a></li>
<li><a href=#32-è·³è·ƒè¡¨-skiplist>3.2 è·³è·ƒè¡¨-skiplist</a>
<ul>
<li><a href=#321-å®šä¹‰>3.2.1 å®šä¹‰</a></li>
<li><a href=#322-åŸç†>3.2.2 åŸç†</a></li>
<li><a href=#323-æŸ¥è¯¢å…ƒç´ >3.2.3 æŸ¥è¯¢å…ƒç´ </a></li>
<li><a href=#324-æ·»åŠ å…ƒç´ >3.2.4 æ·»åŠ å…ƒç´ </a>
<ul>
<li><a href=#3241-éšæœº-level-ç®—æ³•>3.2.4.1 éšæœº level ç®—æ³•</a></li>
</ul>
</li>
<li><a href=#325-åˆ é™¤å…ƒç´ >3.2.5 åˆ é™¤å…ƒç´ </a></li>
<li><a href=#326-æ›´æ–°å…ƒç´ >3.2.6 æ›´æ–°å…ƒç´ </a></li>
</ul>
</li>
</ul>
</li>
<li><a href=#4-zset-å®ç°>4 zset å®ç°</a>
<ul>
<li><a href=#41-æ•°æ®ç»“æ„å®šä¹‰>4.1 æ•°æ®ç»“æ„å®šä¹‰</a></li>
<li><a href=#42-åˆå§‹åŒ–>4.2 åˆå§‹åŒ–</a></li>
<li><a href=#43-å…¶ä»–åŠŸèƒ½>4.3 å…¶ä»–åŠŸèƒ½</a>
<ul>
<li><a href=#431-æ ¹æ®æ’åæŸ¥æ‰¾å…ƒç´ >4.3.1 æ ¹æ®æ’åæŸ¥æ‰¾å…ƒç´ </a></li>
<li><a href=#432-zrange-å®ç°>4.3.2 zrange å®ç°</a></li>
</ul>
</li>
</ul>
</li>
<li><a href=#5-æ€»ç»“>5 æ€»ç»“</a></li>
<li><a href=#6-å‚è€ƒé“¾æ¥>6 å‚è€ƒé“¾æ¥ğŸ”—</a></li>
</ul>
</nav></div>
</div><div class=content id=content><blockquote>
<p>æœ¬ç¯‡è®²è¿° <code>Redis</code> ä¸­çš„åŸºç¡€æ•°æ®ç»“æ„ <code>ZSet</code>(<code>SortedSet</code>) çš„åº•å±‚å®ç°åŸç†å’Œå¦‚ä½•é€šè¿‡ go è¯­è¨€å®ç°ä¸€ä¸ª <code>ZSet</code> çš„è¿‡ç¨‹ä»¥åŠéœ€è¦æ³¨æ„çš„é—®é¢˜ã€‚</p>
</blockquote>
<div class="details admonition quote open">
<div class="details-summary admonition-title">
<i class="icon fas fa-quote-right fa-fw"></i>è¯´æ˜<i class="details-icon fas fa-angle-right fa-fw"></i>
</div>
<div class=details-content>
<div class=admonition-content>æœ¬æ–‡ç« ä¸ºè¯¥ç³»åˆ—çš„<code>æœ‰åºé›†åˆ</code>ï¼Œå¦‚æœéœ€è¦é˜…è¯»å…¶ä»–ç›¸å…³æ–‡ç« ï¼Œ è¯·ç‚¹å‡»<a href=https://yusank.github.io/posts/redeis-server-introduction/ target=_blank rel="noopener noreffer">è¿™é‡Œ</a>è·³è½¬æŸ¥çœ‹</div>
</div>
</div>
<h2 id=1-å‰è¨€>1 å‰è¨€</h2>
<p>ä½¿ç”¨ Redis è¿‡ç¨‹ä¸­é›†åˆè¿™ä¸ªæ¦‚å¿µå‡ºç°çš„æ¯”è¾ƒé¢‘ç¹ï¼Œå¸¸ç”¨çš„ <code>set</code>ï¼Œ<code>zset</code> éƒ½æ˜¯é›†åˆçš„æ¦‚å¿µã€‚ä¸æ™®é€šçš„é›†åˆä¸åŒçš„æ˜¯ï¼Œ<code>zset</code> çš„å…ƒç´ ä¹‹é—´æ˜¯æœ‰é¡ºåºçš„ï¼Œè€Œä¸”è¿™ä¸ªé¡ºåºä¸æ˜¯æ’å…¥çš„é¡ºåºè€Œæ˜¯ä½¿ç”¨è€…æ’å…¥å…ƒç´ æ—¶æŒ‡å®šçš„ score è€Œå®šçš„ã€‚</p>
<p><code>zset</code> ä¸­çš„ä»»ä½•å…ƒç´ éƒ½æ˜¯æœ‰score å€¼ï¼ˆæµ®ç‚¹æ•°ï¼‰çš„ï¼Œè€Œä¸”æ ¹æ® score çš„é¡ºåºè¿›è¡Œè¯»å†™ç”šè‡³å¯ä»¥åšåˆ°è·å–èŒƒå›´æ•°æ®ï¼Œè¿™äº›ç‰¹æ€§ç»™ä½¿ç”¨è€…å¸¦æ¥äº†æ— æ•°ç§å¯èƒ½æ€§è§£å†³æ–¹æ¡ˆã€‚</p>
<div class="details admonition tip open">
<div class="details-summary admonition-title">
<i class="icon fas fa-lightbulb fa-fw"></i>zset çš„æ•°æ®ç»“æ„<i class="details-icon fas fa-angle-right fa-fw"></i>
</div>
<div class=details-content>
<div class=admonition-content><p>ä»ä½¿ç”¨è€…çš„è§’åº¦æ¥è¯´ï¼Œzset æ›´åƒä¸€ä¸ª kv ç»“æ„,å…ƒç´ ä¸å¯ä»¥é‡å¤ä½†æ˜¯ä¸åŒå…ƒç´ çš„ score å€¼æ˜¯å¯ä»¥ä¸€æ ·çš„ï¼Œæ­¤æ—¶çš„æ’åºæ˜¯æŒ‰å…ƒç´ å­—å…¸æ’åºã€‚</p>
<p>é€šè¿‡ <code>ZRANGEBYSCORE</code> å‘½ä»¤å¯ä»¥åˆ—å‡ºæŒ‡å®šscoreèŒƒå›´å†…çš„å…ƒç´ ä»¥åŠå¯¹åº”çš„ keyï¼Œ
å…¶é¡ºåºä¸º score çš„å‡åºã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>&gt; ZRANGEBYSCORE zset1 <span class=m>0</span> <span class=m>100</span> withscores
1<span class=o>)</span> <span class=s2>&#34;a&#34;</span>
2<span class=o>)</span> <span class=s2>&#34;5&#34;</span>
3<span class=o>)</span> <span class=s2>&#34;b&#34;</span>
4<span class=o>)</span> <span class=s2>&#34;5&#34;</span>
5<span class=o>)</span> <span class=s2>&#34;hello&#34;</span>
6<span class=o>)</span> <span class=s2>&#34;20&#34;</span>
</code></pre></td></tr></table>
</div>
</div></div>
</div>
</div>
<h2 id=2-zset-æ”¯æŒçš„èƒ½åŠ›>2 zset æ”¯æŒçš„èƒ½åŠ›</h2>
<p><code>zset</code> ä½œä¸ºä¸€ä¸ªæœ‰åºé›†åˆï¼Œå³æ‹¥æœ‰æ™®é€šé›†åˆçš„ç‰¹æ€§ï¼ŒåŒæ—¶åˆåŸºäºå…¶æœ‰åºç‰¹æ€§è¡ç”Ÿå‡ºæ›´å¤šåˆ«çš„ç‰¹æ€§ã€‚ä¸»è¦ç‰¹æ€§å¦‚ä¸‹ï¼š</p>
<ul>
<li>å…ƒç´ ä¸é‡å¤</li>
<li>é›†åˆä¹‹é—´äº¤é›†å¹¶é›†å·®é›†çš„æ“ä½œ</li>
<li>æ‰¹é‡è¯»å†™å…ƒç´ </li>
<li>æ ¹æ® score æ“ä½œï¼ˆå¢åˆ æ”¹æŸ¥ï¼‰å…ƒç´ </li>
<li>è·å–scoreæœ€å¤§æœ€å°çš„å…ƒç´ </li>
<li>æ ¹æ®é›†åˆå†…rankï¼ˆæˆ– indexï¼‰æ“ä½œï¼ˆå¢åˆ æ”¹æŸ¥ï¼‰å…ƒç´ </li>
</ul>
<h2 id=3-zset-åº•å±‚åŸç†>3 zset åº•å±‚åŸç†</h2>
<div class="details admonition warning open">
<div class="details-summary admonition-title">
<i class="icon fas fa-exclamation-triangle fa-fw"></i>æ³¨æ„<i class="details-icon fas fa-angle-right fa-fw"></i>
</div>
<div class=details-content>
<div class=admonition-content>æœ¬ç¯‡ä¸­æ‰€æœ‰å¼•ç”¨çš„ Redis æºç å‡åŸºäº <code>Redis6.2</code> ç‰ˆæœ¬ã€‚</div>
</div>
</div>
<p>Redis å®ç°çš„ <code>zset</code> åº•å±‚æ˜¯è·³è·ƒè¡¨å’Œå“ˆå¸Œè¡¨çš„ç»„åˆã€‚<code>è·³è·ƒè¡¨</code> ç”¨äºè®°å½•å’Œæ“ä½œæ‰€æœ‰åŸºäº score çš„æ“ä½œï¼Œè€Œ<code>å“ˆå¸Œè¡¨</code>å­˜çš„æ˜¯å…ƒç´ å€¼å’Œ score çš„kvå…³ç³»ï¼Œç”¨äºå¿«é€Ÿå®šä½å…ƒç´ å­˜ä¸å­˜åœ¨çš„æƒ…å†µã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=k>typedef</span> <span class=k>struct</span> <span class=n>zset</span> <span class=p>{</span>
    <span class=n>dict</span> <span class=o>*</span><span class=n>dict</span><span class=p>;</span> <span class=c1>// å“ˆå¸Œè¡¨ï¼Œå­˜å‚¨ å…ƒç´ -&gt;score
</span><span class=c1></span>    <span class=n>zskiplist</span> <span class=o>*</span><span class=n>zsl</span><span class=p>;</span> <span class=c1>// è·³è·ƒè¡¨
</span><span class=c1></span><span class=p>}</span> <span class=n>zset</span><span class=p>;</span>
</code></pre></td></tr></table>
</div>
</div><p>é™¤äº†è·³è·ƒè¡¨å’Œå“ˆå¸Œè¡¨ä¹‹å¤–ï¼Œå…¶å®è¿˜æœ‰ä¸€ä¸ªä¸æ€ä¹ˆå‡ºåœºçš„æ•°æ®ç»“æ„ &ndash; <code>ziplist</code>ï¼ˆå‹ç¼©åˆ—è¡¨ï¼‰ã€‚åœ¨æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶çš„æƒ…å†µä¸‹ï¼ŒRedis ä¼šä½¿ç”¨ <code>ziplist</code>æ¥æ›¿ä»£è·³è·ƒè¡¨ã€‚</p>
<ol>
<li>ä¿å­˜çš„å…ƒç´ å°‘äº128ä¸ª</li>
<li>ä¿å­˜çš„æ‰€æœ‰å…ƒç´ å¤§å°éƒ½å°äº64å­—èŠ‚</li>
</ol>
<p>åœ¨äº†è§£è·³è·ƒè¡¨ä¹‹å‰å…ˆäº†ç®€å•è§£ä¸€ä¸‹ <code>ziplist</code> è¿™ä¸ªæ•°æ®ç»“æ„çš„å®ç°ä»¥åŠè§£ç­”ä¸ºä»€ä¹ˆè¦ç”¨ <code>ziplist</code> æ¥æ›¿ä»£è·³è·ƒè¡¨ã€‚</p>
<h3 id=31-å‹ç¼©åˆ—è¡¨-ziplist>3.1 å‹ç¼©åˆ—è¡¨-ziplist</h3>
<p>ziplist ç¼–ç çš„æœ‰åºé›†åˆå¯¹è±¡ä½¿ç”¨å‹ç¼©åˆ—è¡¨ä½œä¸ºåº•å±‚å®ç°ï¼Œæ¯ä¸ªé›†åˆå…ƒç´ ä½¿ç”¨ä¸¤ä¸ªç´§æŒ¨åœ¨ä¸€èµ·çš„å‹ç¼©åˆ—è¡¨èŠ‚ç‚¹æ¥ä¿å­˜ï¼Œç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¿å­˜å…ƒç´ çš„æˆå‘˜ï¼Œç¬¬äºŒä¸ªèŠ‚ç‚¹ä¿å­˜å…ƒç´ çš„åˆ†å€¼ã€‚å¹¶ä¸”å‹ç¼©åˆ—è¡¨å†…çš„é›†åˆå…ƒç´ æŒ‰åˆ†å€¼ä»å°åˆ°å¤§çš„é¡ºåºè¿›è¡Œæ’åˆ—ã€‚</p>
<p>ä»ä¸Šè¿°çš„ä¸¤ä¸ªæ¡ä»¶å¯ä»¥çœ‹å‡ºï¼Œåœ¨æ•°æ®é‡å°‘ä¸”å•ä¸ªå…ƒç´ ä¹Ÿæ¯”è¾ƒå°çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨ ziplist æ˜¯ä¸ºäº†èŠ‚çœå†…å­˜ï¼Œå› ä¸ºåœ¨æ•°æ®é‡å°‘çš„æƒ…å†µä¸‹å‘æŒ¥ä¸å‡ºæ¥ skiplist çš„ä¼˜åŠ¿ä¸”å çš„å†…å­˜æ¯” ziplist å¤§ã€‚</p>
<p>æƒ³æ›´æ·±å…¥äº†è§£ ziplist çš„å®ç°ç»†èŠ‚ï¼Œè¯·<a href=https://redisbook.readthedocs.io/en/latest/compress-datastruct/ziplist.html target=_blank rel="noopener noreffer">ç‚¹å‡»</a>è¿™é‡ŒæŸ¥çœ‹</p>
<div class="details admonition inf open">
<div class="details-summary admonition-title">
<i class="icon fas fa-pencil-alt fa-fw"></i>ç»“æ„åˆ†å¸ƒ<i class="details-icon fas fa-angle-right fa-fw"></i>
</div>
<div class=details-content>
<div class=admonition-content><ul>
<li>ziplist ç»“æ„åˆ†å¸ƒ</li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-markdown data-lang=markdown>area        |<span class=p>&lt;</span><span class=nt>----</span> <span class=na>ziplist</span> <span class=na>header</span> <span class=na>----</span><span class=p>&gt;</span>|<span class=p>&lt;</span><span class=nt>-----------</span> <span class=na>entries</span> <span class=na>-------------</span><span class=p>&gt;</span>|<span class=p>&lt;</span><span class=nt>-end-</span><span class=p>&gt;</span>|

size          4 bytes  4 bytes  2 bytes    ?        ?        ?        ?     1 byte
            +---------+--------+-------+--------+--------+--------+--------+-------+
component   | zlbytes | zltail | zllen | entry1 | entry2 |  ...   | entryN | zlend |
            +---------+--------+-------+--------+--------+--------+--------+-------+
                                       ^                          ^        ^
address                                |                          |        |
                                ZIPLIST_ENTRY_HEAD                |   ZIPLIST_ENTRY_END
                                                                  |
                                                         ZIPLIST_ENTRY_TAIL
</code></pre></td></tr></table>
</div>
</div><ul>
<li>ziplist èŠ‚ç‚¹ç»“æ„åˆ†å¸ƒ</li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-markdown data-lang=markdown>area        |<span class=p>&lt;</span><span class=nt>-------------------</span> <span class=na>entry</span> <span class=na>--------------------</span><span class=p>&gt;</span>|

            +------------------+----------+--------+---------+
component   | pre_entry_length | encoding | length | content |
            +------------------+----------+--------+---------+
</code></pre></td></tr></table>
</div>
</div></div>
</div>
</div>
<h3 id=32-è·³è·ƒè¡¨-skiplist>3.2 è·³è·ƒè¡¨-skiplist</h3>
<h4 id=321-å®šä¹‰>3.2.1 å®šä¹‰</h4>
<p>è·³è·ƒè¡¨æ˜¯ä¸€ä¸ªéšæœºåŒ–çš„æ•°æ®ç»“æ„ï¼Œå®è´¨å°±æ˜¯ä¸€ç§å¯ä»¥è¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾çš„æœ‰åºé“¾è¡¨ã€‚è·³è·ƒè¡¨åœ¨åŸæœ‰çš„æœ‰åºé“¾è¡¨ä¸Šé¢å¢åŠ äº†å¤šçº§ç´¢å¼•ï¼Œé€šè¿‡ç´¢å¼•æ¥å®ç°å¿«é€ŸæŸ¥æ‰¾ã€‚è·³è·ƒè¡¨ä¸ä»…èƒ½æé«˜æœç´¢æ€§èƒ½ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥æé«˜æ’å…¥å’Œåˆ é™¤æ“ä½œçš„æ€§èƒ½ã€‚</p>
<p>å®ƒé‡‡ç”¨éšæœºæŠ€æœ¯å†³å®šé“¾è¡¨ä¸­å“ªäº›èŠ‚ç‚¹åº”å¢åŠ å‘å‰æŒ‡é’ˆä»¥åŠåœ¨è¯¥èŠ‚ç‚¹ä¸­åº”å¢åŠ å¤šå°‘ä¸ªæŒ‡é’ˆã€‚è·³è·ƒè¡¨ç»“æ„çš„å¤´èŠ‚ç‚¹éœ€æœ‰è¶³å¤Ÿçš„æŒ‡é’ˆåŸŸï¼Œä»¥æ»¡è¶³å¯èƒ½æ„é€ æœ€å¤§çº§æ•°çš„éœ€è¦ï¼Œè€Œå°¾èŠ‚ç‚¹ä¸éœ€è¦æŒ‡é’ˆåŸŸã€‚</p>
<p>é‡‡ç”¨è¿™ç§éšæœºæŠ€æœ¯ï¼Œè·³è·ƒè¡¨ä¸­çš„æœç´¢ã€æ’å…¥ã€åˆ é™¤æ“ä½œçš„æ—¶é—´å‡ä¸º<code>O(logn)</code>ï¼Œç„¶è€Œï¼Œæœ€åæƒ…å†µä¸‹æ—¶é—´å¤æ‚æ€§å´å˜æˆ<code>O(n)</code>ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œåœ¨ä¸€ä¸ªæœ‰åºæ•°ç»„æˆ–é“¾è¡¨ä¸­è¿›è¡Œæ’å…¥/åˆ é™¤æ“ä½œçš„æ—¶é—´ä¸º<code>O(n)</code>ï¼Œæœ€åæƒ…å†µä¸‹ä¸º<code>O(n)</code>ã€‚</p>
<h4 id=322-åŸç†>3.2.2 åŸç†</h4>
<p>è·³è·ƒè¡¨åŸç†éå¸¸ç®€å•ï¼Œåœ¨é“¾è¡¨çš„åŸºç¡€ä¸Šæ¯ä¸ªå…ƒç´ åŠ ä¸Šä¸€ä¸ªå±‚(level)çš„æ¦‚å¿µï¼Œå±‚é«˜åˆ™æ˜¯éšæœºçš„, æ‰€ä»¥æ¯ä¸ªå…ƒç´ çš„é«˜åº¦ä¸ä¸€æ ·ã€‚æ¯ä¸€å±‚éƒ½ä¼šæŒ‡å‘ä¸‹ä¸€ä¸ªåŒä¸€å±‚çš„å…ƒç´ ï¼ŒæŸ¥è¯¢å…ƒç´ æ—¶ç”±é«˜å±‚å‘åå‘ä¸‹çš„æ–¹å¼äºŒçº§æ£€ç´¢ä»è€Œè¾¾åˆ°æ›´é«˜çš„æŸ¥è¯¢æ•ˆç‡ï¼Œä¸‹é¢ç”¨å›¾è§£çš„æ–¹å¼è§£æå¦‚ä½•è¯»å†™è·³è·ƒè¡¨å…ƒç´ çš„ã€‚åœ¨çœ‹å›¾ä¹‹å‰å¯ä»¥å…ˆçœ‹ä¸€ä¸‹æºç ï¼Œå°è¯•ç†è§£ä¸€ä¸‹ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=c1>// è·³è·ƒè¡¨ç»“æ„
</span><span class=c1></span><span class=k>typedef</span> <span class=k>struct</span> <span class=n>zskiplist</span> <span class=p>{</span>
    <span class=k>struct</span> <span class=n>zskiplistNode</span> <span class=o>*</span><span class=n>header</span><span class=p>,</span> <span class=o>*</span><span class=n>tail</span><span class=p>;</span> <span class=c1>// è®°å½• head å’Œ tail ä¸¤ä¸ªèŠ‚ç‚¹
</span><span class=c1></span>    <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>length</span><span class=p>;</span> <span class=c1>// è®°å½•é•¿åº¦
</span><span class=c1></span>    <span class=kt>int</span> <span class=n>level</span><span class=p>;</span> <span class=c1>// è®°å½•å½“å‰æœ€é«˜ levelï¼Œå¦‚æœæœ‰æ–°å…ƒç´ æ’å…¥ä¸”å…¶ level å¤§äºå½“å‰æœ€é«˜åˆ™æ›´æ–°è¯¥å€¼
</span><span class=c1></span><span class=p>}</span> <span class=n>zskiplist</span><span class=p>;</span>

<span class=c1>// è·³è·ƒè¡¨èŠ‚ç‚¹
</span><span class=c1></span><span class=k>typedef</span> <span class=k>struct</span> <span class=n>zskiplistNode</span> <span class=p>{</span>
    <span class=n>sds</span> <span class=n>ele</span><span class=p>;</span> <span class=c1>// å…ƒç´ å€¼
</span><span class=c1></span>    <span class=kt>double</span> <span class=n>score</span><span class=p>;</span> <span class=c1>// score
</span><span class=c1></span>    <span class=k>struct</span> <span class=n>zskiplistNode</span> <span class=o>*</span><span class=n>backward</span><span class=p>;</span> <span class=c1>// å‘å‰æŒ‡å‘æŒ‡é’ˆï¼Œç”¨äºå¾€å›è·³
</span><span class=c1></span>    <span class=k>struct</span> <span class=n>zskiplistLevel</span> <span class=p>{</span>
        <span class=k>struct</span> <span class=n>zskiplistNode</span> <span class=o>*</span><span class=n>forward</span><span class=p>;</span> <span class=c1>// æ¯ä¸€å±‚éƒ½æŒ‡å‘ä¸‹ä¸€ä¸ªåŒé«˜åº¦å…ƒç´ 
</span><span class=c1></span>        <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>span</span><span class=p>;</span> <span class=c1>// åˆ°ä¸‹ä¸€ä¸ªåŒé«˜åº¦å…ƒç´ çš„è·¨åº¦
</span><span class=c1></span>    <span class=p>}</span> <span class=n>level</span><span class=p>[];</span> <span class=c1>// è¯¥å…ƒç´ çš„ level æ•°ç»„ï¼Œindex ä» 0 åˆ° N è¡¨ç¤ºä»æœ€ä½åˆ°æœ€é«˜ï¼Œé»˜è®¤æœ€é«˜æ”¯æŒ 32 å±‚
</span><span class=c1></span><span class=p>}</span> <span class=n>zskiplistNode</span><span class=p>;</span>
</code></pre></td></tr></table>
</div>
</div><p>å¦‚æœçœ‹å®Œæºç è¿˜æ˜¯æ²¡æœ‰çœ‹åˆ° ï¼Œè¯·çœ‹ä¸‹å›¾ï¼š</p>
<figure><a class=lightgallery href=https://redisbook.readthedocs.io/en/latest/_images/skiplist.png title=https://redisbook.readthedocs.io/en/latest/_images/skiplist.png data-thumbnail=https://redisbook.readthedocs.io/en/latest/_images/skiplist.png data-sub-html="<h2>è·³è·ƒè¡¨ç»“æ„</h2>">
<img class=lazyload src=/svg/loading.min.svg data-src=https://redisbook.readthedocs.io/en/latest/_images/skiplist.png data-srcset="https://redisbook.readthedocs.io/en/latest/_images/skiplist.png, https://redisbook.readthedocs.io/en/latest/_images/skiplist.png 1.5x, https://redisbook.readthedocs.io/en/latest/_images/skiplist.png 2x" data-sizes=auto alt=https://redisbook.readthedocs.io/en/latest/_images/skiplist.png width=800>
</a><figcaption class=image-caption>è·³è·ƒè¡¨ç»“æ„</figcaption>
</figure>
<p>ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œ è·³è·ƒè¡¨ä¸»è¦ç”±ä»¥ä¸‹éƒ¨åˆ†æ„æˆï¼š</p>
<ul>
<li>è¡¨å¤´ï¼ˆheadï¼‰ï¼šè´Ÿè´£ç»´æŠ¤è·³è·ƒè¡¨çš„èŠ‚ç‚¹æŒ‡é’ˆã€‚</li>
<li>è·³è·ƒè¡¨èŠ‚ç‚¹ï¼šä¿å­˜ç€å…ƒç´ å€¼ï¼Œä»¥åŠå¤šä¸ªå±‚ã€‚</li>
<li>å±‚ï¼šä¿å­˜ç€æŒ‡å‘å…¶ä»–å…ƒç´ çš„æŒ‡é’ˆã€‚é«˜å±‚çš„æŒ‡é’ˆè¶Šè¿‡çš„å…ƒç´ æ•°é‡å¤§äºç­‰äºä½å±‚çš„æŒ‡é’ˆï¼Œä¸ºäº†æé«˜æŸ¥æ‰¾çš„æ•ˆç‡ï¼Œç¨‹åºæ€»æ˜¯ä»é«˜å±‚å…ˆå¼€å§‹è®¿é—®ï¼Œç„¶åéšç€å…ƒç´ å€¼èŒƒå›´çš„ç¼©å°ï¼Œæ…¢æ…¢é™ä½å±‚æ¬¡ã€‚</li>
<li>è¡¨å°¾ï¼šå…¨éƒ¨ç”± NULL ç»„æˆï¼Œè¡¨ç¤ºè·³è·ƒè¡¨çš„æœ«å°¾ã€‚</li>
</ul>
<div class="details admonition warning open">
<div class="details-summary admonition-title">
<i class="icon fas fa-exclamation-triangle fa-fw"></i>æ³¨æ„<i class="details-icon fas fa-angle-right fa-fw"></i>
</div>
<div class=details-content>
<div class=admonition-content>å›¾ä¸­æ²¡æœ‰è¡¨ç¤ºå‡ºæ¥ <code>zskiplistNode.backward</code> æŒ‡é’ˆçš„æŒ‡å‘ï¼Œå®é™…ä¸Šå›¾ä¸­æ¯ä¸ªå…ƒç´ éƒ½ä¼šæŒ‡å‘å‰ä¸€ä¸ªå…ƒç´ </div>
</div>
</div>
<h4 id=323-æŸ¥è¯¢å…ƒç´ >3.2.3 æŸ¥è¯¢å…ƒç´ </h4>
<p>åœ¨è·³è·ƒè¡¨æŸ¥è¯¢å…ƒç´ ï¼Œæ€»æ˜¯ä» head çš„é¡¶å±‚ level å‘åå‘ä¸‹çš„æ–¹å¼å–æŸ¥è¯¢ï¼Œä»¥ä¸Šé¢çš„ç¤ºä¾‹å›¾ä¸ºä¾‹ï¼Œä¸‹é¢è®²è§£å¦‚ä½•æŸ¥è¯¢ score å€¼ä¸º <code>7</code> çš„å…ƒç´ :</p>
<p>åˆå§‹æ¡ä»¶ï¼š</p>
<ul>
<li>p ä¸ºåˆå§‹æŒ‡é’ˆï¼ŒæŒ‡å‘ head çš„é¡¶å±‚ level</li>
</ul>
<p>æŸ¥è¯¢æ­¥éª¤ï¼š</p>
<ol>
<li>
<p>åˆ¤æ–­æŒ‡é’ˆ p çš„ forward å…ƒç´ çš„å€¼ å½“æ»¡è¶³æ¡ä»¶ï¼šforward.score <code>&lt;</code> score <code>æˆ–</code> forward.score == score <code>&&</code> forward.ele <code>&lt;</code> targetEle æ—¶ï¼Œp å‘å‰ç§»åŠ¨ï¼Œlevel ä¸å˜</p>
</li>
<li>
<p>å½“ p çš„ forward ä¸º null æˆ–è€…forward å…ƒç´ çš„å€¼å¤§äº score æ—¶ï¼Œlevel å‡ä¸€ï¼Œä½†æ˜¯ p ä¸å¾€å‰ç§»åŠ¨</p>
</li>
<li>
<p>æ­¥éª¤ 1ï¼Œ2 ä¸€ç›´å¾ªç¯ï¼ŒæŒ‡åˆ° p ç§»åŠ¨åˆ° null æˆ–è€…ç§»åŠ¨åˆ°ç›®æ ‡å…ƒç´ ä¸ºæ­¢ã€‚</p>
</li>
</ol>
<figure><a class=lightgallery href=/posts/redis-server-zset/skiplist_find.png title=/posts/redis-server-zset/skiplist_find.png data-thumbnail=/posts/redis-server-zset/skiplist_find.png data-sub-html="<h2>è·³è·ƒè¡¨æŸ¥è¯¢å…ƒç´ è¿‡ç¨‹</h2>">
<img class=lazyload src=/svg/loading.min.svg data-src=skiplist_find.png data-srcset="/posts/redis-server-zset/skiplist_find.png, skiplist_find.png 1.5x, /posts/redis-server-zset/skiplist_find.png 2x" data-sizes=auto alt=/posts/redis-server-zset/skiplist_find.png width=800>
</a><figcaption class=image-caption>è·³è·ƒè¡¨æŸ¥è¯¢å…ƒç´ è¿‡ç¨‹</figcaption>
</figure>
<p>æºç ï¼š</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c>    <span class=cm>/* ä¸‹é¢å°±æ˜¯éå¸¸å¸¸è§„çš„ä¸€ä¸ªéå†æŸ¥æ‰¾è¿‡ç¨‹ */</span>
    <span class=n>x</span> <span class=o>=</span> <span class=n>zsl</span><span class=o>-&gt;</span><span class=n>header</span><span class=p>;</span>
    <span class=c1>// ä»head é¡¶å±‚levelå¼€å§‹å‘ä¸‹éå†
</span><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=n>zsl</span><span class=o>-&gt;</span><span class=n>level</span><span class=o>-</span><span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span><span class=o>--</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// æ¯ä¸€å±‚åˆ¤æ–­forwardå…ƒç´ ä¸ä¸ºç©ºçš„æ—¶å€™æ˜¯å¦ä¸ç›®æ ‡scoreå’Œele
</span><span class=c1></span>        <span class=k>while</span> <span class=p>(</span><span class=n>x</span><span class=o>-&gt;</span><span class=n>level</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>forward</span> <span class=o>&amp;&amp;</span>
                <span class=p>(</span><span class=n>x</span><span class=o>-&gt;</span><span class=n>level</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>forward</span><span class=o>-&gt;</span><span class=n>score</span> <span class=o>&lt;</span> <span class=n>curscore</span> <span class=o>||</span>
                    <span class=p>(</span><span class=n>x</span><span class=o>-&gt;</span><span class=n>level</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>forward</span><span class=o>-&gt;</span><span class=n>score</span> <span class=o>==</span> <span class=n>curscore</span> <span class=o>&amp;&amp;</span>
                    <span class=c1>// è¿™é‡Œçš„ sdccmp æ˜¯Rediså†…å®ç°çš„å¯¹å…¶ String ç»“æ„çš„å­—ç¬¦ä¸²è¿›è¡Œå¯¹æ¯”(å³å­—å…¸æ’åºçš„å¯¹æ¯”)
</span><span class=c1></span>                     <span class=n>sdscmp</span><span class=p>(</span><span class=n>x</span><span class=o>-&gt;</span><span class=n>level</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>forward</span><span class=o>-&gt;</span><span class=n>ele</span><span class=p>,</span><span class=n>ele</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)))</span>
        <span class=p>{</span>
            <span class=n>x</span> <span class=o>=</span> <span class=n>x</span><span class=o>-&gt;</span><span class=n>level</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>forward</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>ç„¶åå†çœŸæ­£å®ç° <code>zset</code> çš„æ—¶å€™ï¼Œä¸ä¼šæ ¹æ® value å€¼å»éå†æŸ¥è¯¢è·³è·ƒè¡¨, è€Œæ˜¯ç›´æ¥ä»å“ˆå¸Œè¡¨æŸ¥æ˜¯å¦å­˜åœ¨</p>
</blockquote>
<h4 id=324-æ·»åŠ å…ƒç´ >3.2.4 æ·»åŠ å…ƒç´ </h4>
<p>æ·»åŠ å…ƒç´ æ ¸å¿ƒæœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š</p>
<ul>
<li>æ‰¾åˆ°éœ€è¦æ’å…¥çš„ä½ç½®ï¼Œè¿™å—ç”¨ä¸Šä¸Šä¸€ä¸ªå°èŠ‚çš„æŸ¥è¯¢å…ƒç´ ç›¸å…³çŸ¥è¯†</li>
<li>åœ¨æŸ¥æ‰¾ä½ç½®çš„è¿‡ç¨‹ä¸­éœ€è¦è®°å½•ç‰µè¿åˆ°éœ€è¦æ›´æ–°çš„å…ƒç´ </li>
<li>å¦‚ä½•å¾—åˆ°æ–°å…ƒç´ çš„å±‚é«˜ï¼ŒçœŸçš„æ˜¯ <code>[0,32)</code> ä¹‹é—´éšæœºä¸€ä¸ªæ•°å˜›ï¼Ÿ</li>
<li>å¦‚æœæ–°å…ƒç´ çš„å±‚é«˜å¤§äºå½“å‰ skiplist çš„é«˜åº¦ï¼Œéœ€è¦åšå“ªäº›è°ƒæ•´å·¥ä½œï¼Ÿ</li>
</ul>
<p>å¯¹ä»¥ä¸Šå‡ ç‚¹æœ‰äº†æ˜ç¡®çš„è®¤çŸ¥å’Œå›ç­”åï¼Œäº†è§£æ’å…¥å…ƒç´ çš„è¿‡ç¨‹å°±å˜å¾—å¾ˆç®€å•ã€‚</p>
<p>æ·»åŠ å…ƒç´ è¿‡ç¨‹ï¼š</p>
<ol start=0>
<li>
<p>å®šä¹‰ä¸€ä¸ª <code>zskiplistNode *update[ZSKIPLIST_MAXLEVEL]</code> æ•°ç»„è®°å½•æ¯æ¬¡å˜æ›´ level æ—¶çš„èŠ‚ç‚¹ï¼ˆåæœŸæ›´æ–°å—å½±å“çš„èŠ‚ç‚¹ç”¨ï¼‰</p>
</li>
<li>
<p>å®šä¹‰ <code>unsigned int rank[ZSKIPLIST_MAXLEVEL]</code> æ•°ç»„è®°å½•ä¸¤æ¬¡å‘ä¸‹éå†çš„èŠ‚ç‚¹ç›´æ¥çš„è·¨åº¦</p>
</li>
<li>
<p>ä¸æŸ¥è¯¢å…ƒç´ ä¸€æ ·ï¼Œä» head çš„é¡¶å±‚å¼€å§‹å‘ä¸‹å‘å‰éå†ï¼Œæ‰¾åˆ°æ’å…¥çš„ä½ç½®ï¼Œè¿™ä¸ªä½ç½®æ»¡è¶³ score å€¼ä»‹äºå‰åçš„å…ƒç´ </p>
</li>
<li>
<p>åœ¨éå†çš„è¿‡ç¨‹ä¸­ï¼Œæ¯å¾€ä¸‹ç§»åŠ¨ä¸€æ¬¡(level - 1 )çš„æ—¶å€™è®°å½•å½“å‰å…ƒç´ update[cur_level] = cur_node</p>
</li>
<li>
<p>åœ¨éå†çš„è¿‡ç¨‹ä¸­ï¼Œæ¯å¾€å‰ç§»åŠ¨ä¸€æ¬¡(æ³¨ï¼šæ¯æ¬¡ç§»åŠ¨åªä¼šå•å‘ ä¸ä¼šåŒæ—¶å‘å‰å‘ä¸‹)çš„å‰è®°å½•åŒä¸€ä¸ª level å†…çš„è·¨åº¦
rank[cur_level] += cur_node.level[cur_level].span (è¿™é‡Œä¹‹æ‰€ä»¥ç´¯åŠ æ˜¯å› ä¸ºï¼ŒåŒä¸€ä¸ª level ä¸Šå¯èƒ½ä¼šå‘å‰ç§»åŠ¨ n æ¬¡ï¼Œå¦‚ä¸Šé¢ç¤ºä¾‹å›¾ä¸­çš„ä» 1 åˆ° 6 çš„è¿‡ç¨‹éƒ½æ˜¯åœ¨åŒä¸€ä¸ª level ä¸Šè¿›è¡Œçš„)</p>
</li>
</ol>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c>    <span class=c1>// å®šä¹‰å˜é‡
</span><span class=c1></span>    <span class=n>zskiplistNode</span> <span class=o>*</span><span class=n>update</span><span class=p>[</span><span class=n>ZSKIPLIST_MAXLEVEL</span><span class=p>],</span> <span class=o>*</span><span class=n>x</span><span class=p>;</span>
    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>rank</span><span class=p>[</span><span class=n>ZSKIPLIST_MAXLEVEL</span><span class=p>];</span>
    <span class=kt>int</span> <span class=n>i</span><span class=p>,</span> <span class=n>level</span><span class=p>;</span>

    <span class=c1>// ä» header å¼€å§‹éå†
</span><span class=c1></span>    <span class=n>x</span> <span class=o>=</span> <span class=n>zsl</span><span class=o>-&gt;</span><span class=n>header</span><span class=p>;</span>
    <span class=c1>// åˆå§‹ä½ç½® header çš„é¡¶å±‚ level
</span><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=n>zsl</span><span class=o>-&gt;</span><span class=n>level</span><span class=o>-</span><span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span><span class=o>--</span><span class=p>)</span> <span class=p>{</span>
        <span class=cm>/* store rank that is crossed to reach the insert position */</span>
        <span class=c1>// å¦‚æœå½“å‰level ä¸ºæœ€é«˜ä¸€å±‚çš„ level åˆ™ rank è®°å½• 0
</span><span class=c1></span>        <span class=n>rank</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>i</span> <span class=o>==</span> <span class=p>(</span><span class=n>zsl</span><span class=o>-&gt;</span><span class=n>level</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=o>?</span> <span class=mi>0</span> <span class=o>:</span> <span class=n>rank</span><span class=p>[</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>];</span>
        <span class=k>while</span> <span class=p>(</span><span class=n>x</span><span class=o>-&gt;</span><span class=n>level</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>forward</span> <span class=o>&amp;&amp;</span>
                <span class=p>(</span><span class=n>x</span><span class=o>-&gt;</span><span class=n>level</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>forward</span><span class=o>-&gt;</span><span class=n>score</span> <span class=o>&lt;</span> <span class=n>score</span> <span class=o>||</span>
                    <span class=p>(</span><span class=n>x</span><span class=o>-&gt;</span><span class=n>level</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>forward</span><span class=o>-&gt;</span><span class=n>score</span> <span class=o>==</span> <span class=n>score</span> <span class=o>&amp;&amp;</span>
                    <span class=n>sdscmp</span><span class=p>(</span><span class=n>x</span><span class=o>-&gt;</span><span class=n>level</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>forward</span><span class=o>-&gt;</span><span class=n>ele</span><span class=p>,</span><span class=n>ele</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)))</span>
        <span class=p>{</span>
            <span class=c1>// å‘å‰ç§»åŠ¨æ—¶è®°å½•å½“å‰ level ç§»åŠ¨çš„è·¨åº¦
</span><span class=c1></span>            <span class=n>rank</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>+=</span> <span class=n>x</span><span class=o>-&gt;</span><span class=n>level</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>span</span><span class=p>;</span>
            <span class=n>x</span> <span class=o>=</span> <span class=n>x</span><span class=o>-&gt;</span><span class=n>level</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>forward</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=c1>// level - 1  æ—¶ è®°å½•å½“å‰å…ƒç´ 
</span><span class=c1></span>        <span class=n>update</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>x</span><span class=p>;</span>
    <span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><ol start=5>
<li>
<p>éšæœºä¸€ä¸ª levelï¼Œ Redis æ˜¯æœ‰ä¸€å¥—ç®€å•çš„ç®—æ³•å»ç”Ÿæˆéšæœºçš„ level <a href=#3241-%e9%9a%8f%e6%9c%ba-level-%e7%ae%97%e6%b3%95 rel>è·³è½¬æŸ¥çœ‹</a>ã€‚</p>
</li>
<li>
<p>å¦‚æœéšæœºçš„ level å¤§äº skiplist å½“å‰æœ€é«˜ levelï¼Œåˆ™åœ¨ update æ•°ç»„è®°å½•ä»å½“å‰æœ€é«˜åˆ°æ–°çš„æœ€é«˜ä¹‹é—´çš„level å¯¹åº”çš„èŠ‚ç‚¹ä¸º head èŠ‚ç‚¹</p>
</li>
</ol>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c>    <span class=cm>/* we assume the element is not already inside, since we allow duplicated
</span><span class=cm>     * scores, reinserting the same element should never happen since the
</span><span class=cm>     * caller of zslInsert() should test in the hash table if the element is
</span><span class=cm>     * already inside or not. */</span>
    <span class=n>level</span> <span class=o>=</span> <span class=n>zslRandomLevel</span><span class=p>();</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>level</span> <span class=o>&gt;</span> <span class=n>zsl</span><span class=o>-&gt;</span><span class=n>level</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// åœ¨ zsl-&gt;level åˆ° level ä¹‹é—´åŒºåŸŸè¡¥ç¼ºåŸæ¥çš„ç©ºç¼º
</span><span class=c1></span>        <span class=c1>// åŸæ¥é«˜äº zsl-&gt;level çš„ level å‡æŒ‡å‘ nullï¼Œç°åœ¨éœ€è¦æŒ‡å‘åˆ°æ–°çš„å…ƒç´ å¯¹åº”çš„ level äº†
</span><span class=c1></span>        <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=n>zsl</span><span class=o>-&gt;</span><span class=n>level</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>level</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>rank</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=c1>// å› ä¸ºæœ€é«˜çš„ level äº†æ‰€ä»¥åœ¨è¯¥å±‚ä¸ä¼šæŒ‡å‘ä¸‹ä¸€ä¸ªå…ƒç´  æ‰€ä»¥å¯¹åº”çš„ rank == 0
</span><span class=c1></span>            <span class=n>update</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>zsl</span><span class=o>-&gt;</span><span class=n>header</span><span class=p>;</span> <span class=c1>// header éœ€è¦æ›´æ–°
</span><span class=c1></span>            <span class=n>update</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>-&gt;</span><span class=n>level</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>span</span> <span class=o>=</span> <span class=n>zsl</span><span class=o>-&gt;</span><span class=n>length</span><span class=p>;</span>  <span class=c1>// ä¸å†æŒ‡å‘ null æ‰€ä»¥ span ä¹Ÿéœ€è¦æ›´æ–°ï¼Œè¿™é‡Œå…ˆèµ‹å€¼ä¸ºæœ€è¿œè·ç¦» ä¸‹é¢ä¼šç»Ÿä¸€å¤„ç†
</span><span class=c1></span>        <span class=p>}</span>
        <span class=c1>// æ›´æ–°æ–°çš„ level
</span><span class=c1></span>        <span class=n>zsl</span><span class=o>-&gt;</span><span class=n>level</span> <span class=o>=</span> <span class=n>level</span><span class=p>;</span>
    <span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><ol start=7>
<li>æ’å…¥æ–°çš„å…ƒç´ ï¼Œæ›´æ–°åŸåˆ™çš„å‰åæŒ‡å‘æŒ‡é’ˆ</li>
</ol>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c>    <span class=c1>// åˆå§‹åŒ–æ–°çš„èŠ‚ç‚¹
</span><span class=c1></span>    <span class=n>x</span> <span class=o>=</span> <span class=n>zslCreateNode</span><span class=p>(</span><span class=n>level</span><span class=p>,</span><span class=n>score</span><span class=p>,</span><span class=n>ele</span><span class=p>);</span>
    <span class=c1>// ä»ä¸‹åˆ°ä¸Š ä¸€å±‚å±‚æ›´æ–°å®Œå–„å‰åèŠ‚ç‚¹ä»¥åŠç›¸å…³èŠ‚ç‚¹çš„å…³ç³»
</span><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>level</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// update æ•°ç»„ä¸€ä¸ªå…ƒç´ è®°å½•çš„æ˜¯ æ¯ä¸€å±‚æœ€é è¿‘ï¼ˆä»header åˆ° xï¼‰x çš„å…ƒç´ 
</span><span class=c1></span>        <span class=c1>// æ‰€ä»¥æ¯ä¸€å±‚æœ€é è¿‘ x çš„å…ƒç´ çš„ forward ç”±åŸæ¥çš„æŒ‡å‘æ”¹ä¸º x
</span><span class=c1></span>        <span class=c1>// åŒæ ·çš„ x æ¯ä¸€å±‚çš„ forward éƒ½æŒ‡å‘åŸæ¥æ¯ä¸€å±‚çš„æŒ‡å‘çš„å…ƒç´ 
</span><span class=c1></span>        <span class=c1>// å¥½æ¯”ä¸€ä¸ªå•å‘é“¾è¡¨ a -&gt; c, æ’å…¥ä¸€ä¸ª b åœ¨ä¸­é—´ï¼Œä» `a.next = c` å˜ä¸º `a.next, b.next = b, a.next`
</span><span class=c1></span>        <span class=n>x</span><span class=o>-&gt;</span><span class=n>level</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>forward</span> <span class=o>=</span> <span class=n>update</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>-&gt;</span><span class=n>level</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>forward</span><span class=p>;</span>
        <span class=n>update</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>-&gt;</span><span class=n>level</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>forward</span> <span class=o>=</span> <span class=n>x</span><span class=p>;</span>

        <span class=cm>/* update span covered by update[i] as x is inserted here */</span>
        <span class=c1>// è¿™é‡Œå¯èƒ½æ¯”è¾ƒç»•
</span><span class=c1></span>        <span class=c1>// span ä¸ºå½“å‰ä½ç½®åˆ°ä¸‹ä¸€ä¸ªå…ƒç´ ä¹‹é—´çš„è·ç¦»ï¼Œå› ä¸ºä¸åŒ level çš„å­˜åœ¨ï¼Œæ¯ä¸€å±‚çš„ span éƒ½ä¸ä¸€å®šç›¸åŒ
</span><span class=c1></span>        <span class=c1>// rank[0] ä¸ºä» header åˆ°å½“å‰æ–°å…ƒç´ ç½®ä½çš„æ€»çš„è·ç¦»
</span><span class=c1></span>        <span class=c1>// x æŸä¸€å±‚çš„ span ä¸ºå‰ä¸€ä¸ªåŒä¸€å±‚çš„å…ƒç´ çš„ span å‡å»  x ä¸å‰ä¸€ä¸ªåŒä¸€å±‚çš„è·ç¦»
</span><span class=c1></span>        <span class=n>x</span><span class=o>-&gt;</span><span class=n>level</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>span</span> <span class=o>=</span> <span class=n>update</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>-&gt;</span><span class=n>level</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>span</span> <span class=o>-</span> <span class=p>(</span><span class=n>rank</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>-</span> <span class=n>rank</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
        <span class=c1>// å‰ä¸€ä¸ªåŒä¸€å±‚çš„å…ƒç´ çš„æ–°çš„ span = ä»header åˆ°æ–°å…ƒç´ çš„è·ç¦»å‡å»ä» header åˆ°è¯¥å…ƒç´ çš„è·ç¦» + 1 ï¼ˆåŠ ä¸€æ˜¯å› ä¸ºæ–°å¢å…ƒç´ äº†ï¼‰
</span><span class=c1></span>        <span class=n>update</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>-&gt;</span><span class=n>level</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>span</span> <span class=o>=</span> <span class=p>(</span><span class=n>rank</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>-</span> <span class=n>rank</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
    <span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><ol start=8>
<li>å¦‚æœæ–°å…ƒç´ çš„é«˜åº¦æ²¡æœ‰æ¯” skiplist æœ€é«˜ level é«˜ï¼Œåˆ™åœ¨æ–°å…ƒç´ ä¹‹å‰çš„æ¯”å®ƒæ›´é«˜å…ƒç´ çš„ level çš„è·¨åº¦åŠ ä¸€</li>
</ol>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=cm>/* increment span for untouched levels */</span>
<span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=n>level</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>zsl</span><span class=o>-&gt;</span><span class=n>level</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>update</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>-&gt;</span><span class=n>level</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>span</span><span class=o>++</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><ol start=9>
<li>
<p>ä¿®æ”¹æ–°å…ƒç´ çš„ä¸‹ä¸€ä¸ªå…ƒç´ ï¼ˆå¦‚æœå­˜åœ¨ä¸‹ä¸€ä¸ªå…ƒç´ ï¼‰çš„ backward æŒ‡é’ˆï¼ŒæŒ‡å‘æ–°å…ƒç´ </p>
</li>
<li>
<p>è·³è·ƒè¡¨é•¿åº¦+1 å®Œæˆæ–°å¢å…ƒç´ </p>
</li>
</ol>
<p>é…åˆåŠ¨å›¾çœ‹æºç ï¼š</p>
<figure><a class=lightgallery href=/posts/redis-server-zset/skiplist_insert.gif title=/posts/redis-server-zset/skiplist_insert.gif data-thumbnail=/posts/redis-server-zset/skiplist_insert.gif data-sub-html="<h2>è·³è·ƒè¡¨æ’å…¥å…ƒç´ è¿‡ç¨‹</h2>">
<img class=lazyload src=/svg/loading.min.svg data-src=skiplist_insert.gif data-srcset="/posts/redis-server-zset/skiplist_insert.gif, skiplist_insert.gif 1.5x, /posts/redis-server-zset/skiplist_insert.gif 2x" data-sizes=auto alt=/posts/redis-server-zset/skiplist_insert.gif width=800>
</a><figcaption class=image-caption>è·³è·ƒè¡¨æ’å…¥å…ƒç´ è¿‡ç¨‹</figcaption>
</figure>
<h5 id=3241-éšæœº-level-ç®—æ³•>3.2.4.1 éšæœº level ç®—æ³•</h5>
<p>è·³è·ƒè¡¨ä½œä¸ºä¸€ä¸ªéšæœºåŒ–çš„æ•°æ®ç»“æ„ï¼Œæ¯ä¸€ä¸ªå…ƒç´ éƒ½æ˜¯æœ‰ä¸ä¸€æ ·é«˜çš„ levelï¼ŒæŸ¥è¯¢æ—¶é€šè¿‡è·³è·ƒ N ä¸ªå…ƒç´ çš„æ–¹å¼æé«˜æ€§èƒ½ã€‚åªè¦ç¡®ä¿ä¸åŒå…ƒç´ ç›´æ¥çš„ level æ˜¯æœ‰ä¸€å®šçš„å·®åˆ«æ‰èƒ½ä½“ç°å‡ºè·³è·ƒè¡¨çš„æ€§èƒ½ï¼Œå¦åˆ™å¾ˆå®¹æ˜“é€€åŒ–æˆé“¾è¡¨ç»“æ„äº†ã€‚</p>
<p>æ¯ä¸ª level çš„å…ƒç´ æ•°ä»ä¸Šåˆ°ä¸‹å‘ˆç°ç¬¬ L å±‚çš„å…ƒç´ æ•°ä¸º L-1çš„1/pï¼ˆå…¶ä¸­Redis ä¸­è¿™ä¸ª p = 4ï¼‰ã€‚é‚£ä¹ˆSkipListå¯ä»¥çœ‹æˆæ˜¯ä¸€æ£µå¹³è¡¡çš„På‰æ ‘ï¼Œä»æœ€é¡¶å±‚å¼€å§‹æŸ¥æ‰¾æŸä¸ªèŠ‚ç‚¹éœ€è¦çš„æ—¶é—´æ˜¯O(logpN)ã€‚æ¯ä¸ªè·³è·ƒè¡¨èŠ‚ç‚¹ä¸­çš„æŒ‡é’ˆæ•°ç»„ä¸­çš„æ¯ä¸€å±‚ï¼Œéƒ½æŒ‡å‘éšåä¸€ä¸ªæŒ‡é’ˆæ•°ç»„å¤§å°å¤§äºç­‰äºè¯¥èŠ‚ç‚¹æŒ‡é’ˆæ•°æ®å¤§å°çš„èŠ‚ç‚¹ã€‚</p>
<p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œå¦‚ä½•ç¡®ä¿æ¯æ¬¡éšæœºæ—¶ï¼Œè¶Šé«˜å±‚å‡ºç°æ¦‚ç‡è¶Šä½ è¶Šåº•å±‚å‡ºç°çš„æ¦‚ç‡è¶Šé«˜å‘¢ï¼Ÿ</p>
<p>å…ˆç»™å‡º Redis æºç ï¼š</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=cm>/* Returns a random level for the new skiplist node we are going to create.
</span><span class=cm> * The return value of this function is between 1 and ZSKIPLIST_MAXLEVEL
</span><span class=cm> * (both inclusive), with a powerlaw-alike distribution where higher
</span><span class=cm> * levels are less likely to be returned. */</span>
<span class=kt>int</span> <span class=nf>zslRandomLevel</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
    <span class=kt>int</span> <span class=n>level</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
    <span class=k>while</span> <span class=p>((</span><span class=n>random</span><span class=p>()</span><span class=o>&amp;</span><span class=mh>0xFFFF</span><span class=p>)</span> <span class=o>&lt;</span> <span class=p>(</span><span class=mf>0.25</span> <span class=o>*</span> <span class=mh>0xFFFF</span><span class=p>))</span>
        <span class=n>level</span> <span class=o>+=</span> <span class=mi>1</span><span class=p>;</span>
    <span class=k>return</span> <span class=p>(</span><span class=n>level</span><span class=o>&lt;</span><span class=mi>32</span><span class=p>)</span> <span class=o>?</span> <span class=nl>level</span> <span class=p>:</span> <span class=mi>32</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><div class="details admonition abstract open">
<div class="details-summary admonition-title">
<i class="icon fas fa-list-ul fa-fw"></i>è§£é‡Šä¸€ä¸‹è¿™é‡Œçš„ç®—æ³•<i class="details-icon fas fa-angle-right fa-fw"></i>
</div>
<div class=details-content>
<div class=admonition-content><p><code>ä»»æ„ä¸€ä¸ªæ•°</code> & <code>0xFFFF</code> å¾—åˆ°çš„ç»“æœåœ¨ [0~0xFFFF] èŒƒå›´å†…, ç»“æœå°äº <code>0.25 * 0xFFFF</code> çš„æ¦‚ç‡å°±æ˜¯ 1/4 .</p>
<p>æ ¹æ®æ¦‚ç‡è®ºå¯ä»¥å¾—å‡ºè¶Šé«˜çš„ level å‡ºç°ï¼ˆå³è¿ç»­å¤šæ¬¡å‡ºç°å°äº 0.25 * 0xFFFF æ‰èƒ½ç´¯åŠ åˆ°é«˜ levelï¼‰çš„æ¦‚ç‡è¶Šä½.
æ•°æ®å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th style=text-align:center>level</th>
<th style=text-align:center>æ¦‚ç‡</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:center>1</td>
<td style=text-align:center>3/4</td>
</tr>
<tr>
<td style=text-align:center>2</td>
<td style=text-align:center>3/4 * 1/4</td>
</tr>
<tr>
<td style=text-align:center>3</td>
<td style=text-align:center>3/4 * 1/4 * 1/4</td>
</tr>
<tr>
<td style=text-align:center>4</td>
<td style=text-align:center>3/4 * 1/4 * 1/4 * 1/4</td>
</tr>
<tr>
<td style=text-align:center>&mldr;</td>
<td style=text-align:center>&mldr;</td>
</tr>
<tr>
<td style=text-align:center>n</td>
<td style=text-align:center>$3/4 * (1/4)^{n-1}$</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<h4 id=325-åˆ é™¤å…ƒç´ >3.2.5 åˆ é™¤å…ƒç´ </h4>
<p>åˆ é™¤å…ƒç´ ç›¸å¯¹æ–°å¢å…ƒç´ æ¥è¯´ç®€å•ä¸€äº›ï¼Œä½†æ˜¯æ•´ä½“æ€è·¯è¿˜æ˜¯ä¸€æ ·çš„ã€‚éå†æ‰¾åˆ°åˆ é™¤çš„å…ƒç´ ï¼Œåœ¨éå†è¿‡ç¨‹ä¸­è®°å½•åˆ é™¤åéœ€è¦æ›´æ–°å±æ€§çš„å…ƒç´ ä»¥åŠ levelã€‚</p>
<ol>
<li>éå†å¹¶æ‰¾åˆ°éœ€è¦åˆ é™¤çš„ä½ç½®</li>
</ol>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=n>x</span> <span class=o>=</span> <span class=n>zsl</span><span class=o>-&gt;</span><span class=n>header</span><span class=p>;</span>
<span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=n>zsl</span><span class=o>-&gt;</span><span class=n>level</span><span class=o>-</span><span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span><span class=o>--</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>while</span> <span class=p>(</span><span class=n>x</span><span class=o>-&gt;</span><span class=n>level</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>forward</span> <span class=o>&amp;&amp;</span>
            <span class=p>(</span><span class=n>x</span><span class=o>-&gt;</span><span class=n>level</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>forward</span><span class=o>-&gt;</span><span class=n>score</span> <span class=o>&lt;</span> <span class=n>score</span> <span class=o>||</span>
                <span class=p>(</span><span class=n>x</span><span class=o>-&gt;</span><span class=n>level</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>forward</span><span class=o>-&gt;</span><span class=n>score</span> <span class=o>==</span> <span class=n>score</span> <span class=o>&amp;&amp;</span>
                    <span class=n>sdscmp</span><span class=p>(</span><span class=n>x</span><span class=o>-&gt;</span><span class=n>level</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>forward</span><span class=o>-&gt;</span><span class=n>ele</span><span class=p>,</span><span class=n>ele</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)))</span>
    <span class=p>{</span>
        <span class=n>x</span> <span class=o>=</span> <span class=n>x</span><span class=o>-&gt;</span><span class=n>level</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>forward</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=c1>// è®°å½•æ¯ä¸€å±‚éœ€è¦æ›´æ–°çš„å…ƒç´ 
</span><span class=c1></span>    <span class=n>update</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>x</span><span class=p>;</span>
<span class=p>}</span>
<span class=cm>/* We may have multiple elements with the same score, what we need
</span><span class=cm>* is to find the element with both the right score and object. */</span>
<span class=n>x</span> <span class=o>=</span> <span class=n>x</span><span class=o>-&gt;</span><span class=n>level</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>forward</span><span class=p>;</span>
<span class=c1>// ç¡®å®šå…ƒç´  åˆ é™¤
</span><span class=c1></span><span class=k>if</span> <span class=p>(</span><span class=n>x</span> <span class=o>&amp;&amp;</span> <span class=n>score</span> <span class=o>==</span> <span class=n>x</span><span class=o>-&gt;</span><span class=n>score</span> <span class=o>&amp;&amp;</span> <span class=n>sdscmp</span><span class=p>(</span><span class=n>x</span><span class=o>-&gt;</span><span class=n>ele</span><span class=p>,</span><span class=n>ele</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// åˆ é™¤æ–¹æ³•ï¼Œéœ€è¦ä¼ å…¥ update æ•°ç»„ æ–¹ä¾¿ åˆ é™¤å®Œæ›´æ–°æ¶‰åŠåˆ°çš„å…ƒç´ 
</span><span class=c1></span>    <span class=n>zslDeleteNode</span><span class=p>(</span><span class=n>zsl</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>update</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><ol start=2>
<li>æ›´æ–°è¢«åˆ å…ƒç´ å‰çš„æ¯ä¸€å±‚çš„ span</li>
</ol>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>zsl</span><span class=o>-&gt;</span><span class=n>level</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// å¦‚æœå½“å‰ level æŒ‡å‘ xï¼Œåˆ™æ–°çš„ span æ˜¯è‡ªå·±å½“å‰ span åŠ ä¸Š x çš„ span -1
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>update</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>-&gt;</span><span class=n>level</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>forward</span> <span class=o>==</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>update</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>-&gt;</span><span class=n>level</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>span</span> <span class=o>+=</span> <span class=n>x</span><span class=o>-&gt;</span><span class=n>level</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>span</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span>
        <span class=c1>// åŒæ—¶ä¿®æ”¹ forward æŒ‡é’ˆçš„æŒ‡å‘
</span><span class=c1></span>        <span class=n>update</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>-&gt;</span><span class=n>level</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>forward</span> <span class=o>=</span> <span class=n>x</span><span class=o>-&gt;</span><span class=n>level</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>forward</span><span class=p>;</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=c1>// å¦‚æœä¸æŒ‡å‘ x åˆ™ span -1 å³å¯
</span><span class=c1></span>        <span class=n>update</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>-&gt;</span><span class=n>level</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>span</span> <span class=o>-=</span> <span class=mi>1</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><ol start=3>
<li>ä¿®æ”¹è¢«åˆ é™¤å…ƒç´ çš„å‰çš„å…ƒç´ çš„å‘åæŒ‡é’ˆ</li>
</ol>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=k>if</span> <span class=p>(</span><span class=n>x</span><span class=o>-&gt;</span><span class=n>level</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>forward</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>x</span><span class=o>-&gt;</span><span class=n>level</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>forward</span><span class=o>-&gt;</span><span class=n>backward</span> <span class=o>=</span> <span class=n>x</span><span class=o>-&gt;</span><span class=n>backward</span><span class=p>;</span>
<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=n>zsl</span><span class=o>-&gt;</span><span class=n>tail</span> <span class=o>=</span> <span class=n>x</span><span class=o>-&gt;</span><span class=n>backward</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><ol start=4>
<li>
<p>åˆ¤æ–­è¢«åˆ é™¤å…ƒç´ æ˜¯ä¸æ˜¯æœ€é«˜ levelï¼Œå¦‚æœæ˜¯ level å‡åˆ°ç¬¬äºŒé«˜å…ƒç´ é«˜åº¦ä¸ºæ­¢</p>
</li>
<li>
<p>skiplist é•¿åº¦å‡ä¸€ï¼Œåˆ é™¤å®Œæˆã€‚</p>
</li>
</ol>
<h4 id=326-æ›´æ–°å…ƒç´ >3.2.6 æ›´æ–°å…ƒç´ </h4>
<p>ä¹‹æ‰€ä»¥æ›´æ–°å…ƒç´ æ”¾åˆ°æœ€åï¼Œæ˜¯å› ä¸ºæ›´æ–°å…ƒç´ æ²¡æœ‰å•ç‹¬çš„é€»è¾‘ï¼Œå®Œå…¨ä¾èµ–ä¸Šé¢çš„çŸ¥è¯†ç‚¹ã€‚</p>
<ol>
<li>
<p>æ‰¾åˆ°å…ƒç´ </p>
</li>
<li>
<p>åˆ é™¤å…ƒç´ </p>
</li>
<li>
<p>æ’å…¥å…ƒç´ </p>
</li>
</ol>
<p>è¿™å°±æ˜¯ Redis å†…å®ç°çš„é€»è¾‘ï¼Œç®€å•æ˜“æ‡‚ã€‚è™½ç„¶æ„Ÿè§‰å“ªé‡Œä¸å¯¹ï¼Œä½†æ˜¯å¥½åƒåˆæ²¡ä»€ä¹ˆæ¯›ç—…ã€‚</p>
<h2 id=4-zset-å®ç°>4 zset å®ç°</h2>
<p>ä¸Šé¢å…³äº<code>zset</code>çš„åŸç†å’Œå®ç°éƒ½ç†è§£çš„æ¯”è¾ƒé€å½»äº†ï¼Œå¦‚æœè¿˜æœ‰ä¸æ˜ç™½çš„å»ºè®®çœ‹æºç ï¼Œç»“åˆæºç ä¸Šä¸‹æ–‡æ›´å¥½ç†è§£ã€‚ç°åœ¨æˆ‘ç”¨ go è¯­è¨€å®ç°è·³è·ƒè¡¨ã€‚å…³äºå‹ç¼©è¡¨æˆ‘åœ¨è¿™é‡Œä¸ä¼šæ¶‰åŠåˆ°åªå®ç°è·³è·ƒè¡¨ç›¸å…³ä»£ç ã€‚</p>
<h3 id=41-æ•°æ®ç»“æ„å®šä¹‰>4.1 æ•°æ®ç»“æ„å®šä¹‰</h3>
<p>æ•°æ®ç»“æ„å®šä¹‰åŸºæœ¬ä¸ Redis ä¸€è‡´ï¼Œè·³è·ƒè¡¨ + map çš„ç»„åˆã€‚å…¶ä¸­ map éƒ¨åˆ†ä¸ºäº†æé«˜è¯»å†™æ€§èƒ½ï¼Œè‡ªå·±å®ç°äº†ä¸€ä¸ª map ç»“æ„ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// zSet is object contain skip list and map which store key-value pair
</span><span class=c1></span><span class=kd>type</span> <span class=nx>zSet</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=c1>// smap.Map ä¸ºè‡ªå·±å®ç°çš„åŸç”Ÿ map çš„å°è£…ï¼Œä¹‹åå•ç‹¬è®²ä¸€ä¸‹ï¼Œä¹‹æ‰€ä»¥è‡ªå·±å®ç°æ˜¯ä¸ºäº†æé«˜æ€§èƒ½
</span><span class=c1></span>    <span class=nx>m</span> <span class=nx>smap</span><span class=p>.</span><span class=nx>Map</span> <span class=c1>// store key and value
</span><span class=c1></span>    <span class=c1>// åœ¨å…ƒç´ å°‘äº 100 &amp; æ¯ä¸ªå…ƒç´ å¤§å°å°äº 64 çš„æ—¶å€™,Redis å®é™…ä¸Šç”¨çš„æ˜¯ zipList è¿™é‡Œä½œä¸ºçŸ¥è¯†ç‚¹æäº†ä¸€ä¸‹
</span><span class=c1></span>    <span class=c1>// é™¤éé‡åˆ°æ€§èƒ½é—®é¢˜,å¦åˆ™ä¸å‡†å¤‡åŒæ—¶æ”¯æŒ zipList å’Œ skipList
</span><span class=c1></span>    <span class=nx>zsl</span> <span class=o>*</span><span class=nx>zSkipList</span> <span class=c1>// skip list
</span><span class=c1></span><span class=p>}</span>

<span class=kd>type</span> <span class=nx>zSkipList</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>head</span><span class=p>,</span> <span class=nx>tail</span> <span class=o>*</span><span class=nx>zSkipListNode</span>
    <span class=nx>length</span>     <span class=kt>int</span> <span class=c1>// æ€»é•¿åº¦
</span><span class=c1></span>    <span class=nx>level</span>      <span class=kt>int</span> <span class=c1>// æœ€å¤§é«˜åº¦
</span><span class=c1></span><span class=p>}</span>

<span class=kd>type</span> <span class=nx>zSkipListNode</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>value</span>    <span class=kt>string</span>
    <span class=nx>score</span>    <span class=kt>float64</span>
    <span class=nx>backward</span> <span class=o>*</span><span class=nx>zSkipListNode</span>
    <span class=nx>levels</span>   <span class=p>[]</span><span class=o>*</span><span class=nx>zSkipListLeve</span>
<span class=p>}</span>

<span class=kd>type</span> <span class=nx>zSkipListLeve</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>forward</span> <span class=o>*</span><span class=nx>zSkipListNode</span>
    <span class=nx>span</span>    <span class=kt>uint</span> <span class=c1>// å½“å‰ level åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„è·¨åº¦
</span><span class=c1></span><span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=42-åˆå§‹åŒ–>4.2 åˆå§‹åŒ–</h3>
<p>å› ä¸ºå­˜åœ¨ä¸€ä¸ª header çš„è™šæ‹ŸèŠ‚ç‚¹ï¼Œæ‰€ä»¥åˆå§‹åŒ–çš„æ—¶å€™éœ€è¦æŠŠè·³è·ƒè¡¨çš„ header ä»¥åŠå…¶æ¯ä¸€å±‚éƒ½åˆå§‹åŒ–ã€‚</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// new skiplist
</span><span class=c1></span><span class=kd>func</span> <span class=nf>newZSkipList</span><span class=p>()</span> <span class=o>*</span><span class=nx>zSkipList</span> <span class=p>{</span>
    <span class=nx>zsl</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>zSkipList</span><span class=p>{</span>
        <span class=nx>level</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
        <span class=c1>// æ¯ä¸€å±‚ä¸ºç©ºçš„ ZSkipListMaxLevel å±‚çš„ head
</span><span class=c1></span>        <span class=nx>head</span><span class=p>:</span>  <span class=nf>newZslNode</span><span class=p>(</span><span class=nx>ZSkipListMaxLevel</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>),</span>
    <span class=p>}</span>

    <span class=k>return</span> <span class=nx>zsl</span>
<span class=p>}</span>

<span class=c1>// new node
</span><span class=c1></span><span class=kd>func</span> <span class=nf>newZslNode</span><span class=p>(</span><span class=nx>level</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>score</span> <span class=kt>float64</span><span class=p>,</span> <span class=nx>value</span> <span class=kt>string</span><span class=p>)</span> <span class=o>*</span><span class=nx>zSkipListNode</span> <span class=p>{</span>
    <span class=nx>node</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>zSkipListNode</span><span class=p>{</span>
        <span class=nx>value</span><span class=p>:</span>  <span class=nx>value</span><span class=p>,</span>
        <span class=nx>score</span><span class=p>:</span>  <span class=nx>score</span><span class=p>,</span>
        <span class=nx>levels</span><span class=p>:</span> <span class=nb>make</span><span class=p>([]</span><span class=o>*</span><span class=nx>zSkipListLeve</span><span class=p>,</span> <span class=nx>level</span><span class=p>),</span>
    <span class=p>}</span>

    <span class=c1>// åˆå§‹åŒ–æ¯ä¸€å±‚
</span><span class=c1></span>    <span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nx>level</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
        <span class=nx>node</span><span class=p>.</span><span class=nx>levels</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>zSkipListLeve</span><span class=p>{}</span>
    <span class=p>}</span>

    <span class=k>return</span> <span class=nx>node</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=43-å…¶ä»–åŠŸèƒ½>4.3 å…¶ä»–åŠŸèƒ½</h3>
<p>å¢åˆ æ”¹æŸ¥çš„ä»£ç ä¸ä¸Šé¢æºç è§£æçš„é€»è¾‘å¤§è‡´ç›¸åŒï¼Œæˆ‘åœ¨è¿™é‡Œç»™å‡ºgo è¯­è¨€å®ç°çš„æºç ï¼Œå¯ä»¥<a href=https://github.com/yusank/godis/blob/master/datastruct/sorted_set.go target=_blank rel="noopener noreffer">ç‚¹å‡»æŸ¥çœ‹</a>ã€‚åœ¨è¿™é‡Œä¸å†è®²è¿°è¿™äº›åŸºç¡€åŠŸèƒ½çš„å®ç°ï¼Œ
è€Œæ˜¯ç»™å‡ºä¸€äº›ç‰¹æ®Šçš„æ–¹æ³•çš„å®ç°ã€‚</p>
<h4 id=431-æ ¹æ®æ’åæŸ¥æ‰¾å…ƒç´ >4.3.1 æ ¹æ®æ’åæŸ¥æ‰¾å…ƒç´ </h4>
<p>åœ¨ä¸Šé¢çš„å®ç°é‡Œä¼šçœ‹åˆ°åˆ°å¤„é£çš„ span è¿™ä¸ªå±æ€§ï¼Œä½†æ˜¯å¥½åƒä¸€ç›´æ²¡æœ‰å®é™…ç”¨ä¸Šï¼Œå…¶å®åœ¨éå†è¿‡ç¨‹ä¸­å°¤å…¶æ˜¯è·Ÿæ’åç›¸å…³çš„æ“ä½œé‡Œè¿™ä¸ª span å±æ€§æ˜¯éå¸¸çš„æœ‰ç”¨ï¼Œä¸‹é¢çœ‹ä¸€ä¸‹å®é™…ç”¨å¤„ï¼š</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=p>(</span><span class=nx>zsl</span> <span class=o>*</span><span class=nx>zSkipList</span><span class=p>)</span> <span class=nf>findElementByRank</span><span class=p>(</span><span class=nx>rank</span> <span class=kt>uint</span><span class=p>)</span> <span class=o>*</span><span class=nx>zSkipListNode</span> <span class=p>{</span>
    <span class=kd>var</span> <span class=p>(</span>
        <span class=nx>x</span>         <span class=p>=</span> <span class=nx>zsl</span><span class=p>.</span><span class=nx>head</span>
        <span class=c1>// å·²éå†çš„è·ç¦»
</span><span class=c1></span>        <span class=nx>traversed</span> <span class=kt>uint</span>
    <span class=p>)</span>

    <span class=c1>// ä» head çš„é¡¶å±‚å¼€å§‹éå†
</span><span class=c1></span>    <span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=nx>zsl</span><span class=p>.</span><span class=nx>level</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span><span class=o>--</span> <span class=p>{</span>
        <span class=c1>// å¦‚æœå½“å‰level çš„ä¸‹ä¸€ä¸ªå…ƒç´ çš„è·ç¦» + å·²ç»èµ°è¿‡çš„è·ç¦» å°äº ç›®æ ‡æ’å -&gt; å‘å‰ç§»åŠ¨
</span><span class=c1></span>        <span class=c1>// å¦åˆ™ level - 1
</span><span class=c1></span>        <span class=k>for</span> <span class=nx>x</span><span class=p>.</span><span class=nx>levels</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>forward</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nx>traversed</span><span class=o>+</span><span class=nx>x</span><span class=p>.</span><span class=nx>levels</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>span</span> <span class=o>&lt;=</span> <span class=nx>rank</span> <span class=p>{</span>
            <span class=nx>traversed</span> <span class=o>+=</span> <span class=nx>x</span><span class=p>.</span><span class=nx>levels</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>span</span>
            <span class=nx>x</span> <span class=p>=</span> <span class=nx>x</span><span class=p>.</span><span class=nx>levels</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>forward</span>
        <span class=p>}</span>

        <span class=c1>// level -1 å‰åˆ¤æ–­æ˜¯å¦è¾¾åˆ°ç›®æ ‡ rank
</span><span class=c1></span>        <span class=k>if</span> <span class=nx>traversed</span> <span class=o>==</span> <span class=nx>rank</span> <span class=p>{</span>
            <span class=k>return</span> <span class=nx>x</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=k>return</span> <span class=kc>nil</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>å› ä¸ºè®°å½•äº†ä¸ä¸‹ä¸€ä¸ªå…ƒç´ çš„è·ç¦»ï¼Œæ ¹æ®æ’åæ‰¾å…ƒç´ å˜å¾—å¾ˆç®€å•é«˜æ•ˆï¼Œåªè¦è·³è·ƒå¯¹åº”çš„è·ç¦»å³å¯ï¼ˆè·ç¦»ä»£è¡¨çš„å°±æ˜¯è·¨è¶Šå¤šå°‘ä¸ªå…ƒç´ ä¹Ÿå°±æ˜¯å¤šå°‘ä¸ªæ’åä½ç½®ï¼‰</p>
<h4 id=432-zrange-å®ç°>4.3.2 zrange å®ç°</h4>
<p><code>zrange</code> è¿™ä¸ªå‘½ä»¤æ˜¯ä½¿ç”¨ <code>zset</code> æ—¶æœ€å¸¸ç”¨çš„å‘½ä»¤ä¹‹ä¸€, é‚£åº•å±‚æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=c1>// start stop æ”¯æŒè´Ÿæ•° è´Ÿæ•°æ—¶è¡¨ç¤ºå€’æ•°ç¬¬å‡ ä¸ª
</span><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>zsl</span> <span class=o>*</span><span class=nx>zSkipList</span><span class=p>)</span> <span class=nf>zRange</span><span class=p>(</span><span class=nx>start</span><span class=p>,</span> <span class=nx>stop</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>withScores</span> <span class=kt>bool</span><span class=p>)</span> <span class=p>[]</span><span class=kt>string</span> <span class=p>{</span>
    <span class=k>if</span> <span class=nx>start</span> <span class=p>&lt;</span> <span class=mi>0</span> <span class=p>{</span>
        <span class=nx>start</span> <span class=p>=</span> <span class=nx>start</span> <span class=o>+</span> <span class=nx>zsl</span><span class=p>.</span><span class=nx>length</span>
        <span class=k>if</span> <span class=nx>start</span> <span class=p>&lt;</span> <span class=mi>0</span> <span class=p>{</span>
            <span class=nx>start</span> <span class=p>=</span> <span class=mi>0</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=k>if</span> <span class=nx>stop</span> <span class=p>&lt;</span> <span class=mi>0</span> <span class=p>{</span>
        <span class=nx>stop</span> <span class=p>=</span> <span class=nx>stop</span> <span class=o>+</span> <span class=nx>zsl</span><span class=p>.</span><span class=nx>length</span>
    <span class=p>}</span>

    <span class=k>if</span> <span class=nx>start</span> <span class=p>&gt;</span> <span class=nx>stop</span> <span class=o>||</span> <span class=nx>start</span> <span class=o>&gt;=</span> <span class=nx>zsl</span><span class=p>.</span><span class=nx>length</span> <span class=p>{</span>
        <span class=k>return</span> <span class=kc>nil</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=nx>stop</span> <span class=o>&gt;=</span> <span class=nx>zsl</span><span class=p>.</span><span class=nx>length</span> <span class=p>{</span>
        <span class=nx>stop</span> <span class=p>=</span> <span class=nx>zsl</span><span class=p>.</span><span class=nx>length</span> <span class=o>-</span> <span class=mi>1</span>
    <span class=p>}</span>
    <span class=c1>// åˆ°ç›®å‰ä¸ºæ­¢æ˜¯ä¸ºäº†å¤„ç† start å’Œ stop è¶Šç•Œé—®é¢˜ï¼Œå¹¶æŠŠè´Ÿæ•°æ¢ç®—æˆæ­£æ•° æ–¹ä¾¿ä¸‹é¢å¤„ç†
</span><span class=c1></span>
    <span class=c1>// å…ˆç”¨ä¸Šé¢çš„æ–¹æ³•æ‰¾åˆ°éå†çš„ç¬¬ä¸€ä¸ªå…ƒç´ 
</span><span class=c1></span>    <span class=nx>node</span> <span class=o>:=</span> <span class=nx>zsl</span><span class=p>.</span><span class=nf>findElementByRank</span><span class=p>(</span><span class=nb>uint</span><span class=p>(</span><span class=nx>start</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
    <span class=kd>var</span> <span class=p>(</span>
        <span class=nx>rangeLen</span> <span class=p>=</span> <span class=nx>stop</span> <span class=o>-</span> <span class=nx>start</span> <span class=o>+</span> <span class=mi>1</span>
        <span class=nx>result</span>   <span class=p>[]</span><span class=kt>string</span>
    <span class=p>)</span>
    <span class=c1>// ä» start å…ƒç´ å¼€å§‹éå†
</span><span class=c1></span>    <span class=k>for</span> <span class=nx>rangeLen</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
        <span class=nx>result</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>result</span><span class=p>,</span> <span class=nx>node</span><span class=p>.</span><span class=nx>value</span><span class=p>)</span>
        <span class=k>if</span> <span class=nx>withScores</span> <span class=p>{</span>
            <span class=nx>result</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>result</span><span class=p>,</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>FormatFloat</span><span class=p>(</span><span class=nx>node</span><span class=p>.</span><span class=nx>score</span><span class=p>,</span> <span class=sc>&#39;g&#39;</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>64</span><span class=p>))</span>
        <span class=p>}</span>

        <span class=c1>// è·³è·ƒè¡¨çš„ç¬¬ 0 å±‚å¯ä»¥çœ‹åšåšæ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œè¿™æ ·éå†è¯»å–å¤šä¸ªå…ƒç´ å°±å¾ˆæ–¹ä¾¿äº†
</span><span class=c1></span>        <span class=nx>node</span> <span class=p>=</span> <span class=nx>node</span><span class=p>.</span><span class=nx>levels</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>forward</span>
        <span class=nx>rangeLen</span><span class=o>--</span>
    <span class=p>}</span>

    <span class=k>return</span> <span class=nx>result</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><div class="details admonition question open">
<div class="details-summary admonition-title">
<i class="icon fas fa-question-circle fa-fw"></i>å¦‚ä½•é€†å‘éå†<i class="details-icon fas fa-angle-right fa-fw"></i>
</div>
<div class=details-content>
<div class=admonition-content>å¦‚æœéœ€è¦é€†å‘éå† ç›´æ¥æŠŠ <code>node = node.levels[0].forward</code> æ”¹æˆ <code>node = node.levels[0].backward</code> å³å¯ã€‚</div>
</div>
</div>
<h2 id=5-æ€»ç»“>5 æ€»ç»“</h2>
<p>å†™åˆ°è¿™é‡Œï¼ŒRedis å¦‚ä½•å®ç° zset çš„åŸç†å’Œæºç ä»¥åŠå¦‚ä½•ç”¨ go è¯­è¨€è‡ªå·±å†™ä¸€ééƒ½è®²å®Œäº†ï¼Œä¸‹é¢åšä¸ªç®€å•çš„æ€»ç»“ã€‚</p>
<ul>
<li>zset åº•å±‚æ˜¯ä¸¤ç§æ•°æ®ç»“æ„ç»„æˆï¼ˆziplistï¼Œ skiplist + dictï¼‰ï¼Œæ ¹æ®å­˜å‚¨çš„æ•°æ®é‡ä¸åŒä»å†³å®šä½¿ç”¨å“ªä¸ª</li>
<li>è·³è·ƒè¡¨æ˜¯ä¸€ä¸ªæ ‘çŠ¶ç»“æ„ï¼Œè¯»å†™æ—¶é—´å¤æ‚åº¦ O(logN)</li>
<li>è·³è·ƒè¡¨çš„level æ˜¯éšæœºç®—æ³•ç®—å‡ºæ¥çš„ï¼Œç¡®ä¿æ¯ä¸€å±‚æ˜¯ä¸Šä¸€æ¬¡çš„ P å€ï¼Œlevel è¶Šä½æ•°æ®åˆ†å¸ƒè¶Šå¯†é›†</li>
<li>å¦‚æœå¯¹ Redis çš„æºç æˆ–è€…è·³è·ƒè¡¨æ¯”è¾ƒç†Ÿæ‚‰çš„è¯ï¼Œgo è¯­è¨€çš„å®ç°åŸºæœ¬æ²¡æœ‰ä»»ä½•éš¾åº¦ï¼Œæ˜¯æŠŠç†è§£è½¬æ¢æˆä»£ç è¿‡ç¨‹</li>
<li>å®ç°è¿‡ç¨‹éœ€è¦æ³¨æ„çš„æ˜¯ä¸€äº›ç‰¹æ®Šæƒ…å†µï¼ŒåŒ…æ‹¬è¾¹ç•Œé—®é¢˜ï¼Œhead å’Œ tail çš„é—®é¢˜ä»¥åŠæ“ä½œæŸä¸ªå…ƒç´ å…¶ç‰µè¿åˆ°çš„é™„è¿‘çš„å…ƒç´ </li>
</ul>
<h2 id=6-å‚è€ƒé“¾æ¥>6 å‚è€ƒé“¾æ¥ğŸ”—</h2>
<ul>
<li><a href=https://redisbook.readthedocs.io/en/latest/compress-datastruct/ziplist.html target=_blank rel="noopener noreffer">å‹ç¼©åˆ—è¡¨-ziplist</a></li>
<li><a href=https://redisbook.readthedocs.io/en/latest/internal-datastruct/skiplist.html target=_blank rel="noopener noreffer">è·³è·ƒè¡¨-skiplist</a></li>
<li><a href=https://github.com/yusank/godis target=_blank rel="noopener noreffer">go è¯­è¨€å®ç° Redis</a></li>
</ul></div><div class=post-footer id=post-footer>
<div class=post-info>
<div class=post-info-line>
<div class=post-info-mod>
<span>æ›´æ–°äº 2022-01-07</span>
</div>
<div class=post-info-license></div>
</div>
<div class=post-info-line>
<div class=post-info-md><span>
<a class=link-to-markdown href=/posts/redis-server-zset/index.md target=_blank>é˜…è¯»åŸå§‹æ–‡æ¡£</a>
</span></div>
<div class=post-info-share>
<span><a href=javascript:void(0); title="åˆ†äº«åˆ° Twitter" data-sharer=twitter data-url=https://yusank.github.io/posts/redis-server-zset/ data-title="[ç³»åˆ—]Redis Server å®ç°Â·æœ‰åºé›†åˆç¯‡" data-hashtags=redis,ç³»åˆ—ç¯‡,æ•°æ®ç»“æ„><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° Facebook" data-sharer=facebook data-url=https://yusank.github.io/posts/redis-server-zset/ data-hashtag=redis><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° Linkedin" data-sharer=linkedin data-url=https://yusank.github.io/posts/redis-server-zset/><i class="fab fa-linkedin fa-fw"></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° WhatsApp" data-sharer=whatsapp data-url=https://yusank.github.io/posts/redis-server-zset/ data-title="[ç³»åˆ—]Redis Server å®ç°Â·æœ‰åºé›†åˆç¯‡" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° Hacker News" data-sharer=hackernews data-url=https://yusank.github.io/posts/redis-server-zset/ data-title="[ç³»åˆ—]Redis Server å®ç°Â·æœ‰åºé›†åˆç¯‡"><i class="fab fa-hacker-news fa-fw"></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° Reddit" data-sharer=reddit data-url=https://yusank.github.io/posts/redis-server-zset/><i class="fab fa-reddit fa-fw"></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° Line" data-sharer=line data-url=https://yusank.github.io/posts/redis-server-zset/ data-title="[ç³»åˆ—]Redis Server å®ç°Â·æœ‰åºé›†åˆç¯‡"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/line.svg></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° å¾®åš" data-sharer=weibo data-url=https://yusank.github.io/posts/redis-server-zset/ data-title="[ç³»åˆ—]Redis Server å®ç°Â·æœ‰åºé›†åˆç¯‡" data-ralateuid=yusann><i class="fab fa-weibo fa-fw"></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° Myspace" data-sharer=myspace data-url=https://yusank.github.io/posts/redis-server-zset/ data-title="[ç³»åˆ—]Redis Server å®ç°Â·æœ‰åºé›†åˆç¯‡" data-description><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/myspace.svg></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° Blogger" data-sharer=blogger data-url=https://yusank.github.io/posts/redis-server-zset/ data-title="[ç³»åˆ—]Redis Server å®ç°Â·æœ‰åºé›†åˆç¯‡" data-description><i class="fab fa-blogger fa-fw"></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° ç™¾åº¦" data-sharer=baidu data-url=https://yusank.github.io/posts/redis-server-zset/ data-title="[ç³»åˆ—]Redis Server å®ç°Â·æœ‰åºé›†åˆç¯‡"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/baidu.svg></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° Evernote" data-sharer=evernote data-url=https://yusank.github.io/posts/redis-server-zset/ data-title="[ç³»åˆ—]Redis Server å®ç°Â·æœ‰åºé›†åˆç¯‡"><i class="fab fa-evernote fa-fw"></i></a></span>
</div>
</div>
</div>
<div class=post-info-more>
<section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/redis/>redis</a>,&nbsp;<a href=/tags/%E7%B3%BB%E5%88%97%E7%AF%87/>ç³»åˆ—ç¯‡</a>,&nbsp;<a href=/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/>æ•°æ®ç»“æ„</a></section>
<section>
<span><a href=javascript:void(0); onclick=window.history.back()>è¿”å›</a></span>&nbsp;|&nbsp;<span><a href=/>ä¸»é¡µ</a></span>
</section>
</div>
<div class=post-nav><a href=/posts/redeis-server-list/ class=prev rel=prev title="[ç³»åˆ—]Redis Server å®ç°Â·é“¾è¡¨ç¯‡"><i class="fas fa-angle-left fa-fw"></i>[ç³»åˆ—]Redis Server å®ç°Â·é“¾è¡¨ç¯‡</a>
<a href=/posts/shard-map/ class=next rel=next title="go è¯­è¨€ä¸­çš„åˆ†ç‰‡ map çš„å®ç°">go è¯­è¨€ä¸­çš„åˆ†ç‰‡ map çš„å®ç°<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id=comments><div id=utterances></div><noscript>
Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>Utterances</a>.
</noscript></div></article></div>
</main><footer class=footer>
<div class=footer-container><div class=footer-line>Keep learning and stay with lights.<br>â¤ yusank<br></div><div class=footer-line>ç”± <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.92.2">Hugo</a> å¼ºåŠ›é©±åŠ¨ | ä¸»é¢˜ - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
</div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2017 - 2022</span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by/4.0/deed.zh target=_blank>CC BY-NC 4.0</a></span></div>
</div>
</footer></div>
<div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=å›åˆ°é¡¶éƒ¨>
<i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=æŸ¥çœ‹è¯„è®º>
<i class="fas fa-comment fa-fw"></i>
</a>
</div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/copy-tex.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/typeit@7.0.4/dist/typeit.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"å¤åˆ¶åˆ°å‰ªè´´æ¿",maxShownLines:100},comment:{utterances:{darkTheme:"github-dark",issueTerm:"pathname",label:"Comment",lightTheme:"github-light",repo:"yusank/yusank.github.io"}},data:{"id-1":"usank`s Site","id-2":"usank`s Site"},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},typeit:{cursorChar:"|",cursorSpeed:1e3,data:{"id-1":["id-1"],"id-2":["id-2"]},duration:-1,speed:70}}</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-24P8ZSJHCQ',{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-24P8ZSJHCQ" async></script></body>
</html>