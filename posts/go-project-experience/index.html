<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>Go 项目开发和维护经验之谈 - Yusank`s Site</title><meta name=Description content="这是我的个人博客，我会在这里分享学习和成长过程中的积累和经验."><meta property="og:title" content="Go 项目开发和维护经验之谈"><meta property="og:description" content="
我想将自己的开发项目的经历以及过程中总结的经验或者一些小技巧整理出来，供自己和看到这篇文章的同学一个参考。内容包括但不限于，项目目录结构，模块拆分，单元测试，e2e 测试，git 的使用技巧，GitHub 的 actionflow 的使用技巧等。
"><meta property="og:type" content="article"><meta property="og:url" content="https://yusank.github.io/posts/go-project-experience/"><meta property="og:image" content="https://yusank.github.io/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-01-24T10:50:00+08:00"><meta property="article:modified_time" content="2022-02-15T16:16:46+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://yusank.github.io/logo.png"><meta name=twitter:title content="Go 项目开发和维护经验之谈"><meta name=twitter:description content="
我想将自己的开发项目的经历以及过程中总结的经验或者一些小技巧整理出来，供自己和看到这篇文章的同学一个参考。内容包括但不限于，项目目录结构，模块拆分，单元测试，e2e 测试，git 的使用技巧，GitHub 的 actionflow 的使用技巧等。
"><meta name=application-name content="Yusank's Site"><meta name=apple-mobile-web-app-title content="Yusank's Site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel=icon href=https://yusank.github.io/images/logo.svg><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://yusank.github.io/posts/go-project-experience/><link rel=prev href=https://yusank.github.io/posts/hpa-controller/><link rel=next href=https://yusank.github.io/posts/conn-pool/><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Go 项目开发和维护经验之谈","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/yusank.github.io\/posts\/go-project-experience\/"},"genre":"posts","keywords":"go, 开发, 维护","wordcount":8989,"url":"https:\/\/yusank.github.io\/posts\/go-project-experience\/","datePublished":"2022-01-24T10:50:00+08:00","dateModified":"2022-02-15T16:16:46+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Yusank"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Yusank`s Site"><img class="lazyload logo" src=/svg/loading.min.svg data-src=https://yusank.github.io/images/logo.svg data-srcset="https://yusank.github.io/images/logo.svg, https://yusank.github.io/images/logo.svg 1.5x, https://yusank.github.io/images/logo.svg 2x" data-sizes=auto alt=https://yusank.github.io/images/logo.svg title=https://yusank.github.io/images/logo.svg><span id=id-1 class=typeit></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/about/>关于 </a><a class=menu-item href=/links/>友链 </a><a class=menu-item href=https://github.com/yusank title=GitHub rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i> </a><a class=menu-item href=/goim title=GoIM><i class="far fa-share-square"></i> GoIM </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Yusank`s Site"><img class="lazyload logo" src=/svg/loading.min.svg data-src=https://yusank.github.io/images/logo.svg data-srcset="https://yusank.github.io/images/logo.svg, https://yusank.github.io/images/logo.svg 1.5x, https://yusank.github.io/images/logo.svg 2x" data-sizes=auto alt=https://yusank.github.io/images/logo.svg title=https://yusank.github.io/images/logo.svg><span id=id-2 class=typeit></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/about/ title>关于</a><a class=menu-item href=/links/ title>友链</a><a class=menu-item href=https://github.com/yusank title=GitHub rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i></a><a class=menu-item href=/goim title=GoIM><i class="far fa-share-square"></i>GoIM</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">Go 项目开发和维护经验之谈</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://github.com/yusank title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw"></i>Yusank</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/%E9%A1%B9%E7%9B%AE%E7%BB%8F%E9%AA%8C/><i class="far fa-folder fa-fw"></i>项目经验</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2022-01-24>2022-01-24</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 8989 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 18 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#1-前言>1. 前言</a></li><li><a href=#2-项目管理>2. 项目管理</a><ul><li><a href=#21-目录结构>2.1. 目录结构</a><ul><li><a href=#211-pkg-式目录>2.1.1. pkg 式目录</a></li><li><a href=#212-按功能分目录>2.1.2. 按功能分目录</a></li><li><a href=#213-裸跑型>2.1.3. 裸跑型</a></li><li><a href=#214-web-项目>2.1.4. web 项目</a></li></ul></li><li><a href=#22-模块拆分>2.2. 模块拆分</a><ul><li><a href=#221-拆分方法>2.2.1. 拆分方法</a></li><li><a href=#222-拆分模块>2.2.2. 拆分模块</a></li></ul></li><li><a href=#23-记录任务>2.3. 记录任务</a></li></ul></li><li><a href=#3-测试>3. 测试</a><ul><li><a href=#31-单元测试>3.1. 单元测试</a></li><li><a href=#32-e2e-测试>3.2. e2e 测试</a></li><li><a href=#33-压测>3.3. 压测</a><ul><li><a href=#331-函数的压测>3.3.1. 函数的压测</a></li><li><a href=#332-整体压测>3.3.2. 整体压测</a></li></ul></li></ul></li><li><a href=#4-代码规范>4. 代码规范</a></li><li><a href=#5-git>5. git</a><ul><li><a href=#51-git-hook>5.1. git hook</a></li><li><a href=#52-github--gitlab>5.2. github / gitlab</a></li></ul></li><li><a href=#6-构建与运行>6. 构建与运行</a><ul><li><a href=#61-makefile>6.1. makefile</a></li><li><a href=#62-dockerfile>6.2. dockerfile</a></li></ul></li><li><a href=#7-总结>7. 总结</a></li><li><a href=#8-链接>8. 链接🔗</a></li></ul></nav></div></div><div class=content id=content><blockquote><p>我想将自己的开发项目的经历以及过程中总结的经验或者一些小技巧整理出来，供自己和看到这篇文章的同学一个参考。内容包括但不限于，项目目录结构，模块拆分，单元测试，<code>e2e</code> 测试，<code>git</code> 的使用技巧，<code>GitHub</code> 的 <code>actionflow</code> 的使用技巧等。</p></blockquote><h2 id=1-前言>1. 前言</h2><p>做 go 开发有几年的时间了，从最开始的只会写一些简单的代码到现在除了日常编码外会考虑一个项目的前前后后(自认为考虑的比较全)，代码管理，项目结构以及相关的工具搭配使用，
走了很多的弯路，做了很多的重复工作，到目前为止积累了一些经验。想通过这篇文章输出一个总结，方便自己以及看到这篇文章的同学们之后在做新项目的时候有一定的启发。</p><div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw"></i>温馨提示<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>这篇文章可能存在一定的漏洞，如发现任何您认为不对的地方，希望能给我一个留言。</div></div></div><h2 id=2-项目管理>2. 项目管理</h2><p><strong>项目管理</strong> 这个模块我想分享一些，在开发过程中需要注意的或者值得学习的知识点，从而提升开发效率减少一些出错的概率，同时提高对项目的整体的理解。</p><h3 id=21-目录结构>2.1. 目录结构</h3><p>目录结构在一些语言会有很严格的要求，但是如果你看过的 go 项目比较多你会发现，大家分目录各有各的好处各有各的理由。所以这里并没有对错，我分享几个高分的开源项目以及自己在做一些 web 项目的时候经常用的目录结构，仁者见仁智者见智吧。</p><h4 id=211-pkg-式目录>2.1.1. pkg 式目录</h4><p>这类分目录在开源项目内十分常见，尤其是 k8s 以及相关组件的项目结构都是这类，下面看一下大概的目录结构。</p><p>以 <a href=https://keda.sh target=_blank rel="noopener noreffer">KEDA</a> 为例：</p><blockquote><p>其中一些目录为了尽量展示常见的目录手动补上的，实际项目中不一定存在。</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>➜ tree -L <span class=m>2</span>
</span></span><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>├── BUILD.md
</span></span><span class=line><span class=cl>├── CHANGELOG.md
</span></span><span class=line><span class=cl>├── CONTRIBUTING.md
</span></span><span class=line><span class=cl>├── CREATE-NEW-SCALER.md
</span></span><span class=line><span class=cl>├── LICENSE
</span></span><span class=line><span class=cl>├── Makefile
</span></span><span class=line><span class=cl>├── PROJECT
</span></span><span class=line><span class=cl>├── README.md
</span></span><span class=line><span class=cl>├── RELEASE-PROCESS.MD
</span></span><span class=line><span class=cl>├── SECURITY.md
</span></span><span class=line><span class=cl>├── api/ <span class=c1>## 公用的 proto api 或 全局结构定义，如 k8s 项目里 api 目录里放入所有资源对象的定义</span>
</span></span><span class=line><span class=cl>├── build/  <span class=c1>## 构建相关的脚本(Dockerfile)</span>
</span></span><span class=line><span class=cl>├── config/ <span class=c1>## 配置文件</span>
</span></span><span class=line><span class=cl>├── cmd/ <span class=c1>## 程序入口</span>
</span></span><span class=line><span class=cl>│   ├── controller <span class=c1>## 不同目录实现不同的功能</span>
</span></span><span class=line><span class=cl>│   └── admin
</span></span><span class=line><span class=cl>├── docs/ <span class=c1>## 生成的文档</span>
</span></span><span class=line><span class=cl>├── go.mod
</span></span><span class=line><span class=cl>├── go.sum
</span></span><span class=line><span class=cl>├── hack/ <span class=c1>## 代码生成相关工具和脚本</span>
</span></span><span class=line><span class=cl>├── pkg/ <span class=c1>## 该项目的功能代码</span>
</span></span><span class=line><span class=cl>│   ├── eventreason
</span></span><span class=line><span class=cl>│   ├── generated
</span></span><span class=line><span class=cl>│   ├── metrics
</span></span><span class=line><span class=cl>│   ├── mock
</span></span><span class=line><span class=cl>│   ├── provider
</span></span><span class=line><span class=cl>│   ├── scalers
</span></span><span class=line><span class=cl>│   ├── scaling
</span></span><span class=line><span class=cl>│   └── util
</span></span><span class=line><span class=cl>├── tests/ <span class=c1>## 测试数据或测试工具（并非测试代码在这里）</span>
</span></span><span class=line><span class=cl>├── tools/ <span class=c1>## 其他工具，如检查代码风格 统计代码量等</span>
</span></span><span class=line><span class=cl>└── third_party/ <span class=c1>## 第三方的protobuf 文件或无法通过 go mod 拉取的代码等</span>
</span></span></code></pre></td></tr></table></div></div><p>最大的特点是，所有的项目功能相关的代码都在 <code>pkg</code> 目录下根据功能拆分。<code>pkg</code> 之外的目录会放测试，文档，构建，发布，配置等内容。</p><p>其中 <code>cmd</code> 为程序的入口，根据功能会拆子目录，每个子目录下会有一个 <code>main</code> 文件，启动服务。</p><p>这个目录结构的项目一般都是体量比较大，测试构建发布过程都比较复杂，所以会有大量的脚本或者工具集来自动化这些复杂的过程。如果代码量比较少或者没有过多的依赖，则这种目录结构就体现不出优势。</p><h4 id=212-按功能分目录>2.1.2. 按功能分目录</h4><p>这种类型的目录结构，在各种框架类型的项目中十分常见，如 <code>go-micro</code>, <code>kratos</code> 等。</p><p>以 <a href=https://github.com/yusank/go-micro target=_blank rel="noopener noreffer">go-micro</a> 为例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>➜ tree -L <span class=m>1</span>
</span></span><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>├── LICENSE
</span></span><span class=line><span class=cl>├── README.md
</span></span><span class=line><span class=cl>├── api/ <span class=c1>## 接口定义</span>
</span></span><span class=line><span class=cl>├── auth/ <span class=c1>## 认证相关</span>
</span></span><span class=line><span class=cl>├── broker/ <span class=c1>## MQ 的 broker</span>
</span></span><span class=line><span class=cl>├── client/ <span class=c1>## http/rpc client</span>
</span></span><span class=line><span class=cl>├── cmd/ <span class=c1>## 项目相关工具 xxx-generator 等 或启动参数的处理</span>
</span></span><span class=line><span class=cl>├── codec/ <span class=c1>## 编码类型定义 json yaml pb 等</span>
</span></span><span class=line><span class=cl>├── config/ <span class=c1>## 配置</span>
</span></span><span class=line><span class=cl>├── debug/ <span class=c1>## debug</span>
</span></span><span class=line><span class=cl>├── errors/ <span class=c1>## 错误类型定义</span>
</span></span><span class=line><span class=cl>├── event.go
</span></span><span class=line><span class=cl>├── examples/ <span class=c1>## 各个模块的使用案例</span>
</span></span><span class=line><span class=cl>├── go.mod
</span></span><span class=line><span class=cl>├── go.sum
</span></span><span class=line><span class=cl>├── logger/ <span class=c1>## 日志模块的定义</span>
</span></span><span class=line><span class=cl>├── metadata/ <span class=c1>## 元数据</span>
</span></span><span class=line><span class=cl>├── micro.go <span class=c1>## 在这里提供对外的接口和方法</span>
</span></span><span class=line><span class=cl>├── options.go <span class=c1>## 各类可选参数定义</span>
</span></span><span class=line><span class=cl>├── plugins/ <span class=c1>## 插件 一般会在这里放起码模块定义的各种实现（如基于 etcd/nacos/consul 的服务发现等）</span>
</span></span><span class=line><span class=cl>├── registry/ <span class=c1>## 服务发现相关定义</span>
</span></span><span class=line><span class=cl>├── runtime/ <span class=c1>## 运行时相关代码</span>
</span></span><span class=line><span class=cl>├── selector/ <span class=c1>## 服务选择相关</span>
</span></span><span class=line><span class=cl>├── server/ <span class=c1>## 服务端相关定义</span>
</span></span><span class=line><span class=cl>├── service.go <span class=c1>## 服务启动相关</span>
</span></span><span class=line><span class=cl>├── service_test.go
</span></span><span class=line><span class=cl>├── store/ <span class=c1>## 存储相关</span>
</span></span><span class=line><span class=cl>├── sync/ <span class=c1>## 数据同步相关定义</span>
</span></span><span class=line><span class=cl>├── transport/ <span class=c1>## 网络转发相关 http/grpc</span>
</span></span><span class=line><span class=cl>└── util/ <span class=c1>## 其他工具类</span>
</span></span></code></pre></td></tr></table></div></div><p>这类目录最大的特点就是分目录分模块比较多且相互不影响。由于是框架，所以这种做法十分重要，别人引用的时候根据自己的需要选择引用其中的一部分目录。并且大部分目录都是定义接口 <code>Interface</code>, 并且在自己框架内都只会用接口，从而做到使用者可以自己实现并轻松替换调任意模块。作为一个框架的目录结构以及每个目录都定义接口的方式，可以说是非常的高明。这个项目可以说是对我的益处非常多，对于一个 1-3 年的程序员非常有必要好好研究一下这个项目。</p><h4 id=213-裸跑型>2.1.3. 裸跑型</h4><p>以 <code>gin</code> 为例，虽然也是一个框架，但是功能集中在根目录，大部分的能力都是 <code>gin.XXX</code> 的方式调用，所以这类项目基本不分目录，仅有一些测试和构建相关的几个目录，一般这么用的少之又少。当然你的项目很小，仅提供单个功能的时候不分目录也罢。</p><h4 id=214-web-项目>2.1.4. web 项目</h4><p>web 项目我之前接触的比较多，参加了无数个大大小小的 web 项目，经过无数次的折腾和吸取他人经验，有了比较统一的目录结构，希望能对在这方面有需求的同学有帮助。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>➜ tree
</span></span><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>├── Makefile <span class=c1>## 聚合各类常用命令</span>
</span></span><span class=line><span class=cl>├── app <span class=c1>## 程序入口</span>
</span></span><span class=line><span class=cl>│   ├── admin <span class=c1>## admin 端的入口（包含服务初始化，启动）</span>
</span></span><span class=line><span class=cl>│   └── server <span class=c1>## server 端（包含服务初始化 服务注册发现 监控等）如果使用任何框架，也在这里进行初始</span>
</span></span><span class=line><span class=cl>├── broker <span class=c1>## MQ 的注册和消费</span>
</span></span><span class=line><span class=cl>├── cmd <span class=c1>## 常用工具二进制文件，代码生成 文档生成等</span>
</span></span><span class=line><span class=cl>├── build <span class=c1>## 构建相关脚本</span>
</span></span><span class=line><span class=cl>├── config <span class=c1>## 配置的定义和初始化</span>
</span></span><span class=line><span class=cl>├── dao <span class=c1>## DAO 层，根据模块拆分，实现数据的增删改查</span>
</span></span><span class=line><span class=cl>│   ├── order
</span></span><span class=line><span class=cl>│   └── user
</span></span><span class=line><span class=cl>├── docs <span class=c1>## 文档生成目录</span>
</span></span><span class=line><span class=cl>├── dto <span class=c1>## 传输层数据定义</span>
</span></span><span class=line><span class=cl>├── middleware <span class=c1>## 中间件</span>
</span></span><span class=line><span class=cl>├── router <span class=c1>## router 为路由定义，这块目录结构比较深 但是我认为是有必要的 每一层占据路由上的一个位置</span>
</span></span><span class=line><span class=cl>│   ├── admin <span class=c1>## 第一层拆分开 admin 和 server 因为该项目最终构建两个程序 分别通过管理端和服务端内容</span>
</span></span><span class=line><span class=cl>│   │   ├── register.go <span class=c1>## 注册路由</span>
</span></span><span class=line><span class=cl>│   │   ├── v1 <span class=c1>## 一定要加版本号，在发生重大修改时提升版本号 不要直接改掉原有的路由（除非有安全隐患）</span>
</span></span><span class=line><span class=cl>│   │   │   ├── order <span class=c1>## 根据模块拆目录</span>
</span></span><span class=line><span class=cl>│   │   │   │   ├── manage <span class=c1>## 如果模块包含内容比较多 可以拆子目录</span>
</span></span><span class=line><span class=cl>│   │   │   │   │   └── manage.go <span class=c1>## 子目录下的路由 handler，可以包含多个 handler</span>
</span></span><span class=line><span class=cl>│   │   │   │   └── statistic
</span></span><span class=line><span class=cl>│   │   │   │       └── statistic.go <span class=c1>## 这一层的handler 的路由应该 /admin/v1/order/statistic/xxx</span>
</span></span><span class=line><span class=cl>│   │   │   ├── user <span class=c1>## 模块拆分</span>
</span></span><span class=line><span class=cl>│   │   │   │   └── user.go <span class=c1>## 如果包含内容不多可以直接放 handler 文件 /admin/v1/user/xxx</span>
</span></span><span class=line><span class=cl>│   │   │   └── v1.go <span class=c1>## 注册 v1 版本路由 同时注册这一层的 middleware</span>
</span></span><span class=line><span class=cl>│   │   └── v2 <span class=c1>## 与 v1 类似，服务重构或与原接口发生冲突 则升级版本</span>
</span></span><span class=line><span class=cl>│   │       ├── order
</span></span><span class=line><span class=cl>│   │       ├── share
</span></span><span class=line><span class=cl>│   │       ├── user
</span></span><span class=line><span class=cl>│   │       └── v2.go
</span></span><span class=line><span class=cl>│   └── server <span class=c1>## 服务端的路由注册 整体与 admin 端一致</span>
</span></span><span class=line><span class=cl>│       ├── register.go
</span></span><span class=line><span class=cl>│       ├── v1
</span></span><span class=line><span class=cl>│       │   ├── user
</span></span><span class=line><span class=cl>│       │   │   ├── action.go <span class=c1>## /server/v1/user/xxx</span>
</span></span><span class=line><span class=cl>│       │   │   └── manage
</span></span><span class=line><span class=cl>│       │   │       └── manage.go <span class=c1>## /server/v1/user/manage/xxx</span>
</span></span><span class=line><span class=cl>│       │   └── v1.go
</span></span><span class=line><span class=cl>│       └── v2
</span></span><span class=line><span class=cl>│           ├── order
</span></span><span class=line><span class=cl>│           ├── share
</span></span><span class=line><span class=cl>│           ├── user
</span></span><span class=line><span class=cl>│           └── v2.go
</span></span><span class=line><span class=cl>├── service <span class=c1>## service 内包含业务逻辑 衔接上层请求和下层数据的增删改查</span>
</span></span><span class=line><span class=cl>│   ├── order <span class=c1>## 按功能拆分目录</span>
</span></span><span class=line><span class=cl>│   │   ├── order_service.go <span class=c1>## 不同 dao 层方法的组合 甚至可以通过上下文传 session 的方式 支持不同dao 层方式之间的事务</span>
</span></span><span class=line><span class=cl>│   │   └── order_statistic_service.go
</span></span><span class=line><span class=cl>│   └── user
</span></span><span class=line><span class=cl>│       └── user_service.go
</span></span><span class=line><span class=cl>├── tests <span class=c1>## 测试相关工具和脚本</span>
</span></span><span class=line><span class=cl>├── logger <span class=c1>## 日志模块</span>
</span></span><span class=line><span class=cl>└── thrid_party <span class=c1>## 第三方的 protobuf 一般放这儿</span>
</span></span></code></pre></td></tr></table></div></div><p>整体思路是从上到下的一个结构，一个请求的处理过程为 <code>router</code> -> <code>service</code> -> <code>dao</code>。其中 <code>middleware</code> 会出现在 handler 的前后，而 <code>broker</code> 出现 <code>service</code> 层。对于一个承接业务的服务，这个目录结构不算出色不算很完善，但是实用性上来说还是可以的，功能和业务模块拆分的比较明确，在各个目录的的 <code>logger</code> 添加目录和功能，大部分问题可以快速定位。</p><p>至于为什么会同时有 <code>admin</code> 和 <code>server</code> 端，是因为公用代码和数据结构，大部分线上服务是需要背后一套管理端的，如果重新起一个新的项目，那肯定会因为数据结构或者代码逻辑的不及时同时出现问题，这种放在一套代码内编译出两个程序是保守且比较可靠的方式。</p><p><code>router</code> 部分，如果你的接口比较少的情况下，体会不出来优势。但是如果接口和模块比较多的情况下这种结构是很明智的选择:</p><ul><li>每个模块几乎都有子模块（比如订单逻辑分 订单的统计，管理，追踪等）且接口比较多，那我可以拆子目录来分别管理和实现</li><li>不同模块有不同的中间件（用户需要校验登录状态，订单需要验证 id，管理端需鉴权），那可以在不同层级添加对应的中间件</li></ul><blockquote><p>当然这一切都是我个人的一些经验总结，不一定适合你，但是找到一个比较合理且适合自己的才是最重要的，可以互相借鉴嘛！</p></blockquote><h3 id=22-模块拆分>2.2. 模块拆分</h3><p>这个就没什么可说的，单独提出来是为了提醒自己和各位，能拆分尽量拆分，不要一个文件上千行代码，一个方法几百行代码，别人看的时候真的很痛苦。</p><h4 id=221-拆分方法>2.2.1. 拆分方法</h4><p>这个比较好拆，唯一的原则就是<code>一个方法只做一件事儿</code>。这个一件事儿可大可小，这是基于当前这个方法所在的层级而定。
如果处于底层操作数据库的层级，那你的方法应该只进行一个数据库操作（不管增删改查），各种组合或者事务应该上层去做。
如果你在业务逻辑层，那你的方法应该只处理一个简单的业务。比如需要下单后发送给用户一个邮件，那你应该拆开下单和发送邮件的方法，不要揉在一起，让上层去组合处理，因为你很有可能添加短信通知/公众号处理。如果揉在一起，需要加新的通知方式的时候你还得去修改完全没有发生变化 <code>OrderAndSendMessage</code> 这个方法（随便起了个名字），很有可能会影响到 <code>Order</code> 的过程。</p><p>总而言之，一个方法只做一件事儿，不要让一个不相干的修改影响到你的逻辑。</p><h4 id=222-拆分模块>2.2.2. 拆分模块</h4><p>这块的话，我觉得重点是逻辑不要掺杂在一起，不同的逻辑尽量抽象出来。dao 层就做数据相关的（MySQL，Redis）不要掺杂逻辑，service 就做业务逻辑的组合，不要在 service 层直接操作底层组件。总结起来就是不要越界，上下不要越级（service -> dao），左右不要越界（用户相关逻辑不要掺杂订单的逻辑，即便是用户信息内需要包含用户的订单总金额，也要在订单模块实现查询方法去调而不是自己去实现，否则以后拆分很痛苦）。我觉得不同的功能之间相互认为是个微服务，不要有底层的依赖，不要认为代码在一个项目内就随便调用，业务升级业务拆分的时候真的非常痛苦（血的教训）。</p><h3 id=23-记录任务>2.3. 记录任务</h3><p>这块的话，我觉得是一个工具推荐了算是。不管是个人开发或者团队开发，有个任务记录和里程碑是很重要的一点。不管是 GitHub 还是 Gitlab 都有 <code>issue</code> 和 <code>milestone</code> 的功能，对于一个开发者来说个人觉得非常的好用。</p><p><code>issue</code> 你可以记录你要实现的功能、你现在出现的问题、QA 同学给你提的 bug，你每解决一个问题，每实现一个新功能在 git commit 上带上 issue 号就可以关联上。不管是之后定位问题还是查看某个功能的相关的提交都非常清晰，收益很多。</p><p><code>milestone</code> 也是非常好用的功能，针对你的一个大功能或者一个新的版本创建一个 milestone 并加上截止日志，之后所有跟这个版本相关的 issue 都可以挂上这个里程碑，当你一个个完成的相关 issue 后，里程碑的完成度逐渐上升，记录了你的开发进度，同时提醒/监督自己。</p><p>不管你做的项目是大是小，都应该有个开发计划并在开发前做好准备，不要盲目上手，着急上手只会让你越做越累，而且做不好。都没有计划和开发过程的记录，怎么证明项目的质量，后期怎么维护，出现问题怎么定位。</p><h2 id=3-测试>3. 测试</h2><p>到这里就开始聊代码相关的了。测试是考验你代码的质量和功能的一把好刀，你应该习惯并熟悉写测试代码，并且尽可能包含你代码的所有部分，确保你的项目整体都是经得起推敲的。</p><p>我常用的代码测试有以下三种：</p><ul><li>单元测试 - 测试你的方法在功能上没有问题</li><li>e2e 测试 - end to end 你的一个完整的功能没有问题，比如测试某个接口是否返回预期结果</li><li>压测 - 测试你的某个方法或者整个系统是否存在性能问题</li></ul><p>压测可以在发布新的版本或分支合并的时候跑一下 通过基准线即可。单元测试和e2e 测试应该在每次提交的时候本地或者远端跑一次，确保任意一次的提交都是可用的。</p><h3 id=31-单元测试>3.1. 单元测试</h3><p>单元测试作为最基础的测试方法，应该在你的项目内尽可能覆盖大部分的方法，但是需要注意以下几点</p><ul><li>任意一个单元测试应该都是独立，不能有依赖</li><li>任意一个单元测试执行前后不应该对数据有影响，如果这个单元测试需要修改数据库数据或文件，应该在测试结束后恢复发生变化的数据</li><li>不应该长时间阻塞，不应该有 <code>select{}</code> 或死循环，等待手动停止的情况</li></ul><p>最简单的单元测试示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Test_ParseInt</span><span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>testing</span><span class=p>.</span><span class=nx>T</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>input</span> <span class=p>=</span> <span class=s>&#34;12&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nx>output</span> <span class=kt>int64</span> <span class=p>=</span><span class=mi>12</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>v</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>ParseInt</span><span class=p>(</span><span class=s>&#34;12&#34;</span><span class=p>,</span> <span class=mi>10</span><span class=p>,</span> <span class=mi>64</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>t</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>v</span> <span class=o>!=</span> <span class=nx>output</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>t</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;want:%v, got:%v\n&#34;</span><span class=p>,</span> <span class=nx>output</span><span class=p>,</span> <span class=nx>v</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>t</span><span class=p>.</span><span class=nf>Log</span><span class=p>(</span><span class=s>&#34;ok&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这是一个校验 <code>strconv.ParseInt</code> 方法的单元测试，可以直接运行。从上面的代码来说，有些啰嗦，而且错误信息的输出也得自己写，这里推荐比较流行的测试框架
<code>github.com/stretchr/testify/assert</code>,该库对错误信息的格式化和遍历对比都毕竟成熟，而且提供很多方法，来简化你的测试代码量，下面看一下改版：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Test_ParseInt</span><span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>testing</span><span class=p>.</span><span class=nx>T</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>v</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>ParseInt</span><span class=p>(</span><span class=s>&#34;12&#34;</span><span class=p>,</span> <span class=mi>10</span><span class=p>,</span> <span class=mi>64</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 如果有错误 这里会返回 false
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>!</span><span class=nx>assert</span><span class=p>.</span><span class=nf>NoError</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Equal 方法支持对比所有的类型，不需要根据类型判断
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 并且报错时，日志信息也非常丰富
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>assert</span><span class=p>.</span><span class=nf>Equal</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=nb>int64</span><span class=p>(</span><span class=mi>12</span><span class=p>),</span> <span class=nx>v</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里我不会细讲这个库，如果看过比较主流的开源库，有很多库都使用这个测试框架，非常值得学习和使用。</p><p>一般来说，测试一个方法不止一个情况，大部分情况下会有多个各种输入，多方面来确保方法的可用性，这种情况下，可以采用下面的写法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Test_zSkipList_rank</span><span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>testing</span><span class=p>.</span><span class=nx>T</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>type</span> <span class=nx>args</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>score</span> <span class=kt>float64</span>
</span></span><span class=line><span class=cl>        <span class=nx>value</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>tests</span> <span class=o>:=</span> <span class=p>[]</span><span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>name</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>        <span class=nx>args</span> <span class=nx>args</span>
</span></span><span class=line><span class=cl>        <span class=nx>want</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl>    <span class=p>}{</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>name</span><span class=p>:</span> <span class=s>&#34;c&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>args</span><span class=p>:</span> <span class=nx>args</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>score</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>value</span><span class=p>:</span> <span class=s>&#34;clang&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=nx>want</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>name</span><span class=p>:</span> <span class=s>&#34;java&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>args</span><span class=p>:</span> <span class=nx>args</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>score</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>value</span><span class=p>:</span> <span class=s>&#34;java&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=nx>want</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>name</span><span class=p>:</span> <span class=s>&#34;w&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>args</span><span class=p>:</span> <span class=nx>args</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>score</span><span class=p>:</span> <span class=mi>5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>value</span><span class=p>:</span> <span class=s>&#34;world&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=nx>want</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>name</span><span class=p>:</span> <span class=s>&#34;js&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>args</span><span class=p>:</span> <span class=nx>args</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>score</span><span class=p>:</span> <span class=mi>8</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>value</span><span class=p>:</span> <span class=s>&#34;javascript&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=nx>want</span><span class=p>:</span> <span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>name</span><span class=p>:</span> <span class=s>&#34;h&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>args</span><span class=p>:</span> <span class=nx>args</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>score</span><span class=p>:</span> <span class=mi>10</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>value</span><span class=p>:</span> <span class=s>&#34;hello&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=nx>want</span><span class=p>:</span> <span class=mi>5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>name</span><span class=p>:</span> <span class=s>&#34;go&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>args</span><span class=p>:</span> <span class=nx>args</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>score</span><span class=p>:</span> <span class=mi>12</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>value</span><span class=p>:</span> <span class=s>&#34;golang&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=nx>want</span><span class=p>:</span> <span class=mi>6</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>zs</span> <span class=o>:=</span> <span class=nf>prepareZSetForTest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>zs</span><span class=p>.</span><span class=nx>zsl</span><span class=p>.</span><span class=nb>print</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>tt</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>tests</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>t</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=nx>tt</span><span class=p>.</span><span class=nx>name</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>testing</span><span class=p>.</span><span class=nx>T</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>got</span> <span class=o>:=</span> <span class=nx>zs</span><span class=p>.</span><span class=nx>zsl</span><span class=p>.</span><span class=nf>rank</span><span class=p>(</span><span class=nx>tt</span><span class=p>.</span><span class=nx>args</span><span class=p>.</span><span class=nx>score</span><span class=p>,</span> <span class=nx>tt</span><span class=p>.</span><span class=nx>args</span><span class=p>.</span><span class=nx>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nx>assert</span><span class=p>.</span><span class=nf>Equal</span><span class=p>(</span><span class=nx>t</span><span class=p>,</span> <span class=nx>tt</span><span class=p>.</span><span class=nx>want</span><span class=p>,</span> <span class=nb>int</span><span class=p>(</span><span class=nx>got</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里我直接从我的现成的代码里复制出来一个测试案例，这种写法特点是定义好输入输出的结构，然后批量赋值，最终一个个执行。
如果测试过程中发现，输入的数据还不够，可以随时增加n个例子，其他部分不用动，<em>重要的是，可以在 GoLand idea 中执行任意一个测试数据，更加方便调试</em>。</p><h3 id=32-e2e-测试>3.2. e2e 测试</h3><p>e2e 测试，相对于单元测试来说更加系统性测试，针对某个模块的整体功能的校验。没有一个必要的代码框架，代码量也会更多一些。比如测试用户注册流程的测试，那启动时需要准备该功能需要的环境（启动或者链接测试数据库，创建表或者创建测试数据等），调用对用的方法后，对结果进行校验，校验成功后需要删除测试用的数据和环境。</p><p>对于web项目，可能针对接口也需要写测试，这个时候就需要启动当前的服务，准备环境，进行接口调用，完成后恢复涉及到的变更。</p><p>e2e 测试更多关注当前程序的整体的功能，可以确保任意的代码改动没有对当前程序的整体能力（或核心功能）没有带来负面影响，所以e2e测试也是非常重要的。</p><h3 id=33-压测>3.3. 压测</h3><p>压测(Benchmark) 不同于上述两个测试，关注的是函数或程序整体的性能情况。</p><h4 id=331-函数的压测>3.3.1. 函数的压测</h4><p>这块可以通过 go 的原生能力进行测试，写压测方法也很简单，如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>goos: darwin
</span></span></span><span class=line><span class=cl><span class=cm>goarch: amd64
</span></span></span><span class=line><span class=cl><span class=cm>pkg: github.com/yusank/godis/util
</span></span></span><span class=line><span class=cl><span class=cm>cpu: Intel(R) Core(TM) i7-9750H CPU @ 2.60GHz
</span></span></span><span class=line><span class=cl><span class=cm>BenchmarkStringConcat
</span></span></span><span class=line><span class=cl><span class=cm>BenchmarkStringConcat-12    14886952        70.91 ns/op
</span></span></span><span class=line><span class=cl><span class=cm>PASS
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>BenchmarkStringConcat</span><span class=p>(</span><span class=nx>b</span> <span class=o>*</span><span class=nx>testing</span><span class=p>.</span><span class=nx>B</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>slice</span> <span class=p>=</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;$&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;10&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;\r\n&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;12345123456&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;\r\n&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nx>b</span><span class=p>.</span><span class=nx>N</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>StringConcat</span><span class=p>(</span><span class=mi>16</span><span class=p>,</span> <span class=nx>slice</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这是go 提供的压测函数的写法，执行后，输出上面代码中的注释部分，可以看到当前机器的信息和执行次数以及每次执行时需要的时间。通过这种方法，可以针对我们的一些高频率调用的方法进行压测，确保这些方法不是性能的瓶颈，并且遇到瓶颈或者优化时，通过压测的方式，对比优化前后的差异。</p><h4 id=332-整体压测>3.3.2. 整体压测</h4><p>在GitHub上有很多项目，尤其是对性能要求高的项目都会有一个性能对比的图，对自己项目进行一个压测，对程序整体的吞吐进行全方面的压测，从而体现出该程序的高性能和稳定性。
这个其实对于tcp或者web服务来说非常好做，而且有很多现成的工具，可进行压测并输出结果。</p><p>以 <code>wrk</code> 为例，支持指定客户端数，并发数，请求次数等，甚至支持脚本执行，定制化压测，这里贴出<a href=https://www.jianshu.com/p/ac185e01cc30 target=_blank rel="noopener noreffer">链接</a>,希望看到这里的同学，花几分钟去了解一下如何使用。</p><h2 id=4-代码规范>4. 代码规范</h2><p>代码规范这块我之前写过专门的文章(<a href=../go-standard/ rel>点击传送</a>)。但是实际开发过程中不能保证所有人（包括自己）都能完成的遵循代码规范的，所以需要一个自动化工具来校验/限制不规范的代码。</p><p><strong><a href=https://github.com/golangci/golangci-lint target=_blank rel="noopener noreffer">golangci-lint</a></strong> 是一个绝大多数 go 开发者都熟悉的一个工具，可以校验任何 go 项目的代码规范，能够指出不规范的部分，并且支持指定开启/关闭部分类型的校验。下面从一个简单的例子说明如何使用。</p><p>这是我在某个 main 方法里加了一些不规范的语法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>var</span> <span class=nx>abc</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>        
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>t</span> <span class=p>=</span> <span class=mi>0</span> <span class=o>==</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>t</span> <span class=o>==</span> <span class=kc>true</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// do
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>core</span><span class=p>.</span><span class=nf>Service</span><span class=p>(</span><span class=s>&#34;:8081&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>执行 <code>golangci-lint</code> 看一下结果：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>➜ golangci-lint run ./... -v
</span></span><span class=line><span class=cl>INFO <span class=o>[</span>config_reader<span class=o>]</span> Config search paths: <span class=o>[</span>./ /Users/shan.yu/workspace/yusank/klyn-examp /Users/shan.yu/workspace/yusank /Users/shan.yu/workspace /Users/shan.yu /Users /<span class=o>]</span> 
</span></span><span class=line><span class=cl>INFO <span class=o>[</span>lintersdb<span class=o>]</span> Active <span class=m>10</span> linters: <span class=o>[</span>deadcode errcheck gosimple govet ineffassign staticcheck structcheck typecheck unused varcheck<span class=o>]</span> 
</span></span><span class=line><span class=cl>INFO <span class=o>[</span>loader<span class=o>]</span> Go packages loading at mode <span class=m>575</span> <span class=o>(</span>deps<span class=p>|</span>types_sizes<span class=p>|</span>compiled_files<span class=p>|</span>exports_file<span class=p>|</span>files<span class=p>|</span>imports<span class=p>|</span>name<span class=o>)</span> took 429.72546ms 
</span></span><span class=line><span class=cl>INFO <span class=o>[</span>runner/filename_unadjuster<span class=o>]</span> Pre-built <span class=m>0</span> adjustments in 3.196848ms 
</span></span><span class=line><span class=cl>INFO <span class=o>[</span>linters context/goanalysis<span class=o>]</span> analyzers took 0s with no stages 
</span></span><span class=line><span class=cl>INFO <span class=o>[</span>runner<span class=o>]</span> Issues before processing: 7, after processing: <span class=m>4</span> 
</span></span><span class=line><span class=cl>INFO <span class=o>[</span>runner<span class=o>]</span> Processors filtering stat <span class=o>(</span>out/in<span class=o>)</span>: skip_dirs: 7/7, exclude: 7/7, uniq_by_line: 4/7, max_per_file_from_linter: 4/4, cgo: 7/7, filename_unadjuster: 7/7, source_code: 4/4, severity-rules: 4/4, skip_files: 7/7, max_from_linter: 4/4, nolint: 7/7, diff: 4/4, max_same_issues: 4/4, path_shortener: 4/4, path_prefixer: 4/4, autogenerated_exclude: 7/7, exclude-rules: 7/7, sort_results: 4/4, path_prettifier: 7/7, identifier_marker: 7/7 
</span></span><span class=line><span class=cl>INFO <span class=o>[</span>runner<span class=o>]</span> processing took 1.708654ms with stages: path_prettifier: 661.569µs, nolint: 614.546µs, exclude-rules: 185.12µs, identifier_marker: 110.421µs, source_code: 48.813µs, autogenerated_exclude: 48.499µs, skip_dirs: 16.894µs, cgo: 6.783µs, max_same_issues: 3.182µs, uniq_by_line: 2.679µs, filename_unadjuster: 2.498µs, path_shortener: 2.444µs, max_per_file_from_linter: 2.015µs, max_from_linter: 1.59µs, sort_results: 348ns, exclude: 291ns, diff: 268ns, skip_files: 260ns, severity-rules: 244ns, path_prefixer: 190ns 
</span></span><span class=line><span class=cl>INFO <span class=o>[</span>runner<span class=o>]</span> linters took 85.727899ms with stages: goanalysis_metalinter: 83.919309ms 
</span></span><span class=line><span class=cl>main.go:81:5: <span class=sb>`</span>abc<span class=sb>`</span> is unused <span class=o>(</span>deadcode<span class=o>)</span>
</span></span><span class=line><span class=cl>var abc string
</span></span><span class=line><span class=cl>    ^
</span></span><span class=line><span class=cl>main.go:78:14: Error <span class=k>return</span> value of <span class=sb>`</span>core.Service<span class=sb>`</span> is not checked <span class=o>(</span>errcheck<span class=o>)</span>
</span></span><span class=line><span class=cl>        core.Service<span class=o>(</span><span class=s2>&#34;:8081&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                    ^
</span></span><span class=line><span class=cl>main.go:75:5: S1002: should omit comparison to bool constant, can be simplified to <span class=sb>`</span>t<span class=sb>`</span> <span class=o>(</span>gosimple<span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nv>t</span> <span class=o>==</span> <span class=nb>true</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>           ^
</span></span><span class=line><span class=cl>main.go:74:10: SA4000: identical expressions on the left and right side of the <span class=s1>&#39;==&#39;</span> operator <span class=o>(</span>staticcheck<span class=o>)</span>
</span></span><span class=line><span class=cl>        var <span class=nv>t</span> <span class=o>=</span> <span class=nv>0</span> <span class=o>==</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>                ^
</span></span><span class=line><span class=cl>INFO File cache stats: <span class=m>1</span> entries of total size 4.3KiB 
</span></span><span class=line><span class=cl>INFO Memory: <span class=m>7</span> samples, avg is 72.4MB, max is 73.1MB 
</span></span><span class=line><span class=cl>INFO Execution took 594.401598ms
</span></span></code></pre></td></tr></table></div></div><p>可以看到，一开始会打印相关的一些信息后，开始一个个打印遍历到的不规范的语法，并且指出问题所在的位置。虽然说现在的代码编辑器会对代码进行扫描也会指出不规范的语法，但是不会影响我们的日常开发和提交，而 <code>golangci-lint</code> 比编辑器更全面且可以通过 <code>CICD</code> 或者命令行的方式一次性遍历整个项目代码，所有的不规范可以一次性列出来。</p><p>如果去看一些 go 语言的开源项目，你会发现很多项目的 GitHub action 里会配置 lint 的工作流，如果 lint 过不去拒绝合并到正式分支的。</p><h2 id=5-git>5. git</h2><p>上面提到了一些代码规范/单元测试和 GitHub action 等概念，从这里开始讲一下如何将这些概念串联起来，让更多的工作变成自动化。</p><p>git 作为版本管理工具，除了版本管理外其他相关方面的能力也是非常的强。本地的git 可以分支开发，打 tag，git hook 等。远端（GitHub/Gitlab）可以有 issue，milestone，PR，MR，CICD 等能力。</p><h3 id=51-git-hook>5.1. git hook</h3><p><a href=https://git-scm.com/book/zh/v2/%E8%87%AA%E5%AE%9A%E4%B9%89-Git-Git-%E9%92%A9%E5%AD%90 target=_blank rel="noopener noreffer">git hook</a>是git 提供的钩子方法，可以配置很多事件的回调，让我们的一些手动工作配置到对应的 hook 上自动执行。我们打开任意的一个 git 项目进行下面的命令查看支持的 hooks：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>➜  ls .git/hooks 
</span></span><span class=line><span class=cl>applypatch-msg.sample     post-update.sample        pre-merge-commit.sample   pre-receive.sample        update.sample
</span></span><span class=line><span class=cl>commit-msg.sample         pre-applypatch.sample     pre-push.sample           prepare-commit-msg.sample
</span></span><span class=line><span class=cl>fsmonitor-watchman.sample pre-commit.sample         pre-rebase.sample         push-to-checkout.sample
</span></span></code></pre></td></tr></table></div></div><p>可以看到很多 <code>pre</code> 或 <code>post</code> 开头的文件，表示对应的事件前或后执行对应的脚本。如果需要启动任意一个钩子，只需要编辑对应的文件然后把后缀 <code>.sample</code> 去掉即可。</p><p>下面是我在自己某个项目内启用了 <code>pre-commit</code> hook 的例子：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=cp>#!/bin/sh
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># An example hook script to verify what is about to be committed.</span>
</span></span><span class=line><span class=cl><span class=c1># Called by &#34;git commit&#34; with no arguments.  The hook should</span>
</span></span><span class=line><span class=cl><span class=c1># exit with non-zero status after issuing an appropriate message if</span>
</span></span><span class=line><span class=cl><span class=c1># it wants to stop the commit.</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># To enable this hook, rename this file to &#34;pre-commit&#34;.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 执行 make test 命令</span>
</span></span><span class=line><span class=cl><span class=k>if</span> ! make test<span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;Go test failed, please check your code.&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>exit</span> <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=c1># 执行 make lint 命令</span>
</span></span><span class=line><span class=cl><span class=k>if</span> ! make lint<span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;Go lint failed, please check your code style.&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>exit</span> <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span></code></pre></td></tr></table></div></div><p>启用后我的任何一次 commit 都会先进行一次全局的测试和 lint 校验通过后，才会 commit 成功否则本次 commit 失败。这种做法对于个人或少数几个人开发者来说，实用性蛮高的，一种自我约束并且保证不会提交一些垃圾代码。最重要的是不需要自己手动去检查代码质量和规范，不通过测试和规范的提交都不会产生一次 commitID。</p><h3 id=52-github--gitlab>5.2. github / gitlab</h3><p>除了上述本地的一些 git hook 的限制外，GitHub 和 Gitlab 提供一套完整的 CICD 的能力，用户可以配置针对提交，MR，PR 等各种事件运行特定的脚本，在远端服务器进行校验，构建，部署等能力。</p><p>CICD 对于现在的开发者来说应该很熟悉，对于热衷于工作自动化的程序员来说，CICD 可以说是非常好用的一个手段，我个人的大部分项目都会配置远端的代码测试代码规范校验的脚本。包括本博客也在 GitHub 上自动部署的,我只管提交剩余的工作都是自动化，感兴趣可以<a href=https://github.com/yusank/yusank.github.io/actions target=_blank rel="noopener noreffer">点击查看</a>。</p><h2 id=6-构建与运行>6. 构建与运行</h2><p>项目的开发和调试过程我们免不了无数次的构建、编译、运行等过程，并且会依赖很多变量。这个时候我们应该有一个比较完善的解决方案来减少我们的敲各种命令的次数提升效率。</p><h3 id=61-makefile>6.1. makefile</h3><p><code>make</code>命令是GNU的工程化编译工具，用于编译众多相互关联的源代码文件，以实现工程化的管理，提高开发效率。我们应该对 make 有一定的了解，并学会使用它，从而提升效率。</p><blockquote><p><a href=https://www.ruanyifeng.com/blog/2015/02/make.html target=_blank rel="noopener noreffer">点击这里</a>学习/复习相关知识，本篇文章不再讲述相关内容。</p></blockquote><p>下面以当前博客项目的 Makefile 为例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nv>TAG</span> <span class=o>=</span> latest
</span></span><span class=line><span class=cl><span class=nf>help</span><span class=o>:</span>  <span class=c>## Display this help
</span></span></span><span class=line><span class=cl><span class=c></span>    @awk <span class=s1>&#39;BEGIN {FS = &#34;:.*##&#34;; printf &#34;\nUsage:\n  make \033[36m&lt;target&gt;\033[0m\n&#34;} /^[0-9A-Za-z_-]+:.*?##/ { printf &#34;  \033[36m%-45s\033[0m %s\n&#34;, $$1, $$2 } /^##@/ { printf &#34;\n\033[1m%s\033[0m\n&#34;, substr($$0, 5) } &#39;</span> <span class=k>$(</span>MAKEFILE_LIST<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nf>.PHONY</span><span class=o>:</span> <span class=n>docker</span>-<span class=n>build</span>
</span></span><span class=line><span class=cl><span class=nf>docker-build</span><span class=o>:</span> <span class=c>## build docker image
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=c1>## change config</span>
</span></span><span class=line><span class=cl>    cat config.toml &gt; config.backup.toml
</span></span><span class=line><span class=cl>    rm -f config.toml
</span></span><span class=line><span class=cl>    mv config.docker.toml config.toml
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    docker build -t yusank/hugo_blog:<span class=k>$(</span>TAG<span class=k>)</span> .
</span></span><span class=line><span class=cl>    <span class=c1># recover</span>
</span></span><span class=line><span class=cl>    mv config.toml config.docker.toml
</span></span><span class=line><span class=cl>    cat config.backup.toml &gt; config.toml
</span></span><span class=line><span class=cl>    rm -f config.backup.toml
</span></span><span class=line><span class=cl><span class=nf>.PHONY</span><span class=o>:</span> <span class=n>docker</span>-<span class=n>run</span>
</span></span><span class=line><span class=cl><span class=nf>docker-run</span><span class=o>:</span> <span class=c>## run latest docker image localy
</span></span></span><span class=line><span class=cl><span class=c></span>    docker rm -f blog
</span></span><span class=line><span class=cl>    docker run -d -p 8088:80 --name blog yusank/hugo_blog:<span class=k>$(</span>TAG<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>.PHONY</span><span class=o>:</span> <span class=n>docker</span>-<span class=n>push</span>
</span></span><span class=line><span class=cl><span class=nf>docker-push</span><span class=o>:</span> <span class=n>docker</span>-<span class=n>build</span> <span class=c>## bulid and push newest docker image
</span></span></span><span class=line><span class=cl><span class=c></span>    docker push docker.io/yusank/hugo_blog:<span class=k>$(</span>TAG<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>.PHONY</span><span class=o>:</span> <span class=n>docker</span>-<span class=n>release</span>
</span></span><span class=line><span class=cl><span class=nf>docker-release</span><span class=o>:</span> <span class=n>docker</span>-<span class=n>push</span> <span class=c>## relaese newest version of image to aliyun
</span></span></span><span class=line><span class=cl><span class=c></span>    ssh aliyun_d1 <span class=s2>&#34;./restart.sh latest&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到定义了几个命令，并且可以发现有些命令是有依赖关系的。当执行 <code>make docker-release</code> 时，会先进行 <code>docker-push</code>的逻辑，而 <code>docker-push</code> 又有其依赖，以此类推。如果没有定义这个 <code>makefile</code>, 那为了一个 release 操作，我需要你手动敲很多命令且还得确保顺序。</p><p>这个只是一个十几行的 <code>make</code> 命令的示例，如果你的构建/编译的依赖更多（环境变量，上下文等），那更得写一个 <code>Makefile</code> 来减少人工操作次数。况且一次测好后，之后就避免人工操作失误的情况。</p><p><code>help</code> 命令会打印当前 <code>Makefile</code> 支持的所有子命令，效果如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>➜ make <span class=nb>help</span>      
</span></span><span class=line><span class=cl>Usage:
</span></span><span class=line><span class=cl>  make &lt;target&gt;
</span></span><span class=line><span class=cl>  <span class=nb>help</span>                                           Display this <span class=nb>help</span>
</span></span><span class=line><span class=cl>  docker-build                                   build docker image
</span></span><span class=line><span class=cl>  docker-run                                     run latest docker image localy
</span></span><span class=line><span class=cl>  docker-push                                    bulid and push newest docker image
</span></span><span class=line><span class=cl>  docker-release                                 relaese newest version of image to aliyun
</span></span></code></pre></td></tr></table></div></div><p>写好一个 Makefile 可以说是一个一劳永逸，对自己和他人都有百益无一害的事儿了。你可以有个模板，有新的项目可以直接 copy 进去修改即可用的那种。</p><h3 id=62-dockerfile>6.2. dockerfile</h3><p><code>dockerfile</code> 的用处很简单，就是为了构建 docker 镜像。现在大部分人的项目都在容器内运行了，二进制裸跑在物理机或虚拟机的情况很少，所以 dockerfile 也是需要我们在项目中加好，方便自动化构建镜像。</p><p>还是以本博客系统的镜像为例（引用本博客系统的文件不是因为夸自己写的好，纯属因为方便）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>ARG</span> <span class=nv>HUGO_DIR</span><span class=o>=</span>.<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>HUGO_ENV_ARG</span><span class=o>=</span>production
</span></span><span class=line><span class=cl><span class=k>FROM</span><span class=s> klakegg/hugo:0.90.1-alpine-onbuild AS hugo</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> nginx</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> nginx.conf /etc/nginx/conf.d/nginx.conf<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> yusank.space.pem /etc/nginx/conf.d/yusank.space.pem<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> yusank.space.key /etc/nginx/conf.d/yusank.space.key<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>hugo /target /usr/share/nginx/html<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>EXPOSE</span><span class=s> 80</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>EXPOSE</span><span class=s> 443</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>典型的 go 项目的dockerfile：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> golang:1.17-alpine as builder</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /app/godis</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> . .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># args</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> build_tags<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> <span class=nv>CGO_ENABLED</span><span class=o>=</span><span class=m>0</span> go build -tags <span class=s2>&#34;</span><span class=si>${</span><span class=nv>build_tags</span><span class=si>}</span><span class=s2>&#34;</span> -o godis cmd/server/main.go<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> scratch</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /app/godis</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>builder /app/godis .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>EXPOSE</span><span class=s> 7379</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>CMD</span> <span class=p>[</span><span class=s2>&#34;./godis&#34;</span><span class=p>]</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=7-总结>7. 总结</h2><p>本篇文章主要讲述了我个人在开个项目过程积累的一些经验，不一定是最好的而且肯定露了很多地方，若有不正确的地方请指出。想通过这篇文章首先给自己一个总结，其次想给对项目的管理（开发方向）方面有疑惑有疑虑的同学一些启发。</p><p>本篇文章的主要内容：</p><ul><li>介绍常见的项目目录结构，请按自己的实际情况选择</li><li>如何拆分模块</li><li>应该重视代码测试项目测试相关</li><li>介绍 git,github,gitlab 的一些好用的特性，希望能带来效率的提升</li><li>介绍 makefile,dockerfile 帮助提升开发效率</li></ul><h2 id=8-链接>8. 链接🔗</h2><ul><li><a href=https://keda.sh target=_blank rel="noopener noreffer">keda</a></li><li><a href=https://github.com/golangci/golangci-lint target=_blank rel="noopener noreffer">golangci-lint</a></li><li><a href=https://git-scm.com/book/zh/v2/%E8%87%AA%E5%AE%9A%E4%B9%89-Git-Git-%E9%92%A9%E5%AD%90 target=_blank rel="noopener noreffer">git hook</a></li><li><a href=https://www.ruanyifeng.com/blog/2015/02/make.html target=_blank rel="noopener noreffer">Makefile</a></li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2022-02-15</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/posts/go-project-experience/index.md target=_blank>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://yusank.github.io/posts/go-project-experience/ data-title="Go 项目开发和维护经验之谈" data-hashtags=go,开发,维护><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://yusank.github.io/posts/go-project-experience/ data-hashtag=go><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="分享到 Linkedin" data-sharer=linkedin data-url=https://yusank.github.io/posts/go-project-experience/><i class="fab fa-linkedin fa-fw"></i></a><a href=javascript:void(0); title="分享到 WhatsApp" data-sharer=whatsapp data-url=https://yusank.github.io/posts/go-project-experience/ data-title="Go 项目开发和维护经验之谈" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href=javascript:void(0); title="分享到 Hacker News" data-sharer=hackernews data-url=https://yusank.github.io/posts/go-project-experience/ data-title="Go 项目开发和维护经验之谈"><i class="fab fa-hacker-news fa-fw"></i></a><a href=javascript:void(0); title="分享到 Reddit" data-sharer=reddit data-url=https://yusank.github.io/posts/go-project-experience/><i class="fab fa-reddit fa-fw"></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://yusank.github.io/posts/go-project-experience/ data-title="Go 项目开发和维护经验之谈"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/line.svg></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://yusank.github.io/posts/go-project-experience/ data-title="Go 项目开发和维护经验之谈" data-ralateuid=yusann><i class="fab fa-weibo fa-fw"></i></a><a href=javascript:void(0); title="分享到 Myspace" data-sharer=myspace data-url=https://yusank.github.io/posts/go-project-experience/ data-title="Go 项目开发和维护经验之谈" data-description><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/myspace.svg></i></a><a href=javascript:void(0); title="分享到 Blogger" data-sharer=blogger data-url=https://yusank.github.io/posts/go-project-experience/ data-title="Go 项目开发和维护经验之谈" data-description><i class="fab fa-blogger fa-fw"></i></a><a href=javascript:void(0); title="分享到 百度" data-sharer=baidu data-url=https://yusank.github.io/posts/go-project-experience/ data-title="Go 项目开发和维护经验之谈"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/baidu.svg></i></a><a href=javascript:void(0); title="分享到 Evernote" data-sharer=evernote data-url=https://yusank.github.io/posts/go-project-experience/ data-title="Go 项目开发和维护经验之谈"><i class="fab fa-evernote fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/go/>go</a>,&nbsp;<a href=/tags/%E5%BC%80%E5%8F%91/>开发</a>,&nbsp;<a href=/tags/%E7%BB%B4%E6%8A%A4/>维护</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/hpa-controller/ class=prev rel=prev title="HPA controller 源码解读"><i class="fas fa-angle-left fa-fw"></i>HPA controller 源码解读</a>
<a href=/posts/conn-pool/ class=next rel=next title="Go 语言实现连接池">Go 语言实现连接池<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=utterances></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>Utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Keep learning and stay with lights.<br>❤ yusank<br></div><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.98.0">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2017 - 2022</span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by/4.0/deed.zh target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/copy-tex.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/typeit@7.0.4/dist/typeit.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:50},comment:{utterances:{darkTheme:"github-dark",issueTerm:"pathname",label:"Comment",lightTheme:"github-light",repo:"yusank/yusank.github.io"}},data:{"id-1":"usank`s Site","id-2":"usank`s Site"},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},typeit:{cursorChar:"|",cursorSpeed:1e3,data:{"id-1":["id-1"],"id-2":["id-2"]},duration:-1,speed:70}}</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-24P8ZSJHCQ",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-24P8ZSJHCQ" async></script></body></html>