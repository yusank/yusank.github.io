<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>[系列]Redis Server 实现·协议篇 - Yusank`s Site</title><meta name=Description content="这是我的个人博客，我会在这里分享学习和成长过程中的积累和经验."><meta property="og:title" content="[系列]Redis Server 实现·协议篇"><meta property="og:description" content="
        
            说明
        
        
            本文章为该系列的协议篇，如果需要阅读其他相关文章， 请点击这里跳转查看
        
    "><meta property="og:type" content="article"><meta property="og:url" content="https://yusank.github.io/posts/redis-server-protocol/"><meta property="og:image" content="https://yusank.github.io/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-11-23T10:00:00+08:00"><meta property="article:modified_time" content="2021-12-15T11:19:23+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://yusank.github.io/logo.png"><meta name=twitter:title content="[系列]Redis Server 实现·协议篇"><meta name=twitter:description content="
        
            说明
        
        
            本文章为该系列的协议篇，如果需要阅读其他相关文章， 请点击这里跳转查看
        
    "><meta name=application-name content="Yusank's Site"><meta name=apple-mobile-web-app-title content="Yusank's Site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel=icon href=https://yusank.github.io/images/logo.svg><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://yusank.github.io/posts/redis-server-protocol/><link rel=prev href=https://yusank.github.io/posts/redeis-server-introduction/><link rel=next href=https://yusank.github.io/posts/blog_example/><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"[系列]Redis Server 实现·协议篇","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/yusank.github.io\/posts\/redis-server-protocol\/"},"genre":"posts","keywords":"redis, 系列篇","wordcount":3016,"url":"https:\/\/yusank.github.io\/posts\/redis-server-protocol\/","datePublished":"2021-11-23T10:00:00+08:00","dateModified":"2021-12-15T11:19:23+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Yusank"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Yusank`s Site"><img class="lazyload logo" src=/svg/loading.min.svg data-src=https://yusank.github.io/images/logo.svg data-srcset="https://yusank.github.io/images/logo.svg, https://yusank.github.io/images/logo.svg 1.5x, https://yusank.github.io/images/logo.svg 2x" data-sizes=auto alt=https://yusank.github.io/images/logo.svg title=https://yusank.github.io/images/logo.svg><span id=id-1 class=typeit></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/about/>关于 </a><a class=menu-item href=/links/>友链 </a><a class=menu-item href=https://github.com/yusank title=GitHub rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i> </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Yusank`s Site"><img class="lazyload logo" src=/svg/loading.min.svg data-src=https://yusank.github.io/images/logo.svg data-srcset="https://yusank.github.io/images/logo.svg, https://yusank.github.io/images/logo.svg 1.5x, https://yusank.github.io/images/logo.svg 2x" data-sizes=auto alt=https://yusank.github.io/images/logo.svg title=https://yusank.github.io/images/logo.svg><span id=id-2 class=typeit></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/about/ title>关于</a><a class=menu-item href=/links/ title>友链</a><a class=menu-item href=https://github.com/yusank title=GitHub rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i></a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class="toc-content always-active" id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">[系列]Redis Server 实现·协议篇</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://github.com/yusank title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw"></i>Yusank</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/redis/><i class="far fa-folder fa-fw"></i>Redis</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2021-11-23>2021-11-23</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 3016 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 7 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#协议>协议</a></li><li><a href=#基础说明>基础说明</a></li><li><a href=#简单字符串simple-strings>简单字符串(Simple Strings)</a></li><li><a href=#错误errors>错误(Errors)</a></li><li><a href=#整数integers>整数(Integers)</a></li><li><a href=#复杂字符串bulk-strings>复杂字符串(Bulk Strings)</a></li><li><a href=#数组arrays>数组(Arrays)</a><ul><li><a href=#null数组>Null数组</a></li><li><a href=#嵌套>嵌套</a></li><li><a href=#包含-null-元素的数组>包含 Null 元素的数组</a></li></ul></li><li><a href=#客户端服务端交互>客户端服务端交互</a></li><li><a href=#高效解析协议>高效解析协议</a></li><li><a href=#参考文献>参考文献</a></li></ul></nav></div></div><div class=content id=content><div class="details admonition quote open"><div class="details-summary admonition-title"><i class="icon fas fa-quote-right fa-fw"></i>说明<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>本文章为该系列的<code>协议篇</code>，如果需要阅读其他相关文章， 请点击<a href=https://yusank.github.io/posts/redeis-server-introduction/ target=_blank rel="noopener noreffer">这里</a>跳转查看</div></div></div><h2 id=前言>前言</h2><p><code>Redis</code> 作为一个当下最流行的 <code>NoSQL</code> 或 <code>KV</code> 数据库，几乎嵌入到大部对性能、时效性高的项目内，变成了每个程序员尤其是后端程序必需了解的一个知识点。
我是无形在 GitHub 上发现一个 <code>Godis</code> 项目，是实现了大部分 Redis 服务器的功能。
然后瞬间激发了我的兴趣，既然用了 Redis 这些年了而且对核心逻辑和数据结构也是有所了解的，那我为什么不也写一个基于 <code>Go</code> 的 Redis 服务器代码，实现我能实现的核心功能逻辑。目的无外乎以下几点：</p><ol><li>更全面且系统的了解Redis 核心逻辑并把自己的了解通过代码输出出来</li><li>提高自己的代码水平</li><li>提高自己的算法水平（涉及到实现 Redis 核心五大数据结构）</li></ol><p>所以我也起了一个项目叫 <code>Godis</code>,一步步将 Redis 的逻辑通过Go 代码写出来，并且在性能上尽可能的追赶 Redis 的性能。</p><p>前期我更专注于最核心的 <code>请求处理</code>, <code>协议处理</code>, <code>数据结构处理</code>, <code>命令处理</code> 等这些基础核心的模块一个个攻破，至于数据持久化，分布式部署，主从模式等这些高级特性，我在确保之前的功能都达到预期后再考虑，目前计划是数据持久化可能优先考虑。</p><h2 id=协议>协议</h2><p>想实现 <code>Redis</code> 服务器首先想到的问题是，如何通信？其实都知道是 tcp 连接，所以更准确的问题是，客户端和服务端用的什么协议去传输数据？答案是 RESP (REdis Serialization Protocol）。</p><p>该协议从内容来说还是比较简单的，对于服务端去解析也是相对友好且消耗性能很低。官方给出的优点为以下三点：</p><ul><li>容易实现</li><li>解析快</li><li>可读性高</li></ul><p>RESP 协议为一个 request-response 模型的协议，客户端发出请求并等待服务器响应，服务器按同样的协议返回数据。下面我们来看一下协议具体内容。</p><h2 id=基础说明>基础说明</h2><p>在 RESP 协议中，所有的数据的第一字符都是以下五种类型之一：</p><ul><li><code>+</code> : 简单字符串.</li><li><code>-</code> : 错误.</li><li><code>:</code> : 整数.</li><li><code>$</code> : 复杂字符串或大块字符串(bulk string).</li><li><code>*</code> : 数组.</li></ul><div class="details admonition tip open"><div class="details-summary admonition-title"><i class="icon fas fa-lightbulb fa-fw"></i>数据结尾<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>任何一个类型的数据都是以 <code>"\r\n"(CRLF)</code>作为结束符.</div></div></div><blockquote><p>本文中的大部分示例均来自官方文档。</p></blockquote><h2 id=简单字符串simple-strings>简单字符串(Simple Strings)</h2><p>简单字符串以 <code>+</code> 符号开始，然后字符内容（不能包含 CR 或 LF，即不能有换行符），以 <code>CRLF("\r\n")</code> 结尾。简单字符不适合传输数据(non binary safa)，在 Redis 内基本用于响应 <code>"OK"</code> 或成功标识。</p><div class="details admonition example open"><div class="details-summary admonition-title"><i class="icon fas fa-list-ol fa-fw"></i>简单字符串<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>&ldquo;+OK\r\n&rdquo;</div></div></div><p>为了安全起见，Redis 内传输数据会用 Bulk Strings .</p><h2 id=错误errors>错误(Errors)</h2><p>RESP 预留专门的错误类型。其实错误类型与简单字符串几乎没区别，只是第一个字符是 <code>-</code>, 除此之外在处理和编码过程均无区别，更多的区别在于客户端处理上。</p><div class="details admonition example open"><div class="details-summary admonition-title"><i class="icon fas fa-list-ol fa-fw"></i>Errors<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>&ldquo;-Error Message\r\n&rdquo;</div></div></div><p><code>Errors</code> 类型只用于在处理请求遇到错误时，响应到客户端，比如命令不存在或命令与 key 的类型不符合等。客户端应该针对错误做一层处理，方便使用者感知到错误。</p><div class="details admonition example open"><div class="details-summary admonition-title"><i class="icon fas fa-list-ol fa-fw"></i>另一个 Errors 的例子<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>-ERR unknown command &lsquo;foobar&rsquo;<br>-WRONGTYPE Operation against a key holding the wrong kind of value</div></div></div><p>从 <code>-</code> 到第一个空格或新一行的单词代表返回的错误的<code>类型</code>。这个是 <code>Redis</code> 的一个响应习惯(convention)，将错误分类型，方便客户端更灵活的处理。</p><p>以上面的例子为例， <code>ERR</code> 是一个通用的错误，而 <code>WRONGTYPE</code> 是一个具体的错误类型，代表命令和 key 的类型不匹配,这个叫错误前缀<code>Error Prefix</code>。站在客户端角度来说，相对于一串错误字符串，拿到一个具体的错误类型无异于拿到一个 error code 一样，可以做一个具体的操作来消化这个错误。</p><p>当然如果分的错误类型很细 那客户端就得写的更复杂反而可能会导致得不偿失，抛开 <code>Redis</code> 的习惯从协议的角度来说，可以在非常简单的返回一个 false 来说明一个错误或者就一行错误内容，返回给用户，这个更多的取决于客户端实现的时候的取舍。</p><h2 id=整数integers>整数(Integers)</h2><p>该类型与上述两个类型也没有很大的区别，是为了专门传输整数而定的，以<code>:</code> 字符为开头，内容为整数且以<code>\r\n</code> 结尾，如 <code>":100\r\n"</code> 。</p><div class="details admonition warning open"><div class="details-summary admonition-title"><i class="icon fas fa-exclamation-triangle fa-fw"></i>数字范围<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>有符号 64 位整数</div></div></div><p><code>Redis</code> 中像 <code>INCR</code>, <code>LLEN</code> 和 <code>LASTSAVE</code> 等命令都返回整数。当然返回整数没有别的意义，只是这些命令的结果是数字。</p><p>除了命令结果是整数时返回 <code>Integer</code> 类型外，一些命令用整数 <code>0 or 1</code> 来表示 <code>true or false</code>,如 <code>EXISTS</code>, <code>SISMEMBER</code>。</p><p>还有一些命令是返回 <code>1</code> 表示操作真正执行(这么说是因为，一些操作因为数据已存在或已被操作所以不会再次操作数据而直接返回),否则返回 <code>0</code> ，像 <code>SADD</code>, <code>SREM</code>, <code>SETNX</code> 等。</p><h2 id=复杂字符串bulk-strings>复杂字符串(Bulk Strings)</h2><p>复杂字符串为 <code>RESP</code> 中二进制安全的字符串类型，最大容量为 512MB。bulk string 编码方式如下：</p><ul><li>以 <code>$</code>为开头写入实际字符串长度并以 CRLF 结尾</li><li>实际字符串</li><li>CRLF 结束</li></ul><div class="details admonition example open"><div class="details-summary admonition-title"><i class="icon fas fa-list-ol fa-fw"></i>以 Hello 为例<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>&ldquo;$5\r\nHello\r\n&rdquo;</div></div></div><div class="details admonition example open"><div class="details-summary admonition-title"><i class="icon fas fa-list-ol fa-fw"></i>空字符<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>&ldquo;$0\r\n\r\n&rdquo;</div></div></div><p>前面说到<code>简单字符串</code> 不能包好换行符，然而 <code>Bulk String</code>是允许包含这类特殊字符的，因为读取 <code>Bulk String</code> 是根据其定义的长度来读取的，而不是根据换行符。</p><div class="details admonition example open"><div class="details-summary admonition-title"><i class="icon fas fa-list-ol fa-fw"></i>包含换行符的例子<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>&ldquo;$4\r\nOK\r\n\r\n&rdquo;<br>这是一个有效的复杂字符串其内容是 <code>OK\r\n</code>包含四个字符。<br><strong>注意：$4\r\n<u>OK\r\n</u>\r\n, 下划线才是字符串内容</strong></div></div></div><p>Bulk String 支持 Null 值（注意不是空字符）以此来区分数据不存在的情况。Null 的情况下不存在数据，所以长度为-1（-1 是协议定的，具体为什么是-1 <em>I hava no idea .</em>), 没有数据部分也没有数据最后的 CRLF（<strong>空字符是有的，这个需要注意的</strong>）</p><div class="details admonition example open"><div class="details-summary admonition-title"><i class="icon fas fa-list-ol fa-fw"></i>Null 响应<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>&ldquo;$-1\r\n&rdquo;</div></div></div><p>官方原文：</p><p>This is called a <strong>Null Bulk String</strong>.</p><h2 id=数组arrays>数组(Arrays)</h2><p>客户端的所有请求都是以数组的方式传到服务端的，而服务端的响应如果是多个值也都是以数组的方式响应。比如 <code>ZRANGE</code>, <code>LRANGE</code>, <code>MGET</code> 等。</p><p>数组(Arrays) 是以下方式编码的：</p><ul><li>以 <code>*</code> 作为第一个字符，然后写入数组的长度，最后以 CRLF 结尾.</li><li>一组 RESP 类型的数据作为数组的元素.</li></ul><div class="details admonition example open"><div class="details-summary admonition-title"><i class="icon fas fa-list-ol fa-fw"></i>空数组<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>&ldquo;*0\r\n&rdquo;</div></div></div><div class="details admonition example open"><div class="details-summary admonition-title"><i class="icon fas fa-list-ol fa-fw"></i>包含 foo 和 bar 两个 bulk string 作为元素的数组<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>&ldquo;*2\r\n$3\r\nfoo\r\n$3\r\nbar\r\n&rdquo;<br><strong>为了阅读方便加上换行符：</strong><br>*2\r\n<br>$3\r\n<br>foo\r\n<br>$3\r\n<br>bar\r\n</div></div></div><p>不难发现，数组只需要声明长度即可，后面拼接元素就可以，元素之前无需有任何分隔符，元素可以是<code>简单字符串</code>, <code>Errors</code>, <code>整型</code>,<code>复杂字符串</code>。下面例子更明显体现如何使用包含不用元素的数组：</p><div class="details admonition example open"><div class="details-summary admonition-title"><i class="icon fas fa-list-ol fa-fw"></i>混合元素例子<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>*5\r\n<br>:1\r\n<br>:2\r\n<br>+SimpleString\r\n<br>-Err Message\r\n<br><code>$6\r\n</code><br>foobar\r\n<br></div></div></div><h3 id=null数组>Null数组</h3><p>与复杂字符串一样，数组也支持表示 Null 值，在 <code>BLPOP</code> 命令中，如果操作超时，则返回一个 Null 数组表示结果：</p><div class="details admonition example open"><div class="details-summary admonition-title"><i class="icon fas fa-list-ol fa-fw"></i>Null Array<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>&ldquo;*-1\r\n&rdquo;</div></div></div><p>实现客户端时，应该考虑并区分开空数组和 Null 数组（如无数据或操作超时）应该有不同的处理方式。</p><h3 id=嵌套>嵌套</h3><p>数组是支持其元素也是数组的，如下面是一个包含两个数组作为元素的数组：</p><div class="details admonition example open"><div class="details-summary admonition-title"><i class="icon fas fa-list-ol fa-fw"></i>嵌套数组<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>*2\r\n<br>*3\r\n<br>:1\r\n<br>:2\r\n<br>:3\r\n<br>*2\r\n<br>+Foo\r\n<br>-Bar\r\n<br></div></div></div><p>把 RESP 协议转换成可读性更高的数据后：</p><div class="details admonition tip open"><div class="details-summary admonition-title"><i class="icon fas fa-lightbulb fa-fw"></i>解码后<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content><code>[[1, 2, 3], ["Foo", Error("Bar")]]</code></div></div></div><h3 id=包含-null-元素的数组>包含 Null 元素的数组</h3><p>在与 <code>Redis</code> 交互时, 一部分命令是操作多个 key，返回多个值的，这个时候就有个问题，其中一些操作不成功或数据不存在，
该不该影响这次请求的整体结果呢？</p><p>以 <code>MGET</code> 这个命令为例，如果获取多个 key 的值，而其中有一部分 key 是不存在时，<code>Redis</code> 在响应中留 null 值从而不影响其他 key 的读取，协议如下：</p><div class="details admonition example open"><div class="details-summary admonition-title"><i class="icon fas fa-list-ol fa-fw"></i>包含 Null 元素<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>*3\r\n<br><code>$3\r\n</code><br>foo\r\n<br><code>$-1\r\n</code><br><code>$3\r\n</code><br>bar\r\n<br></div></div></div><p>客户端针对该响应解析出来的结果应该如下：</p><div class="details admonition tip open"><div class="details-summary admonition-title"><i class="icon fas fa-lightbulb fa-fw"></i>解码后<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content><code>["foo", nil, "bar"]</code></div></div></div><h2 id=客户端服务端交互>客户端服务端交互</h2><p>到目前为止，RESP 协议的内容全部说完了，发现其实蛮简单的。其实现在去实现一个客户端的代码比实现服务端的简单很多，因为只需要编码解码协议内容即可。
服务端和客户单交互最核心就是以下两点：</p><ul><li>客户端向服务端发起请求均为以 <code>Bulk Strings</code> 作为元素的数组.</li><li>服务端向客户端响应任意合法的 RESP 数据类型.</li></ul><p>以 <code>LLEN mylist</code> 为例：</p><div class="details admonition abstract open"><div class="details-summary admonition-title"><i class="icon fas fa-list-ul fa-fw"></i>一次交互过程<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content><p>C: <code>*2\r\n</code><br>C: <code>$4\r\n</code><br>C: <code>LLEN\r\n</code><br>C: <code>$6\r\n</code><br>C: <code>mylist\r\n</code><br><br></p><p>S: <code>:48293\r\n</code></p><blockquote><p>C: client， S:server</p></blockquote></div></div></div><h2 id=高效解析协议>高效解析协议</h2><p>该协议可读性相对高，与此同时解析效率也很高，下面给出如何解析该协议.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;bytes&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;io&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>p</span> <span class=p>=</span> <span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=s>&#34;$5\r\nHello\r\n&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>buf</span> <span class=o>:=</span> <span class=nx>bytes</span><span class=p>.</span><span class=nf>NewBuffer</span><span class=p>(</span><span class=nx>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// read first line
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>b</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>buf</span><span class=p>.</span><span class=nf>ReadBytes</span><span class=p>(</span><span class=sc>&#39;\n&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// read length
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>ln</span> <span class=o>:=</span> <span class=nf>readBulkOrArrayLength</span><span class=p>(</span><span class=nx>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;string len: &#34;</span><span class=p>,</span><span class=nx>ln</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// string len: 5
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// read value
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>value</span><span class=p>,</span><span class=nx>err</span> <span class=o>:=</span> <span class=nf>readBulkStrings</span><span class=p>(</span><span class=nx>buf</span><span class=p>,</span> <span class=nx>ln</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;value: &#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>value</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=c1>// value: Hello
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 解析长度
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>readBulkOrArrayLength</span><span class=p>(</span><span class=nx>line</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>)</span> <span class=kt>int</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>ln</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>1</span><span class=p>;</span> <span class=nx>line</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=o>!=</span> <span class=sc>&#39;\r&#39;</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>ln</span> <span class=p>=</span> <span class=p>(</span><span class=nx>ln</span> <span class=o>*</span> <span class=mi>10</span><span class=p>)</span> <span class=o>+</span> <span class=nb>int</span><span class=p>(</span><span class=nx>line</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span><span class=o>-</span><span class=sc>&#39;0&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>ln</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 读取内容
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>readBulkStrings</span><span class=p>(</span><span class=nx>r</span> <span class=nx>io</span><span class=p>.</span><span class=nx>Reader</span><span class=p>,</span> <span class=nx>ln</span> <span class=kt>int</span><span class=p>)</span> <span class=p>(</span><span class=nx>val</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>ln</span> <span class=o>&lt;=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 读取时 将 \r\n 也读出来，保证 offset 在新的一行第一个字符
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>val</span> <span class=p>=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=nx>ln</span><span class=o>+</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Read</span><span class=p>(</span><span class=nx>val</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// trim last \r\n
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>val</span> <span class=p>=</span> <span class=nx>val</span><span class=p>[:</span><span class=nx>ln</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=参考文献>参考文献</h2><ul><li><a href=https://redis.io/topics/protocol target=_blank rel="noopener noreffer">https://redis.io/topics/protocol</a></li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2021-12-15</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/posts/redis-server-protocol/index.md target=_blank>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://yusank.github.io/posts/redis-server-protocol/ data-title="[系列]Redis Server 实现·协议篇" data-hashtags=redis,系列篇><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://yusank.github.io/posts/redis-server-protocol/ data-hashtag=redis><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="分享到 Linkedin" data-sharer=linkedin data-url=https://yusank.github.io/posts/redis-server-protocol/><i class="fab fa-linkedin fa-fw"></i></a><a href=javascript:void(0); title="分享到 WhatsApp" data-sharer=whatsapp data-url=https://yusank.github.io/posts/redis-server-protocol/ data-title="[系列]Redis Server 实现·协议篇" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href=javascript:void(0); title="分享到 Hacker News" data-sharer=hackernews data-url=https://yusank.github.io/posts/redis-server-protocol/ data-title="[系列]Redis Server 实现·协议篇"><i class="fab fa-hacker-news fa-fw"></i></a><a href=javascript:void(0); title="分享到 Reddit" data-sharer=reddit data-url=https://yusank.github.io/posts/redis-server-protocol/><i class="fab fa-reddit fa-fw"></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://yusank.github.io/posts/redis-server-protocol/ data-title="[系列]Redis Server 实现·协议篇"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/line.svg></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://yusank.github.io/posts/redis-server-protocol/ data-title="[系列]Redis Server 实现·协议篇" data-ralateuid=yusann><i class="fab fa-weibo fa-fw"></i></a><a href=javascript:void(0); title="分享到 Myspace" data-sharer=myspace data-url=https://yusank.github.io/posts/redis-server-protocol/ data-title="[系列]Redis Server 实现·协议篇" data-description><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/myspace.svg></i></a><a href=javascript:void(0); title="分享到 Blogger" data-sharer=blogger data-url=https://yusank.github.io/posts/redis-server-protocol/ data-title="[系列]Redis Server 实现·协议篇" data-description><i class="fab fa-blogger fa-fw"></i></a><a href=javascript:void(0); title="分享到 百度" data-sharer=baidu data-url=https://yusank.github.io/posts/redis-server-protocol/ data-title="[系列]Redis Server 实现·协议篇"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/baidu.svg></i></a><a href=javascript:void(0); title="分享到 Evernote" data-sharer=evernote data-url=https://yusank.github.io/posts/redis-server-protocol/ data-title="[系列]Redis Server 实现·协议篇"><i class="fab fa-evernote fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/redis/>redis</a>,&nbsp;<a href=/tags/%E7%B3%BB%E5%88%97%E7%AF%87/>系列篇</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/redeis-server-introduction/ class=prev rel=prev title="[系列]Redis Server 实现·前言"><i class="fas fa-angle-left fa-fw"></i>[系列]Redis Server 实现·前言</a>
<a href=/posts/blog_example/ class=next rel=next title=好用且实用的写文章技巧>好用且实用的写文章技巧<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=utterances></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>Utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Keep learning and stay with lights.<br>❤ yusank<br></div><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.94.2">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2017 - 2022</span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by/4.0/deed.zh target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/copy-tex.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/typeit@7.0.4/dist/typeit.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:100},comment:{utterances:{darkTheme:"github-dark",issueTerm:"pathname",label:"Comment",lightTheme:"github-light",repo:"yusank/yusank.github.io"}},data:{"id-1":"usank`s Site","id-2":"usank`s Site"},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},typeit:{cursorChar:"|",cursorSpeed:1e3,data:{"id-1":["id-1"],"id-2":["id-2"]},duration:-1,speed:70}}</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-24P8ZSJHCQ",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-24P8ZSJHCQ" async></script></body></html>