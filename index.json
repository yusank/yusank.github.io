[{"categories":["microservice"],"content":" æœ¬æ–‡ä¸ºç³»åˆ—ç¯‡å¾®æœåŠ¡çš„å…³äº æ·±å…¥ gRPC çš„æ–‡ç« ã€‚æœ¬ç¯‡å°†ä¼šä» gRPC çš„åŸºæœ¬æ¦‚å¿µã€gRPC çš„ä½¿ç”¨ã€gRPC çš„ç¼–ç¨‹æ¨¡å‹ã€gRPC çš„ç¼–ç¨‹æ¨¡å‹çš„å®ç°ã€gRPC çš„ç¼–ç¨‹æ¨¡å‹çš„å®ç°çš„ç»†èŠ‚ç­‰å¤šä¸ªè§’åº¦æ¥äº†è§£ã€‚ æœ¬ç¯‡ä¸º æ·±å…¥äº†è§£gRPC çš„ä¸‹ç¯‡ï¼Œç¯‡å¹…åŸå› ï¼Œå°†è¿™ç¯‡æ–‡ç« æ‹†åˆ†æˆä¸Šä¸‹ç¯‡ï¼Œä¸‹ç¯‡ç»§ç»­æ›´æ–°ä¸­ã€‚ ","date":"2022-06-29","objectID":"/posts/microservices-grpc-part1/:0:0","tags":["å¾®æœåŠ¡","ç³»åˆ—ç¯‡","grpc"],"title":"[ç³»åˆ—]å¾®æœåŠ¡Â·æ·±å…¥äº†è§£gRPC Part1","uri":"/posts/microservices-grpc-part1/"},{"categories":["microservice"],"content":"1. å‰è¨€ gRPC ä½œä¸ºä¸€ä¸ª Google å¼€æºçš„ RPC æ¡†æ¶ï¼Œç”±äºå…¶ä¼˜å¼‚çš„æ€§èƒ½å’Œæ”¯æŒå¤šç§æµè¡Œè¯­è¨€çš„ç‰¹ç‚¹ï¼Œè¢«ä¼—å¤šçš„å¼€å‘è€…æ‰€ç†Ÿæ‚‰ã€‚æˆ‘æ¥è§¦ gRPC ä¹Ÿæœ‰è‡³å°‘äº”å¹´çš„æ—¶é—´ï¼Œä½†æ˜¯ç”±äºç§ç§åŸå› ï¼Œåœ¨å¾ˆé•¿æ—¶é—´å†…å¯¹ gRPC çš„äº†è§£å¤„äºä¸€ä¸ªå…¥é—¨æˆ–è€…åªæ˜¯çŸ¥é“ä¸ªå¤§æ¦‚çš„æ°´å¹³ã€‚ç›´åˆ°å¤§æ¦‚ 2~3 å¹´å‰åœ¨ä¸Šå®¶å…¬å¸æœºç¼˜å·§åˆçš„ç¼˜æ•…ï¼Œéœ€è¦å¯¹éƒ¨é—¨å†…åšä¸€æ¬¡å…³äº gRPC çš„çŸ¥è¯†åˆ†äº«ï¼Œè€Œé‚£æ¬¡æˆ‘èŠ±äº† 2 å‘¨å¤šçš„æ—¶é—´å»äº†è§£å»èƒŒåçš„åŸç†ã€å®ç°ã€æ•°æ®æµå‘ã€‚é‚£æ—¶å€™æˆ‘è®°å¾—æ˜¯ç™½ç­åˆ†äº«æ²¡æœ‰å†™ PPTï¼Œæ‰€ä»¥é‚£æ—¶å€™å¯¹è¿™äº›çŸ¥è¯†ç‚¹æœ‰äº†æ¯”è¾ƒæ·±åˆ»çš„ç†è§£ã€‚ ç„¶è€Œï¼Œæˆ‘ä¸Šå®¶æˆ‘æ‰€åœ¨éƒ¨é—¨çš„ä¸šåŠ¡å‡ ä¹æ²¡æœ‰æ¶‰åŠåˆ° gRPC çš„å¼€å‘ï¼Œå› æ­¤è¿™äº›ç†è§£åªæ˜¯å˜æˆä¸€ä¸ªçŸ¥é“çš„æ¦‚å¿µï¼Œå¹¶æ²¡æœ‰åœ¨å®é™…å¼€å‘å·¥ä½œä¸­æåˆ°å®é™…çš„åº”ç”¨ã€‚ä½†æ˜¯ä»é‚£æ¬¡åˆ†äº«åï¼Œæˆ‘å¯¹ gRPC æœ‰äº†ä¸€äº›è¿·æ‹ç°è±¡ï¼Œæƒ³åšä¸€äº›å®é™…çš„ gRPC ç›¸å…³é¡¹ç›®ï¼Œä»å®é™…é¡¹ç›®ä¸­æç‚¼è‡ªå·±çš„çŸ¥è¯†é¢ã€‚ åˆ°ç°åœ¨ï¼Œæˆ‘å›è¿‡å¤´æ¥çœ‹ï¼Œå·²ç»å‚ä¸äº†å‡ ä¸ªåŸºäº gRPC é€šä¿¡çš„é¡¹ç›®ä»¥åŠåŸºäº gRPC çš„å¾®æœåŠ¡æ¡†æ¶ï¼Œæœ€è¿‘ä¹Ÿåœ¨å†™ä¸€ä¸ªæ¯”è¾ƒå®Œæ•´çš„å¾®æœåŠ¡é¡¹ç›®ï¼Œä¹Ÿæ˜¯åŸºäº gRPC é€šä¿¡ã€‚çš„ç¡®ä»å®è·µä¸­æç‚¼åˆ°äº†ä¸€å®šçš„çŸ¥è¯†ï¼Œè‡ªå·±å¯¹æ•´ä½“çš„ç†è§£ä¹Ÿæœ‰äº†ä¸€å®šçš„æå‡ã€‚ ä»Šå¤©æƒ³å†™è¿™ç¯‡æ–‡ç« çš„åŸå› æœ‰ä¸¤ä¸ªï¼Œå…¶ä¸€æ˜¯æˆ‘å‰å‰ååå¯¹ gRPC æœ‰äº†å¾ˆå¤šçš„äº¤é›†å¹¶ä¸”ä¹Ÿåœ¨ä¸Šå®¶æåŠ›æ¨èä½¿ç”¨ï¼ˆä½†æ˜¯èƒ½åŠ›ä¸å¤Ÿï¼Œæ²¡èƒ½æ¨å¹¿èµ·æ¥ï¼‰ï¼Œæˆ‘å¯¹è¿™å—æœ‰äº†ä¸€äº›è‡ªå·±çš„çœ‹æ³•å’Œè§‚ç‚¹ï¼Œä½†æ˜¯ä¸€ç›´æ²¡æœ‰ä¸€ä¸ªæ¯”è¾ƒå®Œæ•´çš„è®°å½•ã€‚å…¶äºŒæ˜¯ä¹‹å‰ä¸å¤§å­¦åŒå­¦åšä¸€æ¬¡çº¿ä¸Šåˆ†äº«çš„æ—¶å€™ï¼Œæœ‰äººæé—®å…³äº gRPC çš„æ€§èƒ½é—®é¢˜ï¼ˆç”±äºå…¶åŸºäº HTTP/2,æ‰€ä»¥å¯¹å…¶æ€§èƒ½æŒæ€€ç–‘æ€åº¦ï¼‰ï¼Œæˆ‘è§‰å¾—è¿™ä¸ªé—®é¢˜ç¡®å®ä¹Ÿæ˜¯éœ€è¦ä¸€ä¸ªæ·±ç©¶çš„é—®é¢˜ï¼Œæ‰€ä»¥è¿™ç¯‡æ–‡ç« ä¹Ÿä¼šæåˆ°ç›¸å…³å†…å®¹ã€‚ å› æ­¤ï¼Œè¿™ç¯‡æ–‡ä»¶å°†ä¼šä» gRPC çš„åŸºæœ¬æ¦‚å¿µã€gRPC çš„ä½¿ç”¨ã€gRPC çš„ç¼–ç¨‹æ¨¡å‹ã€gRPC çš„ç¼–ç¨‹æ¨¡å‹çš„å®ç°ã€gRPC çš„ç¼–ç¨‹æ¨¡å‹çš„å®ç°çš„ç»†èŠ‚ç­‰å¤šä¸ªè§’åº¦æ¥ä¸€ä¸€è¿›è¡Œè®²è§£ï¼Œç»™è‡ªå·±ä¸€ä¸ªæ€»ç»“ï¼Œç»™å¯¹è¿™æ–¹é¢æœ‰ç–‘é—®çš„åŒå­¦ä¸€å®šçš„å¸®åŠ©ã€‚ æ³¨æ„ æœ¬ç¯‡æ‰€æœ‰çš„ç¤ºä¾‹ä»£ç å‡ç”¨ Go æœ¬ç¯‡å®Œå…¨ä»¥ä¸ªäººçš„ç†è§£å’Œå®˜æ–¹æ–‡æ¡£ä¸ºå‡†ï¼Œè‹¥æœ‰é”™è¯¯ä¸å‡†ä¹‹å¤„ï¼Œè¯·å¸®å¿™æ”¯æŒè¯„è®ºä¸€ä¸‹ï¼Œè°¢è°¢ï¼ ","date":"2022-06-29","objectID":"/posts/microservices-grpc-part1/:1:0","tags":["å¾®æœåŠ¡","ç³»åˆ—ç¯‡","grpc"],"title":"[ç³»åˆ—]å¾®æœåŠ¡Â·æ·±å…¥äº†è§£gRPC Part1","uri":"/posts/microservices-grpc-part1/"},{"categories":["microservice"],"content":"2. gRPC çš„åŸºæœ¬æ¦‚å¿µ Definition by official gRPC is a modern open source high performance Remote Procedure Call (RPC) framework that can run in any environment. It can efficiently connect services in and across data centers with pluggable support for load balancing, tracing, health checking and authentication. It is also applicable in last mile of distributed computing to connect devices, mobile applications and browsers to backend services. ç®€å•æ¥è¯´ï¼ŒgRPC æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„è¿œç¨‹è¿‡ç¨‹è°ƒç”¨æ¡†æ¶ï¼Œå¯ä»¥åœ¨ä»»ä½•ç¯å¢ƒä¸­è¿è¡Œï¼Œå¯ä»¥åœ¨æ•°æ®ä¸­å¿ƒä¹‹é—´é«˜æ•ˆåœ°è¿æ¥æœåŠ¡ï¼Œå¹¶ä¸”æ”¯æŒè´Ÿè½½å‡è¡¡ã€è·Ÿè¸ªã€å¥åº·æ£€æŸ¥å’Œèº«ä»½éªŒè¯ã€‚å®ƒè¿˜é€‚ç”¨äºåˆ†å¸ƒå¼è®¡ç®—ï¼Œå°†è®¾å¤‡ã€ç§»åŠ¨åº”ç”¨å’Œæµè§ˆå™¨è¿æ¥åˆ°åç«¯æœåŠ¡ã€‚ gRPC æ˜¯ç”± CNCF å­µåŒ–çš„é¡¹ç›®,ç›®å‰åœ¨ GitHub ä¸Šæœ‰ 43.8k çš„ star å’Œ 9.2k çš„ forkã€‚gRPC æœ‰ä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒç‰¹ç‚¹ï¼š ç®€å•çš„æœåŠ¡å®šä¹‰ã€‚é€šè¿‡ Protocol Buffer å»å®šä¹‰æ•°æ®ç»“æ„å’ŒæœåŠ¡çš„æ¥å£ (å…³äº pb æ›´è¯¦ç»†çš„ä»‹ç»è¯·æŸ¥è¿™ç¯‡ï¼š[ç³»åˆ—]å¾®æœåŠ¡Â·å¦‚ä½•é€šè¿‡ protobuf å®šä¹‰æ•°æ®å’ŒæœåŠ¡)ã€‚ å¿«é€Ÿä½¿ç”¨ã€‚ä»…é€šè¿‡ä¸€è¡Œä»£ç å°±è¿›è¡ŒæœåŠ¡æ³¨å†Œå’Œè¿œç¨‹è°ƒç”¨ã€‚ è·¨è¯­è¨€å’Œå¹³å°ã€‚gRPC æ”¯æŒä¼—å¤šä¸»æµè¯­è¨€ï¼Œå¯ä»¥åœ¨ä¸åŒè¯­è¨€ä¹‹é—´æ— ç¼è¿œç¨‹è°ƒç”¨ä¸”å‡å¯é€šè¿‡ pb ç”Ÿæˆå¯¹åº”è¯­è¨€çš„ç›¸å…³ä»£ç ã€‚ æ”¯æŒåŒå‘æµã€‚gRPC æ”¯æŒåŸºäº HTTP/2 çš„åŒå‘æµï¼Œå³å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å‡å¯ä»¥å‘å¯¹æ–¹è¯»å†™æµæ•°æ®ã€‚ æ’ä»¶åŒ–ã€‚å†…ç½®å¯æ’æ‹”çš„è´Ÿè½½å‡è¡¡ã€è·Ÿè¸ªã€å¥åº·æ£€æŸ¥å’Œèº«ä»½éªŒè¯æ’ä»¶ã€‚ å¾®æœåŠ¡ã€‚gRPC éå¸¸é€‚åˆå¾®æœåŠ¡æ¡†æ¶ï¼Œä¸”æœ‰ä¼—å¤šå¾®æœåŠ¡æ¡†æ¶å‡æ”¯æŒ gRPCã€‚ é«˜æ€§èƒ½ã€‚å¾—ç›Šäº HTTP/2 çš„é“¾è·¯å¤ç”¨èƒ½åŠ›ï¼ŒgRPC å¯ä»¥åœ¨åŒä¸€ä¸ªè¿æ¥ä¸ŠåŒæ—¶å¤„ç†å¤šä¸ªè¯·æ±‚ï¼ŒåŒæ—¶å¾—ç›Šäº pb ä¸ºç¼–ç å‡ºåŒ…æ›´å¿«æ›´å°çš„äºŒè¿›åˆ¶æ•°æ®åŒ…ï¼Œä»è€Œæé«˜äº†æ€§èƒ½ã€‚ è¿™äº›ç‰¹æ€§ä½¿å¾— gRPC åœ¨å¾®æœåŠ¡æ¶æ„ä¸­çš„åº”ç”¨éå¸¸å¹¿æ³›ã€‚ä»¥ Go è¯­è¨€ä¸ºä¾‹ï¼Œä¸»æµçš„å¾®æœåŠ¡æ¡†æ¶ go-micro, go-zero, go-kit, kratos ç­‰éƒ½æ˜¯é»˜è®¤æ”¯æŒ gRPC çš„ã€‚ ","date":"2022-06-29","objectID":"/posts/microservices-grpc-part1/:2:0","tags":["å¾®æœåŠ¡","ç³»åˆ—ç¯‡","grpc"],"title":"[ç³»åˆ—]å¾®æœåŠ¡Â·æ·±å…¥äº†è§£gRPC Part1","uri":"/posts/microservices-grpc-part1/"},{"categories":["microservice"],"content":"3. gRPC çš„ä½¿ç”¨ ","date":"2022-06-29","objectID":"/posts/microservices-grpc-part1/:3:0","tags":["å¾®æœåŠ¡","ç³»åˆ—ç¯‡","grpc"],"title":"[ç³»åˆ—]å¾®æœåŠ¡Â·æ·±å…¥äº†è§£gRPC Part1","uri":"/posts/microservices-grpc-part1/"},{"categories":["microservice"],"content":"3.1 ç”Ÿæˆ gRPC ä»£ç  åœ¨ proto æ–‡ä»¶å®šä¹‰æœåŠ¡åï¼Œæˆ‘ä»¬é€šè¿‡ protoc å·¥å…·ç”Ÿæˆ gRPC çš„ä»£ç ã€‚æ­¤æ—¶éœ€è¦åœ¨ç”Ÿæˆå‘½ä»¤ä¸­æ·»åŠ  --go-grpc_out å‚æ•°æ¥æŒ‡å®šç”Ÿæˆä»£ç çš„è·¯å¾„å’Œå…¶ä»–å‚æ•°ã€‚ä»¥ä¸‹é¢çš„ç®€å• proto æ–‡ä»¶ä¸ºä¾‹ï¼š // ä¸ºäº†æ¼”ç¤ºï¼Œè¿™é‡Œè¿”å›å€¼å®šä¹‰ä¸ºç©ºçš„ç»“æ„ message Empty { } // å®šä¹‰æœåŠ¡å’Œå…¶æ–¹æ³• // ä¸ºç¡®ä¿ç”Ÿæˆçš„ä»£ç å°½é‡ç®€å•ï¼Œæˆ‘ä»¬åªå®šä¹‰äº†ä¸¤ä¸ªæ–¹æ³• service OrderService { rpc GetOrder(Empty) returns (Empty) {} rpc CreateOrder(Empty) returns (Empty) {} } æˆ‘ä»¬æ‰§è¡Œ protoc --go_out=paths=source_relative:. --go-grpc_out=paths=source_relative:. proto_file å‘½ä»¤ï¼Œç”Ÿæˆä»£ç åï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨å½“å‰ç›®å½•ä¸‹ä¼šç”Ÿæˆä¸¤ä¸ªæ–‡ä»¶ï¼Œåˆ†åˆ«æ˜¯ order_service.pb.go å’Œ order_service_grpc.pb.goã€‚ç¬¬ä¸€ä¸ªæ–‡ä»¶åŒ…å«å®šä¹‰çš„ enum, message ä»¥åŠ pb æ–‡ä»¶çš„ä¿¡æ¯æ‰€å¯¹åº”çš„ Go ä»£ç ï¼Œç¬¬äºŒä¸ªæ–‡ä»¶åŒ…å«å®šä¹‰çš„ service æ‰€å¯¹åº”çš„ Go ä»£ç ã€‚æœ¬ç¯‡ä¸è®¨è®ºç¬¬ä¸€ä¸ªæ–‡ä»¶å†…å®¹ã€‚æˆ‘ä»¬ç°åœ¨æ¥çœ‹ä¸€ä¸‹ order_service_grpc.pb.go æ–‡ä»¶å’Œæ ¸å¿ƒå†…å®¹ï¼ˆç¯‡å¹…åŸå› ä¼šå¿½ç•¥ä¸€äº›éå¿…è¦ä»£ç çš„å±•ç¤ºï¼‰ã€‚ 3.1.1 å®¢æˆ·ç«¯ç›¸å…³ä»£ç  å®¢æˆ·ç«¯ä»£ç ç›¸å¯¹æ¥è¯´æ¯”è¾ƒç®€å•å¥½ç†è§£ï¼Œå®šäº† OrderServiceClient ä¹‹åå®ç°è¿™ä¸ªæ¥å£ï¼Œè€Œæ˜¾ç¤ºæ–¹å¼å°±æ˜¯é€šè¿‡ gRPC è¿æ¥å»è°ƒç”¨æœåŠ¡ç«¯çš„ OrderService æœåŠ¡çš„å¯¹åº”çš„æ–¹æ³•ã€‚æˆ‘ä»¬çœ‹çš„ç±»ä¼¼è¿™ç§ /api.user.session.v1.OrderService/GetOrder å­—ç¬¦ä¸²å¯ä»¥ç†è§£ä¸ºè·¯ç”±åœ°å€ï¼Œserver ç«¯ä»£ç ç”Ÿæˆæ—¶ä¼šå°†åŒæ ·çš„å­—ç¬¦ä¸²ä¸å…¶å¯¹åº”çš„æ–¹æ³•å…±åŒæ³¨å†Œä¸Šå»ï¼Œä»è€Œç¡®å®šå”¯ä¸€çš„æ–¹æ³•ã€‚ type OrderServiceClient interface { GetOrder(ctx context.Context, in *Empty, opts ...grpc.CallOption) (*Empty, error) CreateOrder(ctx context.Context, in *Empty, opts ...grpc.CallOption) (*Empty, error) } type orderServiceClient struct { cc grpc.ClientConnInterface } func NewOrderServiceClient(cc grpc.ClientConnInterface) OrderServiceClient { return \u0026orderServiceClient{cc} } func (c *orderServiceClient) GetOrder(ctx context.Context, in *Empty, opts ...grpc.CallOption) (*Empty, error) { out := new(Empty) err := c.cc.Invoke(ctx, \"/api.user.session.v1.OrderService/GetOrder\", in, out, opts...) if err != nil { return nil, err } return out, nil } func (c *orderServiceClient) CreateOrder(ctx context.Context, in *Empty, opts ...grpc.CallOption) (*Empty, error) { out := new(Empty) err := c.cc.Invoke(ctx, \"/api.user.session.v1.OrderService/CreateOrder\", in, out, opts...) if err != nil { return nil, err } return out, nil } æˆ‘ä»¬åœ¨è‡ªå·±ç¨‹åºå†…å¦‚æœéœ€è¦è°ƒç”¨ç¬¬ä¸‰æ–¹æœåŠ¡çš„è¯ï¼Œåªéœ€è¦é€šè¿‡ NewOrderServiceClient å‡½æ•°ç”Ÿæˆ OrderServiceClient å®ä¾‹ï¼Œç„¶åè°ƒç”¨å¯¹åº”çš„æ–¹æ³•å³å¯ã€‚å¦‚ï¼š // conn ä¸º grpc connectionï¼Œå¯ä»¥é€šè¿‡ grpc.Dial æ¥ç”Ÿæˆæˆ–å¤§éƒ¨åˆ†å¾®æœåŠ¡æ¡†æ¶éƒ½æä¾›äº†è¿æ¥æ–¹æ³• resp,err := NewOrderServiceClient(conn).GetOrder(context.Background(), \u0026Empty{}) if err != nil { fmt.Println(err) } // end of rpc call, do own biz 3.1.2 æœåŠ¡ç«¯ç›¸å…³ä»£ç  æœåŠ¡ç«¯ä»£ç ç›¸å¯¹å®¢æˆ·ç«¯ä»£ç ä¼šå¤šä¸€äº›ï¼Œç”Ÿæˆä»£ç åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†æ˜¯å®šä¹‰ interface ç„¶åç”±ä¸€ä¸ªé»˜è®¤å®ç°ç±»æ¥å®ç°ï¼Œå¦ä¸€éƒ¨åˆ†æ˜¯æä¾›æ³¨å†Œå®ç°æ¥å£çš„æ–¹æ³•ã€‚å› ä¸ºæˆ‘ä»¬éœ€è¦è‡ªå·±å»å®ç°å®šä¹‰çš„æœåŠ¡é€»è¾‘ï¼Œç„¶åæ³¨å†Œä¸Šå»ï¼Œè¿™æ ·æ‰èƒ½è®©å®¢æˆ·ç«¯è°ƒç”¨ã€‚ ç¬¬ä¸€éƒ¨åˆ†ä»£ç ï¼š // OrderServiceServer is the server API for OrderService service. // All implementations must embed UnimplementedOrderServiceServer // for forward compatibility // è¿™é‡Œéœ€è¦è¯´æ˜ä¸€ä¸‹ï¼Œä¸ºäº†ç¡®ä¿æœåŠ¡çš„ç¨³å®šæ€§ï¼Œå®ç°è¯¥æ¥å£çš„ç»“æ„å¿…éœ€åŒ…å« UnimplementedOrderServiceServerï¼Œè¿™æ ·å³ä¾¿æˆ‘ä»¬åªå®ç°å…¶ä¸­ä¸€éƒ¨åˆ†çš„æ–¹æ³•ï¼Œä¹Ÿä¸ä¼šå¯¼è‡´æœåŠ¡å´©æºƒæˆ–ä¸å¯ç”¨ã€‚ type OrderServiceServer interface { GetOrder(context.Context, *Empty) (*Empty, error) CreateOrder(context.Context, *Empty) (*Empty, error) mustEmbedUnimplementedOrderServiceServer() } // UnimplementedOrderServiceServer must be embedded to have forward compatible implementations. type UnimplementedOrderServiceServer struct { } func (UnimplementedOrderServiceServer) GetOrder(context.Context, *Empty) (*Empty, error) { return nil, status.Errorf(codes.Unimplemented, \"method GetOrder not implemented\") } func (UnimplementedOrderServiceServer) CreateOrder(context.Context, *Empty) (*Empty, error) { return nil, status.Errorf(codes.Unimplemented, \"method CreateOrder not implemented\") } func (UnimplementedOrderServiceServer) mustEmbedUnimplementedOrderServiceServer() {} // UnsafeOrderServiceServer may be embedded to opt out of forward compatibility for this service. // Use of this interface is not recommended, as added methods to OrderServiceServer will // result in compilation errors. type UnsafeOrderServiceServer interface { mustEmbedUnimplementedOrderServiceServer() } ç¬¬äºŒéƒ¨åˆ†ä»£ç ï¼š // è¿™é‡Œæ˜¯æˆ‘ä»¬å¤–éƒ¨æ³¨å†Œå…¥å£ func RegisterOrderServiceServer(s grpc.ServiceRegistrar, srv OrderServiceServer) { s.RegisterService(\u0026OrderService_ServiceDesc, srv) } // æ¯ä¸ªæ¥å£çš„å¤„ç†æ–¹æ³•ï¼Œå†…éƒ¨è°ƒç”¨çš„æ˜¯è¿™ä¸ªæ–¹æ³• func _OrderService_GetOrder_Handler(srv interface{}, ctx context.Context, dec func(interface{}) error, interceptor grpc.UnaryServerInterceptor) (interface{}, error) { in := new(Empty) if err := dec(in); err != nil { return nil, err } if interceptor == nil { return sr","date":"2022-06-29","objectID":"/posts/microservices-grpc-part1/:3:1","tags":["å¾®æœåŠ¡","ç³»åˆ—ç¯‡","grpc"],"title":"[ç³»åˆ—]å¾®æœåŠ¡Â·æ·±å…¥äº†è§£gRPC Part1","uri":"/posts/microservices-grpc-part1/"},{"categories":["microservice"],"content":"4. gRPC çš„ç¼–ç¨‹æ¨¡å‹ grpc ç¼–ç¨‹æ¨¡å‹å¯ä»¥ä»å¤§ä½“ä¸Šåˆ†ä¸ºä¸¤ç§æƒ…å†µï¼Œåˆ†åˆ«æ˜¯åº”ç­”æ¨¡å¼ï¼Œæ•°æ®æµæ¨¡å¼ã€‚åº”ç­”æ¨¡å¼æ˜¯æŒ‡å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªè¯·æ±‚ï¼ŒæœåŠ¡ç«¯è¿”å›ä¸€ä¸ªå“åº”ï¼ˆå¸¸è§çš„ http request-response æ¨¡å¼ï¼‰ï¼Œç„¶åè¿™æ¬¡è¯·æ±‚å®Œæˆã€‚è€Œæ•°æ®æµæ¨¡å¼æ˜¯å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å…¶ä¸­ä¸€æ–¹ä»¥æµçš„å½¢å¼æŒç»­è¯»/å†™æ•°æ®ï¼ˆä¹Ÿå¯èƒ½åŒæ–¹éƒ½æ˜¯æŒç»­è¯»å†™ï¼ŒåŒå‘æµï¼‰ï¼Œå¦ä¸€æ–¹åªéœ€è¦ä¸€æ¬¡è¯·æ±‚æˆ–å“åº”ï¼ˆå¦‚æœæ˜¯åŒå‘æµåˆ™å‡å¯ä»¥å¤šæ¬¡è¯»å†™ï¼‰ã€‚ ","date":"2022-06-29","objectID":"/posts/microservices-grpc-part1/:4:0","tags":["å¾®æœåŠ¡","ç³»åˆ—ç¯‡","grpc"],"title":"[ç³»åˆ—]å¾®æœåŠ¡Â·æ·±å…¥äº†è§£gRPC Part1","uri":"/posts/microservices-grpc-part1/"},{"categories":["microservice"],"content":"4.1 åº”ç­”æ¨¡å¼ è¿™ä¸ªæ¨¡å¼å±äºæ˜¯æœ€å¸¸è§å¤§å®¶æœ€ç†Ÿæ‚‰çš„ä¸€ç§æ¨¡å¼ï¼Œåœ¨æˆ‘ä»¬å®šä¹‰æœåŠ¡çš„æ–¹æ³•çš„æ—¶å€™ä¹Ÿæ˜¯åŸºæœ¬ç”¨çš„æ˜¯åº”ç­”æ¨¡å¼ã€‚æˆ‘ä»¬ä¸Šé¢æåˆ°çš„ GetOrder æ–¹æ³•ï¼Œå°±æ˜¯ä¸€ä¸ªåº”ç­”æ¨¡å¼çš„ä¾‹å­ã€‚è¯·æ±‚æ—¶æ„é€ è¾“å…¥å‚æ•°ï¼Œç„¶åç­‰åˆ°å“åº”è¿”å›ï¼Œç„¶åç»“æŸè¿™æ¬¡è¿œç¨‹è°ƒç”¨ï¼Œè¿™å°±æ˜¯åº”ç­”æ¨¡å¼ã€‚ 4.1.1 ä½¿ç”¨ è¯¥æ–¹å¼çš„ä½¿ç”¨æˆ‘ä»¬åœ¨ä¸Šé¢å…¶å®å·²ç»æ¼”ç¤ºè¿‡äº†ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚ç‚¹å‡»è¿™é‡Œè·³å›æŸ¥çœ‹ 4.1.2 å®ç° ä¸€æ¬¡å®¢æˆ·ç«¯è¿œç¨‹è°ƒç”¨æœåŠ¡ç«¯æ–¹æ³•çš„æµç¨‹æ­¥éª¤å¤§ä½“å¦‚ä¸‹ï¼š å®¢æˆ·ç«¯è°ƒç”¨å¯¹åº”çš„ Client æ–¹æ³• client æ–¹æ³•å®ç°å†…è°ƒç”¨ invoke æ–¹æ³• å¹¶å¸¦ä¸Šå¯¹åº”çš„ method å’Œå…¶ä»–å‚æ•° invoke æ–¹æ³•å†…æ€»å…±åˆ†ä¸‰æ­¥ï¼š åˆ›å»ºä¸€ä¸ª ClientStream å¯¹è±¡ï¼Œåˆå§‹åŒ–è¯·æ±‚éœ€è¦çš„å‚æ•°ï¼Œç¡®å®šè¯·æ±‚ endpoint åœ°å€ï¼Œåˆå§‹åŒ– buffer sizeï¼Œè·å– http2 transport å¯¹è±¡ç­‰ è°ƒç”¨ ClientStream.SendMsq æ–¹æ³•ã€‚é¦–å…ˆåˆå§‹åŒ–è¯·æ±‚ header, payload å’Œ dataï¼Œ ç„¶åè°ƒç”¨ http2 client çš„ Write æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ˜¯å¼‚æ­¥å¤„ç†è¯·æ±‚çš„ï¼Œä¼šæŠŠ send request å†™å…¥åˆ°ä¸€ä¸ªå•å‘é“¾è¡¨å†…ï¼Œç„¶åç”±ä¸€ä¸ªå•ç‹¬çš„ goroutine å»æ¶ˆè´¹è¿™ä¸ªé“¾è¡¨ä¸Šçš„æ•°æ®ï¼Œç„¶åæ‰¹é‡å†™å…¥åˆ° socket ä¸­ã€‚ write: // Write formats the data into HTTP2 data frame(s) and sends it out. The caller // should proceed only if Write returns nil. func (t *http2Client) Write(s *Stream, hdr []byte, data []byte, opts *Options) error { if opts.Last { // If it's the last message, update stream state. if !s.compareAndSwapState(streamActive, streamWriteDone) { return errStreamDone } } else if s.getState() != streamActive { return errStreamDone } df := \u0026dataFrame{ streamID: s.id, endStream: opts.Last, h: hdr, d: data, } if hdr != nil || data != nil { // If it's not an empty data frame, check quota. if err := s.wq.get(int32(len(hdr) + len(data))); err != nil { return err } } // controlBuf åº•å±‚ä¸ºä¸€ä¸ªç¼“å†²åŒºï¼Œç”¨äºå­˜å‚¨æ§åˆ¶æ•°æ®ï¼Œæ¯”å¦‚ header å’Œ dataã€‚åŸºäºå•å‘é“¾è¡¨å®ç° return t.controlBuf.put(df) } // writeLoop å†…éƒ¨è°ƒç”¨ write æ–¹æ³•ï¼Œå¾ªç¯å‘é€æ•°æ® read from buf and write to socket: // è¿™æ®µæ³¨é‡Šå…¶å®å†™çš„å¾ˆè¯¦ç»†äº†ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œçš„ writeLoop å†…éƒ¨è°ƒç”¨äº† write æ–¹æ³•ï¼Œç„¶åå†è°ƒç”¨äº†ä¸€ä¸ªå•ç‹¬çš„ goroutineï¼Œè¿™ä¸ª goroutine å°± // æ˜¯ä¸€ä¸ªå•å‘é“¾è¡¨çš„æ¶ˆè´¹è€…ï¼Œç›´åˆ°é“¾è¡¨ä¸ºç©ºï¼Œç„¶åå†ä¸€æ¬¡æ€§å†™å…¥åˆ° socket ä¸­ã€‚ // run should be run in a separate goroutine. // It reads control frames from controlBuf and processes them by: // 1. Updating loopy's internal state, or/and // 2. Writing out HTTP2 frames on the wire. // // Loopy keeps all active streams with data to send in a linked-list. // All streams in the activeStreams linked-list must have both: // 1. Data to send, and // 2. Stream level flow control quota available. // // In each iteration of run loop, other than processing the incoming control // frame, loopy calls processData, which processes one node from the activeStreams linked-list. // This results in writing of HTTP2 frames into an underlying write buffer. // When there's no more control frames to read from controlBuf, loopy flushes the write buffer. // As an optimization, to increase the batch size for each flush, loopy yields the processor, once // if the batch size is too low to give stream goroutines a chance to fill it up. func (l *loopyWriter) run() (err error) { defer func() { if err == ErrConnClosing { // Don't log ErrConnClosing as error since it happens // 1. When the connection is closed by some other known issue. // 2. User closed the connection. // 3. A graceful close of connection. if logger.V(logLevel) { logger.Infof(\"transport: loopyWriter.run returning. %v\", err) } err = nil } }() for { it, err := l.cbuf.get(true) if err != nil { return err } if err = l.handle(it); err != nil { return err } if _, err = l.processData(); err != nil { return err } gosched := true hasdata: for { it, err := l.cbuf.get(false) if err != nil { return err } if it != nil { // æ ¹æ®æ•°æ®ç±»å‹åšä¸åŒçš„å¤„ç† // å¦‚æœæ˜¯stream dataï¼Œåˆ™ä¼šæŠŠæ•°æ®å†™å…¥åˆ° loopWriter çš„ activeStreams ä¸­ï¼Œ ä¹Ÿæ˜¯ä¸ªå•å‘é“¾è¡¨ if err = l.handle(it); err != nil { return err } // ä» activeStreams ä¸­è¯»å–ä¸€ä¸ªæ•°æ® ç„¶åæŠŠæ•°æ®å†™å…¥åˆ° loopWriter çš„ frameBuf ä¸­ // è¯¥æ–¹æ³•çš„ç¬¬ä¸€å‚æ•°ä¸º boolï¼Œå½“ activeStreams ä¸ºç©ºæ˜¯è¿”å›trueï¼Œå¦åˆ™è¿”å›false if _, err = l.processData(); err != nil { return err } // è¯»å®Œè¯»å–ä¸‹ä¸€ä¸ª continue hasdata } isEmpty, err := l.processData() if err != nil { return err } // activeStreams ä¸­ä¾ç„¶æœ‰æ•°æ®è¿˜æ²¡ process if !isEmpty { continue hasdata } if gosched { gosched = false // å¦‚æœå½“å‰å¤„ç†çš„æ•°æ®å¤§å°å°äº minBatchSizeï¼ˆ1000ï¼‰ï¼Œåˆ™ä¼‘çœ ä¸€ä¸‹ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡çš„æ•°æ® if l.framer.writer.offset \u003c minBatchSize { runtime.Gosched() continue hasdata } } // æ•°æ® flush åˆ° socket l.framer.writer.Flush() break hasdata } } } è°ƒç”¨ ClientStream.RecvMsg æ–¹æ³•ã€‚è¯¥æ–¹æ³•ä¼šå…ˆå“åº”çš„ header æ¶ˆæ¯ï¼Œä» header è¯»å–æ•°æ® encodingï¼Œç„¶åæ ¹æ® encoding è¯»å–æ•°æ®è§£å‹æ•°æ®ï¼Œå¹¶æŠŠæ•°æ®ç»‘å®šåˆ°è¿™æ¬¡è¯·æ±‚å“åº”çš„ pb message ç»“æ„ä¸Šã€‚æœ€åä¼šè°ƒç”¨ ClientStream.finish æ–¹æ³•ï¼Œè¡¨ç¤ºç»“æŸè¯¥è¯·æ±‚ã€‚ å®¢æˆ·ç«¯è¯·æ±‚æµç¨‹(ç‚¹å‡»æ”¾å¤§) ä¸€æ¬¡æœåŠ¡ç«¯æ”¶åˆ°ä¸€ä¸ªè¯·æ±‚ï¼Œç„¶åå¤„ç†å®Œå“åº”å›å»çš„æµç¨‹æ˜¯è¿™æ ·çš„ï¼š grpc æœåŠ¡å¯åŠ¨ï¼Œå¼€å§‹ç›‘å¬ç«¯å£ net.Li","date":"2022-06-29","objectID":"/posts/microservices-grpc-part1/:4:1","tags":["å¾®æœåŠ¡","ç³»åˆ—ç¯‡","grpc"],"title":"[ç³»åˆ—]å¾®æœåŠ¡Â·æ·±å…¥äº†è§£gRPC Part1","uri":"/posts/microservices-grpc-part1/"},{"categories":["microservice"],"content":"5. æ€»ç»“ ç”±äºç¯‡å¹…åŸå› ï¼Œæœ¬ç¯‡å°†åœ¨è¿™é‡Œç»“æŸï¼Œå…³äº grpc çš„æ•°æ®æµå˜æˆæ¨¡å¼å’Œç›¸å…³å®ç°ä»¥åŠå…¶ä»–æ›´å¤šå…³äº grpc çš„å†…å®¹ï¼Œè¯·æŒç»­å…³æ³¨ï¼Œæˆ‘ä¼šåœ¨ä¸‹ä¸€ç¯‡ä¸­è¿›è¡Œè¯¦ç»†çš„ä»‹ç»ã€‚ æœ¬ç¯‡ä¸»è¦è®²è¿°äº†ï¼š grpc çš„æ¦‚å¿µ grpc åœ¨ go è¯­è¨€ç¯å¢ƒä¸‹çš„ä½¿ç”¨ grpc çš„å¸¸è§ç¼–ç¨‹æ¨¡å¼ä¹‹ä¸€çš„åº”ç­”æ¨¡å¼çš„ä½¿ç”¨å’Œå®ç°æºç è§£æ ","date":"2022-06-29","objectID":"/posts/microservices-grpc-part1/:5:0","tags":["å¾®æœåŠ¡","ç³»åˆ—ç¯‡","grpc"],"title":"[ç³»åˆ—]å¾®æœåŠ¡Â·æ·±å…¥äº†è§£gRPC Part1","uri":"/posts/microservices-grpc-part1/"},{"categories":["microservice"],"content":" æœ¬æ–‡ä¸ºç³»åˆ—ç¯‡å¾®æœåŠ¡çš„å…³äº protobuf å®šä¹‰æ•°æ®å’ŒæœåŠ¡çš„æ–‡ç« ã€‚æœ¬ç¯‡å°†ä¼šä»‹ç»å¦‚ä½•é€šè¿‡ pb å®šä¹‰æ•°æ®ç»“æ„å’ŒæœåŠ¡ä»¥åŠ pb çš„ä¸€äº›å¦ç±»ç©æ³•ã€‚ ","date":"2022-06-15","objectID":"/posts/microservices-protobuf/:0:0","tags":["å¾®æœåŠ¡","ç³»åˆ—ç¯‡","protobuf","grpc"],"title":"[ç³»åˆ—]å¾®æœåŠ¡Â·å¦‚ä½•é€šè¿‡ protobuf å®šä¹‰æ•°æ®å’ŒæœåŠ¡","uri":"/posts/microservices-protobuf/"},{"categories":["microservice"],"content":"1. å‰è¨€ Definition by Google Protocol buffers provide a language-neutral, platform-neutral, extensible mechanism for serializing structured data in a forward-compatible and backward-compatible way. Itâ€™s like JSON, except itâ€™s smaller and faster, and it generates native language bindings. Protocol buffers are a combination of the definition language (created in .proto files), the code that the proto compiler generates to interface with data, language-specific runtime libraries, and the serialization format for data that is written to a file (or sent across a network connection). Protocol buffer(ä¸‹é¢ä½¿ç”¨ pb æ¥ä»£æ›¿) æ˜¯ä¸€ä¸ª æ¥å£å®šä¹‰è¯­è¨€(Interface Definition Language -- IDL)å’Œæ¶ˆæ¯ç¼–ç æ ¼å¼ã€‚æ—¨åœ¨æä¾›ä¸€ç§ç®€å•ã€æ˜“äºä½¿ç”¨ã€å¯æ‰©å±•çš„æ–¹å¼æ¥å®šä¹‰æ•°æ®ç»“æ„å’ŒæœåŠ¡ã€‚pb æ˜¯ä¸€ç§çº¯æ–‡æœ¬æ ¼å¼ï¼Œè€Œå…¶å†…éƒ¨æ˜¯çº¯äºŒè¿›åˆ¶æ ¼å¼ï¼Œæ¯”å…¶ä»–ç¼–ç æ ¼å¼(å¦‚ï¼šjsonï¼Œxml)æ›´åŠ ç²¾ç‚¼ã€‚pb åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªæ¶ˆæ¯ç±»å‹ï¼Œæ¯ä¸ªæ¶ˆæ¯ç±»å‹åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªå­—æ®µã€‚å…¶ä¸»è¦ç‰¹æ€§ä¸ºï¼š ç¼–ç é€Ÿåº¦å¿« ç¼–ç åæ•°æ®æ›´å° æ ¹æ® pb ç”Ÿæˆå„ä¸ªè¯­è¨€ä»£ç (æœ¬æ–‡ä»¥ Go ä¸ºä¾‹) æ”¯æŒç±»å‹å®šä¹‰ æ”¯æŒå®šä¹‰æœåŠ¡ è¯­æ³•ç®€å• è€Œ gRPC ä½œä¸º Google æ¨å‡ºçš„ rpc åè®®ï¼Œå°† pb ä½œä¸ºé»˜è®¤çš„æ•°æ®ä¼ è¾“æ ¼å¼ï¼Œä¹Ÿè¯´æ˜äº† pb ä½œä¸ºæ¶ˆæ¯ç¼–ç æ ¼å¼çš„ä¼˜ç§€æ€§ã€‚ Pb è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ pb æä¾›åºåˆ—åŒ–çš„æ¶ˆæ¯æ ¼å¼å®šä¹‰ï¼Œé€‚ç”¨äºçŸ­è¿æ¥å’Œé•¿è¿æ¥ é€‚ç”¨äºå¾®æœåŠ¡ä¸­æœåŠ¡ä¹‹é—´é€šä¿¡å’Œæ•°æ®è½ç›˜ æ¶ˆæ¯æ ¼å¼ç”±æœåŠ¡æä¾›è€…å®šä¹‰ï¼Œè€Œä½¿ç”¨è€…å¯æ ¹æ®è‡ªèº«æ¡ä»¶ç”Ÿæˆä¸åŒè¯­è¨€çš„ä»£ç ï¼Œå…å»ç¼–ç å’Œè§£ç çš„å·¥ä½œå’Œå…¶ä¸­å¯èƒ½å‡ºç°å„ç±»é—®é¢˜ æ¶ˆæ¯å®šä¹‰å¯ä»¥éšæ—¶ä¿®æ”¹ï¼Œè€Œä¸ä¼šå½±å“ä½¿ç”¨è€…çš„ä»£ç ï¼Œä½¿ç”¨è€…åªéœ€è¦ä¿æŒæœ€æ–°çš„ pb æ–‡ä»¶å³å¯ ä¸‹é¢æˆ‘ä»¬ä»ç®€å•åˆ°å¤æ‚çš„ä»‹ç»ï¼Œå¦‚ä½•ä½¿ç”¨ pb å®šä¹‰æ•°æ®ç»“æ„å’ŒæœåŠ¡ã€‚ ","date":"2022-06-15","objectID":"/posts/microservices-protobuf/:1:0","tags":["å¾®æœåŠ¡","ç³»åˆ—ç¯‡","protobuf","grpc"],"title":"[ç³»åˆ—]å¾®æœåŠ¡Â·å¦‚ä½•é€šè¿‡ protobuf å®šä¹‰æ•°æ®å’ŒæœåŠ¡","uri":"/posts/microservices-protobuf/"},{"categories":["microservice"],"content":"2. æ•°æ®å®šä¹‰ é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦çœ‹ä¸€ä¸‹ pb æ”¯æŒçš„æ•°æ®ç±»å‹æœ‰å“ªäº›ï¼Œä»¥åŠè¿™äº›æ•°æ®ç±»å‹ç”Ÿæˆçš„ä»£ç ä¸­çš„ç±»å‹çš„å¯¹ç…§ã€‚ Pb Go double float64 float float32 int32 int32 int64 int64 uint32 uint32 uint64 uint64 sint32 int32 sint64 int64 fixed32 uint32 fixed64 uint64 sfixed32 int32 sfixed64 int64 bool bool string string bytes []byte map map enum int32 message struct å¯ä»¥çœ‹å‡º pb å®šä¹‰çš„æ•°æ®ç±»å‹å‡ ä¹ä¸å¤§éƒ¨åˆ†ç¼–ç¨‹è¯­è¨€å¾ˆç›¸ä¼¼ï¼Œå› æ­¤å…¥é—¨ pb çš„é—¨æ§›å¯ä»¥è¯´æ˜¯å¾ˆä½ã€‚ ","date":"2022-06-15","objectID":"/posts/microservices-protobuf/:2:0","tags":["å¾®æœåŠ¡","ç³»åˆ—ç¯‡","protobuf","grpc"],"title":"[ç³»åˆ—]å¾®æœåŠ¡Â·å¦‚ä½•é€šè¿‡ protobuf å®šä¹‰æ•°æ®å’ŒæœåŠ¡","uri":"/posts/microservices-protobuf/"},{"categories":["microservice"],"content":"2.1 åŸºç¡€ç”¨æ³• ä¸‹é¢åˆ†åˆ«ä»¥æšä¸¾å’Œæ¶ˆæ¯çš„è§’åº¦ï¼Œæ¥ä»‹ç» pb çš„åŸºæœ¬ç”¨æ³•ã€‚ æ³¨æ„ ä¸‹é¢æ‰€æœ‰æåˆ°çš„ pb å®šä¹‰å‡æ˜¯ä»¥ proto3ä¸ºå‡†ï¼Œæœ¬æ–‡ä¸è®¨è®º proto2 ä»¥åŠ proto2 ä¸ proto3 çš„åŒºåˆ«ã€‚ ä¸‹é¢æåˆ°çš„ä»£ç ç”Ÿæˆè§„åˆ™å‡æ˜¯åŸºäº Go è¯­è¨€ç‰ˆæœ¬çš„ï¼Œä¸”ç»è¿‡æœ¬äººæµ‹è¯•éªŒè¯ï¼Œä½†æ˜¯ä¸ä¼šå¯¹å…¶ä»–è¯­è¨€ç”Ÿæˆä»£ç è§„åˆ™åšä»»ä½•ä¿è¯ã€‚ å†™æœ¬æ–‡æ—¶ï¼Œä½¿ç”¨çš„å·¥å…·ç‰ˆæœ¬å¦‚ä¸‹ï¼š protoc --version :libprotoc 3.19.4 protoc-gen-go : v1.28.0 åœ¨å®šä¹‰æ•°æ®ä¹‹å‰ï¼Œå…ˆè¯´ä¸€ä¸‹ .proto æ–‡ä»¶çš„å¤´éƒ¨è§„åˆ™ï¼š syntax = \"proto3\"; // è¡¨ç¤ºä½¿ç”¨ proto3 çš„è¯­æ³• // åŒ…åï¼Œå¦‚æœå…¶ä»– proto æ–‡ä»¶å¼•ç”¨è¯¥æ–‡ä»¶æ—¶ï¼Œä½¿ç”¨è¯¥å€¼å»å¼•ç”¨ï¼Œ å¦‚ï¼š // import \"api.user.v1.proto\"; // message xxx { // api.user.v1.Person person= 1; // ... // } package api.user.v1; // go çš„åŒ…åï¼Œå¯ä»¥æ ¹æ®åœ¨å½“å‰é¡¹ç›®çš„è·¯å¾„å®šä¹‰ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœå…¶ä»–åŒ…å¼•å…¥å½“å‰ proto æ–‡ä»¶ï¼Œ // åˆ™å…¶ä»– proto æ–‡ä»¶ç”Ÿæˆ go ä»£ç æ—¶ï¼Œä¼šä»¥ go_package ä½œä¸ºåŒ…åŒ…åå¼•å…¥ä½¿ç”¨,å› æ­¤å¦‚æœå½“å‰é¡¹ç›®çš„ proto æ–‡ä»¶ä¼šè¢«å…¶ä»–é¡¹ç›®å¼•å…¥ // æˆ–è€… é¡¹ç›®åŒ…åæ˜¯ä»¥ github.com/xx/xx çš„æ–¹å¼å®šä¹‰ï¼Œé‚£è¿™é‡Œä¹ŸæŒ‰è¿™ä¸ªæ ¼å¼å®šä¹‰å®Œæ•´çš„è·¯å¾„ option go_package = \"api/user/v1\"; 2.1.1 æšä¸¾ enum Sex { Unknown = 0; Male = 1; Female = 2; Other = 3; Alien = -1; } ä¸Šé¢æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªæšä¸¾ç±»å‹(enum) Sex ï¼Œå¹¶å®šä¹‰äº†å‡ ä¸ªæšä¸¾å€¼ã€‚è¿™ä¸ªæšä¸¾ç±»å‹å¯ä»¥ä½œä¸ºä¸€ä¸ªæ•°æ®ç±»å‹ï¼Œå¯ä»¥åœ¨å½“å‰ proto æ–‡ä»¶å†…è¢«å¼•ç”¨ã€‚å®šä¹‰ä½¿ç”¨æšä¸¾æœ‰å‡ ç‚¹éœ€è¦æ³¨æ„ï¼š æšä¸¾çš„å€¼åªèƒ½æ˜¯æ•´æ•° æšä¸¾å€¼ä¸èƒ½é‡å¤ æšä¸¾çš„ç¬¬ä¸€ä¸ªå…ƒç´ çš„å€¼å¿…é¡»æ˜¯ 0ï¼Œä¸”ä¸èƒ½ä¸å®šä¹‰ ä»ç¬¬äºŒä¸ªå…ƒç´ å¼€å§‹ï¼Œå…¶å€¼å¯ä»¥ä¸ºä»»æ„æ•´æ•°ï¼Œä¸éœ€è¦ä¸¥æ ¼çš„é€’å¢ï¼Œç”šè‡³å¯ä»¥å®šä¹‰ä¸ºè´Ÿæ•° é€šè¿‡ protoc å‘½ä»¤è¡Œå·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ® .proto æ–‡ä»¶ä¸åŒè¯­è¨€çš„ä»£ç ï¼Œä¸‹é¢æ˜¯æ ¹æ®ä¸Šè¿°å®šä¹‰çš„æšä¸¾å€¼ç”Ÿæˆçš„ä»£ç ä¸€éƒ¨åˆ†ï¼š type Sex int32 const ( Sex_Unknown Sex = 0 Sex_Male Sex = 1 Sex_Female Sex = 2 Sex_Other Sex = 3 Sex_Alien Sex = -1 ) // Enum value maps for Sex. var ( Sex_name = map[int32]string{ 0: \"Unknown\", 1: \"Male\", 2: \"Female\", 3: \"Other\", -1: \"Alien\", } Sex_value = map[string]int32{ \"Unknown\": 0, \"Male\": 1, \"Female\": 2, \"Other\": 3, \"Alien\": -1, } ) // è¿˜ä¼šç”Ÿæˆ Sex çš„ String() Type() ç­‰æ–¹æ³•ï¼Œè¿™é‡Œå¿½ç•¥ä¸è´´ä»£ç äº† å¯ä»¥çœ‹åˆ°å®šä¹‰ const ç±»å‹å’Œå€¼ä¹‹å¤–ï¼Œè¿˜ä¼šç”Ÿæˆä¸¤ä¸ª mapï¼Œæšä¸¾çš„åå­—å’Œå€¼å¯äº’ç›¸è½¬æ¢ã€‚è¿™é‡Œä¹Ÿå¯ä»¥æ›´åŠ ç¡®å®šä¸ºä»€ä¹ˆæšä¸¾å€¼ä¸èƒ½é‡å¤çš„åŸå› äº†ã€‚ 2.1.2 æ¶ˆæ¯ message Person { string name = 1; Sex sex = 3; int32 age = 2; float score = 4; map\u003cstring,bytes\u003e extra_data = 5; } æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªç®€å•çš„æ¶ˆæ¯(message)ä¸º Person å¹¶ä¸”åŒ…å«äº†ä¸Šé¢å®šä¹‰çš„æšä¸¾å€¼ã€‚å®šä¹‰æ¶ˆæ¯ä¹Ÿæ˜¯æœ‰ä¸€å¥—è‡ªå·±çš„è§„åˆ™ï¼š æ¶ˆæ¯çš„åå­—å¿…é¡»ä»¥å­—æ¯å¼€å¤´ï¼Œåé¢å¯ä»¥è·Ÿå­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ï¼Œä¸”å¤§å°å†™ä¸æ˜æ„Ÿï¼Œç”Ÿæˆçš„ä»£ç ä¸­ä¼šè‡ªåŠ¨å°†æ¶ˆæ¯åå­—è½¬æ¢ä¸ºå¤§å†™ æ¶ˆæ¯å­—æ®µå®šä¹‰æ˜¯ï¼Œå…ˆæŒ‡å®šç±»å‹ï¼Œå†æŒ‡å®šå­—æ®µåï¼Œæœ€åéœ€è¦æŒ‡å®šç´¢å¼•å€¼ æ¶ˆæ¯ç´¢å¼•å€¼å¿…é¡»æ˜¯æ•´æ•°ï¼Œä¸”ä¸é‡å¤å³å¯ï¼Œæ— éœ€è¦ä¸¥æ ¼çš„é€’å¢ æ¶ˆæ¯å­—æ®µåå¯ä»¥æ˜¯å°å†™ æˆ– snake case,ç”Ÿæˆçš„ä»£ç ä¼šè½¬æ¢æˆé¦–å­—æ¯å¤§å†™çš„ Camel Case ä¸‹é¢çœ‹ä¸€ä¸‹åŸºäºè¿™ä¸ªæ¶ˆæ¯ç»“æ„ç”Ÿæˆçš„ä»£ç ï¼š type Person struct { state protoimpl.MessageState sizeCache protoimpl.SizeCache unknownFields protoimpl.UnknownFields Name string `protobuf:\"bytes,1,opt,name=name,proto3\" json:\"name,omitempty\"` Sex Sex `protobuf:\"varint,3,opt,name=sex,proto3,enum=api.user.session.v1.Sex\" json:\"sex,omitempty\"` Age int32 `protobuf:\"varint,2,opt,name=age,proto3\" json:\"age,omitempty\"` Score float32 `protobuf:\"fixed32,4,opt,name=score,proto3\" json:\"score,omitempty\"` ExtraData map[string][]byte `protobuf:\"bytes,5,rep,name=extra_data,json=extraData,proto3\" json:\"extra_data,omitempty\" protobuf_key:\"bytes,1,opt,name=key,proto3\" protobuf_val:\"bytes,2,opt,name=value,proto3\"` } // åŒæ—¶ä¼šç”Ÿæˆä¸€å †æ–¹æ³•ï¼Œè¿™é‡Œå¿½ç•¥ä¸è´´ä»£ç äº† å¯ä»¥çœ‹åˆ°ï¼Œæ¶ˆæ¯ä¼šç”Ÿæˆä¸€ä¸ªç»“æ„ä½“ï¼Œå¹¶æ¯ä¸ªå­—æ®µéƒ½ä¼šå¸¦ä¸Š protobuf å’Œ json çš„ tagï¼Œæ–¹ä¾¿åºåˆ—åŒ–æ›´æ–¹ä¾¿ã€‚protobuf tag ä¼šè¯¦ç»†è®°å½•å­—æ®µçš„åœ¨ proto æ–‡ä»¶å®šä¹‰çš„åå­—ï¼Œç´¢å¼•å€¼ã€proto ç‰ˆæœ¬ç­‰ä¿¡æ¯ï¼Œç”¨äºç¼–ç å’Œè§£ç ã€‚è€Œ json tag ä»…è®°å½•å­—æ®µåã€‚ ","date":"2022-06-15","objectID":"/posts/microservices-protobuf/:2:1","tags":["å¾®æœåŠ¡","ç³»åˆ—ç¯‡","protobuf","grpc"],"title":"[ç³»åˆ—]å¾®æœåŠ¡Â·å¦‚ä½•é€šè¿‡ protobuf å®šä¹‰æ•°æ®å’ŒæœåŠ¡","uri":"/posts/microservices-protobuf/"},{"categories":["microservice"],"content":"2.2 é«˜çº§ç©æ³• 2.2.1 ç»„åˆä½¿ç”¨ ä¸Šé¢å®šä¹‰äº†äº›ç®€å•çš„ä½¿ç”¨æ–¹å¼ï¼Œä½†æ˜¯å®é™…å¼€å‘è¿‡ç¨‹ä¸­éœ€è¦æ›´å¤æ‚çš„åœºæ™¯ï¼Œä¸‹é¢æˆ‘ä»¬ä»¥ä¸€ä¸ªæ¯”è¾ƒå¤æ‚çš„åœºæ™¯ä¸ºä¾‹ï¼Œè®²è§£å¦‚ä½•å®šä¹‰å¤æ‚çš„æ¶ˆæ¯ç±»å‹ã€‚ enum Sex { Unknown = 0; Male = 1; Female = 2; Other = 3; Alien = -1; } message School { string name = 1; string grade = 2; int64 graduated_at = 3; repeated string teachers = 4; } message Person { optional string name = 1; Sex sex = 3; int32 age = 2; float score = 4; map\u003cstring,bytes\u003e extra_data = 5; repeated School schools = 6; oneof contact { string email = 7; string phone = 8; } message Company { string name = 1; string address = 2; int32 salary = 3; repeated string employees = 4; } Company company = 9; } åœ¨ä¹‹å‰çš„ Person åŸºç¡€ä¸Šåšäº†ä¸€ä¸ªæ›´å¤æ‚çš„æ¶ˆæ¯ç»“æ„ï¼Œæ–°å¢äº†å­¦æ ¡ã€è”ç³»æ–¹å¼ã€å…¬å¸ä¸‰ä¸ªå­—æ®µï¼Œå¹¶ä¸”å„ä¸ªå­—æ®µçš„ç±»å‹å¹¶ä¸ç›¸åŒï¼Œä¸‹é¢ä¸€ä¸ªä¸ªè¿›è¡Œè®²è§£ã€‚ school è¿™ä¸ªå­—æ®µå¼•å…¥äº†ä¸¤ä¸ªç‰¹æ€§ï¼Œç¬¬ä¸€ä¸ªæ˜¯ repeated ï¼Œè¡¨ç¤ºè¿™ä¸ªå­—æ®µæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œè€Œæ•°ç»„çš„å…ƒç´ ç±»å‹å°±æ˜¯ repeated ä¹‹åçš„å€¼ Schoolã€‚ç¬¬äºŒä¸ªç‰¹æ€§æ˜¯æ¶ˆæ¯çš„åµŒå¥—ï¼Œå¯ä»¥çœ‹åˆ°ä¸Šé¢å·²ç»å®šä¹‰äº†ä¸€ä¸ª School çš„æ¶ˆæ¯ï¼Œç„¶ååœ¨Person æ¶ˆæ¯å†…åµŒå¥—ä½¿ç”¨ã€‚ contact è¿™ä¸ªå­—æ®µå¼•å…¥äº† oneof è¿™ä¸ªç‰¹æ€§ï¼Œoneof å¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ª switch çš„è¯­å¥ï¼Œå®ƒçš„ä½œç”¨æ˜¯æ ¹æ® contact å­—æ®µçš„å€¼ï¼Œæ¥é€‰æ‹©ä½¿ç”¨å“ªä¸ªå­—æ®µã€‚ä½ å¯ä»¥èµ‹å€¼ email ä¹Ÿå¯ä»¥èµ‹å€¼ phone æˆ–è€…å‡ä¸èµ‹å€¼ï¼Œåœ¨ç”Ÿæˆçš„ä»£ç é‡Œï¼Œæ˜¯æœ‰ GetEmail(), GetPhone æ–¹æ³•æ¥è·å–è¿™ä¸ªå­—æ®µçš„å€¼ã€‚ company å­—æ®µå¼•å…¥äº†ä¸€ä¸ªç‰¹æ€§ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥åœ¨æ¶ˆæ¯å†…å®šä¹‰å¦ä¸€ä¸ªæ¶ˆæ¯å¹¶ç”¨åœ¨æŸä¸ªå­—æ®µä¸Šã€‚æœ€ç»ˆç”Ÿæˆçš„ä»£ç é‡Œä¼šæœ‰ä¸€ä¸ª Person_Company çš„ç»“æ„ä½“ï¼Œè¡¨ç¤ºè¿™ä¸ªç»“æ„ä½“å±äº Person. é™¤æ­¤ä¹‹å¤–ï¼Œ name å­—æ®µä¹ŸåŠ äº†ä¸€ä¸ª option çš„æ ‡è¯†ï¼Œåœ¨ç”Ÿæˆä»£ç æ—¶ä¼šç”Ÿæˆ *string çš„ç±»å‹ï¼Œå¯ä»¥åŒºåˆ†nil å’Œç©ºå€¼ã€‚ ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹ï¼Œç”Ÿæˆçš„ä»£ç ï¼ˆä»…å±•ç°æ ¸å¿ƒéƒ¨åˆ†,å¿½ç•¥å…¶ä»–æ— å…³éƒ¨åˆ†ï¼‰ï¼š type School struct { // ...ignored... Name string `protobuf:\"bytes,1,opt,name=name,proto3\" json:\"name,omitempty\"` Grade string `protobuf:\"bytes,2,opt,name=grade,proto3\" json:\"grade,omitempty\"` GraduatedAt int64 `protobuf:\"varint,3,opt,name=graduated_at,json=graduatedAt,proto3\" json:\"graduated_at,omitempty\"` Teachers []string `protobuf:\"bytes,4,rep,name=teachers,proto3\" json:\"teachers,omitempty\"` } type Person struct { // ...ignored... Name *string `protobuf:\"bytes,1,opt,name=name,proto3,oneof\" json:\"name,omitempty\"` Sex Sex `protobuf:\"varint,3,opt,name=sex,proto3,enum=api.user.session.v1.Sex\" json:\"sex,omitempty\"` Age int32 `protobuf:\"varint,2,opt,name=age,proto3\" json:\"age,omitempty\"` Score float32 `protobuf:\"fixed32,4,opt,name=score,proto3\" json:\"score,omitempty\"` ExtraData map[string][]byte `protobuf:\"bytes,5,rep,name=extra_data,json=extraData,proto3\" json:\"extra_data,omitempty\" protobuf_key:\"bytes,1,opt,name=key,proto3\" protobuf_val:\"bytes,2,opt,name=value,proto3\"` Schools []*School `protobuf:\"bytes,6,rep,name=schools,proto3\" json:\"schools,omitempty\"` // Types that are assignable to Contact: // *Person_Email // *Person_Phone Contact isPerson_Contact `protobuf_oneof:\"contact\"` // æ³¨æ„è¿™ä¸ªå­—æ®µ Company *Person_Company `protobuf:\"bytes,9,opt,name=company,proto3\" json:\"company,omitempty\"` } type isPerson_Contact interface { isPerson_Contact() } type Person_Email struct { Email string `protobuf:\"bytes,7,opt,name=email,proto3,oneof\"` } type Person_Phone struct { Phone string `protobuf:\"bytes,8,opt,name=phone,proto3,oneof\"` } func (*Person_Email) isPerson_Contact() {} func (*Person_Phone) isPerson_Contact() {} type Person_Company struct { // ...ignored... Name string `protobuf:\"bytes,1,opt,name=name,proto3\" json:\"name,omitempty\"` Address string `protobuf:\"bytes,2,opt,name=address,proto3\" json:\"address,omitempty\"` Salary int32 `protobuf:\"varint,3,opt,name=salary,proto3\" json:\"salary,omitempty\"` Employees []string `protobuf:\"bytes,4,rep,name=employees,proto3\" json:\"employees,omitempty\"` } å…³äº oneof éœ€è¦æ³¨æ„çš„æ—¶ä¸Šé¢ç”Ÿæˆçš„ contact çš„å­—æ®µå€¼ isPerson_Contact æ˜¯ä¸€ä¸ªæ¥å£å®šä¹‰ï¼Œå®ƒçš„å®ç°æ˜¯ Person_Email å’Œ Person_Phone ä¸¤ä¸ªç»“æ„ä½“ã€‚ è€Œ Person ç»“æ„ä¼šåŒæ—¶ç”Ÿæˆä¸€ä¸‹ä»£ç ï¼Œä»è€Œå®ç°äº† oneof çš„åŠŸèƒ½ï¼š func (m *Person) GetContact() isPerson_Contact { if m != nil { return m.Contact } return nil } func (x *Person) GetEmail() string { if x, ok := x.GetContact().(*Person_Email); ok { return x.Email } return \"\" } func (x *Person) GetPhone() string { if x, ok := x.GetContact().(*Person_Phone); ok { return x.Phone } return \"\" } 2.2.2 é¡¹ç›®å†… proto çš„å¼•ç”¨ ä½œä¸ºä¸€ä¸ªåˆæ ¼çš„ç¨‹åºå‘˜ï¼Œä»£ç æ˜¯éœ€è¦æ ¹æ®åŠŸèƒ½ã€ç±»å‹ç­‰å› ç´ è¿›è¡Œæ‹†åˆ†çš„ï¼Œæ¯ä¸ªæ–‡ä»¶/æ¨¡å— è´Ÿè´£ä¸€éƒ¨åˆ†çš„é€»è¾‘ï¼Œå„ä¸ªæ¨¡å—ä¹‹é—´å¯ä»¥æœ‰ç›¸äº’çš„ä¾èµ–å…³ç³»ã€‚ å› æ­¤å¼•è¿›æ¥ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œæˆ‘ä¸åŒçš„ proto æ–‡ä»¶ä¹‹é—´å¦‚ä½•ç›¸äº’å¼•ç”¨ï¼Ÿå¦‚æœæœ‰ç¬¬ä¸‰æ–¹çš„ proto æ–‡ä»¶åˆæ€ä¹ˆå¼•å…¥ä½¿ç”¨å‘¢ï¼Ÿ ç­”æ¡ˆæ˜¯ï¼Œpb æ˜¯æ”¯æŒ import èƒ½åŠ›çš„ã€‚è‡ªå·±çš„ proto æ–‡ä»¶ä¹‹é—´å¯ä»¥äº’ç›¸å¼•ç”¨ï¼Œä¹Ÿå¯ä»¥å¼•å…¥å…¶ä»– proto æ–‡ä»¶ã€‚ä½†æ˜¯éœ€è¦æ³¨æ„ä¸è¦åœ¨ä¸åŒ package ä¹‹é—´å¾ªç¯å¼•ç”¨ï¼ˆå†™ go çš„éƒ½çŸ¥é“è¿™ä¸ªæ˜¯å‘ï¼Œä¸ç”¨è¿‡å¤šè§£é‡Šï¼‰ã€‚ å…ˆè¯´ä¸€ä¸‹å¼•å…¥è‡ªå·±é¡¹ç›®å†…çš„å…¶ä»– proto æ–‡ä»¶çš„æƒ…å†µã€‚ å‡è®¾æˆ‘ç°åœ¨æœ‰ä¸¤ä¸ª proto æ–‡ä»¶ï¼Œå…¶è·¯å¾„å…¥ä¸‹ï¼š api |--user | |--user.proto |-- order | |--order.proto è€Œè¿™ä¸ªé¡¹ç›®çš„ g","date":"2022-06-15","objectID":"/posts/microservices-protobuf/:2:2","tags":["å¾®æœåŠ¡","ç³»åˆ—ç¯‡","protobuf","grpc"],"title":"[ç³»åˆ—]å¾®æœåŠ¡Â·å¦‚ä½•é€šè¿‡ protobuf å®šä¹‰æ•°æ®å’ŒæœåŠ¡","uri":"/posts/microservices-protobuf/"},{"categories":["microservice"],"content":"2.3 æ¶ˆæ¯æ ¡éªŒ åœ¨ä¸šåŠ¡æ­£å¸¸çš„ä¸šåŠ¡å¼€å‘ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å¯¹æ¥å£ä¼ å‚çš„æ•°æ®è¿›è¡Œæ•°æ®åˆæ³•æ€§éªŒè¯ï¼Œä¸€èˆ¬æ˜¯é€šè¿‡ç»“æ„ä½“æ³¨å…¥ tag çš„æ–¹å¼ç»Ÿä¸€å¤„ç†ã€‚å¤§å®¶æœ€ç†Ÿæ‚‰çš„åº”è¯¥æ˜¯ github.com/go-playground/validator è¿™ä¸ªåŒ…ï¼Œé€šè¿‡åœ¨ tag ä¸Šå®šä¹‰éªŒè¯è§„åˆ™ï¼Œç„¶åç”¨ç»Ÿä¸€çš„æ–¹æ³•è¿›è¡Œè§„åˆ™éªŒè¯ã€‚ç”¨ä¹ æƒ¯äº†å¯ä»¥è¯´æ˜¯å¾ˆæ–¹ä¾¿ï¼Œè€Œä¸”å¾ˆå¤šä¸»æµçš„http æ¡†æ¶ä¹Ÿå¯¹è¿™ä¸ªåº“è¿›è¡Œæ”¯æŒçš„ï¼ˆæ¯”å¦‚ ginï¼‰ã€‚ ä½†æ˜¯åœ¨åŸºäº gRPC \u0026 pb çš„åœºæ™¯ä¸‹ï¼Œè¿™ä¸ªåº“å°±åªæ˜¯ä¸ªæ‘†è®¾äº†ï¼Œå› ä¸ºä»£ç æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œæ²¡åŠæ³•æ”¹åŠ¨ï¼Œæ›´æ²¡åŠæ³•æ³¨å…¥ tag ä¿¡æ¯ï¼ˆå½“ç„¶ä¸èƒ½è¯´ä¸è¡Œï¼Œä½ å¯ä»¥è‡ªå·±å¼€å‘ä¸€ä¸ª protoc çš„æ’ä»¶å»åšè¿™ä¸ªäº‹å„¿ï¼Œä½†æ˜¯è¿™ä¸ªè¿‡ç¨‹æ¯”ä½ æƒ³æƒ³çš„è¦éº»çƒ¦å¤šï¼Œå¯ä»¥çœ‹ä¸€ä¸‹ å¦‚ä½•è‡ªå®šä¹‰ protoc æ’ä»¶ è¿™ç¯‡æ–‡ä»¶ï¼‰ã€‚ æ‰€ä»¥æƒ³éªŒè¯æ•°æ®çš„åˆæ³•æ€§å¥½åƒåªèƒ½æŒ¨ä¸ªå­—æ®µå»å»åˆ¤æ–­ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå‡ºç°å¦ä¸€ä¸ªéå¸¸ nb çš„æ’ä»¶ â€“ github.com/envoyproxy/protoc-gen-validateã€‚ è¯¥åº“å®šä¹‰äº†æ¯ä¸ªåŸºç¡€ç±»å‹ï¼ˆåŒ…æ‹¬ Google æä¾› duration, timestamp ç­‰ç±»å‹ï¼‰çš„éªŒè¯è§„åˆ™ï¼Œå¹¶ç”Ÿæˆå¯¹åº”çš„ä»£ç ã€‚ä½¿ç”¨æ—¶ç›´æ¥è°ƒç”¨ç»“æ„ä½“çš„ Validate() æ–¹æ³•å³å¯ã€‚ 2.3.1 åŸºç¡€ç±»å‹ å¯¹äºåŸºç¡€ç±»å‹ï¼Œæ¯”å¦‚ int32ã€int64ã€stringã€bool ç­‰ç­‰ï¼Œä¼šæœ‰å¤§äºå°äºç­‰äºï¼Œå¿…é¡»ï¼Œéå¿…é¡»ï¼Œç©ºï¼Œéç©ºç­‰ç­‰çš„éªŒè¯è§„åˆ™ã€‚ å¦‚ï¼š message UpdateUserRequest { string uid = 1 [(validate.rules).string = {min_len: 20, max_len: 24}]; string name = 2 [(validate.rules).string = {min_len: 2, max_len: 20, ignore_empty: true}]; string email = 3 [(validate.rules).string = {email: true,ignore_empty: true}]; string phone = 4 [(validate.rules).string = {pattern: \"^1[3-9]\\\\d{9}$\", ignore_empty: true}]; string avatar = 5 [(validate.rules).string = {max_len:128, ignore_empty: true}]; } ç”Ÿæˆçš„ä»£ç æ¯”è¾ƒå¤šï¼Œå°±ä¸å†è¿™é‡Œå±•ç¤ºã€‚ä½†æ˜¯ç”Ÿæˆä»£ç é€»è¾‘æ˜¯ï¼Œä¸€ä¸ªä¸ªåˆ¤æ–­å­—æ®µä¸Šçš„è§„åˆ™ï¼Œä¸ç¬¦åˆè§„åˆ™æ—¶ï¼Œä¼šè¿”å›å¾ˆè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ï¼ŒåŒ…æ‹¬å­—æ®µåï¼Œè§„åˆ™ç­‰ï¼Œä¸€çœ¼å°±èƒ½çœ‹å‡ºå“ªä¸ªå­—æ®µä¸ç¬¦åˆå“ªä¸ªè§„åˆ™ã€‚ å…¶ä»–åŸºç¡€ç±»å‹ä¹Ÿç±»ä¼¼ï¼Œå»ºè®®é˜…è¯»å®˜æ–¹æ–‡æ¡£æˆ–è€…ç›´æ¥çœ‹ proto æ–‡ä»¶ï¼Œå› ä¸º proto æ–‡ä»¶æ¯”æ–‡æ¡£çœ‹èµ·æ¥æ›´ç®€å•æ˜äº†ã€‚ 2.3.2 é«˜çº§ç±»å‹ å¯¹äº oneof, message è¿™ç§é«˜çº§ç”¨æ³•ï¼Œä»–ä¹Ÿæœ‰å¯¹åº”çš„æ£€éªŒè§„åˆ™ï¼Œè¿™é‡Œæä¸€ä¸‹ oneofã€‚å› ä¸ºåŸç”Ÿçš„ oneof å¯ä»¥ä¼ å…¶ä¸­ä¸€ä¸ªå­—æ®µæˆ–è€…ä¸ä¼ ï¼Œä½†æ˜¯æˆ‘ä»¬å¸Œæœ›æˆ‘å®šä¹‰äº† n ä¸ªï¼Œä½ å¿…é€‰ä¼ å…¶ä¸­ä¸€ä¸ªï¼Œè¿™ä¸ªæ—¶å€™åªéœ€è¦åœ¨ oneof ä¸Šç¬¬ä¸€è¡ŒåŠ ä¸Š option (validate.required) = true; å³å¯ã€‚å¦‚ï¼š oneof id { // either x, y, or z must be set. option (validate.required) = true; string x = 1; int32 y = 2; Person z = 3; } 2.3.3 æ‰©å±•ç±»å‹ å¯¹äºç¬¬ä¸‰æ–¹åŒ…ï¼ˆå¦‚ google/protobuf/duration, google/protobuf/timestampsï¼‰ä¹Ÿæ”¯æŒäº†è§„åˆ™é…ç½®ï¼Œå¯ä»¥è¦æ±‚å¿…ä¼ ï¼Œå¯ä»¥è¦æ±‚ä¼ çš„å€¼å¿…é¡»ç­‰äºæŸä¸ªæŒ‡å®šå€¼æˆ–è€…æ˜¯åœ¨ä¸€å®šçš„æ—¶é—´èŒƒå›´å†…ã€‚å¦‚ï¼š message config { // range [10ms, 10s] google.protobuf.Duration dial_timeout_sec = 3 [(validate.rules).duration = { gte: {nanos: 1000000, seconds: 0}, lte: {seconds: 10} }]; } è¯¥åŒ…çš„èƒ½åŠ›æ¯”è¾ƒå¼ºï¼Œç”±äºç¯‡å¹…åªè®²äº†å‡ ä¸ªç±»å‹ï¼Œæ‰€ä»¥ä¸å†å±•ç¤ºã€‚è¿™ä¸ªåº“çš„æ½œåŠ›æˆ‘ä¸ªäººè®¤ä¸ºæ˜¯å¾ˆå¤§çš„ï¼Œå¼ºçƒˆæ¨èå¤§å®¶ä½¿ç”¨ã€‚ ","date":"2022-06-15","objectID":"/posts/microservices-protobuf/:2:3","tags":["å¾®æœåŠ¡","ç³»åˆ—ç¯‡","protobuf","grpc"],"title":"[ç³»åˆ—]å¾®æœåŠ¡Â·å¦‚ä½•é€šè¿‡ protobuf å®šä¹‰æ•°æ®å’ŒæœåŠ¡","uri":"/posts/microservices-protobuf/"},{"categories":["microservice"],"content":"3. æœåŠ¡å®šä¹‰ ","date":"2022-06-15","objectID":"/posts/microservices-protobuf/:3:0","tags":["å¾®æœåŠ¡","ç³»åˆ—ç¯‡","protobuf","grpc"],"title":"[ç³»åˆ—]å¾®æœåŠ¡Â·å¦‚ä½•é€šè¿‡ protobuf å®šä¹‰æ•°æ®å’ŒæœåŠ¡","uri":"/posts/microservices-protobuf/"},{"categories":["microservice"],"content":"3.1 å¸¸è§„æœåŠ¡å®šä¹‰ èŠäº†è¿™ä¹ˆå¤š pb ä¸­æ¶ˆæ¯çš„å®šä¹‰ï¼Œç°åœ¨èŠä¸€èŠ pb ä¸­çš„æœåŠ¡å®šä¹‰ï¼Œæ¯•ç«ŸæœåŠ¡æ‰æ˜¯æ ¸å¿ƒéƒ¨åˆ†ã€‚ pb ä¸­æœåŠ¡å®šä¹‰æ˜¯å®šä¹‰ä¸€ä¸ªæœåŠ¡å’Œå…¶ä¸‹é¢çš„æ–¹æ³•ï¼Œè€Œè¿™äº›æ–¹æ³•éœ€è¦ä¸€ä¸ªè¯·æ±‚å’Œä¸€ä¸ªå“åº”ã€‚å¦‚ï¼š service UserService { rpc CreateUser(CreateUserRequest) returns (CreateUserResponse); // ... } message CreateUserRequest { Person person = 1; } message CreateUserResponse { string id = 1; } è¿™æ˜¯ä¸€ä¸ªæœ€ç®€çš„æœåŠ¡å®šä¹‰ï¼Œå…¶åŒ…å«ä¸€ä¸ªåˆ›å»ºç”¨æˆ·çš„æ–¹æ³•ï¼Œè¾“å…¥è¾“å‡ºä¹Ÿåˆ†åˆ«å®šä¹‰äº†ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ–¹æ³•å¿…é¡»è¦æœ‰è¾“å…¥è¾“å‡ºä¸”ä¸æ”¯æŒå¤šä¸ªå‚æ•°ï¼Œå¦‚æœéœ€è¦å¤šä¸ªå‚æ•°ï¼Œè¯·åµŒå¥—ä¸€ä¸ªç»“æ„ä½“ã€‚å¦‚æœæ–¹æ³•æ²¡æœ‰è¿”å›å€¼ï¼Œåˆ™å¯ä»¥å®šä¹‰ä¸€ä¸ªç©ºçš„ message å³å¯ã€‚è€Œæˆ‘çš„åšæ³•æ˜¯å®šä¹‰ä¸€ä¸ªé€šç”¨çš„ responseï¼Œåœ¨æ²¡æœ‰è¿”å›å€¼çš„æ–¹æ³•è¿”å›è¿™ä¸ª responseï¼Œæœ‰è¿”å›å€¼çš„æ–¹æ³•åˆ™åµŒå¥—ä¸€å±‚ï¼Œresponse ä½œä¸ºå‚æ•°ã€‚ // BaseResponse use as define response code and message message BaseResponse { Code code = 1; string reason = 2; string message = 3; } ","date":"2022-06-15","objectID":"/posts/microservices-protobuf/:3:1","tags":["å¾®æœåŠ¡","ç³»åˆ—ç¯‡","protobuf","grpc"],"title":"[ç³»åˆ—]å¾®æœåŠ¡Â·å¦‚ä½•é€šè¿‡ protobuf å®šä¹‰æ•°æ®å’ŒæœåŠ¡","uri":"/posts/microservices-protobuf/"},{"categories":["microservice"],"content":"3.2 stream æµæœåŠ¡å®šä¹‰ å¤„äº†ä¸Šè¿°çš„å®šä¹‰æœåŠ¡ä¹‹å¤–ï¼Œè¿˜å¯ä»¥å®šä¹‰è¾“å…¥æˆ–è¾“å‡ºä½ stream çš„æ–¹æ³•ï¼Œå¦‚ï¼š service UserService { rpc CreateUser1(stream CreateUserRequest) returns (CreateUserResponse); rpc CreateUser2(CreateUserRequest) returns (stream CreateUserResponse); rpc CreateUser3(stream CreateUserRequest) returns (stream CreateUserResponse); } è¡¨ç¤ºè¯·æ±‚æˆ–å“åº”å¯ä»¥æ˜¯ä¸ª stream æµï¼Œè€Œä¸åŒçš„ stream çš„å®šä¹‰ç”Ÿæˆçš„ä»£ç ä¹Ÿä¸ä¸€æ ·ï¼Œå¦‚(ä»¥ client ç«¯ä»£ç ä¸ºä¾‹)ï¼š // For semantics around ctx use and closing/ending streaming RPCs, please refer to https://pkg.go.dev/google.golang.org/grpc/?tab=doc#ClientConn.NewStream. type UserServiceClient interface { CreateUser1(ctx context.Context, opts ...grpc.CallOption) (UserService_CreateUser1Client, error) CreateUser2(ctx context.Context, in *CreateUserRequest, opts ...grpc.CallOption) (UserService_CreateUser2Client, error) CreateUser3(ctx context.Context, opts ...grpc.CallOption) (UserService_CreateUser3Client, error) } type UserService_CreateUser1Client interface { Send(*CreateUserRequest) error CloseAndRecv() (*CreateUserResponse, error) grpc.ClientStream } type UserService_CreateUser2Client interface { Recv() (*CreateUserResponse, error) grpc.ClientStream } type UserService_CreateUser3Client interface { Send(*CreateUserRequest) error Recv() (*CreateUserResponse, error) grpc.ClientStream } ä¸‰ä¸ªæ–¹æ³•è¿”å›çš„å€¼å‡ä¸ä¸€æ ·ï¼Œåˆ†åˆ«ä¸ºï¼šå‘é€ç«¯ä¸º stream æµï¼Œæ¥æ”¶ç«¯ä¸º stream æµï¼ŒåŒå‘ stream æµã€‚åŒæ ·çš„ server ç«¯å®ç°è¿™äº›æ–¹å¼æ—¶ï¼Œä¹Ÿéœ€è¦å®ç°ç›¸åº”çš„æ¥å£ã€‚ ","date":"2022-06-15","objectID":"/posts/microservices-protobuf/:3:2","tags":["å¾®æœåŠ¡","ç³»åˆ—ç¯‡","protobuf","grpc"],"title":"[ç³»åˆ—]å¾®æœåŠ¡Â·å¦‚ä½•é€šè¿‡ protobuf å®šä¹‰æ•°æ®å’ŒæœåŠ¡","uri":"/posts/microservices-protobuf/"},{"categories":["microservice"],"content":"3.3 æœåŠ¡å®šä¹‰ä¸­åµŒå¥— http å®šä¹‰ åœ¨ google/api/annotations.proto åº“çš„æ”¯æŒä¸‹ï¼Œ pb æ”¯æŒæœåŠ¡ä¸­åµŒå¥— http å®šä¹‰ï¼Œå¦‚ï¼š import \"google/api/annotations.proto\"; service Hello { rpc Add(AddRequest) returns (AddResponse) { option (google.api.http) = { post: \"/api/hello/service/v1/add\" body: \"*\" }; } rpc Get(GetRequest) returns (GetResponse) { option (google.api.http) = { get: \"/api/hello/service/v1/get\" }; } } å¯ä»¥é€šè¿‡ grpc-gateway (å®˜æ–¹é¡¹ç›®)ç”Ÿæˆå¯¹åº”çš„ http æ¥å£å¹¶æ³¨å†Œåˆ° grpc-gateway ä¸­ã€‚ä¹Ÿå¯ä»¥é€šè¿‡å…¶ä»–æ’ä»¶å»ç”Ÿæˆ http ä»£ç ã€‚è€Œ kratos è¿™ä¸ªæ¡†æ¶å°±åšäº†è¿™ä¸ªäº‹å„¿ï¼Œå•ç‹¬ç”Ÿæˆ .http.go æ–‡ä»¶ï¼Œå¯ä»¥å°†ç”Ÿæˆçš„è·¯ç”±æ³¨å†Œåˆ° kratos ä¸­ã€‚æˆ‘ä¹‹å‰ä¹Ÿå†™è¿‡ç±»ä¼¼çš„æ’ä»¶ï¼Œå¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼šå¦‚ä½•è‡ªå®šä¹‰ protoc æ’ä»¶ã€‚ ä¸ç®¡é‚£ç§æ–¹å¼ï¼Œæœ€ç»ˆç›®æ ‡éƒ½æ˜¯å¤šç”Ÿäº§ä¸€å¥— http æ¥å£ï¼Œæ–¹ä¾¿è°ƒè¯•æˆ–è€…å¯¹å¤–æä¾› grpc \u0026 http æœåŠ¡ã€‚ ","date":"2022-06-15","objectID":"/posts/microservices-protobuf/:3:3","tags":["å¾®æœåŠ¡","ç³»åˆ—ç¯‡","protobuf","grpc"],"title":"[ç³»åˆ—]å¾®æœåŠ¡Â·å¦‚ä½•é€šè¿‡ protobuf å®šä¹‰æ•°æ®å’ŒæœåŠ¡","uri":"/posts/microservices-protobuf/"},{"categories":["microservice"],"content":"4. æ€»ç»“ åˆ°è¿™é‡Œæœ¬ç¯‡æ–‡ç« å°±ç»“æŸäº†ï¼ŒåŸºæœ¬è®²å®Œæˆ‘å¯¹ pb çš„ç†è§£å’Œä½¿ç”¨ä¸Šé‡åˆ°çš„ç»éªŒéƒ½å†™å‡ºæ¥äº†ã€‚å½“ç„¶ç”±äºç¯‡å¹…åŸå› ï¼Œæ²¡æœ‰è®²è¿°å¤ªå¤š grpc ç›¸å…³çš„é—®é¢˜ï¼Œå› ä¸º grpc ä¹Ÿç®—æ˜¯ä¸ªå¤§å¤´ï¼Œæˆ‘æƒ³ä»¥åå•ç‹¬å†™ä¸€ç¯‡è®²è¿° grpc çš„åŸç†å’Œé€šä¿¡ä»¥åŠä½¿ç”¨çš„æ–‡ç« ã€‚ æœ¬ç¯‡ä¸»è¦è®²è¿°äº†ï¼š pb çš„å®šä¹‰å’Œè§£å†³çš„é—®é¢˜ pb çš„åŸºç¡€ç±»å‹å®šä¹‰å’ŒèŠ±æ ·ç©æ³• pb ç±»å‹çš„æ•°æ®æ ¡éªŒï¼ˆä»‹ç»äº†ä¸€ä¸ªç¬¬ä¸‰æ–¹åº“ï¼šprotoc-gen-validateï¼‰ pb å®šä¹‰æ™®é€šæœåŠ¡ pb å®šä¹‰ stream æµæœåŠ¡ pb å®šä¹‰ http æœåŠ¡ å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜æˆ–è€…æœ‰ä¸ä¸€æ ·çš„æƒ³æ³•ï¼Œè¯·é€šè¿‡è¯„è®ºåŒºæˆ–è€…é‚®ä»¶è”ç³»æˆ‘ã€‚ å¦‚æœåœ¨ä½¿ç”¨ pb è¿‡ç¨‹ä¸­æœ‰ä»€ä¹ˆä¸æ˜ç™½çš„ æœ¬æ–‡ä¸­çš„çŸ¥è¯†ç‚¹ï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯æˆ‘åœ¨å†™é¡¹ç›®çš„æ—¶å€™ç§¯ç´¯ä¸‹æ¥çš„ï¼Œå¦‚æœä½ æœ‰ä»€ä¹ˆä¸æ˜ç™½çš„åœ°æ–¹ï¼Œå¯ä»¥å‚è€ƒæˆ‘çš„ä¸€ä¸ªé¡¹ç›®: goim/apiã€‚ æœ¬æ–‡æåˆ°çš„èƒ½åŠ›æˆ‘åœ¨è¿™ä¸ªé¡¹ç›®åŸºæœ¬éƒ½ç”¨åˆ°äº†ï¼Œä½ å¯ä»¥åŒæ—¶çœ‹ä»£ç å’Œæœ¬æ–‡ï¼Œåº”è¯¥å¯¹ä½ æœ‰ä¸€å®šçš„å¸®åŠ©ã€‚ ","date":"2022-06-15","objectID":"/posts/microservices-protobuf/:4:0","tags":["å¾®æœåŠ¡","ç³»åˆ—ç¯‡","protobuf","grpc"],"title":"[ç³»åˆ—]å¾®æœåŠ¡Â·å¦‚ä½•é€šè¿‡ protobuf å®šä¹‰æ•°æ®å’ŒæœåŠ¡","uri":"/posts/microservices-protobuf/"},{"categories":["microservice"],"content":"5. é“¾æ¥ğŸ”— ç³»åˆ—ç¯‡ å¦‚ä½•è‡ªå®šä¹‰ protoc æ’ä»¶ https://developers.google.com/protocol-buffers/docs/overview https://www.grpc.io/docs/what-is-grpc/introduction/ https://github.com/envoyproxy/protoc-gen-validate ","date":"2022-06-15","objectID":"/posts/microservices-protobuf/:5:0","tags":["å¾®æœåŠ¡","ç³»åˆ—ç¯‡","protobuf","grpc"],"title":"[ç³»åˆ—]å¾®æœåŠ¡Â·å¦‚ä½•é€šè¿‡ protobuf å®šä¹‰æ•°æ®å’ŒæœåŠ¡","uri":"/posts/microservices-protobuf/"},{"categories":["k8s"],"content":" æœ¬ç¯‡ä¸ºè½¬è½½æ–‡ç« ï¼ŒåŸæ–‡ç« é“¾æ¥ï¼šhttps://ying-zhang.github.io/cluster/2015-borg-eurosys-cn/ Large-scale cluster management at Google with Borg Abhishek Vermay, Luis Pedrosaz, Madhukar Korupolu David Oppenheimer, Eric Tune, John Wilkes. Google Inc. EuroSys, 2015. è¯‘è€…ï¼šéš¾æ˜“ï¼ˆSimpsonï¼‰ ä¿®è®¢ï¼šYing ZHANG. 2017-11; 2018-06 https://dl.acm.org/doi/10.1145/2741948.2741964æˆ–https://research.google/pubs/pub43438/æˆ– https://pdos.csail.mit.edu/6.824/papers/borg.pdf è¯‘æ–‡ PDF æ–‡ä»¶ è¯´æ˜ï¼šæˆ‘æ˜¯åŸºäºåŸè¯‘è€…çš„æ–‡æœ¬ä¿®è®¢çš„ï¼Œä½†æœ€ç»ˆæ”¹åŠ¨å¤ªå¤šï¼Œå°±ä¸æ ‡æ³¨äº†ã€‚æœ€è¿‘åˆçœ‹åˆ° æ·±åº¦è¯‘æ–‡ï½œGoogleçš„å¤§è§„æ¨¡é›†ç¾¤ç®¡ç†ç³»ç»ŸBorg - ç‹å‹‡æ¡¥ ã€‚å¯ä»¥é€šè¿‡æ‘˜è¦å¯¹æ¯”ä¸€ä¸‹ã€‚ Googleçš„Borgç³»ç»Ÿæ˜¯ä¸€ä¸ªé›†ç¾¤ç®¡ç†å™¨ã€‚å®ƒåœ¨å¤šä¸ªä¸‡å°æœºå™¨è§„æ¨¡çš„é›†ç¾¤ä¸Šè¿è¡Œç€æ¥è‡ªå‡ åƒä¸ªä¸åŒåº”ç”¨çš„å‡ åä¸‡ä¸ªä½œä¸šã€‚Borgé€šè¿‡å‡†å…¥æ§åˆ¶ã€é«˜æ•ˆçš„ä»»åŠ¡è£…ç®±ã€è¶…å”®ã€æœºå™¨å…±äº«ã€ä»¥åŠè¿›ç¨‹çº§åˆ«çš„æ€§èƒ½éš”ç¦»ï¼Œå®ç°äº†é«˜åˆ©ç”¨ç‡ã€‚å®ƒä¸ºé«˜å¯ç”¨åº”ç”¨æä¾›äº†å¯ä»¥å‡å°‘æ•…éšœæ¢å¤æ—¶é—´çš„è¿è¡Œæ—¶ç‰¹æ€§ï¼Œä»¥åŠé™ä½å…³è”æ•…éšœæ¦‚ç‡çš„è°ƒåº¦ç­–ç•¥ã€‚Borgæä¾›äº†å£°æ˜å¼çš„ä½œä¸šæè¿°è¯­è¨€ã€åŸŸåæœåŠ¡é›†æˆã€å®æ—¶ä½œä¸šç›‘æ§ã€åˆ†æå’Œæ¨¡æ‹Ÿç³»ç»Ÿè¡Œä¸ºçš„å·¥å…·ã€‚è¿™äº›ç®€åŒ–äº†ç”¨æˆ·çš„ä½¿ç”¨ã€‚ æœ¬æ–‡ä»‹ç»äº†Borgç³»ç»Ÿæ¶æ„å’Œç‰¹æ€§ï¼Œé‡è¦çš„è®¾è®¡å†³ç­–ï¼Œå¯¹æŸäº›ç­–ç•¥é€‰æ‹©çš„å®šé‡åˆ†æï¼Œä»¥åŠåå¹´æ¥çš„è¿è¥ç»éªŒå’Œæ•™è®­ã€‚ éš¾æ˜“ï¼š è°·æ­Œçš„Borgç³»ç»Ÿç¾¤é›†ç®¡ç†å™¨è¿è¡Œå‡ åä¸‡ä¸ªä»¥ä¸Šçš„jobsï¼Œæ¥è‡ªå‡ åƒä¸ªä¸åŒçš„åº”ç”¨ï¼Œè·¨å¤šä¸ªé›†ç¾¤ï¼Œæ¯ä¸ªé›†ç¾¤æœ‰ä¸Šä¸‡ä¸ªæœºå™¨ã€‚å®ƒé€šè¿‡ç®¡ç†æ§åˆ¶ã€é«˜æ•ˆçš„ä»»åŠ¡åŒ…è£…ã€è¶…å”®ã€å’Œè¿›ç¨‹çº§åˆ«æ€§èƒ½éš”ç¦»å®ç°äº†é«˜åˆ©ç”¨ç‡ã€‚å®ƒæ”¯æŒé«˜å¯ç”¨æ€§åº”ç”¨ç¨‹åºä¸è¿è¡Œæ—¶åŠŸèƒ½ï¼Œæœ€å¤§é™åº¦åœ°å‡å°‘æ•…éšœæ¢å¤æ—¶é—´ï¼Œå‡å°‘ç›¸å…³æ•…éšœæ¦‚ç‡çš„è°ƒåº¦ç­–ç•¥ã€‚Borgç®€åŒ–äº†ç”¨æˆ·ç”Ÿæ´»ï¼Œé€šè¿‡æä¾›ä¸€ä¸ªå£°æ˜æ€§çš„å·¥ä½œè§„èŒƒè¯­è¨€ï¼Œåç§°æœåŠ¡é›†æˆï¼Œå®æ—¶ä½œä¸šç›‘æ§ï¼Œå’Œåˆ†æå’Œæ¨¡æ‹Ÿç³»ç»Ÿè¡Œä¸ºçš„å·¥å…·ã€‚ æˆ‘ä»¬å°†ä¼šå±•ç°Borgç³»ç»Ÿæ¶æ„å’Œç‰¹ç‚¹ï¼Œé‡è¦çš„è®¾è®¡å†³ç­–ï¼Œå®šé‡åˆ†æå®ƒçš„ä¸€äº›ç­–ç•¥ï¼Œå’Œåå¹´ä»¥æ¥çš„è¿ç»´ç»éªŒå’Œå­¦åˆ°çš„ä¸œè¥¿ã€‚ç‹ï¼š Googleçš„Borgç³»ç»Ÿæ˜¯ä¸€ä¸ªè¿è¡Œç€æˆåƒä¸Šä¸‡é¡¹ä½œä¸šçš„é›†ç¾¤ç®¡ç†å™¨ï¼Œå®ƒåŒæ—¶ç®¡ç†ç€å¾ˆå¤šä¸ªåº”ç”¨é›†ç¾¤ï¼Œæ¯ä¸ªé›†ç¾¤éƒ½æœ‰æˆåƒä¸Šä¸‡å°æœºå™¨ï¼Œè¿™äº›é›†ç¾¤ä¹‹ä¸Šè¿è¡Œç€Googleçš„å¾ˆå¤šä¸åŒçš„åº”ç”¨ã€‚ Borgé€šè¿‡å‡†å…¥æ§åˆ¶ï¼Œé«˜æ•ˆçš„ä»»åŠ¡æ‰“åŒ…ï¼Œè¶…é¢çš„èµ„æºåˆ†é…å’Œè¿›ç¨‹çº§éš”ç¦»çš„æœºå™¨å…±äº«ï¼Œæ¥å®ç°è¶…é«˜çš„èµ„æºåˆ©ç”¨ç‡ã€‚ å®ƒé€šè¿‡æœ€å°åŒ–æ•…éšœæ¢å¤æ—¶é—´çš„è¿è¡Œæ—¶ç‰¹æ€§å’Œå‡å°‘ç›¸å…³è¿è¡Œæ—¶æ•…éšœçš„è°ƒåº¦ç­–ç•¥æ¥æ”¯æŒé«˜å¯ç”¨çš„åº”ç”¨ç¨‹åºã€‚Borgé€šè¿‡æä¾›ä¸€ä¸ªä½œä¸šå£°æ˜çš„æ ‡å‡†è¯­è¨€ï¼Œå‘½åæœåŠ¡çš„é›†æˆæœºåˆ¶ï¼Œå®æ—¶çš„ä½œä¸šç›‘æ§ï¼Œä»¥åŠä¸€å¥—åˆ†æå’Œæ¨¡æ‹Ÿç³»ç»Ÿè¡Œä¸ºçš„å·¥å…·æ¥ç®€åŒ–ç”¨æˆ·çš„ä½¿ç”¨ã€‚ æˆ‘ä»¬å°†é€šè¿‡æ­¤è®ºæ–‡å¯¹Borgç³»ç»Ÿçš„æ¶æ„å’Œä¸»è¦ç‰¹æ€§è¿›è¡Œæ€»ç»“ï¼ŒåŒ…æ‹¬é‡è¦çš„è®¾è®¡å†³å®šï¼Œä¸€äº›è°ƒåº¦ç®¡ç†ç­–ç•¥çš„å®šé‡åˆ†æï¼Œä»¥åŠå¯¹åå¹´çš„ä½¿ç”¨ç»éªŒä¸­æ±²å–çš„æ•™è®­çš„å®šæ€§åˆ†æã€‚ Googleâ€™s Borg system is a cluster manager that runs hundreds of thousands of jobs, from many thousands of different applications, across a number of clusters each with up to tens of thousands of machines. It achieves high utilization by combining admission control, efficient task-packing, over-commitment, and machine sharing with process-level performance isolation. It supports high-availability applications with runtime features that minimize fault-recovery time, and scheduling policies that reduce the probability of correlated failures. Borg simplifies life for its users by offering a declarative job specification language, name service integration, real-time job monitoring, and tools to analyze and simulate system behavior. We present a summary of the Borg system architecture and features, important design decisions, a quantitative analysis of some of its policy decisions, and a qualitative examination of lessons learned from a decade of operational experience with it. Permission to make digital or hard copies of part or all of this work for personal or classroom use is granted without fee provided that copies are not made or distributed for profit or commercial advantage and that copies bear this notice and the full citation on the first page. Copyrights for third-party components of this work must be honored. For all other uses, contact the owner/author(s). EuroSys'15, April 21-24, 2015, Bordeaux, France. Copyright is held by the owner/author(s). ACM 978-1-4503-3238-5/15/04. https://doi.org/10.1145/2741948.2741964 ","date":"2022-05-31","objectID":"/posts/brog-in-google/:0:0","tags":["è½¬è½½","brog","cluster"],"title":"[è¯‘]ä½¿ç”¨Borgåœ¨Googleç®¡ç†å¤§è§„æ¨¡é›†ç¾¤","uri":"/posts/brog-in-google/"},{"categories":["k8s"],"content":"1. ç®€ä»‹ æˆ‘ä»¬å†…éƒ¨ç§°ä¸ºBorgçš„é›†ç¾¤ç®¡ç†ç³»ç»Ÿï¼Œè´Ÿè´£æ¥æ”¶ã€è°ƒåº¦ã€å¯åŠ¨ã€é‡å¯å’Œç›‘æ§Googleæ‰€æœ‰çš„åº”ç”¨ã€‚æœ¬æ–‡ä»‹ç»å®ƒæ˜¯å¦‚ä½•å®ç°çš„ã€‚ Borgæä¾›äº†ä¸‰ä¸ªä¸»è¦çš„å¥½å¤„ï¼šï¼ˆ1ï¼‰éšè—èµ„æºç®¡ç†å’Œæ•…éšœå¤„ç†ç»†èŠ‚ï¼Œä½¿ç”¨æˆ·å¯ä»¥ä¸“æ³¨äºåº”ç”¨å¼€å‘ï¼›ï¼ˆ2ï¼‰é«˜å¯é å’Œé«˜å¯ç”¨çš„è¿ç»´ï¼Œå¹¶æ”¯æŒåº”ç”¨ç¨‹åºä¹Ÿèƒ½å¤Ÿå¦‚æ­¤ï¼›ï¼ˆ3ï¼‰è®©æˆ‘ä»¬å¯ä»¥åœ¨å‡ ä¸‡å°æœºå™¨ä¸Šé«˜æ•ˆåœ°è¿è¡Œè´Ÿè½½ã€‚Borgä¸æ˜¯ç¬¬ä¸€ä¸ªæ¶‰åŠè¿™äº›é—®é¢˜çš„ç³»ç»Ÿï¼Œä½†å®ƒæ˜¯å°‘æœ‰çš„è¿è¡Œåœ¨å¦‚æ­¤å¤§è§„æ¨¡ï¼Œå…·æœ‰å¼¹æ€§ä¸”å®Œæ•´çš„ç³»ç»Ÿä¹‹ä¸€ã€‚ æœ¬æ–‡å›´ç»•è¿™äº›ä¸»é¢˜æ¥ç¼–å†™ï¼Œæ€»ç»“äº†åå¤šå¹´æ¥æˆ‘ä»¬åœ¨ç”Ÿäº§ç¯å¢ƒè¿è¡ŒBorgçš„ä¸€äº›å®šæ€§è§‚å¯Ÿã€‚ å›¾1. Borgçš„æ¶æ„ã€‚å›¾ä¸­åªç”»å‡ºäº†æ•°åƒä¸ªå·¥ä½œèŠ‚ç‚¹çš„å¾ˆå°ä¸€éƒ¨åˆ† ","date":"2022-05-31","objectID":"/posts/brog-in-google/:1:0","tags":["è½¬è½½","brog","cluster"],"title":"[è¯‘]ä½¿ç”¨Borgåœ¨Googleç®¡ç†å¤§è§„æ¨¡é›†ç¾¤","uri":"/posts/brog-in-google/"},{"categories":["k8s"],"content":"2. ç”¨æˆ·è§†è§’ Borgçš„ç”¨æˆ·æ˜¯Googleçš„å¼€å‘äººå‘˜ä»¥åŠè¿è¡ŒGoogleåº”ç”¨å’ŒæœåŠ¡çš„ç³»ç»Ÿç®¡ç†å‘˜ï¼ˆç«™ç‚¹å¯é æ€§å·¥ç¨‹å¸ˆï¼ŒSREï¼‰ã€‚ç”¨æˆ·ä»¥ä½œä¸šï¼ˆJobï¼‰çš„æ–¹å¼å°†ä»–ä»¬çš„å·¥ä½œæäº¤ç»™Borgã€‚ä½œä¸šç”±ä¸€ä¸ªæˆ–å¤šä¸ªä»»åŠ¡ï¼ˆTaskï¼‰ç»„æˆï¼Œæ¯ä¸ªä»»åŠ¡æ‰§è¡Œç›¸åŒçš„äºŒè¿›åˆ¶ç¨‹åºã€‚æ¯ä¸ªä½œä¸šåªè¿è¡Œåœ¨ä¸€ä¸ªBorgå•å…ƒï¼ˆCellï¼‰é‡Œã€‚Cellæ˜¯ä¸€ç»„æœºå™¨çš„ç®¡ç†å•å…ƒã€‚ä¸‹é¢çš„å°èŠ‚å°†ä»‹ç»ç”¨æˆ·è§†è§’çœ‹åˆ°çš„Borgç³»ç»Ÿçš„ä¸»è¦ç‰¹æ€§ã€‚ SREçš„èŒè´£æ¯”ç³»ç»Ÿç®¡ç†å‘˜å¤šå¾—å¤šï¼šä»–ä»¬æ˜¯è´Ÿè´£Googleç”Ÿäº§æœåŠ¡çš„å·¥ç¨‹å¸ˆã€‚ä»–ä»¬ä¹Ÿè®¾è®¡å’Œå®ç°åŒ…æ‹¬è‡ªåŠ¨åŒ–ç³»ç»Ÿç­‰è½¯ä»¶ï¼Œç®¡ç†åº”ç”¨ã€æœåŠ¡åŸºç¡€è®¾æ–½å’Œå¹³å°ï¼Œä»¥ä¿è¯åœ¨Googleå¦‚æ­¤å¤§çš„è§„æ¨¡ä¸‹çš„é«˜æ€§èƒ½å’Œé«˜å¯é æ€§ã€‚ ","date":"2022-05-31","objectID":"/posts/brog-in-google/:2:0","tags":["è½¬è½½","brog","cluster"],"title":"[è¯‘]ä½¿ç”¨Borgåœ¨Googleç®¡ç†å¤§è§„æ¨¡é›†ç¾¤","uri":"/posts/brog-in-google/"},{"categories":["k8s"],"content":"2.1 å·¥ä½œè´Ÿè½½ Borg Cellä¸»è¦è¿è¡Œ2ç§å¼‚æ„çš„å·¥ä½œè´Ÿè½½ã€‚ç¬¬ä¸€ç§æ˜¯åº”è¯¥â€œæ°¸ä¸â€åœæ­¢çš„é•¿æœŸè¿è¡Œçš„æœåŠ¡ï¼Œå¤„ç†æŒç»­æ—¶é—´è¾ƒçŸ­ä½†å¯¹å»¶è¿Ÿæ•æ„Ÿçš„è¯·æ±‚ï¼ˆä»å‡ å¾®ç§’åˆ°å‡ ç™¾æ¯«ç§’ï¼‰ã€‚è¿™äº›æœåŠ¡ç”¨äºé¢å‘æœ€ç»ˆç”¨æˆ·çš„äº§å“ï¼Œå¦‚Gmailã€Google Docsã€ç½‘é¡µæœç´¢ï¼Œä»¥åŠå†…éƒ¨åŸºç¡€è®¾æ–½æœåŠ¡ï¼ˆä¾‹å¦‚Bigtableï¼‰ã€‚ç¬¬äºŒç§æ˜¯æ‰¹å¤„ç†ä½œä¸šï¼Œæ‰§è¡Œæ—¶é—´ä»å‡ ç§’åˆ°å‡ å¤©ï¼Œå¯¹çŸ­æœŸæ€§èƒ½æ³¢åŠ¨ä¸æ•æ„Ÿã€‚è¿™2ç§è´Ÿè½½åœ¨ä¸åŒCellä¸­çš„æ¯”ä¾‹ä¸åŒï¼Œå–å†³äºå…¶ä¸»è¦ç§Ÿæˆ·ï¼ˆä¾‹å¦‚ï¼Œæœ‰äº›Cellå°±ä»¥æ‰¹å¤„ç†ä½œä¸šä¸ºä¸»ï¼‰ã€‚å·¥ä½œè´Ÿè½½ä¹Ÿéšæ—¶é—´å˜åŒ–ï¼šæ‰¹å¤„ç†ä½œä¸šä¸æ–­æäº¤æˆ–ç»“æŸï¼Œè€Œå¾ˆå¤šé¢å‘ç»ˆç«¯ç”¨æˆ·çš„æœåŠ¡è¡¨ç°å‡ºæ˜¼å¤œå‘¨æœŸæ€§çš„ä½¿ç”¨æ¨¡å¼ã€‚Borgéœ€è¦éƒ½å¤„ç†å¥½è¿™äº›æƒ…å†µã€‚ Borgçš„ä»£è¡¨æ€§è´Ÿè½½æ˜¯ä¸€ä¸ªå…¬å¼€çš„2011å¹´5æœˆæ•´æœˆçš„è®°å½•æ•°æ®é›†[80]ã€‚è¿™ä¸ªæ•°æ®é›†å·²ç»å¾—åˆ°äº†å¹¿æ³›çš„åˆ†æ[1, 26, 27, 57, 68]ã€‚ æœ€è¿‘å‡ å¹´ï¼Œä»¥Borgä¸ºåŸºç¡€æ„å»ºäº†å¾ˆå¤šåº”ç”¨æ¡†æ¶ï¼ŒåŒ…æ‹¬æˆ‘ä»¬å†…éƒ¨çš„MapReduceç³»ç»Ÿ[23]ã€FlumeJava[18]ã€Millwheel[3]å’ŒPregel[59]ã€‚è¿™äº›æ¡†æ¶å¤§å¤šæœ‰ä¸€ä¸ªæ§åˆ¶å™¨æ¥æäº¤Master Jobï¼Œè¿˜æœ‰å¤šä¸ªWorker Jobã€‚å‰ä¸¤ä¸ªæ¡†æ¶ç±»ä¼¼äºYARNçš„åº”ç”¨ç®¡ç†å™¨[76]ã€‚æˆ‘ä»¬çš„åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿï¼Œä¾‹å¦‚GFS[34]å’Œå®ƒçš„åç»§è€…CFSã€Bigtable[19]ã€ä»¥åŠMegastore[8]ï¼Œéƒ½æ˜¯è¿è¡Œåœ¨Borgä¸Šçš„ã€‚ æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬æŠŠé«˜ä¼˜å…ˆçº§çš„Borgä½œä¸šç§°ä¸ºä¸ºç”Ÿäº§ä½œä¸šï¼ˆprodï¼‰ï¼Œå…¶å®ƒçš„åˆ™æ˜¯éç”Ÿäº§çš„ï¼ˆnon-prodï¼‰ã€‚å¤§å¤šæ•°é•¿æœŸæœåŠ¡æ˜¯prodçš„ï¼Œå¤§éƒ¨åˆ†æ‰¹å¤„ç†ä½œä¸šæ˜¯non-prodçš„ã€‚ä¸€ä¸ªå…¸å‹Cellé‡Œï¼Œprodä½œä¸šåˆ†é…äº†çº¦70%çš„æ€»CPUèµ„æºï¼Œå æ€»CPUä½¿ç”¨é‡çº¦60%ï¼›åˆ†é…äº†çº¦55%çš„æ€»å†…å­˜èµ„æºï¼Œå æ€»å†…å­˜ä½¿ç”¨é‡çº¦85%ã€‚Â§5.5 èŠ‚è¡¨æ˜åˆ†é…é‡å’Œä½¿ç”¨é‡çš„å·®å¼‚æ˜¯å€¼å¾—æ³¨æ„çš„ã€‚ ","date":"2022-05-31","objectID":"/posts/brog-in-google/:2:1","tags":["è½¬è½½","brog","cluster"],"title":"[è¯‘]ä½¿ç”¨Borgåœ¨Googleç®¡ç†å¤§è§„æ¨¡é›†ç¾¤","uri":"/posts/brog-in-google/"},{"categories":["k8s"],"content":"2.2 é›†ç¾¤ï¼ˆClusterï¼‰å’Œå•å…ƒï¼ˆCellï¼‰ ä¸€ä¸ªCellé‡Œçš„æœºå™¨å±äºåŒä¸€ä¸ªé›†ç¾¤ã€‚é›†ç¾¤ç”±æ•°æ®ä¸­å¿ƒçº§çš„é«˜æ€§èƒ½å…‰çº¤çš„ç»„ç½‘æ¥å®šä¹‰ã€‚ä¸€ä¸ªé›†ç¾¤ä½äºæ•°æ®ä¸­å¿ƒçš„ä¸€æ ‹å»ºç­‘å†…ï¼Œè€Œä¸€ä¸ªæ•°æ®ä¸­å¿ƒæœ‰å¤šæ ‹å»ºç­‘åŸæ³¨1: è¿™äº›å…³ç³»ä¼šæœ‰å°‘æ•°ä¾‹å¤–æƒ…å†µã€‚ä¸€ä¸ªé›†ç¾¤é€šå¸¸åŒ…æ‹¬ä¸€ä¸ªå¤§çš„Cellï¼Œè¿˜å¯èƒ½æœ‰ä¸€äº›å°è§„æ¨¡çš„æµ‹è¯•ç”¨æˆ–å…¶å®ƒç‰¹æ®Šç”¨é€”çš„Cellã€‚æˆ‘ä»¬å°½åŠ›é¿å…ä»»ä½•å•ç‚¹æ•…éšœã€‚ ä¸è®¡æµ‹è¯•ç”¨çš„Cellï¼Œä¸­ç­‰è§„æ¨¡çš„Cellçº¦æœ‰ä¸€ä¸‡å°æœºå™¨ï¼›æœ‰äº›Cellè¿˜è¦å¤§å¾—å¤šã€‚Cellä¸­çš„æœºå™¨ä»å¤šä¸ªç»´åº¦çœ‹éƒ½æ˜¯å¼‚æ„çš„ï¼šå¤§å°ï¼ˆCPUã€å†…å­˜ï¼Œç¡¬ç›˜ï¼Œç½‘ç»œï¼‰ã€å¤„ç†å™¨ç±»å‹ã€æ€§èƒ½ã€ä»¥åŠæ˜¯å¦æœ‰å¤–ç½‘IPåœ°å€æˆ–SSDç­‰ã€‚Borgè´Ÿè´£å†³å®šä»»åŠ¡åœ¨Cellä¸­çš„å“ªäº›æœºå™¨ä¸Šæ‰§è¡Œã€ä¸ºå…¶åˆ†é…èµ„æºã€å®‰è£…ç¨‹åºåŠä¾èµ–ã€ç›‘æ§å¥åº·çŠ¶æ€å¹¶åœ¨å¤±è´¥åé‡å¯ï¼Œä»è€Œä½¿ç”¨æˆ·å‡ ä¹ä¸å¿…å…³å¿ƒæœºå™¨å¼‚æ„æ€§ã€‚ ","date":"2022-05-31","objectID":"/posts/brog-in-google/:2:2","tags":["è½¬è½½","brog","cluster"],"title":"[è¯‘]ä½¿ç”¨Borgåœ¨Googleç®¡ç†å¤§è§„æ¨¡é›†ç¾¤","uri":"/posts/brog-in-google/"},{"categories":["k8s"],"content":"2.3 ä½œä¸šï¼ˆJobï¼‰å’Œä»»åŠ¡ï¼ˆTaskï¼‰ ä¸€ä¸ªBorgä½œä¸šçš„å±æ€§æœ‰ï¼šåç§°ã€æ‹¥æœ‰è€…å’Œä»»åŠ¡ä¸ªæ•°ã€‚ä½œä¸šå¯ä»¥æœ‰ä¸€äº›çº¦æŸæ¥å¼ºåˆ¶å…¶ä»»åŠ¡è¿è¡Œåœ¨æœ‰ç‰¹å®šå±æ€§çš„æœºå™¨ä¸Šï¼Œæ¯”å¦‚å¤„ç†å™¨æ¶æ„ã€æ“ä½œç³»ç»Ÿç‰ˆæœ¬ã€æ˜¯å¦æœ‰å¤–ç½‘IPåœ°å€ç­‰ã€‚çº¦æŸå¯ä»¥æ˜¯ç¡¬æ€§çš„æˆ–è€…æŸ”æ€§çš„ï¼ŒæŸ”æ€§çº¦æŸè¡¨ç¤ºåå¥½ï¼Œè€Œééœ€æ±‚ã€‚ä¸€ä¸ªä½œä¸šå¯ä»¥æ¨è¿Ÿåˆ°å‰ä¸€ä¸ªä½œä¸šç»“æŸåå†å¼€å§‹ã€‚ä¸€ä¸ªä½œä¸šåªåœ¨ä¸€ä¸ªCellä¸­è¿è¡Œã€‚ æ¯ä¸ªä»»åŠ¡å¯¹åº”ç€ä¸€ç»„Linuxè¿›ç¨‹ï¼Œè¿è¡Œåœ¨ä¸€å°æœºå™¨ä¸Šçš„ä¸€ä¸ªå®¹å™¨å†…[62]ã€‚ç»å¤§éƒ¨åˆ†Borgçš„å·¥ä½œè´Ÿè½½æ²¡æœ‰è¿è¡Œåœ¨è™šæ‹Ÿæœºé‡Œï¼Œå› ä¸ºæˆ‘ä»¬ä¸æƒ³ä»˜å‡ºè™šæ‹ŸåŒ–çš„å¼€é”€ã€‚è€Œä¸”ï¼Œåœ¨Borgè®¾è®¡çš„æ—¶å€™ï¼Œæˆ‘ä»¬æœ‰å¾ˆå¤šå¤„ç†å™¨è¿˜æ²¡æœ‰ç¡¬ä»¶è™šæ‹ŸåŒ–åŠŸèƒ½å‘¢ã€‚ ä»»åŠ¡ä¹Ÿæœ‰ä¸€äº›å±æ€§ï¼Œå¦‚èµ„æºéœ€æ±‚é‡ï¼Œåœ¨ä½œä¸šä¸­çš„åºå·ç­‰ã€‚ä¸€ä¸ªä½œä¸šä¸­çš„ä»»åŠ¡å¤§å¤šæœ‰ç›¸åŒçš„å±æ€§ï¼Œä½†ä¹Ÿå¯ä»¥è¢«è¦†ç›– â€”â€”ä¾‹å¦‚ç‰¹å®šä»»åŠ¡çš„å‘½ä»¤è¡Œå‚æ•°ã€‚å„ç»´åº¦çš„èµ„æºï¼ˆCPUæ ¸ã€å†…å­˜ã€ç¡¬ç›˜ç©ºé—´ã€ç¡¬ç›˜è®¿é—®é€Ÿåº¦ã€TCPç«¯å£ç­‰åŸæ³¨2: Borgè´Ÿè´£ç®¡ç†ä¸€å°æœºå™¨ä¸Šçš„å¯ç”¨ç«¯å£å¹¶å°†å…¶åˆ†é…ç»™ä»»åŠ¡ï¼‰ã€‚å¯ä»¥äº’ç›¸ç‹¬ç«‹çš„ä»¥ç»†ç²’åº¦æŒ‡å®šã€‚æˆ‘ä»¬ä¸å¼ºåˆ¶ä½¿ç”¨å›ºå®šå¤§å°çš„èµ„æºæ¡¶æˆ–æ§½ï¼ˆè§Â§5.4ï¼‰ã€‚Borgè¿è¡Œçš„ç¨‹åºéƒ½æ˜¯é™æ€é“¾æ¥çš„ï¼Œä»¥å‡å°‘å¯¹è¿è¡Œç¯å¢ƒçš„ä¾èµ–ï¼Œè¿™äº›ç¨‹åºç»„ç»‡æˆç”±äºŒè¿›åˆ¶æ–‡ä»¶å’Œæ•°æ®æ–‡ä»¶æ„æˆçš„åŒ…ï¼Œç”±Borgè´Ÿè´£å®‰è£…ã€‚ ç”¨æˆ·é€šè¿‡å‘Borgå‘é€RPCæ¥æ§åˆ¶ä½œä¸šã€‚RPCå¤§å¤šæ˜¯ä»å‘½ä»¤è¡Œå·¥å…·ã€å…¶å®ƒä½œä¸šã€æˆ–æˆ‘ä»¬çš„ç›‘æ§ç³»ç»Ÿï¼ˆÂ§2.6ï¼‰å‘å‡ºçš„ã€‚å¤§å¤šä½œä¸šæè¿°æ–‡ä»¶ä½¿ç”¨ä¸€ç§å£°æ˜å¼é…ç½®è¯­è¨€BCLã€‚BCLæ˜¯GCL[12]çš„ä¸€ä¸ªå˜ç§ï¼Œå³å¢åŠ äº†ä¸€äº›Borgä¸“æœ‰çš„å…³é”®å­—ï¼Œè€ŒGCLä¼šç”Ÿæˆè‹¥å¹²protobufæ–‡ä»¶[67]ã€‚GCLè¿˜æä¾›äº†åŒ¿åå‡½æ•°ä»¥æ”¯æŒè®¡ç®—ï¼Œè¿™æ ·å°±èƒ½è®©åº”ç”¨æ ¹æ®ç¯å¢ƒè°ƒæ•´è‡ªå·±çš„é…ç½®ã€‚æœ‰ä¸Šä¸‡ä¸ªè¶…è¿‡ä¸€åƒè¡Œçš„BCLé…ç½®æ–‡ä»¶ï¼Œç³»ç»Ÿä¸­ç´¯è®¡æœ‰æ•°åƒä¸‡è¡ŒBCLã€‚Auroraçš„é…ç½®æ–‡ä»¶ä¸Borgçš„ä½œä¸šé…ç½®[6]ç±»ä¼¼ã€‚ å›¾2å±•ç¤ºäº†ä½œä¸šå’Œä»»åŠ¡æ•´ä¸ªç”Ÿå‘½å‘¨æœŸçš„çŠ¶æ€å˜åŒ–ã€‚ å›¾2. ä½œä¸šå’Œä»»åŠ¡çš„çŠ¶æ€å›¾ã€‚ç”¨æˆ·å¯ä»¥è§¦å‘æäº¤ï¼Œæ€æ­»å’Œæ›´æ–°æ“ä½œ è¦æƒ³åœ¨è¿è¡Œæ—¶æ”¹å˜ä¸€ä¸ªä½œä¸šä¸­è‹¥å¹²æˆ–å…¨éƒ¨ä»»åŠ¡çš„å±æ€§ï¼Œç”¨æˆ·å¯ä»¥å‘Borgæäº¤ä¸€ä¸ªæ–°çš„ä½œä¸šé…ç½®ï¼Œå¹¶å‘½ä»¤Borgå°†ä»»åŠ¡æ›´æ–°åˆ°æ–°çš„é…ç½®ã€‚æ›´æ–°æ˜¯è½»é‡çš„ï¼ŒéåŸå­æ€§çš„äº‹åŠ¡ï¼Œåœ¨äº‹åŠ¡ç»“æŸï¼ˆæäº¤ï¼‰ä¹‹å‰å¯ä»¥å¾ˆå®¹æ˜“åœ°æ’¤é”€ã€‚æ›´æ–°é€šå¸¸æ˜¯æ»šåŠ¨æ‰§è¡Œçš„ï¼Œè€Œä¸”å¯ä»¥é™åˆ¶ç”±æ›´æ–°å¯¼è‡´çš„ä»»åŠ¡ä¸­æ–­ï¼ˆè¢«é‡æ–°è°ƒåº¦æˆ–æŠ¢å ï¼‰çš„æ•°é‡ï¼›è¶…è¿‡é™å€¼åï¼Œå˜æ›´å°†ä¼šè¢«è·³è¿‡ã€‚ ä¸€äº›ä»»åŠ¡æ›´æ–°ï¼ˆå¦‚æ›´æ–°äºŒè¿›åˆ¶ç¨‹åºï¼‰éœ€è¦é‡å¯ä»»åŠ¡ï¼›å¦å¤–ä¸€äº›æ›´æ–°ï¼ˆå¦‚å¢åŠ èµ„æºéœ€æ±‚æˆ–ä¿®æ”¹çº¦æŸï¼‰å¯èƒ½ä½¿è¯¥ä»»åŠ¡ä¸é€‚åˆè¿è¡Œåœ¨å½“å‰æœºå™¨ä¸Šï¼Œå¯¼è‡´åœæ­¢å¹¶é‡æ–°è°ƒåº¦è¯¥ä»»åŠ¡ï¼›è¿˜æœ‰ä¸€äº›æ›´æ–°ï¼ˆå¦‚ä¿®æ”¹ä¼˜å…ˆçº§ï¼‰æ€»æ˜¯å¯ä»¥è¿›è¡Œçš„ï¼Œä¸éœ€è¦é‡å¯æˆ–è€…ç§»åŠ¨ä»»åŠ¡ã€‚ ä»»åŠ¡å¯ä»¥è¦æ±‚åœ¨è¢«Unixçš„SIGKILLä¿¡å·ç«‹å³æ€æ­»ä¹‹å‰è·å¾—SIGTERMä¿¡å·é€šçŸ¥ï¼Œè¿™æ ·å®ƒä»¬è¿˜æœ‰æ—¶é—´æ¸…ç†èµ„æºã€ä¿å­˜çŠ¶æ€ã€ç»“æŸå½“å‰è¯·æ±‚ã€æ‹’ç»æ–°è¯·æ±‚ã€‚ä½†å¦‚æœæŠ¢å è€…è®¾ç½®äº†å»¶è¿Ÿé™å€¼ï¼Œå°±å¯èƒ½æ¥ä¸åŠå‘é€šçŸ¥ã€‚å®è·µä¸­ï¼Œ80%çš„æƒ…å†µä¸‹èƒ½å‘å‡ºé€šçŸ¥ä¿¡å·ã€‚ ","date":"2022-05-31","objectID":"/posts/brog-in-google/:2:3","tags":["è½¬è½½","brog","cluster"],"title":"[è¯‘]ä½¿ç”¨Borgåœ¨Googleç®¡ç†å¤§è§„æ¨¡é›†ç¾¤","uri":"/posts/brog-in-google/"},{"categories":["k8s"],"content":"2.4 åˆ†é…ï¼ˆAllocsï¼‰ Borgçš„allocï¼ˆallocationçš„ç¼©å†™ï¼‰æ˜¯ä¸€å°æœºå™¨ä¸Šçš„é¢„ç•™èµ„æºï¼Œå¯ä»¥ç”¨æ¥æ‰§è¡Œä¸€ä¸ªæˆ–å¤šä¸ªä»»åŠ¡ï¼›ä¸ç®¡æœ‰æ²¡æœ‰è¢«ä½¿ç”¨ï¼Œè¿™äº›èµ„æºéƒ½ç®—åˆ†é…å‡ºå»äº†ã€‚Allocså¯ä»¥ç»™å°†æ¥çš„ä»»åŠ¡é¢„ç•™èµ„æºï¼Œæˆ–åœ¨ä»»åŠ¡æš‚åœå’Œé‡å¯çš„é—´éš”ä¿æŒèµ„æºï¼Œä»¥åŠå°†ä¸åŒä½œä¸šçš„å¤šä¸ªä»»åŠ¡ç»‘å®šåœ¨åŒä¸€å°æœºå™¨ä¸Šâ€”â€”ä¾‹å¦‚ä¸€ä¸ªWebæœåŠ¡å™¨å®ä¾‹å’Œé™„åŠ çš„å°†å…¶URLæ—¥å¿—ä»æœ¬æœºç¡¬ç›˜æ‹·è´åˆ°åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿçš„æ—¥å¿—è½¬å­˜ä»»åŠ¡ã€‚Allocåƒä¸€å°æœºå™¨é‚£æ ·æ¥ç®¡ç†ï¼›è¿è¡Œåœ¨åŒä¸€ä¸ªAllocå†…çš„å¤šä¸ªä»»åŠ¡å…±äº«å…¶èµ„æºã€‚å¦‚æœä¸€ä¸ªAllocéœ€è¦è¿ç§»åˆ°å…¶å®ƒæœºå™¨ä¸Šï¼Œé‚£ä¹ˆå®ƒçš„ä»»åŠ¡ä¹Ÿè¦è·Ÿç€é‡æ–°è°ƒåº¦ã€‚ ä¸€ä¸ªAllocé›†åˆï¼Œå³ä¸€ç»„åœ¨å¤šå°æœºå™¨ä¸Šé¢„ç•™äº†èµ„æºçš„Allocï¼Œç±»ä¼¼äºä¸€ä¸ªä½œä¸šã€‚ä¸€æ—¦åˆ›å»ºäº†ä¸€ä¸ªAllocé›†åˆï¼Œå°±å¯ä»¥å‘å…¶æäº¤è‹¥å¹²ä½œä¸šã€‚ç®€ä¾¿èµ·è§ï¼Œæˆ‘ä»¬ç”¨ä»»åŠ¡è¡¨ç¤ºä¸€ä¸ªAllocæˆ–è€…ä¸€ä¸ªé¡¶å±‚ä»»åŠ¡ï¼ˆå³è¿è¡Œåœ¨Allocä¹‹å¤–çš„ä»»åŠ¡ï¼‰ï¼Œç”¨ä½œä¸šè¡¨ç¤ºä¸€ä¸ªæ™®é€šä½œä¸šæˆ–è€…Allocé›†åˆã€‚ ","date":"2022-05-31","objectID":"/posts/brog-in-google/:2:4","tags":["è½¬è½½","brog","cluster"],"title":"[è¯‘]ä½¿ç”¨Borgåœ¨Googleç®¡ç†å¤§è§„æ¨¡é›†ç¾¤","uri":"/posts/brog-in-google/"},{"categories":["k8s"],"content":"2.5 ä¼˜å…ˆçº§ã€é…é¢å’Œå‡†å…¥æ§åˆ¶ å½“å‡ºç°è¶…è¿‡ç³»ç»Ÿå®¹é‡çš„å·¥ä½œè´Ÿè½½ä¼šäº§ç”Ÿä»€ä¹ˆæƒ…å†µï¼Ÿæˆ‘ä»¬å¯¹æ­¤çš„è§£å†³æ–¹æ¡ˆæ˜¯ä¼˜å…ˆçº§å’Œé…é¢ã€‚ æ¯ä¸ªä½œä¸šéƒ½æœ‰ä¸€ä¸ªå°çš„æ­£æ•´æ•°è¡¨ç¤ºçš„ä¼˜å…ˆçº§ã€‚é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡å¯ä»¥ä¼˜å…ˆè·å¾—èµ„æºï¼Œç”šè‡³æŠ¢å ï¼ˆæ€æ­»ï¼‰ä½ä¼˜å…ˆçº§çš„ä»»åŠ¡ã€‚Borgä¸ºä¸åŒç”¨é€”å®šä¹‰äº†ä¸é‡å çš„ä¼˜å…ˆçº§åŒºé—´ï¼ŒåŒ…æ‹¬ï¼ˆä¼˜å…ˆçº§é™åºï¼‰ï¼šç›‘æ§ã€ç”Ÿäº§ã€æ‰¹å¤„ç†ã€å°½åŠ›ï¼ˆå³æµ‹è¯•çš„æˆ–å…è´¹çš„ï¼‰ã€‚æœ¬æ–‡ä¸­ï¼Œprodä½œä¸šçš„ä¼˜å…ˆçº§åŒ…æ‹¬ç›‘æ§å’Œç”Ÿäº§ä¸¤ä¸ªåŒºé—´ã€‚ è™½ç„¶ä¸€ä¸ªè¢«æŠ¢å çš„ä»»åŠ¡é€šå¸¸ä¼šè¢«é‡æ–°è°ƒåº¦åˆ°Cellçš„å…¶å®ƒæœºå™¨ä¸Šï¼Œä½†çº§è”æŠ¢å ä¹Ÿå¯èƒ½å‘ç”Ÿï¼šå¦‚æœæŸä¸ªä»»åŠ¡æŠ¢å äº†ä¸€ä¸ªä¼˜å…ˆçº§ç¨ä½çš„ä»»åŠ¡ï¼Œè€Œåè€…åˆæŠ¢å äº†å¦ä¸€ä¸ªä¼˜å…ˆçº§ç¨ä½çš„ï¼Œå¦‚æ­¤ç»§ç»­ã€‚ä¸ºé¿å…è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬ç¦æ­¢ç”Ÿäº§åŒºé—´çš„ä»»åŠ¡äº’ç›¸æŠ¢å ã€‚ç»†ç²’åº¦çš„ä¼˜å…ˆçº§åœ¨å…¶å®ƒåœºæ™¯ä¸‹ä¹Ÿå¾ˆæœ‰ç”¨ â€”â€” å¦‚MapReduceçš„Masterä»»åŠ¡çš„ä¼˜å…ˆçº§æ¯”å…¶ç®¡ç†çš„Workeré«˜ä¸€ç‚¹ï¼Œä»¥æé«˜å…¶å¯é æ€§ã€‚ ä¼˜å…ˆçº§è¡¨ç¤ºäº†Cellä¸­è¿è¡Œæˆ–ç­‰å¾…çš„ä½œä¸šä¹‹é—´çš„ç›¸å¯¹é‡è¦æ€§ã€‚é…é¢ï¼ˆQuotaï¼‰åˆ™ç”¨æ¥å†³å®šå‡†è®¸å“ªä¸ªä½œä¸šå¯ä»¥è¢«è°ƒåº¦ã€‚é…é¢æ˜¯ç‰¹å®šä¼˜å…ˆçº§å’Œæ—¶é—´æ®µï¼ˆå…¸å‹æ˜¯å‡ ä¸ªæœˆï¼‰çš„ä¸€ä¸ªèµ„æºå‘é‡ï¼ˆCPUï¼Œå†…å­˜ï¼Œç¡¬ç›˜ç­‰ï¼‰ã€‚é…é¢é™åˆ¶äº†ç”¨æˆ·çš„ä½œä¸šä¸€æ¬¡å¯ä»¥ç”³è¯·èµ„æºçš„æœ€å¤§æ•°é‡ï¼ˆå¦‚ï¼š20TBå†…å­˜ï¼Œprodä¼˜å…ˆçº§ï¼Œä»ç°åœ¨åˆ°7æœˆæœ«ï¼Œåœ¨xx Cellå†…ï¼‰ã€‚é…é¢æ£€æŸ¥æ˜¯å‡†å…¥æ§åˆ¶çš„ä¸€éƒ¨åˆ†ï¼Œè€Œä¸æ˜¯è°ƒåº¦çš„ï¼šé…é¢ä¸è¶³çš„ä½œä¸šæäº¤æ—¶å½“å³å°±ä¼šè¢«æ‹’ç»ã€‚ é«˜ä¼˜å…ˆçº§çš„é…é¢æ¯”ä½ä¼˜å…ˆçº§çš„æˆæœ¬è¦é«˜ã€‚ç”Ÿäº§çº§çš„é…é¢é™å®šäºä¸€ä¸ªCellçš„ç‰©ç†èµ„æºé‡ã€‚å› æ­¤ï¼Œç”¨æˆ·æäº¤äº†ä¸è¶…è¿‡é…é¢çš„ç”Ÿäº§çº§ä½œä¸šæ—¶ï¼Œä¸è€ƒè™‘èµ„æºç¢ç‰‡å’Œçº¦æŸï¼Œå¯ä»¥é¢„æœŸè¿™ä¸ªä½œä¸šä¸€å®šä¼šè¿è¡Œã€‚å°½ç®¡æˆ‘ä»¬é¼“åŠ±ç”¨æˆ·ä¸è¦è´­ä¹°è¶…è¿‡å…¶éœ€æ±‚çš„é…é¢ï¼Œä½†å¾ˆå¤šç”¨æˆ·ä»ç„¶è¶…ä¹°äº†ï¼Œè¿™æ ·ä»–ä»¬å°±ä¸ç”¨æ‹…å¿ƒç”±äºå°†æ¥åº”ç”¨ç”¨æˆ·é‡å¢é•¿å¯èƒ½å¯¼è‡´çš„é…é¢çŸ­ç¼ºã€‚æˆ‘ä»¬çš„åº”å¯¹æ–¹æ¡ˆæ˜¯å¯¹ä½ä¼˜å…ˆçº§èµ„æºé…é¢çš„è¶…å”®ï¼šæ‰€æœ‰ç”¨æˆ·çš„0ä¼˜å…ˆçº§é…é¢æ˜¯æ— é™çš„ï¼Œå°½ç®¡è¿™æ— æ³•å®ç°ã€‚ä½ä¼˜å…ˆçº§çš„ä½œä¸šè™½ç„¶è¢«æ¥æ”¶äº†ï¼Œä½†å¯èƒ½ç”±äºèµ„æºä¸è¶³è€Œä¸€ç›´ç­‰å¾…ã€‚ é…é¢åˆ†é…æ˜¯Borgä¹‹å¤–çš„ç³»ç»Ÿå¤„ç†çš„ï¼Œä¸æˆ‘ä»¬çš„ç‰©ç†å®¹é‡è§„åˆ’ç´§å¯†ç›¸å…³ã€‚å®¹é‡è§„åˆ’çš„ç»“æœåæ˜ åœ¨å„æ•°æ®ä¸­å¿ƒçš„ä»·æ ¼å’Œå¯ç”¨é…é¢ä¸Šã€‚åªæœ‰åœ¨å…¶è¦æ±‚çš„ä¼˜å…ˆçº§æœ‰è¶³å¤Ÿçš„é…é¢ï¼Œç”¨æˆ·çš„ä½œä¸šæ‰èƒ½è¢«æ¥æ”¶ã€‚é‡‡ç”¨é…é¢ä½¿å¾—ä¸»å¯¼èµ„æºå…¬å¹³æ€§ï¼ˆDRFï¼‰[29, 35, 36, 66]è¿™æ ·çš„ç­–ç•¥ä¸æ˜¯é‚£ä¹ˆå¿…è¦äº†ã€‚ Borgçš„å®¹é‡ç³»ç»Ÿå¯ä»¥ç»™æŸäº›ç”¨æˆ·ä¸€äº›ç‰¹æ®Šæƒé™ã€‚ä¾‹å¦‚ï¼Œå…è®¸ç®¡ç†å‘˜åˆ é™¤æˆ–ä¿®æ”¹Cellé‡Œçš„ä»»æ„ä½œä¸šï¼Œæˆ–è€…å…è®¸æŸä¸ªç”¨æˆ·æ“ä½œç‰¹å®šçš„å†…æ ¸ç‰¹æ€§æˆ–Borgè¡Œä¸ºï¼ˆå¦‚å¯¹å…¶ä½œä¸šç¦ç”¨èµ„æºä¼°è®¡ã€‚Â§5.5ï¼‰ã€‚ ","date":"2022-05-31","objectID":"/posts/brog-in-google/:2:5","tags":["è½¬è½½","brog","cluster"],"title":"[è¯‘]ä½¿ç”¨Borgåœ¨Googleç®¡ç†å¤§è§„æ¨¡é›†ç¾¤","uri":"/posts/brog-in-google/"},{"categories":["k8s"],"content":"2.6 åŸŸåå’Œç›‘æ§ ä»…ä»…åˆ›å»ºå’Œéƒ¨ç½²ä»»åŠ¡æ˜¯ä¸å¤Ÿçš„ï¼šä¸€ä¸ªæœåŠ¡çš„å®¢æˆ·ç«¯å’Œå…¶å®ƒç³»ç»Ÿéœ€è¦èƒ½æ‰¾åˆ°å®ƒä»¬ï¼Œå³ä½¿è¯¥æœåŠ¡è¢«é‡æ–°éƒ¨ç½²åˆ°å¦ä¸€å°æœºå™¨ä¹‹åã€‚ä¸ºå®ç°è¯¥éœ€æ±‚ï¼ŒBorgä¸ºæ¯ä¸ªä»»åŠ¡åˆ›å»ºäº†ä¸€ä¸ªå›ºå®šçš„BNSåŸŸåï¼ˆBNSï¼ŒBorg name Serviceï¼‰ï¼Œè¿™ä¸ªåŸŸååŒ…æ‹¬äº†Cellåï¼Œä½œä¸šåç§°å’Œä»»åŠ¡åºå·ã€‚BorgæŠŠä»»åŠ¡çš„ä¸»æœºåå’Œç«¯å£å†™å…¥Chubby[14]çš„ä¸€ä¸ªæŒä¹…åŒ–é«˜å¯ç”¨æ–‡ä»¶é‡Œï¼Œä»¥BNSåŸŸåä¸ºæ–‡ä»¶åã€‚è¿™ä¸ªæ–‡ä»¶è¢«RPCç”¨æ¥å‘ç°ä»»åŠ¡çš„å®é™…åœ°å€ã€‚BNSåŸŸåä¹Ÿæ˜¯ä»»åŠ¡çš„DNSåŸŸåçš„ä¸€éƒ¨åˆ†ï¼Œä¾‹å¦‚ï¼Œcc Cellçš„ubarç”¨æˆ·çš„jfoo ä½œä¸šçš„ç¬¬50ä¸ªä»»åŠ¡å¯ä»¥é€šè¿‡50.jfoo.ubar.cc.borg.google.comæ¥è®¿é—®ã€‚æ¯å½“çŠ¶æ€æ”¹å˜æ—¶ï¼ŒBorgè¿˜ä¼šæŠŠä½œä¸šçš„å¤§å°å’Œä»»åŠ¡çš„å¥åº·ä¿¡æ¯å†™å…¥åˆ°Chubbyï¼Œè¿™æ ·è´Ÿè½½å‡è¡¡å™¨å°±çŸ¥é“å¦‚ä½•è·¯ç”±è¯·æ±‚äº†ã€‚ å‡ ä¹æ¯ä¸ªä»»åŠ¡éƒ½æœ‰ä¸€ä¸ªå†…ç½®çš„HTTPæœåŠ¡å™¨ï¼Œç”¨æ¥å‘å¸ƒä»»åŠ¡çš„å¥åº·ä¿¡æ¯å’Œå‡ åƒä¸ªæ€§èƒ½æŒ‡æ ‡ï¼ˆå¦‚RPCå»¶æ—¶ï¼‰ã€‚Borgç›‘æ§è¿™äº›å¥åº·æ£€æŸ¥çš„URLï¼Œé‡å¯é‚£äº›æ²¡æœ‰ç«‹åˆ»å“åº”æˆ–è¿”å›HTTPé”™è¯¯ç çš„ä»»åŠ¡ã€‚ç›‘æ§å·¥å…·è·Ÿè¸ªå…¶å®ƒæ•°æ®å¹¶æ˜¾ç¤ºåœ¨ä»ªè¡¨ç›˜ä¸Šï¼Œå½“è¿åæœåŠ¡æ°´å¹³ç›®æ ‡ï¼ˆSLOï¼‰æ—¶æŠ¥è­¦ã€‚ ç”¨æˆ·å¯ä»¥ä½¿ç”¨ä¸€ä¸ªç§°ä¸ºSigmaçš„Webç•Œé¢æ¥æ£€æŸ¥ä»–çš„æ‰€æœ‰ä½œä¸šçš„çŠ¶æ€ï¼Œé’ˆå¯¹æŸä¸ªCellï¼Œæˆ–è€…æ·±å…¥æŸä¸ªä½œä¸šåŠä»»åŠ¡ï¼Œæ£€æŸ¥å…¶èµ„æºä½¿ç”¨è¡Œä¸ºã€è¯¦ç»†æ—¥å¿—ã€æ‰§è¡Œå†å²å’Œæœ€ç»ˆç»“æœã€‚æˆ‘ä»¬çš„åº”ç”¨äº§ç”Ÿå¤§é‡çš„æ—¥å¿—ï¼Œå®ƒä»¬éƒ½ä¼šè¢«è‡ªåŠ¨çš„æ»šåŠ¨ä»¥é¿å…è€—å°½ç¡¬ç›˜ç©ºé—´ã€‚ä»»åŠ¡é€€å‡ºåï¼Œæ—¥å¿—ä¼šä¿ç•™ä¸€å°æ®µæ—¶é—´ä»¥å¸®åŠ©è°ƒè¯•ã€‚å¦‚æœä¸€ä¸ªä½œä¸šæ²¡æœ‰è¿è¡Œèµ·æ¥ï¼ŒBorgä¼šæä¾›ä¸€ä¸ªæŒ‚èµ·åŸå› çš„æ ‡æ³¨ï¼Œä»¥åŠå»ºè®®å¦‚ä½•ä¿®æ”¹ä½œä¸šçš„èµ„æºè¯·æ±‚ï¼Œä»¥ä½¿å…¶æ›´é€‚åˆCellã€‚æˆ‘ä»¬å‘å¸ƒäº†å¦‚ä½•ä½¿èµ„æºè¯·æ±‚æ›´å®¹æ˜“è¢«è°ƒåº¦çš„æŒ‡å—ã€‚ Borgå°†æ‰€æœ‰çš„ä½œä¸šæäº¤ã€ä»»åŠ¡äº‹ä»¶ã€ä»¥åŠæ¯ä¸ªä»»åŠ¡çš„è¯¦ç»†èµ„æºä½¿ç”¨éƒ½è®°å½•åœ¨Infrastoreé‡Œã€‚Infrastoreæ˜¯ä¸€ä¸ªå¯æ‰©å±•çš„åªè¯»æ•°æ®å­˜å‚¨ï¼Œé€šè¿‡Dremel[61]æä¾›äº†ç±»ä¼¼SQLçš„äº¤äº’å¼æ¥å£ã€‚è¿™äº›æ•°æ®ç”¨ä»¥æ”¯æŒåŸºäºä½¿ç”¨é‡çš„æ”¶è´¹ï¼Œè°ƒè¯•ä½œä¸šå’Œç³»ç»Ÿæ•…éšœï¼Œä»¥åŠé•¿æœŸå®¹é‡è§„åˆ’ã€‚å…¬å¼€çš„Googleé›†ç¾¤è´Ÿè½½æ•°æ®é›†[80]ä¹Ÿæ¥è‡ªäºè¿™äº›æ•°æ®ã€‚ æ‰€æœ‰è¿™äº›ç‰¹æ€§å¸®åŠ©ç”¨æˆ·ç†è§£å’Œè°ƒè¯•BorgåŠå…¶ä½œä¸šçš„è¡Œä¸ºï¼Œå¹¶å¸®åŠ©æˆ‘ä»¬çš„SREå®ç°æ¯äººç®¡ç†è¶…è¿‡ä¸Šä¸‡å°æœºå™¨ã€‚ ","date":"2022-05-31","objectID":"/posts/brog-in-google/:2:6","tags":["è½¬è½½","brog","cluster"],"title":"[è¯‘]ä½¿ç”¨Borgåœ¨Googleç®¡ç†å¤§è§„æ¨¡é›†ç¾¤","uri":"/posts/brog-in-google/"},{"categories":["k8s"],"content":"3. Borgæ¶æ„ ä¸€ä¸ªBorgçš„CellåŒ…æ‹¬ä¸€ç»„æœºå™¨ï¼Œä¸€ä¸ªé€»è¾‘ä¸Šé›†ä¸­çš„æ§åˆ¶å™¨ï¼Œç§°ä¸ºBorgmasterï¼Œä»¥åŠè¿è¡Œåœ¨æ¯å°æœºå™¨ä¸Šçš„ç§°ä¸ºBorgletçš„ä»£ç†è¿›ç¨‹ï¼ˆè§å›¾1ï¼‰ã€‚Borgçš„ç»„ä»¶éƒ½æ˜¯ç”¨C++å®ç°çš„ã€‚ ","date":"2022-05-31","objectID":"/posts/brog-in-google/:3:0","tags":["è½¬è½½","brog","cluster"],"title":"[è¯‘]ä½¿ç”¨Borgåœ¨Googleç®¡ç†å¤§è§„æ¨¡é›†ç¾¤","uri":"/posts/brog-in-google/"},{"categories":["k8s"],"content":"3.1 Borgmaster Cellçš„Borgmasterç”±ä¸¤ä¸ªè¿›ç¨‹ç»„æˆï¼šBorgmasterä¸»è¿›ç¨‹å’Œä¸€ä¸ªå•ç‹¬çš„è°ƒåº¦è¿›ç¨‹ï¼ˆÂ§3.2ï¼‰ã€‚Borgmasterä¸»è¿›ç¨‹å¤„ç†å®¢æˆ·ç«¯çš„RPCï¼ŒåŒ…æ‹¬ä¿®æ”¹çŠ¶æ€ï¼ˆå¦‚åˆ›å»ºä½œä¸šï¼‰ï¼Œæˆ–æä¾›åªè¯»æ•°æ®ï¼ˆå¦‚æŸ¥æ‰¾ä½œä¸šï¼‰ã€‚å®ƒè¿˜ç®¡ç†ç€ç³»ç»Ÿä¸­æ‰€æœ‰å¯¹è±¡ï¼ˆæœºå™¨ã€ä»»åŠ¡ã€Allocsç­‰ï¼‰çš„çŠ¶æ€ï¼Œä¸Borgleté€šä¿¡ï¼Œå¹¶æä¾›ä¸€ä¸ªWeb UIï¼ˆä½œä¸ºSigmaçš„å¤‡ä»½ï¼‰ã€‚ Borgmasteråœ¨é€»è¾‘ä¸Šæ˜¯å•ä¸ªè¿›ç¨‹ï¼Œä½†å®é™…ä¸Šæœ‰5ä¸ªå‰¯æœ¬ã€‚æ¯ä¸ªå‰¯æœ¬åœ¨å†…å­˜ç»´æŠ¤ç€CellçŠ¶æ€çš„æ‹·è´ï¼Œè¯¥çŠ¶æ€åŒæ—¶ä¿å­˜åœ¨ç”±è¿™äº›å‰¯æœ¬çš„æœ¬åœ°ç¡¬ç›˜ç»„æˆçš„ä¸€ä¸ªåŸºäºPaxos[55]çš„é«˜å¯ç”¨ã€åˆ†å¸ƒå¼å­˜å‚¨ä¸Šã€‚æ¯ä¸ªCellä¸­ä»…æœ‰ä¸€ä¸ªé€‰ä¸¾å‡ºæ¥çš„Masterï¼Œå®ƒåŒæ—¶ä½œä¸ºPaxosçš„Leaderå’ŒçŠ¶æ€ä¿®æ”¹è€…ï¼Œå¤„ç†æ‰€æœ‰å˜æ›´CellçŠ¶æ€çš„è¯·æ±‚ï¼Œä¾‹å¦‚æäº¤ä½œä¸šæˆ–è€…ç»“æŸæŸå°æœºå™¨ä¸Šçš„ä¸€ä¸ªä»»åŠ¡ã€‚å½“Cellå¯åŠ¨æˆ–è€…ä¸Šä¸€ä¸ªMasteræ•…éšœæ—¶ï¼Œæ–°çš„Masterä¼šé€šè¿‡Paxosç®—æ³•é€‰ä¸¾å‡ºæ¥ï¼›æ–°Masterä¼šè·å–ä¸€ä¸ªChubbyé”ï¼Œè¿™æ ·å…¶å®ƒçš„ç³»ç»Ÿå°±å¯ä»¥æ‰¾åˆ°å®ƒã€‚é€‰ä¸¾å¹¶è½¬ç§»åˆ°æ–°çš„Masteré€šå¸¸éœ€è¦10ç§’ï¼Œä½†åœ¨å¤§çš„Cellé‡Œå¯èƒ½éœ€è¦é•¿è¾¾1åˆ†é’Ÿï¼Œå› ä¸ºéœ€è¦é‡æ„ä¸€äº›å†…å­˜çŠ¶æ€ã€‚å½“ä¸€ä¸ªå‰¯æœ¬ä»å®•æœºæ¢å¤åï¼Œå®ƒä¼šåŠ¨æ€åœ°ä»å…¶å®ƒæœ€æ–°çš„Paxoså‰¯æœ¬ä¸­é‡æ–°åŒæ­¥è‡ªå·±çš„çŠ¶æ€ã€‚ æŸä¸ªæ—¶åˆ»çš„BorgmasterçŠ¶æ€è¢«ç§°ä¸ºæ£€æŸ¥ç‚¹ï¼ˆCheckpointï¼‰ï¼Œä»¥å®šæœŸå¿«ç…§åŠ å˜æ›´æ—¥å¿—çš„å½¢å¼ä¿å­˜åœ¨Paxoså­˜å‚¨é‡Œã€‚æ£€æŸ¥ç‚¹æœ‰å¾ˆå¤šç”¨é€”ï¼šå¦‚é‡å»ºè¿‡å»ä»»æ„æ—¶åˆ»çš„BorgmasterçŠ¶æ€ï¼ˆä¾‹å¦‚ï¼Œåœ¨æ¥æ”¶ä¸€ä¸ªè§¦å‘äº†Borgæ•…éšœçš„è¯·æ±‚ä¹‹å‰çš„æ—¶åˆ»ï¼Œè¿™æ ·å°±å¯ä»¥ç”¨æ¥è°ƒè¯•ï¼‰ï¼›ç‰¹åˆ«æƒ…å†µä¸‹å¯ä»¥æ‰‹å·¥ä¿®å¤æ£€æŸ¥ç‚¹ï¼›æ„å»ºä¸€ä¸ªæŒä¹…çš„äº‹ä»¶æ—¥å¿—ä¾›æ—¥åæŸ¥è¯¢ï¼›æˆ–ç”¨äºç¦»çº¿ä»¿çœŸã€‚ ä¸€ä¸ªé«˜ä¿çœŸçš„Borgmasteræ¨¡æ‹Ÿå™¨ï¼Œç§°ä¸ºFauxmasterï¼Œå¯ä»¥è¯»å–æ£€æŸ¥ç‚¹æ–‡ä»¶ã€‚Fauxmasterçš„ä»£ç æ‹·è´è‡ªçº¿ä¸Šçš„Borgmasterï¼Œè¿˜æœ‰å¯¹Borgletçš„å­˜æ ¹æ¥å£ã€‚å®ƒæ¥æ”¶RPCæ¥æ”¹å˜çŠ¶æ€ï¼Œæ‰§è¡Œæ“ä½œï¼Œä¾‹å¦‚â€œè°ƒåº¦æ‰€æœ‰ç­‰å¾…çš„ä»»åŠ¡â€ã€‚æˆ‘ä»¬ç”¨å®ƒæ¥è°ƒè¯•æ•…éšœï¼Œåƒè·Ÿåœ¨çº¿çš„Borgmasteré‚£æ ·ä¸æ¨¡æ‹Ÿå™¨äº¤äº’ï¼Œç”¨æ¨¡æ‹Ÿçš„Borgleté‡æ”¾æ£€æŸ¥ç‚¹æ–‡ä»¶é‡Œçš„çœŸå®äº¤äº’ã€‚ç”¨æˆ·å¯ä»¥å•æ­¥æ‰§è¡Œå¹¶è§‚å¯Ÿç³»ç»Ÿè¿‡å»ç¡®å®å‘ç”Ÿäº†çš„çŠ¶æ€å˜åŒ–ã€‚Fauxmasterä¹Ÿç”¨äºå®¹é‡è§„åˆ’ï¼ˆå¯ä»¥æ¥æ”¶å¤šå°‘ä¸ªæ­¤ç±»å‹çš„ä½œä¸šï¼Ÿï¼‰ï¼Œä»¥åŠåœ¨å®é™…æ›´æ”¹Cellé…ç½®å‰åšå¯è¡Œæ€§æ£€æŸ¥ï¼ˆè¿™ä¸ªå˜æ›´ä¼šå¯¼è‡´å…³é”®ä½œä¸šå¼‚å¸¸é€€å‡ºå—ï¼Ÿï¼‰ ","date":"2022-05-31","objectID":"/posts/brog-in-google/:3:1","tags":["è½¬è½½","brog","cluster"],"title":"[è¯‘]ä½¿ç”¨Borgåœ¨Googleç®¡ç†å¤§è§„æ¨¡é›†ç¾¤","uri":"/posts/brog-in-google/"},{"categories":["k8s"],"content":"3.2 è°ƒåº¦ å½“æäº¤ä¸€ä¸ªä½œä¸šåï¼ŒBorgmasterä¼šæŠŠå®ƒä¿å­˜åœ¨æŒä¹…çš„Paxoså­˜å‚¨ä¸Šï¼Œå¹¶å°†è¿™ä¸ªä½œä¸šçš„æ‰€æœ‰ä»»åŠ¡åŠ å…¥ç­‰å¾…é˜Ÿåˆ—ä¸­ã€‚è°ƒåº¦å™¨å¼‚æ­¥åœ°æ‰«æç­‰å¾…é˜Ÿåˆ—ï¼Œå°†ä»»åŠ¡åˆ†é…åˆ°æ»¡è¶³ä½œä¸šçº¦æŸä¸”æœ‰è¶³å¤Ÿèµ„æºçš„æœºå™¨ä¸Šï¼ˆè°ƒåº¦æ˜¯é’ˆå¯¹ä»»åŠ¡çš„ï¼Œè€Œéä½œä¸šï¼‰ã€‚é˜Ÿåˆ—æ‰«æä»é«˜ä¼˜å…ˆçº§åˆ°ä½ä¼˜å…ˆçº§ï¼ŒåŒä¼˜å…ˆçº§åˆ™ä»¥è½®è½¬çš„æ–¹å¼å¤„ç†ï¼Œä»¥ä¿è¯ç”¨æˆ·é—´çš„å…¬å¹³ï¼Œå¹¶é¿å…é˜Ÿé¦–çš„å¤§å‹ä½œä¸šé˜»å¡é˜Ÿåˆ—ã€‚è°ƒåº¦ç®—æ³•æœ‰ä¸¤ä¸ªéƒ¨åˆ†ï¼šå¯è¡Œæ€§æ£€æŸ¥ï¼Œæ‰¾åˆ°ä¸€ç»„å¯ä»¥è¿è¡Œä»»åŠ¡çš„æœºå™¨ï¼›è¯„åˆ†ï¼Œä»ä¸­é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„æœºå™¨ã€‚ åœ¨å¯è¡Œæ€§æ£€æŸ¥é˜¶æ®µï¼Œè°ƒåº¦å™¨ä¼šæ‰¾åˆ°ä¸€ç»„æ»¡è¶³ä»»åŠ¡çº¦æŸä¸”æœ‰è¶³å¤Ÿå¯ç”¨èµ„æºçš„æœºå™¨ â€”â€” å¯ç”¨èµ„æºåŒ…æ‹¬å·²ç»åˆ†é…ç»™ä½ä¼˜å…ˆçº§ä»»åŠ¡ä½†å¯ä»¥æŠ¢å çš„èµ„æºã€‚åœ¨è¯„åˆ†é˜¶æ®µï¼Œè°ƒåº¦å™¨ç¡®å®šæ¯å°å¯è¡Œæœºå™¨çš„é€‚å®œæ€§ã€‚è¯„åˆ†è€ƒè™‘äº†ç”¨æˆ·ç‰¹å®šçš„åå¥½ï¼Œä½†ä¸»è¦å–å†³äºå†…å»ºçš„æ ‡å‡†ï¼šä¾‹å¦‚æœ€å°åŒ–è¢«æŠ¢å ä»»åŠ¡çš„ä¸ªæ•°å’Œä¼˜å…ˆçº§ï¼Œé€‰æ‹©å·²ç»æœ‰è¯¥ä»»åŠ¡å®‰è£…åŒ…çš„æœºå™¨ï¼Œå°½å¯èƒ½ä½¿ä»»åŠ¡åˆ†æ•£åœ¨ä¸åŒçš„ä¾›ç”µå’Œæ•…éšœåŸŸï¼Œä»¥åŠè£…ç®±ï¼ˆPackingï¼‰è´¨é‡ï¼ˆåœ¨å•å°æœºå™¨ä¸Šæ··åˆé«˜ã€ä½ä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼Œä»¥å…è®¸é«˜ä¼˜å…ˆçº§ä»»åŠ¡åœ¨è´Ÿè½½å°–å³°æ‰©å®¹ï¼‰ç­‰ã€‚ Borgæ—©æœŸä½¿ç”¨ä¿®æ”¹è¿‡çš„E-PVM[4]ç®—æ³•æ¥è¯„åˆ†ã€‚è¿™ä¸ªç®—æ³•å¯¹å¼‚æ„çš„èµ„æºç”Ÿæˆç­‰æ•ˆçš„æˆæœ¬å€¼ï¼Œæ”¾ç½®ä»»åŠ¡çš„ç›®æ ‡æ˜¯ä½¿æˆæœ¬çš„å˜åŒ–é‡æœ€å°ã€‚åœ¨å®è·µä¸­ï¼ŒE-PVMä¼šæŠŠè´Ÿè½½åˆ†æ•£åˆ°æ‰€æœ‰æœºå™¨ï¼Œä¸ºè´Ÿè½½å°–å³°é¢„ç•™å‡ºèµ„æº â€”â€” è¿™æ ·çš„ä»£ä»·æ˜¯å¢åŠ äº†ç¢ç‰‡ï¼Œç‰¹åˆ«æ˜¯å¯¹éœ€è¦å¤§éƒ¨åˆ†æœºå™¨çš„å¤§å‹ä»»åŠ¡è€Œè¨€ï¼›æˆ‘ä»¬æœ‰æ—¶ç§°å…¶ä¸ºâ€œæœ€å·®åŒ¹é…â€ã€‚ ä¸ä¹‹ç›¸åçš„æ˜¯â€œæœ€ä½³åŒ¹é…â€ï¼ŒæŠŠæœºå™¨ä¸Šçš„ä»»åŠ¡å¡çš„è¶Šæ»¡è¶Šå¥½ã€‚è¿™å°±â€œç©ºâ€å‡ºä¸€äº›æ²¡æœ‰ç”¨æˆ·ä½œä¸šçš„æœºå™¨ï¼ˆå®ƒä»¬ä»è¿è¡Œå­˜å‚¨æœåŠ¡ï¼‰ï¼Œè¿™æ ·æ”¾ç½®å¤§å‹ä»»åŠ¡å°±æ¯”è¾ƒç›´æ¥äº†ã€‚ä½†æ˜¯ï¼Œå¦‚æœç”¨æˆ·æˆ–Borgé”™è¯¯ä¼°è®¡äº†èµ„æºéœ€æ±‚ï¼Œç´§å®çš„è£…ç®±ä¼šå¯¹æ­¤é€ æˆï¼ˆæ€§èƒ½ä¸Šçš„ï¼‰æƒ©ç½šã€‚è¿™ç§ç­–ç•¥ä¸åˆ©äºæœ‰çªå‘è´Ÿè½½çš„åº”ç”¨ï¼Œè€Œä¸”å¯¹ç”³è¯·å°‘é‡CPUçš„æ‰¹å¤„ç†ä½œä¸šç‰¹åˆ«ä¸å‹å¥½ï¼Œè¿™äº›ä½œä¸šç”³è¯·å°‘é‡CPUæœ¬æ¥æ˜¯ä¸ºäº†æ›´å®¹æ˜“è¢«è°ƒåº¦æ‰§è¡Œï¼Œå¹¶æŠ“ä½æœºä¼šä½¿ç”¨ç©ºé—²èµ„æºï¼š20%çš„non-prod ä»»åŠ¡ç”³è¯·å°‘äº0.1ä¸ªCPUæ ¸ã€‚ æˆ‘ä»¬ç›®å‰çš„è¯„åˆ†æ¨¡å‹æ˜¯æ··åˆçš„ï¼Œè¯•å›¾å‡å°‘ææµ…ï¼ˆStrandedï¼‰çš„èµ„æºï¼ˆæŒ‡æŸäº›ç±»å‹èµ„æºåˆ†é…å®Œä¹‹åï¼Œä¸€å°æœºå™¨ä¸Šæ— æ³•åˆ†é…çš„å…¶å®ƒç±»å‹èµ„æºï¼‰ã€‚å¯¹æˆ‘ä»¬çš„è´Ÿè½½è€Œè¨€ï¼Œè¿™ä¸ªæ¨¡å‹æ¯”â€œæœ€ä½³åŒ¹é…â€æå‡äº†3%-5%çš„è£…ç®±æ•ˆç‡ï¼ˆä»¥[78]å®šä¹‰çš„æ–¹å¼è¯„ä»·ï¼‰ã€‚ å¦‚æœè¯„åˆ†åé€‰ä¸­çš„ä¸€å°æœºå™¨ä»æ²¡æœ‰è¶³å¤Ÿçš„èµ„æºæ¥è¿è¡Œæ–°ä»»åŠ¡ï¼ŒBorgä¼šæŠ¢å ä½ä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼Œä»æœ€ä½ä¼˜å…ˆçº§å‘ä¸Šé€çº§æŠ¢å ï¼Œç›´åˆ°èµ„æºè¶³å¤Ÿè¿è¡Œè¯¥ä»»åŠ¡ã€‚è¢«æŠ¢å çš„ä»»åŠ¡æ”¾å›åˆ°è°ƒåº¦å™¨çš„ç­‰å¾…é˜Ÿåˆ—é‡Œï¼Œè€Œä¸æ˜¯è¢«è¿ç§»æˆ–ä¼‘çœ åŸæ³¨3: ä¾‹å¤–æƒ…å†µæ˜¯ï¼Œä¸ºGoogle Compute Engineæä¾›è™šæ‹Ÿæœºçš„ä»»åŠ¡ä¼šè¢«è¿ç§»ã€‚ ä»»åŠ¡çš„å¯åŠ¨å»¶è¿Ÿï¼ˆä»æäº¤ä½œä¸šåˆ°ä»»åŠ¡å¼€å§‹è¿è¡Œä¹‹é—´çš„æ—¶é—´æ®µï¼‰æ˜¯æˆ‘ä»¬æŒç»­é‡ç‚¹å…³æ³¨çš„ã€‚è¿™ä¸ªæ—¶é—´å·®åˆ«å¾ˆå¤§ï¼Œä¸­ä½æ•°çº¦25ç§’ã€‚å®‰è£…è½¯ä»¶åŒ…è€—è´¹äº†å…¶ä¸­80%çš„æ—¶é—´ï¼šä¸€ä¸ªå·²çŸ¥çš„ç“¶é¢ˆå°±æ˜¯è½¯ä»¶åŒ…å†™å…¥æ—¶å¯¹æœ¬åœ°ç¡¬ç›˜çš„ç«äº‰ã€‚ä¸ºäº†å‡å°‘ä»»åŠ¡å¯åŠ¨æ—¶é—´ï¼Œè°ƒåº¦å™¨åå¥½å°†ä»»åŠ¡åˆ†é…åˆ°å·²ç»æœ‰å¿…éœ€çš„è½¯ä»¶åŒ…ï¼ˆç¨‹åºåŠæ•°æ®ï¼‰çš„æœºå™¨ï¼šå¤§éƒ¨åˆ†åŒ…æ˜¯åªè¯»çš„ï¼Œæ‰€ä»¥å¯ä»¥è¢«å…±äº«å’Œç¼“å­˜ï¼ˆè¿™æ˜¯Borgè°ƒåº¦å™¨å”¯ä¸€çš„ä¸€ç§æ•°æ®å±€éƒ¨æ€§æ”¯æŒï¼‰ã€‚å¦å¤–ï¼ŒBorgé€šè¿‡æ ‘å½¢å’Œç±»ä¼¼BTçš„åè®®å¹¶å‘åœ°å°†è½¯ä»¶åŒ…åˆ†å‘åˆ°å¤šä¸ªæœºå™¨ä¸Šã€‚ æ­¤å¤–ï¼Œè°ƒåº¦å™¨é‡‡ç”¨å¤šç§æŠ€æœ¯ä½¿å…¶èƒ½å¤Ÿæ‰©å±•åˆ°æ•°ä¸‡å°æœºå™¨çš„Cellï¼ˆÂ§3.4ï¼‰ã€‚ ","date":"2022-05-31","objectID":"/posts/brog-in-google/:3:2","tags":["è½¬è½½","brog","cluster"],"title":"[è¯‘]ä½¿ç”¨Borgåœ¨Googleç®¡ç†å¤§è§„æ¨¡é›†ç¾¤","uri":"/posts/brog-in-google/"},{"categories":["k8s"],"content":"3.3 Borglet Borgletæ˜¯éƒ¨ç½²åœ¨Cellæ¯å°æœºå™¨ä¸Šçš„æœ¬æœºBorgä»£ç†ã€‚å®ƒè´Ÿè´£å¯åŠ¨å’Œåœæ­¢ä»»åŠ¡ï¼›é‡å¯å¤±è´¥çš„ä»»åŠ¡ï¼›é€šè¿‡OSå†…æ ¸è®¾ç½®æ¥ç®¡ç†æœ¬åœ°èµ„æºï¼›æ»šåŠ¨è°ƒè¯•æ—¥å¿—ï¼›æŠŠæœ¬æœºçš„çŠ¶æ€ä¸ŠæŠ¥ç»™Borgmasterå’Œå…¶å®ƒç›‘æ§ç³»ç»Ÿã€‚ Borgmasteræ¯è¿‡å‡ ç§’å°±ä¼šè½®è¯¢æ¯ä¸ªBorgletæ¥è·å–æœºå™¨çš„å½“å‰çŠ¶æ€ï¼Œå¹¶å‘å…¶å‘é€è¯·æ±‚ã€‚è¿™è®©Borgmasterèƒ½æ§åˆ¶é€šä¿¡é¢‘ç‡ï¼Œçœå»äº†æ˜¾å¼çš„æµé‡æ§åˆ¶æœºåˆ¶ï¼Œè€Œä¸”é˜²æ­¢äº†æ¢å¤é£æš´[9]ã€‚ é€‰ä¸¾å‡ºæ¥çš„Masterè´Ÿè´£å‡†å¤‡å‘é€ç»™Borgletçš„æ¶ˆæ¯ï¼Œå¹¶æ ¹æ®Borgletçš„å“åº”æ›´æ–°Cellçš„çŠ¶æ€ã€‚ä¸ºä½¿æ€§èƒ½å¯æ‰©å±•ï¼Œæ¯ä¸ªBorgmasterå‰¯æœ¬ä¼šè´Ÿè´£ä¸€ä¸ªæ— çŠ¶æ€çš„é“¾æ¥åˆ†ç‰‡ï¼ˆLink Shardï¼‰æ¥å¤„ç†éƒ¨åˆ†Borgletçš„é€šä¿¡ï¼›Borgmasteré€‰ä¸¾åé‡æ–°è®¡ç®—é“¾æ¥çš„åˆ†ç‰‡ã€‚ä¸ºäº†ä¿è¯å¼¹æ€§ï¼ˆResiliencyï¼‰ï¼ŒBorgletæ€»æ˜¯æ±‡æŠ¥å…¨éƒ¨çŠ¶æ€ï¼Œä½†æ˜¯Link Shardåªæ±‡æŠ¥å˜åŒ–å€¼ï¼Œä»è€Œèšåˆã€å‹ç¼©è¿™äº›ä¿¡æ¯ï¼Œå‡å°‘Masteræ›´æ–°çš„è´Ÿæ‹…ã€‚ å¦‚æœæŸä¸ªBorgletå‡ æ¬¡æ²¡æœ‰å“åº”è½®è¯¢è¯·æ±‚ï¼Œè¯¥æœºå™¨ä¼šè¢«æ ‡è®°ä¸ºå®•æœºï¼Œå…¶ä¸Šè¿è¡Œçš„æ‰€æœ‰ä»»åŠ¡ä¼šè¢«é‡æ–°è°ƒåº¦åˆ°å…¶å®ƒæœºå™¨ã€‚å¦‚æœé€šè®¯æ¢å¤äº†ï¼ŒBorgmasterä¼šè®©è¿™ä¸ªBorgletæ€æ‰å·²ç»è¢«é‡æ–°è°ƒåº¦å‡ºå»çš„ä»»åŠ¡ï¼Œä»¥é¿å…é‡å¤ã€‚å³ä¾¿æ— æ³•ä¸Borgmasteré€šä¿¡ï¼ŒBorgletä»ä¼šç»§ç»­æ­£å¸¸è¿è¡Œã€‚æ‰€ä»¥å³ä½¿æ‰€æœ‰çš„Borgmasteréƒ½å‡ºæ•…éšœäº†ï¼Œæ­£åœ¨è¿è¡Œçš„ä»»åŠ¡å’ŒæœåŠ¡è¿˜ä¼šä¿æŒè¿è¡Œã€‚ ","date":"2022-05-31","objectID":"/posts/brog-in-google/:3:3","tags":["è½¬è½½","brog","cluster"],"title":"[è¯‘]ä½¿ç”¨Borgåœ¨Googleç®¡ç†å¤§è§„æ¨¡é›†ç¾¤","uri":"/posts/brog-in-google/"},{"categories":["k8s"],"content":"3.4 æ‰©å±•æ€§ æˆ‘ä»¬è¿˜æ²¡æœ‰é‡åˆ°Borgè¿™ç§é›†ä¸­å¼æ¶æ„çš„ç»ˆææ‰©å±•ä¸Šé™ã€‚æˆ‘ä»¬é¡ºåˆ©åœ°çªç ´äº†é‡åˆ°çš„æ¯ä¸ªé™åˆ¶ã€‚ä¸€ä¸ªå•ç‹¬çš„Borgmasterå¯ä»¥ç®¡ç†æœ‰æ•°åƒå°æœºå™¨çš„Cellï¼Œæœ‰äº›Cellæ¯åˆ†é’Ÿæœ‰10000å¤šä¸ªä»»åŠ¡åˆ°è¾¾ã€‚ä¸€ä¸ªç¹å¿™çš„Borgmasterä½¿ç”¨10~14ä¸ªCPUæ ¸ä»¥åŠ50GBå†…å­˜ã€‚æˆ‘ä»¬ç”¨äº†å‡ é¡¹æŠ€æœ¯æ¥å®ç°è¿™ç§æ‰©å±•æ€§ã€‚ æ—©æœŸç‰ˆæœ¬çš„Borgmasterä½¿ç”¨ä¸€ä¸ªç®€å•çš„ï¼ŒåŒæ­¥çš„å¾ªç¯æ¥å¤„ç†è¯·æ±‚ã€è°ƒåº¦ä»»åŠ¡ï¼Œå¹¶ä¸Borgleté€šä¿¡ã€‚ä¸ºäº†å¤„ç†æ›´å¤§çš„Cellï¼Œæˆ‘ä»¬æŠŠè°ƒåº¦å™¨åˆ†ç¦»ä¸ºä¸€ä¸ªå•ç‹¬çš„è¿›ç¨‹ï¼Œè¿™æ ·å®ƒå°±å¯ä»¥ä¸å…¶å®ƒçš„BorgmasteråŠŸèƒ½å¹¶è¡Œæ‰§è¡Œï¼Œè€Œè¿™äº›å…¶å®ƒçš„åŠŸèƒ½æœ‰å¤šå‰¯æœ¬ä»¥ä¾¿å®¹é”™ã€‚è°ƒåº¦å™¨ä½¿ç”¨ä¸€ä»½ç¼“å­˜çš„CellçŠ¶æ€æ‹·è´ï¼Œé‡å¤æ‰§è¡Œä¸‹é¢çš„æ“ä½œï¼šä»é€‰ä¸¾å‡ºæ¥çš„Masterè·å–çŠ¶æ€å˜æ›´ï¼ˆåŒ…æ‹¬å·²åˆ†é…çš„å’Œç­‰å¾…ä¸­çš„å·¥ä½œï¼‰ï¼›æ›´æ–°è‡ªå·±çš„æœ¬åœ°æ‹·è´ï¼›æ‰§è¡Œä¸€è½®è°ƒåº¦æ¥åˆ†é…ä»»åŠ¡ï¼›å°†åˆ†é…ä¿¡æ¯å‘é€ç»™Masterã€‚Masterä¼šæ¥å—å¹¶åº”ç”¨è¿™äº›åˆ†é…ï¼Œä½†å¦‚æœåˆ†é…ä¸é€‚åˆï¼ˆä¾‹å¦‚ï¼Œæ˜¯åŸºäºè¿‡æ—¶çš„çŠ¶æ€åšå‡ºçš„ï¼‰ï¼Œå°±ä¼šç­‰å¾…è°ƒåº¦å™¨çš„ä¸‹ä¸€è½®è°ƒåº¦ã€‚è¿™ä¸Omega[69]ä½¿ç”¨çš„ä¹è§‚å¹¶å‘æ§åˆ¶æ€è·¯å¾ˆç›¸ä¼¼ï¼Œè€Œä¸”æˆ‘ä»¬æœ€è¿‘è¿˜ç»™Borgæ·»åŠ äº†å¯¹ä¸åŒè´Ÿè½½ç±»å‹ä½¿ç”¨ä¸åŒè°ƒåº¦å™¨çš„åŠŸèƒ½ã€‚ ä¸ºäº†æ”¹è¿›å“åº”æ—¶é—´ï¼ŒBorgletä½¿ç”¨ç‹¬ç«‹çš„çº¿ç¨‹åˆ†åˆ«è¿›è¡Œé€šä¿¡å’Œå“åº”åªè¯»RPCã€‚ä¸ºäº†æ›´å¥½çš„æ€§èƒ½ï¼Œæˆ‘ä»¬å°†è¿™äº›è¯·æ±‚åˆ’åˆ†ç»™5ä¸ªBorgmasterå‰¯æœ¬ï¼ˆÂ§3.3ï¼‰ã€‚æ€»çš„æ•ˆæœæ˜¯ï¼ŒUIå“åº”æ—¶é—´çš„99%åˆ†ä½æ•°å°äº1ç§’ï¼Œè€ŒBorgletè½®è¯¢é—´éš”çš„95%åˆ†ä½æ•°å°äº10ç§’ã€‚ ä¸€äº›æé«˜Borgè°ƒåº¦å™¨æ‰©å±•æ€§çš„æ–¹æ³•å¦‚ä¸‹ï¼š ç¼“å­˜è¯„åˆ†ï¼šè®¡ç®—ä¸€å°æœºå™¨çš„å¯è¡Œæ€§å’Œè¯„åˆ†æ˜¯æ¯”è¾ƒæ˜‚è´µçš„ï¼Œæ‰€ä»¥Borgä¼šä¸€ç›´ç¼“å­˜è¯„åˆ†ï¼Œç›´åˆ°è¿™å°æœºå™¨æˆ–è€…ä»»åŠ¡çš„å±æ€§å‘ç”Ÿäº†å˜åŒ–â€”â€”ä¾‹å¦‚ï¼Œè¿™å°æœºå™¨ä¸Šçš„æŸä¸ªä»»åŠ¡ç»“æŸäº†ï¼Œä¸€äº›å±æ€§ä¿®æ”¹äº†ï¼Œæˆ–è€…ä»»åŠ¡çš„éœ€æ±‚æ”¹å˜äº†ã€‚å¿½ç•¥å°é¢çš„èµ„æºå˜åŒ–å¯ä»¥å‡å°‘ç¼“å­˜å¤±æ•ˆã€‚ ä»»åŠ¡ç­‰æ•ˆç±»ï¼ˆEquivalence classesï¼‰ï¼šä¸€èˆ¬æ¥è¯´ï¼ŒåŒä¸€ä¸ªBorgä½œä¸šçš„ä»»åŠ¡æœ‰ç›¸åŒçš„è¯·æ±‚å’Œçº¦æŸã€‚ä»»åŠ¡ç­‰æ•ˆç±»å³ä¸€ç»„æœ‰ç›¸åŒéœ€æ±‚çš„ä»»åŠ¡ã€‚Borgåªå¯¹ç­‰æ•ˆç±»ä¸­çš„ä¸€ä¸ªä»»åŠ¡è¿›è¡Œå¯è¡Œæ€§æ£€æŸ¥å’Œè¯„åˆ†ï¼Œè€Œä¸æ˜¯å¯¹ç­‰å¾…çš„æ¯ä¸ªä»»åŠ¡å»æ£€æŸ¥ä¸€éæ‰€æœ‰æœºå™¨çš„å¯è¡Œæ€§å¹¶å¯¹å¯è¡Œçš„æœºå™¨è¯„åˆ†ã€‚ é€‚åº¦éšæœºï¼šåœ¨ä¸€ä¸ªå¤§çš„Cellä¸­ï¼Œå¯¹æ‰€æœ‰æœºå™¨éƒ½å»è®¡ç®—ä¸€éå¯è¡Œæ€§å’Œè¯„åˆ†æ˜¯å¾ˆæµªè´¹çš„ã€‚è°ƒåº¦å™¨ä¼šéšæœºåœ°æ£€æŸ¥æœºå™¨ï¼Œç›´åˆ°æ‰¾åˆ°è¶³å¤Ÿå¤šçš„å¯ç”¨æœºå™¨æ¥è¯„åˆ†ï¼Œç„¶åä»ä¸­æŒ‘é€‰å‡ºæœ€å¥½çš„ä¸€ä¸ªã€‚è¿™å‡å°‘äº†ä»»åŠ¡å¯åŠ¨å’Œé€€å‡ºæ‰€éœ€çš„è¯„åˆ†æ¬¡æ•°åŠå¯¼è‡´çš„ç¼“å­˜å¤±æ•ˆï¼ŒåŠ å¿«äº†ä»»åŠ¡åˆ†é…è¿‡ç¨‹ã€‚é€‚åº¦éšæœºæœ‰ç‚¹ç±»ä¼¼Sparrow[65]çš„æ‰¹é‡é‡‡æ ·æŠ€æœ¯ï¼Œä½†Borgè¿˜å¤„ç†äº†ä¼˜å…ˆçº§ã€æŠ¢å ã€å¼‚æ„æ€§å’Œå®‰è£…è½¯ä»¶åŒ…çš„æˆæœ¬ã€‚ åœ¨æˆ‘ä»¬çš„å®éªŒä¸­ï¼ˆÂ§5ï¼‰ï¼Œä»é›¶å¼€å§‹è°ƒåº¦æ•´ä¸ªCellçš„å·¥ä½œè´Ÿè½½åªè¦å‡ ç™¾ç§’ï¼Œä½†ç¦ç”¨ä¸Šé¢å‡ é¡¹æŠ€æœ¯çš„è¯ï¼Œ3å¤©éƒ½ä¸å¤Ÿã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼ŒåŠç§’ä¹‹å†…å°±èƒ½å®Œæˆä¸€éç­‰å¾…é˜Ÿåˆ—çš„åœ¨çº¿è°ƒåº¦ã€‚ ","date":"2022-05-31","objectID":"/posts/brog-in-google/:3:4","tags":["è½¬è½½","brog","cluster"],"title":"[è¯‘]ä½¿ç”¨Borgåœ¨Googleç®¡ç†å¤§è§„æ¨¡é›†ç¾¤","uri":"/posts/brog-in-google/"},{"categories":["k8s"],"content":"4. å¯ç”¨æ€§ å›¾3. ä¸åŒç±»å‹ä»»åŠ¡çš„å¼‚å¸¸é€€å‡ºç‡åŠåŸå›  åŒ…æ‹¬æŠ¢å ã€èµ„æºä¸è¶³ã€æœºå™¨æ•…éšœã€æœºå™¨å…³æœºã€å…¶å®ƒã€‚æ•°æ®ä»2013-08-01å¼€å§‹å¤§å‹ç³»ç»Ÿé‡Œæ•…éšœæ˜¯å¾ˆå¸¸è§çš„[10, 11, 12]ã€‚å›¾3å±•ç¤ºäº†åœ¨15ä¸ªæ ·æœ¬Cellé‡Œä»»åŠ¡å¼‚å¸¸é€€å‡ºçš„åŸå› åˆ†ç±»ã€‚åœ¨Borgä¸Šè¿è¡Œçš„åº”ç”¨éœ€è¦èƒ½å¤„ç†è¿™ç§äº‹ä»¶ï¼Œå¯é‡‡ç”¨çš„æŠ€æœ¯æœ‰å¤šå‰¯æœ¬ã€ä¿å­˜æŒä¹…çŠ¶æ€åˆ°åˆ†å¸ƒå¼å­˜å‚¨ï¼Œæˆ–å®šæœŸå¿«ç…§ï¼ˆå¦‚æœå¯è¡Œçš„è¯ï¼‰ç­‰ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå°½å¯èƒ½çš„ç¼“è§£å¼‚å¸¸äº‹ä»¶çš„å½±å“ã€‚ä¾‹å¦‚ï¼ŒBorgæä¾›äº†ï¼š è‡ªåŠ¨é‡æ–°è°ƒåº¦å¼‚å¸¸é€€å‡ºçš„ä»»åŠ¡ï¼Œå¦‚æœå¿…è¦ï¼Œå¯ä»¥æ”¾ç½®åˆ°å¦ä¸€å°æœºå™¨ä¸Šå»è¿è¡Œ æŠŠä¸€ä¸ªä½œä¸šçš„ä»»åŠ¡åˆ†æ•£åˆ°ä¸åŒçš„å¯ç”¨åŸŸï¼Œä¾‹å¦‚æœºå™¨ã€æœºæ¶ã€ä¾›ç”µåŸŸå±‚æ¬¡ï¼Œä»¥å‡å°‘å…³è”å¤±æ•ˆ åœ¨æœºå™¨/OSå‡çº§ç­‰ç»´æŠ¤æ´»åŠ¨æœŸé—´ï¼Œé™åˆ¶ä»»åŠ¡å—å½±å“çš„é€Ÿç‡ï¼Œä»¥åŠåŒä¸€ä½œä¸šä¸­åŒæ—¶ä¸­æ­¢çš„ä»»åŠ¡çš„ä¸ªæ•° ä½¿ç”¨å£°æ˜å¼çš„é¢„æœŸçŠ¶æ€è¡¨ç¤ºï¼ŒåŠå¹‚ç­‰çš„å˜æ›´æ“ä½œï¼Œè¿™æ ·æ•…éšœçš„å®¢æˆ·ç«¯å¯ä»¥æ— æŸåœ°é‡å¤æäº¤æ•…éšœæœŸé—´æ¼æ‰çš„è¯·æ±‚ å¯¹äºå¤±è”çš„æœºå™¨ä¸Šçš„ä»»åŠ¡ï¼Œé™åˆ¶é‡æ–°è°ƒåº¦çš„é€Ÿç‡ï¼Œå› ä¸ºå¤§è§„æ¨¡çš„æœºå™¨æ•…éšœå’Œç½‘ç»œåˆ†åŒºæ˜¯å¾ˆéš¾åŒºåˆ†çš„ å›é¿é€ æˆå´©æºƒçš„ $\\langle$ä»»åŠ¡ï¼Œæœºå™¨$\\rangle$ ç»„åˆ é€šè¿‡ä¸æ–­é‡æ–°æ‰§è¡Œæ—¥å¿—ä¿å­˜ä»»åŠ¡ï¼ˆÂ§2.4ï¼‰ï¼Œæ¢å¤å·²å†™å…¥æœ¬åœ°ç¡¬ç›˜çš„å…³é”®ä¸­é—´æ•°æ®ï¼Œå°±ç®—è¿™ä¸ªæ—¥å¿—å…³è”çš„Allocå·²ç»ç»ˆæ­¢æˆ–è°ƒåº¦åˆ°å…¶å®ƒæœºå™¨ä¸Šäº†ã€‚ç”¨æˆ·å¯ä»¥è®¾ç½®ç³»ç»ŸæŒç»­é‡å¤å°è¯•å¤šä¹…ï¼Œé€šå¸¸æ˜¯å‡ å¤©æ—¶é—´ã€‚ Borgçš„ä¸€ä¸ªå…³é”®è®¾è®¡ç‰¹æ€§æ˜¯ï¼šå°±ç®—Borgmasteræˆ–è€…Borgleté€€å‡ºäº†ï¼Œå·²ç»è¿è¡Œçš„ä»»åŠ¡è¿˜ä¼šç»§ç»­è¿è¡Œä¸‹å»ã€‚ä¸è¿‡ï¼Œä¿æŒMasteræ­£å¸¸è¿è¡Œä»ç„¶é‡è¦ï¼Œå› ä¸ºåœ¨å®ƒé€€å‡ºåå°±æ— æ³•æäº¤æ–°çš„ä½œä¸šï¼Œæ— æ³•æ›´æ–°è¿è¡Œä½œä¸šçš„çŠ¶æ€ï¼Œä¹Ÿä¸èƒ½é‡æ–°è°ƒåº¦æ•…éšœæœºå™¨ä¸Šçš„ä»»åŠ¡ã€‚ Borgmasterä½¿ç”¨å¤šé¡¹çš„æŠ€æœ¯æ”¯æŒå…¶è·å¾—99.99%çš„å®é™…å¯ç”¨æ€§ï¼šå¤šå‰¯æœ¬åº”å¯¹æœºå™¨æ•…éšœï¼›å‡†å…¥æ§åˆ¶åº”å¯¹è¿‡è½½ï¼›ä½¿ç”¨ç®€å•ã€åº•å±‚çš„å·¥å…·éƒ¨ç½²å®ä¾‹ï¼Œä»¥å‡å°‘å¤–éƒ¨ä¾èµ–ã€‚Cellå½¼æ­¤æ˜¯ç‹¬ç«‹çš„ï¼Œå‡å°‘äº†å…³è”è¯¯æ“ä½œå’Œæ•…éšœä¼ æ’­çš„æœºä¼šã€‚åŒæ—¶è¿™ä¹Ÿæ˜¯æˆ‘ä»¬ä¸æ‰©å¤§Cellè§„æ¨¡çš„ä¸»è¦è€ƒè™‘ï¼Œè€Œå¹¶éæ˜¯å—é™äºæ‰©å±•æ€§ã€‚ ","date":"2022-05-31","objectID":"/posts/brog-in-google/:4:0","tags":["è½¬è½½","brog","cluster"],"title":"[è¯‘]ä½¿ç”¨Borgåœ¨Googleç®¡ç†å¤§è§„æ¨¡é›†ç¾¤","uri":"/posts/brog-in-google/"},{"categories":["k8s"],"content":"5. åˆ©ç”¨ç‡ Borgçš„ä¸€ä¸ªä¸»è¦ç›®æ ‡å°±æ˜¯æœ‰æ•ˆåœ°åˆ©ç”¨Googleçš„å¤§é‡æœºå™¨ï¼ˆè¿™æ˜¯ä¸€å¤§ç¬”è´¢åŠ¡æŠ•èµ„ï¼‰ï¼šè®©æ•ˆç‡æå‡å‡ ä¸ªç™¾åˆ†ç‚¹å°±èƒ½çœä¸‹å‡ ç™¾ä¸‡ç¾å…ƒã€‚è¿™ä¸€èŠ‚è®¨è®ºå’Œè¯„ä¼°äº†ä¸€äº›Borgä½¿ç”¨çš„ç­–ç•¥å’ŒæŠ€æœ¯ã€‚ ","date":"2022-05-31","objectID":"/posts/brog-in-google/:5:0","tags":["è½¬è½½","brog","cluster"],"title":"[è¯‘]ä½¿ç”¨Borgåœ¨Googleç®¡ç†å¤§è§„æ¨¡é›†ç¾¤","uri":"/posts/brog-in-google/"},{"categories":["k8s"],"content":"5.1 è¯„ä¼°æ–¹æ³• ä½œä¸šæœ‰éƒ¨ç½²çº¦æŸï¼Œè€Œä¸”éœ€è¦å¤„ç†è´Ÿè½½å°–å³°ï¼ˆå°½ç®¡æ¯”è¾ƒå°‘è§ï¼‰ï¼›æœºå™¨æ˜¯å¼‚æ„çš„ï¼›æˆ‘ä»¬å›æ”¶æœåŠ¡å‹ä½œä¸šçš„èµ„æºæ¥è¿è¡Œæ‰¹å¤„ç†ä½œä¸šã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ¯”â€œå¹³å‡åˆ©ç”¨ç‡â€æ›´é«˜çº§çš„æŒ‡æ ‡æ¥è¯„ä¼°æˆ‘ä»¬çš„ç­–ç•¥é€‰æ‹©ã€‚å¤§é‡å®éªŒåï¼Œæˆ‘ä»¬é€‰æ‹©äº†Cellå‹ç¼©é‡ï¼ˆCompactionï¼‰ï¼šç»™å®šä¸€ä¸ªè´Ÿè½½ï¼Œæˆ‘ä»¬ä¸æ–­åœ°ç§»é™¤æœºå™¨ï¼Œç›´åˆ°æ— æ³•å®¹çº³è¯¥è´Ÿè½½ï¼Œä»è€Œå¾—çŸ¥æ‰€éœ€æœ€å°çš„Cellè§„æ¨¡ã€‚ä»ç©ºé›†ç¾¤å¼€å§‹éƒ¨ç½²è¯¥è´Ÿè½½å¹¶é‡å¤å¤šæ¬¡ï¼Œä»¥å‡å°‘ç‰¹æ®Šæƒ…å†µçš„å½±å“ã€‚ç»ˆæ­¢æ¡ä»¶æ˜¯æ˜ç¡®çš„ï¼Œå¯¹æ¯”å¯ä»¥è‡ªåŠ¨åŒ–ï¼Œé¿å…äº†ç”Ÿæˆå’Œå»ºæ¨¡åˆæˆè´Ÿè½½çš„é™·é˜±[31]ã€‚[78]æä¾›äº†è¯„ä¼°æŠ€æœ¯çš„å®šé‡æ¯”è¾ƒï¼Œå…¶ä¸­çš„ç»†èŠ‚éå¸¸å¾®å¦™ã€‚ æˆ‘ä»¬ä¸å¯èƒ½åœ¨çº¿ä¸ŠCellè¿›è¡Œå®éªŒï¼Œä½†æ˜¯æˆ‘ä»¬ç”¨äº†Fauxmasteræ¥è·å¾—é«˜ä¿çœŸçš„æ¨¡æ‹Ÿæ•ˆæœï¼Œå®ƒä½¿ç”¨äº†çœŸå®ç”Ÿäº§Cellå’Œè´Ÿè½½çš„æ•°æ®ï¼ŒåŒ…æ‹¬æ‰€æœ‰çº¦æŸã€å®é™…é™åˆ¶ã€é¢„ç•™å’Œä½¿ç”¨é‡æ•°æ®ï¼ˆÂ§5.5ï¼‰ã€‚å®éªŒæ•°æ®æå–è‡ª2014-10-01 14:00 PDTçš„Borgå¿«ç…§ï¼ˆå…¶å®ƒå¿«ç…§ä¹Ÿæœ‰ç±»ä¼¼çš„ç»“è®ºï¼‰ã€‚æˆ‘ä»¬é¦–å…ˆæ’é™¤äº†ç‰¹æ®Šç”¨é€”çš„ã€æµ‹è¯•ç”¨çš„ã€å°å‹çš„ï¼ˆå°‘äº5000å°æœºå™¨ï¼‰çš„Cellï¼Œç„¶åä»å‰©ä¸‹çš„Cellä¸­é€‰å–äº†15ä¸ªæ ·æœ¬ï¼ŒæŠ½æ ·å°½é‡å…³äºCellçš„å¤§å°å‡åŒ€åˆ†å¸ƒã€‚ ä¸ºäº†ä¿æŒæœºå™¨å¼‚æ„æ€§ï¼Œåœ¨Cellå‹ç¼©å®éªŒä¸­ï¼Œæˆ‘ä»¬éšæœºåœ°ç§»é™¤æœºå™¨ã€‚ä¸ºäº†ä¿æŒå·¥ä½œè´Ÿè½½çš„å¼‚æ„æ€§ï¼Œæˆ‘ä»¬ä¿ç•™äº†æ‰€æœ‰è´Ÿè½½ï¼ˆé™¤äº†é‚£äº›ç»‘å®šåˆ°ç‰¹å®šæœºå™¨çš„æœåŠ¡å’Œå­˜å‚¨ä»»åŠ¡ï¼Œå¦‚Borgletï¼‰ã€‚æˆ‘ä»¬æŠŠé‚£äº›éœ€è¦è¶…è¿‡åŸCellå¤§å°ä¸€åŠçš„ä½œä¸šçš„ç¡¬æ€§é™åˆ¶æ”¹æˆæŸ”æ€§çš„ï¼Œå…è®¸ä¸è¶…è¿‡0.2%çš„ä»»åŠ¡ä¸€ç›´ç­‰å¾…ï¼Œè¿™æ˜¯é’ˆå¯¹ä¸€äº›ç‰¹åˆ«â€œæŒ‘å‰”â€çš„ï¼Œåªèƒ½æ”¾ç½®åœ¨å¾ˆå°‘çš„ç‰¹å®šæœºå™¨ä¸Šçš„ä»»åŠ¡ï¼›å……åˆ†çš„å®éªŒè¡¨æ˜ç»“æœæ˜¯å¯å¤ç°çš„ï¼Œæ³¢åŠ¨å¾ˆå°ã€‚å¦‚æœéœ€è¦ä¸€ä¸ªå¤§å‹çš„Cellï¼Œå°±æŠŠåŸCellå¤åˆ¶å‡ å€ï¼›å¦‚æœéœ€è¦æ›´å¤šçš„Cellï¼Œä¹Ÿæ˜¯å¤åˆ¶åŸCellã€‚ æ¯ä¸ªå®éªŒéƒ½ç”¨ä¸åŒçš„éšæœºæ•°ç§å­å¯¹æ¯ä¸ªCellé‡å¤äº†11æ¬¡ã€‚å›¾ä¸­ï¼Œæˆ‘ä»¬ç”¨è¯¯å·®çº¿çº¿æ¥è¡¨ç¤ºæ‰€éœ€æœºå™¨æ•°é‡çš„æœ€å¤§å’Œæœ€å°å€¼ï¼Œé€‰æ‹©90%åˆ†ä½æ•°ä½œä¸ºç»“æœâ€”â€”å¹³å‡å€¼æˆ–ä¸­ä½æ•°ä¸èƒ½åæ˜ ç³»ç»Ÿç®¡ç†å‘˜æ‰€æœŸæœ›çš„å……åˆ†æŠŠæ¡ã€‚æˆ‘ä»¬è®¤ä¸ºCellå‹ç¼©ç‡æ˜¯ä¸€ä¸ªå…¬å¹³ä¸€è‡´çš„æ¯”è¾ƒè°ƒåº¦ç­–ç•¥çš„æ–¹æ³•ï¼Œè€Œä¸”å¯ä»¥ç›´æ¥è½¬åŒ–ä¸ºæˆæœ¬/æ”¶ç›Šçš„ç»“æœï¼šæ›´å¥½çš„ç­–ç•¥åªéœ€è¦æ›´å°‘çš„æœºå™¨æ¥è¿è¡Œç›¸åŒçš„è´Ÿè½½ã€‚ æˆ‘ä»¬çš„å®éªŒå…³æ³¨äºå³æ—¶çš„è°ƒåº¦ï¼ˆè£…ç®±ï¼‰ï¼Œè€Œä¸æ˜¯é‡æ”¾ä¸€æ®µé•¿æ—¶é—´çš„è´Ÿè½½è®°å½•ã€‚éƒ¨åˆ†åŸå› æ˜¯é¿å…å¤„ç†å¼€æ”¾æˆ–é—­åˆçš„é˜Ÿåˆ—æ¨¡å‹[71, 79]çš„å›°éš¾ï¼›éƒ¨åˆ†æ˜¯ä¼ ç»Ÿçš„å®Œæˆæ—¶é—´ä¸é€‚ç”¨äºé•¿æ—¶é—´è¿è¡Œçš„æœåŠ¡ï¼›éƒ¨åˆ†æ˜¯è¿™æ ·å¯ä»¥æä¾›æ˜ç¡®çš„æ¯”è¾ƒç»“æœï¼›éƒ¨åˆ†æ˜¯å› ä¸ºæˆ‘ä»¬è®¤ä¸ºä¸ä¼šå¯¹ç»“æœäº§ç”Ÿæ˜¾è‘—å½±å“ï¼›è¿˜æœ‰éƒ¨åˆ†ç°å®åŸå› ï¼Œæˆ‘ä»¬å‘ç°ä¸€æ¬¡å®éªŒä½¿ç”¨äº†20ä¸‡ä¸ªBorg CPUæ ¸ â€”â€” å³ä¾¿å¯¹Googleè€Œè¨€ï¼Œè¿™ä¸ªæˆæœ¬ä¹Ÿä¸æ˜¯ä¸ªå°æ•°ç›®ã€‚ å›¾4. å‹ç¼©çš„æ•ˆæœã€‚15ä¸ªCellåœ¨å‹ç¼©åç›¸æ¯”åŸè§„æ¨¡çš„ç™¾åˆ†æ¯”ç´¯ç§¯åˆ†å¸ƒï¼ˆCDFï¼‰ ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬ç‰¹æ„ä¿ç•™äº†ä¸€äº›è£•åº¦ï¼ˆHeadroomï¼‰ï¼Œä»¥åº”å¯¹è´Ÿè½½å¢é•¿ã€å¶ç„¶çš„â€œé»‘å¤©é¹…â€äº‹ä»¶ã€è´Ÿè½½å°–å³°ã€æœºå™¨æ•…éšœã€ç¡¬ä»¶å‡çº§ã€ä»¥åŠå¤§èŒƒå›´çš„å±€éƒ¨æ•…éšœï¼ˆå¦‚ä¾›ç”µæ¯çº¿çŸ­è·¯ï¼‰ã€‚å›¾4æ˜¾ç¤ºäº†å¦‚æœåº”ç”¨Cellå‹ç¼©ï¼Œå®é™…çš„Cellå¯ä»¥å‹ç¼©åˆ°å¤šå°ã€‚ä¸‹æ–‡çš„å›¾ä½¿ç”¨è¿™äº›å‹ç¼©åçš„å¤§å°ä½œä¸ºåŸºå‡†å€¼ã€‚ ","date":"2022-05-31","objectID":"/posts/brog-in-google/:5:1","tags":["è½¬è½½","brog","cluster"],"title":"[è¯‘]ä½¿ç”¨Borgåœ¨Googleç®¡ç†å¤§è§„æ¨¡é›†ç¾¤","uri":"/posts/brog-in-google/"},{"categories":["k8s"],"content":"5.2 Cellå…±äº« å‡ ä¹æ‰€æœ‰çš„æœºå™¨éƒ½åŒæ—¶è¿è¡Œprodå’Œnon-prodçš„ä»»åŠ¡ï¼šåœ¨å…±äº«çš„Cellé‡Œæ˜¯98%çš„æœºå™¨ï¼Œåœ¨æ‰€æœ‰Borgç®¡ç†çš„æœºå™¨é‡Œæ˜¯83%ï¼ˆæœ‰ä¸€äº›Cellæ˜¯ä¸“ç”¨çš„ï¼‰ã€‚ å›¾5. å°†prodå’Œnon-prodå·¥ä½œåˆ’åˆ†åˆ°ä¸åŒçš„é›†ç¾¤å°†éœ€è¦æ›´å¤šçš„æœºå™¨ã€‚ä¸¤å¹…å›¾ä¸­çš„ç™¾åˆ†æ¯”éƒ½æ˜¯ç›¸å¯¹äºå•ä¸ªé›†ç¾¤æ‰€éœ€æœºå™¨çš„æœ€å°‘æ•°é‡è€Œè¨€çš„ é‰´äºå¾ˆå¤šå¤–éƒ¨ç»„ç»‡å°†é¢å‘ç”¨æˆ·çš„ä½œä¸šå’Œæ‰¹å¤„ç†ä½œä¸šåˆ†åˆ«è¿è¡Œåœ¨ä¸åŒçš„é›†ç¾¤ä¸Šï¼Œæˆ‘ä»¬æ£€æŸ¥ä¸€ä¸‹å¦‚æœæˆ‘ä»¬ä¹Ÿè¿™ä¹ˆåšä¼šæ€æ ·ã€‚å›¾5è¡¨æ˜ï¼Œåœ¨ä¸€ä¸ªä¸­ç­‰å¤§å°çš„Cellä¸Šï¼Œåˆ†å¼€è¿è¡Œprodå’Œnon-prodçš„å·¥ä½œè´Ÿè½½å°†éœ€è¦å¢åŠ 20-30%çš„æœºå™¨ã€‚è¿™æ˜¯å› ä¸ºprodçš„ä½œä¸šé€šå¸¸ä¼šä¿ç•™ä¸€äº›èµ„æºæ¥åº”å¯¹æå°‘å‘ç”Ÿçš„è´Ÿè½½å°–å³°ï¼Œä½†å¤§å¤šæƒ…å†µä¸‹ç”¨ä¸åˆ°è¿™äº›èµ„æºã€‚Borgå›æ”¶äº†è¿™äº›ç”¨ä¸åˆ°çš„èµ„æºï¼ˆÂ§5.5ï¼‰ï¼Œæ¥è¿è¡Œnon-prodçš„å·¥ä½œï¼Œæ‰€ä»¥æ€»ä½“æˆ‘ä»¬åªéœ€è¦æ›´å°‘çš„æœºå™¨ã€‚ å›¾6. å°†ç”¨æˆ·åˆ†å¼€åˆ°ä¸åŒçš„é›†ç¾¤ä¹Ÿä¼šéœ€è¦æ›´å¤šçš„æœºå™¨ å¤§éƒ¨åˆ†Borg Cellè¢«æ•°åƒä¸ªç”¨æˆ·å…±äº«ä½¿ç”¨ã€‚å›¾6å±•ç¤ºäº†ä¸ºä»€ä¹ˆè¦å…±äº«ã€‚æµ‹è¯•ä¸­ï¼Œå¦‚æœä¸€ä¸ªç”¨æˆ·æ¶ˆè´¹äº†è¶…è¿‡10TiBï¼ˆæˆ–100TiBï¼‰çš„å†…å­˜ï¼Œæˆ‘ä»¬å°±æŠŠè¿™ä¸ªç”¨æˆ·çš„å·¥ä½œè´Ÿè½½åˆ†ç¦»åˆ°å¦ä¸€ä¸ªCellä¸­ã€‚æˆ‘ä»¬ç›®å‰çš„å…±äº«ç­–ç•¥æ˜¯æœ‰æ•ˆçš„ï¼šå³ä½¿100TiBçš„é˜ˆå€¼ï¼Œä¹Ÿéœ€è¦2-16å€çš„Cellï¼Œå¢åŠ 20-150%çš„æœºå™¨ã€‚å°†èµ„æºæ± åŒ–å†æ¬¡æ˜¾è‘—åœ°èŠ‚çœäº†æˆæœ¬ã€‚ ä½†æ˜¯ï¼ŒæŠŠå¾ˆå¤šä¸ç›¸å…³çš„ç”¨æˆ·å’Œä½œä¸šç±»å‹æ”¾ç½®åˆ°åŒä¸€å°æœºå™¨ä¸Šå¯èƒ½ä¼šé€ æˆCPUå†²çªï¼Œæˆ‘ä»¬æ˜¯å¦éœ€è¦æ›´å¤šçš„æœºå™¨æ¥è¡¥å¿ï¼Ÿä¸ºè¯„ä¼°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹å›ºå®šæœºå™¨ç±»å‹å’Œæ—¶é’Ÿé¢‘ç‡ï¼Œä»»åŠ¡çš„CPIï¼ˆCycles per Instructionï¼Œæ‰§è¡Œæ¯æ¡æŒ‡ä»¤å¹³å‡æ‰€éœ€æ—¶é’Ÿæ•°ï¼Œè¶Šå¤§åˆ™ç¨‹åºæ‰§è¡Œè¶Šæ…¢ï¼‰åœ¨å…¶å®ƒç¯å¢ƒæ¡ä»¶ä¸åŒçš„å½±å“ä¸‹æ˜¯å¦‚ä½•å˜åŒ–çš„ã€‚åœ¨è¿™ç§å®éªŒæ¡ä»¶ä¸‹ï¼ŒCPIæ˜¯ä¸€ä¸ªå¯æ¯”è¾ƒçš„æŒ‡æ ‡ï¼Œè€Œä¸”å¯ä»¥è¡¨å¾æ€§èƒ½å†²çªï¼Œå› ä¸º2å€çš„CPIæ„å‘³ç€ä¸€ä¸ªCPUå¯†é›†å‹ç¨‹åºéœ€è¦2å€çš„æ‰§è¡Œæ—¶é—´ã€‚æ•°æ®æ˜¯åœ¨ä¸€å‘¨å†…ä»çº¦12000ä¸ªéšæœºé€‰æ‹©çš„prodä»»åŠ¡è·å–çš„ï¼Œä½¿ç”¨äº†[83]ä¸­ä»‹ç»çš„ç¡¬ä»¶å‰–æå·¥å…·è®°å½•5åˆ†é’Ÿå†…çš„æ—¶é’Ÿæ•°å’ŒæŒ‡ä»¤æ•°ï¼Œå¹¶è°ƒæ•´äº†é‡‡æ ·çš„æƒé‡ï¼Œä½¿CPUæ—¶é—´çš„æ¯ç§’éƒ½å‡ç­‰å¤„ç†ã€‚ç»“æœå¹¶éç›´æˆªäº†å½“çš„ï¼š æˆ‘ä»¬å‘ç°CPIåœ¨åŒä¸€ä¸ªæ—¶é—´æ®µå†…å’Œä¸‹é¢ä¸¤ä¸ªé‡æ­£ç›¸å…³ï¼šè¿™å°æœºå™¨ä¸Šæ€»çš„CPUä½¿ç”¨é‡ï¼Œä»¥åŠè¿™ä¸ªæœºå™¨ä¸ŠåŒæ—¶è¿è¡Œçš„ä»»åŠ¡ä¸ªæ•°ï¼ˆåŸºæœ¬ä¸Šç‹¬ç«‹ï¼‰ï¼›æ¯å‘ä¸€å°æœºå™¨ä¸Šå¢åŠ ä¸€ä¸ªä»»åŠ¡ï¼Œå°±ä¼šä½¿å…¶å®ƒä»»åŠ¡çš„CPIå¢åŠ 0.3%ï¼ˆä»æ•°æ®æ‹Ÿåˆçš„çº¿æ€§æ¨¡å‹ç»™å‡ºçš„é¢„æµ‹å€¼ï¼‰ï¼›å°†ä¸€å°æœºå™¨çš„CPUä½¿ç”¨é‡å¢åŠ 10%ï¼Œå°±ä¼šå¢åŠ 2%å¼±çš„CPIã€‚å°½ç®¡ç›¸å…³æ€§åœ¨ç»Ÿè®¡æ„ä¹‰ä¸Šæ˜¯æ˜¾è‘—çš„ï¼Œä¹Ÿåªæ˜¯è§£é‡Šäº†CPIå˜åŒ–çš„5%ã€‚è¿˜æœ‰å…¶å®ƒçš„å› ç´ ï¼Œæ”¯é…ç€CPIçš„å˜åŒ–ï¼Œä¾‹å¦‚ï¼Œåº”ç”¨ç¨‹åºå›ºæœ‰çš„å·®åˆ«ï¼Œä»¥åŠç‰¹æ®Šçš„å¹²æ‰°æ¨¡å¼[24, 83]ã€‚ æ¯”è¾ƒä»å…±äº«Cellå’Œåªè¿è¡Œå‡ ç§åº”ç”¨çš„å°‘æ•°ä¸“ç”¨Cellè·å–çš„CPIé‡‡æ ·ï¼Œæˆ‘ä»¬çœ‹åˆ°å…±äº«Cellé‡Œçš„CPIå¹³å‡å€¼ä¸º1.58ï¼ˆÏƒ=0.35ï¼Œæ ‡å‡†å·®ï¼‰ï¼Œä¸“ç”¨Cellçš„CPIå¹³å‡å€¼æ˜¯1.53ï¼ˆÏƒ=0.32ï¼‰â€”â€” ä¹Ÿå°±æ˜¯è¯´ï¼Œå…±äº«Cellçš„æ€§èƒ½å·®3%ã€‚ ä¸ºäº†æå®šä¸åŒCellçš„åº”ç”¨ä¼šæœ‰ä¸åŒçš„å·¥ä½œè´Ÿè½½ï¼Œæˆ–è€…ä¼šæœ‰å¹¸å­˜è€…åå·®ï¼ˆæˆ–è®¸å¯¹å†²çªæ›´æ•æ„Ÿçš„ç¨‹åºä¼šè¢«æŒªåˆ°ä¸“ç”¨Cellé‡Œé¢å»ï¼‰ï¼Œæˆ‘ä»¬è§‚å¯Ÿäº†Borgletçš„CPIã€‚æ‰€æœ‰Cellçš„æ‰€æœ‰æœºå™¨ä¸Šéƒ½è¿è¡Œç€Borgletã€‚æˆ‘ä»¬å‘ç°ä¸“ç”¨Cellé‡ŒBorletçš„CPIå¹³å‡å€¼æ˜¯1.20ï¼ˆÏƒ=0.29ï¼‰ï¼Œè€Œå…±äº«Cellé‡Œçš„CPIå¹³å‡å€¼ä¸º1.43ï¼ˆÏƒ=0.45ï¼‰ï¼Œè¡¨æ˜åœ¨ä¸“ç”¨Cellä¸Šæ¯”åœ¨å…±äº«Cellä¸Šå¿«1.19å€ï¼Œä¸è¿‡è¿™ä¸ªç»“æœå¿½ç•¥äº†ä¸“ç”¨Cellä¸­çš„æœºå™¨è´Ÿè½½è¾ƒè½»çš„å› ç´ ï¼Œå³ç¨åå‘ä¸“ç”¨Cellã€‚ è¿™äº›å®éªŒè¡¨æ˜äº†ä»“åº“çº§åˆ«çš„æ€§èƒ½æ¯”è¾ƒæ˜¯å¤æ‚çš„ï¼Œå¼ºåŒ–äº†[51]ä¸­çš„è§‚å¯Ÿï¼Œä½†ä¹Ÿè¯´æ˜å…±äº«å¹¶æ²¡æœ‰æ˜¾è‘—å¢åŠ è¿è¡Œç¨‹åºçš„å¼€é”€ã€‚ ä¸è¿‡ï¼Œå°±ç®—ä»ç»“æœä¸­æœ€å·®çš„æ•°æ®æ¥çœ‹ï¼Œå…±äº«è¿˜æ˜¯æœ‰ç›Šçš„ï¼šæ¯”èµ·CPUçš„é™é€Ÿï¼Œå…±äº«æ¯”å„ä¸ªåˆ’åˆ†æ–¹æ¡ˆéƒ½å‡å°‘äº†æœºå™¨ï¼Œè¿™ä¸€ç‚¹æ›´é‡è¦ï¼Œè€Œä¸”å…±äº«çš„æ”¶ç›Šé€‚ç”¨äºåŒ…æ‹¬å†…å­˜å’Œç¡¬ç›˜ç­‰å„ç§èµ„æºï¼Œä¸ä»…ä»…æ˜¯CPUã€‚ ","date":"2022-05-31","objectID":"/posts/brog-in-google/:5:2","tags":["è½¬è½½","brog","cluster"],"title":"[è¯‘]ä½¿ç”¨Borgåœ¨Googleç®¡ç†å¤§è§„æ¨¡é›†ç¾¤","uri":"/posts/brog-in-google/"},{"categories":["k8s"],"content":"5.3 å¤§å‹Cell å›¾7. å°†Cellåˆ†æˆæ›´å°çš„è§„æ¨¡å°†éœ€è¦æ›´å¤šçš„æœºå™¨ Googleå»ºç«‹äº†å¤§å‹Cellï¼Œä¸€æ˜¯ä¸ºäº†å…è®¸è¿è¡Œå¤§å‹ä»»åŠ¡ï¼ŒäºŒæ˜¯ä¸ºäº†å‡å°‘èµ„æºç¢ç‰‡ã€‚ä¸ºæµ‹è¯•å‡å°‘ç¢ç‰‡çš„æ•ˆæœï¼Œæˆ‘ä»¬æŠŠè´Ÿè½½ä»ä¸€ä¸ªCellåˆ†æ•£å¤šä¸ªè¾ƒå°çš„Cellä¸­ â€”â€” é¦–å…ˆå°†ä½œä¸šéšæœºæ’åˆ—ï¼Œç„¶åè½®æµåˆ†é…åˆ°å„å°çš„Cellä¸­ã€‚å›¾7ç¡®è®¤äº†ä½¿ç”¨å°å‹Celléœ€è¦å¢åŠ ç›¸å½“å¤šçš„æœºå™¨ã€‚ ","date":"2022-05-31","objectID":"/posts/brog-in-google/:5:3","tags":["è½¬è½½","brog","cluster"],"title":"[è¯‘]ä½¿ç”¨Borgåœ¨Googleç®¡ç†å¤§è§„æ¨¡é›†ç¾¤","uri":"/posts/brog-in-google/"},{"categories":["k8s"],"content":"5.4 ç»†ç²’åº¦èµ„æºè¯·æ±‚ Borgç”¨æˆ·è¯·æ±‚çš„CPUå•ä½æ˜¯0.001ä¸ªæ ¸ï¼Œå†…å­˜å’Œç¡¬ç›˜çš„å•ä½æ˜¯å­—èŠ‚ã€‚ï¼ˆä¸€ä¸ªæ ¸å®é™…ä¸Šæ˜¯ä¸€ä¸ªCPUçš„è¶…çº¿ç¨‹ï¼Œå¯¹ä¸åŒæœºå™¨ç±»å‹çš„æ€§èƒ½è¿›è¡Œäº†æ ‡å‡†åŒ–ï¼‰ã€‚å›¾8è¡¨æ˜ç”¨æˆ·å……åˆ†åˆ©ç”¨äº†ç»†ç²’åº¦ï¼šè¯·æ±‚çš„CPUæ ¸å’Œå†…å­˜æ•°é‡çš„â€œç‰¹åˆ«åå¥½å€¼â€æ˜¯å¾ˆå°‘çš„ï¼Œè¿™äº›èµ„æºä¹Ÿæ²¡æœ‰æ˜æ˜¾çš„ç›¸å…³æ€§ã€‚è¿™ä¸[68]é‡Œçš„åˆ†å¸ƒéå¸¸ç›¸ä¼¼ï¼Œé™¤äº†æˆ‘ä»¬åœ¨90%åˆ†ä½æ•°åŠä»¥ä¸Šçš„å†…å­˜è¯·æ±‚å¤šä¸€ç‚¹ä¹‹å¤–ã€‚ å°½ç®¡IaaSæ™®éåªæä¾›ä¸€ç»„å›ºå®šå°ºå¯¸çš„å®¹å™¨æˆ–è™šæ‹Ÿæœº[7, 33]ï¼Œä½†ä¸ç¬¦åˆæˆ‘ä»¬çš„éœ€æ±‚ã€‚ä¸ºè¯´æ˜è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¯¹prodçš„ä½œä¸šå’ŒAllocï¼ˆÂ§2.4ï¼‰ç”³è¯·çš„CPUæ ¸å’Œå†…å­˜åˆ†åˆ«å‘ä¸Šå–æ•´åˆ°æœ€æ¥è¿‘çš„2çš„å¹‚ï¼Œå½¢æˆå›ºå®šå¤§å°çš„â€œæ¡¶â€ï¼Œæœ€å°çš„æ¡¶æœ‰0.5ä¸ªæ ¸å’Œ1GiBå†…å­˜ã€‚å›¾9æ˜¾ç¤ºä¸€èˆ¬æƒ…å†µä¸‹è¿™æ ·éœ€è¦å¢åŠ 30-50%çš„èµ„æºã€‚ä¸Šé™çš„æƒ…å½¢æ˜¯ï¼Œæœ‰çš„å¤§å‹ä»»åŠ¡å³ä¾¿å°†Cellæ‰©å¤§ä¸ºæœªå‹ç¼©å°ºå¯¸çš„å››å€ä¹Ÿæ— æ³•å®¹çº³ï¼Œåªå¥½ä¸ºå…¶åˆ†é…ä¸€æ•´å°æœºå™¨ã€‚ä¸‹é™æ˜¯å…è®¸è¿™äº›ä»»åŠ¡ä¸€ç›´ç­‰å¾…ã€‚ï¼ˆè¿™æ¯”[37]ç»™å‡ºçš„å°†è¿‘100%çš„é¢å¤–å¼€é”€è¦å°ä¸€äº›ï¼Œå› ä¸ºæˆ‘ä»¬æ”¯æŒä¸æ­¢4ç§å°ºå¯¸çš„æ¡¶ï¼Œè€Œä¸”å…è®¸CPUå’Œå†…å­˜åˆ†åˆ«æ”¹å˜ï¼‰ã€‚ ","date":"2022-05-31","objectID":"/posts/brog-in-google/:5:4","tags":["è½¬è½½","brog","cluster"],"title":"[è¯‘]ä½¿ç”¨Borgåœ¨Googleç®¡ç†å¤§è§„æ¨¡é›†ç¾¤","uri":"/posts/brog-in-google/"},{"categories":["k8s"],"content":"5.5 èµ„æºå›æ”¶ ä½œä¸šå¯ä»¥å£°æ˜ä¸€ä¸ªèµ„æºé™é¢ï¼ˆLimitï¼‰ï¼Œæ˜¯æ¯ä¸ªä»»åŠ¡èƒ½è·å¾—çš„èµ„æºä¸Šé™ã€‚Borgä¼šç”¨å®ƒæ¥æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰è¶³å¤Ÿçš„é…é¢æ¥æ¥å—è¯¥ä½œä¸šï¼Œå¹¶æ£€æŸ¥æŸä¸ªæœºå™¨æ˜¯å¦æœ‰è¶³å¤Ÿçš„å¯ç”¨èµ„æºæ¥è¿è¡Œä»»åŠ¡ã€‚å› ä¸ºBorgé€šå¸¸ä¼šæ€æ­»é‚£äº›è¯•å›¾ä½¿ç”¨è¶…å‡ºå†…å­˜å’Œç¡¬ç›˜ç”³è¯·å€¼çš„ä»»åŠ¡ï¼Œæˆ–è€…é™åˆ¶å…¶CPUä½¿ç”¨é‡ä¸è¶…è¿‡ç”³è¯·å€¼ï¼Œæ‰€ä»¥æœ‰çš„ç”¨æˆ·ä¼šä¸ºä»»åŠ¡ç”³è¯·è¶…è¿‡å®é™…éœ€è¦çš„èµ„æºï¼Œå°±åƒæœ‰çš„ç”¨æˆ·ä¼šè´­ä¹°è¶…è¿‡å®é™…éœ€è¦çš„é…é¢ä¸€æ ·ã€‚å¦å¤–ï¼Œä¸€äº›ä»»åŠ¡åªæ˜¯å¶å°”éœ€è¦ä½¿ç”¨å®ƒä»¬ç”³è¯·çš„æ‰€æœ‰èµ„æºï¼ˆä¾‹å¦‚ï¼Œåœ¨ä¸€å¤©ä¸­çš„é«˜å³°æœŸæˆ–è€…å—åˆ°äº†æ‹’ç»æœåŠ¡æ”»å‡»ï¼‰ï¼Œä½†å¤§å¤šæ—¶å€™ç”¨ä¸äº†ã€‚ ä¸å…¶æŠŠé‚£äº›åˆ†é…å‡ºæ¥ä½†æš‚æ—¶æ²¡æœ‰è¢«ç”¨åˆ°çš„èµ„æºæµªè´¹æ‰ï¼Œæˆ‘ä»¬ä¼°è®¡äº†ä¸€ä¸ªä»»åŠ¡ä¼šç”¨å¤šå°‘èµ„æºï¼Œç„¶åæŠŠå‰©ä½™çš„èµ„æºå›æ”¶ç»™é‚£äº›å¯ä»¥å¿å—ä½è´¨é‡èµ„æºçš„ä»»åŠ¡ï¼Œä¾‹å¦‚æ‰¹å¤„ç†ä½œä¸šã€‚è¿™æ•´ä¸ªè¿‡ç¨‹ç§°ä¸ºèµ„æºå†åˆ©ç”¨ã€‚è¿™ä¸ªä¼°å€¼ç§°ä¸ºä»»åŠ¡çš„èµ„æºé¢„ç•™ï¼ˆReservationï¼‰ã€‚Borgmasteræ¯éš”å‡ ç§’å°±ä¼šæ ¹æ®Borgletè·å–çš„ç»†ç²’åº¦èµ„æºä½¿ç”¨é‡ä¿¡æ¯æ¥è®¡ç®—ä¸€æ¬¡é¢„ç•™å€¼ã€‚æœ€åˆçš„é¢„ç•™èµ„æºè¢«è®¾ç½®ä¸ºèµ„æºé™é¢ï¼›åœ¨300ç§’ä¹‹åï¼Œä¹Ÿå°±è¿‡äº†å¯åŠ¨é˜¶æ®µï¼Œé¢„ç•™èµ„æºä¼šç¼“æ…¢çš„ä¸‹é™åˆ°å®é™…ä½¿ç”¨é‡åŠ ä¸Šä¸€ä¸ªå®‰å…¨å€¼ã€‚åœ¨å®é™…ä½¿ç”¨é‡è¶…è¿‡å®ƒæ—¶ï¼Œé¢„ç•™å€¼ä¼šè¿…é€Ÿå¢åŠ ã€‚ Borgè°ƒåº¦å™¨ä½¿ç”¨èµ„æºé™é¢æ¥è®¡ç®—prodçº§ä»»åŠ¡åŸæ³¨4: å‡†ç¡®çš„è¯´ï¼Œæ˜¯é«˜ä¼˜å…ˆçº§çš„ã€å»¶è¿Ÿæ•æ„Ÿçš„ä»»åŠ¡ï¼Œè§Â§6.2æ˜¯å¦å¯ä»¥æ‰§è¡Œï¼ˆÂ§3.2ï¼‰ï¼Œæ‰€ä»¥è¿™äº›ä»»åŠ¡ä¸ä¾èµ–äºå›æ”¶çš„èµ„æºï¼Œä¹Ÿä¸èµ„æºè¶…å”®æ— å…³ï¼›å¯¹äºnon-prodçš„ä»»åŠ¡ï¼Œè¿è¡Œä»»åŠ¡ä½¿ç”¨çš„èµ„æºåœ¨é¢„ç•™å€¼ä¹‹å†…ï¼Œè¿™æ ·æ–°ä»»åŠ¡å°±å¯ä»¥ä½¿ç”¨å›æ”¶çš„èµ„æºã€‚ ä¸€å°æœºå™¨æœ‰å¯èƒ½å› ä¸ºé¢„ç•™ï¼ˆé¢„æµ‹ï¼‰é”™è¯¯è€Œå¯¼è‡´è¿è¡Œæ—¶èµ„æºä¸è¶³ â€”â€” å³ä½¿æ‰€æœ‰çš„ä»»åŠ¡éƒ½åœ¨èµ„æºé™é¢ä¹‹å†…ã€‚å¦‚æœè¿™ç§æƒ…å†µå‘ç”Ÿäº†ï¼Œæˆ‘ä»¬ä¼šæ€æ‰æˆ–è€…é™åˆ¶non-prodä»»åŠ¡ï¼Œä½†ä»æ¥ä¸å¯¹prodä»»åŠ¡ä¸‹æ‰‹ã€‚ å›¾10è¡¨æ˜ï¼Œå¦‚æœæ²¡æœ‰èµ„æºå›æ”¶ï¼Œå°†éœ€è¦æ›´å¤šçš„æœºå™¨ã€‚åœ¨ä¸€ä¸ªä¸­ç­‰è§„æ¨¡çš„Cellä¸­å¤§æ¦‚æœ‰20%çš„å·¥ä½œè´Ÿè½½ï¼ˆÂ§6.2ï¼‰ä½¿ç”¨äº†å›æ”¶çš„èµ„æºã€‚ å›¾11å¯ä»¥çœ‹åˆ°æ›´å¤šçš„ç»†èŠ‚ï¼Œå…¶ä¸­æœ‰é¢„ç•™å€¼ã€ä½¿ç”¨é‡ä¸é™é¢çš„æ¯”ä¾‹ã€‚å½“èµ„æºç´§å¼ æ—¶ï¼Œè¶…å‡ºå†…å­˜é™é¢çš„ä»»åŠ¡é¦–å…ˆä¼šè¢«æŠ¢å ï¼Œä¸è®ºä¼˜å…ˆçº§æœ‰å¤šé«˜ï¼Œæ‰€ä»¥å¾ˆå°‘æœ‰ä»»åŠ¡è¶…è¿‡å†…å­˜é™é¢ã€‚å¦ä¸€æ–¹é¢ï¼ŒCPUä½¿ç”¨é‡æ˜¯å¯ä»¥è¢«è½»æ˜“é™åˆ¶ä½çš„ï¼Œæ‰€ä»¥çŸ­æ—¶çš„æ¯›åˆºè™½ç„¶ä¼šå¯¼è‡´ä½¿ç”¨é‡è¶…è¿‡é¢„ç•™å€¼ï¼Œä½†è¿™æ²¡ä»€ä¹ˆæŸå®³ã€‚ å›¾11è¡¨æ˜äº†èµ„æºå›æ”¶å¯èƒ½è¿˜è¿‡äºä¿å®ˆï¼šåœ¨é¢„ç•™å€¼å’Œå®é™…ä½¿ç”¨é‡ä¸­é—´è¿˜æœ‰ä¸€å¤§æ®µå·®è·ã€‚ä¸ºäº†æµ‹è¯•è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬é€‰æ‹©äº†ä¸€ä¸ªçº¿ä¸ŠCellï¼Œï¼ˆç¬¬ä¸€å‘¨ä½œä¸ºå‚ç…§åŸºå‡†ï¼Œï¼‰ç¬¬äºŒå‘¨å°†å…¶ä¼°è®¡ç®—æ³•çš„å‚æ•°è°ƒæ•´ä¸ºæ¯”è¾ƒæ¿€è¿›çš„è®¾ç½®ï¼Œå³æŠŠå®‰å…¨è£•åº¦ç•™å°ä¸€ç‚¹ï¼›ç¬¬ä¸‰å‘¨é‡‡å–çš„æ˜¯ä»‹äºæ¿€è¿›å’ŒåŸºå‡†ä¹‹é—´çš„é€‚åº¦ç­–ç•¥ï¼Œæœ€åä¸€å‘¨æ¢å¤åˆ°åŸºå‡†ç­–ç•¥ã€‚ å›¾12å±•ç¤ºäº†ç»“æœã€‚ç¬¬äºŒå‘¨çš„é¢„ç•™å€¼æ˜æ˜¾æ›´æ¥è¿‘å®é™…ä½¿ç”¨é‡ï¼Œç¬¬ä¸‰å‘¨ç¨å¤§ä¸€ç‚¹ï¼Œæœ€å¤§çš„æ˜¯ç¬¬ä¸€å‘¨å’Œç¬¬å››å‘¨ã€‚å’Œé¢„æœŸçš„ä¸€æ ·ï¼Œç¬¬äºŒå‘¨å’Œç¬¬ä¸‰å‘¨çš„OOMæ¯”ç‡è½»å¾®åœ°å¢åŠ äº†åŸæ³¨5: ç¬¬3å‘¨åæœŸçš„å¼‚å¸¸æƒ…å†µä¸æœ¬æ¬¡å®éªŒæ— å…³ã€‚åœ¨è¯„ä¼°äº†è¿™ä¸ªç»“æœåï¼Œæˆ‘ä»¬è®¤ä¸ºåˆ©å¤§äºå¼Šï¼Œäºæ˜¯åœ¨å…¶å®ƒCellä¸Šä¹Ÿé‡‡ç”¨äº†é€‚åº¦ç­–ç•¥çš„èµ„æºå›æ”¶å‚æ•°ã€‚ å›¾12. æ›´æ¿€è¿›çš„èµ„æºä¼°è®¡å¯ä»¥å›æ”¶æ›´å¤šèµ„æºï¼Œä½†ä¼šç¨å¢åŠ OOMäº‹ä»¶ ","date":"2022-05-31","objectID":"/posts/brog-in-google/:5:5","tags":["è½¬è½½","brog","cluster"],"title":"[è¯‘]ä½¿ç”¨Borgåœ¨Googleç®¡ç†å¤§è§„æ¨¡é›†ç¾¤","uri":"/posts/brog-in-google/"},{"categories":["k8s"],"content":"6. éš”ç¦» 50%çš„æœºå™¨è¿è¡Œäº†9ä¸ªä»¥ä¸Šçš„ä»»åŠ¡ï¼›å¤„äº90%åˆ†ä½æ•°çš„æœºå™¨åˆ™æœ‰å¤§çº¦25ä¸ªä»»åŠ¡ï¼Œ4500ä¸ªçº¿ç¨‹[83]ã€‚è™½ç„¶åœ¨åº”ç”¨ä¹‹é—´å…±äº«æœºå™¨ä¼šå¢åŠ åˆ©ç”¨ç‡ï¼Œä½†ä¹Ÿéœ€è¦ä¸€ä¸ªæ¯”è¾ƒå¥½çš„æœºåˆ¶æ¥ä¿è¯ä»»åŠ¡ä¹‹é—´ä¸äº§ç”Ÿå¹²æ‰°ã€‚è¿™åŒæ—¶é€‚ç”¨äºå®‰å…¨å’Œæ€§èƒ½ä¸¤ä¸ªæ–¹é¢ã€‚ ","date":"2022-05-31","objectID":"/posts/brog-in-google/:6:0","tags":["è½¬è½½","brog","cluster"],"title":"[è¯‘]ä½¿ç”¨Borgåœ¨Googleç®¡ç†å¤§è§„æ¨¡é›†ç¾¤","uri":"/posts/brog-in-google/"},{"categories":["k8s"],"content":"6.1 å®‰å…¨éš”ç¦» æˆ‘ä»¬ä½¿ç”¨Linuxçš„chrootä½œä¸ºåŒä¸€å°æœºå™¨ä¸Šä¸åŒä»»åŠ¡ä¹‹é—´çš„ä¸»è¦å®‰å…¨éš”ç¦»æœºåˆ¶ã€‚ä»…å½“æŸå°æœºå™¨æœ‰ç”¨æˆ·è¿è¡Œçš„ä»»åŠ¡æ—¶ï¼Œä¸ºäº†å…è®¸è¿œç¨‹è°ƒè¯•ï¼Œæˆ‘ä»¬ä»¥å‰ä¼šè‡ªåŠ¨åˆ†å‘ï¼ˆæˆ–åºŸé™¤ï¼‰SSHç§˜é’¥ï¼Œä½¿ç”¨æˆ·å¯ä»¥è®¿é—®è¿™å°æœºå™¨ã€‚å¯¹å¤§å¤šæ•°ç”¨æˆ·æ¥è¯´ï¼Œç°åœ¨è¢«æ›¿æ¢ä¸ºborgsshå‘½ä»¤ï¼Œè¿™ä¸ªç¨‹åºå’ŒBorgletååŒæ„å»ºä¸€ä¸ªSSHé€šé“ï¼Œè¿æ¥åˆ°ä¸ä»»åŠ¡è¿è¡Œåœ¨åŒä¸€ä¸ªchrootå’Œcgroupä¸‹çš„Shellï¼Œè¿™æ ·é™åˆ¶å°±æ›´åŠ ä¸¥æ ¼äº†ã€‚ Googleçš„AppEngineï¼ˆGAEï¼‰[38]å’ŒGoogle Compute Engineï¼ˆGCEï¼‰ä½¿ç”¨VMå’Œå®‰å…¨æ²™ç®±æŠ€æœ¯è¿è¡Œå¤–éƒ¨çš„è½¯ä»¶ã€‚æˆ‘ä»¬æŠŠæ¯ä¸ªè¿è¡Œåœ¨KVMè¿›ç¨‹ä¸­çš„VMä½œä¸ºä¸€ä¸ªBorgä»»åŠ¡æ¥è¿è¡Œã€‚ ","date":"2022-05-31","objectID":"/posts/brog-in-google/:6:1","tags":["è½¬è½½","brog","cluster"],"title":"[è¯‘]ä½¿ç”¨Borgåœ¨Googleç®¡ç†å¤§è§„æ¨¡é›†ç¾¤","uri":"/posts/brog-in-google/"},{"categories":["k8s"],"content":"6.2 æ€§èƒ½éš”ç¦» æ—©æœŸçš„Borgletä½¿ç”¨äº†ä¸€ç§ç›¸å¯¹åŸå§‹çš„èµ„æºéš”ç¦»æªæ–½ï¼šäº‹åæ£€æŸ¥å†…å­˜ã€ç¡¬ç›˜å’ŒCPUä½¿ç”¨é‡ï¼Œç»ˆæ­¢ä½¿ç”¨è¿‡å¤šå†…å­˜å’Œç¡¬ç›˜çš„ä»»åŠ¡ï¼Œæˆ–è€…é™ä½ä½¿ç”¨è¿‡å¤šCPUçš„ä»»åŠ¡çš„Linux CPUä¼˜å…ˆçº§ã€‚ä¸è¿‡ï¼Œä¸€äº›ç²—æš´çš„ä»»åŠ¡è¿˜æ˜¯èƒ½å¾ˆå®¹æ˜“åœ°å½±å“åˆ°åŒå°æœºå™¨ä¸Šå…¶å®ƒä»»åŠ¡çš„æ€§èƒ½ï¼Œäºæ˜¯æœ‰çš„ç”¨æˆ·å°±ä¼šå¤šç”³è¯·èµ„æºæ¥è®©Borgå‡å°‘ä¸å…¶å…±å­˜çš„ä»»åŠ¡æ•°é‡ï¼Œé™ä½äº†èµ„æºåˆ©ç”¨ç‡ã€‚èµ„æºå›æ”¶å¯ä»¥å¼¥è¡¥ä¸€äº›æŸå¤±ï¼Œä½†ä¸æ˜¯å…¨éƒ¨ï¼Œå› ä¸ºæ¶‰åŠåˆ°å®‰å…¨è£•åº¦ã€‚åœ¨æç«¯æƒ…å†µä¸‹ï¼Œç”¨æˆ·ä¼šè¦æ±‚ä½¿ç”¨ä¸“å±çš„æœºå™¨æˆ–è€…Cellã€‚ ç›®å‰ï¼Œæ‰€æœ‰Borgä»»åŠ¡éƒ½è¿è¡Œåœ¨åŸºäºLinux cgroupçš„èµ„æºå®¹å™¨[17, 58, 62]é‡Œã€‚Borgletæ§åˆ¶ç€è¿™äº›å®¹å™¨çš„è®¾ç½®ã€‚æœ‰äº†OSå†…æ ¸çš„å¸®åŠ©ï¼Œæ§åˆ¶èƒ½åŠ›å¾—åˆ°äº†æ”¹å–„ã€‚å³ä½¿è¿™æ ·ï¼Œå¶å°”è¿˜æ˜¯æœ‰åº•å±‚çš„èµ„æºå‘ç”Ÿå†²çªï¼ˆä¾‹å¦‚å†…å­˜å¸¦å®½æˆ–L3ç¼“å­˜æ±¡æŸ“ï¼‰ï¼Œè§[60, 83]ã€‚ ä¸ºäº†åº”å¯¹è¿‡è½½å’Œè¶…å”®ï¼ŒBorgä»»åŠ¡æœ‰ä¸€ä¸ªåº”ç”¨ç±»åˆ«ï¼ˆappclassï¼‰å±æ€§ã€‚æœ€é‡è¦çš„åŒºåˆ†æ˜¯å»¶è¿Ÿæ•æ„Ÿï¼ˆLSï¼‰çš„åº”ç”¨å’Œæœ¬æ–‡ä¸­ç§°ä¸ºæ‰¹å¤„ç†ï¼ˆbatchï¼‰çš„å…¶å®ƒç±»åˆ«ã€‚LSä»»åŠ¡åŒ…æ‹¬é¢å‘ç”¨æˆ·çš„åº”ç”¨å’Œéœ€è¦å¿«é€Ÿå“åº”çš„å…±äº«åŸºç¡€è®¾æ–½ã€‚é«˜ä¼˜å…ˆçº§çš„LSä»»åŠ¡å¾—åˆ°æœ€é«˜ä¼˜å¾…ï¼Œå¯ä»¥æš‚æ—¶è®©æ‰¹å¤„ç†ä»»åŠ¡ç­‰å¾…å‡ ç§’ç§ã€‚ ç¬¬äºŒä¸ªåŒºåˆ†æ˜¯ï¼šå¯å‹ç¼©èµ„æºï¼ˆä¾‹å¦‚CPUï¼Œç¡¬ç›˜I/Oå¸¦å®½ï¼‰ï¼Œéƒ½æ˜¯åŸºäºé€Ÿç‡çš„ï¼Œå¯ä»¥é€šè¿‡é™ä½ä¸€ä¸ªä»»åŠ¡çš„æœåŠ¡è´¨é‡è€Œä¸æ˜¯æ€æ­»å®ƒæ¥å›æ”¶ï¼›ä¸å¯å‹ç¼©èµ„æºï¼ˆä¾‹å¦‚å†…å­˜ã€ç¡¬ç›˜ç©ºé—´ï¼‰ï¼Œè¿™äº›ä¸€èˆ¬æ¥è¯´ä¸æ€æ‰ä»»åŠ¡æ˜¯æ²¡åŠæ³•å›æ”¶çš„ã€‚å¦‚æœä¸€ä¸ªæœºå™¨ç”¨å…‰äº†ä¸å¯å‹ç¼©èµ„æºï¼ŒBorgleté©¬ä¸Šå°±ä¼šå¼€å§‹æ€æ­»ä»»åŠ¡ï¼Œä»ä½ä¼˜å…ˆçº§å¼€å§‹ï¼Œç›´åˆ°èƒ½æ»¡è¶³å‰©ä¸‹çš„èµ„æºé¢„ç•™ã€‚å¦‚æœæœºå™¨ç”¨å®Œäº†å¯å‹ç¼©èµ„æºï¼ŒBorgletä¼šé™åˆ¶ä½¿ç”¨é‡ï¼ˆåå¥½LSä»»åŠ¡ï¼‰ï¼Œè¿™æ ·ä¸ç”¨æ€æ­»ä»»ä½•ä»»åŠ¡ä¹Ÿèƒ½å¤„ç†çŸ­æœŸè´Ÿè½½å°–å³°ã€‚å¦‚æœæƒ…å†µæ²¡æœ‰æ”¹å–„ï¼ŒBorgmasterä¼šä»è¿™ä¸ªæœºå™¨ä¸Šç§»é™¤ä¸€ä¸ªæˆ–å¤šä¸ªä»»åŠ¡ã€‚ Borgletæœ‰ä¸€ä¸ªç”¨æˆ·æ€çš„æ§åˆ¶å¾ªç¯ï¼Œè´Ÿè´£ä»¥ä¸‹æ“ä½œï¼šä¸ºå®¹å™¨ç¡®å®šå†…å­˜é‡ï¼Œprodä»»åŠ¡åŸºäºé¢„æµ‹å€¼ï¼Œè€Œnon-prodä»»åŠ¡åˆ™åŸºäºå†…å­˜å‹åŠ›ï¼›å¤„ç†æ¥è‡ªå†…æ ¸çš„OOMäº‹ä»¶ï¼›å½“ä»»åŠ¡è¯•å›¾åˆ†é…è¶…è¿‡å…¶è‡ªèº«é™é¢çš„å†…å­˜æ—¶ï¼Œæˆ–è€…è¶…å”®çš„æœºå™¨ä¸Šç¡®å®è€—å°½å†…å­˜æ—¶ï¼Œéƒ½ä¼šæ€æ­»ä»»åŠ¡ã€‚Linuxæ¿€è¿›çš„æ–‡ä»¶ç¼“å­˜è®©æˆ‘ä»¬çš„å®ç°å¤æ‚å¾—å¤šï¼Œå› ä¸ºéœ€è¦ç²¾ç¡®è®¡ç®—å†…å­˜ä½¿ç”¨é‡ã€‚ ä¸ºäº†å¢å¼ºæ€§èƒ½éš”ç¦»ï¼ŒLSä»»åŠ¡å¯ä»¥é¢„ç•™æ•´ä¸ªç‰©ç†CPUæ ¸ï¼Œä»¥é˜»æ­¢åˆ«çš„LSä»»åŠ¡æ¥ä½¿ç”¨å®ƒä»¬ã€‚æ‰¹å¤„ç†ä»»åŠ¡è¢«å…è®¸è¿è¡Œåœ¨ä»»ä½•æ ¸ä¸Šï¼Œä½†æ˜¯ç›¸æ¯”LSä»»åŠ¡ï¼Œæ‰¹å¤„ç†ä»»åŠ¡åªåˆ†é…äº†å¾ˆå°‘çš„è°ƒåº¦ä»½é¢ã€‚BorgletåŠ¨æ€åœ°è°ƒæ•´è´ªå©ªçš„LSä»»åŠ¡çš„èµ„æºä¸Šé™ï¼Œä»¥ä¿è¯å®ƒä»¬ä¸ä¼šæŠŠæ‰¹å¤„ç†ä»»åŠ¡é¥¿ä¸Šå‡ åˆ†é’Ÿï¼Œå¿…è¦æ—¶æœ‰é€‰æ‹©çš„ä½¿ç”¨CFSå¸¦å®½æ§åˆ¶[75]ï¼›ä»…ç”¨ä»½é¢æ¥è¡¨ç¤ºæ˜¯ä¸å¤Ÿçš„ï¼Œå› ä¸ºæˆ‘ä»¬æœ‰å¤šä¸ªä¼˜å…ˆçº§ã€‚ å›¾13. è°ƒåº¦å»¶è¿Ÿä¸è´Ÿè½½çš„å…³ç³»ã€‚å³ä¸€ä¸ªå°±ç»ªçº¿ç¨‹éœ€è¦ç­‰å¾…è¶…è¿‡1 msæ‰èƒ½è¿è¡Œçš„æ¯”ç‡ï¼Œä¸æœºå™¨ç¹å¿™ç¨‹åº¦çš„å…³ç³»ã€‚æ¯ç»„æ•°æ®æ¡ä¸­ï¼Œå·¦ä¾§æ˜¯å»¶è¿Ÿæ•æ„Ÿçš„ä»»åŠ¡ï¼Œå³ä¾§æ˜¯æ‰¹å¤„ç†ä»»åŠ¡ åªæœ‰å¾ˆå°‘çš„æ¯”ç‡éœ€è¦ç­‰5 msä»¥ä¸Šï¼Œè¶…è¿‡10 mså°±æå°‘äº†ã€‚è¿™æ˜¯2013å¹´12æœˆä»ä¸€ä¸ª ä»£è¡¨æ€§çš„Cellä¸­è·å–çš„ä¸€ä¸ªæœˆçš„æ•°æ®ï¼›è¯¯å·®çº¿æ˜¯æ¯å¤©çš„æ³¢åŠ¨åŒLeverich[56]ä¸€æ ·ï¼Œæˆ‘ä»¬å‘ç°æ ‡å‡†çš„Linux CPUè°ƒåº¦å™¨ï¼ˆCFSï¼‰éœ€è¦å¤§å¹…è°ƒæ•´æ‰èƒ½åŒæ—¶æ”¯æŒä½å»¶è¿Ÿå’Œé«˜åˆ©ç”¨ç‡ã€‚ä¸ºäº†å‡å°‘è°ƒåº¦å»¶è¿Ÿï¼šæˆ‘ä»¬å†…éƒ¨ç‰ˆæœ¬çš„CFSå¯¹æ¯ä¸ªcgroupéƒ½æœ‰å•ç‹¬çš„è´Ÿè½½å†å²[16]ï¼›å…è®¸LSä»»åŠ¡æŠ¢å æ‰¹å¤„ç†ä»»åŠ¡ï¼›å½“ä¸€ä¸ªCPUæœ‰å¤šä¸ªå°±ç»ªçš„LSä»»åŠ¡æ—¶ï¼Œä¼šå‡å°‘å…¶è°ƒåº¦é‡ï¼ˆQuantumï¼‰ã€‚å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬çš„å¤§å¤šåº”ç”¨ä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹å¤„ç†ä¸€ä¸ªè¯·æ±‚çš„æ¨¡å‹ï¼Œè¿™æ ·å°±ç¼“è§£äº†æŒç»­çš„è´Ÿè½½å¤±è¡¡ã€‚æˆ‘ä»¬èŠ‚ä¿­åœ°ä½¿ç”¨cpusetsä¸ºæœ‰ç‰¹åˆ«ä¸¥æ ¼çš„å»¶è¿Ÿéœ€æ±‚çš„åº”ç”¨åˆ†é…CPUæ ¸ã€‚è¿™äº›åŠªåŠ›çš„ä¸€äº›æ•ˆæœå±•ç¤ºåœ¨å›¾13ä¸­ã€‚æˆ‘ä»¬æŒç»­åœ¨è¿™æ–¹é¢æŠ•å…¥ï¼Œå¢åŠ æ„ŸçŸ¥NUMAã€è¶…çº¿ç¨‹ã€èƒ½è€—ï¼ˆå¦‚[81]ï¼‰çš„çº¿ç¨‹æ”¾ç½®å’ŒCPUç®¡ç†ï¼Œæ”¹è¿›Borgletçš„æ§åˆ¶ç²¾ç¡®åº¦ã€‚ ä»»åŠ¡è¢«å…è®¸åœ¨å…¶ä¸Šé™ä¹‹å†…æ¶ˆè´¹èµ„æºã€‚å¤§éƒ¨åˆ†ä»»åŠ¡è¿˜å…è®¸å»ä½¿ç”¨è¶…å‡ºä¸Šé™çš„å¯å‹ç¼©èµ„æºï¼Œä¾‹å¦‚CPUï¼Œä»¥åˆ©ç”¨ç©ºé—²èµ„æºã€‚åªæœ‰5%çš„LSä»»åŠ¡ç¦æ­¢è¿™ä¹ˆåšï¼Œä¸»è¦æ˜¯ä¸ºäº†æ”¹å–„å¯é¢„æµ‹æ€§ï¼›å°äº1%çš„æ‰¹å¤„ç†ä»»åŠ¡ä¹Ÿç¦æ­¢äº†ã€‚ä½¿ç”¨è¶…é‡å†…å­˜é»˜è®¤æ˜¯è¢«ç¦æ­¢çš„ï¼Œå› ä¸ºè¿™ä¼šå¢åŠ ä»»åŠ¡è¢«æ€æ‰çš„æ¦‚ç‡ï¼Œä¸è¿‡å³ä½¿è¿™æ ·ï¼Œ10%çš„LSä»»åŠ¡è§£é™¤äº†è¿™ä¸ªé™åˆ¶ï¼Œ79%çš„æ‰¹å¤„ç†ä»»åŠ¡ä¹Ÿè§£é™¤äº†ï¼Œå› ä¸ºè¿™æ˜¯MapReduceæ¡†æ¶çš„é»˜è®¤è®¾ç½®ã€‚è¿™è¡¥å¿äº†èµ„æºå›æ”¶ï¼ˆÂ§5.5ï¼‰çš„åæœã€‚æ‰¹å¤„ç†ä»»åŠ¡å¾ˆä¹æ„ä½¿ç”¨ç©ºé—²çš„æˆ–å›æ”¶çš„å†…å­˜ï¼šå¤§å¤šæƒ…å†µä¸‹è¿™æ ·è¿ä½œå¾—å¾ˆå¥½ï¼Œå³ä½¿å¶å°”æ‰¹å¤„ç†ä»»åŠ¡ä¼šè¢«æ€¥éœ€èµ„æºçš„LSä»»åŠ¡æ€æ‰ã€‚ ","date":"2022-05-31","objectID":"/posts/brog-in-google/:6:2","tags":["è½¬è½½","brog","cluster"],"title":"[è¯‘]ä½¿ç”¨Borgåœ¨Googleç®¡ç†å¤§è§„æ¨¡é›†ç¾¤","uri":"/posts/brog-in-google/"},{"categories":["k8s"],"content":"7. ç›¸å…³å·¥ä½œ æ•°åå¹´æ¥ï¼Œèµ„æºè°ƒåº¦å·²ç»åœ¨å¤šç§åœºæ™¯å¾—åˆ°äº†ç ”ç©¶ï¼Œå¦‚å¹¿åŸŸé«˜æ€§èƒ½è®¡ç®—ç½‘æ ¼ã€å·¥ä½œç«™ç½‘ç»œã€å’Œå¤§è§„æ¨¡æœåŠ¡å™¨é›†ç¾¤ç­‰ã€‚æˆ‘ä»¬è¿™é‡Œåªå…³æ³¨æœ€ç›¸å…³çš„å¤§è§„æ¨¡æœåŠ¡å™¨é›†ç¾¤è¿™ä¸ªåœºæ™¯ã€‚ æœ€è¿‘çš„ä¸€äº›ç ”ç©¶åˆ†æäº†æ¥è‡ªäºYahoo!ã€Googleå’ŒFacebookçš„é›†ç¾¤è®°å½•æ•°æ®[20, 52, 63, 68, 70, 80, 82]ï¼Œå±•ç°äº†è¿™äº›ç°ä»£çš„æ•°æ®ä¸­å¿ƒå’Œå·¥ä½œè´Ÿè½½å›ºæœ‰çš„å¼‚æ„æ€§å’Œå¤§è§„æ¨¡å¸¦æ¥çš„æŒ‘æˆ˜ã€‚[69]åŒ…å«äº†å¯¹é›†ç¾¤ç®¡ç†å™¨æ¶æ„çš„åˆ†ç±»ã€‚ Apache Mesos[45]å°†èµ„æºç®¡ç†å’Œä»»åŠ¡æ”¾ç½®åŠŸèƒ½æ‹†åˆ†åˆ°ä¸€ä¸ªé›†ä¸­èµ„æºç®¡ç†å™¨ï¼ˆç±»ä¼¼äºå»æ‰è°ƒåº¦å™¨çš„Bormasterï¼‰å’Œå¤šç§â€œæ¡†æ¶â€ï¼ˆæ¯”å¦‚Hadoop[41]å’ŒSpark[73]ï¼‰ä¹‹é—´ï¼Œä¸¤è€…åŸºäºä¾›åº”ï¼ˆOfferï¼‰æœºåˆ¶äº¤äº’ã€‚Borgåˆ™æŠŠè¿™äº›åŠŸèƒ½é›†ä¸­åœ¨ä¸€èµ·ï¼Œä½¿ç”¨åŸºäºè¯·æ±‚çš„æœºåˆ¶ï¼Œè€Œä¸”æ‰©å±•æ€§ç›¸å½“å¥½ã€‚DRF[29, 35, 36, 66]æœ€åˆæ˜¯ä¸ºMesoså¼€å‘çš„ï¼›Borgåˆ™ä½¿ç”¨ä¼˜å…ˆçº§å’Œå‡†å…¥é…é¢æ¥æ›¿ä»£ã€‚Mesoså¼€å‘è€…å·²ç»å®£å¸ƒäº†ä»–ä»¬æ‰©å±•Mesosçš„é›„å¿ƒå£®å¿—ï¼šé¢„æµ‹æ€§èµ„æºåˆ†é…å’Œå›æ”¶ï¼Œä»¥åŠè§£å†³[69]ä¸­å‘ç°çš„ä¸€äº›é—®é¢˜ã€‚ YARN[76]æ˜¯ä¸€ä¸ªé’ˆå¯¹Hadoopçš„é›†ç¾¤ç®¡ç†å™¨ã€‚æ¯ä¸ªåº”ç”¨éƒ½æœ‰ä¸€ä¸ªå¦å¤–çš„ç®¡ç†å™¨ï¼Œä¸ä¸­å¤®èµ„æºç®¡ç†å™¨è°ˆåˆ¤æ‰€éœ€èµ„æºï¼›è¿™è·Ÿå¤§çº¦2008å¹´å¼€å§‹Googleçš„MapReduceä½œä¸šå·²ç»ä½¿ç”¨çš„å‘Borgè·å–èµ„æºçš„æ¨¡å¼å¦‚å‡ºä¸€è¾™ã€‚YARNçš„èµ„æºç®¡ç†å™¨æœ€è¿‘æ‰æ”¯æŒå®¹é”™ã€‚ä¸€ä¸ªç›¸å…³çš„å¼€æºé¡¹ç›®æ˜¯Hadoop Capacity Schedulerï¼ˆåŸºäºå®¹é‡çš„è°ƒåº¦å™¨ï¼‰[42]ï¼Œæä¾›äº†å¤šç§Ÿæˆ·ä¸‹çš„å®¹é‡ä¿è¯ã€å¤šå±‚é˜Ÿåˆ—ã€å¼¹æ€§å…±äº«å’Œå…¬å¹³è°ƒåº¦ã€‚YARNæœ€è¿‘æ‰©å±•æ”¯æŒäº†å¤šç§èµ„æºç±»å‹ã€ä¼˜å…ˆçº§ã€æŠ¢å å’Œé«˜çº§å‡†å…¥æ§åˆ¶[21]ã€‚Tetrisä¿„ç½—æ–¯æ–¹å—ç ”ç©¶åŸå‹[40]æ”¯æŒå®Œæˆæ—¶é—´æ„ŸçŸ¥çš„ä½œä¸šè£…ç®±ã€‚ Facebookçš„Tupperware[64]ï¼Œæ˜¯ä¸€ä¸ªåœ¨é›†ç¾¤ä¸­è°ƒåº¦cgroupå®¹å™¨çš„ç±»Borgç³»ç»Ÿï¼›åªæœ‰å°‘é‡ç»†èŠ‚æŠ«éœ²å‡ºæ¥äº†ï¼Œçœ‹èµ·æ¥å®ƒä¹Ÿæä¾›äº†æŸç§å½¢å¼çš„èµ„æºå›æ”¶åŠŸèƒ½ã€‚Twitterå¼€æºçš„Aurora[5]æ˜¯ä¸€ä¸ªç±»ä¼¼Borgçš„ï¼Œç”¨äºé•¿æœŸè¿è¡ŒæœåŠ¡çš„è°ƒåº¦å™¨ï¼Œè¿è¡Œä¸Mesosä¹‹ä¸Šï¼Œå…¶é…ç½®è¯­è¨€å’ŒçŠ¶æ€è¿ç§»ä¸Borgç±»ä¼¼ã€‚ å¾®è½¯çš„Autopilot[48]ä¸ºå…¶é›†ç¾¤æä¾›äº†â€œè‡ªåŠ¨åŒ–çš„è½¯ä»¶ä¾›åº”å’Œéƒ¨ç½²ï¼›ç³»ç»Ÿç›‘æ§ï¼›ä»¥åŠé‡‡å–ä¿®å¤è¡Œä¸ºå¤„ç†è½¯ç¡¬ä»¶æ•…éšœâ€çš„åŠŸèƒ½ã€‚Borgç”Ÿæ€ç³»ç»Ÿæä¾›äº†ç›¸ä¼¼çš„ç‰¹æ€§ï¼Œä¸è¿‡ç¯‡å¹…æ‰€é™ï¼Œä¸å†æ·±å…¥è®¨è®ºï¼›ä½œè€…Isaardæ¦‚æ‹¬äº†å¾ˆå¤šæˆ‘ä»¬ä¹Ÿèµæˆçš„æœ€ä½³å®è·µã€‚ Quincy[49]ä½¿ç”¨äº†ä¸€ä¸ªç½‘ç»œæµæ¨¡å‹æ¥æä¾›å…¬å¹³æ€§å’Œæ•°æ®å±€éƒ¨æ€§æ„ŸçŸ¥çš„è°ƒåº¦ï¼Œåº”ç”¨åœ¨å‡ ç™¾ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤çš„æ•°æ®å¤„ç†DAGä¸Šã€‚Borgä½¿ç”¨é…é¢å’Œä¼˜å…ˆçº§åœ¨ç”¨æˆ·é—´å…±äº«æ•°æ®ï¼Œå¯ä»¥æ‰©å±•åˆ°ä¸Šä¸‡å°æœºå™¨ã€‚Quincyå¯ä»¥ç›´æ¥å¤„ç†æ‰§è¡Œå›¾ï¼Œè€ŒBorgéœ€è¦åœ¨å…¶ä¸Šå±‚å¦å¤–æ„å»ºã€‚ Cosmos[44]èšç„¦åœ¨æ‰¹å¤„ç†ä¸Šï¼Œå¼ºè°ƒäº†ç”¨æˆ·å¯ä»¥å…¬å¹³è·å–ä»–ä»¬å·²ç»æçŒ®ç»™é›†ç¾¤çš„èµ„æºã€‚æ¯ä¸ªä½œä¸šåˆ†åˆ«æœ‰ä¸€ä¸ªç®¡ç†å™¨æ¥è·å–èµ„æºï¼›åªæœ‰å¾ˆå°‘å…¬å¼€çš„ç»†èŠ‚ã€‚ å¾®è½¯çš„Apolloç³»ç»Ÿ[13]ä¸ºæ¯ä¸ªçŸ­æœŸæ‰¹å¤„ç†ä½œä¸šåˆ†åˆ«ä½¿ç”¨å•ç‹¬çš„è°ƒåº¦å™¨ï¼Œä»¥è·å¾—é«˜ååé‡ï¼Œå…¶é›†ç¾¤è§„æ¨¡çœ‹èµ·æ¥ä¸Borgçš„Cellç›¸å½“ã€‚ApolloæŠ•æœºåœ°æ‰§è¡Œä½ä¼˜å…ˆçº§åå°ä»»åŠ¡æ¥æå‡èµ„æºåˆ©ç”¨ç‡ï¼Œä»£ä»·æ˜¯æœ‰æ—¶æœ‰é•¿è¾¾å¤šæ—¥çš„é˜Ÿåˆ—å»¶è¿Ÿã€‚Apolloçš„å„èŠ‚ç‚¹éƒ½ä¸€ä¸ªå…³äºå¼€å§‹æ—¶é—´çš„é¢„æµ‹çŸ©é˜µï¼Œå…¶è¡Œåˆ—åˆ†åˆ«ä¸ºCPUå’Œå†…å­˜ä¸¤ä¸ªèµ„æºç»´åº¦ã€‚è°ƒåº¦å™¨ä¼šç»¼åˆå¼€å§‹æ—¶é—´ã€ä¼°è®¡çš„å¯åŠ¨å¼€é”€ã€è·å–è¿œç¨‹æ•°æ®çš„å¼€é”€æ¥å†³å®šéƒ¨ç½²ä½ç½®ï¼Œå¹¶ç”¨ä¸€ä¸ªéšæœºå»¶æ—¶æ¥å‡å°‘å†²çªã€‚Borgä½¿ç”¨çš„æ˜¯ä¸­å¤®è°ƒåº¦å™¨ï¼ŒåŸºäºä¹‹å‰çš„åˆ†é…æ¥å†³å®šéƒ¨ç½²ä½ç½®ï¼Œå¯ä»¥å¤„ç†æ›´å¤šçš„èµ„æºç»´åº¦ï¼Œè€Œä¸”æ›´å…³æ³¨é«˜å¯ç”¨ã€é•¿æœŸè¿è¡Œçš„åº”ç”¨ï¼›Apolloä¹Ÿè®¸èƒ½å¤„ç†æ¯”Borgæ›´é«˜çš„ä»»åŠ¡åˆ°è¾¾ç‡ã€‚ é˜¿é‡Œå·´å·´çš„ä¼ç¾²ï¼ˆFuxiï¼‰[84]æ”¯æŒæ•°æ®åˆ†æçš„åº”ç”¨ï¼Œä»2009å¹´å°±å¼€å§‹è¿è¡Œäº†ã€‚ç±»ä¼¼Borgmasterï¼Œä¸€ä¸ªé›†ä¸­çš„FuxiMasterï¼ˆä¹Ÿåšäº†å¤šå‰¯æœ¬å®¹é”™ï¼‰ä»èŠ‚ç‚¹ä¸Šè·å–å¯ç”¨èµ„æºçš„ä¿¡æ¯ã€æ¥å—åº”ç”¨çš„èµ„æºè¯·æ±‚ï¼Œç„¶ååŒ¹é…ä¸¤è€…ã€‚ä¼ç¾²çš„å¢é‡è°ƒåº¦ç­–ç•¥ä¸Borgçš„ä»»åŠ¡ç­‰ä»·ç±»æ˜¯ç›¸åçš„ï¼šä¼ç¾²ç”¨æœ€æ–°çš„å¯ç”¨èµ„æºåŒ¹é…ç­‰å¾…é˜Ÿåˆ—é‡Œçš„ä»»åŠ¡ã€‚ç±»ä¼¼Mesosï¼Œä¼ç¾²å…è®¸å®šä¹‰â€œè™šæ‹Ÿèµ„æºâ€ç±»å‹ã€‚åªæœ‰å¯¹åˆæˆå·¥ä½œè´Ÿè½½çš„å®éªŒç»“æœæ˜¯å…¬å¼€çš„ã€‚ Omega[69]æ”¯æŒå¤šä¸ªå¹¶å‘çš„è°ƒåº¦å™¨ï¼Œç²—ç•¥ç›¸å½“äºæ²¡æœ‰æŒä¹…å­˜å‚¨å’Œé“¾æ¥åˆ†ç‰‡çš„Borgmasterã€‚Omegaè°ƒåº¦å™¨ä½¿ç”¨ä¹è§‚å¹¶å‘æ§åˆ¶çš„æ–¹å¼å»æ“ä½œä¸€ä¸ªå…±äº«çš„é›†ç¾¤é¢„æœŸçš„å’Œè§‚å¯Ÿçš„çŠ¶æ€è¡¨ç¤ºã€‚é›†ç¾¤çŠ¶æ€å­˜å‚¨åœ¨ä¸€ä¸ªé›†ä¸­æŒä¹…å­˜å‚¨ä¸­ï¼Œç”¨å•ç‹¬çš„è¿æ¥ç»„ä»¶ä¸BorgletåŒæ­¥ã€‚Omageæ¶æ„è®¾è®¡ä¸ºæ”¯æŒå¤šç§ä¸åŒçš„å·¥ä½œè´Ÿè½½ï¼Œå®ƒä»¬æœ‰è‡ªå·±ç‰¹å®šçš„RPCæ¥å£ã€çŠ¶æ€è¿ç§»å’Œè°ƒåº¦ç­–ç•¥ï¼ˆä¾‹å¦‚é•¿æœŸè¿è¡Œçš„æœåŠ¡ã€å¤šä¸ªæ¡†æ¶æ‰¹å¤„ç†ä½œä¸šã€å¦‚é›†ç¾¤å­˜å‚¨è¿™æ ·çš„åŸºç¡€æœåŠ¡ã€Googleäº‘å¹³å°ä¸Šçš„è™šæ‹Ÿæœºï¼‰ã€‚ç›¸åï¼ŒBorgæä¾›äº†ä¸€ç§é€šç”¨æ–¹æ¡ˆï¼ŒåŒæ ·çš„RPCæ¥å£ã€çŠ¶æ€è¿ç§»ã€è°ƒåº¦ç­–ç•¥ï¼Œä¸ºæ”¯æŒå¤šç§ä¸åŒçš„è´Ÿè½½ï¼Œå…¶è§„æ¨¡å’Œå¤æ‚åº¦é€æ¸å¢åŠ ï¼Œä½†ç›®å‰æ¥è¯´å¯æ‰©å±•æ€§è¿˜ä¸ç®—ä¸€ä¸ªé—®é¢˜ï¼ˆÂ§3.4ï¼‰ã€‚ Googleçš„å¼€æºé¡¹ç›®Kubernetesç³»ç»Ÿ[53]æŠŠåº”ç”¨æ”¾åœ¨Dockerå®¹å™¨å†…[28]ï¼Œå†åˆ†å‘åˆ°å¤šä¸ªæœºå™¨ä¸Šã€‚å®ƒæ—¢å¯ä»¥è¿è¡Œåœ¨ç‰©ç†æœºä¸Šï¼ˆåƒBorgé‚£æ ·ï¼‰ï¼Œä¹Ÿå¯ä»¥è¿è¡Œåœ¨å¤šä¸ªäº‘ä¾›åº”å•†ï¼ˆæ¯”å¦‚Google Compute Engineï¼ŒGCEï¼‰çš„ä¸»æœºä¸Šã€‚Kubernetesæ­£åœ¨å¿«é€Ÿå¼€å‘ä¸­ï¼Œå®ƒçš„å¾ˆå¤šå¼€å‘è€…ä¹Ÿå‚ä¸å¼€å‘äº†Borgã€‚Googleæä¾›äº†ä¸€ä¸ªæ‰˜ç®¡çš„ç‰ˆæœ¬ï¼Œç§°ä¸ºGoogle Container Engineï¼ˆGKEï¼‰[39]ã€‚æˆ‘ä»¬ä¼šåœ¨ä¸‹ä¸€èŠ‚é‡Œé¢è®¨è®ºKubernetesä»Borgä¸­å­¦åˆ°äº†å“ªäº›ä¸œè¥¿ã€‚ åœ¨é«˜æ€§èƒ½è®¡ç®—ç¤¾åŒºå¯¹è¿™ä¸ªé¢†åŸŸæœ‰é•¿æœŸçš„ç ”ç©¶ä¼ ç»Ÿï¼ˆå¦‚Maui, Moab, Platform LSF[2, 47, 50]ï¼‰ï¼›ä½†æ˜¯è¿™å’ŒGoogle Cellæ‰€é¢å¯¹çš„è§„æ¨¡ã€å·¥ä½œè´Ÿè½½ã€å®¹é”™æ€§æ˜¯ä¸åŒçš„ã€‚æ€»ä½“è€Œè¨€ï¼Œä¸ºè¾¾åˆ°é«˜ç”¨ç‡ï¼Œè¿™äº›ç³»ç»Ÿéœ€è¦è®©ä»»åŠ¡åœ¨ä¸€ä¸ªå¾ˆé•¿çš„é˜Ÿåˆ—ä¸­ç­‰å¾…ã€‚ è™šæ‹ŸåŒ–ä¾›åº”å•†ï¼Œä¾‹å¦‚VMware[77]ï¼Œå’Œæ•°æ®ä¸­å¿ƒæ–¹æ¡ˆä¾›åº”å•†ï¼Œä¾‹å¦‚HPå’ŒIBM[46]æä¾›äº†å…¸å‹æƒ…å†µä¸‹å¯ä»¥æ‰©å±•åˆ°ä¸€åƒå°æœºå™¨è§„æ¨¡çš„é›†ç¾¤ç®¡ç†è§£å†³æ–¹æ¡ˆã€‚å¦å¤–ï¼Œä¸€äº›ç ”ç©¶å°ç»„çš„åŸå‹ç³»ç»Ÿä»¥å¤šç§æ–¹å¼æå‡äº†è°ƒåº¦è´¨é‡ï¼ˆå¦‚[25, 40, 72, 74]ï¼‰ã€‚ æœ€åï¼Œæ­£å¦‚æˆ‘ä»¬æ‰€æŒ‡å‡ºçš„ï¼Œå¤§è§„æ¨¡é›†ç¾¤ç®¡ç†çš„å¦å¤–ä¸€ä¸ªé‡è¦éƒ¨åˆ†æ˜¯è‡ªåŠ¨åŒ–å’Œæ— äººåŒ–ã€‚[43]æŒ‡å‡ºï¼Œå¤±æ•ˆé¢„æ¡ˆã€å¤šç§Ÿæˆ·ã€å¥åº·æ£€æŸ¥ã€å‡†å…¥æ§åˆ¶ï¼Œä»¥åŠå¯é‡å¯å¯¹å®ç°å•ä¸ªè¿ç»´äººå‘˜ç®¡ç†æ›´å¤šçš„æœºå™¨çš„ç›®æ ‡æ˜¯å¿…è¦çš„ã€‚Borgçš„è®¾è®¡å“²å­¦ä¹Ÿæ˜¯è¿™æ ·çš„ï¼Œè€Œä¸”æ”¯æ’‘äº†æˆ‘ä»¬çš„æ¯ä¸ªSREç®¡ç†æ•°ä¸‡å°æœºå™¨ã€‚ Borgä»å®ƒçš„å‰ä»»ç»§æ‰¿äº†å¾ˆå¤šä¸œè¥¿ï¼Œå³æˆ‘ä»¬å†…éƒ¨çš„å…¨å±€å·¥ä½œé˜Ÿåˆ—ï¼ˆGlobal Work Queueï¼‰ç³»ç»Ÿï¼Œå®ƒæœ€åˆæ˜¯ç”±Jeff Deanï¼ŒOlcan Sercinoglu, å’ŒPercy Liangå¼€å‘çš„ã€‚ Conder[85]æ›¾è¢«å¹¿æ³›åº”ç”¨äºæ”¶é›†ç©ºé—²èµ„æºï¼Œå…¶ClassAdsæœºåˆ¶[86]æ”¯æŒå£°æ˜å¼çš„è¯­å¥å’Œè‡ªåŠ¨å±æ€§åŒ¹é…ã€‚ ","date":"2022-05-31","objectID":"/posts/brog-in-google/:7:0","tags":["è½¬è½½","brog","cluster"],"title":"[è¯‘]ä½¿ç”¨Borgåœ¨Googleç®¡ç†å¤§è§„æ¨¡é›†ç¾¤","uri":"/posts/brog-in-google/"},{"categories":["k8s"],"content":"8. ç»éªŒæ•™è®­å’Œæœªæ¥å·¥ä½œ åœ¨è¿™ä¸€èŠ‚ä¸­æˆ‘ä»¬ä»‹ç»äº†åå¤šå¹´æ¥æˆ‘ä»¬åœ¨ç”Ÿäº§ç¯å¢ƒè¿è¡ŒBorgå¾—åˆ°çš„å®šæ€§çš„ç»éªŒæ•™è®­ï¼Œç„¶åä»‹ç»è®¾è®¡Kubernetes[53]æ˜¯å¦‚ä½•å¸æ”¶è¿™äº›ç»éªŒçš„ã€‚ ","date":"2022-05-31","objectID":"/posts/brog-in-google/:8:0","tags":["è½¬è½½","brog","cluster"],"title":"[è¯‘]ä½¿ç”¨Borgåœ¨Googleç®¡ç†å¤§è§„æ¨¡é›†ç¾¤","uri":"/posts/brog-in-google/"},{"categories":["k8s"],"content":"8.1 æ•™è®­ æˆ‘ä»¬ä»ä¸€äº›Borgä½œä¸ºåé¢è­¦ç¤ºçš„ç‰¹æ€§å¼€å§‹ï¼Œç„¶åä»‹ç»Kubernetesçš„æ›¿ä»£æ–¹æ¡ˆã€‚ å°†ä½œä¸šä½œä¸ºå”¯ä¸€çš„ä»»åŠ¡åˆ†ç»„æœºåˆ¶æ¯”è¾ƒå—é™ Borgæ²¡æœ‰å†…ç½®çš„æ–¹æ³•å°†å¤šä¸ªä½œä¸šç»„æˆå•ä¸ªå®ä½“æ¥ç®¡ç†ï¼Œæˆ–å°†ç›¸å…³çš„æœåŠ¡å®ä¾‹å…³è”èµ·æ¥ï¼ˆä¾‹å¦‚ï¼Œæµ‹è¯•é€šé“å’Œç”Ÿäº§é€šé“ï¼‰ã€‚ä½œä¸ºä¸€ä¸ªæŠ€å·§ï¼Œç”¨æˆ·æŠŠä»–ä»¬çš„æœåŠ¡æ‹“æ‰‘ç¼–ç åˆ°ä½œä¸šçš„åç§°ä¸­ï¼Œç„¶åæ„å»ºäº†æ›´é«˜å±‚çš„ç®¡ç†å·¥å…·æ¥è§£æè¿™äº›åç§°ã€‚è¿™ä¸ªé—®é¢˜çš„å¦å¤–ä¸€é¢æ˜¯ï¼Œæ²¡åŠæ³•æŒ‡å‘æœåŠ¡çš„ä»»æ„å­é›†ï¼Œè¿™å°±å¯¼è‡´äº†åƒµç¡¬çš„è¯­ä¹‰ï¼Œä»¥è‡³äºæ— æ³•æ»šåŠ¨å‡çº§æˆ–æ”¹å˜ä½œä¸šçš„å®ä¾‹æ•°ã€‚ ä¸ºäº†é¿å…è¿™äº›å›°éš¾ï¼ŒKubernetesä¸å†ä½¿ç”¨ä½œä¸šè¿™ä¸ªæ¦‚å¿µï¼Œè€Œæ˜¯ç”¨æ ‡ç­¾ï¼ˆLabelï¼‰æ¥ç»„ç»‡å®ƒçš„è°ƒåº¦å•å…ƒï¼ˆPodï¼‰ã€‚æ ‡ç­¾æ˜¯ä»»æ„çš„é”®å€¼å¯¹ï¼Œç”¨æˆ·å¯ä»¥å¯¹ç³»ç»Ÿçš„ä»»ä½•å¯¹è±¡æ‰“ä¸Šæ ‡ç­¾ã€‚Borgä½œä¸šå¯ä»¥ç­‰æ•ˆåœ°é€šè¿‡å¯¹ä¸€ç»„Podæ‰“ä¸Š $\\langle$ä½œä¸šï¼šä½œä¸šå$\\rangle$ è¿™æ ·çš„æ ‡ç­¾æ¥å®ç°ã€‚å…¶å®ƒæœ‰ç”¨çš„åˆ†ç»„æ–¹å¼ä¹Ÿå¯ä»¥ç”¨æ ‡ç­¾æ¥è¡¨ç¤ºï¼Œä¾‹å¦‚æœåŠ¡ã€å±‚çº§ã€å‘å¸ƒç±»å‹ï¼ˆå¦‚ï¼Œç”Ÿäº§ã€å°±ç»ªã€æµ‹è¯•ï¼‰ã€‚Kubernetesç”¨æ ‡ç­¾æŸ¥è¯¢çš„æ–¹å¼æ¥é€‰å–å¾…æ“ä½œçš„ç›®æ ‡å¯¹è±¡ã€‚è¿™æ ·å°±æ¯”å›ºå®šçš„ä½œä¸šåˆ†ç»„æ›´åŠ çµæ´»ã€‚ åŒä¸€å°æœºå™¨çš„ä»»åŠ¡å…±ç”¨ä¸€ä¸ªIPå¤ªå¤æ‚äº† Borgä¸­ï¼ŒåŒä¸€å°æœºå™¨ä¸Šçš„æ‰€æœ‰ä»»åŠ¡éƒ½ä½¿ç”¨ä¸»æœºçš„åŒä¸€ä¸ªIPåœ°å€ï¼Œå…±äº«ç«¯å£ç©ºé—´ã€‚è¿™å°±å¸¦æ¥å‡ ä¸ªéº»çƒ¦ï¼šBorgå¿…é¡»æŠŠç«¯å£å½“åšèµ„æºæ¥è°ƒåº¦ï¼›ä»»åŠ¡å¿…é¡»å…ˆå£°æ˜å®ƒéœ€è¦å¤šå°‘ç«¯å£ï¼Œè€Œä¸”éœ€è¦æ”¯æŒå¯åŠ¨æ—¶ä¼ å…¥å¯ç”¨ç«¯å£å·ï¼›Borgletå¿…é¡»å¼ºåˆ¶ç«¯å£éš”ç¦»ï¼›åŸŸåå’ŒRPCç³»ç»Ÿå¿…é¡»åƒIPä¸€æ ·å¤„ç†ç«¯å£ã€‚ å¤šäºäº†Linuxçš„namespaceã€è™šæ‹Ÿæœºã€IPv6å’Œè½¯ä»¶å®šä¹‰ç½‘ç»œSDNçš„å‡ºç°ï¼ŒKuberneteså¯ä»¥ç”¨ä¸€ç§æ›´ç”¨æˆ·å‹å¥½çš„æ–¹å¼æ¥æ¶ˆé™¤è¿™äº›å¤æ‚æ€§ï¼šæ¯ä¸ªPodå’ŒServiceéƒ½è‡ªå·±çš„IPåœ°å€ï¼Œå…è®¸å¼€å‘è€…é€‰æ‹©ç«¯å£ï¼Œè€Œä¸æ˜¯è®©ä»–ä»¬çš„è½¯ä»¶æ”¯æŒä»åŸºç¡€è®¾æ–½è·å¾—åˆ†é…ï¼Œè¿™ä¹Ÿæ¶ˆé™¤äº†åŸºç¡€è®¾æ–½ç®¡ç†ç«¯å£çš„å¤æ‚æ€§ã€‚ ç»™èµ„æ·±ç”¨æˆ·ä¼˜åŒ–è€Œå¿½ç•¥äº†åˆçº§ç”¨æˆ· Borgæä¾›äº†ä¸€å¤§å †é’ˆå¯¹â€œèµ„æ·±ç”¨æˆ·â€çš„ç‰¹æ€§ï¼Œè¿™æ ·ä»–ä»¬å°±å¯ä»¥ä»”ç»†åœ°è°ƒèŠ‚ä»–ä»¬ç¨‹åºçš„è¿è¡Œæ–¹å¼ï¼ˆBCLè§„èŒƒçº¦æœ‰230ä¸ªå‚æ•°ï¼‰ï¼šå¼€å§‹çš„ç›®çš„æ˜¯ä¸ºäº†æ”¯æŒGoogleçš„å¤§å‹èµ„æºç”¨æˆ·ï¼Œæå‡ä»–ä»¬çš„æ•ˆç‡ä¼šå¸¦æ¥æ˜¾è‘—çš„æ•ˆç›Šã€‚ä½†ä¸å¹¸çš„æ˜¯ï¼Œè¿™ä¹ˆå¤æ‚çš„APIè®©åˆçº§ç”¨æˆ·ç”¨èµ·æ¥å¾ˆå¤æ‚ï¼Œè€Œä¸”é™åˆ¶äº†APIçš„æ¼”è¿›ã€‚æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆæ˜¯åœ¨Borgä¸Šåˆåšäº†ä¸€äº›è‡ªåŠ¨åŒ–çš„å·¥å…·å’ŒæœåŠ¡ï¼Œä»å®éªŒä¸­å†³å®šåˆç†çš„é…ç½®ã€‚ç”±äºåº”ç”¨æ”¯æŒå®¹é”™ï¼Œå®éªŒå¯ä»¥è‡ªç”±è¿›è¡Œï¼šå³ä½¿è‡ªåŠ¨åŒ–å‡ºäº†é—®é¢˜ï¼Œä¹Ÿåªæ˜¯å°éº»çƒ¦ï¼Œä¸ä¼šå¯¼è‡´ç¾éš¾ã€‚ ","date":"2022-05-31","objectID":"/posts/brog-in-google/:8:1","tags":["è½¬è½½","brog","cluster"],"title":"[è¯‘]ä½¿ç”¨Borgåœ¨Googleç®¡ç†å¤§è§„æ¨¡é›†ç¾¤","uri":"/posts/brog-in-google/"},{"categories":["k8s"],"content":"8.2 ç»éªŒ å¦ä¸€æ–¹é¢ï¼Œæœ‰ä¸å°‘Borgçš„è®¾è®¡ç‰¹æ€§æ˜¯éå¸¸æœ‰ç›Šçš„ï¼Œè€Œä¸”ç»å†äº†æ—¶é—´è€ƒéªŒã€‚ Allocæ˜¯æœ‰ç”¨çš„ Borgçš„AllocæŠ½è±¡é€‚ç”¨äºå¹¿æ³›ä½¿ç”¨çš„ä¿å­˜æ—¥å¿—æ¨¡å¼ï¼ˆÂ§2.4ï¼‰ï¼Œå¦ä¸€ä¸ªæµè¡Œçš„æ¨¡å¼æ˜¯ï¼šä¸€ä¸ªç®€å•çš„æ•°æ®åŠ è½½ä»»åŠ¡å®šæœŸæ›´æ–°WebæœåŠ¡å™¨ä½¿ç”¨çš„æ•°æ®ã€‚Allocå’Œè½¯ä»¶åŒ…æœºåˆ¶å…è®¸è¿™äº›è¾…åŠ©æœåŠ¡ç”±ä¸åŒçš„å°ç»„å¼€å‘ã€‚Kuberneteså¯¹åº”äºAllocçš„æ¦‚å¿µæ˜¯Podï¼Œå®ƒæ˜¯å¯¹ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨çš„èµ„æºå°è£…ï¼Œå…¶ä¸­çš„å®¹å™¨å…±äº«Podçš„èµ„æºï¼Œè€Œä¸”æ€»æ˜¯è¢«è°ƒåº¦åˆ°åŒä¸€å°æœºå™¨ä¸Šã€‚Kubernetesä½¿ç”¨Podé‡Œçš„è¾…åŠ©å®¹å™¨æ¥æ›¿ä»£Allocé‡Œé¢çš„ä»»åŠ¡ï¼Œä¸è¿‡æ€è·¯æ˜¯ä¸€æ ·çš„ã€‚ é›†ç¾¤ç®¡ç†ä¸åªæ˜¯ä»»åŠ¡ç®¡ç† è™½ç„¶Borgçš„ä¸»è¦è§’è‰²æ˜¯ç®¡ç†ä»»åŠ¡å’Œæœºå™¨çš„ç”Ÿå‘½å‘¨æœŸï¼Œä½†Borgä¸Šçš„åº”ç”¨è¿˜ä»å…¶å®ƒçš„é›†ç¾¤æœåŠ¡ä¸­æ”¶ç›Šè‰¯å¤šï¼Œä¾‹å¦‚åŸŸåæœåŠ¡å’Œè´Ÿè½½å‡è¡¡ã€‚Kubernetesç”¨Serviceè¿™ä¸ªæŠ½è±¡æ¦‚å¿µæ¥æ”¯æŒåŸŸåæœåŠ¡å’Œè´Ÿè½½å‡è¡¡ï¼šServiceæœ‰ä¸€ä¸ªåŸŸåå’Œç”¨æ ‡ç­¾é€‰å‡ºçš„å¤šä¸ªPodçš„åŠ¨æ€é›†åˆã€‚é›†ç¾¤ä¸­çš„ä»»ä½•å®¹å™¨éƒ½å¯ä»¥é€šè¿‡ServiceåŸŸåè¿æ¥åˆ°è¯¥æœåŠ¡ã€‚å¹•åï¼ŒKubernetesè‡ªåŠ¨å°†è¿æ¥åˆ°è¯¥Serviceçš„è´Ÿè½½åˆ†æ•£åˆ°ä¸å…¶æ ‡ç­¾åŒ¹é…çš„Podä¹‹é—´ï¼Œç”±äºPodæŒ‚æ‰åä¼šè¢«é‡æ–°è°ƒåº¦åˆ°å…¶å®ƒæœºå™¨ä¸Šï¼ŒKubernetesè¿˜ä¼šè·Ÿè¸ªè¿™äº›Podçš„ä½ç½®ã€‚ è‡ªçœæ˜¯è‡³å…³é‡è¦çš„ è™½ç„¶Borgæ€»ä½“ä¸Šæ˜¯å·¥ä½œè‰¯å¥½çš„ï¼Œä½†å‡ºäº†é—®é¢˜åï¼Œå®šä½æ ¹æœ¬åŸå› æ˜¯éå¸¸æœ‰æŒ‘æˆ˜æ€§çš„ã€‚Borgçš„ä¸€ä¸ªå…³é”®è®¾è®¡é€‰æ‹©æ˜¯æŠŠæ‰€æœ‰çš„è°ƒè¯•ä¿¡æ¯æš´éœ²ç»™ç”¨æˆ·è€Œä¸æ˜¯éšè—èµ·æ¥ï¼šBorgæœ‰å‡ åƒä¸ªç”¨æˆ·ï¼Œæ‰€ä»¥â€œè‡ªåŠ©â€æ˜¯è°ƒè¯•çš„ç¬¬ä¸€æ­¥ã€‚è™½ç„¶ä¸€äº›ç”¨æˆ·çš„ä¾èµ–é¡¹è®©æˆ‘ä»¬éš¾ä»¥åºŸå¼ƒä¸€äº›ç‰¹æ€§æˆ–ä¿®æ”¹å†…éƒ¨ç­–ç•¥ï¼Œä½†è¿™è¿˜æ˜¯æˆåŠŸçš„ï¼Œæˆ‘ä»¬è¿˜æ²¡æ‰¾åˆ°å…¶å®ƒå®é™…çš„æ›¿ä»£æ–¹å¼ã€‚ä¸ºç®¡ç†å¤§é‡çš„æ•°æ®ï¼Œæˆ‘ä»¬æä¾›äº†å¤šä¸ªå±‚æ¬¡çš„UIå’Œè°ƒè¯•å·¥å…·ï¼Œè¿™æ ·ç”¨æˆ·å°±å¯ä»¥å¿«é€Ÿå®šä½ä¸å…¶ä½œä¸šç›¸å…³çš„å¼‚å¸¸äº‹ä»¶ï¼Œæ·±å…¥æŒ–æ˜æ¥è‡ªå…¶åº”ç”¨å’ŒåŸºç¡€è®¾æ–½æœ¬èº«çš„è¯¦ç»†äº‹ä»¶å’Œé”™è¯¯æ—¥å¿—ã€‚ Kubernetesä¹Ÿè®¡åˆ’å¼•å…¥Borgçš„å¤§éƒ¨åˆ†è‡ªçœæŠ€æœ¯ã€‚å’ŒKubernetesä¸€èµ·å‘å¸ƒäº†å¾ˆå¤šå·¥å…·ï¼Œæ¯”å¦‚ç”¨äºèµ„æºç›‘æ§çš„cAdvisor[15]ï¼Œå®ƒåŸºäºElasticsearch/Kibana[30]å’ŒFluentd[32]èšåˆæ—¥å¿—ã€‚Masterå¯ä»¥ç”¨æ¥æŸ¥è¯¢æŸä¸ªå¯¹è±¡çš„çŠ¶æ€å¿«ç…§ã€‚Kubernetesæä¾›äº†ä¸€è‡´æœºåˆ¶ï¼Œæ‰€æœ‰å¯ä»¥è®°å½•äº‹ä»¶çš„ç»„ä»¶ï¼ˆä¾‹å¦‚ï¼Œè¢«è°ƒåº¦çš„Podã€å‡ºé”™çš„å®¹å™¨ï¼‰éƒ½å¯ä»¥è¢«å®¢æˆ·ç«¯è®¿é—®ã€‚ Masteræ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ ¸å¿ƒ Borgmasteræœ€åˆè®¾è®¡ä¸ºä¸€ä¸ªå•ä½“çš„ç³»ç»Ÿï¼Œéšç€æ—¶é—´å‘å±•ï¼Œå®ƒæ¼”å˜æˆäº†ä¸€ç»„æœåŠ¡ç”Ÿæ€ç³»ç»Ÿçš„æ ¸å¿ƒã€‚ç”¨æˆ·ä½œä¸šç®¡ç†çš„ç®¡ç†æ˜¯ç”±è¿™äº›æœåŠ¡ååŒå®Œæˆçš„ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬æŠŠè°ƒåº¦å™¨å’Œä¸»è¦çš„UIï¼ˆSigmaï¼‰åˆ†ç¦»æˆå•ç‹¬çš„è¿›ç¨‹ï¼Œå¢åŠ äº†ä¸€ç»„æœåŠ¡ï¼ŒåŒ…æ‹¬å‡†å…¥æ§åˆ¶ã€çºµå‘å’Œæ¨ªå‘æ‰©å±•ã€ä»»åŠ¡é‡æ–°è£…ç®±ã€å‘¨æœŸæ€§ä½œä¸šæäº¤ï¼ˆcronï¼‰ã€å·¥ä½œæµç®¡ç†ï¼Œç”¨äºç¦»çº¿æŸ¥è¯¢çš„ç³»ç»Ÿæ´»åŠ¨å½’æ¡£ç­‰ã€‚æ€»ä½“è€Œè¨€ï¼Œè¿™è®©æˆ‘ä»¬èƒ½æ‰©å±•å·¥ä½œè´Ÿè½½å’Œç‰¹æ€§é›†åˆï¼Œä½†æ— éœ€ç‰ºç‰²æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§ã€‚ Kubernetesçš„æ¶æ„èµ°çš„æ›´è¿œä¸€äº›ï¼šå®ƒçš„æ ¸å¿ƒæ˜¯ä¸€ä¸ªä»…å¤„ç†è¯·æ±‚å’Œæ“ä½œåº•å±‚çŠ¶æ€ç›®æ ‡çš„APIæœåŠ¡ã€‚é›†ç¾¤ç®¡ç†é€»è¾‘æ„å»ºä¸ºä¸€ä¸ªå°å‹çš„ã€å¯ç»„åˆçš„å¾®æœåŠ¡ï¼Œä½œä¸ºAPIæœåŠ¡çš„å®¢æˆ·ç«¯ï¼Œå¦‚æ•…éšœåä»ç»´æŒPodå‰¯æœ¬ä¸ªæ•°åœ¨æœŸæœ›å€¼çš„å‰¯æœ¬ç®¡ç†å™¨ï¼Œä»¥åŠç®¡ç†æœºå™¨ç”Ÿå‘½å‘¨æœŸçš„èŠ‚ç‚¹ç®¡ç†å™¨ã€‚ ","date":"2022-05-31","objectID":"/posts/brog-in-google/:8:2","tags":["è½¬è½½","brog","cluster"],"title":"[è¯‘]ä½¿ç”¨Borgåœ¨Googleç®¡ç†å¤§è§„æ¨¡é›†ç¾¤","uri":"/posts/brog-in-google/"},{"categories":["k8s"],"content":"8.3 æ€»ç»“ åœ¨è¿‡å»åå¹´é—´ï¼Œæ‰€æœ‰å‡ ä¹æ‰€æœ‰çš„Googleé›†ç¾¤è´Ÿè½½éƒ½è¿ç§»åˆ°äº†Borgä¸Šã€‚æˆ‘ä»¬ä»åœ¨æŒç»­æ”¹è¿›å®ƒï¼Œå¹¶æŠŠç»éªŒåº”ç”¨åˆ°äº†Kubernetesä¸Šã€‚ ","date":"2022-05-31","objectID":"/posts/brog-in-google/:8:3","tags":["è½¬è½½","brog","cluster"],"title":"[è¯‘]ä½¿ç”¨Borgåœ¨Googleç®¡ç†å¤§è§„æ¨¡é›†ç¾¤","uri":"/posts/brog-in-google/"},{"categories":["k8s"],"content":"è‡´è°¢ è¿™ç¯‡æ–‡ç« çš„ä½œè€…è´Ÿè´£æ’°å†™æ–‡ç« ï¼Œå¹¶å®Œæˆäº†è¯„ä¼°å®éªŒã€‚å‡ åä½è®¾è®¡ã€å®ç°å’Œç»´æŠ¤Borgç»„ä»¶å’Œç”Ÿæ€ç³»ç»Ÿçš„å·¥ç¨‹å¸ˆæ‰æ˜¯å®ƒæˆåŠŸçš„å…³é”®ã€‚æˆ‘ä»¬åœ¨è¿™é‡Œåˆ—å‡ºç›´æ¥å‚ä¸è®¾è®¡ã€å®ç°å’Œç»´æŠ¤BorgmasteråŠBorgletçš„äººå‘˜ã€‚å¦‚æœæœ‰é—æ¼ï¼Œæˆ‘ä»¬æ·±è¡¨æ­‰æ„ã€‚ æ—©æœŸç‰ˆæœ¬çš„Borgmasterè®¾è®¡å’Œå®ç°äººå‘˜æœ‰ï¼šJeremy Dionå’ŒMark Vandevoordeï¼Œä»¥åŠBen Smith, Ken Ashcraft, Maricia Scott, Ming-Yee Iu å’Œ Monika Henzingerã€‚æ—©æœŸç‰ˆæœ¬çš„Borgletä¸»è¦æ˜¯ç”±Paul Menageè®¾è®¡å’Œå®ç°çš„ã€‚ åç»­çš„å‚ä¸è€…åŒ…æ‹¬ï¼šAbhishek Rai, Abhishek Verma, Andy Zheng, Ashwin Kumar, Beng-Hong Lim, Bin Zhang, Bolu Szewczyk, Brian Budge, Brian Grant, Brian Wickman, Chengdu Huang, Cynthia Wong, Daniel Smith, Dave Bort, David Oppenheimer, David Wall, Dawn Chen, Eric Haugen, Eric Tune, Ethan Solomita, Gaurav Dhiman, Geeta Chaudhry, Greg Roelofs, Grzegorz Czajkowski, James Eady, Jarek Kusmierek, Jaroslaw Przybylowicz, Jason Hickey, Javier Kohen, Jeremy Lau, Jerzy Szczepkowski, John Wilkes, Jonathan Wilson, Joso Eterovic, Jutta Degener, Kai Backman, Kamil Yurtsever, Kenji Kaneda, Kevan Miller, Kurt Steinkraus, Leo Landa, Liza Fireman, Madhukar Korupolu, Mark Logan, Markus Gutschke, Matt Sparks, Maya Haridasan, Michael Abd-El-Malek, Michael Kenniston, Mukesh Kumar, Nate Calvin, Onufry Wojtaszczyk, Patrick Johnson, Pedro Valenzuela, Piotr Witusowski, Praveen Kallakuri, Rafal Sokolowski, Richard Gooch, Rishi Gosalia, Rob Radez, Robert Hagmann, Robert Jardine, Robert Kennedy, Rohit Jnagal, Roy Bryant, Rune Dahl, Scott Garriss, Scott Johnson, Sean Howarth, Sheena Madan, Smeeta Jalan, Stan Chesnutt, Temo Arobelidze, Tim Hockin, Todd Wang, Tomasz Blaszczyk, Tomasz Wozniak, Tomek Zielonka, Victor Marmol, Vish Kannan, Vrigo Gokhale, Walfredo Cirne, Walt Drummond, Weiran Liu, Xiaopan Zhang, Xiao Zhang, Ye Zhao, Zohaib Maya. Borg SREå›¢é˜Ÿä¹Ÿæ˜¯éå¸¸é‡è¦çš„ï¼ŒåŒ…æ‹¬ï¼šAdam Rogoyski, Alex Milivojevic, Anil Das, Cody Smith, Cooper Bethea, Folke Behrens, Matt Liggett, James Sanford, John Millikin, Matt Brown, Miki Habryn, Peter Dahl, Robert van Gent, Seppi Wilhelmi, Seth Hettich, Torsten Marek, å’Œ Viraj Alankarã€‚Borgé…ç½®è¯­è¨€ï¼ˆBCLï¼‰å’Œborgcfgå·¥å…·æœ€åˆæ˜¯Marcel van Lohuizen å’Œ Robert Griesemerå¼€å‘çš„ã€‚ æˆ‘ä»¬ä¸å°å¿ƒæ¼æ‰äº† Brad Strand, Chris Colohan, Divyesh Shah, Eric Wilcox, å’Œ Pavanish Nirulaã€‚ è°¢è°¢æˆ‘ä»¬çš„å®¡ç¨¿äººï¼ˆå°¤å…¶æ˜¯Eric Brewer, Malte Schwarzkopf å’Œ Tom Rodehefferï¼‰ï¼Œä»¥åŠæˆ‘ä»¬çš„å¯¼å¸ˆChristos Kozyrakisï¼Œå¯¹è¿™ç¯‡è®ºæ–‡çš„åé¦ˆã€‚ ","date":"2022-05-31","objectID":"/posts/brog-in-google/:9:0","tags":["è½¬è½½","brog","cluster"],"title":"[è¯‘]ä½¿ç”¨Borgåœ¨Googleç®¡ç†å¤§è§„æ¨¡é›†ç¾¤","uri":"/posts/brog-in-google/"},{"categories":["k8s"],"content":"å‹˜è¯¯ 2015-04-23 å®šç¨¿åï¼Œæˆ‘ä»¬å‘ç°äº†è‹¥å¹²æ— æ„çš„ç–æ¼å’Œæ­§ä¹‰ã€‚ è¯‘æ³¨ï¼šè¯‘æ–‡å·²å°†å‹˜è¯¯å†…å®¹æ”¾ç½®åˆ°å¯¹åº”ç« èŠ‚ã€‚è¡¥å……çš„2æ¡å‚è€ƒæ–‡çŒ®ä¸å·²æœ‰åºå·å†²çªï¼Œæ•…æ”¾åœ¨äº†åˆ—è¡¨ä¹‹åï¼Œå¹¶ç»§ç»­ç¼–å·ä¸º85ï¼Œ86ã€‚ ","date":"2022-05-31","objectID":"/posts/brog-in-google/:10:0","tags":["è½¬è½½","brog","cluster"],"title":"[è¯‘]ä½¿ç”¨Borgåœ¨Googleç®¡ç†å¤§è§„æ¨¡é›†ç¾¤","uri":"/posts/brog-in-google/"},{"categories":["k8s"],"content":"å‚è€ƒæ–‡çŒ® O. A. Abdul-Rahman and K. Aida. Towards understanding the usage behavior of Google cloud users: the mice and elephants phenomenon. In Proc. IEEE Int'l Conf. on Cloud Computing Technology and Science (CloudCom), pages 272â€“277, Singapore, Dec. 2014. Adaptive Computing Enterprises Inc., Provo, UT. Maui Scheduler Administrator's Guide, 3.2 edition, 2011. T. Akidau, A. Balikov, K. BekiroÄŸlu, S. Chernyak, J. Haberman, R. Lax, S. McVeety, D. Mills, P. Nordstrom,and S. Whittle. MillWheel: fault-tolerant stream processing at internet scale, In Proc. Int'l Conf. on Very Large Data Bases (VLDB), pages 734â€“746, Riva del Garda, Italy, Aug.2013. Y. Amir, B. Awerbuch, A. Barak, R. S. Borgstrom, and A. Keren. An opportunity cost approach for job assignment in a scalable computing cluster, IEEE Trans. Parallel Distrib.Syst., 11(7):760â€“768, July 2000. Apache Aurora. http://aurora.incubator.apache.org/, 2014. Aurora Configuration Tutorial. https://aurora.incubator.apache.org/documentation/latest/configuration-tutorial/, 2014. AWS. Amazon Web Services VM Instances. http://aws.amazon.com/ec2/instance-types/, 2014. J. Baker, C. Bond, J. Corbett, J. Furman, A. Khorlin, J. Larson, J.-M. Leon, Y. Li, A. Lloyd, and V. Yushprakh. Megastore: Providing scalable, highly available storage for interactive services, In Proc. Conference on Innovative Data Systems Research (CIDR), pages 223â€“234, Asilomar, CA, USA, Jan. 2011. M. Baker and J. Ousterhout. Availability in the Sprite distributed file system, Operating Systems Review,25(2):95â€“98, Apr. 1991. L. A. Barroso, J. Clidaras, and U. HÃ¶lzle. The datacenter as a computer: an introduction to the design of warehouse-scale machines, Morgan Claypool Publishers, 2nd edition, 2013. L. A. Barroso, J. Dean, and U. Holzle. Web search for a planet: the Google cluster architecture, In IEEE Micro, pages 22â€“28, 2003. I. Bokharouss. GCL Viewer: a study in improving the understanding of GCL programs, Technical report, Eindhoven Univ. of Technology, 2008. MS thesis. E. Boutin, J. Ekanayake, W. Lin, B. Shi, J. Zhou, Z. Qian, M. Wu, and L. Zhou. Apollo: scalable and coordinated scheduling for cloud-scale computing, In Proc. USENIX Symp. on Operating Systems Design and Implementation (OSDI), Oct. 2014. M. Burrows. The Chubby lock service for loosely-coupled distributed systems, In Proc. USENIX Symp. on Operating Systems Design and Implementation (OSDI), pages 335â€“350,Seattle, WA, USA, 2006. cAdvisor. https://github.com/google/cadvisor, 2014 CFS per-entity load patches. http://lwn.net/Articles/531853, 2013. cgroups. http://en.wikipedia.org/wiki/Cgroups, 2014. C. Chambers, A. Raniwala, F. Perry, S. Adams, R. R. Henry, R. Bradshaw, and N. Weizenbaum. FlumeJava: easy, efficient data-parallel pipelines, In Proc. ACM SIGPLAN Conf. on Programming Language Design and Implementation (PLDI), pages 363â€“375, Toronto, Ontario, Canada, 2010. F. Chang, J. Dean, S. Ghemawat, W. C. Hsieh, D. A. Wallach, M. Burrows, T. Chandra, A. Fikes, and R. E. Gruber. Bigtable: a distributed storage system for structured data, ACM Trans. on Computer Systems, 26(2):4:1â€“4:26, June 2008. Y. Chen, S. Alspaugh, and R. H. Katz. Design insights for MapReduce from diverse production workloads, Technical Report UCB/EECSâ€“2012â€“17, UC Berkeley, Jan. 2012. C. Curino, D. E. Difallah, C. Douglas, S. Krishnan, R. Ramakrishnan, and S. Rao. Reservation-based scheduling: if you're late don't blame us! In Proc. ACM Symp. on Cloud Computing (SoCC), pages 2:1â€“2:14, Seattle, WA, USA, 2014. J. Dean and L. A. Barroso. The tail at scale, Communications of the ACM, 56(2):74â€“80, Feb. 2012. J. Dean and S. Ghemawat. MapReduce: simplified data processing on large clusters, Communications of the ACM, 51(1):107â€“113, 2008. C. Delimitrou and C. Kozyrakis. Paragon: QoS-aware scheduling for heterogeneous datacenters, In Proc. Int'l Conf. on Architectural Support for Programming Languages and Operating Systems (ASPLOS), Mar. 201. C. Delimitrou and C. Kozyrakis. Quasar: resource-efficient and","date":"2022-05-31","objectID":"/posts/brog-in-google/:11:0","tags":["è½¬è½½","brog","cluster"],"title":"[è¯‘]ä½¿ç”¨Borgåœ¨Googleç®¡ç†å¤§è§„æ¨¡é›†ç¾¤","uri":"/posts/brog-in-google/"},{"categories":["microservice"],"content":" æœ¬æ–‡ä¸ºç³»åˆ—ç¯‡å¾®æœåŠ¡çš„ç¬¬ä¸€ç¯‡ï¼Œå°†ä¼šä»‹ç»ä»€ä¹ˆæ˜¯å¾®æœåŠ¡ã€ä¸ºä»€ä¹ˆæ˜¯å¾®æœåŠ¡ã€å¾®æœåŠ¡çš„æ ¸å¿ƒç†å¿µå’Œç›¸å…³å‘¨è¾¹ç»„ä»¶çš„ä»‹ç»ã€‚ ","date":"2022-05-14","objectID":"/posts/what-is-microservices/:0:0","tags":["å¾®æœåŠ¡","ç³»åˆ—ç¯‡"],"title":"[ç³»åˆ—]å¾®æœåŠ¡Â·ä»€ä¹ˆæ˜¯å¾®æœåŠ¡","uri":"/posts/what-is-microservices/"},{"categories":["microservice"],"content":"1. ä»€ä¹ˆæ˜¯å¾®æœåŠ¡ aws å…³äºå¾®æœåŠ¡çš„è§£é‡Š å¾®æœåŠ¡æ˜¯ä¸€ç§å¼€å‘è½¯ä»¶çš„æ¶æ„å’Œç»„ç»‡æ–¹æ³•ï¼Œå…¶ä¸­è½¯ä»¶ç”±é€šè¿‡æ˜ç¡®å®šä¹‰çš„ API è¿›è¡Œé€šä¿¡çš„å°å‹ç‹¬ç«‹æœåŠ¡ç»„æˆã€‚è¿™äº›æœåŠ¡ç”±å„ä¸ªå°å‹ç‹¬ç«‹å›¢é˜Ÿè´Ÿè´£ã€‚ å¾®æœåŠ¡æ¶æ„ä½¿åº”ç”¨ç¨‹åºæ›´æ˜“äºæ‰©å±•å’Œæ›´å¿«åœ°å¼€å‘ï¼Œä»è€ŒåŠ é€Ÿåˆ›æ–°å¹¶ç¼©çŸ­æ–°åŠŸèƒ½çš„ä¸Šå¸‚æ—¶é—´ã€‚ å¾®æœåŠ¡å¹¶éæ˜¯ä¸€ä¸ªå…¨æ–°çš„æŠ€æœ¯è€Œæ˜¯è·Ÿéšç€äº’è”ç½‘æŠ€æœ¯çš„å‘å±•çš„ä¸€ä¸ªæœåŠ¡éƒ¨ç½²æ¶æ„æ–¹æ¡ˆã€‚ä¸å¾®æœåŠ¡ç›¸å¯¹çš„ä¾¿æ˜¯ä¼ ç»Ÿå·¨çŸ³æ¶æ„(æ•´ä½“æ¶æ„)ã€‚å¯ä»¥ç†è§£ä¸ºå¾®æœåŠ¡çš„å‡ºç°è§£å†³äº†å·¨çŸ³æ¶æ„çš„å¤§éƒ¨åˆ†çš„é—®é¢˜ï¼Œå› æ­¤å¾®æœåŠ¡è¿™ä¸ªæ¦‚å¿µä¹Ÿè¢«å¤§éƒ¨åˆ†çš„å¼€å‘è€…æ‰€ç†Ÿæ‚‰ã€‚ å¾®æœåŠ¡æ¶æ„ ä¸‹é¢æˆ‘ä»¬é€šè¿‡å¯¹æ¯”å¾®æœåŠ¡å’Œå·¨çŸ³æ¶æ„çš„æ–¹å¼å¯¹å¾®æœåŠ¡è¿›è¡Œäº†è§£ã€‚ ","date":"2022-05-14","objectID":"/posts/what-is-microservices/:1:0","tags":["å¾®æœåŠ¡","ç³»åˆ—ç¯‡"],"title":"[ç³»åˆ—]å¾®æœåŠ¡Â·ä»€ä¹ˆæ˜¯å¾®æœåŠ¡","uri":"/posts/what-is-microservices/"},{"categories":["microservice"],"content":"1.1 å·¨çŸ³æ¶æ„ å·¨çŸ³æ¶æ„åˆåä¸ºæ•´ä½“æ¶æ„ï¼Œåœ¨ä»¥å¾€äº’è”ç½‘åº”ç”¨å¼€å‘è¿‡ç¨‹ä¸€ç›´æ˜¯å¤§å®¶é»˜è®¤çš„ä¸€ç§æ¶æ„æ–¹æ¡ˆã€‚å°†æ‰€æœ‰çš„åŠŸèƒ½èƒ½åŠ›éƒ½åœ¨ä¸€ä¸ªé¡¹ç›®å†…å®ç°ï¼Œç”šè‡³åŒ…æ‹¬å‰ç«¯é¡µé¢çš„ä»£ç ã€‚ è¿™ç§æ–¹å¼å¯¹äºå¿«é€Ÿå‘å±•çš„ä¸šåŠ¡æ¥è¯´éå¸¸é€‚åˆçš„ï¼Œä¸ç®¡å¤ªå¤šçš„ä»£ç è§„èŒƒæ¶æ„è§„èŒƒï¼ŒåŠŸèƒ½å¿«é€Ÿå®ç°å¿«é€Ÿä¸Šçº¿ä½œä¸ºç¬¬ä¸€ç›®æ ‡ï¼Œä»è€Œè¡ç”Ÿå‡ºäº†å¾ˆå¤šä¸€é”®ç”Ÿæˆé¡¹ç›®çš„å„ç±»æ¡†æ¶æ¨¡æ¿ï¼Œåªæ˜¯ä¸ºäº†æ›´å¿«é€Ÿçš„å®Œæˆé¡¹ç›®çš„è¿­ä»£ã€‚ è¿™ç§æ¶æ„çš„ä¼˜ç‚¹æ˜¯å¿«é€Ÿè¿­ä»£ã€ä»£ç ç›¸å¯¹èšåˆã€å›¢é˜Ÿå†…æ‰€æœ‰äººåªç»´æŠ¤ä¸€ä¸ªä»“åº“å³å¯ã€‚ä½†æ˜¯å…¶ç¼ºç‚¹ä¹Ÿæ¯”è¾ƒæ˜æ˜¾ï¼Œé¦–å…ˆéšç€ä»£ç çš„å¢é•¿ç»´æŠ¤ä»“åº“çš„æˆæœ¬è¶Šæ¥è¶Šé«˜ä»è€Œæ–°å¢ã€ä¿®æ”¹æ–°åŠŸèƒ½å˜å¾—è¶Šæ¥è¶Šéº»çƒ¦ã€‚ä¸ä»…ä»…æ˜¯å¼€å‘åŒå­¦çš„å·¥ä½œé‡å˜å¤šå˜å¤æ‚ï¼ŒQA åŒå­¦çš„å·¥ä½œä¹Ÿä¼šè¶Šæ¥è¶Šå¤æ‚ã€‚ä»…ä»…ä¸€ä¸ªå°åŠŸèƒ½çš„æ·»åŠ ï¼Œç”±äºæ˜¯ä¸€ä¸ªæ•´ä½“çš„å¤§é¡¹ç›®ï¼ŒåŠŸèƒ½æµ‹è¯•å›å½’æµ‹è¯•éƒ½å˜å¾—å¼‚å¸¸æ£˜æ‰‹ã€‚é€æ¸çš„é¡¹ç›®çš„å¿«é€Ÿè¿­ä»£çš„ä¼˜ç‚¹å°±æ²¡æœ‰äº†ï¼Œè¿­ä»£é€Ÿåº¦ä¼šè¶Šæ¥è¶Šæ…¢ã€‚ å…¶æ¬¡æ˜¯é¡¹ç›®ä¸­å±€éƒ¨å‡çº§å‡ ä¹å˜å¾—ä¸å¯èƒ½äº†ï¼Œä¾‹å¦‚ä¾èµ–çš„åŒ…ã€åº•å±‚æ•°æ®åº“ã€MQ çš„åˆ‡æ¢ç­‰ç­‰ï¼Œå¾ˆéš¾ç¡®ä¿è¿™äº›ç»„ä»¶ä¸ä¸ä¸šåŠ¡é€»è¾‘ä»£ç æ²¡æœ‰å…³è”ã€‚å³ä¾¿æ˜¯å‡çº§ä¸€äº›ç¬¬ä¸‰æ–¹çš„åŒ…ï¼Œä¹Ÿéœ€è¦è€ƒè™‘æ‰€æœ‰å¼•ç”¨çš„åœ°å„¿ï¼Œå‡çº§äº†ä¹Ÿéœ€è¦å¤§é‡çš„å›å½’æµ‹è¯•ã€‚ ç„¶åæ˜¯ä»£ç  debug å˜å¾—å¼‚å¸¸éº»çƒ¦ã€‚å·¨çŸ³æ¶æ„å†…è™½è¯´åŒ…å«äº†æ‰€æœ‰çš„ä»£ç æ— éœ€è·³è½¬é¡¹ç›®çš„ debugï¼Œä½†æ˜¯ç”±äºéƒ½æ˜¯ç›´æ¥è°ƒç”¨ä»£ç å†…çš„æ–¹æ³•ï¼Œå¾ˆéš¾åšåˆ°æ—¥å¿—å’Œé“¾è·¯è¿½è¸ªï¼Œçº¿ä¸Šå‡ºæ•…éšœçš„è¯åªèƒ½ç¡¬ç€å¤´çš®åœ¨å¤§é‡æ—¥å¿—ä¸­æ‰¾ç›¸å…³æ—¥å¿—ã€‚ ç„¶åæ˜¯éƒ¨ç½²æ–¹å¼æ¯”è¾ƒæ­»æ¿ï¼Œç”±äºæœ€åæ‰“åŒ…å‡ºæ¥çš„è¿›ç¨‹åŒ…å«äº†æ‰€æœ‰çš„èƒ½åŠ›ï¼Œéƒ¨ç½²ä¹‹åå¾ˆéš¾é¢„ä¼°æœåŠ¡çš„è¯·æ±‚é‡å’Œå‹åŠ›ï¼Œèµ„æºåˆ©ç”¨ç‡ä¼šç›¸å¯¹ä½ã€‚ æœ€åæ˜¯å®¹æ˜“å—è¯­è¨€çš„é™åˆ¶ã€‚æˆ‘è®¤ä¸ºæ²¡æœ‰æ‰€è°“çš„å¥½è¯­è¨€ä¸å¥½çš„è¯­è¨€ï¼Œæ¯ä¸ªè¯­è¨€éƒ½æœ‰å„è‡ªçš„æ“…é•¿å’Œä¸æ“…é•¿çš„é¢†åŸŸã€‚éšç€é¡¹ç›®çš„è¿­ä»£æ€»ä¼šæœ‰ä¸€äº›éœ€æ±‚ï¼Œç”¨é¡¹ç›®çš„ä¸»è¯­è¨€å®ç°é‡åˆ°å¾ˆå¤šçš„å›°éš¾ï¼Œè™½ç„¶æ˜æ™ºæ¢ä¸€ç§è¯­è¨€å¾ˆå¿«èƒ½è§£å†³å½“å‰çš„éœ€æ±‚ï¼Œä½†æ˜¯å·¨çŸ³æ¶æ„ä¸å…è®¸è¿™æ ·çš„æ“ä½œï¼Œä¹Ÿå¾ˆéš¾è¯´ä¸ºäº†è¿™ä¸ªåŠŸèƒ½æ–°å¢ä¸€ä¸ªé¡¹ç›®è¿›è¡Œéƒ¨ç½²ã€‚ æ€»ä½“æ¥è¯´ï¼Œå·¨çŸ³æ¶æ„åœ¨é¡¹ç›®åˆæœŸçš„æ—¶å€™å‡ ä¹ä¸ä¼šå±•ç°å‡ºä»–çš„ç¼ºç‚¹ï¼Œä½†æ˜¯ç»è¿‡ä¸€æ®µæ—¶é—´çš„è¿­ä»£ï¼Œå·¨çŸ³æ¶æ„ä¸‹çš„é¡¹ç›®å°±å¾ˆéš¾è¿›è¡Œå¾ˆå¥½åœ°ç»´æŠ¤äº†ã€‚ ","date":"2022-05-14","objectID":"/posts/what-is-microservices/:1:1","tags":["å¾®æœåŠ¡","ç³»åˆ—ç¯‡"],"title":"[ç³»åˆ—]å¾®æœåŠ¡Â·ä»€ä¹ˆæ˜¯å¾®æœåŠ¡","uri":"/posts/what-is-microservices/"},{"categories":["microservice"],"content":"1.2 å¾®æœåŠ¡æ¶æ„ å·¨çŸ³æ¶æ„ -\u003e å¾®æœåŠ¡æ¶æ„ å¾®æœåŠ¡æ¶æ„æ˜¯ç”±ä¸€ç»„å°å¾®çš„æœåŠ¡çš„ç»„åˆè€Œæˆã€‚è¿™äº›æœåŠ¡ä¹‹å‰é€šè¿‡ rpc çš„æ–¹å¼è¿›è¡Œé€šä¿¡ï¼Œä»è€Œæä¾›ä¸€ä¸ªæ•´ä½“çš„èƒ½åŠ›ã€‚å¾®æœåŠ¡çš„ä¼˜åŠ¿æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š æ•æ·æ€§ï¼šå¾®æœåŠ¡ä¿ƒè¿›è‹¥å¹²å°å‹ç‹¬ç«‹å›¢é˜Ÿå½¢æˆä¸€ä¸ªç»„ç»‡ï¼Œè¿™äº›å›¢é˜Ÿè´Ÿè´£è‡ªå·±çš„æœåŠ¡ã€‚å„å›¢é˜Ÿåœ¨å°å‹ä¸”æ˜“äºç†è§£çš„ç¯å¢ƒä¸­è¡Œäº‹ï¼Œå¹¶ä¸”å¯ä»¥æ›´ç‹¬ç«‹ã€æ›´å¿«é€Ÿåœ°å·¥ä½œã€‚è¿™ç¼©çŸ­äº†å¼€å‘å‘¨æœŸæ—¶é—´ã€‚æ‚¨å¯ä»¥ä»ç»„ç»‡çš„æ€»ååé‡ä¸­æ˜¾è‘—è·ç›Šã€‚ çµæ´»æ‰©å±•ï¼šé€šè¿‡å¾®æœåŠ¡ï¼Œæ‚¨å¯ä»¥ç‹¬ç«‹æ‰©å±•å„é¡¹æœåŠ¡ä»¥æ»¡è¶³å…¶æ”¯æŒçš„åº”ç”¨ç¨‹åºåŠŸèƒ½çš„éœ€æ±‚ã€‚è¿™ä½¿å›¢é˜Ÿèƒ½å¤Ÿé€‚å½“è°ƒæ•´åŸºç¡€è®¾æ–½éœ€æ±‚ï¼Œå‡†ç¡®è¡¡é‡åŠŸèƒ½æˆæœ¬ï¼Œå¹¶åœ¨æœåŠ¡éœ€æ±‚æ¿€å¢æ—¶ä¿æŒå¯ç”¨æ€§ã€‚ è½»æ¾éƒ¨ç½²ï¼šå¾®æœåŠ¡æ”¯æŒæŒç»­é›†æˆå’ŒæŒç»­äº¤ä»˜ï¼Œå¯ä»¥è½»æ¾å°è¯•æ–°æƒ³æ³•ï¼Œå¹¶å¯ä»¥åœ¨æ— æ³•æ­£å¸¸è¿è¡Œæ—¶å›æ»šã€‚ç”±äºæ•…éšœæˆæœ¬è¾ƒä½ï¼Œå› æ­¤å¯ä»¥å¤§èƒ†è¯•éªŒï¼Œæ›´è½»æ¾åœ°æ›´æ–°ä»£ç ï¼Œå¹¶ç¼©çŸ­æ–°åŠŸèƒ½çš„ä¸Šå¸‚æ—¶é—´ã€‚ æŠ€æœ¯è‡ªç”±ï¼šå¾®æœåŠ¡æ¶æ„ä¸éµå¾ªâ€œä¸€åˆ€åˆ‡â€çš„æ–¹æ³•ã€‚å›¢é˜Ÿå¯ä»¥è‡ªç”±é€‰æ‹©æœ€ä½³å·¥å…·æ¥è§£å†³ä»–ä»¬çš„å…·ä½“é—®é¢˜ã€‚å› æ­¤ï¼Œæ„å»ºå¾®æœåŠ¡çš„å›¢é˜Ÿå¯ä»¥ä¸ºæ¯é¡¹ä½œä¸šé€‰æ‹©æœ€ä½³è¯­è¨€å’Œå·¥å…·ã€‚ å¼¹æ€§ï¼šæœåŠ¡ç‹¬ç«‹æ€§å¢åŠ äº†åº”ç”¨ç¨‹åºåº”å¯¹æ•…éšœçš„å¼¹æ€§ã€‚åœ¨æ•´ä½“å¼æ¶æ„ä¸­ï¼Œå¦‚æœä¸€ä¸ªç»„ä»¶å‡ºç°æ•…éšœï¼Œå¯èƒ½å¯¼è‡´æ•´ä¸ªåº”ç”¨ç¨‹åºæ— æ³•è¿è¡Œã€‚é€šè¿‡å¾®æœåŠ¡ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥é€šè¿‡é™ä½åŠŸèƒ½è€Œä¸å¯¼è‡´æ•´ä¸ªåº”ç”¨ç¨‹åºå´©æºƒæ¥å¤„ç†æ€»ä½“æœåŠ¡æ•…éšœã€‚ å½“ç„¶å¾®æœåŠ¡å¹¶ä¸æ˜¯ä»€ä¹ˆ silver bulletï¼Œå¾®æœåŠ¡è™½è¯´ç›¸å¯¹å·¨çŸ³æ¶æ„æœ‰å¾ˆå¤šæœ‰ç‚¹ï¼Œä½†æ˜¯éšå¾®æœåŠ¡ä¸€èµ·æ¥çš„é‚£å°±æ˜¯æ¯”è¾ƒå¤æ‚çš„éƒ¨ç½²ç¯å¢ƒã€‚åŒæ—¶æœ‰å¤šä¸ªä¸åŒçš„æœåŠ¡åœ¨è¿è¡Œä¸”å¾—ç¡®ä¿å„ä¸ªæœåŠ¡ç›´æ¥çš„ç½‘ç»œçš„äº’é€šï¼ŒåŠ ä¸Šå¾®æœåŠ¡ä¼šä¾èµ–æœåŠ¡å‘ç°ã€æ—¥å¿—æ”¶é›†ã€é“¾è·¯è¿½è¸ªç­‰ç»„ä»¶ï¼Œéœ€è¦ä¸€å®šçš„æ¶æ„èƒ½åŠ›ã€‚ ","date":"2022-05-14","objectID":"/posts/what-is-microservices/:1:2","tags":["å¾®æœåŠ¡","ç³»åˆ—ç¯‡"],"title":"[ç³»åˆ—]å¾®æœåŠ¡Â·ä»€ä¹ˆæ˜¯å¾®æœåŠ¡","uri":"/posts/what-is-microservices/"},{"categories":["microservice"],"content":"2. ä¸ºä»€ä¹ˆæ˜¯å¾®æœåŠ¡ åœ¨å¯¹å·¨çŸ³æ¶æ„å’Œå¾®æœåŠ¡çš„ä¼˜ç¼ºç‚¹æœ‰äº†ä¸€å®šçš„è®¤çŸ¥ã€‚æˆ‘ä»¬ç°åœ¨èŠä¸€èŠä¸ºä»€ä¹ˆæ˜¯å¾®æœåŠ¡æˆ–è€…æ˜¯è¯´ ä¸ºä»€ä¹ˆå¾®æœåŠ¡ä¸ºä»€ä¹ˆè¢«è¶Šæ¥è¶Šå¤šçš„å¼€å‘è€…æ‰€æ¥å—ã€‚ å¾®æœåŠ¡å¹¶éæ˜¯è¿‘å‡ å¹´æ‰å‡ºç°çš„æ¦‚å¿µï¼Œå…¶å®è¿™ç§æ¶æ„æ–¹å¼ä¸€ç›´éƒ½æœ‰è¢«æåˆ°ï¼Œä½†æ˜¯ç”±äºä»¥å¾€çš„æœåŠ¡éƒ½æ˜¯ç‰©ç†æœºçš„æ–¹å¼éƒ¨ç½²ï¼Œå¾ˆéš¾ä¸ºçµæ´»çš„å¾®æœåŠ¡æ¶æ„æä¾›ä¸€ä¸ªå±•ç°ä»–ä¼˜åŠ¿çš„å¹³å°ã€‚ è€Œå®¹å™¨æŠ€æœ¯çš„å‡ºç°æˆ‘è®¤ä¸ºæ˜¯å¾®æœåŠ¡æ¶æ„å´›èµ·çš„å¼€å§‹ã€‚æœåŠ¡å¯ä»¥ä»¥ä¸€ä¸ªé•œåƒä¸ºå•ä½éƒ¨ç½²åœ¨æœåŠ¡å™¨ä¸Šï¼Œä¸”å¯é™åˆ¶èµ„æºã€å¯ä»»æ„æ‰©ç¼©å®¹ã€å¯å¿«é€Ÿå‡çº§ã€‚è¿™ç§éƒ¨ç½²æ–¹å¼ä½¿å¾—å¾®æœåŠ¡æ¶æ„çš„ä¼˜ç‚¹æ›´åŠ ä½“ç°å‡ºæ¥äº†ï¼Œå¯ä»¥è¯´æ˜¯å®¹å™¨æŠ€æœ¯çš„å‡ºç°æˆå°±äº†å¾®æœåŠ¡ã€‚ ä¹‹åå†å‡ºç°çš„å®¹å™¨ç¼–æ’ï¼ˆkubernetesï¼‰ï¼ŒæŠŠå®¹å™¨æŠ€æœ¯çš„ä¼˜åŠ¿å±•ç°ç»™äº†æ‰€æœ‰äººï¼Œè¶Šæ¥è¶Šå¤šçš„æœåŠ¡ä¸å†åƒä»¥å‰é‚£ä¹ˆè‡ƒè‚¿ï¼Œä¸€ä¸ªæœåŠ¡åªåšä¸€ä»¶äº‹å„¿ï¼Œä¸å…¶ä»–æœåŠ¡ç»„æˆä¸€ä¸ªå®Œæ•´çš„æ¶æ„ä½“ç³»ã€‚ ä¸æ­¤åŒæ—¶å‡ºç°äº†ä¸€å¤§æ‰¹ä¼˜ç§€çš„å¼€æºäº§å“/æ¦‚å¿µå¦‚ etcdã€Prometheusã€open tracing ç­‰ï¼Œä¸ºå¾®æœåŠ¡æ¶æ„çš„å‘å±•å’Œå‘æ‰¬èµ·äº†å¾ˆå¤§ä½œç”¨ã€‚ é™¤æ­¤ä¹‹å¤–ï¼Œäº‘è®¡ç®—/äº‘å¹³å°çš„å‡ºç°ï¼Œè®©æˆ‘ä»¬è®¤è¯†äº† awsã€azureã€Google Cloudã€è…¾è®¯äº‘ã€é˜¿é‡Œäº‘ç­‰è¿™äº›äº‘å‚å•†ã€‚ä»–ä»¬ç»™æˆ‘å¸¦æ¥äº†å¾ˆå¤š Paasï¼ŒSaas æœåŠ¡ï¼Œä½¿å¾—æˆ‘ä»¬çš„é¡¹ç›®æ¶æ„å¯ä»¥æ›´çµæ´»ï¼Œæˆ‘ä»¬ä¸ç”¨è‡ªå·±ææ‰€æœ‰çš„ä¸œè¥¿äº†ï¼Œåœ¨æˆ‘ä»¬çš„æ¶æ„ä½“ç³»é‡Œå¯ä»¥æœ‰ä¸åŒè¯­è¨€å®ç°æœåŠ¡ã€å¯ä»¥æœ‰ä¸åŒäº‘å‚å•†æä¾›çš„æœåŠ¡ã€‚ è¿™äº›ç§ç§æ–°çš„çš„æŠ€æœ¯çš„æ¨ªç©ºå‡ºä¸–ä»¥åŠåŸå…ˆæŠ€æœ¯çš„æ›´æ–°æ¢ä»£ï¼Œä¸ºå¾®æœåŠ¡æ¶æ„ä½“ç°å¸¦æ¥äº†å¾ˆå¤šçš„å¯èƒ½æ€§ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ˜¯å¾®æœåŠ¡çš„ç­”æ¡ˆã€‚ ","date":"2022-05-14","objectID":"/posts/what-is-microservices/:2:0","tags":["å¾®æœåŠ¡","ç³»åˆ—ç¯‡"],"title":"[ç³»åˆ—]å¾®æœåŠ¡Â·ä»€ä¹ˆæ˜¯å¾®æœåŠ¡","uri":"/posts/what-is-microservices/"},{"categories":["microservice"],"content":"3. å¾®æœåŠ¡çš„æ ¸å¿ƒç†å¿µ å¾®æœåŠ¡æ ¸å¿ƒç†å¿µæˆ‘è®¤ä¸ºæ˜¯å°è€Œç²¾ï¼Œç”±å¤šä¸ªä¸åŒèŒè´£çš„å°å¾®æœåŠ¡å»ç»„æˆä¸€ä¸ªå¼ºå¤§çš„æœåŠ¡ä½“ç³»ã€‚è¿™ä¸ªä½“ç³»ä¸­çš„æ¯ä¸€ä¸ªæ¨¡å—å¯å•ç‹¬ç»´æŠ¤ã€å¯å•ç‹¬å‡é™çº§ã€å¯å•ç‹¬æ›¿æ¢ä»è€Œä¸å½±å“æ•´ä½“èƒ½åŠ›ã€‚ è€Œè¿™äº›æ¨¡å—ä½œä¸ºä¸€ä¸ªä¸ªå¾®æœåŠ¡æˆ–è€…åŸºç¡€ç»„ä»¶çš„å½¢å¼ï¼Œå­˜åœ¨è¿™ä¸ªä½“ç³»å½“ä¸­ã€‚ä»å¤–éƒ¨æ¥çœ‹ï¼Œæ•´ä½“ä½“ç³»åªæœ‰ä¸€ä¸ªæˆ–å‡ ä¸ªå…¥å£ï¼Œå„ä¸ªæœåŠ¡å’Œç»„ä»¶äº’ç›¸ä¾èµ–è°ƒç”¨ï¼Œä»è€Œåšåˆ°ä¸€ä¸ªå®Œæ•´çš„è¯·æ±‚é“¾ï¼Œä¸æ­¤åŒæ—¶ä¼šæœ‰ç±»ä¼¼ sidecar çš„ç»„ä»¶å»ç»´æŠ¤æ•´ä½“çš„å®Œæ•´æ€§ã€‚æ•´ä½“æ¶æ„æ›´åƒä¸€ä¸ªé‡‘å­—å¡”æ¨¡å‹ï¼Œè¶Šåº•å±‚çš„ç»„ä»¶/æœåŠ¡ä¼šè¶Šå¤šï¼Œè¿™äº›ç»„ä»¶/æœåŠ¡çš„ç»„åˆä¸ºä¸Šä¸€å±‚æä¾›æœåŠ¡ï¼Œè€Œä¸Šä¸€å±‚çš„èŒè´£å°±æ˜¯æ ¹æ®ä¸šåŠ¡æ•´åˆä¸åŒçš„åº•å±‚ç»„ä»¶/æœåŠ¡æä¾›çš„æ•°æ®ï¼Œä¸ºå…¶ä¸Šä¸€å±‚æœåŠ¡ã€‚ å¾®æœåŠ¡çš„é‡‘å­—å¡”æ¨¡å‹ ","date":"2022-05-14","objectID":"/posts/what-is-microservices/:3:0","tags":["å¾®æœåŠ¡","ç³»åˆ—ç¯‡"],"title":"[ç³»åˆ—]å¾®æœåŠ¡Â·ä»€ä¹ˆæ˜¯å¾®æœåŠ¡","uri":"/posts/what-is-microservices/"},{"categories":["microservice"],"content":"4. å¾®æœåŠ¡æ¶æ„ä¸‹çš„ä¸»è¦ç»„ä»¶ åœ¨æœ¬ç¯‡å¼€å¤´çš„å›¾ç‰‡æˆ‘ä»¬èƒ½çœ‹åˆ°ï¼Œä¸€ä¸ªæ¯”è¾ƒå®Œæ•´çš„å¾®æœåŠ¡æ¶æ„ä¸­ä¼šæœ‰å¾ˆå¤šä¸ä¸šåŠ¡æ— å…³çš„ç»„ä»¶å’ŒæœåŠ¡åœ¨è¿è¡Œï¼Œä¸‹é¢æˆ‘çœ‹æŒ‘å‡ ä¸ªæ ¸å¿ƒçš„ç»„ä»¶è¿›è¡Œå…¶èƒ½åŠ›çš„è®²è§£å’Œè¯¥ç»„ä»¶åœ¨æ¶æ„ä¸­çš„ä½œç”¨ã€‚ ","date":"2022-05-14","objectID":"/posts/what-is-microservices/:4:0","tags":["å¾®æœåŠ¡","ç³»åˆ—ç¯‡"],"title":"[ç³»åˆ—]å¾®æœåŠ¡Â·ä»€ä¹ˆæ˜¯å¾®æœåŠ¡","uri":"/posts/what-is-microservices/"},{"categories":["microservice"],"content":"4.1 æœåŠ¡å‘ç°æœåŠ¡æ³¨å†Œ æœåŠ¡å‘ç°æœåŠ¡æ³¨å†Œåº”è¯¥ç®—æ˜¯å¾®æœåŠ¡æ¶æ„ä¸­çš„æ ¸å¿ƒæ¦‚å¿µä¹‹ä¸€ï¼Œå„ä¸ªæœåŠ¡ä¹‹é—´çš„é€šä¿¡éƒ½ç¦»ä¸å¼€è¯¥ç»„ä»¶çš„èƒ½åŠ›ã€‚å¯ä»¥ä»å­—é¢æ„æ€ç†è§£ï¼Œè¯¥ç»„ä»¶çš„æ ¸å¿ƒèƒ½åŠ›å°±æ˜¯ä¸€ä¸ªæœåŠ¡æ³¨å†Œä¸­å¿ƒï¼ŒæœåŠ¡å¯åŠ¨åä¼šå°†è‡ªå·±çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬åå­—ã€é€šä¿¡åè®®ã€ç«¯å£ç­‰ï¼Œæ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒï¼Œè€Œå…¶ä»–æœåŠ¡ä»æ³¨å†Œä¸­å¿ƒæ‹‰å–å…¶ä»–æœåŠ¡ä¿¡æ¯ï¼Œéœ€è¦æ—¶æ ¹æ®æœåŠ¡ä¿¡æ¯å»è°ƒç”¨è¿™äº›æœåŠ¡çš„ rpc æ–¹æ³•ï¼ˆæˆ– http æ¥å£ï¼‰ã€‚è€Œæ•´ä¸ªè¿‡ç¨‹ä¸­å„ä¸ªæœåŠ¡ä¹‹å‰éƒ½ä¸éœ€è¦äº’ç›¸æ„ŸçŸ¥æœåŠ¡çš„çŠ¶æ€ï¼Œä»…é€šè¿‡ç»Ÿä¸€çš„æœåŠ¡æ³¨å†Œä¸­å¿ƒæ¥æ‹‰å–æ‰€éœ€è¦çš„æœåŠ¡çš„åŸºæœ¬ä¿¡æ¯å³å¯ã€‚ æœåŠ¡å‘ç°æœåŠ¡æ³¨å†Œ è€Œè¿™ç§æ¨¡å¼çš„å¥½å¤„åœ¨äºï¼Œä»»æ„ä¸€ä¸ªæœåŠ¡æ„å¤–é€€å‡ºæˆ–ç”¨æ–°çš„æœåŠ¡åŒºæ›¿æ¢ä¸€ä¸ªæ—§çš„æœåŠ¡ï¼Œå¯¹äºå…¶ä»–æœåŠ¡æ¥è¯´æ˜¯å‡ ä¹æ— æ„ŸçŸ¥çš„ï¼Œä¸éœ€è¦å¯¹éœ€è¦è°ƒç”¨è¿™ä¸ªæœåŠ¡çš„å…¶ä»–æœåŠ¡è¿›è¡Œä»»ä½•æ”¹åŠ¨ã€‚å¦‚æœæœåŠ¡æ„å¤–é€€å‡ºï¼Œå…¶ä»–æœåŠ¡ä¸å†ä»æœåŠ¡æ³¨å†Œä¸­å¿ƒæ‹¿åˆ°è¯¥æœåŠ¡çš„ä¿¡æ¯ï¼Œå› æ­¤ä¸ä¼šå‡ºç°è¯·æ±‚è¶…æ—¶æˆ–è€…ç½‘ç»œä¸é€šçš„ä½ç½®æƒ…å†µï¼Œä»è¯·æ±‚å‘å‡ºå‰å·²ç»çŸ¥é“å¯¹æ–¹æœåŠ¡å·²ç»æ˜¯ä¸å¯ç”¨çš„çŠ¶æ€äº†ï¼Œå¯ä»¥åšé™çº§å¤„ç†ã€‚ è€Œæ›´æ¢æœåŠ¡ï¼ˆç”šè‡³æ›´æ¢æœåŠ¡ ip ç«¯å£ï¼‰éƒ½å¯¹å…¶ä»–æœåŠ¡æ˜¯æ— æ„ŸçŸ¥çš„ï¼Œå› ä¸ºè¿™äº›ä¿¡æ¯æœ¬æ¥å°±æ˜¯ä»æœåŠ¡æ³¨å†Œä¸­å¿ƒæ‹¿åˆ°çš„ï¼Œæœ‰å˜åŒ–å¾ˆæ­£å¸¸ï¼Œç›´æ¥ç”¨æ–°çš„ç»§ç»­ä½¿ç”¨å°±å¯ä»¥ã€‚ ","date":"2022-05-14","objectID":"/posts/what-is-microservices/:4:1","tags":["å¾®æœåŠ¡","ç³»åˆ—ç¯‡"],"title":"[ç³»åˆ—]å¾®æœåŠ¡Â·ä»€ä¹ˆæ˜¯å¾®æœåŠ¡","uri":"/posts/what-is-microservices/"},{"categories":["microservice"],"content":"4.2 é…ç½®ä¸­å¿ƒ ä»¥å¾€çš„æœåŠ¡éƒ¨ç½²éƒ½ä¼šå¸¦ç€ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œç„¶åå†æœåŠ¡å¯åŠ¨æ—¶ä»é…ç½®æ–‡ä»¶æˆ–è€…ç¯å¢ƒå˜é‡è¯»å–æœåŠ¡å¯åŠ¨å¿…è¦çš„å‚æ•°ã€‚ä½†æ˜¯éšç€æœåŠ¡æ•°é‡çš„å˜å¤šï¼Œä¸åŒæœåŠ¡ä¹‹é—´çš„é…ç½®æ–‡ä»¶ä¼šæœ‰é‡å çš„æƒ…å†µï¼ˆæ¯”å¦‚å…¬ç”¨ä¸€ä¸ªæ•°æ®åº“ï¼Œmqï¼Œcache ç­‰ï¼‰ã€‚å¦‚æœè¿è¡Œè¿‡ç¨‹ä¸­éœ€è¦æ”¹å˜è¿™äº›é…ç½®æ–‡ä»¶ä¼šå˜å¾—éå¸¸éº»çƒ¦ï¼Œè‡³å°‘éœ€è¦ä¸€æ¬¡æ”¹å˜é…ç½®å’Œé‡å¯æœåŠ¡çš„è¿‡ç¨‹ã€‚å¦‚æœæ˜¯ä¿®æ”¹å“ªäº›é‡å çš„é…ç½®ï¼Œåˆ™æ›´åŠ éº»çƒ¦ï¼Œå¾ˆéš¾ä¿è¯æ‰€æœ‰çš„æœåŠ¡éƒ½å·²ç»ä¿®æ”¹ä¸”çŸ­æ—¶é—´å†…å¿«é€Ÿç”Ÿæ•ˆã€‚ é…ç½®ä¸­å¿ƒåˆ™å¾ˆå¥½çš„è§£å†³äº†è¿™äº›é—®é¢˜ï¼Œç±»ä¼¼æœåŠ¡æ³¨å†Œä¸­å¿ƒï¼Œé…ç½®ä¸­å¿ƒç»Ÿä¸€ç®¡ç†æ‰€æœ‰çš„é…ç½®ï¼Œå¹¶ä¸”å¯ä»¥åšåˆ°åŒä¸€å—é…ç½®å¯ä»¥è¢«å¤šä¸ªåº”ç”¨å…±äº«ï¼Œè€Œä¸€äº›æ•æ„Ÿçš„é…ç½®ï¼Œé…ç½®ä¸­å¿ƒå¯ä»¥åšåˆ°æƒé™æ ¡éªŒä»è€Œç¡®ä¿æ•°æ®å®‰å…¨æ€§ï¼ˆæ¯”å¦‚æœ‰çš„æœåŠ¡ä¸åº”è¯¥æ‹¥æœ‰å†™æƒé™çš„ db è§’è‰²ï¼‰ã€‚ ","date":"2022-05-14","objectID":"/posts/what-is-microservices/:4:2","tags":["å¾®æœåŠ¡","ç³»åˆ—ç¯‡"],"title":"[ç³»åˆ—]å¾®æœåŠ¡Â·ä»€ä¹ˆæ˜¯å¾®æœåŠ¡","uri":"/posts/what-is-microservices/"},{"categories":["microservice"],"content":"4.3 æœåŠ¡æ„å»ºä¸éƒ¨ç½² å¾®æœåŠ¡æ¶æ„ä¸­çš„æœåŠ¡ï¼Œä¸€èˆ¬è¦æ±‚æ˜¯å¯å¿«é€Ÿéƒ¨ç½²ï¼ˆç”šè‡³è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼‰ï¼Œä¼ ç»Ÿçš„æœåŠ¡å™¨æˆ–è€…è™šæ‹Ÿæœºä¸Šç›´æ¥è¿è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶çš„æ–¹å¼ï¼Œå¯¹äºå¾®æœåŠ¡æ¥è¯´æ˜¯ä¸èƒ½æ¥å—çš„ã€‚å‰é¢ä¹Ÿè¯´äº†å®¹å™¨åŒ–æŠ€æœ¯çš„å‡ºç°åŠ å¿«äº†å¾®æœåŠ¡æ¶æ„çš„å‘å±•ï¼Œå› æ­¤å¾®æœåŠ¡çš„éƒ¨ç½²å¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯ä¾èµ–å®¹å™¨æŠ€æœ¯çš„ã€‚åœ¨æäº¤ä»£ç æˆ–è€…æ‰‹åŠ¨ç¼–è¯‘æ—¶ï¼Œéœ€è¦ç”Ÿæˆä¸€ä¸ªdocker é•œåƒï¼Œæ¨åˆ°é•œåƒä»“åº“ä¸­ï¼Œè€Œéƒ¨ç½²æ—¶ç›´æ¥æ‹‰å–å¯¹åº”ç‰ˆæœ¬çš„é•œåƒå¯åŠ¨å³å¯ã€‚ è¿™æ ·åœ¨ä¸šåŠ¡è¿­ä»£æˆ–è€…éœ€è¦å¿«é€Ÿæ‰©ç¼©å®¹æ—¶ï¼Œé…åˆå®¹å™¨ç¼–æ’å™¨è¿›è¡Œå®¹å™¨çš„è°ƒåº¦ï¼Œè¿™ç›¸å¯¹äºä¼ ç»ŸæœåŠ¡å™¨/è™šæ‹Ÿæœºç¯å¢ƒä¸‹çš„è°ƒåº¦æ—¶æ•ˆæ€§ä¼šé«˜å¾ˆå¤šã€‚åŒæ—¶å¯ä»¥æ›´å……åˆ†çš„åˆ©ç”¨ç°æœ‰çš„èµ„æºï¼Œæé«˜åˆ©ç”¨ç‡ã€‚ ","date":"2022-05-14","objectID":"/posts/what-is-microservices/:4:3","tags":["å¾®æœåŠ¡","ç³»åˆ—ç¯‡"],"title":"[ç³»åˆ—]å¾®æœåŠ¡Â·ä»€ä¹ˆæ˜¯å¾®æœåŠ¡","uri":"/posts/what-is-microservices/"},{"categories":["microservice"],"content":"4.4 æœåŠ¡è§‚æµ‹ æœåŠ¡çš„è§‚æµ‹æŒ‡çš„æ˜¯æ—¥å¿—ã€ç›‘æ§ã€é“¾è·¯è¿½è¸ªè¿™ä¸‰ä¸ªæ¨¡å—ï¼Œå…¨é¢çš„å¯¹æœåŠ¡è¿›è¡Œè§‚æµ‹ï¼Œè¾¾åˆ°å°½å¿«å‘ç°é—®é¢˜ï¼Œå°½å¿«å®šä½çš„ä½œç”¨ã€‚ 4.4.1 æ—¥å¿—æœåŠ¡ æ—¥å¿—è¿™å—ä¸€èˆ¬ä»ä¸¤ä¸ªæ–¹é¢å…¥æ‰‹ï¼Œä¸€æ˜¯ç»“æ„åŒ–æ—¥å¿—ï¼ŒäºŒæ˜¯æ”¶é›†æ—¥å¿—ã€‚ å…ˆè¯´ç»“æ„åŒ–æ—¥å¿—ã€‚ æ—¥å¿—æ˜¯ä¸ä»…æ˜¯ä¸ºäº†è§‚å¯ŸæœåŠ¡è¿è¡Œæ˜¯å¦æ­£å¸¸ï¼Œæ›´æ˜¯ä¸ºäº†åœ¨å‡ºç°é—®é¢˜æ˜¯æ—¶å€™æ ¹æ®ç›¸å…³æ—¥å¿—å°½å¿«å®šä½é—®é¢˜æ‰€åœ¨ã€‚å› æ­¤æ—¥å¿—æ€ä¹ˆæ‰“ï¼Œåº”è¯¥æ³¨æ„å“ªäº›äº‹é¡¹åº”è¯¥æœ‰ä¸€ä»½è§„èŒƒã€‚è¿™è§„èŒƒå¯æ ¹æ®è‡ªèº«æƒ…å†µè€Œå®šï¼Œä¸€èˆ¬æƒ…å†µä¸‹æ˜¯æ—¥å¿—åˆ†ç­‰çº§ï¼Œç„¶åä¸åŒæƒ…å†µä¸‹æ‰“å°ä¸åŒçº§åˆ«çš„æ—¥å¿—ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæ—¥å¿—çš„ç»“æ„åŒ–ï¼Œæ—¥å¿—ä¸èƒ½åªåªæ˜¯äºäººèƒ½çœ‹æ‡‚ï¼Œæ›´åº”æ˜¯æœºå™¨èƒ½çœ‹æ‡‚ã€‚æ ¹æ®æ—¥å¿—åˆ†ææœåŠ¡è´¨é‡ã€é”™è¯¯ç‡ã€ä¸šåŠ¡æƒ…å†µç­‰å¤§æ•°æ®åˆ†æï¼Œä»è€Œå¯ä»¥é¢„æµ‹ä¸€äº›åœºæ™¯ï¼Œä»è€Œå¯¹æœåŠ¡å¸¦æ¥ä¸€äº›ç›Šå¤„ã€‚ å†è¯´æ”¶é›†æ—¥å¿—ã€‚ ç”±äºå¾®æœåŠ¡æ¶æ„ä¸‹çš„æœåŠ¡å¤§å¤šæ•°æ˜¯åœ¨ docker æˆ– kubernetes ç¯å¢ƒä¸‹è¿è¡Œï¼Œè¿™å°±æ„å‘³ç€æ—¥å¿—æ–‡ä»¶åœ¨å„è‡ªçš„å®¹å™¨å†…ã€‚è¿™ä¸ªæ—¶å€™éœ€è¦æ—¥å¿—æ”¶é›†çš„ agent å’Œç»Ÿä¸€æ—¥å¿—ä¸­å¿ƒæ¥èšåˆåˆ†æ•£çš„æ—¥å¿—ï¼Œæå‡æŸ¥è¯¢æ•ˆç‡ã€‚ä¸€èˆ¬éƒ¨ç½²ä¸€ä¸ª ESæˆ–è€…éƒ¨ç½²ä¸€å¥— ELK æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå½“ç„¶å¯¹äºä¾èµ–äº‘å‚å•†æœåŠ¡æˆ–è€…æ²¡æœ‰èµ„æºéƒ¨ç½²è¿™äº›ç»„ä»¶çš„å¼€å‘è€…ï¼Œå¯¹æ¥åˆ°äº‘å‚å•†æä¾›çš„æ—¥å¿—ç»„ä»¶ä¹Ÿæ˜¯è¶³çŸ£ã€‚æˆ‘ä¹‹å‰å…¬å¸çš„æ—¶å€™ä¹Ÿæ˜¯å¯¹æ¥é˜¿é‡Œäº‘çš„æ—¥å¿—æœåŠ¡ï¼Œæ•´ä½“ä½¿ç”¨èµ·æ¥ä¹Ÿæ˜¯ OK çš„ã€‚ é™¤æ­¤ä¹‹å¤–ï¼Œæœ€è¿‘è¿˜è¢«å®‰åˆ©äº†ä¸€ä¸ª Go è¯­è¨€å®ç°çš„è½»é‡çº§çš„å¼€æºæ—¥å¿—æŸ¥è¯¢ã€åˆ†æã€æŠ¥è­¦çš„å¯è§†åŒ–å¹³å° â€“ Click Visualã€‚å¤§æ¦‚çœ‹äº†ä¸€ä¸‹é¡µé¢ä¸é˜¿é‡Œäº‘çš„æ—¥å¿—ç»„ä»¶é¡µé¢å¾ˆç›¸ä¼¼ï¼Œå¯èƒ½ä¸ºäº†ä¿æŒç”¨æˆ·ä½¿ç”¨ä¹ æƒ¯ã€‚ä¹‹åæˆ‘ä¼šèŠ±æ—¶é—´å»ä½“éªŒè¿™ä¸ªå·¥å…·ï¼Œå¹¶å‡ºä¸€ä¸ªå®‰è£…\u0026ä½“éªŒçš„åšå®¢ï¼ˆå…ˆæŒ–ä¸ªå‘ï¼‰ã€‚ Click Visual 4.4.2 æœåŠ¡ç›‘æ§ä¸å‘Šè­¦ æœåŠ¡ç›‘æ§ä¸å‘Šè­¦å¹¶ä¸æ˜¯å¾®æœåŠ¡ç‹¬æœ‰çš„æ¦‚å¿µï¼Œæ­£å¸¸ä»»ä½•ä¸€ä¸ªçº¿ä¸Šä¸šåŠ¡éƒ½ä¼šåŸºäºå„ç§æŠ€æœ¯æ‰‹æ®µå»ç›‘æ§å…¶ä¸šåŠ¡çš„å„ç§æŒ‡æ ‡ï¼ŒåŒæ—¶æ ¹æ®è§„åˆ™è¿›è¡Œå‘Šè­¦ã€‚ ä¸€èˆ¬å¾®æœåŠ¡æ¶æ„ä¸­å¸¸è§çš„ç›‘æ§å’Œå‘Šè­¦ç»„åˆä¸º Prometheus + Grafanaã€‚ Prometheus ä½œä¸ºä¸€ä¸ªè¿™å‡ å¹´å‡ºç°çš„å¼€æºé¡¹ç›®,å·²ç»è¢«ä¼—å¤šçŸ¥åçš„å¼€æºé¡¹ç›®æˆ–å¼€æºç»„ç»‡æ‰€æ‹¥æŠ¤ï¼Œå…¶æŒ‡æ ‡æ”¶é›†å’ŒæŸ¥è¯¢èƒ½åŠ›å¯ä»¥è¯´æ˜¯ä¸šç•Œæ•°ä¸€æ•°äºŒçš„äº†ã€‚çœ‹ä¸€ä¸‹å…¶ç”¨æˆ·å°±çŸ¥é“å…¶å¼ºå¤§äº†ï¼š Prometheus Users è€Œ Grafana æ˜¯ä¸€ä¸ªæ•°æ®å±•ç¤ºé¢æ¿ï¼Œå…¶ä¸°å¯Œçš„ç»„ä»¶å’Œé«˜åº¦å¯åˆ¶å®šæ€§ï¼Œç»™ä½¿ç”¨è€…å¸¦æ¥äº†æ— æ•°ç§å¯èƒ½æ€§ã€‚ä¸” Grafana æ”¯æŒåŒ…æ‹¬ Prometheus åœ¨å†…çš„ 100 å¤šç§æ•°æ®æºï¼Œå¯ä»¥åšåˆ°ä¸€ä¸ªæ•°æ®é¢ï¼Œçœ‹åˆ°æ‰€æœ‰ç»„ä»¶çš„ç›‘æ§æŒ‡æ ‡å¹¶ä¸”æ¯ä¸€ç§æŒ‡æ ‡éƒ½å¯ä»¥é…ç½®ç›‘æ§è§„åˆ™ã€‚å› æ­¤ Grafana ä¹Ÿå—å¤§é‡å¼€å‘è€…çš„æ¬¢è¿ã€‚ 4.4.3 OpenTracing OpenTracing æ˜¯ CNCF æå‡ºçš„åˆ†å¸ƒå¼è¿½è¸ªçš„æ ‡å‡†ã€‚å®ƒæä¾›ç”¨å‚å•†ä¸­ç«‹çš„ APIï¼Œå¹¶æä¾› Goã€Javaã€JavaScriptã€Pythonã€Rubyã€PHPã€Objective-Cã€C++ å’Œ C# è¿™ä¹ç§è¯­è¨€çš„åº“ã€‚ç›®å‰æ”¯æŒ Tracer åŒ…æ‹¬ Zipkinã€Skywalkingã€Jaeger ç­‰ï¼Œæ”¯æŒçš„æ¡†æ¶åŒ…æ‹¬ gRPCã€MOTANã€djangoã€Flaskã€Sharding-JDBC ç­‰ã€‚ OpenTracing ä¸­æœ‰ä¸¤ä¸ªå…³é”®çš„æ¦‚å¿µï¼Œåˆ†åˆ«æ˜¯ Traceï¼ŒSpanã€‚ Trace Trace è¡¨ç¤ºä¸€ä¸ªå®Œæˆçš„è°ƒç”¨é“¾ï¼Œå¦‚ä¸€æ¬¡å®Œæˆçš„è¯·æ±‚ã€‚ Span Span è¡¨ç¤ºè°ƒç”¨é“¾ä¸­çš„ä¸€ä¸ªæœ€å°å•å…ƒï¼Œä¸€ä¸ª Trace ç”±å¤šä¸ª Span ç»„æˆã€‚å¦‚ä¸€æ¬¡è¯·æ±‚ä¸­çš„ä¸­æœåŠ¡ä¹‹é—´çš„è°ƒç”¨å¯ä»¥æ˜¯ä¸€ä¸ª spanï¼Œä¸€æ¬¡æ•°æ®åº“æŸ¥è¯¢å¯ä»¥æ˜¯ä¸€ä¸ª spanã€‚ å¦‚ä¸‹å›¾JaegerUI å±•ç¤ºçš„ä¸€æ¬¡ Traceï¼Œæ•´ä¸ªè¿‡ç¨‹æ˜¯ä¸€ä¸ª Traceï¼Œè€Œè¿‡ç¨‹ä¸­çš„æ¯ä¸€ä¸ªæ¨¡å—æ˜¯ä¸€ä¸ª Spanã€‚Trace æ‹¥æœ‰ä¸€ä¸ªå”¯ä¸€çš„ TraceID, Span æ‹¥æœ‰ä¸€ä¸ªå”¯ä¸€çš„ SpanID å’Œå…¶æ‰€å±çš„ TraceIDã€‚ Jaeger UI é…åˆ UIï¼Œå¯ä»¥å¾ˆå¿«å®šä½å“ªä¸€ä¸ªé˜¶æ®µå‡ºé—®é¢˜ã€å“ªä¸€ä¸ªé˜¶æ®µå¤„ç†å˜æ…¢äº†ç­‰æƒ…å†µï¼Œå¯¹äºè·¨å¤šä¸ªæœåŠ¡å¤šä¸ªç»„ä»¶çš„è¯·æ±‚ï¼Œè¿™ç§è¿½è¸ªæ–¹å¼æ— ç–‘ä½¿éå¸¸å¥½ç”¨çš„ã€‚ ç›®å‰ OpenTracing æœ€æ–°çŠ¶æ€æ˜¯ CNCF äº 2022 å¹´ 1 æœˆ 31 æ—¥å½’æ¡£äº†ï¼ˆcncf-archives-the-opentracing-projectï¼‰ã€‚å…¶ä¸»è¦åŸå› æ˜¯ CNCF æ¨å‡ºäº† OpenTelemetry é¡¹ç›®ï¼Œæ˜¯ä¸€ä¸ªæ›´å…¨é¢çš„å¯è§‚æµ‹æ€§æ ‡å‡†ã€‚ OpenTelemetryæ˜¯ä»€ä¹ˆï¼Ÿ OpenTelemetryï¼ˆä¹Ÿç§°ä¸º OTelï¼‰æ˜¯ä¸€ä¸ªå¼€æºå¯è§‚æµ‹èƒ½åŠ›æ¡†æ¶ï¼Œç”±ä¸€ç³»åˆ—å·¥å…·ã€API å’Œ SDK ç»„æˆï¼Œä½¿ IT å›¢é˜Ÿèƒ½å¤Ÿæ£€æµ‹ã€ç”Ÿæˆã€æ”¶é›†å’Œå¯¼å‡ºè¿œç¨‹ç›‘æµ‹æ•°æ®ä»¥è¿›è¡Œåˆ†æå’Œäº†è§£è½¯ä»¶æ€§èƒ½å’Œè¡Œä¸ºã€‚ è¦äº†è§£ OTel æ‰€åšçš„å·¥ä½œï¼Œäº†è§£å¯è§‚æµ‹èƒ½åŠ›ä¼šæœ‰æ‰€å¸®åŠ©ã€‚ç²—ç•¥å®šä¹‰ä¸€ä¸‹ï¼Œå¯è§‚æµ‹èƒ½åŠ›æ˜¯ä¸€ç§æ ¹æ®ç³»ç»Ÿç”Ÿæˆå¤–éƒ¨æ•°æ®ï¼ˆé€šå¸¸æ˜¯æ—¥å¿—ã€æŒ‡æ ‡å’Œè·Ÿè¸ªï¼‰ç ”åˆ¤ç³»ç»Ÿå†…éƒ¨å‘ç”Ÿæƒ…å†µçš„èƒ½åŠ›ã€‚ OpenTelemetryè‡´åŠ›äºå¦‚ä½•æ”¶é›†å’Œå‘é€å¯è§‚æµ‹èƒ½åŠ›æ•°æ®å¹¶ä½¿å…¶å…·æœ‰é€šç”¨æ ¼å¼ã€‚ä½œä¸ºäº‘åŸç”Ÿè®¡ç®—åŸºé‡‘ä¼š (CNCF) çš„å­µåŒ–é¡¹ç›®ï¼ŒOTel æ—¨åœ¨æä¾›ä¸ä¾›åº”å•†æ— å…³çš„ç»Ÿä¸€åº“å’Œ API é›†â€”â€”ä¸»è¦ç”¨äºæ”¶é›†æ•°æ®å¹¶å°†å…¶ä¼ è¾“åˆ°æŸä¸ªåœ°æ–¹ã€‚è‡ªé¡¹ç›®å¯åŠ¨ä»¥æ¥ï¼ŒåŒ…æ‹¬Dynatraceåœ¨å†…çš„ä¼—å¤šå‚å•†,å·²åŠ å…¥è¿™ä¸€é˜µè¥ï¼ŒåŒå¿ƒååŠ›è®©æµ·é‡æ•°æ®æ”¶é›†æ›´ç®€ä¾¿ã€æ›´æ˜“äºä½¿ç”¨ã€‚ è¦äº†è§£å¯è§‚æµ‹èƒ½åŠ›å’Œ OTel çš„å¤„ç†æ–¹æ³•çš„é‡è¦æ€§ï¼Œè®©æˆ‘ä»¬æ›´æ·±å…¥åœ°äº†è§£è¿œç¨‹ç›‘æµ‹æ•°æ®æœ¬èº«ï¼Œä»¥åŠå®ƒå¦‚ä½•å¸®åŠ©ç»„ç»‡è½¬å˜å…¶ç»è¥æ–¹å¼ã€‚ å®˜æ–¹æ–‡æ¡£ï¼šhttps://opentelemetry.io/docs/ ","date":"2022-05-14","objectID":"/posts/what-is-microservices/:4:4","tags":["å¾®æœåŠ¡","ç³»åˆ—ç¯‡"],"title":"[ç³»åˆ—]å¾®æœåŠ¡Â·ä»€ä¹ˆæ˜¯å¾®æœåŠ¡","uri":"/posts/what-is-microservices/"},{"categories":["microservice"],"content":"4.5 API ç½‘å…³ API ç½‘å…³ä½œä¸ºæ•´ä¸ªæœåŠ¡çš„å…¥å£ï¼Œå…¶æ ¸å¿ƒåŠŸèƒ½åº”è¯¥åŒ…æ‹¬ä»¥ä¸‹å‡ ç‚¹ï¼š é‰´æƒ é™æµç†”æ–­é™çº§ æ„ŸçŸ¥åç«¯æœåŠ¡ï¼Œæ ¹æ®ä¸šåŠ¡/è§„åˆ™è°ƒç”¨ä¸åŒçš„æœåŠ¡ ä¸€èˆ¬æˆç†Ÿçš„å¾®æœåŠ¡æ¡†æ¶éƒ½å¸¦æœ‰ API ç½‘å…³ç›¸å…³é€»è¾‘ï¼Œä¹Ÿæœ‰å•ç‹¬çš„ç½‘å…³å¼€æºé¡¹ç›®ï¼Œå¦‚ istio, apisixç­‰ã€‚ ","date":"2022-05-14","objectID":"/posts/what-is-microservices/:4:5","tags":["å¾®æœåŠ¡","ç³»åˆ—ç¯‡"],"title":"[ç³»åˆ—]å¾®æœåŠ¡Â·ä»€ä¹ˆæ˜¯å¾®æœåŠ¡","uri":"/posts/what-is-microservices/"},{"categories":["microservice"],"content":"4.6 å…¶ä»– é™¤äº†ä¸Šè¿°å‡ ä¸ªå¸¸è§çš„ç»„ä»¶/æ¦‚å¿µä¹‹å¤–ï¼Œæ ¹æ®ä¸šåŠ¡/æ¶æ„éœ€æ±‚ï¼Œä¼šæœ‰å®‰å…¨ã€è´Ÿè½½å‡è¡¡ã€DBã€MQã€ä»£ç†ç­‰ç»„ä»¶ã€‚è€Œè¿™äº›ç»„ä»¶/æ¦‚å¿µåœ¨å¼€å‘ä¸­å¦‚ä½•ä½¿ç”¨ï¼Œåº”è¯¥æ€ä¹ˆå†™å¾®æœåŠ¡çš„ä»£ç å¯¹äºä¸€ä¸ªåˆšæ¥è§¦å¾®æœåŠ¡çš„äººæ¥è¯´ç¡®å®æ˜¯ä¸ªå¤§é—®é¢˜ã€‚è€Œè¿™ä¸ªé—®é¢˜çš„ç­”æ¡ˆå°±æ˜¯ä½¿ç”¨ä¸€äº›æˆç†Ÿçš„å¾®æœåŠ¡æ¡†æ¶ï¼Œè¿™äº›æ¡†æ¶å·²ç»æŠŠä¸Šè¿°çš„æ‰€æœ‰æ¦‚å¿µé€šè¿‡ä»£ç æŠ½è±¡å‡ºæ¥ï¼Œçœ‹å®Œè¿™äº›æ¡†æ¶çš„ demoï¼ŒåŸºæœ¬å¯ä»¥ä¸Šæ‰‹ä½¿ç”¨ã€‚ å¸¸è§çš„æ¡†æ¶ï¼š asim/go-microï¼šè¯¥æ¡†æ¶å¯ä»¥ç®—å¾—ä¸Šæ˜¯ä¸€ä¸ªè€ç‰Œä¸€æµçš„æ¡†æ¶ï¼Œå¾ˆå¤šæ–°å…´æ¡†æ¶ä¸Šéƒ½èƒ½çœ‹åˆ°ä»–çš„å½±å­ï¼Œå¼ºçƒˆå»ºè®®é˜…è¯»å…¶å„ç§æ¥å£ï¼Œé¡¹ç›®ç»“æ„çš„å®šä¹‰ï¼Œèƒ½æ”¶è·å¾ˆå¤šã€‚ go-kratos/kratosï¼šB ç«™å‘˜å·¥ä»¬æ¨å‡ºçš„å¾®æœåŠ¡æ¡†æ¶ï¼Œæœ€è¿‘ä¸¤å¹´éå¸¸ç«ï¼Œå…¶è®¾è®¡ç†å¿µä¸ go-micro å¾ˆç±»ä¼¼ï¼Œä¹Ÿå¾ˆå€¼å¾—å°è¯•ä½¿ç”¨ï¼Œæˆ‘æœ¬äºº GoIM é¡¹ç›®ä¹Ÿå°è¯•ä½¿ç”¨è¯¥æ¡†æ¶ï¼Œæ•´ä½“è¿˜æ˜¯ä¸é”™çš„ã€‚å…¶ä»‹ç»ä¹Ÿè¯´äº†è®¾è®¡å— go-micro çš„å½±å“ã€‚ è¿™äº›æ¡†æ¶å¹¶éæŠŠæ‰€æœ‰å¾®æœåŠ¡çš„ä»£ç éƒ½å¸®ä½ å†™å¥½ï¼Œä½ å®Œå…¨å¯ä»¥æ›¿ä»£å…¶ä»»æ„æ¨¡å—ï¼Œå› ä¸ºå¤§éƒ¨åˆ†å¾®æœåŠ¡æ¡†æ¶éƒ½é‡‡ç”¨å®šä¹‰ apiï¼Œç„¶åå•ç‹¬å®ç°api åæ³¨å†Œçš„æ–¹å¼ä½¿ç”¨ã€‚å› æ­¤æ¡†æ¶å†…å‡ ä¹æ²¡æœ‰å¯¹å›ºå®šæŸä¸ªç»„ä»¶çš„ä¾èµ–ï¼Œå…¨éƒ¨é‡‡ç”¨ api çš„æ–¹å¼ã€‚ä½ å¯ä»¥è‡ªå·±å®ç°å…¶ log æ¨¡å—ï¼Œæˆ–å…¶æœåŠ¡æ³¨å†ŒæœåŠ¡å‘ç°æ¨¡å—ã€‚ 4.6.1 è¯´ç‚¹ rpc ç›¸å…³çš„ å¾®æœåŠ¡ä¹‹é—´çš„é€šä¿¡ä¸€èˆ¬æ˜¯ä»¥ rpc çš„æ–¹å¼ï¼Œä¸€èˆ¬æˆ‘ä»¬å¸¸å¬è¿‡çš„ rpc æœ‰ï¼š Dubboï¼šé˜¿é‡Œæ¨å‡ºçš„ rpc æ¡†æ¶ï¼Œä»…æ”¯æŒJava Tarsï¼šè…¾è®¯æ¨å‡ºçš„ rpc æ¡†æ¶ï¼Œä»…æ”¯æŒJava Spring Cloudï¼šPivotal å…¬å¸æ¨å‡ºçš„ rpc æ¡†æ¶ï¼Œä»…æ”¯æŒ Java ä¸Šè¿°å‡ ä¸ª rpc æ¡†æ¶éƒ½æ˜¯åœ¨ç‰¹å®šçš„è¯­è¨€èŒƒå›´å†…ï¼Œå¯¹äºæ•´ä¸ªå¾®æœåŠ¡ä½“ç³»åªæœ‰ä¸€ç§è¯­è¨€çš„æƒ…å†µä¸‹æ‰èƒ½ä½¿ç”¨ï¼Œå¦‚æœè·¨è¯­è¨€åªèƒ½é é€šç”¨çš„ http ç­‰åè®®å»é€šä¿¡ã€‚ä½†æ˜¯è¶Šæ¥è¶Šå¤šçš„çš„å¾®æœåŠ¡æ¶æ„å†…ä¸æ­¢åªæœ‰ java ä¸€ç§è¯­è¨€ï¼Œæ‰€ä»¥è·¨è¯­è¨€çš„ rpc æ¡†æ¶ä¹Ÿæ˜¯ä¸å¯ç¼ºå°‘çš„ã€‚ gRPCï¼šGoogle æ¨å‡ºçš„ rpc æ¡†æ¶ï¼Œæ”¯æŒå¤§éƒ¨åˆ†ä¸»æµè¯­è¨€ Thriftï¼šApache åŸºé‡‘ä¼šçš„å¼€æºé¡¹ç›®ï¼Œä¹Ÿæ˜¯æ”¯æŒå¤§éƒ¨åˆ†ä¸»æµè¯­è¨€ åœ¨ Go è¯­è¨€ç¯å¢ƒä¸‹ï¼ŒgRPC æ— éæ˜¯æœ€å¥½çš„é€‰æ‹©ï¼Œå†µä¸”é€‰æ‹©å¾ˆå¤šä¸»æµçš„å¼€æºé¡¹ç›®éƒ½æ”¯æŒ gRPCï¼Œå…¶é€‚ç”¨é¢è¿˜æ˜¯å¾ˆå¹¿çš„ã€‚ åœ¨ä¸åŒå¾®æœåŠ¡ä¹‹é—´ï¼Œå…±åŒç»´æŠ¤ä¸€ä¸ª proto buffer æ–‡ä»¶ï¼ˆgRPC çš„é€šä¿¡ç¼–ç åè®®ï¼‰ï¼ŒæœåŠ¡é€šè¿‡protoc å·¥å…·ç”Ÿæˆå„è‡ªè¯­è¨€çš„ä»£ç ï¼Œä»è€Œå¯ä»¥è¾¾åˆ°æœåŠ¡ä¹‹é—´çš„ rpc è°ƒç”¨ã€‚ ä»¥ä¸€ä¸ªå‘é€æ¶ˆæ¯çš„æ¥å£å®šä¹‰ä¸ºä¾‹ï¼š // Ignore file header message QueryOfflineMessageReq { string user_id = 1; string last_msg_seq = 2; bool onlyCount = 3; int32 page = 4; int32 page_size = 5; } message QueryOfflineMessageResp { transport.response.BaseResponse response = 1; int32 total = 2; repeated BriefMessage messages = 3; } service OfflineMessage { rpc QueryOfflineMessage(QueryOfflineMessageReq) returns (QueryOfflineMessageResp); } è¿™å—å®šä¹‰å¯ä»¥é€šè¿‡ protoc ç”Ÿæˆ Go è¯­è¨€çš„ä»£ç ï¼ŒåŒ…æ‹¬ struct å®šä¹‰ä»¥åŠrpc æ–¹æ³•çš„å®šä¹‰å’Œ client ç«¯è°ƒç”¨è¯¥ rpc æ–¹æ³•çš„ä»£ç ã€‚ç”±äºä»£ç é‡æ¯”è¾ƒå¤šï¼Œè¿™é‡Œæ”¾ä¸€ä¸ªè·³è½¬åœ°å€ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è·³è½¬æŸ¥çœ‹ã€‚ ","date":"2022-05-14","objectID":"/posts/what-is-microservices/:4:6","tags":["å¾®æœåŠ¡","ç³»åˆ—ç¯‡"],"title":"[ç³»åˆ—]å¾®æœåŠ¡Â·ä»€ä¹ˆæ˜¯å¾®æœåŠ¡","uri":"/posts/what-is-microservices/"},{"categories":["microservice"],"content":"5. æ€»ç»“ æœ¬ç¯‡ç¯‡å¹…è¾ƒé•¿ï¼Œç”±äºå¾®æœåŠ¡æ¶‰åŠåˆ°çš„é¢æ¯”è¾ƒå¹¿ï¼Œå†µä¸”æˆ‘æƒ³å°½é‡å†™çš„å…¨é¢ä¸€ç‚¹ï¼Œå°±å†™çš„æœ‰ç‚¹å¤šäº†ã€‚è¿™é‡Œå¯¹æœ¬ç¯‡çš„å†…å®¹åšä¸ªç®€å•çš„æ€»ç»“ï¼š è®²è¿°å·¨çŸ³æ¶æ„ vs å¾®æœåŠ¡æ¶æ„ è®²è¿°ä¸ºä»€ä¹ˆæ˜¯å¾®æœåŠ¡æ¶æ„ï¼Œæ˜¯ä»€ä¹ˆä¿ƒæˆäº†å¾®æœåŠ¡çš„å‘å±• å¾®æœåŠ¡çš„æ ¸å¿ƒç†å¿µæœ‰å“ªäº› å¾®æœåŠ¡æ ¸å¿ƒç»„ä»¶çš„ä»‹ç» æœåŠ¡å‘ç°æœåŠ¡æ³¨å†Œ é…ç½®ä¸­å¿ƒ æœåŠ¡çš„æ„å»ºå’Œéƒ¨ç½² æœåŠ¡çš„è§‚æµ‹ API ç½‘å…³ å¾®æœåŠ¡æ¡†æ¶ \u0026 rpc æ¡†æ¶ \u0026 gRPC æœ¬ç¯‡æ˜¯æˆ‘ä¸ªäººå¯¹å¾®æœåŠ¡çš„ä¸€ç‚¹ç†è§£ï¼Œè‹¥æœ‰æˆ‘ç†è§£é”™æˆ–è€…æ¯”æˆ‘æ›´å¥½çš„ç†è§£ï¼Œæ¬¢è¿ä¸‹é¢è¯„è®ºè®¨è®ºã€‚ ","date":"2022-05-14","objectID":"/posts/what-is-microservices/:5:0","tags":["å¾®æœåŠ¡","ç³»åˆ—ç¯‡"],"title":"[ç³»åˆ—]å¾®æœåŠ¡Â·ä»€ä¹ˆæ˜¯å¾®æœåŠ¡","uri":"/posts/what-is-microservices/"},{"categories":["microservice"],"content":"6. é“¾æ¥ğŸ”— https://jimmysong.io/kubernetes-handbook/practice/opentracing.html https://github.com/yusank/goim https://opentelemetry.io/docs/ https://www.elastic.co/what-is/elk-stack https://clickvisual.gocn.vip/ https://prometheus.io/ https://grafana.com/ asim/go-micro go-kratos/kratos ","date":"2022-05-14","objectID":"/posts/what-is-microservices/:6:0","tags":["å¾®æœåŠ¡","ç³»åˆ—ç¯‡"],"title":"[ç³»åˆ—]å¾®æœåŠ¡Â·ä»€ä¹ˆæ˜¯å¾®æœåŠ¡","uri":"/posts/what-is-microservices/"},{"categories":["microservice"],"content":" æœ¬æ–‡ä¸ºç³»åˆ—ç¯‡å¾®æœåŠ¡çš„å¼€ç¯‡æ–‡ç« ï¼Œè®²è¿°æœ¬ç³»åˆ—çš„å¼€ç¯‡èƒŒæ™¯ã€æ ¸å¿ƒå†…å®¹ã€æ¶‰åŠåˆ°çš„æ–¹å‘ä»¥åŠå¾€åçš„è§„åˆ’ã€‚ ","date":"2022-05-04","objectID":"/posts/microservices-introduction/:0:0","tags":["å¾®æœåŠ¡","ç³»åˆ—ç¯‡"],"title":"[ç³»åˆ—]å¾®æœåŠ¡Â·å¼€ç¯‡ä»‹ç»","uri":"/posts/microservices-introduction/"},{"categories":["microservice"],"content":"å‰è¨€ å…³äºå¾®æœåŠ¡å…¶å®æˆ‘å‰å‰ååå­¦ä¹ äº†è§£ä½¿ç”¨æœ‰å‡ å¹´çš„æ—¶é—´äº†ï¼Œä¹‹å‰ä¹ŸçŸ­æš‚çš„å·¥ä½œæ–¹å‘ä¹Ÿæ˜¯å¾®æœåŠ¡æ¡†æ¶çš„å¼€å‘æ–¹å‘ã€‚å¹¶ä¸”å»å¹´å¹´åº•å…¶å®ä»¥åŠå¼€å§‹è®¡åˆ’å†™è¿™ç³»åˆ—æ–‡ç« äº†ï¼Œä½†æ˜¯è¿Ÿè¿Ÿæ²¡æœ‰å¼€å§‹åœ¨åšèµ·æ¥ã€‚å¾®æœåŠ¡è¿™ä¸ªæ¦‚å¿µå·²ç»æ˜¯ä¸€ä¸ªçƒ‚å¤§è¡—çš„æ¦‚å¿µäº†ï¼Œå¤§éƒ¨åˆ†ç¨‹åºå‘˜éƒ½å¯¹è¿™ä¸ªæ¦‚å¿µæœ‰æ¯”è¾ƒæ¸…æ™°çš„æ¦‚å¿µï¼Œæˆ‘è¿™é‡Œä¸»è¦æ˜¯æƒ³æŠŠè‡ªå·±çš„ç†è§£å’Œä¸€äº›å¿ƒå¾—åˆ†äº«å‡ºæ¥ï¼Œä¸€æ˜¯ç»™è‡ªå·±ä¸€ä¸ªç»éªŒç§¯ç´¯ï¼ŒäºŒæ˜¯ç»™ä¸€ä¸ªæ–°å…¥è¡Œæˆ–è€…åƒå¯¹å¾®æœåŠ¡æœ‰è¾ƒæ·±çš„ç†è§£çš„åŒè¡Œä»¬ä¸€ä¸ªå¯å‘æˆ–è€…ä¸€ä¸ç‚¹å¸®åŠ©ã€‚ è‡³äºä¸ºä»€ä¹ˆæ²¡æœ‰åšèµ·æ¥æˆ‘èƒ½æƒ³åˆ°çš„åŸå› ä¸ºæ— éä»¥ä¸‹å‡ ä¸ªï¼š å½“æ—¶åœ¨å†™ Redis Server ç”¨ Go è¯­è¨€å®ç°çš„é¡¹ç›®ï¼Œæœ‰è¶³å¤Ÿçš„å†™åšå®¢çš„ç´ æ(ç‚¹å‡»æŸ¥çœ‹Redis ç³»åˆ—ç¯‡) å½“æ—¶æ²¡æœ‰ä¸€ä¸ªç°æˆçš„æˆ–è€…ä¹‹å‰å®Œæ•´çš„ä¸€ä¸ªå¾®æœåŠ¡é¡¹ç›®çš„ç»å†å’Œæºç ï¼Œä»æ¥è§¦å¾®æœåŠ¡åˆ°ç°åœ¨å¤§éƒ¨åˆ†æ—¶é—´éƒ½æ˜¯çœ‹ä»–äººæ–‡ç« å»æˆ–è€…å»çœ‹æºç ç†è§£åº•å±‚å®ç°ï¼Œè™½ç„¶å†™äº†ä¸€ä¸ªåˆç‰ˆçš„å¾®æœåŠ¡æ¡†æ¶ï¼Œä½†æ˜¯ç”±äºæ˜¯å·¥ä½œä¸Šçš„é¡¹ç›®ï¼Œæ²¡åŠæ³•æ‹¿å‡ºæ¥åˆ†äº«ã€‚å› æ­¤æ²¡æœ‰ä¸€ä¸ªé¡¹ç›®æ¥æ”¯æ’‘æˆ‘çš„ç³»åˆ—æ–‡ç«  è€Œåˆ°ç›®å‰è¿™ä¸ªæ—¶é—´çš„æ—¶å€™ï¼Œå…¶å®æˆ‘å·²ç»åœ¨å†™ä¸€ä¸ªé¡¹ç›®æ¥è¿‘ 3 ä¸ªæœˆäº†ï¼Œå¹¶ä¸”åŸºç¡€åŠŸèƒ½ä¹Ÿå·²ç»å®ç°ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹æˆ‘è§‰å¾—æˆ‘å¯ä»¥é‡å¯æˆ‘è¿™ç³»åˆ—æ–‡ç« æ¥æŠŠæˆ‘ä¹‹å‰çš„ç§¯ç´¯ä»¥åŠè¿™æ¬¡å¼€å‘è¿‡ç¨‹ä¸­çš„å¿ƒå¾—åšå‡ºä¸€ä¸ªæ€»ç»“ã€‚ é¡¹ç›®é“¾æ¥ï¼šhttps://github.com/yusank/goim ä¹Ÿå¯ä»¥ç‚¹å‡»å³ä¸Šè§’ GoIM è·³è½¬æŸ¥çœ‹è¯¥é¡¹ç›®çš„é¡¹ç›®æ–‡æ¡£ ","date":"2022-05-04","objectID":"/posts/microservices-introduction/:1:0","tags":["å¾®æœåŠ¡","ç³»åˆ—ç¯‡"],"title":"[ç³»åˆ—]å¾®æœåŠ¡Â·å¼€ç¯‡ä»‹ç»","uri":"/posts/microservices-introduction/"},{"categories":["microservice"],"content":"æ ¸å¿ƒå†…å®¹ è¯¥ç³»åˆ—ç¯‡åœ¨æˆ‘ä¹‹å‰è®¡åˆ’çš„ç»“æœæ–¹å‘ä¹‹å¤–åœ¨å¼€å‘è¿‡ç¨‹ä¸­æˆ‘å¯èƒ½ä¼šæ–°å¢ä¸€äº›ç›¸å…³æ–¹å‘çš„æ–‡ç« ï¼Œå°½å¯èƒ½æŠŠå¾®æœåŠ¡çš„æ ¸å¿ƒæ¦‚å¿µã€æ€è·¯ä»¥åŠå¸¸ç”¨çš„ç»„ä»¶éƒ½æ¶‰åŠåˆ°ã€‚ ç›®å‰æƒ³å¥½çš„æ–¹å‘æœ‰ä»¥ä¸‹ï¼š å¾®æœåŠ¡æ ¸å¿ƒæ¦‚å¿µå’Œè§£å†³çš„é—®é¢˜ å¾®æœåŠ¡çš„æœåŠ¡å‘ç°ä¸æœåŠ¡æ³¨å†Œ å¾®æœåŠ¡çš„é…ç½®ç®¡ç† å¾®æœåŠ¡çš„æ—¥å¿—ç®¡ç† å¾®æœåŠ¡çš„ç›‘æ§å‘Šè­¦ å¾®æœåŠ¡ä¸­ DB çš„ä½¿ç”¨å’Œç®¡ç† å¾®æœåŠ¡ä¸­æœåŠ¡ä¹‹é—´æ•°æ®å…±äº«é—®é¢˜ï¼ˆmqï¼Œredis ç­‰æ–¹å‘ï¼‰ å¾®æœåŠ¡çš„æ„å»ºéƒ¨ç½²é—®é¢˜ ","date":"2022-05-04","objectID":"/posts/microservices-introduction/:2:0","tags":["å¾®æœåŠ¡","ç³»åˆ—ç¯‡"],"title":"[ç³»åˆ—]å¾®æœåŠ¡Â·å¼€ç¯‡ä»‹ç»","uri":"/posts/microservices-introduction/"},{"categories":["microservice"],"content":"æ–‡ç« ä¼ é€é—¨ ä»€ä¹ˆæ˜¯å¾®æœåŠ¡(æœªå‘å¸ƒ) æœåŠ¡æ³¨å†ŒæœåŠ¡å‘ç°(æœªå‘å¸ƒ) é…ç½®ç®¡ç†(æœªå‘å¸ƒ) æ—¥å¿—(æœªå‘å¸ƒ) ç›‘æ§å‘Šè­¦(æœªå‘å¸ƒ) DB(æœªå‘å¸ƒ) æ•°æ®å…±äº«(æœªå‘å¸ƒ) æ„å»ºéƒ¨ç½²(æœªå‘å¸ƒ) å¾…è¡¥å…… ","date":"2022-05-04","objectID":"/posts/microservices-introduction/:3:0","tags":["å¾®æœåŠ¡","ç³»åˆ—ç¯‡"],"title":"[ç³»åˆ—]å¾®æœåŠ¡Â·å¼€ç¯‡ä»‹ç»","uri":"/posts/microservices-introduction/"},{"categories":["GoIM"],"content":" è½¬è½½ åŸæ–‡é“¾æ¥ï¼š å®ç°å¼‚æ­¥å¹¶å‘ worker é˜Ÿåˆ— åœ¨å¼€å‘ broadcast åŠŸèƒ½çš„æ—¶å€™ï¼Œç¢°åˆ°ä¸€ä¸ªæ¯”è¾ƒæ£˜æ‰‹çš„é—®é¢˜ï¼Œéœ€è¦å¹¶å‘æ‰§è¡Œå¤šä¸ª worker æ¥è®² broadcast æ¶ˆæ¯æ¨é€åˆ°æ‰€æœ‰åœ¨çº¿ç”¨æˆ·ï¼ŒåŒæ—¶æˆ‘å¸Œæœ›èƒ½æ§åˆ¶å¹¶å‘æ•°é‡ã€‚ ","date":"2022-04-01","objectID":"/posts/goim-worker-pool/:0:0","tags":["goim","go","worker","è½¬è½½"],"title":"[GoIM] å®ç°å¼‚æ­¥å¹¶å‘ worker é˜Ÿåˆ—","uri":"/posts/goim-worker-pool/"},{"categories":["GoIM"],"content":"å‰è¨€ ä»¥å¾€é‡åˆ°ç±»ä¼¼çš„é—®é¢˜æˆ‘éƒ½ä¼šå€ŸåŠ© sync.WaitGroup åŠ  channel çš„æ–¹å¼å»åšï¼Œå®ç°æ–¹å¼ä¹Ÿæ¯”è¾ƒç®€å•ã€‚å¤§è‡´æ€è·¯å¦‚ä¸‹ï¼š type LimitedWaitGroup struct { wg *sync.WaitGroup ch chan int } func NewLimitedWaitGroup(size int) *LimitedWaitGroup { return \u0026LimitedWaitGroup{ wg : new(sync.WaitGroup), ch : make(chan int, size) } } func (w *LimitedWaitGroup) Add(f func()) { // wait if channel is full w.ch \u003c- 1 w.wg.Add(1) go func() { defer w.done() f() }() } func (w *LimitedWaitGroup) done() { \u003c-w.ch w.wg.Done() } func (w *LimitedWaitGroup) Wait() { w.wg.Wait() } è¿™æ ·èƒ½è§£å†³æˆ‘å¤§éƒ¨åˆ†çš„ç®€å•éœ€æ±‚ï¼Œä½†æ˜¯ç°åœ¨æˆ‘æƒ³è¦çš„èƒ½åŠ›ç”¨è¿™ä¸ªç®€å•çš„ LimitedWaitGroup æ— æ³•å®Œå…¨æ»¡è¶³ï¼Œæ‰€ä»¥é‡æ–°è®¾è®¡äº†ä¸€ä¸ª worker pool çš„æ¦‚å¿µæ¥æ»¡è¶³æˆ‘ç°åœ¨ä»¥åŠä»¥åç±»ä¼¼çš„éœ€æ±‚ã€‚ ","date":"2022-04-01","objectID":"/posts/goim-worker-pool/:1:0","tags":["goim","go","worker","è½¬è½½"],"title":"[GoIM] å®ç°å¼‚æ­¥å¹¶å‘ worker é˜Ÿåˆ—","uri":"/posts/goim-worker-pool/"},{"categories":["GoIM"],"content":"è®¾è®¡ ","date":"2022-04-01","objectID":"/posts/goim-worker-pool/:2:0","tags":["goim","go","worker","è½¬è½½"],"title":"[GoIM] å®ç°å¼‚æ­¥å¹¶å‘ worker é˜Ÿåˆ—","uri":"/posts/goim-worker-pool/"},{"categories":["GoIM"],"content":"éœ€æ±‚æ•´ç† é¦–å…ˆå°†ç›®å‰æƒ³åˆ°çš„éœ€æ±‚ä»¥åŠå…¶ä¼˜å…ˆçº§åˆ—å‡ºæ¥ï¼š é«˜ä¼˜å…ˆçº§ï¼š worker pool æ”¯æŒè®¾ç½® sizeï¼Œé˜²æ­¢ worker æ— é™å¢å¤š ä»»åŠ¡å¹¶å‘æ‰§è¡Œä¸”èƒ½æŒ‡å®šå¹¶å‘æ•° å½“ worker è¾¾åˆ°ä¸Šçº¿æ—¶ï¼Œæ–°çš„ä»»åŠ¡åœ¨ä¸€å®šèŒƒå›´å†…æ”¯æŒæ’é˜Ÿç­‰å¾…ï¼ˆå³ limited queueï¼‰ æ”¯æŒæ•è·ä»»åŠ¡é”™è¯¯ æ’é˜Ÿä¸­çš„ä»»åŠ¡åº”è¯¥æŒ‰é¡ºåºè°ƒåº¦æ‰§è¡Œ ä½ä¼˜å…ˆçº§ï¼š ä»»åŠ¡æ”¯æŒå®æ—¶çŠ¶æ€æ›´æ–° ä»»åŠ¡å¯ä»¥å¤–éƒ¨ç­‰å¾…å®Œæˆï¼ˆç±»ä¼¼ waitGroup.Done() ï¼‰ å½“ç©ºé—² worker å°äºæŒ‡å®šå¹¶å‘æ•°æ—¶ï¼Œæ”¯æŒå ç”¨ç©ºé—² worker éƒ¨åˆ†è¿è¡Œï¼ˆå¦‚å½“å‰å‰©ä½™ 3 ä¸ª worker å¯ç”¨ï¼Œä½†æ˜¯æ–°çš„ä»»åŠ¡éœ€è¦ 5 ä¸ªå¹¶å‘ï¼Œåˆ™å°è¯•å…ˆå ç”¨è¿™ 3 ä¸ªworkerï¼Œå¹¶åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ç»§ç»­ç›‘å¬ pool ç©ºé—²å‡ºæ¥çš„ worker å¹¶å°è¯•å»å ç”¨ï¼‰ å°ç»“ å°ç»“ åˆ—å‡ºå®Œéœ€æ±‚åŠå…¶ä¼˜å…ˆçº§åï¼Œç»è¿‡è€ƒè™‘å†³å®šï¼Œé«˜ä¼˜å…ˆçº§é™¤äº†ç¬¬äº”æ¡, ä½ä¼˜å…ˆçº§é™¤äº†ç¬¬ä¸‰æ¡, å…¶ä»–éœ€æ±‚éƒ½åœ¨ç›®å‰ç‰ˆæœ¬é‡Œå®ç°ã€‚ åŸå› å¦‚ä¸‹ï¼š é¦–å…ˆè¯´ä½ä¼˜å…ˆçº§ç¬¬ä¸‰æ¡ï¼Œè¿™å—çš„éƒ¨åˆ†è°ƒåº¦æ‰§è¡Œ workerï¼Œç›®å‰æ²¡æœ‰æƒ³å¥½æ¯”è¾ƒä¼˜é›…çš„å®ç°æ–¹å¼ï¼Œæ‰€ä»¥æš‚æ—¶æ²¡æœ‰å®ç°ï¼ˆä½†æ˜¯ä¸‹ä¸ªç‰ˆæœ¬ä¼šå®ç°ï¼‰ é«˜ä¼˜å…ˆçº§çš„ç¬¬äº”æ¡ä¹Ÿæ˜¯è·Ÿè°ƒåº¦æœ‰ç‚¹å…³ç³»ï¼Œå¦‚æœé˜Ÿåˆ—é‡Œé å‰çš„ä»»åŠ¡éœ€è¦å¤§é‡çš„ workerï¼Œé‚£å¾ˆå®¹æ˜“é€ æˆé˜»å¡ï¼Œåé¢çš„ task ä¸€ç›´æ²¡åŠæ³•æ‰§è¡Œï¼Œå³ä¾¿éœ€è¦å¾ˆå°‘çš„ workerã€‚æ‰€ä»¥ç­‰éƒ¨åˆ†è°ƒåº¦æ‰§è¡Œå¼€å‘å®Œå†æŠŠä»»åŠ¡æŒ‰éœ€æ‰§è¡Œæ‰“å¼€ã€‚ ","date":"2022-04-01","objectID":"/posts/goim-worker-pool/:2:1","tags":["goim","go","worker","è½¬è½½"],"title":"[GoIM] å®ç°å¼‚æ­¥å¹¶å‘ worker é˜Ÿåˆ—","uri":"/posts/goim-worker-pool/"},{"categories":["GoIM"],"content":"Task Definition task è¡¨ç¤ºä¸€æ¬¡ä»»åŠ¡ï¼ŒåŒ…å«äº†ä»»åŠ¡æ‰§è¡Œçš„æ–¹æ³•ï¼Œå¹¶å‘æ•°ï¼Œæ‰€å±çš„ workerSetä»¥åŠæ‰§è¡ŒçŠ¶æ€ç­‰ã€‚ type TaskFunc func() error type task struct { tf TaskFunc // task function concurrence int // concurrence of task ws *workerSet // assign value after task distribute to worker. status TaskStatus // store task status. } // TaskStatus is the status of task. type TaskStatus int ","date":"2022-04-01","objectID":"/posts/goim-worker-pool/:2:2","tags":["goim","go","worker","è½¬è½½"],"title":"[GoIM] å®ç°å¼‚æ­¥å¹¶å‘ worker é˜Ÿåˆ—","uri":"/posts/goim-worker-pool/"},{"categories":["GoIM"],"content":"Worker Definition worker ä½œä¸ºæœ€å°è°ƒåº¦å•å…ƒï¼Œä»…åŒ…å« workerSet å’Œ error . type worker struct { ws *workerSet err error } ","date":"2022-04-01","objectID":"/posts/goim-worker-pool/:2:3","tags":["goim","go","worker","è½¬è½½"],"title":"[GoIM] å®ç°å¼‚æ­¥å¹¶å‘ worker é˜Ÿåˆ—","uri":"/posts/goim-worker-pool/"},{"categories":["GoIM"],"content":"TaskResult Definition TaskResult æ˜¯ä¸€ä¸ªå¯¹å¤–æš´éœ²çš„ interface, ç”¨äºå¤–éƒ¨è°ƒç”¨è€…è·å–å’Œç®¡ç†ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€ä¿¡æ¯ã€‚ // TaskResult is a manager of submitted task. type TaskResult interface { // get error if task failed. Err() error // wait for task done. Wait() // get task status. Status() TaskStatus // kill task. Kill() } æ³¨æ„ task å’Œ TaskStatus åˆ†åˆ«å®ç° TaskResult çš„æ¥å£ï¼Œä»è€Œå¤–éƒ¨ç»Ÿä¸€æ‹¿åˆ° TaskResult ä¹‹æ‰€ä»¥ TaskStatus ä¹Ÿéœ€è¦å®ç° TaskResult æ˜¯å› ä¸ºéƒ¨åˆ†æƒ…å†µä¸‹ï¼Œä¸éœ€è¦åˆ›å»º task ç›´æ¥è¿”å›é”™è¯¯çŠ¶æ€å³å¯ã€‚å¦‚ï¼š æäº¤çš„ä»»åŠ¡çš„å¹¶å‘æ•°è¿‡é«˜ï¼ˆè¶…è¿‡ pool çš„ sizeï¼‰ï¼Œå½“å‰ queue å·²æ»¡ä¸èƒ½å†å¤„ç†ä»»ä½•å…¶ä»–ä»»åŠ¡äº†ï¼Œè¿™ç§æƒ…å†µç›´æ¥è¿”å›å¯¹åº”çš„çŠ¶æ€ç ã€‚ ","date":"2022-04-01","objectID":"/posts/goim-worker-pool/:2:4","tags":["goim","go","worker","è½¬è½½"],"title":"[GoIM] å®ç°å¼‚æ­¥å¹¶å‘ worker é˜Ÿåˆ—","uri":"/posts/goim-worker-pool/"},{"categories":["GoIM"],"content":"WorkerSet Definition workerSet ä¸ºä¸€ç»„ workerçš„é›†åˆï¼Œä½œç”¨æ˜¯è°ƒåº¦ worker å¹¶ç»´æŠ¤èµ·æ‰€å± task çš„æ•´ä¸ªç”Ÿå‘½è¿‡ç¨‹. // workerSet represent a group of task handle workers type workerSet struct { task *task runningWorker atomic.Int32 workers []*worker ctx context.Context cancel context.CancelFunc wg *sync.WaitGroup } ","date":"2022-04-01","objectID":"/posts/goim-worker-pool/:2:5","tags":["goim","go","worker","è½¬è½½"],"title":"[GoIM] å®ç°å¼‚æ­¥å¹¶å‘ worker é˜Ÿåˆ—","uri":"/posts/goim-worker-pool/"},{"categories":["GoIM"],"content":"WorkerPool Definition Pool æ˜¯ä¸€ä¸ªå¯æŒ‡å®š size çš„ worker pool. å¯å¹¶å‘è¿è¡Œå¤šä¸ª task å¹¶ä¸”æ”¯æŒé¢å¤–çš„ä»»åŠ¡æ’é˜Ÿèƒ½åŠ›ã€‚ // Pool is a buffered worker pool type Pool struct { // TODO: taskQueue should be a linked list, so that we can get the task from the head of the list and put it back to the head. // If we use a channel as taskQueue, we can't get the task from the head of the list and put it back to the head. // But make sure that before change it to linked list, we should have the ability run the task in min(taskQueue length, concurrence) goroutines. taskQueue chan *task enqueuedTaskCount atomic.Int32 // count of unhandled tasks bufferSize int // size of taskQueue buffer, means can count of bufferSize task can wait to be handled maxWorker int // count of how many worker run in concurrence workerSets []*workerSet lock *sync.Mutex stopFlag atomic.Bool } ","date":"2022-04-01","objectID":"/posts/goim-worker-pool/:2:6","tags":["goim","go","worker","è½¬è½½"],"title":"[GoIM] å®ç°å¼‚æ­¥å¹¶å‘ worker é˜Ÿåˆ—","uri":"/posts/goim-worker-pool/"},{"categories":["GoIM"],"content":"å®ç° ä¸Šé¢å·²ç»ç¡®å®šéœ€è¦çš„èƒ½åŠ›å’ŒåŸºç¡€çš„æ•°æ®ç»“æ„äº†ï¼Œä¸‹é¢ä¸€ä¸ªä¸ªå»å®ç°å„ä¸ªæ¨¡å—çš„èƒ½åŠ›ã€‚ ","date":"2022-04-01","objectID":"/posts/goim-worker-pool/:3:0","tags":["goim","go","worker","è½¬è½½"],"title":"[GoIM] å®ç°å¼‚æ­¥å¹¶å‘ worker é˜Ÿåˆ—","uri":"/posts/goim-worker-pool/"},{"categories":["GoIM"],"content":"Worker Implement worker èƒ½åŠ›ç›¸å¯¹çº¯ç²¹ï¼Œçœ‹çœ‹ worker æ˜¯å¦‚ä½•å·¥ä½œçš„: func (w *worker) run() { defer w.ws.done() var ec = make(chan error, 1) defer close(ec) go func() { ec \u003c- w.ws.task.tf() }() select { case e := \u003c-ec: w.err = e case \u003c-w.ws.ctx.Done(): } } ","date":"2022-04-01","objectID":"/posts/goim-worker-pool/:3:1","tags":["goim","go","worker","è½¬è½½"],"title":"[GoIM] å®ç°å¼‚æ­¥å¹¶å‘ worker é˜Ÿåˆ—","uri":"/posts/goim-worker-pool/"},{"categories":["GoIM"],"content":"WorkerSet Implement workerSet è°ƒåº¦ workerï¼Œè®°å½• worker è¿è¡ŒçŠ¶æ€ç­‰ã€‚ func newWorkerSet(ctx context.Context, t *task) *workerSet { // åˆå§‹åŒ–å‚æ•° // ... çœç•¥ä»£ç  return ws } func (ws *workerSet) run() { ws.task.updateStatus(TaskStatusRunning) for _, w := range ws.workers { ws.addOne() go w.run() } } func (ws *workerSet) stopAll() { ws.cancel() ws.task.updateStatus(TaskStatusKilled) } // err returns the first error that occurred in the workerSet. func (ws *workerSet) err() error { // ...çœç•¥ä»£ç  return nil } func (ws *workerSet) getRunningWorker() int { return int(ws.runningWorker.Load()) } // done called when worker stop. func (ws *workerSet) done() { ws.addRunningWorker(-1) ws.wg.Done() if ws.getRunningWorker() == 0 { ws.task.updateStatus(TaskStatusDone) } } // addOne called when worker start running. func (ws *workerSet) addOne() { ws.addRunningWorker(1) ws.wg.Add(1) } func (ws *workerSet) wait() { ws.wg.Wait() } ","date":"2022-04-01","objectID":"/posts/goim-worker-pool/:3:2","tags":["goim","go","worker","è½¬è½½"],"title":"[GoIM] å®ç°å¼‚æ­¥å¹¶å‘ worker é˜Ÿåˆ—","uri":"/posts/goim-worker-pool/"},{"categories":["GoIM"],"content":"Task Implement task ä¸»è¦æ˜¯è®°å½• task çš„çŠ¶æ€ï¼Œå¹¶é€šè¿‡ workerSet æ§åˆ¶å…¶ä¸‹çš„ worker. func newTask(tf TaskFunc, concurrence int) *task { return \u0026task{ tf: tf, concurrence: concurrence, } } // Err returns the first error that occurred in the workerSet. func (t *task) Err() error { // check t.ws if nil return nil. if t.ws == nil { return nil } return t.ws.err() } // Wait for task done. // Please make sure task is done or running before call this function. func (t *task) Wait() { // check t.ws if nil. if t.ws == nil { return } t.ws.wait() } // Status returns task status. func (t *task) Status() TaskStatus { return t.status } // Kill task. func (t *task) Kill() { // check t.ws if nil. if t.ws == nil { return } t.ws.stopAll() } func (t *task) assignWorkerSet(ws *workerSet) { t.ws = ws } func (t *task) updateStatus(status TaskStatus) { t.status = status } ","date":"2022-04-01","objectID":"/posts/goim-worker-pool/:3:3","tags":["goim","go","worker","è½¬è½½"],"title":"[GoIM] å®ç°å¼‚æ­¥å¹¶å‘ worker é˜Ÿåˆ—","uri":"/posts/goim-worker-pool/"},{"categories":["GoIM"],"content":"TaskStatus Implement TaskStatus è™½ç„¶å®ç°äº† TaskResult æ¥å£ï¼Œä½†æ˜¯ä¸èƒ½æ§åˆ¶ä»»ä½• taskï¼Œå…¶æœ‰æ•ˆçš„æ–¹æ³•åªæœ‰ Status() å’Œ Err() func (t TaskStatus) Error() string { return t.String() } func (t TaskStatus) Err() error { switch t { case TaskStatusError, TaskStatusQueueFull, TaskStatusTooManyWorker, TaskStatusPoolClosed, TaskStatusKilled: return t } return nil } func (t TaskStatus) Wait() { // do nothing. } func (t TaskStatus) Status() TaskStatus { return t } func (t TaskStatus) Kill() { // do nothing. } ","date":"2022-04-01","objectID":"/posts/goim-worker-pool/:3:4","tags":["goim","go","worker","è½¬è½½"],"title":"[GoIM] å®ç°å¼‚æ­¥å¹¶å‘ worker é˜Ÿåˆ—","uri":"/posts/goim-worker-pool/"},{"categories":["GoIM"],"content":"Pool Implement Pool æ˜¯æ€»çš„å…¥å£ï¼Œä»»åŠ¡ä¼šæäº¤åˆ° Pool, å¹¶ç”± Pool åˆ›å»º task å¹¶è°ƒåº¦åˆ° workerSet ä¸Šï¼ŒåŒæ—¶å®šæ—¶æ¸…ç†å·²å®Œæˆçš„ workerSet, ç¡®ä¿ç©ºé—² worker èƒ½è¢«åˆç†ä½¿ç”¨ã€‚ func NewPool(workerSize, queueSize int) *Pool { // ... åˆå§‹åŒ–å„ä¸ªå‚æ•° // check p.enqueue to find out why make this channel size with p.bufferSize+1. // p.taskQueue = make(chan *task, p.bufferSize+1) // å¯åŠ¨å•ç‹¬ goroutine ç»´æŠ¤é˜Ÿåˆ— go p.consumeQueue() return p } func (p *Pool) Submit(ctx context.Context, tf TaskFunc, concurrence int) TaskResult { if p.stopFlag.Load() { return TaskStatusPoolClosed } if concurrence \u003e p.maxWorker { return TaskStatusTooManyWorker } // check if there has any worker place left p.lock.Lock() defer p.lock.Unlock() t := newTask(tf, concurrence) if p.tryRunTask(ctx, t) { return t } if p.enqueueTask(t, true) { return t } return TaskStatusQueueFull } func (p *Pool) Stop() { // å…³é—­é˜Ÿåˆ—å’Œæ­£åœ¨è¿è¡Œçš„ workerSet } // tryRunTask try to put task into workerSet and run it.Return false if capacity not enough. // Make sure get p.Lock before call this func func (p *Pool) tryRunTask(ctx context.Context, t *task) bool { if p.curRunningWorkerNum()+t.concurrence \u003c= p.maxWorker { ws := newWorkerSet(ctx, t) p.workerSets = append(p.workerSets, ws) // run ä¸ºå¼‚æ­¥æ–¹æ³• ws.run() return true } return false } // curRunningWorkerNum get current running worker num // make sure lock mutex before call this func func (p *Pool) curRunningWorkerNum() int { // ...çœç•¥ä»£ç  return cnt } // enqueueTask put task to queue. // p.enqueuedTaskCount increase 1 if is new task func (p *Pool) enqueueTask(t *task, isNewTask bool) bool { // ... çœç•¥ä»£ç  return true } func (p *Pool) consumeQueue() { var ticker = time.NewTicker(time.Second) for { select { case t, ok := \u003c-p.taskQueue: if !ok { // channel closed return } if p.tryRunTask(context.Background(), t) { p.enqueuedTaskCount.Sub(1) goto unlock } // if enqueueTask return false, means channel is closed. if !p.enqueueTask(t, false) { // channel is closed goto unlock } unlock: p.lock.Unlock() case \u003c-ticker.C: log.Printf(\"current running worker num: %d\", p.curRunningWorkerNum()) } } // never reach here } ","date":"2022-04-01","objectID":"/posts/goim-worker-pool/:3:5","tags":["goim","go","worker","è½¬è½½"],"title":"[GoIM] å®ç°å¼‚æ­¥å¹¶å‘ worker é˜Ÿåˆ—","uri":"/posts/goim-worker-pool/"},{"categories":["GoIM"],"content":"ä½¿ç”¨ åˆ°è¿™é‡Œç›¸å…³å¼€å‘åŸºæœ¬ç»“æŸäº†ï¼Œæœ‰ä¸€äº› TODO é¡¹åé¢åè¡¥å……å®Œå–„ï¼Œä¸‹é¢é€šè¿‡ test case æ¥çœ‹ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨è¿™ä¸ª worker pool: func TestPool_SubmitOrEnqueue(t *testing.T) { p := NewPool(5, 1) var ( cnt int concurrence = 5 ) tf := func() error { time.Sleep(time.Second) log.Println(\"hello world\") cnt++ return nil } got := p.Submit(context.Background(), tf, concurrence) if got.Status() != TaskStatusRunning { t.Errorf(\"SubmitOrEnqueue() = %v, want %v\", got.Status(), TaskStatusRunning) return } got.Wait() if cnt != concurrence { t.Errorf(\"cnt = %v, want %v\", cnt, concurrence) } if got := p.Submit(context.Background(), tf, concurrence); got.Status() != TaskStatusRunning { t.Errorf(\"SubmitOrEnqueue() = %v, want %v\", got, TaskStatusRunning) return } if got := p.Submit(context.Background(), tf, concurrence); got.Status() != TaskStatusEnqueue { t.Errorf(\"SubmitOrEnqueue() = %v, want %v\", got.Status(), TaskStatusEnqueue) return } if got := p.Submit(context.Background(), tf, 6); got.Status() != TaskStatusTooManyWorker { t.Errorf(\"SubmitOrEnqueue() = %v, want %v\", got.Status(), TaskStatusTooManyWorker) return } if got := p.Submit(context.Background(), tf, concurrence); got.Status() != TaskStatusQueueFull { t.Errorf(\"SubmitOrEnqueue() = %v, want %v\", got.Status(), TaskStatusQueueFull) return } p.Stop() if got := p.Submit(context.Background(), tf, 1); got.Status() != TaskStatusPoolClosed { t.Errorf(\"SubmitOrEnqueue() = %v, want %v\", got.Status(), TaskStatusPoolClosed) return } } ","date":"2022-04-01","objectID":"/posts/goim-worker-pool/:4:0","tags":["goim","go","worker","è½¬è½½"],"title":"[GoIM] å®ç°å¼‚æ­¥å¹¶å‘ worker é˜Ÿåˆ—","uri":"/posts/goim-worker-pool/"},{"categories":["GoIM"],"content":"æ€»ç»“ åˆ°è¿™é‡Œè¿™ç¯‡æ–‡ç« å†…å®¹å…¨éƒ¨ç»“æŸäº†ï¼Œä¸‹é¢åšä¸€ä¸ªç®€å•çš„æ€»ç»“ï¼š ä»‹ç»èƒŒæ™¯å’Œéœ€æ±‚ æ ¹æ®éœ€æ±‚å®šä¹‰äº†ä¸€ç»„æ¦‚å¿µï¼štask, worker, workerSet, pool å„ä¸ªç»“æ„ä¹‹å‰çš„å…³ç³»ä»¥åŠå¦‚ä½•å®ç° æœ€ç»ˆç»™å‡ºä½¿ç”¨çš„ test case. ","date":"2022-04-01","objectID":"/posts/goim-worker-pool/:5:0","tags":["goim","go","worker","è½¬è½½"],"title":"[GoIM] å®ç°å¼‚æ­¥å¹¶å‘ worker é˜Ÿåˆ—","uri":"/posts/goim-worker-pool/"},{"categories":["GoIM"],"content":"é“¾æ¥ ğŸ”— å¦‚æœæƒ³ä»”ç»†é˜…è¯»æºç ï¼Œå¹¶æŒç»­å…³æ³¨è¿™å—åŠŸèƒ½çš„åç»­æ›´æ–°ä¼˜åŒ–ï¼Œè¯·ç‚¹å‡»è¿™é‡Œè·³è½¬åˆ° GitHub. ","date":"2022-04-01","objectID":"/posts/goim-worker-pool/:6:0","tags":["goim","go","worker","è½¬è½½"],"title":"[GoIM] å®ç°å¼‚æ­¥å¹¶å‘ worker é˜Ÿåˆ—","uri":"/posts/goim-worker-pool/"},{"categories":["Go"],"content":" æœ€è¿‘æ„å¤–å‘ç°ä¸€ä¸ªæ–‡ç« ï¼Œè¯´æ˜¯å¯ä»¥é€šè¿‡ go è¯­è¨€æ§åˆ¶ object-cï¼Œä»è€Œå®ç°ç”¨ go è¯­è¨€å¼€å‘å‡ºç®€å•çš„ mac appã€‚æˆ‘å°±æ˜¯è¯•ç€å°è¯•ä¸€ä¸‹çš„æƒ³æ³•å»æŠŠæ–‡ç« é‡Œè¯´çš„ repo ä¸‹è½½ä¸‹æ¥æœ¬åœ°è¿è¡Œäº†ä¸€ä¸‹é‡Œé¢çš„ç¤ºä¾‹ï¼Œå±…ç„¶è¿è¡ŒæˆåŠŸäº†ã€‚å¾ˆæ„å¤–ä¹Ÿå¾ˆæƒŠå–œï¼Œä½œä¸ºä¸€ä¸ªåç«¯å¼€å‘è€…ï¼Œç”¨åç«¯è¯­è¨€å†™å‡ºç®€å•çš„å®¢æˆ·ç«¯é¡µé¢ç®€ç›´å°±æ˜¯å¼€å¯äº†ä¸€ä¸ªæ–°æ—¶ä»£çš„å¤§é—¨ä¸€æ ·ï¼Œä»¥åå¯ä»¥åˆ¶ä½œä¸€äº›ç®€å•çš„ mac appï¼Œæ»¡è¶³è‡ªå·±çš„éœ€æ±‚äº†ï¼ˆä¹…åæé†’ã€å®šæ—¶å™¨ä¹‹ç±»çš„ï¼Œä¸€æ—¶åŠä¼šå„¿æƒ³ä¸åˆ°å¤ªå¤šï¼‰ã€‚æœ¬ç¯‡æ–‡ç« è®²è¿°å¦‚ä½•å¼€å‘ã€éƒ¨ç½²ä»¥åŠéœ€è¦æ³¨æ„çš„é—®é¢˜ã€‚ ","date":"2022-03-23","objectID":"/posts/macapp-by-go/:0:0","tags":["mac-app","go"],"title":"Golang å¼€å‘ mac app","uri":"/posts/macapp-by-go/"},{"categories":["Go"],"content":"1. èƒŒæ™¯ æœ€è¿‘åœ¨å¸®ä¸€ä¸ªæœ‹å‹å†™ä¸€äº›ç¨‹åºæŠŠä¸€äº›ç¹ççš„å·¥ä½œåšæˆè‡ªåŠ¨åŒ–ï¼Œå¸®ä»–èŠ‚çœæ—¶é—´å’Œç²¾åŠ›ã€‚ä½†æ˜¯ä½œä¸ºä¸€ä¸ªåç«¯ç¨‹åºå‘˜ï¼Œåšå‡ºæ¥çš„ä¸œè¥¿å¯¹å¤–æ¥è¯´æ— éå°±æ˜¯ http æ¥å£ æˆ–è€…ä¸€ä¸ªå¯æ‰§è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚å¦‚æœ http æ¥å£è¿˜å¥½ï¼Œæ‰¾ä¸ªè‡ªå·±çš„æœåŠ¡å™¨éƒ¨ç½²ä¸Šå»ï¼Œå†™ä¸ªç®€å•çš„é¡µé¢ï¼ˆæˆ‘èƒ½åŠ›ä»…é™äºç®€å•çš„é¡µé¢ï¼‰äº¤ç»™ä»–äººä½¿ç”¨å³å¯ã€‚ä½†æ˜¯æœ‰äº›éœ€æ±‚å¯èƒ½åœ¨å¯¹æ–¹çš„ç”µè„‘è¿è¡Œæ›´æ–¹ä¾¿ï¼ˆæ¯”å¦‚å¤„ç†æœ¬åœ°çš„ä¸€äº›æ–‡ä»¶ï¼Œæˆ–è€…æ¶‰åŠåˆ°æ•æ„Ÿä¿¡æ¯ç­‰ï¼‰ï¼Œè¿™ä¸ªæ—¶å€™å°±éº»çƒ¦äº†ï¼Œæˆ‘ç»™å¯¹æ–¹ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶è®©ä»–ç”¨ï¼Œå¯¹æ–¹ä¹Ÿæ˜¯ä¸€è„¸æ‡µé€¼ï¼Œè¿è¡Œå¤±è´¥äº†ï¼ŒæŠ¥é”™äº†æˆ–è€…å…¶ä»–æƒ…å†µå¯¹æ–¹éƒ½ä¸çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆï¼Œå°±å¾ˆä¸å‹å¥½ã€‚ æ‰€ä»¥æˆ‘è¿«åˆ‡å¸Œæœ›ä¸€ä¸ªå¯ä»¥é€šè¿‡åç«¯è¯­è¨€ç”Ÿæˆä¸€äº›ç®€å•é¡µé¢åŒ–çš„ appï¼ˆä¸€å¼€å§‹ç›¸å…³ terminal guiï¼Œä½†è¿˜æ˜¯å¤ª geekï¼‰ã€‚è¯•ç€æœäº†ä¸€ä¸‹ go è¯­è¨€å¼€å‘ mac appï¼Œå±…ç„¶æœåˆ°äº†ä¸€ä¸ªå¯¹æˆ‘å¸®åŠ©å¾ˆå¤§çš„æ–‡ç« ï¼ˆåŸæ–‡è¿æ¥ï¼‰ã€‚çœ‹åˆ°é‡Œé¢æåˆ°çš„ç¬¬äºŒä¸ªä¾‹å­ï¼Œç®€ç›´å°±æ˜¯æˆ‘æƒ³è¦çš„ï¼Œç›´æ¥åœ¨ mac çš„ status bar å¤šä¸€ä¸ªå…¥å£ï¼Œç‚¹å‡»ä¸‹æ¥å¤šä¸ªèœå•ï¼Œæˆ‘å¯ä»¥æŠŠæˆ‘å¼€å‘çš„èƒ½åŠ›æ”¾åˆ°è¿™é‡Œï¼Œç”¨æˆ·ä¸€ç‚¹å°±è§¦å‘ï¼Œå°±è§‰å¾—å¾ˆ niceã€‚ å®˜æ–¹ä¾‹å­å¦‚ä¸‹ï¼š hello world always on top webview è¿™æ˜¯æˆ‘å¼€å‘åçš„æ•ˆæœï¼š status bar å…¶ä¸­çŠ¶æ€æ æ˜¾ç¤ºçš„æ–‡å­—ï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶å®æ—¶æ›´æ–°ï¼Œè¿™æ ·å¯ä»¥åœ¨çŠ¶æ€æ å°±å¯ä»¥çœ‹åˆ°å½“å‰è¿è¡Œæƒ…å†µå’Œè¿›åº¦äº†ã€‚ é¡¹ç›®å« MacDriverï¼Œæ˜¯é€šè¿‡ go è¯­è¨€è°ƒç”¨ mac apiçš„æ¡†æ¶ã€‚ MacDriver MacDriver is a toolkit for working with Apple/Mac APIs and frameworks in Go. ","date":"2022-03-23","objectID":"/posts/macapp-by-go/:1:0","tags":["mac-app","go"],"title":"Golang å¼€å‘ mac app","uri":"/posts/macapp-by-go/"},{"categories":["Go"],"content":"2. å¼€å‘ æˆ‘æœ¬äººå¯¹ Mac APP çš„å¼€å‘ä»¥åŠ Mac çš„ API å‡ ä¹å®Œå…¨ä¸æ‡‚ï¼Œæ‰€ä»¥æœ¬é¡¹ç›®å¯¹è¿™ç°æœ‰çš„ example æ…¢æ…¢å•ƒä¸‹æ¥ç„¶åå®ç°äº†è‡ªå·±çš„éœ€æ±‚ã€‚ è€Œ MacDriver é¡¹ç›®æä¾›çš„èƒ½åŠ›å’Œèƒ½åšå‡ºæ¥çš„ä¸œè¥¿è¿œæ¯”æˆ‘åœ¨è¿™é‡Œå®ç°çš„å¤æ‚å’Œé«˜çº§ï¼Œå¦‚æœæœ‰åŒå­¦å¯¹è¿™ä¸ªååˆ†æ„Ÿå…´è¶£å¯ä»¥å…ˆçœ‹çœ‹é¡¹ç›®çš„æºç ï¼Œå¤§æ¦‚äº†è§£ä¸€ä¸‹å·²æœ‰çš„èƒ½åŠ›ã€‚ æˆ‘éœ€æ±‚æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯æ‹‰å–æœ€è¿‘æœªè¯»é‚®ä»¶ç„¶åå¯¹å…¶ä¸­éœ€è¦å¤„ç†çš„ï¼ˆè‡ªå·±æŒ‡å®šäº†ä¸€äº›åŒ¹é…è§„åˆ™ï¼‰è¿›è¡Œåå°å¤„ç†å¹¶å›å¤ä¸€æ¡è‡ªåŠ¨é‚®ä»¶ã€‚ å› ä¸ºæˆ‘çš„å¤„ç†éœ€æ±‚å’ŒåŒ¹é…è§„åˆ™è·Ÿé‚®ä»¶å†…å®¹æœ‰å…³ï¼Œæ‰€ä»¥æ²¡åŠæ³•ä½¿ç”¨é‚®ç®±æä¾›çš„æ”¶ä¿¡è§„åˆ™ç®€å•å¤„ç†ï¼Œæ‰€ä»¥è‡ªå·±åŠ¨æ‰‹å†™äº†ä¸€ä¸ªç¨‹åºã€‚ ","date":"2022-03-23","objectID":"/posts/macapp-by-go/:2:0","tags":["mac-app","go"],"title":"Golang å¼€å‘ mac app","uri":"/posts/macapp-by-go/"},{"categories":["Go"],"content":"2.1. åˆå§‹åŒ– APP func main() { runtime.LockOSThread() cocoa.TerminateAfterWindowsClose = false app := cocoa.NSApp_WithDidLaunch(func(n objc.Object) { // all code in here } app.Run() } æ‰€æœ‰çš„é€»è¾‘åœ¨ cocoa.NSApp_WithDidLaunch ä¼ å‚çš„å‡½æ•°é‡Œã€‚ ","date":"2022-03-23","objectID":"/posts/macapp-by-go/:2:1","tags":["mac-app","go"],"title":"Golang å¼€å‘ mac app","uri":"/posts/macapp-by-go/"},{"categories":["Go"],"content":"2.2. åˆå§‹åŒ– status bar è¿™é‡Œæ˜¯å®šä¹‰ç¨‹åºå¯åŠ¨æ—¶ï¼Œé»˜è®¤æ˜¯å±•ç¤ºæ–‡å­—ã€‚ app := cocoa.NSApp_WithDidLaunch(func(n objc.Object) { obj := cocoa.NSStatusBar_System().StatusItemWithLength(cocoa.NSVariableStatusItemLength) obj.Retain() obj.Button().SetTitle(\"ğŸ“§ å‡†å¤‡å°±ç»ª\") // åˆå§‹åŒ– status bar çš„å±•ç¤ºæ–‡æœ¬ // ...çœç•¥ code } ","date":"2022-03-23","objectID":"/posts/macapp-by-go/:2:2","tags":["mac-app","go"],"title":"Golang å¼€å‘ mac app","uri":"/posts/macapp-by-go/"},{"categories":["Go"],"content":"2.3. è¿è¡Œæ—¶åŠ¨æ€æ›´æ–° status bar è¿è¡Œè¿‡ç¨‹ä¸­æˆ‘å¸Œæœ›èƒ½å®æ—¶æ›´æ–°å¤„ç†çš„è¿›åº¦ä»¥åŠçŠ¶æ€ã€‚ app := cocoa.NSApp_WithDidLaunch(func(n objc.Object) { obj := cocoa.NSStatusBar_System().StatusItemWithLength(cocoa.NSVariableStatusItemLength) obj.Retain() obj.Button().SetTitle(\"ğŸ“§ å‡†å¤‡å°±ç»ª\") var ( eventChan = make(chan string, 1) indexChan = make(chan int, count) ) go func() { for { select { case \u003c-time.After(1 * time.Second): case e := \u003c-eventChan: // è¿™é‡Œæˆ‘æ›´æ–°å„ç±»äº‹ä»¶çš„å®æ—¶æƒ…å†µå’ŒçŠ¶æ€ core.Dispatch(func() { obj.Button().SetTitle(fmt.Sprintf(\"ğŸ· %s\", e)) }) case i := \u003c-indexChan: // è¿™é‡Œæˆ‘å®æ—¶æ›´æ–°å¤„ç†åˆ°ç¬¬å‡ å°é‚®ä»¶ core.Dispatch(func() { obj.Button().SetTitle(fmt.Sprintf(\"âœ´ï¸ å¤„ç†é‚®ä»¶ä¸­ %d/%d\", i, count)) }) } } }() // .. çœç•¥ code ","date":"2022-03-23","objectID":"/posts/macapp-by-go/:2:3","tags":["mac-app","go"],"title":"Golang å¼€å‘ mac app","uri":"/posts/macapp-by-go/"},{"categories":["Go"],"content":"2.4. æ·»åŠ  menu ä¸Šé¢åˆå§‹åŒ–äº†å±•ç¤ºçš„ status bar çš„æ–‡å­—ï¼Œç°åœ¨æˆ‘ä»¬æ·»åŠ  menu èœå•ï¼Œä¸åŒçš„ menu å¤„ç†ä¸åŒçš„äº‹ä»¶ã€‚ app := cocoa.NSApp_WithDidLaunch(func(n objc.Object) { // ... çœç•¥code // set quit action itemQuit := cocoa.NSMenuItem_New() itemQuit.SetTitle(\"é€€å‡º\") itemQuit.SetAction(objc.Sel(\"terminate:\")) // è®¾ç½®è‡ªå®šä¹‰ menu å’Œå¤„ç†æ–¹æ³• checkAndSetSeen := cocoa.NSMenuItem_New() checkAndSetSeen.SetTitle(fmt.Sprintf(\"å¤„ç†æœ€æ–°%då°é‚®ä»¶âœ‰ï¸(å¹¶ä¸”è®¾ä¸ºå·²è¯»)\", count)) checkAndSetSeen.SetAction(objc.Sel(\"checkAndSet:\")) cocoa.DefaultDelegateClass.AddMethod(\"checkAndSet:\", func(_ objc.Object) { // è¿™é‡Œå°±å¯ä»¥æ”¾æˆ‘ä»¬è‡ªå·±çš„é€»è¾‘äº† go func() { defer deferFunc(obj) log.Println(\"email start\") run(indexChan, eventChan, onlyCheckMode|setSeenMode) }() }) setAndReply := cocoa.NSMenuItem_New() setAndReply.SetTitle(fmt.Sprintf(\"å¤„ç†æœ€æ–°%då°é‚®ä»¶âœ‰ï¸(å¹¶ä¸”è®¾ä¸ºå·²è¯»å’Œå›å¤é‚®ä»¶)\", count)) setAndReply.SetAction(objc.Sel(\"setAndReply:\")) cocoa.DefaultDelegateClass.AddMethod(\"setAndReply:\", func(_ objc.Object) { go func() { defer deferFunc(obj) log.Println(\"email start\") run(indexChan, eventChan, onlyCheckMode|setSeenMode|replyMailMode) }() }) // menu æ³¨å†Œè¿›å» menu := cocoa.NSMenu_New() menu.AddItem(checkAndSetSeen) menu.AddItem(setAndReply) menu.AddItem(itemQuit) obj.SetMenu(menu) } åˆ°è¿™é‡Œ status bar çš„å¼€å‘å°±å®Œæˆäº†ï¼Œä¸šåŠ¡é€»è¾‘ä»£ç æˆ‘å°±ä¸è´´äº†ã€‚ ","date":"2022-03-23","objectID":"/posts/macapp-by-go/:2:4","tags":["mac-app","go"],"title":"Golang å¼€å‘ mac app","uri":"/posts/macapp-by-go/"},{"categories":["Go"],"content":"3. ç¼–è¯‘éƒ¨ç½² æˆ‘ä¸€å¼€å§‹ä»¥ä¸ºæ˜¯éœ€è¦å„ç±»çš„å¼€å‘è€…è´¦å·æˆ–è€… xcode æ‰èƒ½å°†ä»£ç è¿è¡Œèµ·æ¥ï¼Œä½†æ˜¯å®é™…ä¸Šç®€å•çš„è®©äººæˆ‘æ€€ç–‘ï¼ˆå› ä¸ºæˆ‘çŸ¥é“è‹¹æœç”±äºç”Ÿæ€å°é—­ app çš„å¼€å‘å°±æ¯”è¾ƒå¤æ‚ï¼‰ ç¼–è¯‘ï¼š go build main.go è¿è¡Œï¼š ./main è¿™å°± OK äº†ï¼Œå®Œå…¨ä¸éœ€è¦å…¶ä»–ä»»ä½•æ“ä½œï¼Œéå¸¸æ¸…çˆ½ã€‚ ","date":"2022-03-23","objectID":"/posts/macapp-by-go/:3:0","tags":["mac-app","go"],"title":"Golang å¼€å‘ mac app","uri":"/posts/macapp-by-go/"},{"categories":["Go"],"content":"4. æ€»ç»“ æœ¬ç¯‡è®²è¿°å†…å®¹å¦‚ä¸‹ï¼š è®²è¿°ç”¨ go å¼€å‘ mac app çš„èƒŒæ™¯ ä»‹ç»åŸºäº go è¯­è¨€è°ƒç”¨ Mac api çš„å¼€æºåº“ MacDriver è®²è¿°åŸºäº MacDriver å¼€å‘ä¸€ä¸ªç®€å•çŠ¶æ€æ  app çš„è¿‡ç¨‹ è®²è¿°å¦‚ä½•ç¼–è¯‘éƒ¨ç½²å¼€å‘çš„ app ","date":"2022-03-23","objectID":"/posts/macapp-by-go/:4:0","tags":["mac-app","go"],"title":"Golang å¼€å‘ mac app","uri":"/posts/macapp-by-go/"},{"categories":["Go"],"content":"5.é“¾æ¥ğŸ”— MacDriver Go ç»ˆäºå¯ä»¥å¼€å‘åŸç”Ÿ Mac APP äº† ","date":"2022-03-23","objectID":"/posts/macapp-by-go/:5:0","tags":["mac-app","go"],"title":"Golang å¼€å‘ mac app","uri":"/posts/macapp-by-go/"},{"categories":["Docker"],"content":" æœ€è¿‘åœ¨æŸä¸ªé¡¹ç›®ä¸­éœ€è¦å¼•å…¥RocketMQæ¥å¤„ç†ä¸€äº›ä¸šåŠ¡é€»è¾‘ï¼Œç„¶åç”±äºè¿˜æ²¡ä¸Šçº¿ï¼Œéœ€è¦æœ¬åœ°æ­å»ºå¼€å‘ç¯å¢ƒï¼Œç”±äºç¬¬ä¸€æ¬¡æ¥è§¦ RocketMQ æ‰€ä»¥åœ¨éƒ¨ç½²çš„è¿‡ç¨‹æœ‰äº›æ›²æŠ˜ï¼Œé€šè¿‡è¿™ç¯‡æ–‡ç« è®°å½•éƒ¨ç½²è¿‡ç¨‹å’Œé‡åˆ°çš„ä¸€äº›é—®é¢˜ï¼Œå¸Œæœ›å¯¹çœ‹åˆ°çš„è¯»è€…æœ‰æ‰€å¸®åŠ©ã€‚ ","date":"2022-03-14","objectID":"/posts/rocketmq-deploy/:0:0","tags":["docker","rocketmq"],"title":"Docker ç¯å¢ƒéƒ¨ç½² RocketMQ","uri":"/posts/rocketmq-deploy/"},{"categories":["Docker"],"content":"1. èƒŒæ™¯ ç”±äºä¸šåŠ¡éœ€æ±‚éœ€è¦æ­å»ºä¸€ä¸ªæœ¬åœ°å¼€å‘ç¯å¢ƒï¼Œè€Œæˆ‘å‡ ä¹æ‰€æœ‰çš„ä¾èµ–ï¼ˆå„ç§æ•°æ®åº“ï¼Œå·¥å…·ä¹‹ç±»çš„ï¼‰éƒ½åŸºäº docker è¿è¡Œï¼Œæ–¹ä¾¿éšæ—¶å¯åœå’Œæ›´æ–°ï¼ŒåŒæ—¶ä¿è¯å®¿ä¸»æœºä¸Šä¸ä¼šå®‰è£…å„ç±»ä¸å¸¸ç”¨çš„ç¯å¢ƒã€‚ åœ¨éœ€è¦ä¸€ä¸ª RocketMQ çš„æ—¶å€™ æˆ‘ä¹Ÿæ˜¯ä¹ æƒ¯æ€§çš„ç›´æ¥æœå…¶é•œåƒï¼Œä½†æ˜¯è®©æˆ‘æ¯”è¾ƒæ„å¤–çš„æ˜¯ï¼Œä½œä¸ºä¸€ä¸ª Apache é¡¹ç›®ï¼Œå…¶é•œåƒæœ€åæ›´æ–°æ—¶é—´å±…ç„¶åœ¨2å¹´å‰ã€‚ è€Œæˆ‘ä¸çŸ¥é“è¦ä¸è¦ç”¨è¿™ä¸ªé•œåƒä»¥åŠæ€ä¹ˆç”¨çš„æ—¶å€™åˆå‘ç°äº†å®˜æ–¹çš„ä¸€ä¸ª repoï¼šapache/rocketmq-dockerã€‚ è¿™ä¸ª repo æä¾›äº†å¦‚ä½•è‡ªå·±æ‰“åŒ…ä¸€ä¸ªé•œåƒæˆ–è€…ç”¨å®˜æ–¹çš„é•œåƒåœ¨ä¸åŒç¯å¢ƒä¸‹éƒ¨ç½² RocketMQï¼ŒåŒ…æ‹¬å•èŠ‚ç‚¹ï¼Œdocker-compose ä»¥åŠ k8s ç¯å¢ƒã€‚ å› ä¸ºå®˜æ–¹çš„é•œåƒç¡®å®æ¯”è¾ƒè€æ—§ï¼Œæœ€æ–°æ‰ 4.6.0ï¼Œè€Œæœ€æ–°ç‰ˆæœ¬ä»¥åŠåˆ° 4.9.x äº†ï¼Œæˆ‘æœ¬æ¥æƒ³è‡ªå·±æ‰“åŒ…ä¸€ä¸ªæœ€æ–°çš„é•œåƒæ¥ç€ã€‚ä½†æ˜¯çœ‹åˆ°éœ€è¦é…ç½®ä¸€å † JAVA ç¯å¢ƒï¼Œæˆ‘å°±æ”¾å¼ƒäº†ï¼Œä¸€æ˜¯ä¸ç†Ÿæ‚‰ JAVA çš„é…ç½®ï¼Œå¦å¤–ä¸€æ–¹é¢æˆ‘ä¸æƒ³ä¸ºäº†è¿™ä¸ªæµªè´¹æˆ‘å¤ªå¤šæ—¶é—´ï¼Œæ‰€ä»¥é€‰æ‹©ä»¥ 4.6.0 ç‰ˆæœ¬ä¸‹éƒ¨ç½²ä¸€ä¸ªæœ¬åœ°ç¯å¢ƒã€‚ ","date":"2022-03-14","objectID":"/posts/rocketmq-deploy/:1:0","tags":["docker","rocketmq"],"title":"Docker ç¯å¢ƒéƒ¨ç½² RocketMQ","uri":"/posts/rocketmq-deploy/"},{"categories":["Docker"],"content":"2. éƒ¨ç½² å…³äºæœ¬åœ°éƒ¨ç½²çš„æ­¥éª¤ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå°† apache/rocketmq-docker è¿™ä¸ª repo ä¸‹è½½åˆ°æœ¬åœ°ã€‚ cd rocketmq-docker sh stage.sh 4.6.0 æ‰§è¡Œè¯¥è„šæœ¬åï¼Œä¼šç”Ÿæˆä¸€ä¸ª statge/4.6.0 çš„ç›®å½•ï¼Œå¹¶åœ¨ç›®å½•ä¸‹ä¼šæœ‰ä¸åŒç±»å‹éƒ¨ç½²æ–¹å¼ç›¸å…³çš„è„šæœ¬å’Œéœ€è¦çš„é…ç½®æ–‡ä»¶ï¼Œæˆ‘ä»¬ç°åœ¨åªå…³æ³¨ docker-compose ç›¸å…³çš„ã€‚ ~/workspace/rocketmq-docker/stages/4.6.0 on î‚  master at 17:21:09 âœ ls -al total 56 drwxr-xr-x 13 shan.yu staff 416 Mar 14 11:57 . drwxr-xr-x 3 shan.yu staff 96 Mar 14 10:24 .. drwxr-xr-x 6 shan.yu staff 192 Mar 14 10:24 data # å•èŠ‚ç‚¹éƒ¨ç½²æ–¹å¼éœ€è¦çš„é…ç½®ç›®å½• drwxr-xr-x 5 shan.yu staff 160 Mar 14 12:04 docker-compose # docker-compose éƒ¨ç½²æ–¹å¼éœ€è¦çš„é…ç½®ç›®å½• drwxr-xr-x 4 shan.yu staff 128 Mar 14 10:24 kubernetes # k8sç½²æ–¹å¼éœ€è¦çš„é…ç½®ç›®å½• -rwxr-xr-x 1 shan.yu staff 902 Mar 14 10:24 play-consumer.sh -rwxr-xr-x 1 shan.yu staff 1497 Mar 14 10:24 play-docker-compose.sh # docker-compose éƒ¨ç½²è„šæœ¬ -rwxr-xr-x 1 shan.yu staff 3201 Mar 14 10:24 play-docker-dledger.sh -rwxr-xr-x 1 shan.yu staff 2271 Mar 14 10:24 play-docker-tls.sh -rwxr-xr-x 1 shan.yu staff 2354 Mar 14 10:24 play-docker.sh -rwxr-xr-x 1 shan.yu staff 947 Mar 14 10:24 play-kubernetes.sh -rwxr-xr-x 1 shan.yu staff 901 Mar 14 10:24 play-producer.sh drwxr-xr-x 17 shan.yu staff 544 Mar 14 10:24 ssl ä»ç›®å½•ç»“æ„å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬åªéœ€è¦å…³æ³¨ docker-compose ç›®å½•å’Œ play_docker-compose.sh è„šæœ¬å³å¯ã€‚ docker-compose ç›®å½•ä¸‹æœ‰ä¸€ä¸ª yaml æ–‡ä»¶ï¼Œè¿™ä¸ªå°±æ˜¯ docker-compose çš„é…ç½®æ–‡ä»¶ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ï¼š version: '2' services: #Service for nameserver namesrv: image: apacherocketmq/rocketmq:4.6.0 container_name: rmqnamesrv ports: - 9876:9876 volumes: - ./data/namesrv/logs:/home/rocketmq/logs command: sh mqnamesrv #Service for broker broker: image: apacherocketmq/rocketmq:4.6.0 container_name: rmqbroker links: - namesrv ports: - 10909:10909 - 10911:10911 - 10912:10912 environment: - NAMESRV_ADDR=rmqnamesrv:9876 volumes: - ./data/broker/logs:/home/rocketmq/logs - ./data/broker/store:/home/rocketmq/store - ./data/broker/conf/broker.conf:/opt/rocketmq-4.6.0/conf/broker.conf command: sh mqbroker -n rmqnamesrv:9876 -c /opt/rocketmq-4.6.0/conf/broker.conf æœ¬æ¥æ˜¯å¯åŠ¨çš„ä¸¤ä¸ª broker, æˆ‘åˆ æ‰ä¸€ä¸ªï¼Œåªä¿ç•™ä¸€ä¸ª namesever å’Œä¸€ä¸ª brokerã€‚ ./data/broker/conf/broker.conf ä¸º broker çš„é…ç½®æ–‡ä»¶è·¯å¾„ï¼Œä¹Ÿæ˜¯æœ€å¼€å§‹æ‰§è¡Œçš„è„šæœ¬ç”Ÿæˆçš„ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹ï¼š brokerClusterName = DefaultCluster brokerName = broker-a brokerId = 0 deleteWhen = 04 fileReservedTime = 48 brokerRole = ASYNC_MASTER flushDiskType = ASYNC_FLUSH ## æ³¨æ„ï¼é»˜è®¤æ˜¯ä¸ç”Ÿæˆè¿™ä¸€è¡Œçš„ï¼Œä½†æ˜¯ä½  docker ç¯å¢ƒéƒ¨ç½²çš„è¯ï¼Œbroker æŠŠè‡ªå·±æ³¨å†Œåˆ° nameserver çš„æ—¶å€™ç”¨çš„æ˜¯containerIP ## ç±»ä¼¼ 172.0.2.3 è¿™ç§ï¼Œè¿™å°±å¯¼è‡´ä½ ä½¿ç”¨æœ¬åœ°ç¨‹åºè¿ broker ä¼šè¿æ¥è¶…æ—¶ï¼Œæˆ‘åœ¨è¿™å—å¡äº†å¾ˆä¹…ã€‚ ## è§£å†³æ–¹æ¡ˆå°±æ˜¯ å°†docker å®¿ä¸»æœºæ‰§è¡Œ ifconfig åï¼Œå¾—åˆ°çš„æœ¬æœº ipï¼ˆä¸æ˜¯ 127.0.0.1ï¼‰é…åˆ°è¿™é‡Œï¼Œä»è€Œè§£å†³è¿™ä¸ªé—®é¢˜ã€‚ brokerIP1=10.12.220.222 éœ€è¦ä¸»è¦ä¸Šé¢çš„ brokerIP1 çš„é…ç½®ï¼Œå…¶ä»–çš„éƒ½ä¸ç”¨ç®¡ã€‚ æ­¤æ—¶ç›´æ¥æ‰§è¡Œ ./play-docker-compose.sh å°±å¯ä»¥äº†ï¼Œç­‰ç€é•œåƒä¸‹å®Œå¯åŠ¨ã€‚å¯åŠ¨å®Œåï¼Œé€šè¿‡ docker ps ç¡®è®¤ä¸€ä¸‹æ˜¯å¦å¯åŠ¨æˆåŠŸï¼š âœ docker ps CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 9653b92c46b5 apacherocketmq/rocketmq:4.6.0 \"sh mqbroker -n rmqnâ€¦\" 4 hours ago Up 4 hours 0.0.0.0:10909-\u003e10909/tcp, 9876/tcp, 0.0.0.0:10911-10912-\u003e10911-10912/tcp rmqbroker e34ca8cbf7fa apacherocketmq/rocketmq:4.6.0 \"sh mqnamesrv\" 4 hours ago Up 4 hours 10909/tcp, 0.0.0.0:9876-\u003e9876/tcp, 10911-10912/tcp rmqnamesrv 4957ecb3adc5 apacherocketmq/rocketmq-dashboard:latest \"sh -c 'java $JAVA_Oâ€¦\" 7 hours ago Up 7 hours 0.0.0.0:8080-\u003e8080/tcp rocketmq-dashboard ä¸Šé¢å‘ç°å¤šäº†ä¸€ä¸ª rocketmq-dashboard, è¿™æ˜¯ä¸€ä¸ªç•Œé¢åŒ–ç®¡ç†çš„ UI ç¨‹åºã€‚å› ä¸ºè‡ªåŠ¨ç”Ÿæˆçš„ docker-compose çš„ yaml æ–‡ä»¶é‡Œæ²¡æœ‰åŒ…å«ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±å•ç‹¬è¿è¡Œæˆ–è€…è¡¥åˆ° yaml æ–‡ä»¶é‡Œï¼Œä¸‹é¢ä¸¤ç§æ–¹å¼éƒ½æä¾›ã€‚ ç›´æ¥ docker è¿è¡Œï¼š âœ docker run -d --name rocketmq-dashboard --network docker-compose_default -e \"JAVA_OPTS=-Drocketmq.namesrv.addr=rmqnamesrv:9876\" -p 8080:8080 -t apacherocketmq/rocketmq-dashboard:latest æ·»åŠ åˆ° docker compose yaml ä¸­ï¼š rocketmq-dashboard: image: apacherocketmq/rocketmq-dashboard:latest container_name: rocketmq-dashboard links: - namesrv ports: - 8080:8080 environment: - JAVA_OPTS=-Drocketmq.namesrv.addr=rmqnamesrv:9876 è¿™æ ·ä½ ä»æœ¬åœ° 8080 ç«¯å£å°±èƒ½çœ‹åˆ° UI é¡µé¢ï¼š ","date":"2022-03-14","objectID":"/posts/rocketmq-deploy/:2:0","tags":["docker","rocketmq"],"title":"Docker ç¯å¢ƒéƒ¨ç½² RocketMQ","uri":"/posts/rocketmq-deploy/"},{"categories":["Docker"],"content":"3. é‡åˆ°çš„é—®é¢˜ ","date":"2022-03-14","objectID":"/posts/rocketmq-deploy/:3:0","tags":["docker","rocketmq"],"title":"Docker ç¯å¢ƒéƒ¨ç½² RocketMQ","uri":"/posts/rocketmq-deploy/"},{"categories":["Docker"],"content":"3.1. æ²¡æœ‰æœ€æ–°çš„é•œåƒ é€šè¿‡ RocketMQ å‘ç°ç›®å‰æœ€æ–°ç‰ˆæœ¬ä»¥åŠåˆ° v4.9.3ï¼Œ è€Œç›®å‰å¯ç”¨çš„é•œåƒæœ€æ–°ä¹Ÿæ˜¯ v4.6.0ï¼Œè¿™ä¸ªå¯¹äºç‰ˆæœ¬è¦æ±‚é«˜çš„åŒå­¦æ¥è¯´æ˜¯ä¸€ä¸ªéº»çƒ¦çš„äº‹å„¿ï¼Œå› ä¸ºåœ¨æœ¬åœ°ç›´æ¥æ‰§è¡Œæœ€æ–°ä»£ç éœ€è¦ä»¥ä¸‹ç¯å¢ƒï¼š Prerequisite The following softwares are assumed installed: 64bit OS, Linux/Unix/Mac is recommended;(Windows user see guide below) 64bit JDK 1.8+; Maven 3.2.x; Git; 4g+ free disk for Broker server æˆ‘æœ€åæ”¾å¼ƒä½¿ç”¨æœ€æ–°ç‰ˆæœ¬äº†ï¼Œä¹Ÿæ²¡æœ‰å»ç ”ç©¶ 4.6.0 åˆ° 4.9.3 è¿™ä¸ªè·¨åº¦æœ‰äº†ä»€ä¹ˆæ¯”è¾ƒå¤§çš„æ›´æ–°ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å»å®˜ç½‘äº†è§£ä¸€ä¸‹ã€‚ ","date":"2022-03-14","objectID":"/posts/rocketmq-deploy/:3:1","tags":["docker","rocketmq"],"title":"Docker ç¯å¢ƒéƒ¨ç½² RocketMQ","uri":"/posts/rocketmq-deploy/"},{"categories":["Docker"],"content":"3.2. docker ç¯å¢ƒå®¿ä¸»æœºä¸Šç¨‹åºæ— æ³•æ­£å¸¸è¿æ¥ ä½¿ç”¨å®˜æ–¹çš„ rocketmq-docker repo ç”Ÿæˆäº† docker-compose æ–‡ä»¶å,ç›´æ¥æ‰§è¡Œå‘ç°æœ¬æœºç¨‹åºè¿ä¸ä¸Šï¼ŒæŠ¥é”™ä¿¡æ¯å¤§æ¦‚å¦‚ä¸‹ï¼š ERRO[6243] get consumer list of group from broker error broker=\"172.18.0.3:10911\" consumerGroup=push_msg underlayError=\"dial tcp 172.18.0.3:10911: i/o timeout\" WARN[6243] do balance in group failed, get consumer id list failed consumerGroup=push_msg topic=\"%RETRY%push_msg\" ERRO[6246] get consumer list of group from broker error broker=\"172.18.0.3:10911\" consumerGroup=push_msg underlayError=\"dial tcp 172.18.0.3:10911: i/o timeout\" WARN[6246] do balance in group failed, get consumer id list failed consumerGroup=push_msg topic=def_topic WARN[6249] send heart beat to broker error underlayError=\"dial tcp 172.18.0.3:10911: i/o timeout\" æˆ‘ä¸€çœ‹è¿™ä¸ª ip å°±çŸ¥é“é—®é¢˜å‡ºåœ¨å“ªå„¿äº†ï¼Œå› ä¸ºç¨‹åºè¿æ¥çš„æ˜¯ nameserver çš„ç«¯å£ï¼Œä» nameserver æœåŠ¡æ‹¿åˆ° broker çš„ ip ç«¯å£å†å»è¿ brokerï¼Œæ‰€ä»¥æ‹¿åˆ°äº† broker çš„ containerIPã€‚ è¿™ä¸ªé—®é¢˜å¥½åœ¨å®˜æ–¹ repo çš„ README æœ€åå†™äº†ï¼Œéœ€è¦é…ç½®å®¿ä¸»æœºçš„ ipï¼Œæˆ‘é…ç½®å®Œé‡æ–°å¯åŠ¨å°± OK äº†ã€‚ ","date":"2022-03-14","objectID":"/posts/rocketmq-deploy/:3:2","tags":["docker","rocketmq"],"title":"Docker ç¯å¢ƒéƒ¨ç½² RocketMQ","uri":"/posts/rocketmq-deploy/"},{"categories":["Docker"],"content":"4. æ€»ç»“ æœ¬ç¯‡æ–‡ä»¶æ˜¯è®²è¿°çš„å†…å®¹é‡ç‚¹å¦‚ä¸‹ï¼š rocketmq docker é•œåƒç°çŠ¶ å¦‚ä½•é€šè¿‡å®˜æ–¹å·¥å…·æœ¬åœ°éƒ¨ç½² rocketmq éƒ¨ç½²å’Œä½¿ç”¨è¿‡ç¨‹é‡åˆ°çš„é—®é¢˜ å¦‚ä½•éƒ¨ç½²æœ€æ–°rocketmq ","date":"2022-03-14","objectID":"/posts/rocketmq-deploy/:4:0","tags":["docker","rocketmq"],"title":"Docker ç¯å¢ƒéƒ¨ç½² RocketMQ","uri":"/posts/rocketmq-deploy/"},{"categories":["Docker"],"content":"5. é“¾æ¥ğŸ”— RocketMQå®˜æ–¹ RocketMQ-Docker ","date":"2022-03-14","objectID":"/posts/rocketmq-deploy/:5:0","tags":["docker","rocketmq"],"title":"Docker ç¯å¢ƒéƒ¨ç½² RocketMQ","uri":"/posts/rocketmq-deploy/"},{"categories":["ä»£ç æŠ€å·§"],"content":" æœ¬ç¯‡ä»‹ç»ä¸€ä¸ªå¦‚ä½•åœ¨ go è¯­è¨€ç¯å¢ƒä¸‹ï¼Œå¦‚ä½•è§£æ/è¯»å– pdf æ–‡ä»¶å†…å®¹ä»è€Œè¿›è¡Œä¸€äº›ä¸šåŠ¡é€»è¾‘ã€‚æœ¬ç¯‡å°†ä¼šä»‹ç»ä¸¤ç§æ–¹æ¡ˆï¼Œå¯ä»¥æŒ‰è‡ªå·±çš„éœ€æ±‚è¿›è¡Œå¯¹æ¯”å’Œæœ€ç»ˆé€‰æ‹©ã€‚ ","date":"2022-03-04","objectID":"/posts/pdf-reader/:0:0","tags":["go","java","docker","pdf"],"title":"Go è¯­è¨€å®ç°è¯»å– pdf æ–‡ä»¶å†…å®¹","uri":"/posts/pdf-reader/"},{"categories":["ä»£ç æŠ€å·§"],"content":"1. èƒŒæ™¯ æœ€è¿‘åœ¨å¸®æœ‹å‹åšä¸€ä¸ªå°çš„ç¨‹åºï¼Œå¸®ä»–å‡å°‘ä¸€äº›äººå·¥ç¹ççš„å·¥ä½œï¼Œå°†ä¸€äº›æœºå™¨å¯ä»¥åšçš„äº‹æƒ…äº¤ç»™æœºå™¨ï¼Œæé«˜æ•ˆç‡ä»–æ•ˆç‡ã€‚ éœ€æ±‚ä¹Ÿç›¸å¯¹ç®€å•ï¼Œå°±æ˜¯ä»å¤§é‡ pdf/docx æ–‡ä»¶å†…å®¹ä¸­è¯»å–ä¸€äº›å…³é”®ä¿¡æ¯ï¼ˆè¿™äº›ä¿¡æ¯æœ‰ä¸€å®šçš„è§„å¾‹ï¼‰ï¼Œå¹¶è¾“å‡ºä¸€ä¸ª Excel è¡¨æ ¼ã€‚å¬åˆ°è¿™ä¸ªéœ€æ±‚æˆ‘ç¬¬ä¸€ä¸ªæƒ³æ³•æ˜¯å¯ä»¥åšçš„ï¼Œæˆ‘ä¹‹å‰åœ¨ä¸€äº›æ‹›è˜ç½‘ç«™ä¹Ÿæ˜¯çœ‹è¿‡è§£æ pdf å†…å®¹çš„åŠŸèƒ½ã€‚æœ€å…¸å‹çš„å°±æ˜¯åœ¨æ‹›è˜ç½‘ç«™ä¸Šä¼ ä¸ªäººç®€å†æ—¶ï¼Œä¼šè¯»å‡ºæ¥ä¸ªäººä¿¡æ¯ä»¥åŠå…¶ä»–ä¿¡æ¯ã€‚æ—¢ç„¶å¸‚é¢ä¸Šæœ‰äººè¿™ä¹ˆå¹²ï¼Œé‚£å°±è¯´æ˜¯è‚¯å®šæœ‰ä¸€å®šçš„è§£å†³æ–¹æ¡ˆå¯ä»¥ä¾›æˆ‘åˆ©ç”¨çš„ã€‚ æ¥ä¸‹æ¥å°±æ˜¯å»æ‰¾è§£å†³æ–¹æ¡ˆäº†ï¼Œè°ƒç ”äº†ä¸€ä¸‹åˆåï¼Œç›®æ ‡åŸºæœ¬æ˜ç¡®äº†ã€‚æœ‰ä¸¤ä¸ªé¡¹ç›®è¿›å…¥äº†æœ€ç»ˆå†³èµ›åœˆï¼Œæˆ‘éœ€è¦åˆ†åˆ«ä½¿ç”¨ï¼Œå¹¶æŠŠä¸€äº›ä¼˜ç¼ºç‚¹åˆ—å‡ºæ¥å°±èƒ½ç¡®å®šæœ€ç»ˆèƒœè€…äº†ã€‚ è¿™ä¸¤ä¸ªæ–¹æ¡ˆåˆ†åˆ«æ˜¯: ledongthuc/pdf goè¯­è¨€å®ç°çš„ pdf è§£æåº“ã€‚æœ‰ä¸å°‘çš„ star å’Œ forkï¼Œå¹¶ä¸”ä» demo ä¸Šçœ‹åˆ°ç¡®å®èƒ½è¯»å–åˆ°å†…å®¹ã€‚ apache/tika Java å®ç°çš„ pdf è§£æåº“ã€‚ä¹‹æ‰€ä»¥èƒ½è¿›å…¥å†³èµ›åœˆæ˜¯å› ä¸ºç½‘ä¸Šå¤§é‡äººæ¨èå¹¶ä¸”æ˜¯ apache çš„é¡¹ç›®ï¼Œæ‰€ä»¥æˆ‘ä¹Ÿæ¯”è¾ƒæ”¾å¿ƒä½¿ç”¨ã€‚ ","date":"2022-03-04","objectID":"/posts/pdf-reader/:1:0","tags":["go","java","docker","pdf"],"title":"Go è¯­è¨€å®ç°è¯»å– pdf æ–‡ä»¶å†…å®¹","uri":"/posts/pdf-reader/"},{"categories":["ä»£ç æŠ€å·§"],"content":"2. go è¯­è¨€æ–¹æ¡ˆ é¦–å…ˆå¯¹ ledongthuc/pdf è¿›è¡Œä½¿ç”¨æµ‹è¯•ã€‚å…ˆä¸Šä»£ç ï¼š package main import ( \"bytes\" \"fmt\" \"github.com/ledongthuc/pdf\" ) func main() { pdf.DebugOn = true content, err := readPdf(\"test.pdf\") // Read local pdf file if err != nil { panic(err) } fmt.Println(content) return } func readPdf(path string) (string, error) { f, r, err := pdf.Open(path) // remember close file defer f.Close() if err != nil { return \"\", err } var buf bytes.Buffer b, err := r.GetPlainText() if err != nil { return \"\", err } buf.ReadFrom(b) return buf.String(), nil } è¿™æ˜¯ä¸€æ®µé¡¹ç›®è‡ªå·±æä¾› demoï¼Œæˆ‘æœ¬åœ°ç¡®å®ä¹Ÿè·‘èµ·æ¥äº†ã€‚ä½†æ˜¯æˆ‘å½“å¯¹ä¸€äº›æˆ‘æœ‹å‹æä¾›çš„æµ‹è¯•æ¡ˆä¾‹ pdf æ–‡ä»¶è¿›è¡Œè§£ææ—¶ï¼Œé‡åˆ°äº†é—®é¢˜ï¼ŒæŠ¥äº†ä¸‹é¢çš„é”™ï¼š malformed PDF: reading at offset 0: stream not present æˆ‘ç¬¬ä¸€ååº”æ˜¯å¯èƒ½æˆ‘çš„ pdf ä¸æ˜¯å¾ˆæ ‡å‡† pdf æ ¼å¼å¯¼è‡´ï¼Œç„¶åå»é¡¹ç›® issue é‡Œçœ‹åˆ°ç±»ä¼¼çš„é—®é¢˜ï¼Œå¹¶ä¸”ä½œè€…ä¹Ÿç»™äº†è§£å†³æ–¹æ¡ˆï¼Œæ˜æ˜¾æ¯”è¾ƒéº»çƒ¦çš„ä¸€ç§è§£å†³æ–¹æ¡ˆã€‚å› ä¸ºéœ€è¦å¯¹æ–‡ä»¶è¿›è¡Œä¸€äº›å¤„ç†ï¼Œè¿™ä¸ªæ–¹æ¡ˆæˆ‘ä¸æ˜¯å¾ˆèƒ½æ¥å—ã€‚ä¸è¿‡æˆ‘æ‰¾ä¸€äº›ç½‘ä¸Šæ ‡å‡†(æ‰€è°“çš„æ ‡å‡†å°±æ˜¯å»æ‰¾äº†ä¸€äº›æƒå¨çš„ç½‘ç«™ä¸Šçš„ pdf æ–‡ä»¶)çš„ pdf æ–‡ä»¶çš„æ—¶å€™ï¼Œçš„ç¡®èƒ½è¯»å‡ºå†…å®¹ã€‚è¿™ä¸ªæ–¹æ¡ˆæˆ‘å…ˆæ ‡æ³¨ä¸º backup, å®åœ¨æ²¡è¾™æˆ‘å†å›æ¥æŠ˜è…¾ã€‚ ","date":"2022-03-04","objectID":"/posts/pdf-reader/:2:0","tags":["go","java","docker","pdf"],"title":"Go è¯­è¨€å®ç°è¯»å– pdf æ–‡ä»¶å†…å®¹","uri":"/posts/pdf-reader/"},{"categories":["ä»£ç æŠ€å·§"],"content":"3. tika + go client æ–¹æ¡ˆ apache/tika æ˜¯ä¸€ä¸ªæ¯”è¾ƒä¸‡èƒ½çš„å·¥å…·é›†ï¼Œå…¶èƒ½åŠ›å¯ä»¥å‚è€ƒå®˜æ–¹çš„è¯´æ˜ã€‚ apache/tika Apache Tika - a content analysis toolkit The Apache Tikaâ„¢ toolkit detects and extracts metadata and text from over a thousand different file types (such as PPT, XLS, and PDF). All of these file types can be parsed through a single interface, making Tika useful for search engine indexing, content analysis, translation, and much more. è™½ç„¶è¯´æ˜¯Java é¡¹ç›®ï¼Œæˆ‘ä¸èƒ½ç›´æ¥å¼•å…¥åˆ°æˆ‘çš„ go é¡¹ç›®ä½¿ç”¨ï¼Œä½†æ˜¯äººå®¶æä¾›äº† APIï¼Œè¿™å°±éå¸¸çš„ nice äº†ã€‚ç„¶åå‡ ä¹åŒæ—¶æˆ‘å‘ç°äº† Google çš„ä¸€ä¸ªé¡¹ç›® go-tika, tika çš„ go è¯­è¨€ç‰ˆ client ç«¯ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä¸ç”¨å»å†™è°ƒç”¨ api ç›¸å…³ä»£ç äº†ï¼Œç®€ç›´åˆçœäº†æˆ‘ä¸å°‘æ—¶é—´ã€‚ ","date":"2022-03-04","objectID":"/posts/pdf-reader/:3:0","tags":["go","java","docker","pdf"],"title":"Go è¯­è¨€å®ç°è¯»å– pdf æ–‡ä»¶å†…å®¹","uri":"/posts/pdf-reader/"},{"categories":["ä»£ç æŠ€å·§"],"content":"3.1. éƒ¨ç½² å› ä¸º tika æ˜¯ä¸ª server ç«¯é¡¹ç›®ï¼Œé‚£æˆ‘å¾—ç”¨çš„æ—¶å€™éœ€è¦æŠŠä»–è·‘èµ·æ¥æ‰è¡Œï¼Œä½†æ˜¯æˆ‘æœ¬åœ°æ²¡æœ‰ Java ç¯å¢ƒï¼Œæˆ‘ä¹Ÿä¸æƒ³å»æŠ˜è…¾ï¼ˆè‡ªå·±åˆä¸æ‡‚ï¼Œçæç»å¯¹æµªè´¹æ—¶é—´è¿˜æä¸å®šï¼‰ã€‚æ‰€ä»¥æˆ‘è½¬å‘äº†ä¸‡èƒ½çš„ docker éƒ¨ç½²ã€‚æ‰¾åˆ° tika çš„ docker é•œåƒï¼Œæœ¬åœ°å¯åŠ¨å°±å¯ä»¥ç”¨äº†ã€‚ $ docker run -d -p 9998:9998 apache/tika:latest éƒ¨ç½²å®Œäº‹å„¿ã€‚ ","date":"2022-03-04","objectID":"/posts/pdf-reader/:3:1","tags":["go","java","docker","pdf"],"title":"Go è¯­è¨€å®ç°è¯»å– pdf æ–‡ä»¶å†…å®¹","uri":"/posts/pdf-reader/"},{"categories":["ä»£ç æŠ€å·§"],"content":"3.2. ä½¿ç”¨ ä½¿ç”¨æ–¹é¢ä¹Ÿæ˜¯éå¸¸ç®€å•ï¼Œæœ‰äº† go-tika é¡¹ç›®çš„åŠ æˆï¼Œæˆ‘éœ€è¦å†™çš„ä»£ç å‡ ä¹å¾ˆå°‘ï¼Œä»£ç å¦‚ä¸‹ï¼š package main import ( \"fmt\" \"flag\" \"context\" \"os\" \"github.com/google/go-tika/tika\" ) func main() { var filePath string flag.StringVar(\u0026filePath, \"fp\", \"\", \"pdf file path.\") flag.Parse() if filePath == \"\" { panic(\"file path must be provided\") } content, err := readPdf(filePath) // Read local pdf file if err != nil { panic(err) } fmt.Println(content) return } func readPdf(path string) (string, error) { f, err := os.Open(path) defer f.Close() if err != nil { return \"\", err } client := tika.NewClient(nil, \"http://127.0.0.1:9998\") return client.Parse(context.TODO(), f) } å“åº”é€Ÿåº¦å®Œå…¨åœ¨å¯æ¥å—èŒƒå›´å†…ï¼ˆ30ms å·¦å³ï¼‰ï¼Œè€Œä¸”æ›´è®©æˆ‘æƒŠå–œçš„æ˜¯ï¼Œä¹‹å‰åœ¨ç”¨ go è¯­è¨€çš„åº“è§£æå‡ºé”™çš„ pdf åœ¨è¿™é‡Œå®Œå…¨æ²¡é—®é¢˜ï¼Œæ²¡æœ‰æ¼æ‰ä¸€ä¸ªå­—çš„ç»™æˆ‘è§£æå‡ºæ¥äº†ã€‚å¯ä»¥è¯´æ˜¯å®Œå…¨è¾¾åˆ°æˆ‘çš„è¦æ±‚äº†ã€‚ ","date":"2022-03-04","objectID":"/posts/pdf-reader/:3:2","tags":["go","java","docker","pdf"],"title":"Go è¯­è¨€å®ç°è¯»å– pdf æ–‡ä»¶å†…å®¹","uri":"/posts/pdf-reader/"},{"categories":["ä»£ç æŠ€å·§"],"content":"4. æ€»ç»“ ä»æˆ‘ä¸ªäººçš„éœ€æ±‚ä¸Šé¢æ¥è¯´ tika æ˜¯å®Œèƒœçš„ï¼Œä½†æ˜¯é€Ÿåº¦ä¸Šçš„ç¡®æ²¡æœ‰ ledongthuc/pdf å¿«ï¼Œä½†æ˜¯åªæ˜¯å¿«å¹¶ä¸èƒ½è§£å†³é—®é¢˜ã€‚ledongthuc/pdf è¯»å–æ ‡å‡†çš„ pdf æ²¡é—®é¢˜ï¼Œå¦‚æœä½ çš„éœ€æ±‚æ˜¯è¯»å–ä¸€äº›æ ‡å‡†çš„ pdf ï¼Œé‚£ ledongthuc/pdf ç»å¯¹æ¯” tika å¥½ç”¨çš„ï¼Œåˆå¿«åˆä¸éœ€è¦æ­å»ºä¸€ä¸ª server ç«¯ã€‚ å¦‚æœä½ é‡åˆ°çš„ pdf ä¸èƒ½ä¿è¯æ¥æºå’Œè´¨é‡ï¼Œé‚£ tika æ›´é€‚åˆï¼Œè¯»å–å†…å®¹çš„æ¦‚ç‡æ›´é«˜ï¼Œæˆ‘è‡ªå·±æµ‹äº†å¤§æ¦‚ 100 æ¥ä»½å„ç§ pdfï¼ŒæˆåŠŸç‡ä¹Ÿå¾ˆé«˜ï¼Œé™¤éæ˜¯éå¸¸æ¨¡ç³Šçš„ pdfï¼Œå¦åˆ™éƒ½èƒ½è¯»å–åˆ°å†…å®¹ï¼Œè€Œä¸”å»¶è¿Ÿ 30ms å¯¹äºä¸€èˆ¬éœ€æ±‚æ¥è¯´æ˜¯è¶³å¤Ÿçš„ã€‚å†µä¸”æ˜¯ docker éƒ¨ç½²çš„æ— çŠ¶æ€æœåŠ¡ï¼Œå¦‚æœä½ è¦å¤§é‡çš„ pdf éœ€è¦å¤„ç†ï¼Œé‚£å°±å¤šæ­å»ºå‡ ä¸ª server ç«¯åŒæ—¶å¤„ç†å°±å¥½äº†ã€‚ å…¶ä»–æ–¹é¢çš„å¯¹æ¯” ï¼Œå¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼šhttps://www.jianshu.com/p/68609f51b6e7 è®²å¾—æ¯”è¾ƒç»†ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥å»é˜…è¯»ã€‚ å¦‚æœä½ æœ‰ä¸åŒçš„æƒ³æ³•ï¼Œé‚£å†è¯„è®ºåŒºè§å§~ ","date":"2022-03-04","objectID":"/posts/pdf-reader/:4:0","tags":["go","java","docker","pdf"],"title":"Go è¯­è¨€å®ç°è¯»å– pdf æ–‡ä»¶å†…å®¹","uri":"/posts/pdf-reader/"},{"categories":["ä»£ç æŠ€å·§"],"content":" æœ¬ç¯‡ä»‹ç»ä¸€ä¸ªç”¨ go å®ç°çš„è¿æ¥æ± ï¼Œé’ˆå¯¹è¿æ¥çš„ç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†ååˆ†æœ‰å¸®åŠ©ã€‚æœ¬ç¯‡ä»è¿æ¥æ± çš„è®¾è®¡åˆ°å®ç°ä»¥åŠå¸¸ç”¨åœºæ™¯è¿›è¡Œè¯¦è§£ã€‚ ","date":"2022-02-22","objectID":"/posts/conn-pool/:0:0","tags":["go","è¿æ¥æ± "],"title":"Go è¯­è¨€å®ç°è¿æ¥æ± ","uri":"/posts/conn-pool/"},{"categories":["ä»£ç æŠ€å·§"],"content":"1. èƒŒæ™¯ è¿æ¥æ±  å¯ä»¥è¯´æ˜¯åœ¨å¼€å‘ä¸­éå¸¸çš„å¸¸è§ï¼Œå„ç±»æˆ‘ä»¬éœ€è¦ä¸è¿œç«¯ä¿æŒé•¿è¿æ¥ä»è€Œæé«˜æœåŠ¡æ€§èƒ½ï¼ˆå‡å°‘å»ºç«‹è¿æ¥è¿‡ç¨‹ï¼‰ã€‚ å¦‚ï¼š æ•°æ®åº“è¿æ¥æ± ï¼ˆMySQLï¼ŒRedisç­‰ï¼‰ æ¶ˆæ¯é˜Ÿåˆ—çš„è¿æ¥æ± ï¼ˆå³producerç«¯æå‰å»ºç«‹è¿æ¥ï¼Œæå‡æ¶ˆæ¯äº§ç”Ÿé€Ÿç‡ï¼‰ ä¸å…¶ä»–è¿œç«¯æœåŠ¡ä¿æŒé•¿è¿æ¥ å¦‚æœä½¿ç”¨ä¸€äº›å¸¸è§çš„ç»„ä»¶ï¼Œå…¶ client ç«¯å…¶å®å·²ç»åšå¥½è¿æ¥æ± äº†ï¼Œæˆ‘ä»¬åˆå§‹åŒ–çš„æ—¶å€™ä»…éœ€è¦è®¾è®¡æ± å­å¤§å°ï¼Œç©ºé—²æ—¶é—´ç­‰å‚æ•°å°±å¯ä»¥ç”¨äº†ã€‚å¦‚æœæˆ‘ä»¬ç”¨çš„å®¢æˆ·ç«¯æ²¡æœ‰åšè¿æ¥æ± æˆ–è€…å› ä¸ºç§ç§åŸå› æˆ‘ä»¬éœ€è¦ä¸€ä¸ªè¿æ¥æ± çš„æ—¶å€™åº”è¯¥æ€ä¹ˆï¼Œæ€ä¹ˆè¯´è®¾è®¡å¥½å‘¢ï¼Ÿ ä¸‹é¢æˆ‘ä»¬å¼€å§‹è®²å¦‚ä½•è®¾è®¡ä»¥åŠå¦‚ä½•å®ç°ä¸€ä¸ªè¿æ¥æ± ã€‚ ","date":"2022-02-22","objectID":"/posts/conn-pool/:1:0","tags":["go","è¿æ¥æ± "],"title":"Go è¯­è¨€å®ç°è¿æ¥æ± ","uri":"/posts/conn-pool/"},{"categories":["ä»£ç æŠ€å·§"],"content":"2. è®¾è®¡ æˆ‘ä»¬å…ˆæ¢³ç†æˆ‘çš„éœ€æ±‚ï¼Œè¿æ¥æ± éƒ½æœ‰ä»€ä¹ˆåŠŸèƒ½ï¼Œåº”è¯¥æœ‰å“ªäº›æ¥å£å¯è°ƒç”¨å‘¢ï¼Ÿ Get è·å–ä¸€ä¸ªè¿æ¥ Put è¿æ¥æ”¾å›å» Close é‡Šæ”¾/å…³é—­è¿æ¥ è¿™ä¸¤ä¸ªå±äºæ˜¯æ ¸å¿ƒçš„èƒ½åŠ›äº†ï¼Œæˆ‘èƒ½æ‹¿åˆ°ä¸€ä¸ªå¯ç”¨çš„è¿æ¥ï¼Œå¹¶ä¸”ç”¨å®Œæ”¾å›å»æˆ–è€…æˆ‘éœ€è¦çš„è¯ è¿™ä¸ªè¿æ¥èƒ½è¢«å…³é—­ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œåº”è¯¥è¿˜æœ‰ä¸€ä¸ªæ•´ä¸ªè¿æ¥æ± é‡Šæ”¾çš„èƒ½åŠ›ï¼Œç¨‹åºé€€å‡ºæ˜¯éœ€è¦é‡Šæ”¾æ‰€æœ‰çš„è¿æ¥ã€‚ é‚£æˆ‘ä»¬å®šä¹‰ä¸€ä¸‹è¿™ä¸ª interface: // Pool åŸºæœ¬æ–¹æ³• type Pool interface { // è·å–èµ„æº Get() (interface{}, error) // èµ„æºæ”¾å›å» Put(interface{}) error // å…³é—­èµ„æº Close(interface{}) error // é‡Šæ”¾æ‰€æœ‰èµ„æº Release() // è¿”å›å½“å‰æ± å­å†…æœ‰æ•ˆè¿æ¥æ•°é‡ Len() int } è¿™ä¸ªå°±æ˜¯ä¸€ä¸ªè¿æ¥æ± åº”è¯¥å¯¹å¤–æä¾›çš„èƒ½åŠ›ï¼Œå¯¹äºä½¿ç”¨è€…æ¥è¯´è¶³çŸ£ã€‚ é—® ä»è¿æ¥æ± æ‹¿åˆ°çš„è¿æ¥æ˜¯ä»å“ªå„¿æ¥çš„ï¼Ÿ è¿™ä¸ªé—®é¢˜æ˜¯ä¸æ˜¯ä¹Ÿéå¸¸é‡è¦ï¼Œå…‰æœ‰è¿æ¥æ± è¿˜ä¸å¤Ÿï¼Œéœ€è¦ä¸€ä¸ªå·¥å‚å¯ä»¥ç”Ÿæˆä¸€ä¸ªæ–°çš„è¿æ¥ï¼Œæˆ‘éœ€è¦çš„æ—¶å€™èƒ½ä»è¿™ä¸ªå·¥å‚ç”Ÿæˆä¸€ä¸ªè¿æ¥å¹¶æ”¾å…¥è¿æ¥æ± ä¾›ä½¿ç”¨è€…è·å–ã€‚ å®šä¹‰ä¸€ä¸ªå·¥å‚çš„ interface: // ConnectionFactory è¿æ¥å·¥å‚ type ConnectionFactory interface { //ç”Ÿæˆè¿æ¥çš„æ–¹æ³• Factory() (interface{}, error) //å…³é—­è¿æ¥çš„æ–¹æ³• Close(interface{}) error //æ£€æŸ¥è¿æ¥æ˜¯å¦æœ‰æ•ˆçš„æ–¹æ³• Ping(interface{}) error } å·¥å‚çš„å®šä¹‰å¾ˆç®€å•ï¼Œåªéœ€è¦ä¸€ä¸ªäº§ç”Ÿè¿æ¥çš„æ–¹æ³•ï¼Œå¹¶ä¸”èƒ½å…³é—­è¿™ä¸ªè¿æ¥å’Œèƒ½å¯¹è¿™ä¸ªè¿æ¥è¿›è¡Œæ¢æ´»çš„æ–¹æ³•å³å¯ã€‚ å®šä¹‰äº† interface ä¹‹åå¥½å¤„åœ¨äºï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±å®ç°è¿æ¥æ± å’Œå·¥å‚ï¼Œä¹Ÿå¯ä»¥åªå®ç°è¿æ¥æ± ï¼Œå·¥å‚ç”±ä½¿ç”¨è€…å»å®ç°ï¼Œè¿™æ ·æˆ‘ä»¬çš„è¿æ¥æ± å˜å¾—æ›´åŠ çµæ´»é€šç”¨ã€‚ ","date":"2022-02-22","objectID":"/posts/conn-pool/:2:0","tags":["go","è¿æ¥æ± "],"title":"Go è¯­è¨€å®ç°è¿æ¥æ± ","uri":"/posts/conn-pool/"},{"categories":["ä»£ç æŠ€å·§"],"content":"3. å®ç° å®ç°è¿æ¥æ± æˆ‘ä»¬éœ€è¦è€ƒè™‘çš„é—®é¢˜æ¯”è®¾è®¡æ›´å…¨é¢ï¼Œä¸èƒ½å…‰è€ƒè™‘èƒ½æ‹¿/æ”¾è¿æ¥å°±è¡Œï¼Œè¿˜å¾—è€ƒè™‘ç®¡ç†è¿™äº›è¿æ¥å¹¶ä¸”æ”¯æŒæœ€å¤§è¿æ¥æ•°ã€æœ€å¤§ç©ºé—²è¿æ¥æ•°ã€åˆå§‹è¿æ¥æ•°ä»¥åŠè¿æ¥çš„è¶…æ—¶ä¸å¯ç”¨ç­‰æƒ…å†µã€‚ ","date":"2022-02-22","objectID":"/posts/conn-pool/:3:0","tags":["go","è¿æ¥æ± "],"title":"Go è¯­è¨€å®ç°è¿æ¥æ± ","uri":"/posts/conn-pool/"},{"categories":["ä»£ç æŠ€å·§"],"content":"3.1. ç»“æ„ä½“ ä¸‹é¢å…ˆè®¾è®¡æ•°æ®ç»“æ„ï¼š // channelPool å­˜æ”¾è¿æ¥ä¿¡æ¯ type channelPool struct { mu sync.RWMutex conns chan *idleConn // å­˜å‚¨æœ€å¤§ç©ºé—²è¿æ¥ factory ConnectionFactory // å·¥å‚ idleTimeout, waitTimeOut time.Duration // è¿æ¥ç©ºé—²è¶…æ—¶å’Œç­‰å¾…è¶…æ—¶ maxActive int // æœ€å¤§è¿æ¥æ•° openingConns int // æ´»è·ƒçš„è¿æ¥æ•° connReqs []chan connReq // è¿æ¥è¯·æ±‚ç¼“å†²åŒºï¼Œå¦‚æœæ— æ³•ä» conns å–åˆ°è¿æ¥ï¼Œåˆ™åœ¨è¿™ä¸ªç¼“å†²åŒºåˆ›å»ºä¸€ä¸ªæ–°çš„å…ƒç´ ï¼Œä¹‹åè¿æ¥æ”¾å›å»æ—¶å…ˆå¡«å……è¿™ä¸ªç¼“å†²åŒº } type idleConn struct { conn interface{} t time.Time } ä¸éš¾å‘ç°ï¼Œæ²¡æœ‰å­—æ®µå»å­˜æ‰€æœ‰çš„è¿æ¥ï¼Œä»…å­˜äº†æœ€å¤§ç©ºé—²è¿æ¥æ•°ï¼Œä¹Ÿå°±æ˜¯æ‹¿çš„è¿æ¥è¶…è¿‡æœ€å¤§ç©ºé—²è¿æ¥æ•°çš„æ—¶å€™ï¼Œåªä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„è¿æ¥è¿”å›ç»™ä½¿ç”¨è€…ï¼Œä½†æ˜¯ä¸ä¼šåœ¨ä»»ä½•å­—æ®µå»å­˜è¿™ä¸ªæ–°çš„äº§ç”Ÿçš„è¿æ¥ã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆåšå‘¢ï¼Ÿ ç­”ï¼šæœ€å¤§ç©ºé—²è¿æ¥æ•° è¿™ä¸ªæ¦‚å¿µå°±å¾ˆæ˜ç¡®ï¼Œæˆ‘æœ€å¤šåªä¼šä¿ç•™è¿™ä¹ˆå¤šç©ºé—²è¿æ¥ï¼Œè¶…è¿‡è¿™ä¸ªæ•°çš„ç©ºé—²è¿æ¥ç›´æ¥é‡Šæ”¾ã€‚ä½†æ˜¯ä¸å½±å“æˆ‘ä½¿ç”¨æ›´å¤šçš„è¿æ¥ï¼Œé™åˆ¶æœ€å¤§è¿æ¥æ•°çš„å­—æ®µæ˜¯ maxActive,æ€»è¿æ¥æ•°åœ¨è¿™ä¸ªé™åˆ¶ä¹‹ä¸‹å¯ä»¥ä¸€ç›´äº§ç”Ÿä½¿ç”¨ã€‚ä½¿ç”¨çš„æ—¶å€™å¯ä»¥é…ç½®æœ€å¤§è¿æ¥æ•° 1000ï¼Œè€Œæœ€å¤§ç©ºé—²è®¾ç½®ä¸º 10ï¼Œè¿™æ ·ç©ºé—²æ—¶åˆ»ä¸ä¼šå ç”¨å¤ªå¤šçš„èµ„æºï¼Œè€Œä½¿ç”¨é«˜å³°çš„æ—¶å€™åˆå¯ä»¥äº§ç”Ÿè¾¾åˆ° 1000 ä¸ªçš„è¿æ¥æ¥ç”¨ã€‚ ","date":"2022-02-22","objectID":"/posts/conn-pool/:3:1","tags":["go","è¿æ¥æ± "],"title":"Go è¯­è¨€å®ç°è¿æ¥æ± ","uri":"/posts/conn-pool/"},{"categories":["ä»£ç æŠ€å·§"],"content":"3.2. åˆå§‹åŒ– ä¸‹é¢å®ç°åˆå§‹åŒ–è¿æ¥æ± ç›¸å…³èƒ½åŠ›ï¼š // PoolConfig è¿æ¥æ± ç›¸å…³é…ç½® type PoolConfig struct { //è¿æ¥æ± ä¸­æ‹¥æœ‰çš„æœ€å°è¿æ¥æ•° InitialCap int //æœ€å¤§å¹¶å‘å­˜æ´»è¿æ¥æ•° MaxCap int //æœ€å¤§ç©ºé—²è¿æ¥ MaxIdle int // å·¥å‚ Factory ConnectionFactory //è¿æ¥æœ€å¤§ç©ºé—²æ—¶é—´ï¼Œè¶…è¿‡è¯¥äº‹ä»¶åˆ™å°†å¤±æ•ˆ IdleTimeout time.Duration } // NewChannelPool åˆå§‹åŒ–è¿æ¥ func NewChannelPool(poolConfig *PoolConfig) (Pool, error) { // æ ¡éªŒå‚æ•° if !(poolConfig.InitialCap \u003c= poolConfig.MaxIdle \u0026\u0026 poolConfig.MaxCap \u003e= poolConfig.MaxIdle \u0026\u0026 poolConfig.InitialCap \u003e= 0) { return nil, errors.New(\"invalid capacity settings\") } // æ ¡éªŒå‚æ•° if poolConfig.Factory == nil { return nil, errors.New(\"invalid factory interface settings\") } c := \u0026channelPool{ conns: make(chan *idleConn, poolConfig.MaxIdle), // æœ€å¤§ç©ºé—²è¿æ¥æ•° factory: poolConfig.Factory, idleTimeout: poolConfig.IdleTimeout, maxActive: poolConfig.MaxCap, openingConns: poolConfig.InitialCap, } // åˆå§‹åŒ–åˆå§‹è¿æ¥æ”¾å…¥ channel ä¸­ for i := 0; i \u003c poolConfig.InitialCap; i++ { conn, err := c.factory.Factory() if err != nil { c.Release() return nil, fmt.Errorf(\"factory is not able to fill the pool: %s\", err) } c.conns \u003c- \u0026idleConn{conn: conn, t: time.Now()} } return c, nil } ä¸Šé¢æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªé…ç½®çš„ç»“æ„ä½“ï¼Œæ–¹ä¾¿å¤–éƒ¨ä¼ å‚ã€‚ä¸ä»…æ”¯æŒäº†æœ€å¤§è¿æ¥æ•°ã€ç©ºé—²è¿æ¥æ•°ã€è¿æ¥è¶…æ—¶ï¼Œè¿˜æ”¯æŒäº†åˆå§‹è¿æ¥æ•°ï¼Œæ–¹ä¾¿åˆå§‹åŒ–å¿«é€Ÿä½¿ç”¨ã€‚ ","date":"2022-02-22","objectID":"/posts/conn-pool/:3:2","tags":["go","è¿æ¥æ± "],"title":"Go è¯­è¨€å®ç°è¿æ¥æ± ","uri":"/posts/conn-pool/"},{"categories":["ä»£ç æŠ€å·§"],"content":"3.3. è·å–è¿æ¥ ç°åœ¨å®ç°è·å–è¿æ¥çš„è¿‡ç¨‹ï¼š // Get ä»poolä¸­å–ä¸€ä¸ªè¿æ¥ func (c *channelPool) Get() (interface{}, error) { conns := c.getConns() if conns == nil { return nil, ErrClosed } for { select { // ä¼˜å…ˆä»ç©ºé—²è¿æ¥ç¼“å†²å– case wrapConn := \u003c-conns: if wrapConn == nil { return nil, ErrClosed } //åˆ¤æ–­æ˜¯å¦è¶…æ—¶ï¼Œè¶…æ—¶åˆ™ä¸¢å¼ƒ if timeout := c.idleTimeout; timeout \u003e 0 { if wrapConn.t.Add(timeout).Before(time.Now()) { //ä¸¢å¼ƒå¹¶å…³é—­è¯¥è¿æ¥ _ = c.Close(wrapConn.conn) continue } } //åˆ¤æ–­æ˜¯å¦å¤±æ•ˆï¼Œå¤±æ•ˆåˆ™ä¸¢å¼ƒï¼Œå¦‚æœç”¨æˆ·æ²¡æœ‰è®¾å®š ping æ–¹æ³•ï¼Œå°±ä¸æ£€æŸ¥ if err := c.Ping(wrapConn.conn); err != nil { _ = c.Close(wrapConn.conn) continue } return wrapConn.conn, nil default: // æ²¡æœ‰ç©ºé—²è¿æ¥ c.mu.Lock() log.Printf(\"openConn %v %v\", c.openingConns, c.maxActive) // åˆ¤æ–­è¿æ¥æ•°æ˜¯å¦è¾¾åˆ°ä¸Šé™ if c.openingConns \u003e= c.maxActive { req := make(chan connReq, 1) // å¦‚æœè¾¾åˆ°ä¸Šé™ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªç¼“å†²ä½ç½®ï¼Œç­‰å¾…æ”¾å›å»çš„è¿æ¥ c.connReqs = append(c.connReqs, req) c.mu.Unlock() // åˆ¤æ–­æ˜¯å¦æœ‰è¿æ¥æ”¾å›å»ï¼ˆæ”¾å›å»é€»è¾‘åœ¨ put æ–¹æ³•å†…ï¼‰ ret, ok := \u003c-req // å¦‚æœæ²¡æœ‰è¿æ¥æ”¾å›å»ï¼Œåˆ™ä¸èƒ½å†åˆ›å»ºæ–°çš„è¿æ¥äº†ï¼Œå› ä¸ºè¾¾åˆ°ä¸Šé™äº† if !ok { return nil, ErrMaxActiveConnReached } // å¦‚æœæœ‰è¿æ¥æ”¾å›å»äº† åˆ¤æ–­è¿æ¥æ˜¯å¦å¯ç”¨ if timeout := c.idleTimeout; timeout \u003e 0 { if ret.idleConn.t.Add(timeout).Before(time.Now()) { //ä¸¢å¼ƒå¹¶å…³é—­è¯¥è¿æ¥ // é‡æ–°å°è¯•è·å–è¿æ¥ _ = c.Close(ret.idleConn.conn) continue } } return ret.idleConn.conn, nil } // åˆ°è¿™é‡Œè¯´æ˜ æ²¡æœ‰ç©ºé—²è¿æ¥ \u0026\u0026 è¿æ¥æ•°æ²¡æœ‰è¾¾åˆ°ä¸Šé™ å¯ä»¥åˆ›å»ºæ–°è¿æ¥ if c.factory == nil { c.mu.Unlock() return nil, ErrClosed } conn, err := c.factory.Factory() if err != nil { c.mu.Unlock() return nil, err } // è¿æ¥æ•°+1 c.openingConns++ c.mu.Unlock() return conn, nil } } } éœ€è¦æ³¨æ„ if c.openingConns \u003e= c.maxActive { è¿™å—çš„é€»è¾‘ï¼Œå½“è¿æ¥æ•°è¾¾åˆ°ä¸Šé™æ—¶ï¼Œä¸ç”¨é©¬ä¸ŠæŠ¥é”™ï¼Œå¯ä»¥é€šè¿‡ connReqs æ¥å¤ç”¨ç”¨å®Œè¿˜æ²¡ release çš„è¿æ¥ï¼Œä»è€ŒèŠ‚çº¦ä¸€ä¸ªè¿æ¥ release ç„¶åé‡æ–°å»ºç«‹è¿æ¥çš„æ—¶é—´å’Œèµ„æºã€‚ ","date":"2022-02-22","objectID":"/posts/conn-pool/:3:3","tags":["go","è¿æ¥æ± "],"title":"Go è¯­è¨€å®ç°è¿æ¥æ± ","uri":"/posts/conn-pool/"},{"categories":["ä»£ç æŠ€å·§"],"content":"3.4. è¿æ¥æ”¾å› è®¾è®¡è¿æ¥æ± çš„æ—¶å€™è®¾è®¡äº†æ”¾å›è¿æ¥çš„æ¥å£ï¼Œå½“ä½¿ç”¨è€…æ‹¿åˆ°ä¸€ä¸ªè¿æ¥ç”¨å®Œåéœ€è¦æ”¾å›å»ï¼Œè¿™ä¸ªè¿æ¥æ ¹æ®æƒ…å†µä¼šç«‹åˆ»ç»™æ–°çš„è·å–è¿æ¥è¯·æ±‚ä½¿ç”¨ï¼Œä¹Ÿå¯èƒ½æ”¾åˆ°ç©ºé—²è¿æ¥çš„ç¼“å­˜æˆ–è€…é‡Šæ”¾ã€‚ å®ç°ä»£ç å¦‚ä¸‹ï¼š // Put å°†è¿æ¥æ”¾å›poolä¸­ func (c *channelPool) Put(conn interface{}) error { if conn == nil { return errors.New(\"connection is nil. rejecting\") } c.mu.Lock() defer c.mu.Unlock() if c.conns == nil { return c.Close(conn) } // å¦‚æœæœ‰è¯·æ±‚è¿æ¥çš„ç¼“å†²åŒºæœ‰ç­‰å¾…ï¼Œåˆ™æŒ‰é¡ºåºæœ‰é™ä¸ªå…ˆæ¥çš„è¯·æ±‚åˆ†é…å½“å‰æ”¾å›çš„è¿æ¥ if l := len(c.connReqs); l \u003e 0 { req := c.connReqs[0] copy(c.connReqs, c.connReqs[1:]) c.connReqs = c.connReqs[:l-1] req \u003c- connReq{ idleConn: \u0026idleConn{conn: conn, t: time.Now()}, } return nil } // å¦‚æœæ²¡æœ‰ç­‰å¾…çš„ç¼“å†²åˆ™å°è¯•æ”¾å…¥ç©ºé—²è¿æ¥ç¼“å†² select { case c.conns \u003c- \u0026idleConn{conn: conn, t: time.Now()}: return nil default: //è¿æ¥æ± å·²æ»¡ï¼Œç›´æ¥å…³é—­è¯¥è¿æ¥ return c.Close(conn) } } ","date":"2022-02-22","objectID":"/posts/conn-pool/:3:4","tags":["go","è¿æ¥æ± "],"title":"Go è¯­è¨€å®ç°è¿æ¥æ± ","uri":"/posts/conn-pool/"},{"categories":["ä»£ç æŠ€å·§"],"content":"3.5. é‡Šæ”¾è¿æ¥ é‡Šæ”¾è¿æ¥æœ‰ä¸¤ç§æƒ…å†µï¼Œé‡Šæ”¾å•ä¸ªè¿æ¥å’Œé‡Šæ”¾æ•´ä¸ªè¿æ¥æ± ï¼Œè€Œåº•å±‚åªå®ç°é‡Šæ”¾å•ä¸ªè¿æ¥çš„é€»è¾‘ï¼Œé‡Šæ”¾è¿æ¥æ± åˆ™ä¸€ä¸ªä¸ªè°ƒç”¨è¿™ä¸ªé‡Šæ”¾æ–¹æ³•å³å¯ã€‚ å®ç°é€»è¾‘å¦‚ä¸‹ï¼š // Close å…³é—­å•æ¡è¿æ¥ func (c *channelPool) Close(conn interface{}) error { if conn == nil { return errors.New(\"connection is nil. rejecting\") } c.mu.Lock() defer c.mu.Unlock() // è¿æ¥æ•°å‡ä¸€ c.openingConns-- // è°ƒç”¨å·¥å‚çš„å…³é—­æ–¹æ³• return c.factory.Close(conn) } // Release é‡Šæ”¾è¿æ¥æ± ä¸­æ‰€æœ‰è¿æ¥ func (c *channelPool) Release() { c.mu.Lock() conns := c.conns c.conns = nil c.mu.Unlock() defer func() { c.factory = nil }() if conns == nil { return } close(conns) for wrapConn := range conns { //log.Printf(\"Type %v\\n\",reflect.TypeOf(wrapConn.conn)) _ = c.factory.Close(wrapConn.conn) } } ","date":"2022-02-22","objectID":"/posts/conn-pool/:3:5","tags":["go","è¿æ¥æ± "],"title":"Go è¯­è¨€å®ç°è¿æ¥æ± ","uri":"/posts/conn-pool/"},{"categories":["ä»£ç æŠ€å·§"],"content":"3.6. å…¶ä»–æ–¹æ³• å®ç°è¿æ¥æ± çš„ Ping å’Œ Len æ–¹æ³•ä¹Ÿå¾ˆç®€å• ç›´æ¥ä¸Šä»£ç ã€‚ // Ping æ£€æŸ¥å•æ¡è¿æ¥æ˜¯å¦æœ‰æ•ˆ func (c *channelPool) Ping(conn interface{}) error { if conn == nil { return errors.New(\"connection is nil. rejecting\") } return c.factory.Ping(conn) } // Len è¿æ¥æ± ä¸­å·²æœ‰çš„è¿æ¥ func (c *channelPool) Len() int { return len(c.getConns()) } ","date":"2022-02-22","objectID":"/posts/conn-pool/:3:6","tags":["go","è¿æ¥æ± "],"title":"Go è¯­è¨€å®ç°è¿æ¥æ± ","uri":"/posts/conn-pool/"},{"categories":["ä»£ç æŠ€å·§"],"content":"4. å®é™…ä½¿ç”¨åœºæ™¯ ä»¥ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—çš„ producer çš„è¿æ¥æ± ä¸ºä¾‹ï¼Œä¸‹é¢è¯´æ˜å¦‚ä½•ä½¿ç”¨ã€‚ ","date":"2022-02-22","objectID":"/posts/conn-pool/:4:0","tags":["go","è¿æ¥æ± "],"title":"Go è¯­è¨€å®ç°è¿æ¥æ± ","uri":"/posts/conn-pool/"},{"categories":["ä»£ç æŠ€å·§"],"content":"4.1. åˆå§‹åŒ– åˆå§‹åŒ–æŒ‡å®šé…ç½®å‚æ•°å³å¯ï¼š pc := \u0026util.PoolConfig{ InitialCap: int(cfg.ProducerConnPoolSize), MaxCap: int(cfg.ProducerConnPoolSize), MaxIdle: int(cfg.ProducerConnPoolSize), Factory: \u0026producerFactory{addr: cfg.MQURL}, // producerFactory å®ç°äº†å·¥å‚çš„æ¥å£ åº•å±‚ä¸ºåˆ›å»º tcp è¿æ¥ IdleTimeout: time.Minute * 5, } pool, err := util.NewChannelPool(pc) if err != nil { return } ","date":"2022-02-22","objectID":"/posts/conn-pool/:4:1","tags":["go","è¿æ¥æ± "],"title":"Go è¯­è¨€å®ç°è¿æ¥æ± ","uri":"/posts/conn-pool/"},{"categories":["ä»£ç æŠ€å·§"],"content":"4.2. ä½¿ç”¨ ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š func (c *Client) getProducer() (p *mq.Producer, err error) { if c.producerPool == nil { err = fmt.Errorf(\"producer pool is not initialized\") return } v, err := c.producerPool.Get() if err != nil { return } p, ok := v.(*mq.Producer) if !ok { err = fmt.Errorf(\"cannot load producer from pool\") return } return p, nil } func (c *Client) putProducer(p *mq.Producer) { _ = c.producerPool.Put(p) } // Publish publish msg to topic and wait for the response. func (c *Client) Publish(topic string, body []byte) error { p, err := c.getProducer() if err != nil { return err } defer c.putProducer(p) return p.Publish(topic, body) } func (c *Client) Stop() { c.producerPool.Release() c.producerPool = nil } æ³¨æ„ è¿æ¥æ± ä½¿ç”¨å®Œæˆ–è€…ç¨‹åºé€€å‡ºæ—¶ï¼ŒåŠ¡å¿…é‡Šæ”¾è¿æ¥æ± èµ„æºã€‚ ","date":"2022-02-22","objectID":"/posts/conn-pool/:4:2","tags":["go","è¿æ¥æ± "],"title":"Go è¯­è¨€å®ç°è¿æ¥æ± ","uri":"/posts/conn-pool/"},{"categories":["ä»£ç æŠ€å·§"],"content":"5. æ€»ç»“ æœ¬ç¯‡ä»‹ç»äº†ä¸€ä¸ª go è¯­è¨€å®ç°çš„è¿æ¥æ± çš„è®¾è®¡ã€å®ç°ä»¥åŠå¦‚ä½•ä½¿ç”¨ã€‚è¿æ¥æ± ä½œä¸ºç¨‹åºå¼€å‘ä¸­éå¸¸å¸¸ç”¨çš„åŠŸèƒ½æ¨¡å—ï¼Œå³ä¾¿æ˜¯ä¸éœ€è¦è‡ªå·±å®ç°ä¹Ÿåº”è¯¥å¯¹å…¶åº•å±‚çš„å®ç°æœ‰ä¸ªå¤§æ¦‚çš„è®¤çŸ¥ã€‚ äº†è§£è¿æ¥æ± çš„æ¦‚å¿µ äº†è§£è¿æ¥æ± çš„ä¸»è¦èƒ½åŠ› äº†è§£å·¥å‚æ¨¡å¼ è®¾è®¡ä¸€ä¸ªè¿æ¥æ±  æ ¹æ®è®¾è®¡å®ç°è¿æ¥æ±  åŠ å…¥äº†è¿æ¥æ•°çš„æ§åˆ¶ æ¥å…¥è¿æ¥è¶…æ—¶æ ¡éªŒ å­¦ä¼šä½¿ç”¨è¿æ¥æ±  ","date":"2022-02-22","objectID":"/posts/conn-pool/:5:0","tags":["go","è¿æ¥æ± "],"title":"Go è¯­è¨€å®ç°è¿æ¥æ± ","uri":"/posts/conn-pool/"},{"categories":["é¡¹ç›®ç»éªŒ"],"content":" æˆ‘æƒ³å°†è‡ªå·±çš„å¼€å‘é¡¹ç›®çš„ç»å†ä»¥åŠè¿‡ç¨‹ä¸­æ€»ç»“çš„ç»éªŒæˆ–è€…ä¸€äº›å°æŠ€å·§æ•´ç†å‡ºæ¥ï¼Œä¾›è‡ªå·±å’Œçœ‹åˆ°è¿™ç¯‡æ–‡ç« çš„åŒå­¦ä¸€ä¸ªå‚è€ƒã€‚å†…å®¹åŒ…æ‹¬ä½†ä¸é™äºï¼Œé¡¹ç›®ç›®å½•ç»“æ„ï¼Œæ¨¡å—æ‹†åˆ†ï¼Œå•å…ƒæµ‹è¯•ï¼Œe2e æµ‹è¯•ï¼Œgit çš„ä½¿ç”¨æŠ€å·§ï¼ŒGitHub çš„ actionflow çš„ä½¿ç”¨æŠ€å·§ç­‰ã€‚ ","date":"2022-01-24","objectID":"/posts/go-project-experience/:0:0","tags":["go","å¼€å‘","ç»´æŠ¤"],"title":"Go é¡¹ç›®å¼€å‘å’Œç»´æŠ¤ç»éªŒä¹‹è°ˆ","uri":"/posts/go-project-experience/"},{"categories":["é¡¹ç›®ç»éªŒ"],"content":"1. å‰è¨€ åš go å¼€å‘æœ‰å‡ å¹´çš„æ—¶é—´äº†ï¼Œä»æœ€å¼€å§‹çš„åªä¼šå†™ä¸€äº›ç®€å•çš„ä»£ç åˆ°ç°åœ¨é™¤äº†æ—¥å¸¸ç¼–ç å¤–ä¼šè€ƒè™‘ä¸€ä¸ªé¡¹ç›®çš„å‰å‰åå(è‡ªè®¤ä¸ºè€ƒè™‘çš„æ¯”è¾ƒå…¨)ï¼Œä»£ç ç®¡ç†ï¼Œé¡¹ç›®ç»“æ„ä»¥åŠç›¸å…³çš„å·¥å…·æ­é…ä½¿ç”¨ï¼Œ èµ°äº†å¾ˆå¤šçš„å¼¯è·¯ï¼Œåšäº†å¾ˆå¤šçš„é‡å¤å·¥ä½œï¼Œåˆ°ç›®å‰ä¸ºæ­¢ç§¯ç´¯äº†ä¸€äº›ç»éªŒã€‚æƒ³é€šè¿‡è¿™ç¯‡æ–‡ç« è¾“å‡ºä¸€ä¸ªæ€»ç»“ï¼Œæ–¹ä¾¿è‡ªå·±ä»¥åŠçœ‹åˆ°è¿™ç¯‡æ–‡ç« çš„åŒå­¦ä»¬ä¹‹ååœ¨åšæ–°é¡¹ç›®çš„æ—¶å€™æœ‰ä¸€å®šçš„å¯å‘ã€‚ æ¸©é¦¨æç¤º è¿™ç¯‡æ–‡ç« å¯èƒ½å­˜åœ¨ä¸€å®šçš„æ¼æ´ï¼Œå¦‚å‘ç°ä»»ä½•æ‚¨è®¤ä¸ºä¸å¯¹çš„åœ°æ–¹ï¼Œå¸Œæœ›èƒ½ç»™æˆ‘ä¸€ä¸ªç•™è¨€ã€‚ ","date":"2022-01-24","objectID":"/posts/go-project-experience/:1:0","tags":["go","å¼€å‘","ç»´æŠ¤"],"title":"Go é¡¹ç›®å¼€å‘å’Œç»´æŠ¤ç»éªŒä¹‹è°ˆ","uri":"/posts/go-project-experience/"},{"categories":["é¡¹ç›®ç»éªŒ"],"content":"2. é¡¹ç›®ç®¡ç† é¡¹ç›®ç®¡ç† è¿™ä¸ªæ¨¡å—æˆ‘æƒ³åˆ†äº«ä¸€äº›ï¼Œåœ¨å¼€å‘è¿‡ç¨‹ä¸­éœ€è¦æ³¨æ„çš„æˆ–è€…å€¼å¾—å­¦ä¹ çš„çŸ¥è¯†ç‚¹ï¼Œä»è€Œæå‡å¼€å‘æ•ˆç‡å‡å°‘ä¸€äº›å‡ºé”™çš„æ¦‚ç‡ï¼ŒåŒæ—¶æé«˜å¯¹é¡¹ç›®çš„æ•´ä½“çš„ç†è§£ã€‚ ","date":"2022-01-24","objectID":"/posts/go-project-experience/:2:0","tags":["go","å¼€å‘","ç»´æŠ¤"],"title":"Go é¡¹ç›®å¼€å‘å’Œç»´æŠ¤ç»éªŒä¹‹è°ˆ","uri":"/posts/go-project-experience/"},{"categories":["é¡¹ç›®ç»éªŒ"],"content":"2.1. ç›®å½•ç»“æ„ ç›®å½•ç»“æ„åœ¨ä¸€äº›è¯­è¨€ä¼šæœ‰å¾ˆä¸¥æ ¼çš„è¦æ±‚ï¼Œä½†æ˜¯å¦‚æœä½ çœ‹è¿‡çš„ go é¡¹ç›®æ¯”è¾ƒå¤šä½ ä¼šå‘ç°ï¼Œå¤§å®¶åˆ†ç›®å½•å„æœ‰å„çš„å¥½å¤„å„æœ‰å„çš„ç†ç”±ã€‚æ‰€ä»¥è¿™é‡Œå¹¶æ²¡æœ‰å¯¹é”™ï¼Œæˆ‘åˆ†äº«å‡ ä¸ªé«˜åˆ†çš„å¼€æºé¡¹ç›®ä»¥åŠè‡ªå·±åœ¨åšä¸€äº› web é¡¹ç›®çš„æ—¶å€™ç»å¸¸ç”¨çš„ç›®å½•ç»“æ„ï¼Œä»è€…è§ä»æ™ºè€…è§æ™ºå§ã€‚ 2.1.1. pkg å¼ç›®å½• è¿™ç±»åˆ†ç›®å½•åœ¨å¼€æºé¡¹ç›®å†…ååˆ†å¸¸è§ï¼Œå°¤å…¶æ˜¯ k8s ä»¥åŠç›¸å…³ç»„ä»¶çš„é¡¹ç›®ç»“æ„éƒ½æ˜¯è¿™ç±»ï¼Œä¸‹é¢çœ‹ä¸€ä¸‹å¤§æ¦‚çš„ç›®å½•ç»“æ„ã€‚ ä»¥ KEDA ä¸ºä¾‹ï¼š å…¶ä¸­ä¸€äº›ç›®å½•ä¸ºäº†å°½é‡å±•ç¤ºå¸¸è§çš„ç›®å½•æ‰‹åŠ¨è¡¥ä¸Šçš„ï¼Œå®é™…é¡¹ç›®ä¸­ä¸ä¸€å®šå­˜åœ¨ã€‚ âœ tree -L 2 . â”œâ”€â”€ BUILD.md â”œâ”€â”€ CHANGELOG.md â”œâ”€â”€ CONTRIBUTING.md â”œâ”€â”€ CREATE-NEW-SCALER.md â”œâ”€â”€ LICENSE â”œâ”€â”€ Makefile â”œâ”€â”€ PROJECT â”œâ”€â”€ README.md â”œâ”€â”€ RELEASE-PROCESS.MD â”œâ”€â”€ SECURITY.md â”œâ”€â”€ api/ ## å…¬ç”¨çš„ proto api æˆ– å…¨å±€ç»“æ„å®šä¹‰ï¼Œå¦‚ k8s é¡¹ç›®é‡Œ api ç›®å½•é‡Œæ”¾å…¥æ‰€æœ‰èµ„æºå¯¹è±¡çš„å®šä¹‰ â”œâ”€â”€ build/ ## æ„å»ºç›¸å…³çš„è„šæœ¬(Dockerfile) â”œâ”€â”€ config/ ## é…ç½®æ–‡ä»¶ â”œâ”€â”€ cmd/ ## ç¨‹åºå…¥å£ â”‚ â”œâ”€â”€ controller ## ä¸åŒç›®å½•å®ç°ä¸åŒçš„åŠŸèƒ½ â”‚ â””â”€â”€ admin â”œâ”€â”€ docs/ ## ç”Ÿæˆçš„æ–‡æ¡£ â”œâ”€â”€ go.mod â”œâ”€â”€ go.sum â”œâ”€â”€ hack/ ## ä»£ç ç”Ÿæˆç›¸å…³å·¥å…·å’Œè„šæœ¬ â”œâ”€â”€ pkg/ ## è¯¥é¡¹ç›®çš„åŠŸèƒ½ä»£ç  â”‚ â”œâ”€â”€ eventreason â”‚ â”œâ”€â”€ generated â”‚ â”œâ”€â”€ metrics â”‚ â”œâ”€â”€ mock â”‚ â”œâ”€â”€ provider â”‚ â”œâ”€â”€ scalers â”‚ â”œâ”€â”€ scaling â”‚ â””â”€â”€ util â”œâ”€â”€ tests/ ## æµ‹è¯•æ•°æ®æˆ–æµ‹è¯•å·¥å…·ï¼ˆå¹¶éæµ‹è¯•ä»£ç åœ¨è¿™é‡Œï¼‰ â”œâ”€â”€ tools/ ## å…¶ä»–å·¥å…·ï¼Œå¦‚æ£€æŸ¥ä»£ç é£æ ¼ ç»Ÿè®¡ä»£ç é‡ç­‰ â””â”€â”€ third_party/ ## ç¬¬ä¸‰æ–¹çš„protobuf æ–‡ä»¶æˆ–æ— æ³•é€šè¿‡ go mod æ‹‰å–çš„ä»£ç ç­‰ æœ€å¤§çš„ç‰¹ç‚¹æ˜¯ï¼Œæ‰€æœ‰çš„é¡¹ç›®åŠŸèƒ½ç›¸å…³çš„ä»£ç éƒ½åœ¨ pkg ç›®å½•ä¸‹æ ¹æ®åŠŸèƒ½æ‹†åˆ†ã€‚pkg ä¹‹å¤–çš„ç›®å½•ä¼šæ”¾æµ‹è¯•ï¼Œæ–‡æ¡£ï¼Œæ„å»ºï¼Œå‘å¸ƒï¼Œé…ç½®ç­‰å†…å®¹ã€‚ å…¶ä¸­ cmd ä¸ºç¨‹åºçš„å…¥å£ï¼Œæ ¹æ®åŠŸèƒ½ä¼šæ‹†å­ç›®å½•ï¼Œæ¯ä¸ªå­ç›®å½•ä¸‹ä¼šæœ‰ä¸€ä¸ª main æ–‡ä»¶ï¼Œå¯åŠ¨æœåŠ¡ã€‚ è¿™ä¸ªç›®å½•ç»“æ„çš„é¡¹ç›®ä¸€èˆ¬éƒ½æ˜¯ä½“é‡æ¯”è¾ƒå¤§ï¼Œæµ‹è¯•æ„å»ºå‘å¸ƒè¿‡ç¨‹éƒ½æ¯”è¾ƒå¤æ‚ï¼Œæ‰€ä»¥ä¼šæœ‰å¤§é‡çš„è„šæœ¬æˆ–è€…å·¥å…·é›†æ¥è‡ªåŠ¨åŒ–è¿™äº›å¤æ‚çš„è¿‡ç¨‹ã€‚å¦‚æœä»£ç é‡æ¯”è¾ƒå°‘æˆ–è€…æ²¡æœ‰è¿‡å¤šçš„ä¾èµ–ï¼Œåˆ™è¿™ç§ç›®å½•ç»“æ„å°±ä½“ç°ä¸å‡ºä¼˜åŠ¿ã€‚ 2.1.2. æŒ‰åŠŸèƒ½åˆ†ç›®å½• è¿™ç§ç±»å‹çš„ç›®å½•ç»“æ„ï¼Œåœ¨å„ç§æ¡†æ¶ç±»å‹çš„é¡¹ç›®ä¸­ååˆ†å¸¸è§ï¼Œå¦‚ go-micro, kratos ç­‰ã€‚ ä»¥ go-micro ä¸ºä¾‹ï¼š âœ tree -L 1 . â”œâ”€â”€ LICENSE â”œâ”€â”€ README.md â”œâ”€â”€ api/ ## æ¥å£å®šä¹‰ â”œâ”€â”€ auth/ ## è®¤è¯ç›¸å…³ â”œâ”€â”€ broker/ ## MQ çš„ broker â”œâ”€â”€ client/ ## http/rpc client â”œâ”€â”€ cmd/ ## é¡¹ç›®ç›¸å…³å·¥å…· xxx-generator ç­‰ æˆ–å¯åŠ¨å‚æ•°çš„å¤„ç† â”œâ”€â”€ codec/ ## ç¼–ç ç±»å‹å®šä¹‰ json yaml pb ç­‰ â”œâ”€â”€ config/ ## é…ç½® â”œâ”€â”€ debug/ ## debug â”œâ”€â”€ errors/ ## é”™è¯¯ç±»å‹å®šä¹‰ â”œâ”€â”€ event.go â”œâ”€â”€ examples/ ## å„ä¸ªæ¨¡å—çš„ä½¿ç”¨æ¡ˆä¾‹ â”œâ”€â”€ go.mod â”œâ”€â”€ go.sum â”œâ”€â”€ logger/ ## æ—¥å¿—æ¨¡å—çš„å®šä¹‰ â”œâ”€â”€ metadata/ ## å…ƒæ•°æ® â”œâ”€â”€ micro.go ## åœ¨è¿™é‡Œæä¾›å¯¹å¤–çš„æ¥å£å’Œæ–¹æ³• â”œâ”€â”€ options.go ## å„ç±»å¯é€‰å‚æ•°å®šä¹‰ â”œâ”€â”€ plugins/ ## æ’ä»¶ ä¸€èˆ¬ä¼šåœ¨è¿™é‡Œæ”¾èµ·ç æ¨¡å—å®šä¹‰çš„å„ç§å®ç°ï¼ˆå¦‚åŸºäº etcd/nacos/consul çš„æœåŠ¡å‘ç°ç­‰ï¼‰ â”œâ”€â”€ registry/ ## æœåŠ¡å‘ç°ç›¸å…³å®šä¹‰ â”œâ”€â”€ runtime/ ## è¿è¡Œæ—¶ç›¸å…³ä»£ç  â”œâ”€â”€ selector/ ## æœåŠ¡é€‰æ‹©ç›¸å…³ â”œâ”€â”€ server/ ## æœåŠ¡ç«¯ç›¸å…³å®šä¹‰ â”œâ”€â”€ service.go ## æœåŠ¡å¯åŠ¨ç›¸å…³ â”œâ”€â”€ service_test.go â”œâ”€â”€ store/ ## å­˜å‚¨ç›¸å…³ â”œâ”€â”€ sync/ ## æ•°æ®åŒæ­¥ç›¸å…³å®šä¹‰ â”œâ”€â”€ transport/ ## ç½‘ç»œè½¬å‘ç›¸å…³ http/grpc â””â”€â”€ util/ ## å…¶ä»–å·¥å…·ç±» è¿™ç±»ç›®å½•æœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯åˆ†ç›®å½•åˆ†æ¨¡å—æ¯”è¾ƒå¤šä¸”ç›¸äº’ä¸å½±å“ã€‚ç”±äºæ˜¯æ¡†æ¶ï¼Œæ‰€ä»¥è¿™ç§åšæ³•ååˆ†é‡è¦ï¼Œåˆ«äººå¼•ç”¨çš„æ—¶å€™æ ¹æ®è‡ªå·±çš„éœ€è¦é€‰æ‹©å¼•ç”¨å…¶ä¸­çš„ä¸€éƒ¨åˆ†ç›®å½•ã€‚å¹¶ä¸”å¤§éƒ¨åˆ†ç›®å½•éƒ½æ˜¯å®šä¹‰æ¥å£ Interface, å¹¶ä¸”åœ¨è‡ªå·±æ¡†æ¶å†…éƒ½åªä¼šç”¨æ¥å£ï¼Œä»è€Œåšåˆ°ä½¿ç”¨è€…å¯ä»¥è‡ªå·±å®ç°å¹¶è½»æ¾æ›¿æ¢è°ƒä»»æ„æ¨¡å—ã€‚ä½œä¸ºä¸€ä¸ªæ¡†æ¶çš„ç›®å½•ç»“æ„ä»¥åŠæ¯ä¸ªç›®å½•éƒ½å®šä¹‰æ¥å£çš„æ–¹å¼ï¼Œå¯ä»¥è¯´æ˜¯éå¸¸çš„é«˜æ˜ã€‚è¿™ä¸ªé¡¹ç›®å¯ä»¥è¯´æ˜¯å¯¹æˆ‘çš„ç›Šå¤„éå¸¸å¤šï¼Œå¯¹äºä¸€ä¸ª 1-3 å¹´çš„ç¨‹åºå‘˜éå¸¸æœ‰å¿…è¦å¥½å¥½ç ”ç©¶ä¸€ä¸‹è¿™ä¸ªé¡¹ç›®ã€‚ 2.1.3. è£¸è·‘å‹ ä»¥ gin ä¸ºä¾‹ï¼Œè™½ç„¶ä¹Ÿæ˜¯ä¸€ä¸ªæ¡†æ¶ï¼Œä½†æ˜¯åŠŸèƒ½é›†ä¸­åœ¨æ ¹ç›®å½•ï¼Œå¤§éƒ¨åˆ†çš„èƒ½åŠ›éƒ½æ˜¯ gin.XXX çš„æ–¹å¼è°ƒç”¨ï¼Œæ‰€ä»¥è¿™ç±»é¡¹ç›®åŸºæœ¬ä¸åˆ†ç›®å½•ï¼Œä»…æœ‰ä¸€äº›æµ‹è¯•å’Œæ„å»ºç›¸å…³çš„å‡ ä¸ªç›®å½•ï¼Œä¸€èˆ¬è¿™ä¹ˆç”¨çš„å°‘ä¹‹åˆå°‘ã€‚å½“ç„¶ä½ çš„é¡¹ç›®å¾ˆå°ï¼Œä»…æä¾›å•ä¸ªåŠŸèƒ½çš„æ—¶å€™ä¸åˆ†ç›®å½•ä¹Ÿç½¢ã€‚ 2.1.4. web é¡¹ç›® web é¡¹ç›®æˆ‘ä¹‹å‰æ¥è§¦çš„æ¯”è¾ƒå¤šï¼Œå‚åŠ äº†æ— æ•°ä¸ªå¤§å¤§å°å°çš„ web é¡¹ç›®ï¼Œç»è¿‡æ— æ•°æ¬¡çš„æŠ˜è…¾å’Œå¸å–ä»–äººç»éªŒï¼Œæœ‰äº†æ¯”è¾ƒç»Ÿä¸€çš„ç›®å½•ç»“æ„ï¼Œå¸Œæœ›èƒ½å¯¹åœ¨è¿™æ–¹é¢æœ‰éœ€æ±‚çš„åŒå­¦æœ‰å¸®åŠ©ã€‚ âœ tree . â”œâ”€â”€ Makefile ## èšåˆå„ç±»å¸¸ç”¨å‘½ä»¤ â”œâ”€â”€ app ## ç¨‹åºå…¥å£ â”‚ â”œâ”€â”€ admin ## admin ç«¯çš„å…¥å£ï¼ˆåŒ…å«æœåŠ¡åˆå§‹åŒ–ï¼Œå¯åŠ¨ï¼‰ â”‚ â””â”€â”€ server ## server ç«¯ï¼ˆåŒ…å«æœåŠ¡åˆå§‹åŒ– æœåŠ¡æ³¨å†Œå‘ç° ç›‘æ§ç­‰ï¼‰å¦‚æœä½¿ç”¨ä»»ä½•æ¡†æ¶ï¼Œä¹Ÿåœ¨è¿™é‡Œè¿›è¡Œåˆå§‹ â”œâ”€â”€ broker ## MQ çš„æ³¨å†Œå’Œæ¶ˆè´¹ â”œâ”€â”€ cmd ## å¸¸ç”¨å·¥å…·äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä»£ç ç”Ÿæˆ æ–‡æ¡£ç”Ÿæˆç­‰ â”œâ”€â”€ build ## æ„å»ºç›¸å…³è„šæœ¬ â”œâ”€â”€ config ## é…ç½®çš„å®šä¹‰å’Œåˆå§‹åŒ– â”œâ”€â”€ dao ## DAO å±‚ï¼Œæ ¹æ®æ¨¡å—æ‹†åˆ†ï¼Œå®ç°æ•°æ®çš„å¢åˆ æ”¹æŸ¥ â”‚ â”œâ”€â”€ order â”‚ â””â”€â”€ user â”œâ”€â”€ docs ## æ–‡æ¡£ç”Ÿæˆç›®å½• â”œâ”€â”€ dto ## ä¼ è¾“å±‚æ•°æ®å®šä¹‰ â”œâ”€â”€ middleware ## ä¸­é—´ä»¶ â”œâ”€â”€ router ## router ä¸ºè·¯ç”±å®šä¹‰ï¼Œè¿™å—ç›®å½•ç»“æ„æ¯”è¾ƒæ·± ä½†æ˜¯æˆ‘è®¤ä¸ºæ˜¯æœ‰å¿…è¦çš„ æ¯ä¸€å±‚å æ®è·¯ç”±ä¸Šçš„ä¸€ä¸ªä½ç½® â”‚ â”œâ”€â”€ admin ## ç¬¬ä¸€å±‚æ‹†åˆ†å¼€ admin å’Œ server å› ä¸ºè¯¥é¡¹ç›®æœ€ç»ˆæ„å»ºä¸¤ä¸ªç¨‹åº åˆ†åˆ«é€šè¿‡ç®¡ç†ç«¯å’ŒæœåŠ¡ç«¯å†…å®¹ â”‚ â”‚ â”œâ”€â”€ register.go ## æ³¨å†Œè·¯ç”± â”‚ â”‚ â”œâ”€â”€ v1 ## ä¸€å®šè¦åŠ ç‰ˆæœ¬å·ï¼Œåœ¨å‘ç”Ÿé‡å¤§ä¿®æ”¹æ—¶æå‡ç‰ˆæœ¬å· ä¸è¦ç›´æ¥æ”¹æ‰åŸæœ‰çš„è·¯ç”±ï¼ˆé™¤éæœ‰å®‰å…¨éšæ‚£ï¼‰ â”‚ â”‚ â”‚ â”œâ”€â”€ order ## æ ¹æ®æ¨¡å—æ‹†ç›®å½• â”‚ â”‚ â”‚ â”‚ â”œâ”€â”€ manage ## å¦‚æœæ¨¡å—åŒ…å«å†…å®¹æ¯”è¾ƒå¤š å¯ä»¥æ‹†å­ç›®å½• â”‚ â”‚ â”‚ â”‚ â”‚ â””â”€â”€ manage.go ## å­ç›®å½•ä¸‹çš„è·¯ç”± handlerï¼Œå¯ä»¥åŒ…å«å¤šä¸ª handler â”‚ â”‚ â”‚ â”‚ â””â”€â”€ statistic â”‚ â”‚ â”‚ â”‚ â””â”€â”€ statistic.go ## è¿™ä¸€å±‚çš„handler çš„è·¯ç”±åº”è¯¥ /admin/v1/order/statistic/xxx â”‚ â”‚ â”‚ â”œâ”€â”€ user ## æ¨¡å—æ‹†åˆ† â”‚ â”‚ â”‚ â”‚ â””â”€â”€ user.go ## å¦‚æœåŒ…å«å†…å®¹ä¸å¤šå¯ä»¥ç›´æ¥æ”¾ handler æ–‡ä»¶ /admin/v1/user/xxx â”‚ â”‚ â”‚ â””â”€â”€ v1.go ## æ³¨å†Œ v1 ç‰ˆæœ¬è·¯ç”± åŒæ—¶æ³¨å†Œè¿™ä¸€å±‚çš„ middleware â”‚ â”‚ â””â”€â”€ v2 ## ä¸ v1 ç±»ä¼¼ï¼ŒæœåŠ¡é‡æ„æˆ–ä¸åŸæ¥å£å‘ç”Ÿå†²çª åˆ™å‡çº§ç‰ˆæœ¬ â”‚ â”‚ â”œâ”€â”€ order â”‚ â”‚ â”œâ”€â”€ share â”‚ â”‚ â”œâ”€â”€ user â”‚ â”‚ â””â”€â”€ v2.go â”‚ â””â”€â”€ server ## æœåŠ¡ç«¯çš„è·¯ç”±æ³¨å†Œ æ•´ä½“ä¸ admin ç«¯ä¸€è‡´ â”‚ â”œâ”€â”€ register.go â”‚ â”œâ”€â”€ v1 â”‚ â”‚ â”œâ”€â”€ user â”‚ â”‚ â”‚ â”œâ”€â”€ action.go ## /server/v1/user/xxx â”‚ â”‚ â”‚ â””â”€â”€ manage â”‚ â”‚ â”‚ â””â”€â”€ manage.go ## /server/v1/user/manage/xxx â”‚ â”‚ â””â”€â”€ v1.go â”‚ â””â”€â”€ v2 â”‚ â”œâ”€â”€ order â”‚ â”œâ”€â”€ share â”‚ â”œâ”€â”€ user â”‚ â””â”€â”€ v2.go â”œâ”€â”€ service ## service å†…åŒ…å«ä¸šåŠ¡é€»è¾‘ è¡”æ¥ä¸Šå±‚è¯·æ±‚å’Œä¸‹å±‚æ•°æ®çš„å¢åˆ æ”¹æŸ¥ â”‚ â”œâ”€â”€ order ## æŒ‰åŠŸèƒ½æ‹†åˆ†ç›®å½• â”‚ â”‚ â”œâ”€â”€ order_service.go ## ä¸åŒ dao å±‚æ–¹æ³•çš„ç»„åˆ ç”šè‡³å¯ä»¥é€šè¿‡ä¸Šä¸‹æ–‡ä¼  session çš„æ–¹å¼ æ”¯æŒä¸åŒdao å±‚æ–¹å¼ä¹‹é—´çš„äº‹åŠ¡ â”‚ â”‚ â””â”€â”€ order_statistic_service.go â”‚ â””â”€â”€ user â”‚ â””â”€â”€ user_service.go â”œâ”€â”€ tests ## æµ‹è¯•ç›¸å…³å·¥å…·å’Œè„šæœ¬ â”œâ”€â”€ logger ## æ—¥å¿—æ¨¡å— â””â”€â”€ thrid_party ## ç¬¬ä¸‰æ–¹çš„ protobuf ä¸€èˆ¬æ”¾è¿™å„¿ æ•´ä½“","date":"2022-01-24","objectID":"/posts/go-project-experience/:2:1","tags":["go","å¼€å‘","ç»´æŠ¤"],"title":"Go é¡¹ç›®å¼€å‘å’Œç»´æŠ¤ç»éªŒä¹‹è°ˆ","uri":"/posts/go-project-experience/"},{"categories":["é¡¹ç›®ç»éªŒ"],"content":"2.2. æ¨¡å—æ‹†åˆ† è¿™ä¸ªå°±æ²¡ä»€ä¹ˆå¯è¯´çš„ï¼Œå•ç‹¬æå‡ºæ¥æ˜¯ä¸ºäº†æé†’è‡ªå·±å’Œå„ä½ï¼Œèƒ½æ‹†åˆ†å°½é‡æ‹†åˆ†ï¼Œä¸è¦ä¸€ä¸ªæ–‡ä»¶ä¸Šåƒè¡Œä»£ç ï¼Œä¸€ä¸ªæ–¹æ³•å‡ ç™¾è¡Œä»£ç ï¼Œåˆ«äººçœ‹çš„æ—¶å€™çœŸçš„å¾ˆç—›è‹¦ã€‚ 2.2.1. æ‹†åˆ†æ–¹æ³• è¿™ä¸ªæ¯”è¾ƒå¥½æ‹†ï¼Œå”¯ä¸€çš„åŸåˆ™å°±æ˜¯ä¸€ä¸ªæ–¹æ³•åªåšä¸€ä»¶äº‹å„¿ã€‚è¿™ä¸ªä¸€ä»¶äº‹å„¿å¯å¤§å¯å°ï¼Œè¿™æ˜¯åŸºäºå½“å‰è¿™ä¸ªæ–¹æ³•æ‰€åœ¨çš„å±‚çº§è€Œå®šã€‚ å¦‚æœå¤„äºåº•å±‚æ“ä½œæ•°æ®åº“çš„å±‚çº§ï¼Œé‚£ä½ çš„æ–¹æ³•åº”è¯¥åªè¿›è¡Œä¸€ä¸ªæ•°æ®åº“æ“ä½œï¼ˆä¸ç®¡å¢åˆ æ”¹æŸ¥ï¼‰ï¼Œå„ç§ç»„åˆæˆ–è€…äº‹åŠ¡åº”è¯¥ä¸Šå±‚å»åšã€‚ å¦‚æœä½ åœ¨ä¸šåŠ¡é€»è¾‘å±‚ï¼Œé‚£ä½ çš„æ–¹æ³•åº”è¯¥åªå¤„ç†ä¸€ä¸ªç®€å•çš„ä¸šåŠ¡ã€‚æ¯”å¦‚éœ€è¦ä¸‹å•åå‘é€ç»™ç”¨æˆ·ä¸€ä¸ªé‚®ä»¶ï¼Œé‚£ä½ åº”è¯¥æ‹†å¼€ä¸‹å•å’Œå‘é€é‚®ä»¶çš„æ–¹æ³•ï¼Œä¸è¦æ‰åœ¨ä¸€èµ·ï¼Œè®©ä¸Šå±‚å»ç»„åˆå¤„ç†ï¼Œå› ä¸ºä½ å¾ˆæœ‰å¯èƒ½æ·»åŠ çŸ­ä¿¡é€šçŸ¥/å…¬ä¼—å·å¤„ç†ã€‚å¦‚æœæ‰åœ¨ä¸€èµ·ï¼Œéœ€è¦åŠ æ–°çš„é€šçŸ¥æ–¹å¼çš„æ—¶å€™ä½ è¿˜å¾—å»ä¿®æ”¹å®Œå…¨æ²¡æœ‰å‘ç”Ÿå˜åŒ– OrderAndSendMessage è¿™ä¸ªæ–¹æ³•ï¼ˆéšä¾¿èµ·äº†ä¸ªåå­—ï¼‰ï¼Œå¾ˆæœ‰å¯èƒ½ä¼šå½±å“åˆ° Order çš„è¿‡ç¨‹ã€‚ æ€»è€Œè¨€ä¹‹ï¼Œä¸€ä¸ªæ–¹æ³•åªåšä¸€ä»¶äº‹å„¿ï¼Œä¸è¦è®©ä¸€ä¸ªä¸ç›¸å¹²çš„ä¿®æ”¹å½±å“åˆ°ä½ çš„é€»è¾‘ã€‚ 2.2.2. æ‹†åˆ†æ¨¡å— è¿™å—çš„è¯ï¼Œæˆ‘è§‰å¾—é‡ç‚¹æ˜¯é€»è¾‘ä¸è¦æºæ‚åœ¨ä¸€èµ·ï¼Œä¸åŒçš„é€»è¾‘å°½é‡æŠ½è±¡å‡ºæ¥ã€‚dao å±‚å°±åšæ•°æ®ç›¸å…³çš„ï¼ˆMySQLï¼ŒRedisï¼‰ä¸è¦æºæ‚é€»è¾‘ï¼Œservice å°±åšä¸šåŠ¡é€»è¾‘çš„ç»„åˆï¼Œä¸è¦åœ¨ service å±‚ç›´æ¥æ“ä½œåº•å±‚ç»„ä»¶ã€‚æ€»ç»“èµ·æ¥å°±æ˜¯ä¸è¦è¶Šç•Œï¼Œä¸Šä¸‹ä¸è¦è¶Šçº§ï¼ˆservice -\u003e daoï¼‰ï¼Œå·¦å³ä¸è¦è¶Šç•Œï¼ˆç”¨æˆ·ç›¸å…³é€»è¾‘ä¸è¦æºæ‚è®¢å•çš„é€»è¾‘ï¼Œå³ä¾¿æ˜¯ç”¨æˆ·ä¿¡æ¯å†…éœ€è¦åŒ…å«ç”¨æˆ·çš„è®¢å•æ€»é‡‘é¢ï¼Œä¹Ÿè¦åœ¨è®¢å•æ¨¡å—å®ç°æŸ¥è¯¢æ–¹æ³•å»è°ƒè€Œä¸æ˜¯è‡ªå·±å»å®ç°ï¼Œå¦åˆ™ä»¥åæ‹†åˆ†å¾ˆç—›è‹¦ï¼‰ã€‚æˆ‘è§‰å¾—ä¸åŒçš„åŠŸèƒ½ä¹‹é—´ç›¸äº’è®¤ä¸ºæ˜¯ä¸ªå¾®æœåŠ¡ï¼Œä¸è¦æœ‰åº•å±‚çš„ä¾èµ–ï¼Œä¸è¦è®¤ä¸ºä»£ç åœ¨ä¸€ä¸ªé¡¹ç›®å†…å°±éšä¾¿è°ƒç”¨ï¼Œä¸šåŠ¡å‡çº§ä¸šåŠ¡æ‹†åˆ†çš„æ—¶å€™çœŸçš„éå¸¸ç—›è‹¦ï¼ˆè¡€çš„æ•™è®­ï¼‰ã€‚ ","date":"2022-01-24","objectID":"/posts/go-project-experience/:2:2","tags":["go","å¼€å‘","ç»´æŠ¤"],"title":"Go é¡¹ç›®å¼€å‘å’Œç»´æŠ¤ç»éªŒä¹‹è°ˆ","uri":"/posts/go-project-experience/"},{"categories":["é¡¹ç›®ç»éªŒ"],"content":"2.3. è®°å½•ä»»åŠ¡ è¿™å—çš„è¯ï¼Œæˆ‘è§‰å¾—æ˜¯ä¸€ä¸ªå·¥å…·æ¨èäº†ç®—æ˜¯ã€‚ä¸ç®¡æ˜¯ä¸ªäººå¼€å‘æˆ–è€…å›¢é˜Ÿå¼€å‘ï¼Œæœ‰ä¸ªä»»åŠ¡è®°å½•å’Œé‡Œç¨‹ç¢‘æ˜¯å¾ˆé‡è¦çš„ä¸€ç‚¹ã€‚ä¸ç®¡æ˜¯ GitHub è¿˜æ˜¯ Gitlab éƒ½æœ‰ issue å’Œ milestone çš„åŠŸèƒ½ï¼Œå¯¹äºä¸€ä¸ªå¼€å‘è€…æ¥è¯´ä¸ªäººè§‰å¾—éå¸¸çš„å¥½ç”¨ã€‚ issue ä½ å¯ä»¥è®°å½•ä½ è¦å®ç°çš„åŠŸèƒ½ã€ä½ ç°åœ¨å‡ºç°çš„é—®é¢˜ã€QA åŒå­¦ç»™ä½ æçš„ bugï¼Œä½ æ¯è§£å†³ä¸€ä¸ªé—®é¢˜ï¼Œæ¯å®ç°ä¸€ä¸ªæ–°åŠŸèƒ½åœ¨ git commit ä¸Šå¸¦ä¸Š issue å·å°±å¯ä»¥å…³è”ä¸Šã€‚ä¸ç®¡æ˜¯ä¹‹åå®šä½é—®é¢˜è¿˜æ˜¯æŸ¥çœ‹æŸä¸ªåŠŸèƒ½çš„ç›¸å…³çš„æäº¤éƒ½éå¸¸æ¸…æ™°ï¼Œæ”¶ç›Šå¾ˆå¤šã€‚ milestone ä¹Ÿæ˜¯éå¸¸å¥½ç”¨çš„åŠŸèƒ½ï¼Œé’ˆå¯¹ä½ çš„ä¸€ä¸ªå¤§åŠŸèƒ½æˆ–è€…ä¸€ä¸ªæ–°çš„ç‰ˆæœ¬åˆ›å»ºä¸€ä¸ª milestone å¹¶åŠ ä¸Šæˆªæ­¢æ—¥å¿—ï¼Œä¹‹åæ‰€æœ‰è·Ÿè¿™ä¸ªç‰ˆæœ¬ç›¸å…³çš„ issue éƒ½å¯ä»¥æŒ‚ä¸Šè¿™ä¸ªé‡Œç¨‹ç¢‘ï¼Œå½“ä½ ä¸€ä¸ªä¸ªå®Œæˆçš„ç›¸å…³ issue åï¼Œé‡Œç¨‹ç¢‘çš„å®Œæˆåº¦é€æ¸ä¸Šå‡ï¼Œè®°å½•äº†ä½ çš„å¼€å‘è¿›åº¦ï¼ŒåŒæ—¶æé†’/ç›‘ç£è‡ªå·±ã€‚ ä¸ç®¡ä½ åšçš„é¡¹ç›®æ˜¯å¤§æ˜¯å°ï¼Œéƒ½åº”è¯¥æœ‰ä¸ªå¼€å‘è®¡åˆ’å¹¶åœ¨å¼€å‘å‰åšå¥½å‡†å¤‡ï¼Œä¸è¦ç›²ç›®ä¸Šæ‰‹ï¼Œç€æ€¥ä¸Šæ‰‹åªä¼šè®©ä½ è¶Šåšè¶Šç´¯ï¼Œè€Œä¸”åšä¸å¥½ã€‚éƒ½æ²¡æœ‰è®¡åˆ’å’Œå¼€å‘è¿‡ç¨‹çš„è®°å½•ï¼Œæ€ä¹ˆè¯æ˜é¡¹ç›®çš„è´¨é‡ï¼ŒåæœŸæ€ä¹ˆç»´æŠ¤ï¼Œå‡ºç°é—®é¢˜æ€ä¹ˆå®šä½ã€‚ ","date":"2022-01-24","objectID":"/posts/go-project-experience/:2:3","tags":["go","å¼€å‘","ç»´æŠ¤"],"title":"Go é¡¹ç›®å¼€å‘å’Œç»´æŠ¤ç»éªŒä¹‹è°ˆ","uri":"/posts/go-project-experience/"},{"categories":["é¡¹ç›®ç»éªŒ"],"content":"3. æµ‹è¯• åˆ°è¿™é‡Œå°±å¼€å§‹èŠä»£ç ç›¸å…³çš„äº†ã€‚æµ‹è¯•æ˜¯è€ƒéªŒä½ ä»£ç çš„è´¨é‡å’ŒåŠŸèƒ½çš„ä¸€æŠŠå¥½åˆ€ï¼Œä½ åº”è¯¥ä¹ æƒ¯å¹¶ç†Ÿæ‚‰å†™æµ‹è¯•ä»£ç ï¼Œå¹¶ä¸”å°½å¯èƒ½åŒ…å«ä½ ä»£ç çš„æ‰€æœ‰éƒ¨åˆ†ï¼Œç¡®ä¿ä½ çš„é¡¹ç›®æ•´ä½“éƒ½æ˜¯ç»å¾—èµ·æ¨æ•²çš„ã€‚ æˆ‘å¸¸ç”¨çš„ä»£ç æµ‹è¯•æœ‰ä»¥ä¸‹ä¸‰ç§ï¼š å•å…ƒæµ‹è¯• - æµ‹è¯•ä½ çš„æ–¹æ³•åœ¨åŠŸèƒ½ä¸Šæ²¡æœ‰é—®é¢˜ e2e æµ‹è¯• - end to end ä½ çš„ä¸€ä¸ªå®Œæ•´çš„åŠŸèƒ½æ²¡æœ‰é—®é¢˜ï¼Œæ¯”å¦‚æµ‹è¯•æŸä¸ªæ¥å£æ˜¯å¦è¿”å›é¢„æœŸç»“æœ å‹æµ‹ - æµ‹è¯•ä½ çš„æŸä¸ªæ–¹æ³•æˆ–è€…æ•´ä¸ªç³»ç»Ÿæ˜¯å¦å­˜åœ¨æ€§èƒ½é—®é¢˜ å‹æµ‹å¯ä»¥åœ¨å‘å¸ƒæ–°çš„ç‰ˆæœ¬æˆ–åˆ†æ”¯åˆå¹¶çš„æ—¶å€™è·‘ä¸€ä¸‹ é€šè¿‡åŸºå‡†çº¿å³å¯ã€‚å•å…ƒæµ‹è¯•å’Œe2e æµ‹è¯•åº”è¯¥åœ¨æ¯æ¬¡æäº¤çš„æ—¶å€™æœ¬åœ°æˆ–è€…è¿œç«¯è·‘ä¸€æ¬¡ï¼Œç¡®ä¿ä»»æ„ä¸€æ¬¡çš„æäº¤éƒ½æ˜¯å¯ç”¨çš„ã€‚ ","date":"2022-01-24","objectID":"/posts/go-project-experience/:3:0","tags":["go","å¼€å‘","ç»´æŠ¤"],"title":"Go é¡¹ç›®å¼€å‘å’Œç»´æŠ¤ç»éªŒä¹‹è°ˆ","uri":"/posts/go-project-experience/"},{"categories":["é¡¹ç›®ç»éªŒ"],"content":"3.1. å•å…ƒæµ‹è¯• å•å…ƒæµ‹è¯•ä½œä¸ºæœ€åŸºç¡€çš„æµ‹è¯•æ–¹æ³•ï¼Œåº”è¯¥åœ¨ä½ çš„é¡¹ç›®å†…å°½å¯èƒ½è¦†ç›–å¤§éƒ¨åˆ†çš„æ–¹æ³•ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ ä»»æ„ä¸€ä¸ªå•å…ƒæµ‹è¯•åº”è¯¥éƒ½æ˜¯ç‹¬ç«‹ï¼Œä¸èƒ½æœ‰ä¾èµ– ä»»æ„ä¸€ä¸ªå•å…ƒæµ‹è¯•æ‰§è¡Œå‰åä¸åº”è¯¥å¯¹æ•°æ®æœ‰å½±å“ï¼Œå¦‚æœè¿™ä¸ªå•å…ƒæµ‹è¯•éœ€è¦ä¿®æ”¹æ•°æ®åº“æ•°æ®æˆ–æ–‡ä»¶ï¼Œåº”è¯¥åœ¨æµ‹è¯•ç»“æŸåæ¢å¤å‘ç”Ÿå˜åŒ–çš„æ•°æ® ä¸åº”è¯¥é•¿æ—¶é—´é˜»å¡ï¼Œä¸åº”è¯¥æœ‰ select{} æˆ–æ­»å¾ªç¯ï¼Œç­‰å¾…æ‰‹åŠ¨åœæ­¢çš„æƒ…å†µ æœ€ç®€å•çš„å•å…ƒæµ‹è¯•ç¤ºä¾‹ï¼š func Test_ParseInt(t *testing.T) { var ( input = \"12\" output int64 =12 ) v, err := strconv.ParseInt(\"12\", 10, 64) if err != nil { t.Error(err) return } if v != output { t.Errorf(\"want:%v, got:%v\\n\", output, v) return } t.Log(\"ok\") } è¿™æ˜¯ä¸€ä¸ªæ ¡éªŒ strconv.ParseInt æ–¹æ³•çš„å•å…ƒæµ‹è¯•ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œã€‚ä»ä¸Šé¢çš„ä»£ç æ¥è¯´ï¼Œæœ‰äº›å•°å—¦ï¼Œè€Œä¸”é”™è¯¯ä¿¡æ¯çš„è¾“å‡ºä¹Ÿå¾—è‡ªå·±å†™ï¼Œè¿™é‡Œæ¨èæ¯”è¾ƒæµè¡Œçš„æµ‹è¯•æ¡†æ¶ github.com/stretchr/testify/assert,è¯¥åº“å¯¹é”™è¯¯ä¿¡æ¯çš„æ ¼å¼åŒ–å’Œéå†å¯¹æ¯”éƒ½æ¯•ç«Ÿæˆç†Ÿï¼Œè€Œä¸”æä¾›å¾ˆå¤šæ–¹æ³•ï¼Œæ¥ç®€åŒ–ä½ çš„æµ‹è¯•ä»£ç é‡ï¼Œä¸‹é¢çœ‹ä¸€ä¸‹æ”¹ç‰ˆï¼š func Test_ParseInt(t *testing.T) { v, err := strconv.ParseInt(\"12\", 10, 64) // å¦‚æœæœ‰é”™è¯¯ è¿™é‡Œä¼šè¿”å› false if !assert.NoError(t, err) { return } // Equal æ–¹æ³•æ”¯æŒå¯¹æ¯”æ‰€æœ‰çš„ç±»å‹ï¼Œä¸éœ€è¦æ ¹æ®ç±»å‹åˆ¤æ–­ // å¹¶ä¸”æŠ¥é”™æ—¶ï¼Œæ—¥å¿—ä¿¡æ¯ä¹Ÿéå¸¸ä¸°å¯Œ assert.Equal(t, int64(12), v) } è¿™é‡Œæˆ‘ä¸ä¼šç»†è®²è¿™ä¸ªåº“ï¼Œå¦‚æœçœ‹è¿‡æ¯”è¾ƒä¸»æµçš„å¼€æºåº“ï¼Œæœ‰å¾ˆå¤šåº“éƒ½ä½¿ç”¨è¿™ä¸ªæµ‹è¯•æ¡†æ¶ï¼Œéå¸¸å€¼å¾—å­¦ä¹ å’Œä½¿ç”¨ã€‚ ä¸€èˆ¬æ¥è¯´ï¼Œæµ‹è¯•ä¸€ä¸ªæ–¹æ³•ä¸æ­¢ä¸€ä¸ªæƒ…å†µï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹ä¼šæœ‰å¤šä¸ªå„ç§è¾“å…¥ï¼Œå¤šæ–¹é¢æ¥ç¡®ä¿æ–¹æ³•çš„å¯ç”¨æ€§ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥é‡‡ç”¨ä¸‹é¢çš„å†™æ³•ï¼š func Test_zSkipList_rank(t *testing.T) { type args struct { score float64 value string } tests := []struct { name string args args want int }{ { name: \"c\", args: args{ score: 1, value: \"clang\", }, want: 1, }, { name: \"java\", args: args{ score: 2, value: \"java\", }, want: 2, }, { name: \"w\", args: args{ score: 5, value: \"world\", }, want: 3, }, { name: \"js\", args: args{ score: 8, value: \"javascript\", }, want: 4, }, { name: \"h\", args: args{ score: 10, value: \"hello\", }, want: 5, }, { name: \"go\", args: args{ score: 12, value: \"golang\", }, want: 6, }, } zs := prepareZSetForTest() zs.zsl.print() for _, tt := range tests { t.Run(tt.name, func(t *testing.T) { got := zs.zsl.rank(tt.args.score, tt.args.value) assert.Equal(t, tt.want, int(got)) }) } } è¿™é‡Œæˆ‘ç›´æ¥ä»æˆ‘çš„ç°æˆçš„ä»£ç é‡Œå¤åˆ¶å‡ºæ¥ä¸€ä¸ªæµ‹è¯•æ¡ˆä¾‹ï¼Œè¿™ç§å†™æ³•ç‰¹ç‚¹æ˜¯å®šä¹‰å¥½è¾“å…¥è¾“å‡ºçš„ç»“æ„ï¼Œç„¶åæ‰¹é‡èµ‹å€¼ï¼Œæœ€ç»ˆä¸€ä¸ªä¸ªæ‰§è¡Œã€‚ å¦‚æœæµ‹è¯•è¿‡ç¨‹ä¸­å‘ç°ï¼Œè¾“å…¥çš„æ•°æ®è¿˜ä¸å¤Ÿï¼Œå¯ä»¥éšæ—¶å¢åŠ nä¸ªä¾‹å­ï¼Œå…¶ä»–éƒ¨åˆ†ä¸ç”¨åŠ¨ï¼Œé‡è¦çš„æ˜¯ï¼Œå¯ä»¥åœ¨ GoLand idea ä¸­æ‰§è¡Œä»»æ„ä¸€ä¸ªæµ‹è¯•æ•°æ®ï¼Œæ›´åŠ æ–¹ä¾¿è°ƒè¯•ã€‚ ","date":"2022-01-24","objectID":"/posts/go-project-experience/:3:1","tags":["go","å¼€å‘","ç»´æŠ¤"],"title":"Go é¡¹ç›®å¼€å‘å’Œç»´æŠ¤ç»éªŒä¹‹è°ˆ","uri":"/posts/go-project-experience/"},{"categories":["é¡¹ç›®ç»éªŒ"],"content":"3.2. e2e æµ‹è¯• e2e æµ‹è¯•ï¼Œç›¸å¯¹äºå•å…ƒæµ‹è¯•æ¥è¯´æ›´åŠ ç³»ç»Ÿæ€§æµ‹è¯•ï¼Œé’ˆå¯¹æŸä¸ªæ¨¡å—çš„æ•´ä½“åŠŸèƒ½çš„æ ¡éªŒã€‚æ²¡æœ‰ä¸€ä¸ªå¿…è¦çš„ä»£ç æ¡†æ¶ï¼Œä»£ç é‡ä¹Ÿä¼šæ›´å¤šä¸€äº›ã€‚æ¯”å¦‚æµ‹è¯•ç”¨æˆ·æ³¨å†Œæµç¨‹çš„æµ‹è¯•ï¼Œé‚£å¯åŠ¨æ—¶éœ€è¦å‡†å¤‡è¯¥åŠŸèƒ½éœ€è¦çš„ç¯å¢ƒï¼ˆå¯åŠ¨æˆ–è€…é“¾æ¥æµ‹è¯•æ•°æ®åº“ï¼Œåˆ›å»ºè¡¨æˆ–è€…åˆ›å»ºæµ‹è¯•æ•°æ®ç­‰ï¼‰ï¼Œè°ƒç”¨å¯¹ç”¨çš„æ–¹æ³•åï¼Œå¯¹ç»“æœè¿›è¡Œæ ¡éªŒï¼Œæ ¡éªŒæˆåŠŸåéœ€è¦åˆ é™¤æµ‹è¯•ç”¨çš„æ•°æ®å’Œç¯å¢ƒã€‚ å¯¹äºwebé¡¹ç›®ï¼Œå¯èƒ½é’ˆå¯¹æ¥å£ä¹Ÿéœ€è¦å†™æµ‹è¯•ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦å¯åŠ¨å½“å‰çš„æœåŠ¡ï¼Œå‡†å¤‡ç¯å¢ƒï¼Œè¿›è¡Œæ¥å£è°ƒç”¨ï¼Œå®Œæˆåæ¢å¤æ¶‰åŠåˆ°çš„å˜æ›´ã€‚ e2e æµ‹è¯•æ›´å¤šå…³æ³¨å½“å‰ç¨‹åºçš„æ•´ä½“çš„åŠŸèƒ½ï¼Œå¯ä»¥ç¡®ä¿ä»»æ„çš„ä»£ç æ”¹åŠ¨æ²¡æœ‰å¯¹å½“å‰ç¨‹åºçš„æ•´ä½“èƒ½åŠ›ï¼ˆæˆ–æ ¸å¿ƒåŠŸèƒ½ï¼‰æ²¡æœ‰å¸¦æ¥è´Ÿé¢å½±å“ï¼Œæ‰€ä»¥e2eæµ‹è¯•ä¹Ÿæ˜¯éå¸¸é‡è¦çš„ã€‚ ","date":"2022-01-24","objectID":"/posts/go-project-experience/:3:2","tags":["go","å¼€å‘","ç»´æŠ¤"],"title":"Go é¡¹ç›®å¼€å‘å’Œç»´æŠ¤ç»éªŒä¹‹è°ˆ","uri":"/posts/go-project-experience/"},{"categories":["é¡¹ç›®ç»éªŒ"],"content":"3.3. å‹æµ‹ å‹æµ‹(Benchmark) ä¸åŒäºä¸Šè¿°ä¸¤ä¸ªæµ‹è¯•ï¼Œå…³æ³¨çš„æ˜¯å‡½æ•°æˆ–ç¨‹åºæ•´ä½“çš„æ€§èƒ½æƒ…å†µã€‚ 3.3.1. å‡½æ•°çš„å‹æµ‹ è¿™å—å¯ä»¥é€šè¿‡ go çš„åŸç”Ÿèƒ½åŠ›è¿›è¡Œæµ‹è¯•ï¼Œå†™å‹æµ‹æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œå¦‚ä¸‹ï¼š /* goos: darwin goarch: amd64 pkg: github.com/yusank/godis/util cpu: Intel(R) Core(TM) i7-9750H CPU @ 2.60GHz BenchmarkStringConcat BenchmarkStringConcat-12 14886952 70.91 ns/op PASS */ func BenchmarkStringConcat(b *testing.B) { var slice = []string{ \"$\", \"10\", \"\\r\\n\", \"12345123456\", \"\\r\\n\", } for i := 0; i \u003c b.N; i++ { StringConcat(16, slice...) } } è¿™æ˜¯go æä¾›çš„å‹æµ‹å‡½æ•°çš„å†™æ³•ï¼Œæ‰§è¡Œåï¼Œè¾“å‡ºä¸Šé¢ä»£ç ä¸­çš„æ³¨é‡Šéƒ¨åˆ†ï¼Œå¯ä»¥çœ‹åˆ°å½“å‰æœºå™¨çš„ä¿¡æ¯å’Œæ‰§è¡Œæ¬¡æ•°ä»¥åŠæ¯æ¬¡æ‰§è¡Œæ—¶éœ€è¦çš„æ—¶é—´ã€‚é€šè¿‡è¿™ç§æ–¹æ³•ï¼Œå¯ä»¥é’ˆå¯¹æˆ‘ä»¬çš„ä¸€äº›é«˜é¢‘ç‡è°ƒç”¨çš„æ–¹æ³•è¿›è¡Œå‹æµ‹ï¼Œç¡®ä¿è¿™äº›æ–¹æ³•ä¸æ˜¯æ€§èƒ½çš„ç“¶é¢ˆï¼Œå¹¶ä¸”é‡åˆ°ç“¶é¢ˆæˆ–è€…ä¼˜åŒ–æ—¶ï¼Œé€šè¿‡å‹æµ‹çš„æ–¹å¼ï¼Œå¯¹æ¯”ä¼˜åŒ–å‰åçš„å·®å¼‚ã€‚ 3.3.2. æ•´ä½“å‹æµ‹ åœ¨GitHubä¸Šæœ‰å¾ˆå¤šé¡¹ç›®ï¼Œå°¤å…¶æ˜¯å¯¹æ€§èƒ½è¦æ±‚é«˜çš„é¡¹ç›®éƒ½ä¼šæœ‰ä¸€ä¸ªæ€§èƒ½å¯¹æ¯”çš„å›¾ï¼Œå¯¹è‡ªå·±é¡¹ç›®è¿›è¡Œä¸€ä¸ªå‹æµ‹ï¼Œå¯¹ç¨‹åºæ•´ä½“çš„ååè¿›è¡Œå…¨æ–¹é¢çš„å‹æµ‹ï¼Œä»è€Œä½“ç°å‡ºè¯¥ç¨‹åºçš„é«˜æ€§èƒ½å’Œç¨³å®šæ€§ã€‚ è¿™ä¸ªå…¶å®å¯¹äºtcpæˆ–è€…webæœåŠ¡æ¥è¯´éå¸¸å¥½åšï¼Œè€Œä¸”æœ‰å¾ˆå¤šç°æˆçš„å·¥å…·ï¼Œå¯è¿›è¡Œå‹æµ‹å¹¶è¾“å‡ºç»“æœã€‚ ä»¥ wrk ä¸ºä¾‹ï¼Œæ”¯æŒæŒ‡å®šå®¢æˆ·ç«¯æ•°ï¼Œå¹¶å‘æ•°ï¼Œè¯·æ±‚æ¬¡æ•°ç­‰ï¼Œç”šè‡³æ”¯æŒè„šæœ¬æ‰§è¡Œï¼Œå®šåˆ¶åŒ–å‹æµ‹ï¼Œè¿™é‡Œè´´å‡ºé“¾æ¥,å¸Œæœ›çœ‹åˆ°è¿™é‡Œçš„åŒå­¦ï¼ŒèŠ±å‡ åˆ†é’Ÿå»äº†è§£ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨ã€‚ ","date":"2022-01-24","objectID":"/posts/go-project-experience/:3:3","tags":["go","å¼€å‘","ç»´æŠ¤"],"title":"Go é¡¹ç›®å¼€å‘å’Œç»´æŠ¤ç»éªŒä¹‹è°ˆ","uri":"/posts/go-project-experience/"},{"categories":["é¡¹ç›®ç»éªŒ"],"content":"4. ä»£ç è§„èŒƒ ä»£ç è§„èŒƒè¿™å—æˆ‘ä¹‹å‰å†™è¿‡ä¸“é—¨çš„æ–‡ç« (ç‚¹å‡»ä¼ é€)ã€‚ä½†æ˜¯å®é™…å¼€å‘è¿‡ç¨‹ä¸­ä¸èƒ½ä¿è¯æ‰€æœ‰äººï¼ˆåŒ…æ‹¬è‡ªå·±ï¼‰éƒ½èƒ½å®Œæˆçš„éµå¾ªä»£ç è§„èŒƒçš„ï¼Œæ‰€ä»¥éœ€è¦ä¸€ä¸ªè‡ªåŠ¨åŒ–å·¥å…·æ¥æ ¡éªŒ/é™åˆ¶ä¸è§„èŒƒçš„ä»£ç ã€‚ golangci-lint æ˜¯ä¸€ä¸ªç»å¤§å¤šæ•° go å¼€å‘è€…éƒ½ç†Ÿæ‚‰çš„ä¸€ä¸ªå·¥å…·ï¼Œå¯ä»¥æ ¡éªŒä»»ä½• go é¡¹ç›®çš„ä»£ç è§„èŒƒï¼Œèƒ½å¤ŸæŒ‡å‡ºä¸è§„èŒƒçš„éƒ¨åˆ†ï¼Œå¹¶ä¸”æ”¯æŒæŒ‡å®šå¼€å¯/å…³é—­éƒ¨åˆ†ç±»å‹çš„æ ¡éªŒã€‚ä¸‹é¢ä»ä¸€ä¸ªç®€å•çš„ä¾‹å­è¯´æ˜å¦‚ä½•ä½¿ç”¨ã€‚ è¿™æ˜¯æˆ‘åœ¨æŸä¸ª main æ–¹æ³•é‡ŒåŠ äº†ä¸€äº›ä¸è§„èŒƒçš„è¯­æ³•ï¼š var abc string func main() { var t = 0 == 0 if t == true { // do } core.Service(\":8081\") } æ‰§è¡Œ golangci-lint çœ‹ä¸€ä¸‹ç»“æœï¼š âœ golangci-lint run ./... -v INFO [config_reader] Config search paths: [./ /Users/shan.yu/workspace/yusank/klyn-examp /Users/shan.yu/workspace/yusank /Users/shan.yu/workspace /Users/shan.yu /Users /] INFO [lintersdb] Active 10 linters: [deadcode errcheck gosimple govet ineffassign staticcheck structcheck typecheck unused varcheck] INFO [loader] Go packages loading at mode 575 (deps|types_sizes|compiled_files|exports_file|files|imports|name) took 429.72546ms INFO [runner/filename_unadjuster] Pre-built 0 adjustments in 3.196848ms INFO [linters context/goanalysis] analyzers took 0s with no stages INFO [runner] Issues before processing: 7, after processing: 4 INFO [runner] Processors filtering stat (out/in): skip_dirs: 7/7, exclude: 7/7, uniq_by_line: 4/7, max_per_file_from_linter: 4/4, cgo: 7/7, filename_unadjuster: 7/7, source_code: 4/4, severity-rules: 4/4, skip_files: 7/7, max_from_linter: 4/4, nolint: 7/7, diff: 4/4, max_same_issues: 4/4, path_shortener: 4/4, path_prefixer: 4/4, autogenerated_exclude: 7/7, exclude-rules: 7/7, sort_results: 4/4, path_prettifier: 7/7, identifier_marker: 7/7 INFO [runner] processing took 1.708654ms with stages: path_prettifier: 661.569Âµs, nolint: 614.546Âµs, exclude-rules: 185.12Âµs, identifier_marker: 110.421Âµs, source_code: 48.813Âµs, autogenerated_exclude: 48.499Âµs, skip_dirs: 16.894Âµs, cgo: 6.783Âµs, max_same_issues: 3.182Âµs, uniq_by_line: 2.679Âµs, filename_unadjuster: 2.498Âµs, path_shortener: 2.444Âµs, max_per_file_from_linter: 2.015Âµs, max_from_linter: 1.59Âµs, sort_results: 348ns, exclude: 291ns, diff: 268ns, skip_files: 260ns, severity-rules: 244ns, path_prefixer: 190ns INFO [runner] linters took 85.727899ms with stages: goanalysis_metalinter: 83.919309ms main.go:81:5: `abc` is unused (deadcode) var abc string ^ main.go:78:14: Error return value of `core.Service` is not checked (errcheck) core.Service(\":8081\") ^ main.go:75:5: S1002: should omit comparison to bool constant, can be simplified to `t` (gosimple) if t == true { ^ main.go:74:10: SA4000: identical expressions on the left and right side of the '==' operator (staticcheck) var t = 0 == 0 ^ INFO File cache stats: 1 entries of total size 4.3KiB INFO Memory: 7 samples, avg is 72.4MB, max is 73.1MB INFO Execution took 594.401598ms å¯ä»¥çœ‹åˆ°ï¼Œä¸€å¼€å§‹ä¼šæ‰“å°ç›¸å…³çš„ä¸€äº›ä¿¡æ¯åï¼Œå¼€å§‹ä¸€ä¸ªä¸ªæ‰“å°éå†åˆ°çš„ä¸è§„èŒƒçš„è¯­æ³•ï¼Œå¹¶ä¸”æŒ‡å‡ºé—®é¢˜æ‰€åœ¨çš„ä½ç½®ã€‚è™½ç„¶è¯´ç°åœ¨çš„ä»£ç ç¼–è¾‘å™¨ä¼šå¯¹ä»£ç è¿›è¡Œæ‰«æä¹Ÿä¼šæŒ‡å‡ºä¸è§„èŒƒçš„è¯­æ³•ï¼Œä½†æ˜¯ä¸ä¼šå½±å“æˆ‘ä»¬çš„æ—¥å¸¸å¼€å‘å’Œæäº¤ï¼Œè€Œ golangci-lint æ¯”ç¼–è¾‘å™¨æ›´å…¨é¢ä¸”å¯ä»¥é€šè¿‡ CICD æˆ–è€…å‘½ä»¤è¡Œçš„æ–¹å¼ä¸€æ¬¡æ€§éå†æ•´ä¸ªé¡¹ç›®ä»£ç ï¼Œæ‰€æœ‰çš„ä¸è§„èŒƒå¯ä»¥ä¸€æ¬¡æ€§åˆ—å‡ºæ¥ã€‚ å¦‚æœå»çœ‹ä¸€äº› go è¯­è¨€çš„å¼€æºé¡¹ç›®ï¼Œä½ ä¼šå‘ç°å¾ˆå¤šé¡¹ç›®çš„ GitHub action é‡Œä¼šé…ç½® lint çš„å·¥ä½œæµï¼Œå¦‚æœ lint è¿‡ä¸å»æ‹’ç»åˆå¹¶åˆ°æ­£å¼åˆ†æ”¯çš„ã€‚ ","date":"2022-01-24","objectID":"/posts/go-project-experience/:4:0","tags":["go","å¼€å‘","ç»´æŠ¤"],"title":"Go é¡¹ç›®å¼€å‘å’Œç»´æŠ¤ç»éªŒä¹‹è°ˆ","uri":"/posts/go-project-experience/"},{"categories":["é¡¹ç›®ç»éªŒ"],"content":"5. git ä¸Šé¢æåˆ°äº†ä¸€äº›ä»£ç è§„èŒƒ/å•å…ƒæµ‹è¯•å’Œ GitHub action ç­‰æ¦‚å¿µï¼Œä»è¿™é‡Œå¼€å§‹è®²ä¸€ä¸‹å¦‚ä½•å°†è¿™äº›æ¦‚å¿µä¸²è”èµ·æ¥ï¼Œè®©æ›´å¤šçš„å·¥ä½œå˜æˆè‡ªåŠ¨åŒ–ã€‚ git ä½œä¸ºç‰ˆæœ¬ç®¡ç†å·¥å…·ï¼Œé™¤äº†ç‰ˆæœ¬ç®¡ç†å¤–å…¶ä»–ç›¸å…³æ–¹é¢çš„èƒ½åŠ›ä¹Ÿæ˜¯éå¸¸çš„å¼ºã€‚æœ¬åœ°çš„git å¯ä»¥åˆ†æ”¯å¼€å‘ï¼Œæ‰“ tagï¼Œgit hook ç­‰ã€‚è¿œç«¯ï¼ˆGitHub/Gitlabï¼‰å¯ä»¥æœ‰ issueï¼Œmilestoneï¼ŒPRï¼ŒMRï¼ŒCICD ç­‰èƒ½åŠ›ã€‚ ","date":"2022-01-24","objectID":"/posts/go-project-experience/:5:0","tags":["go","å¼€å‘","ç»´æŠ¤"],"title":"Go é¡¹ç›®å¼€å‘å’Œç»´æŠ¤ç»éªŒä¹‹è°ˆ","uri":"/posts/go-project-experience/"},{"categories":["é¡¹ç›®ç»éªŒ"],"content":"5.1. git hook git hookæ˜¯git æä¾›çš„é’©å­æ–¹æ³•ï¼Œå¯ä»¥é…ç½®å¾ˆå¤šäº‹ä»¶çš„å›è°ƒï¼Œè®©æˆ‘ä»¬çš„ä¸€äº›æ‰‹åŠ¨å·¥ä½œé…ç½®åˆ°å¯¹åº”çš„ hook ä¸Šè‡ªåŠ¨æ‰§è¡Œã€‚æˆ‘ä»¬æ‰“å¼€ä»»æ„çš„ä¸€ä¸ª git é¡¹ç›®è¿›è¡Œä¸‹é¢çš„å‘½ä»¤æŸ¥çœ‹æ”¯æŒçš„ hooksï¼š âœ ls .git/hooks applypatch-msg.sample post-update.sample pre-merge-commit.sample pre-receive.sample update.sample commit-msg.sample pre-applypatch.sample pre-push.sample prepare-commit-msg.sample fsmonitor-watchman.sample pre-commit.sample pre-rebase.sample push-to-checkout.sample å¯ä»¥çœ‹åˆ°å¾ˆå¤š pre æˆ– post å¼€å¤´çš„æ–‡ä»¶ï¼Œè¡¨ç¤ºå¯¹åº”çš„äº‹ä»¶å‰æˆ–åæ‰§è¡Œå¯¹åº”çš„è„šæœ¬ã€‚å¦‚æœéœ€è¦å¯åŠ¨ä»»æ„ä¸€ä¸ªé’©å­ï¼Œåªéœ€è¦ç¼–è¾‘å¯¹åº”çš„æ–‡ä»¶ç„¶åæŠŠåç¼€ .sample å»æ‰å³å¯ã€‚ ä¸‹é¢æ˜¯æˆ‘åœ¨è‡ªå·±æŸä¸ªé¡¹ç›®å†…å¯ç”¨äº† pre-commit hook çš„ä¾‹å­ï¼š #!/bin/sh # # An example hook script to verify what is about to be committed. # Called by \"git commit\" with no arguments. The hook should # exit with non-zero status after issuing an appropriate message if # it wants to stop the commit. # # To enable this hook, rename this file to \"pre-commit\". # æ‰§è¡Œ make test å‘½ä»¤ if ! make test; then echo \"Go test failed, please check your code.\" exit 1 fi # æ‰§è¡Œ make lint å‘½ä»¤ if ! make lint; then echo \"Go lint failed, please check your code style.\" exit 1 fi å¯ç”¨åæˆ‘çš„ä»»ä½•ä¸€æ¬¡ commit éƒ½ä¼šå…ˆè¿›è¡Œä¸€æ¬¡å…¨å±€çš„æµ‹è¯•å’Œ lint æ ¡éªŒé€šè¿‡åï¼Œæ‰ä¼š commit æˆåŠŸå¦åˆ™æœ¬æ¬¡ commit å¤±è´¥ã€‚è¿™ç§åšæ³•å¯¹äºä¸ªäººæˆ–å°‘æ•°å‡ ä¸ªäººå¼€å‘è€…æ¥è¯´ï¼Œå®ç”¨æ€§è›®é«˜çš„ï¼Œä¸€ç§è‡ªæˆ‘çº¦æŸå¹¶ä¸”ä¿è¯ä¸ä¼šæäº¤ä¸€äº›åƒåœ¾ä»£ç ã€‚æœ€é‡è¦çš„æ˜¯ä¸éœ€è¦è‡ªå·±æ‰‹åŠ¨å»æ£€æŸ¥ä»£ç è´¨é‡å’Œè§„èŒƒï¼Œä¸é€šè¿‡æµ‹è¯•å’Œè§„èŒƒçš„æäº¤éƒ½ä¸ä¼šäº§ç”Ÿä¸€æ¬¡ commitIDã€‚ ","date":"2022-01-24","objectID":"/posts/go-project-experience/:5:1","tags":["go","å¼€å‘","ç»´æŠ¤"],"title":"Go é¡¹ç›®å¼€å‘å’Œç»´æŠ¤ç»éªŒä¹‹è°ˆ","uri":"/posts/go-project-experience/"},{"categories":["é¡¹ç›®ç»éªŒ"],"content":"5.2. github / gitlab é™¤äº†ä¸Šè¿°æœ¬åœ°çš„ä¸€äº› git hook çš„é™åˆ¶å¤–ï¼ŒGitHub å’Œ Gitlab æä¾›ä¸€å¥—å®Œæ•´çš„ CICD çš„èƒ½åŠ›ï¼Œç”¨æˆ·å¯ä»¥é…ç½®é’ˆå¯¹æäº¤ï¼ŒMRï¼ŒPR ç­‰å„ç§äº‹ä»¶è¿è¡Œç‰¹å®šçš„è„šæœ¬ï¼Œåœ¨è¿œç«¯æœåŠ¡å™¨è¿›è¡Œæ ¡éªŒï¼Œæ„å»ºï¼Œéƒ¨ç½²ç­‰èƒ½åŠ›ã€‚ CICD å¯¹äºç°åœ¨çš„å¼€å‘è€…æ¥è¯´åº”è¯¥å¾ˆç†Ÿæ‚‰ï¼Œå¯¹äºçƒ­è¡·äºå·¥ä½œè‡ªåŠ¨åŒ–çš„ç¨‹åºå‘˜æ¥è¯´ï¼ŒCICD å¯ä»¥è¯´æ˜¯éå¸¸å¥½ç”¨çš„ä¸€ä¸ªæ‰‹æ®µï¼Œæˆ‘ä¸ªäººçš„å¤§éƒ¨åˆ†é¡¹ç›®éƒ½ä¼šé…ç½®è¿œç«¯çš„ä»£ç æµ‹è¯•ä»£ç è§„èŒƒæ ¡éªŒçš„è„šæœ¬ã€‚åŒ…æ‹¬æœ¬åšå®¢ä¹Ÿåœ¨ GitHub ä¸Šè‡ªåŠ¨éƒ¨ç½²çš„,æˆ‘åªç®¡æäº¤å‰©ä½™çš„å·¥ä½œéƒ½æ˜¯è‡ªåŠ¨åŒ–ï¼Œæ„Ÿå…´è¶£å¯ä»¥ç‚¹å‡»æŸ¥çœ‹ã€‚ ","date":"2022-01-24","objectID":"/posts/go-project-experience/:5:2","tags":["go","å¼€å‘","ç»´æŠ¤"],"title":"Go é¡¹ç›®å¼€å‘å’Œç»´æŠ¤ç»éªŒä¹‹è°ˆ","uri":"/posts/go-project-experience/"},{"categories":["é¡¹ç›®ç»éªŒ"],"content":"6. æ„å»ºä¸è¿è¡Œ é¡¹ç›®çš„å¼€å‘å’Œè°ƒè¯•è¿‡ç¨‹æˆ‘ä»¬å…ä¸äº†æ— æ•°æ¬¡çš„æ„å»ºã€ç¼–è¯‘ã€è¿è¡Œç­‰è¿‡ç¨‹ï¼Œå¹¶ä¸”ä¼šä¾èµ–å¾ˆå¤šå˜é‡ã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬åº”è¯¥æœ‰ä¸€ä¸ªæ¯”è¾ƒå®Œå–„çš„è§£å†³æ–¹æ¡ˆæ¥å‡å°‘æˆ‘ä»¬çš„æ•²å„ç§å‘½ä»¤çš„æ¬¡æ•°æå‡æ•ˆç‡ã€‚ ","date":"2022-01-24","objectID":"/posts/go-project-experience/:6:0","tags":["go","å¼€å‘","ç»´æŠ¤"],"title":"Go é¡¹ç›®å¼€å‘å’Œç»´æŠ¤ç»éªŒä¹‹è°ˆ","uri":"/posts/go-project-experience/"},{"categories":["é¡¹ç›®ç»éªŒ"],"content":"6.1. makefile makeå‘½ä»¤æ˜¯GNUçš„å·¥ç¨‹åŒ–ç¼–è¯‘å·¥å…·ï¼Œç”¨äºç¼–è¯‘ä¼—å¤šç›¸äº’å…³è”çš„æºä»£ç æ–‡ä»¶ï¼Œä»¥å®ç°å·¥ç¨‹åŒ–çš„ç®¡ç†ï¼Œæé«˜å¼€å‘æ•ˆç‡ã€‚æˆ‘ä»¬åº”è¯¥å¯¹ make æœ‰ä¸€å®šçš„äº†è§£ï¼Œå¹¶å­¦ä¼šä½¿ç”¨å®ƒï¼Œä»è€Œæå‡æ•ˆç‡ã€‚ ç‚¹å‡»è¿™é‡Œå­¦ä¹ /å¤ä¹ ç›¸å…³çŸ¥è¯†ï¼Œæœ¬ç¯‡æ–‡ç« ä¸å†è®²è¿°ç›¸å…³å†…å®¹ã€‚ ä¸‹é¢ä»¥å½“å‰åšå®¢é¡¹ç›®çš„ Makefile ä¸ºä¾‹ï¼š TAG = latest help: ## Display this help @awk 'BEGIN {FS = \":.*##\"; printf \"\\nUsage:\\n make \\033[36m\u003ctarget\u003e\\033[0m\\n\"} /^[0-9A-Za-z_-]+:.*?##/ { printf \" \\033[36m%-45s\\033[0m %s\\n\", $$1, $$2 } /^##@/ { printf \"\\n\\033[1m%s\\033[0m\\n\", substr($$0, 5) } ' $(MAKEFILE_LIST) .PHONY: docker-build docker-build: ## build docker image ## change config cat config.toml \u003e config.backup.toml rm -f config.toml mv config.docker.toml config.toml docker build -t yusank/hugo_blog:$(TAG) . # recover mv config.toml config.docker.toml cat config.backup.toml \u003e config.toml rm -f config.backup.toml .PHONY: docker-run docker-run: ## run latest docker image localy docker rm -f blog docker run -d -p 8088:80 --name blog yusank/hugo_blog:$(TAG) .PHONY: docker-push docker-push: docker-build ## bulid and push newest docker image docker push docker.io/yusank/hugo_blog:$(TAG) .PHONY: docker-release docker-release: docker-push ## relaese newest version of image to aliyun ssh aliyun_d1 \"./restart.sh latest\" å¯ä»¥çœ‹åˆ°å®šä¹‰äº†å‡ ä¸ªå‘½ä»¤ï¼Œå¹¶ä¸”å¯ä»¥å‘ç°æœ‰äº›å‘½ä»¤æ˜¯æœ‰ä¾èµ–å…³ç³»çš„ã€‚å½“æ‰§è¡Œ make docker-release æ—¶ï¼Œä¼šå…ˆè¿›è¡Œ docker-pushçš„é€»è¾‘ï¼Œè€Œ docker-push åˆæœ‰å…¶ä¾èµ–ï¼Œä»¥æ­¤ç±»æ¨ã€‚å¦‚æœæ²¡æœ‰å®šä¹‰è¿™ä¸ª makefile, é‚£ä¸ºäº†ä¸€ä¸ª release æ“ä½œï¼Œæˆ‘éœ€è¦ä½ æ‰‹åŠ¨æ•²å¾ˆå¤šå‘½ä»¤ä¸”è¿˜å¾—ç¡®ä¿é¡ºåºã€‚ è¿™ä¸ªåªæ˜¯ä¸€ä¸ªåå‡ è¡Œçš„ make å‘½ä»¤çš„ç¤ºä¾‹ï¼Œå¦‚æœä½ çš„æ„å»º/ç¼–è¯‘çš„ä¾èµ–æ›´å¤šï¼ˆç¯å¢ƒå˜é‡ï¼Œä¸Šä¸‹æ–‡ç­‰ï¼‰ï¼Œé‚£æ›´å¾—å†™ä¸€ä¸ª Makefile æ¥å‡å°‘äººå·¥æ“ä½œæ¬¡æ•°ã€‚å†µä¸”ä¸€æ¬¡æµ‹å¥½åï¼Œä¹‹åå°±é¿å…äººå·¥æ“ä½œå¤±è¯¯çš„æƒ…å†µã€‚ help å‘½ä»¤ä¼šæ‰“å°å½“å‰ Makefile æ”¯æŒçš„æ‰€æœ‰å­å‘½ä»¤ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š âœ make help Usage: make \u003ctarget\u003e help Display this help docker-build build docker image docker-run run latest docker image localy docker-push bulid and push newest docker image docker-release relaese newest version of image to aliyun å†™å¥½ä¸€ä¸ª Makefile å¯ä»¥è¯´æ˜¯ä¸€ä¸ªä¸€åŠ³æ°¸é€¸ï¼Œå¯¹è‡ªå·±å’Œä»–äººéƒ½æœ‰ç™¾ç›Šæ— ä¸€å®³çš„äº‹å„¿äº†ã€‚ä½ å¯ä»¥æœ‰ä¸ªæ¨¡æ¿ï¼Œæœ‰æ–°çš„é¡¹ç›®å¯ä»¥ç›´æ¥ copy è¿›å»ä¿®æ”¹å³å¯ç”¨çš„é‚£ç§ã€‚ ","date":"2022-01-24","objectID":"/posts/go-project-experience/:6:1","tags":["go","å¼€å‘","ç»´æŠ¤"],"title":"Go é¡¹ç›®å¼€å‘å’Œç»´æŠ¤ç»éªŒä¹‹è°ˆ","uri":"/posts/go-project-experience/"},{"categories":["é¡¹ç›®ç»éªŒ"],"content":"6.2. dockerfile dockerfile çš„ç”¨å¤„å¾ˆç®€å•ï¼Œå°±æ˜¯ä¸ºäº†æ„å»º docker é•œåƒã€‚ç°åœ¨å¤§éƒ¨åˆ†äººçš„é¡¹ç›®éƒ½åœ¨å®¹å™¨å†…è¿è¡Œäº†ï¼ŒäºŒè¿›åˆ¶è£¸è·‘åœ¨ç‰©ç†æœºæˆ–è™šæ‹Ÿæœºçš„æƒ…å†µå¾ˆå°‘ï¼Œæ‰€ä»¥ dockerfile ä¹Ÿæ˜¯éœ€è¦æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­åŠ å¥½ï¼Œæ–¹ä¾¿è‡ªåŠ¨åŒ–æ„å»ºé•œåƒã€‚ è¿˜æ˜¯ä»¥æœ¬åšå®¢ç³»ç»Ÿçš„é•œåƒä¸ºä¾‹ï¼ˆå¼•ç”¨æœ¬åšå®¢ç³»ç»Ÿçš„æ–‡ä»¶ä¸æ˜¯å› ä¸ºå¤¸è‡ªå·±å†™çš„å¥½ï¼Œçº¯å±å› ä¸ºæ–¹ä¾¿ï¼‰ï¼š ARG HUGO_DIR=. ARG HUGO_ENV_ARG=production FROM klakegg/hugo:0.90.1-alpine-onbuild AS hugo FROM nginx COPY nginx.conf /etc/nginx/conf.d/nginx.conf COPY yusank.space.pem /etc/nginx/conf.d/yusank.space.pem COPY yusank.space.key /etc/nginx/conf.d/yusank.space.key COPY --from=hugo /target /usr/share/nginx/html EXPOSE 80 EXPOSE 443 å…¸å‹çš„ go é¡¹ç›®çš„dockerfileï¼š FROM golang:1.17-alpine as builder WORKDIR /app/godis COPY . . # args ARG build_tags RUN CGO_ENABLED=0 go build -tags \"${build_tags}\" -o godis cmd/server/main.go FROM scratch WORKDIR /app/godis COPY --from=builder /app/godis . EXPOSE 7379 CMD [\"./godis\"] ","date":"2022-01-24","objectID":"/posts/go-project-experience/:6:2","tags":["go","å¼€å‘","ç»´æŠ¤"],"title":"Go é¡¹ç›®å¼€å‘å’Œç»´æŠ¤ç»éªŒä¹‹è°ˆ","uri":"/posts/go-project-experience/"},{"categories":["é¡¹ç›®ç»éªŒ"],"content":"7. æ€»ç»“ æœ¬ç¯‡æ–‡ç« ä¸»è¦è®²è¿°äº†æˆ‘ä¸ªäººåœ¨å¼€ä¸ªé¡¹ç›®è¿‡ç¨‹ç§¯ç´¯çš„ä¸€äº›ç»éªŒï¼Œä¸ä¸€å®šæ˜¯æœ€å¥½çš„è€Œä¸”è‚¯å®šéœ²äº†å¾ˆå¤šåœ°æ–¹ï¼Œè‹¥æœ‰ä¸æ­£ç¡®çš„åœ°æ–¹è¯·æŒ‡å‡ºã€‚æƒ³é€šè¿‡è¿™ç¯‡æ–‡ç« é¦–å…ˆç»™è‡ªå·±ä¸€ä¸ªæ€»ç»“ï¼Œå…¶æ¬¡æƒ³ç»™å¯¹é¡¹ç›®çš„ç®¡ç†ï¼ˆå¼€å‘æ–¹å‘ï¼‰æ–¹é¢æœ‰ç–‘æƒ‘æœ‰ç–‘è™‘çš„åŒå­¦ä¸€äº›å¯å‘ã€‚ æœ¬ç¯‡æ–‡ç« çš„ä¸»è¦å†…å®¹ï¼š ä»‹ç»å¸¸è§çš„é¡¹ç›®ç›®å½•ç»“æ„ï¼Œè¯·æŒ‰è‡ªå·±çš„å®é™…æƒ…å†µé€‰æ‹© å¦‚ä½•æ‹†åˆ†æ¨¡å— åº”è¯¥é‡è§†ä»£ç æµ‹è¯•é¡¹ç›®æµ‹è¯•ç›¸å…³ ä»‹ç» git,github,gitlab çš„ä¸€äº›å¥½ç”¨çš„ç‰¹æ€§ï¼Œå¸Œæœ›èƒ½å¸¦æ¥æ•ˆç‡çš„æå‡ ä»‹ç» makefile,dockerfile å¸®åŠ©æå‡å¼€å‘æ•ˆç‡ ","date":"2022-01-24","objectID":"/posts/go-project-experience/:7:0","tags":["go","å¼€å‘","ç»´æŠ¤"],"title":"Go é¡¹ç›®å¼€å‘å’Œç»´æŠ¤ç»éªŒä¹‹è°ˆ","uri":"/posts/go-project-experience/"},{"categories":["é¡¹ç›®ç»éªŒ"],"content":"8. é“¾æ¥ğŸ”— keda golangci-lint git hook Makefile ","date":"2022-01-24","objectID":"/posts/go-project-experience/:8:0","tags":["go","å¼€å‘","ç»´æŠ¤"],"title":"Go é¡¹ç›®å¼€å‘å’Œç»´æŠ¤ç»éªŒä¹‹è°ˆ","uri":"/posts/go-project-experience/"},{"categories":["kubernetes"],"content":" æœ¬ç¯‡è®²è¿° kubernetes çš„æ¨ªå‘ pod ä¼¸ç¼©(HorizontalPodAutoscaler) æ§åˆ¶å™¨çš„æ•°æ®ç»“æ„ï¼Œé€»è¾‘å¤„ç†ï¼Œmetrics è®¡ç®—ä»¥åŠç›¸å…³ç»†èŠ‚çš„æºç è§£è¯»ã€‚ ","date":"2022-01-20","objectID":"/posts/hpa-controller/:0:0","tags":["go","k8s","æºç è§£è¯»"],"title":"HPA controller æºç è§£è¯»","uri":"/posts/hpa-controller/"},{"categories":["kubernetes"],"content":"1. å‰è¨€ åœ¨ k8s ç¯å¢ƒå†…å¼¹æ€§ä¼¸ç¼©å¹¶ä¸æ˜¯ä¸€ä¸ªé™Œç”Ÿçš„æ¦‚å¿µï¼Œæ˜¯ä¸€ä¸ªå¸¸è§ä¸”ä¸éš¾ç†è§£çš„äº‹ä»¶ã€‚å°±æ˜¯æ ¹æ®ç‰¹å®šçš„äº‹ä»¶æˆ–æ•°æ®æ¥è§¦å‘å¯ä¼¸ç¼©èµ„æºçš„ä¼¸ç¼©èƒ½åŠ›ã€‚ä¸€èˆ¬æœ‰ HPA å’Œ VPA ä¸¤ä¸ªæ¦‚å¿µï¼ŒHPA å…¨ç§° Horizontal Pod Autoscaler å³æ¨ªå‘ pod çš„è‡ªåŠ¨ä¼¸ç¼©ï¼ŒVPA å…¨ç§° Vertical Pod Autoscaler å³çºµå‘ pod çš„è‡ªåŠ¨ä¼¸ç¼©ã€‚ ","date":"2022-01-20","objectID":"/posts/hpa-controller/:1:0","tags":["go","k8s","æºç è§£è¯»"],"title":"HPA controller æºç è§£è¯»","uri":"/posts/hpa-controller/"},{"categories":["kubernetes"],"content":"1.1. HPA HPA å…³æ³¨ pod çš„æ•°é‡ï¼Œæ ¹æ®ç°æœ‰ pod çš„æ•°æ®(cpu, memory)æˆ–å¤–éƒ¨æ•°æ®(metrics)æ¥è®¡ç®—å®é™…éœ€è¦çš„ pod æ•°é‡ï¼Œä»è€Œè°ƒæ•´ pod çš„æ€»æ•°ã€‚HPA æ“ä½œçš„å¯¹è±¡éœ€è¦å®ç° ScaleInterface ã€‚ ScaleInterface // ScaleInterface can fetch and update scales for // resources in a particular namespace which implement // the scale subresource. type ScaleInterface interface { // Get fetches the scale of the given scalable resource. Get(ctx context.Context, resource schema.GroupResource, name string, opts metav1.GetOptions) (*autoscalingapi.Scale, error) // Update updates the scale of the given scalable resource. Update(ctx context.Context, resource schema.GroupResource, scale *autoscalingapi.Scale, opts metav1.UpdateOptions) (*autoscalingapi.Scale, error) // Patch patches the scale of the given scalable resource. Patch(ctx context.Context, gvr schema.GroupVersionResource, name string, pt types.PatchType, data []byte, opts metav1.PatchOptions) (*autoscalingapi.Scale, error) } k8s åŸç”Ÿèµ„æºä¸­ HPA å¯æ“ä½œæ€§çš„å¯¹è±¡æ˜¯ä»¥ä¸‹ä¸‰ä¸ª: Deployment ReplicaSet StatefulSet ä¸€èˆ¬ä¸šåŠ¡åœºæ™¯ç”¨ HPA èƒ½æ»¡è¶³éœ€æ±‚ï¼Œå³ä¸šåŠ¡é«˜å³°å¢åŠ  pod æ•°æ›´å¥½å¤„ç†ä¸šåŠ¡ï¼Œä¸šåŠ¡ä½å³°é™ä½pod æ•°èŠ‚çœèµ„æºã€‚ ","date":"2022-01-20","objectID":"/posts/hpa-controller/:1:1","tags":["go","k8s","æºç è§£è¯»"],"title":"HPA controller æºç è§£è¯»","uri":"/posts/hpa-controller/"},{"categories":["kubernetes"],"content":"1.2. VPA VPA å…³æ³¨çš„æ˜¯ pod çš„èµ„æºï¼Œæ ¹æ®å½“å‰èµ„æºåˆ©ç”¨ç‡ç­‰æ•°æ®ä¸º pod æä¾›æ›´å¤šçš„èµ„æºï¼ˆcpuï¼Œmemory ç­‰ï¼‰ã€‚æœ¬äººå¯¹ VPA ä¹Ÿæ˜¯è¡¨é¢ç†è§£ï¼Œæ‰€ä»¥è¿™é‡Œä¸åšè¯¦ç»†çš„è§£è¯»ã€‚ VPA æ›´é€‚åˆå¤§è®¡ç®—ã€ç¦»çº¿è®¡ç®—ã€æœºå™¨å­¦ä¹ ç­‰åœºæ™¯ï¼Œéœ€è¦å¤§é‡çš„ CPUï¼ŒGPUï¼Œå†…å­˜æ¥è¿›è¡Œè®¡ç®—ã€‚ ","date":"2022-01-20","objectID":"/posts/hpa-controller/:1:2","tags":["go","k8s","æºç è§£è¯»"],"title":"HPA controller æºç è§£è¯»","uri":"/posts/hpa-controller/"},{"categories":["kubernetes"],"content":"2. åŸºç¡€ç”¨æ³• é€šè¿‡ä»¥ä¸‹å‘½ä»¤å¼€å¯å¯¹æŸä¸ªèµ„æºçš„ HPA èƒ½åŠ›ï¼š âœ kubectl autoscale (-f FILENAME | TYPE NAME | TYPE/NAME) [--min=MINPODS] --max=MAXPODS [--cpu-percent=CPU] [options] Warning éœ€è¦å¼€å¯ metric server æ‰èƒ½è¯»å–åˆ°cpu åˆ©ç”¨ç‡ï¼Œé»˜è®¤æ˜¯ä¸å¼€å¯çš„ã€‚è¯¦æƒ…è¯·çœ‹å®˜æ–¹æ–‡æ¡£: https://github.com/kubernetes-sigs/metrics-server å®é™…ä½¿ç”¨å¦‚ä¸‹ï¼š # å¯¹ deployment/klyn-deploy è¿›è¡Œ CPU ç›‘æ§ï¼Œè¶…è¿‡ 10%çš„å¹³å‡åˆ©ç”¨ç‡å³è¿›è¡Œscale upï¼Œæœ€å¤§ 3 ä¸ª pod æœ€å° 1 ä¸ª âœ kubectl autoscale deployment klyn-deploy --cpu-percent=10 --min=1 --max=3 ç„¶åå¯ä»¥é€šè¿‡ describe å‘½ä»¤æŸ¥çœ‹åˆ›å»ºå HPA çš„è¯¦æƒ…ï¼š âœ kubectl describe hpa klyn-deploy Warning: autoscaling/v2beta2 HorizontalPodAutoscaler is deprecated in v1.23+, unavailable in v1.26+ Name: klyn-deploy Namespace: default Labels: \u003cnone\u003e Annotations: \u003cnone\u003e CreationTimestamp: Thu, 20 Jan 2022 11:43:43 +0800 Reference: Deployment/klyn-deploy Metrics: ( current / target ) resource cpu on pods (as a percentage of request): 4% (10m) / 10% # å¯ä»¥çœ‹åˆ°å·²ç»è¯»åˆ° cpu æ•°æ® Min replicas: 1 Max replicas: 3 Deployment pods: 1 current / 1 desired Conditions: Type Status Reason Message ---- ------ ------ ------- AbleToScale True ReadyForNewScale recommended size matches current size ScalingActive True ValidMetricFound the HPA was able to successfully calculate a replica count from cpu resource utilization (percentage of request) ScalingLimited False DesiredWithinRange the desired count is within the acceptable range Events: \u003cnone\u003e å¯ä»¥ä»ä¸Šè¿°è¯¦æƒ…çœ‹åˆ° HPA èµ„æºçš„è¯¦ç»†ä¿¡æ¯ä»¥åŠæœ€ä¸‹é¢çš„æ­¥éª¤ä¿¡æ¯ï¼Œå½“è¿›è¡Œä¼¸ç¼©æ—¶ä¼šåŒæ­¥ä¼¸ç¼©è¿‡ç¨‹å’ŒåŸå› åˆ° Events å­—æ®µä¸Šã€‚ ä¹‹åå¯ä»¥é€šè¿‡å‹æµ‹çš„æ–¹å¼å°† cpu çš„åˆ©ç”¨ç‡æå‡ç„¶åå¯ä»¥åˆ° Deployment çš„ replicas æ•°é‡çš„æå‡ï¼Œå¹¶å‹æµ‹ç»“æŸä¸€æ®µæ—¶é—´(ä¼šæœ‰å†·å´æ—¶é—´)ååˆé™åˆ° 1 ä¸ª replicas. ","date":"2022-01-20","objectID":"/posts/hpa-controller/:2:0","tags":["go","k8s","æºç è§£è¯»"],"title":"HPA controller æºç è§£è¯»","uri":"/posts/hpa-controller/"},{"categories":["kubernetes"],"content":"3. æ•°æ®ç»“æ„ HPA èµ„æº YAML ç»“æ„ï¼š apiVersion: autoscaling/v2 kind: HorizontalPodAutoscaler metadata: creationTimestamp: \"2022-01-20T03:43:43Z\" name: klyn-deploy namespace: default resourceVersion: \"6602029\" uid: 385f4234-025b-453d-8270-788f7ce3ced6 spec: maxReplicas: 3 metrics: - resource: name: cpu target: averageUtilization: 10 type: Utilization type: Resource minReplicas: 1 scaleTargetRef: apiVersion: apps/v1 kind: Deployment name: klyn-deploy status: conditions: - lastTransitionTime: \"2022-01-20T03:43:58Z\" message: recommended size matches current size reason: ReadyForNewScale status: \"True\" type: AbleToScale - lastTransitionTime: \"2022-01-20T03:43:58Z\" message: the HPA was able to successfully calculate a replica count from cpu resource utilization (percentage of request) reason: ValidMetricFound status: \"True\" type: ScalingActive - lastTransitionTime: \"2022-01-20T03:43:58Z\" message: the desired count is within the acceptable range reason: DesiredWithinRange status: \"False\" type: ScalingLimited currentMetrics: - resource: current: averageUtilization: 3 averageValue: 9m name: cpu type: Resource currentReplicas: 1 desiredReplicas: 1 lastScaleTime: \"2022-01-20T03:51:44Z\" ä¸Šé¢å¯¹ HPA çš„æ¦‚å¿µå’Œå¦‚ä½•ä½¿ç”¨æœ‰äº†ä¸€å®šçš„è®¤çŸ¥ï¼Œä»è¿™é‡Œå¼€å§‹å¯¹ HPA Controller çš„æºç è¿›è¡Œè§£è¯»ã€‚ æ•°æ®ç»“æ„ï¼š // HorizontalController is responsible for the synchronizing HPA objects stored // in the system with the actual deployments/replication controllers they // control. type HorizontalController struct { // Scale èµ„æºçš„è¯»å†™ï¼ˆå¦‚ Deployment çš„ Scaleï¼‰ scaleNamespacer scaleclient.ScalesGetter // HorizontalPodAutoscaler èµ„æºçš„è¯»å†™ hpaNamespacer autoscalingclient.HorizontalPodAutoscalersGetter // ç”¨äºæ ¹æ®ç±»å‹å’Œç‰ˆæœ¬è·å–èµ„æºä¿¡æ¯ mapper apimeta.RESTMapper // è®¡ç®— replica æ•°é‡ replicaCalc *ReplicaCalculator // è®¢é˜… HPA èµ„æºï¼Œå¤„ç†èµ„æºå˜åŒ– eventRecorder record.EventRecorder // æ¯æ¬¡ç¼©å®¹ä¹‹é—´ç­‰å¾…æ—¶é—´ downscaleStabilisationWindow time.Duration // hpaLister is able to list/get HPAs from the shared cache from the informer passed in to // NewHorizontalController. // ç”¨äºè¯»å– hpa å¯¹è±¡ hpaLister autoscalinglisters.HorizontalPodAutoscalerLister hpaListerSynced cache.InformerSynced // podLister is able to list/get Pods from the shared cache from the informer passed in to // NewHorizontalController. // ç”¨äºè¯»å– pod èµ„æº podLister corelisters.PodLister podListerSynced cache.InformerSynced // Controllers that need to be synced // åªä¼šå¯åŠ¨ä¸€ä¸ª workerï¼Œå³å¦‚æœæœ‰å¤§é‡çš„ HPA èµ„æºæ—¶ï¼Œä¸€éƒ¨åˆ†èµ„æºçš„æ‰©ç¼©å®¹å¯èƒ½ä¸é‚£ä¹ˆåŠæ—¶ queue workqueue.RateLimitingInterface // Latest unstabilized recommendations for each autoscaler. // è®°å½•æ¨èä¼¸ç¼©æ•°é‡ recommendations map[string][]timestampedRecommendation // Latest autoscaler events // è®°å½•ä¼¸ç¼©äº‹ä»¶ scaleUpEvents map[string][]timestampedScaleEvent scaleDownEvents map[string][]timestampedScaleEvent } ","date":"2022-01-20","objectID":"/posts/hpa-controller/:3:0","tags":["go","k8s","æºç è§£è¯»"],"title":"HPA controller æºç è§£è¯»","uri":"/posts/hpa-controller/"},{"categories":["kubernetes"],"content":"4. æ§åˆ¶å™¨é€»è¾‘ ","date":"2022-01-20","objectID":"/posts/hpa-controller/:4:0","tags":["go","k8s","æºç è§£è¯»"],"title":"HPA controller æºç è§£è¯»","uri":"/posts/hpa-controller/"},{"categories":["kubernetes"],"content":"4.1. ä¼¸ç¼©è¿‡ç¨‹ ä¼¸ç¼©è¿‡ç¨‹çš„è§¦å‘ä¸æ˜¯å®æ—¶çš„ï¼Œè€Œæ˜¯ä» queue é‡Œæ¶ˆè´¹æ•°æ®ï¼Œè¿›è¡Œä¸€æ¬¡ä¼¸ç¼©æµç¨‹ï¼Œå†æ¬¡å°†èµ„æºåæ”¾å…¥ queue, å®Œæˆä¸€æ¬¡å¾ªç¯ã€‚ è¯¦ç»†æµç¨‹å¦‚ä¸‹ï¼š 4.1.1. ä» queue è¯»å–ä¸€æ¡æ¶ˆæ¯ï¼Œæ ¹æ®æ¶ˆæ¯ä¸­çš„ä¿¡æ¯ï¼Œè·å– hpa å¯¹è±¡ func (a *HorizontalController) processNextWorkItem() bool { key, quit := a.queue.Get() if quit { return false } // å¤„ç†å®Œæ ‡è®°å®Œæˆ defer a.queue.Done(key) // å¤„ç†å‡½æ•°å…¥å£ deleted, err := a.reconcileKey(key.(string)) if err != nil { utilruntime.HandleError(err) } // Add request processing HPA to queue with resyncPeriod delay. // Requests are always added to queue with resyncPeriod delay. If there's already request // for the HPA in the queue then a new request is always dropped. Requests spend resyncPeriod // in queue so HPAs are processed every resyncPeriod. // Request is added here just in case last resync didn't insert request into the queue. This // happens quite often because there is race condition between adding request after resyncPeriod // and removing them from queue. Request can be added by resync before previous request is // removed from queue. If we didn't add request here then in this case one request would be dropped // and HPA would processed after 2 x resyncPeriod. if !deleted { // å¦‚æœ hpa æ²¡æœ‰è¢«åˆ é™¤ï¼Œå†æ¬¡æ”¾å›é˜Ÿåˆ—é‡Œï¼Œç»è¿‡é»˜è®¤æ—¶é—´é—´éš”ï¼ˆ15sï¼Œk8s å¯åŠ¨å‚æ•°å¯é…ç½®ï¼‰åå†è¯»å–å¤„ç†ä¸€æ¬¡ a.queue.AddRateLimited(key) } return true } func (a *HorizontalController) reconcileKey(key string) (deleted bool, err error) { namespace, name, err := cache.SplitMetaNamespaceKey(key) if err != nil { return true, err } // è¯»å– hpa å¯¹è±¡ `*autoscalingv1.HorizontalPodAutoscaler` hpa, err := a.hpaLister.HorizontalPodAutoscalers(namespace).Get(name) if errors.IsNotFound(err) { klog.Infof(\"Horizontal Pod Autoscaler %s has been deleted in %s\", name, namespace) delete(a.recommendations, key) delete(a.scaleUpEvents, key) delete(a.scaleDownEvents, key) return true, nil } if err != nil { return false, err } // å¤„ç†æœ¬æ¬¡ä¼¸ç¼©é€»è¾‘ return false, a.reconcileAutoscaler(hpa, key) } 4.1.2. ä¸ºäº†å…¼å®¹è€ç‰ˆæœ¬ï¼Œè¯»å–æ—¶ hpa å¯¹è±¡ä¸º v1 ç‰ˆæœ¬ï¼Œè¯»å–ååœ¨ä»£ç é‡Œä¼šå…ˆç»Ÿä¸€è½¬æ¢ä¸º v2 ç‰ˆæœ¬,ä»è€Œä¹‹åçš„é€»è¾‘ç»Ÿä¸€ func (a *HorizontalController) reconcileAutoscaler(hpav1Shared *autoscalingv1.HorizontalPodAutoscaler, key string) error { // make a copy so that we never mutate the shared informer cache (conversion can mutate the object) hpav1 := hpav1Shared.DeepCopy() // then, convert to autoscaling/v2, which makes our lives easier when calculating metrics hpaRaw, err := unsafeConvertToVersionVia(hpav1, autoscalingv2.SchemeGroupVersion) if err != nil { a.eventRecorder.Event(hpav1, v1.EventTypeWarning, \"FailedConvertHPA\", err.Error()) return fmt.Errorf(\"failed to convert the given HPA to %s: %v\", autoscalingv2.SchemeGroupVersion.String(), err) } hpa := hpaRaw.(*autoscalingv2.HorizontalPodAutoscaler) ... } 4.1.3. æ ¹æ® hpa.Spec.ScaleTargetRef ä¿¡æ¯è¯»åˆ°éœ€è¦ä¼¸ç¼©çš„èµ„æº func (a *HorizontalController) reconcileAutoscaler(hpav1Shared *autoscalingv1.HorizontalPodAutoscaler, key string) error { ... // çœç•¥éƒ¨åˆ†ä»£ç  hpa := hpaRaw.(*autoscalingv2.HorizontalPodAutoscaler) reference := fmt.Sprintf(\"%s/%s/%s\", hpa.Spec.ScaleTargetRef.Kind, hpa.Namespace, hpa.Spec.ScaleTargetRef.Name) // è§£æèµ„æº api version targetGV, err := schema.ParseGroupVersion(hpa.Spec.ScaleTargetRef.APIVersion) if err != nil { a.eventRecorder.Event(hpa, v1.EventTypeWarning, \"FailedGetScale\", err.Error()) setCondition(hpa, autoscalingv2.AbleToScale, v1.ConditionFalse, \"FailedGetScale\", \"the HPA controller was unable to get the target's current scale: %v\", err) a.updateStatusIfNeeded(hpaStatusOriginal, hpa) return fmt.Errorf(\"invalid API version in scale target reference: %v\", err) } // èµ„æºç±»å‹ targetGK := schema.GroupKind{ Group: targetGV.Group, Kind: hpa.Spec.ScaleTargetRef.Kind, } // æŸ¥è¯¢èµ„æºå¯¹è±¡ mappings, err := a.mapper.RESTMappings(targetGK) if err != nil { a.eventRecorder.Event(hpa, v1.EventTypeWarning, \"FailedGetScale\", err.Error()) setCondition(hpa, autoscalingv2.AbleToScale, v1.ConditionFalse, \"FailedGetScale\", \"the HPA controller was unable to get the target's current scale: %v\", err) a.updateStatusIfNeeded(hpaStatusOriginal, hpa) return fmt.Errorf(\"unable to determine resource for scale target reference: %v\", err) } // æ ¹æ® ns èµ„æºç±»å‹ èµ„æºç‰ˆæœ¬å’Œèµ„æºåç§° ç¡®å®šæœ€","date":"2022-01-20","objectID":"/posts/hpa-controller/:4:1","tags":["go","k8s","æºç è§£è¯»"],"title":"HPA controller æºç è§£è¯»","uri":"/posts/hpa-controller/"},{"categories":["kubernetes"],"content":"4.2. è®¡ç®—å‰¯æœ¬æ•°è¿‡ç¨‹ å¯é€šè¿‡ä¸Šé¢æµç¨‹çœ‹åˆ°ä¼šæœ‰ä¸€ä¸ªè®¡ç®—ç›®æ ‡å‰¯æœ¬æ•°çš„è¿‡ç¨‹ a.computeReplicasForMetricsï¼Œçœ‹ä¼¼ç®€å•å…¶å®å†…éƒ¨ç›¸å½“ä¸°å¯Œçš„ä¸€ä¸ªè¿‡ç¨‹ï¼Œä¸‹é¢ä¸€èµ·çœ‹ä¸€ä¸‹å¦‚ä½•å»è®¡ç®—çš„ã€‚ 4.2.1. éå† spec.Metrics è®¡ç®—å¾—å‡ºæœ€å¤§å€¼ // computeReplicasForMetrics computes the desired number of replicas for the metric specifications listed in the HPA, // returning the maximum of the computed replica counts, a description of the associated metric, and the statuses of // all metrics computed. func (a *HorizontalController) computeReplicasForMetrics(hpa *autoscalingv2.HorizontalPodAutoscaler, scale *autoscalingv1.Scale, metricSpecs []autoscalingv2.MetricSpec) (replicas int32, metric string, statuses []autoscalingv2.MetricStatus, timestamp time.Time, err error) { /* * çœç•¥äº†éƒ¨åˆ†æ— å…³ä»£ç  */ if scale.Status.Selector == \"\" { errMsg := \"selector is required\" return 0, \"\", nil, time.Time{}, fmt.Errorf(errMsg) } selector, err := labels.Parse(scale.Status.Selector) if err != nil { return 0, \"\", nil, time.Time{}, fmt.Errorf(errMsg) } specReplicas := scale.Spec.Replicas statusReplicas := scale.Status.Replicas // è®°å½•æ¯ä¸ª metric çš„ç»“æœ statuses = make([]autoscalingv2.MetricStatus, len(metricSpecs)) invalidMetricsCount := 0 var invalidMetricError error var invalidMetricCondition autoscalingv2.HorizontalPodAutoscalerCondition // éå†è®¡ç®— for i, metricSpec := range metricSpecs { // è®¡ç®—å•ä¸ª metric çš„æ–¹æ³• replicaCountProposal, metricNameProposal, timestampProposal, condition, err := a.computeReplicasForMetric(hpa, metricSpec, specReplicas, statusReplicas, selector, \u0026statuses[i]) if err != nil { if invalidMetricsCount \u003c= 0 { invalidMetricCondition = condition invalidMetricError = err } invalidMetricsCount++ } // å–æœ€å¤§ if err == nil \u0026\u0026 (replicas == 0 || replicaCountProposal \u003e replicas) { timestamp = timestampProposal replicas = replicaCountProposal metric = metricNameProposal } } // If all metrics are invalid or some are invalid and we would scale down, // return an error and set the condition of the hpa based on the first invalid metric. // Otherwise set the condition as scaling active as we're going to scale if invalidMetricsCount \u003e= len(metricSpecs) || (invalidMetricsCount \u003e 0 \u0026\u0026 replicas \u003c specReplicas) { return 0, \"\", statuses, time.Time{}, fmt.Errorf(\"invalid metrics (%v invalid out of %v), first error is: %v\", invalidMetricsCount, len(metricSpecs), invalidMetricError) } return replicas, metric, statuses, timestamp, nil } 4.2.2. è®¡ç®—å•ä¸ª metricï¼šæ ¹æ®ç±»å‹è®¡ç®— metric åè¯è§£æ hpa å¯¹è±¡çš„ spac.metrics ä¸­çš„å…ƒç´ æœ‰ä¸ª Type å­—æ®µ,è®°å½• metric æ•°æ®æºçš„ç±»å‹ï¼Œç›®å‰æ”¯æŒçš„ä»¥ä¸‹å‡ ç§ï¼š ç±»å‹ è¯´æ˜ æ”¯æŒçš„è®¡ç®—ç±»å‹ ä¸æ”¯æŒçš„è®¡ç®—ç±»å‹ Object ç”± k8s æœ¬èº«èµ„æºæä¾›çš„æ•°æ®ï¼Œå¦‚ ingress æä¾›å‘½ä¸­è§„åˆ™æ•°é‡ AverageValue Value AverageUtilization Pods ç”± pod æä¾›çš„é™¤ CPU å†…å­˜ä¹‹å¤–çš„æ•°æ® AverageValue AverageUtilization Value Resource pod æä¾›çš„ç³»ç»Ÿèµ„æºï¼ˆCPU å†…å­˜ï¼‰ AverageUtilization AverageValue Value External å¤–éƒ¨æä¾›çš„ç›‘æ§æŒ‡æ ‡ AverageValue Value AverageUtilization AverageValueï¼šè®¾å®šå¹³å‡å€¼ï¼Œå¦‚qpsï¼Œtpsã€‚è®¡ç®—æ—¶è¯»å– metric æ€»å’Œï¼Œä¸é¢„è®¾å¹³å‡å€¼âœ–ï¸å‰¯æœ¬æ•°è¿›è¡Œå¯¹æ¯”ï¼Œä»è€Œåˆ¤æ–­æ˜¯å¦éœ€è¦ä¼¸ç¼©ã€‚ Valueï¼šè®¾å®šå›ºå®šå€¼ï¼Œå¦‚é˜Ÿåˆ—ä¸­æ¶ˆæ¯æ•°é‡ï¼ŒRedis ä¸­ list é•¿åº¦ç­‰ã€‚è®¡ç®—æ—¶ç›´æ¥æ‹¿ metric å’Œé¢„è®¾å€¼è¿›è¡Œå¯¹æ¯”ã€‚ AverageUtilizationï¼š å¹³å‡åˆ©ç”¨ç‡ï¼Œå¦‚ CPU å’Œå†…å­˜ã€‚å…ˆè®¡ç®— podçš„åŸºæ•°çš„æ€»å’Œï¼ˆtotalMetric å’Œ totalRequestï¼‰ï¼Œæœ€ç»ˆè®¡ç®—åˆ©ç”¨ç‡ â†’ totalMetric/totalRequest æºç ï¼š // Computes the desired number of replicas for a specific hpa and metric specification, // returning the metric status and a proposed condition to be set on the HPA object. func (a *HorizontalController) computeReplicasForMetric(hpa *autoscalingv2.HorizontalPodAutoscaler, spec autoscalingv2.MetricSpec, specReplicas, statusReplicas int32, selector labels.Selector, status *autoscalingv2.MetricStatus) (replicaCountProposal int32, metricNameProposal string, timestampProposal time.Time, condition autoscalingv2.HorizontalPodAutoscalerCondition, err error) { switch spec.Type { case autoscalingv2.ObjectMetricSourceType: metricSelector, err := metav1.LabelSelectorAsSelector(spec.Object.Metric.Selector) if err != nil { condition := a.getUnableComputeReplicaCountCondition(hpa, \"FailedGetObjectMetric\", err) return 0, \"\", time.Time{}, condition, fmt.Errorf(\"failed to get object metric value: %v\", err) } replicaCountProposal, timestampProposal, metricNameProposal, condition, err = a.computeStatusForObjectMetric(specReplicas, statusRepli","date":"2022-01-20","objectID":"/posts/hpa-controller/:4:2","tags":["go","k8s","æºç è§£è¯»"],"title":"HPA controller æºç è§£è¯»","uri":"/posts/hpa-controller/"},{"categories":["kubernetes"],"content":"5. æ‰©å±•ç”¨æ³• åœ¨å®é™…å¼€å‘ç¯å¢ƒåªç”¨ cpu, memory æ¥ä½œä¸ºå¼¹æ€§ä¼¸ç¼©ä¾æ®æ˜¯è¿œè¿œä¸å¤Ÿçš„ã€‚å¤§å¤šæ•°æƒ…å†µå¯èƒ½ä¼šæ ¹æ® qps, tps, å¹³å‡å»¶è¿Ÿæ—¶é—´, MQ ä¸­çš„æ¶ˆæ¯æ•°é‡, Redis ä¸­çš„æ•°æ®é‡ ç­‰ä¸ä¸šåŠ¡æ¯æ¯ç›¸å…³çš„æ•°æ®é‡åˆ¤æ–­ä¼¸ç¼©çš„ä¾æ®ï¼Œè¿™äº›éƒ½å±äº HPA çš„ External ç±»å‹çš„èŒƒç•´ã€‚ä½†æ˜¯ External ç±»å‹çš„æ•°æ®æºéœ€è¦å¯¹æ¥ Adapter çš„æ–¹å¼æ‰èƒ½ç”¨åˆ° HPA å¯¹è±¡å†…å®¹(å…·ä½“è¯·æŸ¥çœ‹: https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/#support-for-metrics-apis) ï¼Œä¹Ÿå°±æ˜¯è¯´éœ€è¦é¢å¤–å¼€å‘é‡çš„ã€‚ è¿™é‡Œæˆ‘æ¨èä¸€ä¸ªçŸ¥ååº¦æ¯”è¾ƒé«˜ä¸”æ”¯æŒçš„æ•°æ®é‡æ¯”è¾ƒå¹¿æ³›çš„ Adapter çš„å®ç° â€“ KEDAã€‚åŸºäºäº‹ä»¶é©±åŠ¨çš„autoscaler,ä¸”æ”¯æŒä» 0 åˆ° 1 1 åˆ° 0 çš„ä¼¸ç¼©ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸šåŠ¡ä½å³°æˆ–è€…æ— æµé‡æ—¶å¯ä»¥é™åˆ° 0 ä¸ªå‰¯æœ¬æ•°(è¿™ä¸ªåœ¨ HPA è¢«è®¤ä¸ºæ˜¯ç¦ç”¨è¯¥åŠŸèƒ½ æ‰€ä»¥ KEDA è‡ªå·±å®ç°çš„ 0 åˆ° 1 1 åˆ° 0 çš„ä¼¸ç¼©çš„èƒ½åŠ›ï¼Œå‰©ä½™çš„æƒ…å†µå®ƒå«ä¸ª HPA å¤„ç†)ã€‚ ç›®å‰ KEDA æ”¯æŒäº‹ä»¶ç±»å‹å¦‚ä¸‹ï¼š KEDA æ”¯æŒçš„äº‹ä»¶ åªéœ€è¦åˆ›å»º KEDA çš„ CRD èµ„æºï¼Œå°±èƒ½å®ç°åŸºäºäº‹ä»¶çš„å¼¹æ€§ä¼¸ç¼©ï¼ŒKEDA çš„ controller ä¼šåˆ›å»ºå¯¹åº”çš„ HPA å¯¹è±¡ã€‚ ä¸‹é¢ä»¥ Prometheus ä¸ºä¾‹ï¼š KEDA.ScaledObject: apiVersion: keda.sh/v1alpha1 kind: ScaledObject metadata: name: prom-scaledobject namespace: default spec: scaleTargetRef: name: klyn-deploy triggers: - type: prometheus metadata: serverAddress: http://10.103.255.235:9090 # Prometheus æŸ¥è¯¢æ¥å£ metricName: http_request_count # è‡ªå®šä¹‰åå­— query: sum(rate(http_request_count{job=\"klyn-service\"}[2m])) # æŸ¥è¯¢è¯­å¥ 2m å†…çš„å¹³å‡ qps threshold: '50' maxReplicaCount: 5 minReplicaCount: 1 pollingInterval: 5 apply è¯¥ yaml åï¼Œä¼šåˆ›å»ºä¸€ä¸ª ScaledObject å’Œ HPA å¯¹è±¡ã€‚ âœ kubectl get ScaledObject NAME SCALETARGETKIND SCALETARGETNAME MIN MAX TRIGGERS AUTHENTICATION READY ACTIVE FALLBACK AGE prom-scaledobject apps/v1.Deployment klyn-deploy 1 5 prometheus True False False 9d ## è¯¥ HPA å¯¹è±¡æœ‰ KEDA çš„ controller åˆ›å»ºçš„ âœ kubectl get hpa NAME REFERENCE TARGETS MINPODS MAXPODS REPLICAS AGE keda-hpa-prom-scaledobject Deployment/klyn-deploy 0/50 (avg) 1 5 1 9d è¿™æ ·ä¸€æ¥ï¼Œå¯ä»¥æ ¹æ®å¾ˆå¤šäº‹ä»¶æ¥æ§åˆ¶ä¼¸ç¼©çš„èƒ½åŠ›ï¼Œè¿™æ¯”å•ä¸€æ¥ cpu,å†…å­˜åˆ©ç”¨ç‡æ¥çœ‹æ›´çµæ´»ä¸”åŠæ—¶ã€‚å®Œå…¨å¯ä»¥æ ¹æ®äº‹ä»¶åœ¨æœåŠ¡çš„å‰¯æœ¬æ•°ä¸å¤Ÿç”¨æˆ–è€…æœ‰ä¸€å †äº‹ä»¶å‡†å¤‡å¤„ç†æ—¶ï¼Œå°½å¯èƒ½å¿«é€Ÿæ‰©å®¹ï¼Œç¡®ä¿å¤„ç†èƒ½åŠ›ä¸ä¼šå—æŸã€‚ ","date":"2022-01-20","objectID":"/posts/hpa-controller/:5:0","tags":["go","k8s","æºç è§£è¯»"],"title":"HPA controller æºç è§£è¯»","uri":"/posts/hpa-controller/"},{"categories":["kubernetes"],"content":"6. æ€»ç»“ è¿™ç¯‡æ–‡ç« ä¸»è¦è®² HPA controller çš„æºç å’Œå¦‚ä½•ä½¿ç”¨ HPA ç›¸å…³å†…å®¹ HPA/VPA çš„è§£é‡Š å¦‚ä½•ä½¿ç”¨ HPA HPA Controller å¦‚ä½•å¤„ç†ä¸€æ¬¡ä¼¸ç¼©äº‹ä»¶çš„ HPA Controller å¦‚ä½•è®¡ç®—ç›®æ ‡å®ä¾‹æ•°çš„ è®¤è¯†å’Œä½¿ç”¨ KEDA â€“ ä¸€ä¸ªåŸºäºäº‹ä»¶é©±åŠ¨çš„ autoscaler ","date":"2022-01-20","objectID":"/posts/hpa-controller/:6:0","tags":["go","k8s","æºç è§£è¯»"],"title":"HPA controller æºç è§£è¯»","uri":"/posts/hpa-controller/"},{"categories":["kubernetes"],"content":"7. é“¾æ¥ğŸ”— horizontal-pod-autoscale pvertical-pod-autoscaler metrics server KEDA ","date":"2022-01-20","objectID":"/posts/hpa-controller/:7:0","tags":["go","k8s","æºç è§£è¯»"],"title":"HPA controller æºç è§£è¯»","uri":"/posts/hpa-controller/"},{"categories":["ä»£ç æŠ€å·§"],"content":" æœ¬ç¯‡åˆ†äº«ä¸€ä¸ªåˆ†ç‰‡å¼çš„ map ç»“æ„ï¼Œåœ¨ä¸€äº›åœºæ™¯ä¸‹è¯¥ç»“æ„æ¯”åŸç”Ÿ syncMap æ›´æœ‰ä¼˜åŠ¿ï¼Œæœ¬æ–‡ä¼šå¯¹è¯¥ç»“æ„çš„å®ç°ï¼ŒåŸç†ä»¥åŠæ—¶å€™çš„åœºæ™¯è¿›è¡Œè¯¦ç»†çš„ä»‹ç»ã€‚ ","date":"2022-01-13","objectID":"/posts/shard-map/:0:0","tags":["go","map","æ•°æ®ç»“æ„"],"title":"go è¯­è¨€ä¸­çš„åˆ†ç‰‡ map çš„å®ç°","uri":"/posts/shard-map/"},{"categories":["ä»£ç æŠ€å·§"],"content":"1. èƒŒæ™¯ map ä½œä¸ºä¸€ä¸ªåŸºç¡€çš„æ•°æ®ç»“æ„ï¼Œåœ¨ç¼–ç¨‹è¿‡ç¨‹ä¸­å¯ä»¥è¯´æ˜¯æ— å¤„ä¸åœ¨ï¼Œåº”ç”¨åœºæ™¯ååˆ†å¹¿æ³›ã€‚åœ¨å¤§éƒ¨åˆ†åœºæ™¯ä¸‹ç”¨åŸç”Ÿçš„ map å°±èƒ½è§£å†³å½“å‰çš„é—®é¢˜ã€‚å¦‚æœæ˜¯é«˜å¹¶å‘åœºæ™¯å¯ä»¥åŠ å…¥ sync.RWMutex æ¥æ§åˆ¶å¹¶å‘è¯»å†™æˆ–è€…ç›´æ¥ä½¿ç”¨ sync.Map æ¥å‡å°‘æ‰‹åŠ¨å†™é”çš„å¤„ç†é€»è¾‘ã€‚å¦‚æœä½œä¸ºä¸€ä¸ªåº”ç”¨çš„åŸºç¡€æ•°æ®ç»“æ„ï¼Œæ€§èƒ½å¯ä»¥è¯´æ˜¯éå¸¸çš„é«˜äº†ï¼Œç»å¤§éƒ¨åˆ†åœºæ™¯ä¸‹æ˜¯å®Œå…¨è¶³å¤Ÿçš„ã€‚ä½†æ˜¯æ€»æœ‰äººåœ¨ä¼˜åŒ–æ€§èƒ½è¿™å—æƒ³åšåˆ°æè‡´ï¼ˆåŒ…æ‹¬æˆ‘è‡ªå·±ï¼‰ï¼Œå³ä¾¿æ˜¯åŸç”Ÿçš„æ•°æ®ç»“æ„ä¹Ÿä¼šæœ‰äººæƒ³ä¼˜åŒ–ã€‚æ—¢ç„¶æƒ³ä¼˜åŒ– mapï¼Œé‚£é¦–å…ˆå¾—äº†è§£ map åœ¨ä»€ä¹ˆæƒ…å†µä¸‹æ€§èƒ½ä¼šå—æŸæˆ–è€…æ€§èƒ½ä¸å¤Ÿé«˜å‘¢ï¼Ÿ å¯¹ map ç»“æ„ç†Ÿæ‚‰çš„åŒå­¦åº”è¯¥éƒ½çŸ¥é“ï¼Œmap åˆç§°ä¹‹ä¸ºå“ˆå¸Œè¡¨ï¼Œkey æ˜¯æŒ‰ç…§å“ˆå¸Œå€¼å­˜å‚¨çš„ï¼Œmap åœ¨å…ƒç´ å¢å¤š/å‡å°‘çš„è¿‡ç¨‹åœ¨ go é‡Œå« grow,è€Œè¿™ä¸ªè¿‡ç¨‹ä¸­æœ‰ä¸ªéå¸¸å…³é”®çš„æ­¥éª¤ rehashã€‚å³ä¼šå¯¹ map å†…çš„æ•°æ®è¿›è¡Œé‡æ–°å“ˆå¸Œè®¡ç®—å’Œç§»åŠ¨ä½ç½®ï¼Œåœ¨æ•°æ®é‡æ¯”è¾ƒå¤§çš„æ—¶å€™ï¼Œmap çš„å†™æ€§èƒ½ä¼šæœ‰ä¸€å®šçš„å—æŸçš„ã€‚ å¦‚æœæˆ‘æœ‰ä¸ªå¯¹æ€§èƒ½è¦æ±‚å¾ˆé«˜çš„ç¨‹åºï¼ˆå…¶å®å¦‚æœå¯¹æ€§èƒ½è¦æ±‚æé«˜å…¶å®å¯ä»¥è€ƒè™‘ C æˆ–è€… rust çš„ï¼Œè¿™é‡Œå°±ä¸è€ƒè™‘äº†ï¼‰ï¼Œæƒ³åœ¨ map ä¸Šåšè¿›ä¸€æ­¥çš„ä¼˜åŒ–çš„ï¼Œåº”è¯¥å¦‚ä½•ä¼˜åŒ–ï¼Œä»ä»€ä¹ˆåœ°æ–¹å…¥æ‰‹å‘¢ï¼Ÿ åœ¨æˆ‘ä¹‹å‰å‡ ç¯‡æ–‡ç« éƒ½åœ¨è®²ç”¨ go è¯­è¨€å®ç° Redis server çš„è¿‡ç¨‹ï¼Œåœ¨å®é™…å¼€å‘è¿‡ç¨‹ä¸­æˆ‘æœ€å¼€å§‹ä¹Ÿæ˜¯ç›´æ¥ç”¨çš„ syncMap ä½œä¸ºåº•å±‚çš„å“ˆå¸Œè¡¨çš„ï¼Œä½†æ˜¯æœ€åå‹æµ‹çš„æ—¶å€™ï¼Œç»“æœä¸æ˜¯å¾ˆæ»¡æ„ã€‚å°¤å…¶æ˜¯å†™å…¥æ“ä½œæ•°æ®é‡å¤§çš„æ—¶å€™ï¼Œtps ä¸‹é™æ¯”è¾ƒå‰å®³ï¼Œæ‰€ä»¥å°±å¼€å§‹æœæŸ¥ç›¸å…³çš„ä¼˜åŒ–æ–¹æ¡ˆã€‚é¦–å…ˆé‡åˆ°äº†ä¸€ä¸ªå¼€æºåº“orcaman/concurrent-map,å…¶ README ä¸­çš„ä¸€å¥è¯å¸å¼•åˆ°æˆ‘äº† orcaman/concurrent-map.README Prior to Go 1.9, there was no concurrent map implementation in the stdlib. In Go 1.9, sync.Map was introduced. The new sync.Map has a few key differences from this map. The stdlib sync.Map is designed for append-only scenarios. So if you want to use the map for something more like in-memory db, you might benefit from using our version è¿™ä¸å°±æ˜¯åœ¨è¯´æˆ‘å—ï¼Ÿæ‰€ä»¥é©¬ä¸Šclone ä¸‹æ¥è¿›è¡Œ benchmark æµ‹è¯•ï¼Œä¸ syncMap è¿›è¡Œå¯¹æ¯”ã€‚ä»…å¯¹åŸºç¡€è¯»å†™èƒ½åŠ›è¿›è¡Œä¸€ä¸ªå‹æµ‹å¯¹æ¯”ï¼Œç»“æœå¦‚ä¸‹ï¼š /* * goos: darwin * goarch: amd64 * pkg: github.com/yusank/godis/datastruct * cpu: Intel(R) Core(TM) i7-9750H CPU @ 2.60GHz * Benchmark_concurrence_map_sAdd * Benchmark_concurrence_map_sAdd-12 2619080 440.8 ns/op * Benchmark_concurrence_map_sIsMember * Benchmark_concurrence_map_sIsMember-12 13764466 77.68 ns/op * Benchmark_concurrence_map_sRem * Benchmark_concurrence_map_sRem-12 16740207 65.18 ns/op * Benchmark_sync_map_sAdd * Benchmark_sync_map_sAdd-12 2101056 765.1 ns/op * Benchmark_sync_map_sIsMember * Benchmark_sync_map_sIsMember-12 15998791 73.47 ns/op * Benchmark_sync_map_sRem * Benchmark_sync_map_sRem-12 15768998 76.62 ns/op * PASS */ æŸ¥è¯¢å…ƒç´ å’Œåˆ é™¤å…ƒç´ å‰ï¼Œæå‰ insert 50000 æ¡æ•°æ®è¿›è¡Œçš„å‹æµ‹ å¯¹æ¯”ç»“æœç¡®å®è®©æˆ‘æœ‰äº›æƒŠè®¶ï¼Œæˆ‘ä»¥ä¸ºè¿™ä¸ªå¼€æºåº“åº”è¯¥ä¹Ÿå°±å¤§æ¦‚èƒ½è¾¾åˆ° sync.Map 80-90% çš„æ€§èƒ½ï¼Œæ²¡æƒ³åˆ°å†™å…¥æ€§èƒ½æ¯” sync.Map é«˜å‡º 60%ï¼Œæˆ‘å†³å®šç”¨è¿™ä¸ªå¼€æºåº“æ›¿ä»£sync.Mapã€‚ ä½†æ˜¯æˆ‘åœ¨çœ‹è¯¥åº“çš„æºç çš„æ—¶å€™å‘ç°è®©æˆ‘ä¸æ˜¯å¾ˆçˆ½çš„ä¸€ä¸ªåœ°æ–¹ï¼Œå°±æ˜¯è¯»å–å…¨é‡æ•°æ®çš„æ—¶å€™ä¼šè¿›è¡Œä¸€æ¬¡ bufferï¼Œå†ä» buffer å¾€å¤–åå‡ºå…ƒç´ ï¼Œå¯¼è‡´å…¨é‡æ•°æ®çš„è¯»å–æˆ–è€…éå†å˜å¾—éå¸¸çš„æ…¢ï¼Œå½“ç„¶è¿™ä¸ªä½œè€…å¯èƒ½æœ‰è‡ªå·±çš„é¡¾è™‘ï¼Œä½†æ˜¯å¯¹æˆ‘æ¥è¯´è¯´ä¸å¯æ¥å—ã€‚æ‰€ä»¥æˆ‘å†³å®šå¯¹è¿™ä¸ªåº“è¿›è¡Œä¸€ä¸ªè‡ªå®šä¹‰ï¼Œä¸‹é¢å°±æŠŠåº“çš„å®ç°é€»è¾‘å’Œè‡ªå·±è‡ªå®šä¹‰çš„éƒ¨åˆ†ä¸€èµ·åˆ†äº«ä¸€ä¸‹ã€‚ ","date":"2022-01-13","objectID":"/posts/shard-map/:1:0","tags":["go","map","æ•°æ®ç»“æ„"],"title":"go è¯­è¨€ä¸­çš„åˆ†ç‰‡ map çš„å®ç°","uri":"/posts/shard-map/"},{"categories":["ä»£ç æŠ€å·§"],"content":"2. å®ç° ","date":"2022-01-13","objectID":"/posts/shard-map/:2:0","tags":["go","map","æ•°æ®ç»“æ„"],"title":"go è¯­è¨€ä¸­çš„åˆ†ç‰‡ map çš„å®ç°","uri":"/posts/shard-map/"},{"categories":["ä»£ç æŠ€å·§"],"content":"2.1. æ•°æ®ç»“æ„ æˆ‘ä»¬å…ˆä»æ•°æ®ç»“æ„çš„å®šä¹‰å…¥æ‰‹çœ‹çœ‹è¿™ä¸ªåº“ä¸ºä»€ä¹ˆèƒ½åšåˆ°è¿™ä¹ˆé«˜çš„æ€§èƒ½ã€‚ var SHARD_COUNT = 32 // A \"thread\" safe map of type string:Anything. // To avoid lock bottlenecks this map is dived to several (SHARD_COUNT) map shards. type ConcurrentMap []*ConcurrentMapShared // A \"thread\" safe string to anything map. type ConcurrentMapShared struct { items map[string]interface{} sync.RWMutex // Read Write mutex, guards access to internal map. } // Creates a new concurrent map. func New() ConcurrentMap { m := make(ConcurrentMap, SHARD_COUNT) for i := 0; i \u003c SHARD_COUNT; i++ { m[i] = \u0026ConcurrentMapShared{items: make(map[string]interface{})} } return m } ConcurrentMap æ˜¯ä¸€ä¸ª 32 ä¸ªåˆ†ç‰‡çš„ map ç»“æ„ï¼Œæ¯ä¸ªåˆ†ç‰‡å†…æ˜¯ä¸€ä¸ª map-lock çš„ç»„åˆã€‚è¿™ä¸ª SHARD_COUNT å¯èƒ½æ˜¯ä¸ºäº†æ–¹ä¾¿åæœŸå¯ä»¥é€šè¿‡ç¼–è¯‘è¿‡ç¨‹æ³¨å…¥çš„æ–¹å¼æ‰©å±•åˆ†ç‰‡å¤§å°è€Œå®šä¹‰çš„å˜é‡ã€‚æˆ‘ç›®å‰æ²¡æœ‰è¿™ä¸ªéœ€æ±‚ï¼Œè€Œä¸”å…¶ä»–å˜é‡åè§‰å¾—æœ‰ç‚¹å•°å—¦ï¼Œæ‰€ä»¥ç¨å¾®æ”¹äº†ä¸€ä¸‹ï¼š const shardCount = 32 // Map - // ç›´æ¥å®šä¹‰32 é•¿åº¦çš„æ•°ç»„ type Map [shardCount]*Shard // Shard of Map // åˆ†ç‰‡ type Shard struct { sync.RWMutex items map[string]interface{} } func New() Map { m := Map{} for i := 0; i \u003c shardCount; i++ { m[i] = \u0026Shard{items: make(map[string]interface{})} } return m } ","date":"2022-01-13","objectID":"/posts/shard-map/:2:1","tags":["go","map","æ•°æ®ç»“æ„"],"title":"go è¯­è¨€ä¸­çš„åˆ†ç‰‡ map çš„å®ç°","uri":"/posts/shard-map/"},{"categories":["ä»£ç æŠ€å·§"],"content":"2.2. å…ƒç´ å®šä½ ä»ä¸Šè¿°ç»“æ„å¯ä»¥çœ‹å‡ºï¼Œå…ƒç´ åˆ†å¸ƒäºå¤šä¸ª Shard å†…çš„ map ä¸­ï¼Œé‚£ä¹ˆå¦‚ä½•ç¡®å®šæŸä¸ªå…ƒç´ åœ¨å“ªä¸ªåˆ†ç‰‡ä¸Šå‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼š å“ˆå¸Œå–æ¨¡çš„æ–¹å¼å®šä½å…ƒç´ çš„åˆ†ç‰‡ã€‚ // GetShard returns shard under given key func (m Map) GetShard(key string) *Shard { return m[uint(fnv32(key))%uint(shardCount)] } // å“ˆå¸Œç®—æ³• func fnv32(key string) uint32 { hash := uint32(2166136261) const prime32 = uint32(16777619) keyLength := len(key) for i := 0; i \u003c keyLength; i++ { hash *= prime32 hash ^= uint32(key[i]) } return hash } ","date":"2022-01-13","objectID":"/posts/shard-map/:2:2","tags":["go","map","æ•°æ®ç»“æ„"],"title":"go è¯­è¨€ä¸­çš„åˆ†ç‰‡ map çš„å®ç°","uri":"/posts/shard-map/"},{"categories":["ä»£ç æŠ€å·§"],"content":"2.3. å¢æ”¹åˆ æŸ¥ func (m Map) Get(key string) (interface{}, bool) { shard := m.GetShard(key) shard.RLock() defer shard.RUnlock() v, ok := shard.items[key] return v, ok } func (m Map) Set(key string, value interface{}) { shard := m.GetShard(key) shard.Lock() defer shard.Unlock() shard.items[key] = value } func (m Map) Delete(key string) { shard := m.GetShard(key) shard.Lock() defer shard.Unlock() delete(shard.items, key) } // UpsertFunc callback for upsert // if after found oldValue and want to stop the upsert op, you can return result and true for it type UpsertFunc func(exist bool, valueInMap, newValue interface{}) (result interface{}, abort bool) // Upsert - update or insert value and support abort operation after callback func (m Map) Upsert(key string, value interface{}, f UpsertFunc) (res interface{}, abort bool) { shard := m.GetShard(key) shard.Lock() defer shard.Unlock() old, ok := shard.items[key] res, abort = f(ok, old, value) if abort { return } shard.items[key] = res return } æœ‰äº†åŸºç¡€çš„æ–¹æ³•ä¹‹åï¼Œå¯ä»¥è¡¥å……ä¸€äº›æ›´æ–¹ä¾¿çš„æ–¹æ³•å°è£…ï¼Œå¦‚ Exists, SetIfNotExists, DeleteAndLoad ç­‰ç­‰ã€‚ ","date":"2022-01-13","objectID":"/posts/shard-map/:2:3","tags":["go","map","æ•°æ®ç»“æ„"],"title":"go è¯­è¨€ä¸­çš„åˆ†ç‰‡ map çš„å®ç°","uri":"/posts/shard-map/"},{"categories":["ä»£ç æŠ€å·§"],"content":"2.4. é«˜çº§ç”¨æ³• func (m Map) SetIfAbsent(key string, value interface{}) bool { shard := m.GetShard(key) shard.Lock() defer shard.Unlock() _, ok := shard.items[key] if !ok { shard.items[key] = value return true } return false } func (m Map) DeleteIfExists(key string) bool { shard := m.GetShard(key) shard.Lock() defer shard.Unlock() _, ok := shard.items[key] if !ok { return false } delete(shard.items, key) return true } func (m Map) LoadAndDelete(key string) (v interface{}, loaded bool) { shard := m.GetShard(key) shard.Lock() defer shard.Unlock() v, loaded = shard.items[key] if !loaded { return nil, false } delete(shard.items, key) return v, loaded } func (m Map) Delete(key string) { shard := m.GetShard(key) shard.Lock() defer shard.Unlock() delete(shard.items, key) } func (m Map) Range(f func(key string, value interface{}) bool) { for i := range m { shard := (m)[i] shard.RLock() defer shard.RUnlock() for s, v := range shard.items { if !f(s, v) { return } } } } ","date":"2022-01-13","objectID":"/posts/shard-map/:2:4","tags":["go","map","æ•°æ®ç»“æ„"],"title":"go è¯­è¨€ä¸­çš„åˆ†ç‰‡ map çš„å®ç°","uri":"/posts/shard-map/"},{"categories":["ä»£ç æŠ€å·§"],"content":"3. åœºæ™¯ \u0026 å‹æµ‹ ","date":"2022-01-13","objectID":"/posts/shard-map/:3:0","tags":["go","map","æ•°æ®ç»“æ„"],"title":"go è¯­è¨€ä¸­çš„åˆ†ç‰‡ map çš„å®ç°","uri":"/posts/shard-map/"},{"categories":["ä»£ç æŠ€å·§"],"content":"3.1. ä½¿ç”¨åœºæ™¯ è¯¥ç»“æ„çš„ç‰¹ç‚¹å°±æ˜¯å†™æ“ä½œæ¯” sync.Map é«˜å¤§æ¦‚ 60% å·¦å³ï¼Œæ‰€ä»¥ä½¿ç”¨åœºæ™¯çš„é€‰æ‹©çš„åŸºç¡€çš„åœ¨äºä»¥ä¸‹ä¸¤ç‚¹ï¼š å¯¹æ€§èƒ½è¦æ±‚æ¯”è¾ƒé«˜ï¼Œå¦åˆ™ sync.Map å®Œæˆè¶³å¤Ÿ æ•°æ®é‡å¤§ã€‚åœ¨æ•°æ®é‡æ¯”è¾ƒå°‘çš„æƒ…å†µä¸‹ï¼Œè¯¥ç»“æ„çš„ä¼˜åŠ¿ä¸å¤Ÿæ˜æ˜¾ ç»¼ä¸Šè¿°ï¼Œæ¯”è¾ƒåˆé€‚çš„ä½¿ç”¨åœºæ™¯çš„åº”è¯¥æ˜¯ å†…å­˜æ•°æ®åº“ã€‚å¯¹æ€§èƒ½è¦æ±‚é«˜ï¼Œä¸”æ•°æ®é‡ä¼šå¾ˆå¤§ï¼Œæ•´ä½“æ€§èƒ½ä¸ä¼šå› ä¸ºæ•°æ®é‡é«˜è€Œä¼šä¸‹é™ã€‚ ","date":"2022-01-13","objectID":"/posts/shard-map/:3:1","tags":["go","map","æ•°æ®ç»“æ„"],"title":"go è¯­è¨€ä¸­çš„åˆ†ç‰‡ map çš„å®ç°","uri":"/posts/shard-map/"},{"categories":["ä»£ç æŠ€å·§"],"content":"3.2. å‹æµ‹ å‹æµ‹æºç ï¼š func BenchmarkShardMap_Set(b *testing.B) { m := New() for i := 0; i \u003c b.N; i++ { k := strconv.Itoa(i) m.Set(k, i) } } func BenchmarkSyncMap_Set(b *testing.B) { m := sync.Map{} for i := 0; i \u003c b.N; i++ { k := strconv.Itoa(i) m.Store(k, i) } } func BenchmarkShardMap_Get(b *testing.B) { m := New() for i := 0; i \u003c 3_000_000; i += 3 { k := strconv.Itoa(i) m.Set(k, i) } for i := 0; i \u003c b.N; i++ { k := strconv.Itoa(i) m.Get(k) } } func BenchmarkSyncMap_Get(b *testing.B) { m := sync.Map{} for i := 0; i \u003c 3_000_000; i += 3 { k := strconv.Itoa(i) m.Store(k, i) } for i := 0; i \u003c b.N; i++ { k := strconv.Itoa(i) m.Load(k) } } func BenchmarkShardMap_Del(b *testing.B) { m := New() for i := 0; i \u003c 3_000_000; i += 3 { k := strconv.Itoa(i) m.Set(k, i) } for i := 0; i \u003c b.N; i++ { k := strconv.Itoa(i) m.Delete(k) } } func BenchmarkSyncMap_Del(b *testing.B) { m := sync.Map{} for i := 0; i \u003c 3_000_000; i += 3 { k := strconv.Itoa(i) m.Store(k, i) } for i := 0; i \u003c b.N; i++ { k := strconv.Itoa(i) m.Delete(k) } } åˆ†åˆ«å¯¹ sync.Map, ShardMap è¿›è¡Œå¤§é‡çš„è¯»å†™åˆ æ“ä½œ,ä¸‹é¢çœ‹çœ‹å‹æµ‹ç»“æœ åŸå§‹ç»“æœ goos: darwin goarch: amd64 pkg: github.com/yusank/godis/lib/shard_map cpu: Intel(R) Core(TM) i7-9750H CPU @ 2.60GHz BenchmarkShardMap_Set BenchmarkShardMap_Set-12 2442687 481.3 ns/op BenchmarkSyncMap_Set BenchmarkSyncMap_Set-12 1442368 736.1 ns/op BenchmarkShardMap_Get BenchmarkShardMap_Get-12 2702954 385.3 ns/op BenchmarkSyncMap_Get BenchmarkSyncMap_Get-12 717051 1409 ns/op BenchmarkShardMap_Del BenchmarkShardMap_Del-12 2704998 384.8 ns/op BenchmarkSyncMap_Del BenchmarkSyncMap_Del-12 480789 2209 ns/op PASS ç»“æœå¯¹æ¯” ç»“æœå¦‚ä¸‹(å•ä½ï¼šns/op)ï¼š æ•°æ®ç»“æ„ Set Get Del ShardMap 481.3 385.3 384.8 sync.Map 736.1 1409 2209 ä¸éš¾å‘ç°ï¼Œåœ¨æ•°æ®é‡å¤§çš„æƒ…å†µä¸‹ï¼ˆç™¾ä¸‡çº§åˆ«ï¼‰sync.Map çš„æ€§èƒ½ä¼šä¸‹é™å¾ˆå¤šï¼Œè¿™ä¸ªä¸ sync.Map çš„è®¾è®¡å’Œå†…éƒ¨ç»“æ„æœ‰å…³ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥å»é˜…è¯»ä¸€ä¸‹ sync.Map çš„æºç ã€‚ æ³¨æ„ï¼šè¿™é‡Œæ–‡ç« æœ€å¼€å§‹æ—¶çš„å‹æµ‹ç»“æœå·®è·å¾ˆå¤§çš„åŸå› æ˜¯ æ•°æ®é‡ä¸ä¸€æ ·ï¼Œç¬¬ä¸€ä¸ªå‹æµ‹ç»“æœæ˜¯åŸºäº 50000 ä¸ªå…ƒç´ ä¹‹ä¸Šè¿›è¡Œçš„ï¼Œæ‰€ä»¥æŸ¥è¯¢å’Œåˆ é™¤çš„æ€§èƒ½ä¸Šçœ‹ä¸Šå»å¾ˆé«˜ã€‚è€Œè¿™é‡Œçš„å‹æµ‹æ—¶åŸºäº 3000000 ä¸ªå…ƒç´ ä¹‹ä¸Šè¿›è¡Œçš„ã€‚ ","date":"2022-01-13","objectID":"/posts/shard-map/:3:2","tags":["go","map","æ•°æ®ç»“æ„"],"title":"go è¯­è¨€ä¸­çš„åˆ†ç‰‡ map çš„å®ç°","uri":"/posts/shard-map/"},{"categories":["ä»£ç æŠ€å·§"],"content":"4. æ€»ç»“ æœ¬ç¯‡ä»‹ç»äº†ä¸€ä¸ªåŸºäº map çš„åˆ†ç‰‡å¼æ•°æ®ç»“æ„ â€“ ShardMapã€‚ è¯¥ç»“æ„å¯ä»¥åœ¨æ•°æ®é‡æ¯”è¾ƒå¤§çš„ä½¿ç”¨æ›¿ä»£sync.Map ä»è€Œä¿æŒæ¯”è¾ƒé«˜çš„æ€§èƒ½ã€‚æˆ‘åœ¨è‡ªå·±çš„ godis é¡¹ç›®å†…ä¹Ÿæ˜¯ç”¨è¯¥ç»“æ„ä½œä¸ºåŸºç¡€çš„å“ˆå¸Œè¡¨ï¼Œä½†æ˜¯ç”±äºgodis å•è¿›ç¨‹å¤„ç†æ•°æ®ï¼Œæ‰€ä»¥æˆ‘æŠŠå…¶ä¸­çš„è¯»å†™é”å»æ‰ ä»è€Œè·å¾—æ›´é«˜çš„æ€§èƒ½ã€‚ æœ¬ç¯‡ä¸»è¦å†…å®¹ï¼š è®¤è¯† ShardMap äº†è§£åˆ° sync.Map ä¹Ÿå­˜åœ¨æ€§èƒ½é—®é¢˜ äº†è§£åˆ° map åœ¨æ•°æ®é‡å¤§çš„æƒ…å†µä¸‹ï¼Œæ€§èƒ½ä¼šå› ä¸º reshah æœºåˆ¶çš„å­˜åœ¨è€Œæœ‰æ‰€ä¸‹é™ é€šè¿‡åˆ†ç‰‡çš„æ–¹å¼ï¼Œé™ä½å•ä¸ª map çš„æ•°æ®é‡ï¼Œä»è€Œå‡å°‘ rehash å¸¦æ¥çš„æ€§èƒ½çš„é™ä½ å®ç°å’Œå‹æµ‹ ShardMap ","date":"2022-01-13","objectID":"/posts/shard-map/:4:0","tags":["go","map","æ•°æ®ç»“æ„"],"title":"go è¯­è¨€ä¸­çš„åˆ†ç‰‡ map çš„å®ç°","uri":"/posts/shard-map/"},{"categories":["ä»£ç æŠ€å·§"],"content":"5. é“¾æ¥ğŸ”— orcaman/concurrent-map godis godis/shard_map ","date":"2022-01-13","objectID":"/posts/shard-map/:5:0","tags":["go","map","æ•°æ®ç»“æ„"],"title":"go è¯­è¨€ä¸­çš„åˆ†ç‰‡ map çš„å®ç°","uri":"/posts/shard-map/"},{"categories":null,"content":" æ„Ÿè°¢å„ä½å¤§ä½¬ä»¬çš„å¤§åŠ›æ”¯æŒ æ¨é¼ç¿ ","date":"2022-01-07","objectID":"/links/:0:0","tags":null,"title":"å‹æƒ…é“¾æ¥","uri":"/links/"},{"categories":["Redis"],"content":" æœ¬ç¯‡è®²è¿° Redis ä¸­çš„åŸºç¡€æ•°æ®ç»“æ„ ZSet(SortedSet) çš„åº•å±‚å®ç°åŸç†å’Œå¦‚ä½•é€šè¿‡ go è¯­è¨€å®ç°ä¸€ä¸ª ZSet çš„è¿‡ç¨‹ä»¥åŠéœ€è¦æ³¨æ„çš„é—®é¢˜ã€‚ è¯´æ˜ æœ¬æ–‡ç« ä¸ºè¯¥ç³»åˆ—çš„æœ‰åºé›†åˆï¼Œå¦‚æœéœ€è¦é˜…è¯»å…¶ä»–ç›¸å…³æ–‡ç« ï¼Œ è¯·ç‚¹å‡»è¿™é‡Œè·³è½¬æŸ¥çœ‹ ","date":"2022-01-07","objectID":"/posts/redis-server-zset/:0:0","tags":["redis","ç³»åˆ—ç¯‡","æ•°æ®ç»“æ„"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·æœ‰åºé›†åˆç¯‡","uri":"/posts/redis-server-zset/"},{"categories":["Redis"],"content":"1 å‰è¨€ ä½¿ç”¨ Redis è¿‡ç¨‹ä¸­é›†åˆè¿™ä¸ªæ¦‚å¿µå‡ºç°çš„æ¯”è¾ƒé¢‘ç¹ï¼Œå¸¸ç”¨çš„ setï¼Œzset éƒ½æ˜¯é›†åˆçš„æ¦‚å¿µã€‚ä¸æ™®é€šçš„é›†åˆä¸åŒçš„æ˜¯ï¼Œzset çš„å…ƒç´ ä¹‹é—´æ˜¯æœ‰é¡ºåºçš„ï¼Œè€Œä¸”è¿™ä¸ªé¡ºåºä¸æ˜¯æ’å…¥çš„é¡ºåºè€Œæ˜¯ä½¿ç”¨è€…æ’å…¥å…ƒç´ æ—¶æŒ‡å®šçš„ score è€Œå®šçš„ã€‚ zset ä¸­çš„ä»»ä½•å…ƒç´ éƒ½æ˜¯æœ‰score å€¼ï¼ˆæµ®ç‚¹æ•°ï¼‰çš„ï¼Œè€Œä¸”æ ¹æ® score çš„é¡ºåºè¿›è¡Œè¯»å†™ç”šè‡³å¯ä»¥åšåˆ°è·å–èŒƒå›´æ•°æ®ï¼Œè¿™äº›ç‰¹æ€§ç»™ä½¿ç”¨è€…å¸¦æ¥äº†æ— æ•°ç§å¯èƒ½æ€§è§£å†³æ–¹æ¡ˆã€‚ zset çš„æ•°æ®ç»“æ„ ä»ä½¿ç”¨è€…çš„è§’åº¦æ¥è¯´ï¼Œzset æ›´åƒä¸€ä¸ª kv ç»“æ„,å…ƒç´ ä¸å¯ä»¥é‡å¤ä½†æ˜¯ä¸åŒå…ƒç´ çš„ score å€¼æ˜¯å¯ä»¥ä¸€æ ·çš„ï¼Œæ­¤æ—¶çš„æ’åºæ˜¯æŒ‰å…ƒç´ å­—å…¸æ’åºã€‚ é€šè¿‡ ZRANGEBYSCORE å‘½ä»¤å¯ä»¥åˆ—å‡ºæŒ‡å®šscoreèŒƒå›´å†…çš„å…ƒç´ ä»¥åŠå¯¹åº”çš„ keyï¼Œ å…¶é¡ºåºä¸º score çš„å‡åºã€‚ \u003e ZRANGEBYSCORE zset1 0 100 withscores 1) \"a\" 2) \"5\" 3) \"b\" 4) \"5\" 5) \"hello\" 6) \"20\" ","date":"2022-01-07","objectID":"/posts/redis-server-zset/:1:0","tags":["redis","ç³»åˆ—ç¯‡","æ•°æ®ç»“æ„"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·æœ‰åºé›†åˆç¯‡","uri":"/posts/redis-server-zset/"},{"categories":["Redis"],"content":"2 zset æ”¯æŒçš„èƒ½åŠ› zset ä½œä¸ºä¸€ä¸ªæœ‰åºé›†åˆï¼Œå³æ‹¥æœ‰æ™®é€šé›†åˆçš„ç‰¹æ€§ï¼ŒåŒæ—¶åˆåŸºäºå…¶æœ‰åºç‰¹æ€§è¡ç”Ÿå‡ºæ›´å¤šåˆ«çš„ç‰¹æ€§ã€‚ä¸»è¦ç‰¹æ€§å¦‚ä¸‹ï¼š å…ƒç´ ä¸é‡å¤ é›†åˆä¹‹é—´äº¤é›†å¹¶é›†å·®é›†çš„æ“ä½œ æ‰¹é‡è¯»å†™å…ƒç´  æ ¹æ® score æ“ä½œï¼ˆå¢åˆ æ”¹æŸ¥ï¼‰å…ƒç´  è·å–scoreæœ€å¤§æœ€å°çš„å…ƒç´  æ ¹æ®é›†åˆå†…rankï¼ˆæˆ– indexï¼‰æ“ä½œï¼ˆå¢åˆ æ”¹æŸ¥ï¼‰å…ƒç´  ","date":"2022-01-07","objectID":"/posts/redis-server-zset/:2:0","tags":["redis","ç³»åˆ—ç¯‡","æ•°æ®ç»“æ„"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·æœ‰åºé›†åˆç¯‡","uri":"/posts/redis-server-zset/"},{"categories":["Redis"],"content":"3 zset åº•å±‚åŸç† æ³¨æ„ æœ¬ç¯‡ä¸­æ‰€æœ‰å¼•ç”¨çš„ Redis æºç å‡åŸºäº Redis6.2 ç‰ˆæœ¬ã€‚ Redis å®ç°çš„ zset åº•å±‚æ˜¯è·³è·ƒè¡¨å’Œå“ˆå¸Œè¡¨çš„ç»„åˆã€‚è·³è·ƒè¡¨ ç”¨äºè®°å½•å’Œæ“ä½œæ‰€æœ‰åŸºäº score çš„æ“ä½œï¼Œè€Œå“ˆå¸Œè¡¨å­˜çš„æ˜¯å…ƒç´ å€¼å’Œ score çš„kvå…³ç³»ï¼Œç”¨äºå¿«é€Ÿå®šä½å…ƒç´ å­˜ä¸å­˜åœ¨çš„æƒ…å†µã€‚ typedef struct zset { dict *dict; // å“ˆå¸Œè¡¨ï¼Œå­˜å‚¨ å…ƒç´ -\u003escore zskiplist *zsl; // è·³è·ƒè¡¨ } zset; é™¤äº†è·³è·ƒè¡¨å’Œå“ˆå¸Œè¡¨ä¹‹å¤–ï¼Œå…¶å®è¿˜æœ‰ä¸€ä¸ªä¸æ€ä¹ˆå‡ºåœºçš„æ•°æ®ç»“æ„ â€“ ziplistï¼ˆå‹ç¼©åˆ—è¡¨ï¼‰ã€‚åœ¨æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶çš„æƒ…å†µä¸‹ï¼ŒRedis ä¼šä½¿ç”¨ ziplistæ¥æ›¿ä»£è·³è·ƒè¡¨ã€‚ ä¿å­˜çš„å…ƒç´ å°‘äº128ä¸ª ä¿å­˜çš„æ‰€æœ‰å…ƒç´ å¤§å°éƒ½å°äº64å­—èŠ‚ åœ¨äº†è§£è·³è·ƒè¡¨ä¹‹å‰å…ˆäº†ç®€å•è§£ä¸€ä¸‹ ziplist è¿™ä¸ªæ•°æ®ç»“æ„çš„å®ç°ä»¥åŠè§£ç­”ä¸ºä»€ä¹ˆè¦ç”¨ ziplist æ¥æ›¿ä»£è·³è·ƒè¡¨ã€‚ ","date":"2022-01-07","objectID":"/posts/redis-server-zset/:3:0","tags":["redis","ç³»åˆ—ç¯‡","æ•°æ®ç»“æ„"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·æœ‰åºé›†åˆç¯‡","uri":"/posts/redis-server-zset/"},{"categories":["Redis"],"content":"3.1 å‹ç¼©åˆ—è¡¨-ziplist ziplist ç¼–ç çš„æœ‰åºé›†åˆå¯¹è±¡ä½¿ç”¨å‹ç¼©åˆ—è¡¨ä½œä¸ºåº•å±‚å®ç°ï¼Œæ¯ä¸ªé›†åˆå…ƒç´ ä½¿ç”¨ä¸¤ä¸ªç´§æŒ¨åœ¨ä¸€èµ·çš„å‹ç¼©åˆ—è¡¨èŠ‚ç‚¹æ¥ä¿å­˜ï¼Œç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¿å­˜å…ƒç´ çš„æˆå‘˜ï¼Œç¬¬äºŒä¸ªèŠ‚ç‚¹ä¿å­˜å…ƒç´ çš„åˆ†å€¼ã€‚å¹¶ä¸”å‹ç¼©åˆ—è¡¨å†…çš„é›†åˆå…ƒç´ æŒ‰åˆ†å€¼ä»å°åˆ°å¤§çš„é¡ºåºè¿›è¡Œæ’åˆ—ã€‚ ä»ä¸Šè¿°çš„ä¸¤ä¸ªæ¡ä»¶å¯ä»¥çœ‹å‡ºï¼Œåœ¨æ•°æ®é‡å°‘ä¸”å•ä¸ªå…ƒç´ ä¹Ÿæ¯”è¾ƒå°çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨ ziplist æ˜¯ä¸ºäº†èŠ‚çœå†…å­˜ï¼Œå› ä¸ºåœ¨æ•°æ®é‡å°‘çš„æƒ…å†µä¸‹å‘æŒ¥ä¸å‡ºæ¥ skiplist çš„ä¼˜åŠ¿ä¸”å çš„å†…å­˜æ¯” ziplist å¤§ã€‚ æƒ³æ›´æ·±å…¥äº†è§£ ziplist çš„å®ç°ç»†èŠ‚ï¼Œè¯·ç‚¹å‡»è¿™é‡ŒæŸ¥çœ‹ ç»“æ„åˆ†å¸ƒ ziplist ç»“æ„åˆ†å¸ƒ area |\u003c---- ziplist header ----\u003e|\u003c----------- entries -------------\u003e|\u003c-end-\u003e| size 4 bytes 4 bytes 2 bytes ? ? ? ? 1 byte +---------+--------+-------+--------+--------+--------+--------+-------+ component | zlbytes | zltail | zllen | entry1 | entry2 | ... | entryN | zlend | +---------+--------+-------+--------+--------+--------+--------+-------+ ^ ^ ^ address | | | ZIPLIST_ENTRY_HEAD | ZIPLIST_ENTRY_END | ZIPLIST_ENTRY_TAIL ziplist èŠ‚ç‚¹ç»“æ„åˆ†å¸ƒ area |\u003c------------------- entry --------------------\u003e| +------------------+----------+--------+---------+ component | pre_entry_length | encoding | length | content | +------------------+----------+--------+---------+ ","date":"2022-01-07","objectID":"/posts/redis-server-zset/:3:1","tags":["redis","ç³»åˆ—ç¯‡","æ•°æ®ç»“æ„"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·æœ‰åºé›†åˆç¯‡","uri":"/posts/redis-server-zset/"},{"categories":["Redis"],"content":"3.2 è·³è·ƒè¡¨-skiplist 3.2.1 å®šä¹‰ è·³è·ƒè¡¨æ˜¯ä¸€ä¸ªéšæœºåŒ–çš„æ•°æ®ç»“æ„ï¼Œå®è´¨å°±æ˜¯ä¸€ç§å¯ä»¥è¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾çš„æœ‰åºé“¾è¡¨ã€‚è·³è·ƒè¡¨åœ¨åŸæœ‰çš„æœ‰åºé“¾è¡¨ä¸Šé¢å¢åŠ äº†å¤šçº§ç´¢å¼•ï¼Œé€šè¿‡ç´¢å¼•æ¥å®ç°å¿«é€ŸæŸ¥æ‰¾ã€‚è·³è·ƒè¡¨ä¸ä»…èƒ½æé«˜æœç´¢æ€§èƒ½ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥æé«˜æ’å…¥å’Œåˆ é™¤æ“ä½œçš„æ€§èƒ½ã€‚ å®ƒé‡‡ç”¨éšæœºæŠ€æœ¯å†³å®šé“¾è¡¨ä¸­å“ªäº›èŠ‚ç‚¹åº”å¢åŠ å‘å‰æŒ‡é’ˆä»¥åŠåœ¨è¯¥èŠ‚ç‚¹ä¸­åº”å¢åŠ å¤šå°‘ä¸ªæŒ‡é’ˆã€‚è·³è·ƒè¡¨ç»“æ„çš„å¤´èŠ‚ç‚¹éœ€æœ‰è¶³å¤Ÿçš„æŒ‡é’ˆåŸŸï¼Œä»¥æ»¡è¶³å¯èƒ½æ„é€ æœ€å¤§çº§æ•°çš„éœ€è¦ï¼Œè€Œå°¾èŠ‚ç‚¹ä¸éœ€è¦æŒ‡é’ˆåŸŸã€‚ é‡‡ç”¨è¿™ç§éšæœºæŠ€æœ¯ï¼Œè·³è·ƒè¡¨ä¸­çš„æœç´¢ã€æ’å…¥ã€åˆ é™¤æ“ä½œçš„æ—¶é—´å‡ä¸ºO(logn)ï¼Œç„¶è€Œï¼Œæœ€åæƒ…å†µä¸‹æ—¶é—´å¤æ‚æ€§å´å˜æˆO(n)ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œåœ¨ä¸€ä¸ªæœ‰åºæ•°ç»„æˆ–é“¾è¡¨ä¸­è¿›è¡Œæ’å…¥/åˆ é™¤æ“ä½œçš„æ—¶é—´ä¸ºO(n)ï¼Œæœ€åæƒ…å†µä¸‹ä¸ºO(n)ã€‚ 3.2.2 åŸç† è·³è·ƒè¡¨åŸç†éå¸¸ç®€å•ï¼Œåœ¨é“¾è¡¨çš„åŸºç¡€ä¸Šæ¯ä¸ªå…ƒç´ åŠ ä¸Šä¸€ä¸ªå±‚(level)çš„æ¦‚å¿µï¼Œå±‚é«˜åˆ™æ˜¯éšæœºçš„, æ‰€ä»¥æ¯ä¸ªå…ƒç´ çš„é«˜åº¦ä¸ä¸€æ ·ã€‚æ¯ä¸€å±‚éƒ½ä¼šæŒ‡å‘ä¸‹ä¸€ä¸ªåŒä¸€å±‚çš„å…ƒç´ ï¼ŒæŸ¥è¯¢å…ƒç´ æ—¶ç”±é«˜å±‚å‘åå‘ä¸‹çš„æ–¹å¼äºŒçº§æ£€ç´¢ä»è€Œè¾¾åˆ°æ›´é«˜çš„æŸ¥è¯¢æ•ˆç‡ï¼Œä¸‹é¢ç”¨å›¾è§£çš„æ–¹å¼è§£æå¦‚ä½•è¯»å†™è·³è·ƒè¡¨å…ƒç´ çš„ã€‚åœ¨çœ‹å›¾ä¹‹å‰å¯ä»¥å…ˆçœ‹ä¸€ä¸‹æºç ï¼Œå°è¯•ç†è§£ä¸€ä¸‹ã€‚ // è·³è·ƒè¡¨ç»“æ„ typedef struct zskiplist { struct zskiplistNode *header, *tail; // è®°å½• head å’Œ tail ä¸¤ä¸ªèŠ‚ç‚¹ unsigned long length; // è®°å½•é•¿åº¦ int level; // è®°å½•å½“å‰æœ€é«˜ levelï¼Œå¦‚æœæœ‰æ–°å…ƒç´ æ’å…¥ä¸”å…¶ level å¤§äºå½“å‰æœ€é«˜åˆ™æ›´æ–°è¯¥å€¼ } zskiplist; // è·³è·ƒè¡¨èŠ‚ç‚¹ typedef struct zskiplistNode { sds ele; // å…ƒç´ å€¼ double score; // score struct zskiplistNode *backward; // å‘å‰æŒ‡å‘æŒ‡é’ˆï¼Œç”¨äºå¾€å›è·³ struct zskiplistLevel { struct zskiplistNode *forward; // æ¯ä¸€å±‚éƒ½æŒ‡å‘ä¸‹ä¸€ä¸ªåŒé«˜åº¦å…ƒç´  unsigned long span; // åˆ°ä¸‹ä¸€ä¸ªåŒé«˜åº¦å…ƒç´ çš„è·¨åº¦ } level[]; // è¯¥å…ƒç´ çš„ level æ•°ç»„ï¼Œindex ä» 0 åˆ° N è¡¨ç¤ºä»æœ€ä½åˆ°æœ€é«˜ï¼Œé»˜è®¤æœ€é«˜æ”¯æŒ 32 å±‚ } zskiplistNode; å¦‚æœçœ‹å®Œæºç è¿˜æ˜¯æ²¡æœ‰çœ‹åˆ° ï¼Œè¯·çœ‹ä¸‹å›¾ï¼š è·³è·ƒè¡¨ç»“æ„ ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œ è·³è·ƒè¡¨ä¸»è¦ç”±ä»¥ä¸‹éƒ¨åˆ†æ„æˆï¼š è¡¨å¤´ï¼ˆheadï¼‰ï¼šè´Ÿè´£ç»´æŠ¤è·³è·ƒè¡¨çš„èŠ‚ç‚¹æŒ‡é’ˆã€‚ è·³è·ƒè¡¨èŠ‚ç‚¹ï¼šä¿å­˜ç€å…ƒç´ å€¼ï¼Œä»¥åŠå¤šä¸ªå±‚ã€‚ å±‚ï¼šä¿å­˜ç€æŒ‡å‘å…¶ä»–å…ƒç´ çš„æŒ‡é’ˆã€‚é«˜å±‚çš„æŒ‡é’ˆè¶Šè¿‡çš„å…ƒç´ æ•°é‡å¤§äºç­‰äºä½å±‚çš„æŒ‡é’ˆï¼Œä¸ºäº†æé«˜æŸ¥æ‰¾çš„æ•ˆç‡ï¼Œç¨‹åºæ€»æ˜¯ä»é«˜å±‚å…ˆå¼€å§‹è®¿é—®ï¼Œç„¶åéšç€å…ƒç´ å€¼èŒƒå›´çš„ç¼©å°ï¼Œæ…¢æ…¢é™ä½å±‚æ¬¡ã€‚ è¡¨å°¾ï¼šå…¨éƒ¨ç”± NULL ç»„æˆï¼Œè¡¨ç¤ºè·³è·ƒè¡¨çš„æœ«å°¾ã€‚ æ³¨æ„ å›¾ä¸­æ²¡æœ‰è¡¨ç¤ºå‡ºæ¥ zskiplistNode.backward æŒ‡é’ˆçš„æŒ‡å‘ï¼Œå®é™…ä¸Šå›¾ä¸­æ¯ä¸ªå…ƒç´ éƒ½ä¼šæŒ‡å‘å‰ä¸€ä¸ªå…ƒç´  3.2.3 æŸ¥è¯¢å…ƒç´  åœ¨è·³è·ƒè¡¨æŸ¥è¯¢å…ƒç´ ï¼Œæ€»æ˜¯ä» head çš„é¡¶å±‚ level å‘åå‘ä¸‹çš„æ–¹å¼å–æŸ¥è¯¢ï¼Œä»¥ä¸Šé¢çš„ç¤ºä¾‹å›¾ä¸ºä¾‹ï¼Œä¸‹é¢è®²è§£å¦‚ä½•æŸ¥è¯¢ score å€¼ä¸º 7 çš„å…ƒç´ : åˆå§‹æ¡ä»¶ï¼š p ä¸ºåˆå§‹æŒ‡é’ˆï¼ŒæŒ‡å‘ head çš„é¡¶å±‚ level æŸ¥è¯¢æ­¥éª¤ï¼š åˆ¤æ–­æŒ‡é’ˆ p çš„ forward å…ƒç´ çš„å€¼ å½“æ»¡è¶³æ¡ä»¶ï¼šforward.score \u003c score æˆ– forward.score == score \u0026\u0026 forward.ele \u003c targetEle æ—¶ï¼Œp å‘å‰ç§»åŠ¨ï¼Œlevel ä¸å˜ å½“ p çš„ forward ä¸º null æˆ–è€…forward å…ƒç´ çš„å€¼å¤§äº score æ—¶ï¼Œlevel å‡ä¸€ï¼Œä½†æ˜¯ p ä¸å¾€å‰ç§»åŠ¨ æ­¥éª¤ 1ï¼Œ2 ä¸€ç›´å¾ªç¯ï¼ŒæŒ‡åˆ° p ç§»åŠ¨åˆ° null æˆ–è€…ç§»åŠ¨åˆ°ç›®æ ‡å…ƒç´ ä¸ºæ­¢ã€‚ è·³è·ƒè¡¨æŸ¥è¯¢å…ƒç´ è¿‡ç¨‹ æºç ï¼š /* ä¸‹é¢å°±æ˜¯éå¸¸å¸¸è§„çš„ä¸€ä¸ªéå†æŸ¥æ‰¾è¿‡ç¨‹ */ x = zsl-\u003eheader; // ä»head é¡¶å±‚levelå¼€å§‹å‘ä¸‹éå† for (i = zsl-\u003elevel-1; i \u003e= 0; i--) { // æ¯ä¸€å±‚åˆ¤æ–­forwardå…ƒç´ ä¸ä¸ºç©ºçš„æ—¶å€™æ˜¯å¦ä¸ç›®æ ‡scoreå’Œele while (x-\u003elevel[i].forward \u0026\u0026 (x-\u003elevel[i].forward-\u003escore \u003c curscore || (x-\u003elevel[i].forward-\u003escore == curscore \u0026\u0026 // è¿™é‡Œçš„ sdccmp æ˜¯Rediså†…å®ç°çš„å¯¹å…¶ String ç»“æ„çš„å­—ç¬¦ä¸²è¿›è¡Œå¯¹æ¯”(å³å­—å…¸æ’åºçš„å¯¹æ¯”) sdscmp(x-\u003elevel[i].forward-\u003eele,ele) \u003c 0))) { x = x-\u003elevel[i].forward; } } ç„¶åå†çœŸæ­£å®ç° zset çš„æ—¶å€™ï¼Œä¸ä¼šæ ¹æ® value å€¼å»éå†æŸ¥è¯¢è·³è·ƒè¡¨, è€Œæ˜¯ç›´æ¥ä»å“ˆå¸Œè¡¨æŸ¥æ˜¯å¦å­˜åœ¨ 3.2.4 æ·»åŠ å…ƒç´  æ·»åŠ å…ƒç´ æ ¸å¿ƒæœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š æ‰¾åˆ°éœ€è¦æ’å…¥çš„ä½ç½®ï¼Œè¿™å—ç”¨ä¸Šä¸Šä¸€ä¸ªå°èŠ‚çš„æŸ¥è¯¢å…ƒç´ ç›¸å…³çŸ¥è¯† åœ¨æŸ¥æ‰¾ä½ç½®çš„è¿‡ç¨‹ä¸­éœ€è¦è®°å½•ç‰µè¿åˆ°éœ€è¦æ›´æ–°çš„å…ƒç´  å¦‚ä½•å¾—åˆ°æ–°å…ƒç´ çš„å±‚é«˜ï¼ŒçœŸçš„æ˜¯ [0,32) ä¹‹é—´éšæœºä¸€ä¸ªæ•°å˜›ï¼Ÿ å¦‚æœæ–°å…ƒç´ çš„å±‚é«˜å¤§äºå½“å‰ skiplist çš„é«˜åº¦ï¼Œéœ€è¦åšå“ªäº›è°ƒæ•´å·¥ä½œï¼Ÿ å¯¹ä»¥ä¸Šå‡ ç‚¹æœ‰äº†æ˜ç¡®çš„è®¤çŸ¥å’Œå›ç­”åï¼Œäº†è§£æ’å…¥å…ƒç´ çš„è¿‡ç¨‹å°±å˜å¾—å¾ˆç®€å•ã€‚ æ·»åŠ å…ƒç´ è¿‡ç¨‹ï¼š å®šä¹‰ä¸€ä¸ª zskiplistNode *update[ZSKIPLIST_MAXLEVEL] æ•°ç»„è®°å½•æ¯æ¬¡å˜æ›´ level æ—¶çš„èŠ‚ç‚¹ï¼ˆåæœŸæ›´æ–°å—å½±å“çš„èŠ‚ç‚¹ç”¨ï¼‰ å®šä¹‰ unsigned int rank[ZSKIPLIST_MAXLEVEL] æ•°ç»„è®°å½•ä¸¤æ¬¡å‘ä¸‹éå†çš„èŠ‚ç‚¹ç›´æ¥çš„è·¨åº¦ ä¸æŸ¥è¯¢å…ƒç´ ä¸€æ ·ï¼Œä» head çš„é¡¶å±‚å¼€å§‹å‘ä¸‹å‘å‰éå†ï¼Œæ‰¾åˆ°æ’å…¥çš„ä½ç½®ï¼Œè¿™ä¸ªä½ç½®æ»¡è¶³ score å€¼ä»‹äºå‰åçš„å…ƒç´  åœ¨éå†çš„è¿‡ç¨‹ä¸­ï¼Œæ¯å¾€ä¸‹ç§»åŠ¨ä¸€æ¬¡(level - 1 )çš„æ—¶å€™è®°å½•å½“å‰å…ƒç´ update[cur_level] = cur_node åœ¨éå†çš„è¿‡ç¨‹ä¸­ï¼Œæ¯å¾€å‰ç§»åŠ¨ä¸€æ¬¡(æ³¨ï¼šæ¯æ¬¡ç§»åŠ¨åªä¼šå•å‘ ä¸ä¼šåŒæ—¶å‘å‰å‘ä¸‹)çš„å‰è®°å½•åŒä¸€ä¸ª level å†…çš„è·¨åº¦ rank[cur_level] += cur_node.level[cur_level].span (è¿™é‡Œä¹‹æ‰€ä»¥ç´¯åŠ æ˜¯å› ä¸ºï¼ŒåŒä¸€ä¸ª level ä¸Šå¯èƒ½ä¼šå‘å‰ç§»åŠ¨ n æ¬¡ï¼Œå¦‚ä¸Šé¢ç¤ºä¾‹å›¾ä¸­çš„ä» 1 åˆ° 6 çš„è¿‡ç¨‹éƒ½æ˜¯åœ¨åŒä¸€ä¸ª level ä¸Šè¿›è¡Œçš„) // å®šä¹‰å˜é‡ zskiplistNode *update[ZSKIPLIST_MAXLEVEL], *x; unsigned int rank[ZSKIPLIST_MAXLEVEL]; int i, level; // ä» header å¼€å§‹éå† x = zsl-\u003eheader; // åˆå§‹ä½ç½® header çš„é¡¶å±‚ level for (i = zsl-\u003elevel-1; i \u003e= 0; i--) { /* store rank that is crossed to reach the insert position */ // å¦‚æœå½“å‰level ä¸ºæœ€é«˜ä¸€å±‚çš„ level åˆ™ rank è®°å½• 0 rank[i] = i == (zsl-\u003elevel-1) ? 0 : rank[i+1]; while (x-\u003elevel[i].forward \u0026\u0026 (x-\u003elevel[i].forward-\u003escore \u003c score || (x-\u003elevel[i].forward-\u003escore == score \u0026\u0026 sdscmp(x-\u003elevel[i].forward-\u003eele,ele) \u003c 0))) { // å‘å‰ç§»åŠ¨æ—¶è®°å½•å½“å‰ level ç§»åŠ¨çš„è·¨åº¦ rank[i] += x-\u003elevel[i].span; x = x-\u003elevel[i].forward; } // level - 1 æ—¶ è®°å½•å½“å‰å…ƒç´  update[i] = x; } éšæœºä¸€ä¸ª levelï¼Œ Redis æ˜¯æœ‰ä¸€å¥—ç®€å•çš„ç®—æ³•å»ç”Ÿæˆéšæœºçš„ level è·³è½¬æŸ¥çœ‹ã€‚ å¦‚æœéšæœºçš„ level å¤§äº skiplist å½“å‰æœ€é«˜ levelï¼Œåˆ™åœ¨ update æ•°ç»„è®°å½•ä»å½“å‰æœ€é«˜åˆ°æ–°çš„æœ€é«˜ä¹‹é—´çš„level å¯¹åº”çš„èŠ‚ç‚¹ä¸º head èŠ‚ç‚¹ /* we assume the element is not already inside, since we allow duplicated * scores, reinserting the same element should never happen since the * caller of zslInsert() should test in the hash table if the element is * already inside or not. */ level = zslRandomLevel(); if (level \u003e zsl-\u003elevel) { // åœ¨ zsl-\u003elevel åˆ° level ä¹‹é—´åŒºåŸŸè¡¥ç¼ºåŸæ¥çš„ç©ºç¼º // åŸæ¥é«˜äº zsl-\u003elevel çš„ level å‡æŒ‡å‘ nullï¼Œç°åœ¨éœ€è¦æŒ‡å‘åˆ°æ–°çš„å…ƒç´ å¯¹åº”çš„ level äº† for (i = zsl-\u003elevel; i \u003c level; i++) { rank[i] = 0; // å› ä¸ºæœ€é«˜çš„ level äº†æ‰€ä»¥åœ¨è¯¥å±‚ä¸ä¼šæŒ‡å‘ä¸‹ä¸€ä¸ªå…ƒç´  æ‰€ä»¥å¯¹åº”çš„ rank == 0 update[i] = zsl-\u003eheader; // header éœ€è¦æ›´æ–° update[i]-\u003elevel[i].span = zsl-\u003elength; // ä¸å†","date":"2022-01-07","objectID":"/posts/redis-server-zset/:3:2","tags":["redis","ç³»åˆ—ç¯‡","æ•°æ®ç»“æ„"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·æœ‰åºé›†åˆç¯‡","uri":"/posts/redis-server-zset/"},{"categories":["Redis"],"content":"4 zset å®ç° ä¸Šé¢å…³äºzsetçš„åŸç†å’Œå®ç°éƒ½ç†è§£çš„æ¯”è¾ƒé€å½»äº†ï¼Œå¦‚æœè¿˜æœ‰ä¸æ˜ç™½çš„å»ºè®®çœ‹æºç ï¼Œç»“åˆæºç ä¸Šä¸‹æ–‡æ›´å¥½ç†è§£ã€‚ç°åœ¨æˆ‘ç”¨ go è¯­è¨€å®ç°è·³è·ƒè¡¨ã€‚å…³äºå‹ç¼©è¡¨æˆ‘åœ¨è¿™é‡Œä¸ä¼šæ¶‰åŠåˆ°åªå®ç°è·³è·ƒè¡¨ç›¸å…³ä»£ç ã€‚ ","date":"2022-01-07","objectID":"/posts/redis-server-zset/:4:0","tags":["redis","ç³»åˆ—ç¯‡","æ•°æ®ç»“æ„"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·æœ‰åºé›†åˆç¯‡","uri":"/posts/redis-server-zset/"},{"categories":["Redis"],"content":"4.1 æ•°æ®ç»“æ„å®šä¹‰ æ•°æ®ç»“æ„å®šä¹‰åŸºæœ¬ä¸ Redis ä¸€è‡´ï¼Œè·³è·ƒè¡¨ + map çš„ç»„åˆã€‚å…¶ä¸­ map éƒ¨åˆ†ä¸ºäº†æé«˜è¯»å†™æ€§èƒ½ï¼Œè‡ªå·±å®ç°äº†ä¸€ä¸ª map ç»“æ„ã€‚ // zSet is object contain skip list and map which store key-value pair type zSet struct { // smap.Map ä¸ºè‡ªå·±å®ç°çš„åŸç”Ÿ map çš„å°è£…ï¼Œä¹‹åå•ç‹¬è®²ä¸€ä¸‹ï¼Œä¹‹æ‰€ä»¥è‡ªå·±å®ç°æ˜¯ä¸ºäº†æé«˜æ€§èƒ½ m smap.Map // store key and value // åœ¨å…ƒç´ å°‘äº 100 \u0026 æ¯ä¸ªå…ƒç´ å¤§å°å°äº 64 çš„æ—¶å€™,Redis å®é™…ä¸Šç”¨çš„æ˜¯ zipList è¿™é‡Œä½œä¸ºçŸ¥è¯†ç‚¹æäº†ä¸€ä¸‹ // é™¤éé‡åˆ°æ€§èƒ½é—®é¢˜,å¦åˆ™ä¸å‡†å¤‡åŒæ—¶æ”¯æŒ zipList å’Œ skipList zsl *zSkipList // skip list } type zSkipList struct { head, tail *zSkipListNode length int // æ€»é•¿åº¦ level int // æœ€å¤§é«˜åº¦ } type zSkipListNode struct { value string score float64 backward *zSkipListNode levels []*zSkipListLeve } type zSkipListLeve struct { forward *zSkipListNode span uint // å½“å‰ level åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„è·¨åº¦ } ","date":"2022-01-07","objectID":"/posts/redis-server-zset/:4:1","tags":["redis","ç³»åˆ—ç¯‡","æ•°æ®ç»“æ„"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·æœ‰åºé›†åˆç¯‡","uri":"/posts/redis-server-zset/"},{"categories":["Redis"],"content":"4.2 åˆå§‹åŒ– å› ä¸ºå­˜åœ¨ä¸€ä¸ª header çš„è™šæ‹ŸèŠ‚ç‚¹ï¼Œæ‰€ä»¥åˆå§‹åŒ–çš„æ—¶å€™éœ€è¦æŠŠè·³è·ƒè¡¨çš„ header ä»¥åŠå…¶æ¯ä¸€å±‚éƒ½åˆå§‹åŒ–ã€‚ // new skiplist func newZSkipList() *zSkipList { zsl := \u0026zSkipList{ level: 1, // æ¯ä¸€å±‚ä¸ºç©ºçš„ ZSkipListMaxLevel å±‚çš„ head head: newZslNode(ZSkipListMaxLevel, 0, \"\"), } return zsl } // new node func newZslNode(level int, score float64, value string) *zSkipListNode { node := \u0026zSkipListNode{ value: value, score: score, levels: make([]*zSkipListLeve, level), } // åˆå§‹åŒ–æ¯ä¸€å±‚ for i := 0; i \u003c level; i++ { node.levels[i] = \u0026zSkipListLeve{} } return node } ","date":"2022-01-07","objectID":"/posts/redis-server-zset/:4:2","tags":["redis","ç³»åˆ—ç¯‡","æ•°æ®ç»“æ„"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·æœ‰åºé›†åˆç¯‡","uri":"/posts/redis-server-zset/"},{"categories":["Redis"],"content":"4.3 å…¶ä»–åŠŸèƒ½ å¢åˆ æ”¹æŸ¥çš„ä»£ç ä¸ä¸Šé¢æºç è§£æçš„é€»è¾‘å¤§è‡´ç›¸åŒï¼Œæˆ‘åœ¨è¿™é‡Œç»™å‡ºgo è¯­è¨€å®ç°çš„æºç ï¼Œå¯ä»¥ç‚¹å‡»æŸ¥çœ‹ã€‚åœ¨è¿™é‡Œä¸å†è®²è¿°è¿™äº›åŸºç¡€åŠŸèƒ½çš„å®ç°ï¼Œ è€Œæ˜¯ç»™å‡ºä¸€äº›ç‰¹æ®Šçš„æ–¹æ³•çš„å®ç°ã€‚ 4.3.1 æ ¹æ®æ’åæŸ¥æ‰¾å…ƒç´  åœ¨ä¸Šé¢çš„å®ç°é‡Œä¼šçœ‹åˆ°åˆ°å¤„é£çš„ span è¿™ä¸ªå±æ€§ï¼Œä½†æ˜¯å¥½åƒä¸€ç›´æ²¡æœ‰å®é™…ç”¨ä¸Šï¼Œå…¶å®åœ¨éå†è¿‡ç¨‹ä¸­å°¤å…¶æ˜¯è·Ÿæ’åç›¸å…³çš„æ“ä½œé‡Œè¿™ä¸ª span å±æ€§æ˜¯éå¸¸çš„æœ‰ç”¨ï¼Œä¸‹é¢çœ‹ä¸€ä¸‹å®é™…ç”¨å¤„ï¼š func (zsl *zSkipList) findElementByRank(rank uint) *zSkipListNode { var ( x = zsl.head // å·²éå†çš„è·ç¦» traversed uint ) // ä» head çš„é¡¶å±‚å¼€å§‹éå† for i := zsl.level - 1; i \u003e= 0; i-- { // å¦‚æœå½“å‰level çš„ä¸‹ä¸€ä¸ªå…ƒç´ çš„è·ç¦» + å·²ç»èµ°è¿‡çš„è·ç¦» å°äº ç›®æ ‡æ’å -\u003e å‘å‰ç§»åŠ¨ // å¦åˆ™ level - 1 for x.levels[i].forward != nil \u0026\u0026 traversed+x.levels[i].span \u003c= rank { traversed += x.levels[i].span x = x.levels[i].forward } // level -1 å‰åˆ¤æ–­æ˜¯å¦è¾¾åˆ°ç›®æ ‡ rank if traversed == rank { return x } } return nil } å› ä¸ºè®°å½•äº†ä¸ä¸‹ä¸€ä¸ªå…ƒç´ çš„è·ç¦»ï¼Œæ ¹æ®æ’åæ‰¾å…ƒç´ å˜å¾—å¾ˆç®€å•é«˜æ•ˆï¼Œåªè¦è·³è·ƒå¯¹åº”çš„è·ç¦»å³å¯ï¼ˆè·ç¦»ä»£è¡¨çš„å°±æ˜¯è·¨è¶Šå¤šå°‘ä¸ªå…ƒç´ ä¹Ÿå°±æ˜¯å¤šå°‘ä¸ªæ’åä½ç½®ï¼‰ 4.3.2 zrange å®ç° zrange è¿™ä¸ªå‘½ä»¤æ˜¯ä½¿ç”¨ zset æ—¶æœ€å¸¸ç”¨çš„å‘½ä»¤ä¹‹ä¸€, é‚£åº•å±‚æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ // start stop æ”¯æŒè´Ÿæ•° è´Ÿæ•°æ—¶è¡¨ç¤ºå€’æ•°ç¬¬å‡ ä¸ª func (zsl *zSkipList) zRange(start, stop int, withScores bool) []string { if start \u003c 0 { start = start + zsl.length if start \u003c 0 { start = 0 } } if stop \u003c 0 { stop = stop + zsl.length } if start \u003e stop || start \u003e= zsl.length { return nil } if stop \u003e= zsl.length { stop = zsl.length - 1 } // åˆ°ç›®å‰ä¸ºæ­¢æ˜¯ä¸ºäº†å¤„ç† start å’Œ stop è¶Šç•Œé—®é¢˜ï¼Œå¹¶æŠŠè´Ÿæ•°æ¢ç®—æˆæ­£æ•° æ–¹ä¾¿ä¸‹é¢å¤„ç† // å…ˆç”¨ä¸Šé¢çš„æ–¹æ³•æ‰¾åˆ°éå†çš„ç¬¬ä¸€ä¸ªå…ƒç´  node := zsl.findElementByRank(uint(start) + 1) var ( rangeLen = stop - start + 1 result []string ) // ä» start å…ƒç´ å¼€å§‹éå† for rangeLen \u003e 0 { result = append(result, node.value) if withScores { result = append(result, strconv.FormatFloat(node.score, 'g', -1, 64)) } // è·³è·ƒè¡¨çš„ç¬¬ 0 å±‚å¯ä»¥çœ‹åšåšæ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œè¿™æ ·éå†è¯»å–å¤šä¸ªå…ƒç´ å°±å¾ˆæ–¹ä¾¿äº† node = node.levels[0].forward rangeLen-- } return result } å¦‚ä½•é€†å‘éå† å¦‚æœéœ€è¦é€†å‘éå† ç›´æ¥æŠŠ node = node.levels[0].forward æ”¹æˆ node = node.levels[0].backward å³å¯ã€‚ ","date":"2022-01-07","objectID":"/posts/redis-server-zset/:4:3","tags":["redis","ç³»åˆ—ç¯‡","æ•°æ®ç»“æ„"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·æœ‰åºé›†åˆç¯‡","uri":"/posts/redis-server-zset/"},{"categories":["Redis"],"content":"5 æ€»ç»“ å†™åˆ°è¿™é‡Œï¼ŒRedis å¦‚ä½•å®ç° zset çš„åŸç†å’Œæºç ä»¥åŠå¦‚ä½•ç”¨ go è¯­è¨€è‡ªå·±å†™ä¸€ééƒ½è®²å®Œäº†ï¼Œä¸‹é¢åšä¸ªç®€å•çš„æ€»ç»“ã€‚ zset åº•å±‚æ˜¯ä¸¤ç§æ•°æ®ç»“æ„ç»„æˆï¼ˆziplistï¼Œ skiplist + dictï¼‰ï¼Œæ ¹æ®å­˜å‚¨çš„æ•°æ®é‡ä¸åŒä»å†³å®šä½¿ç”¨å“ªä¸ª è·³è·ƒè¡¨æ˜¯ä¸€ä¸ªæ ‘çŠ¶ç»“æ„ï¼Œè¯»å†™æ—¶é—´å¤æ‚åº¦ O(logN) è·³è·ƒè¡¨çš„level æ˜¯éšæœºç®—æ³•ç®—å‡ºæ¥çš„ï¼Œç¡®ä¿æ¯ä¸€å±‚æ˜¯ä¸Šä¸€æ¬¡çš„ P å€ï¼Œlevel è¶Šä½æ•°æ®åˆ†å¸ƒè¶Šå¯†é›† å¦‚æœå¯¹ Redis çš„æºç æˆ–è€…è·³è·ƒè¡¨æ¯”è¾ƒç†Ÿæ‚‰çš„è¯ï¼Œgo è¯­è¨€çš„å®ç°åŸºæœ¬æ²¡æœ‰ä»»ä½•éš¾åº¦ï¼Œæ˜¯æŠŠç†è§£è½¬æ¢æˆä»£ç è¿‡ç¨‹ å®ç°è¿‡ç¨‹éœ€è¦æ³¨æ„çš„æ˜¯ä¸€äº›ç‰¹æ®Šæƒ…å†µï¼ŒåŒ…æ‹¬è¾¹ç•Œé—®é¢˜ï¼Œhead å’Œ tail çš„é—®é¢˜ä»¥åŠæ“ä½œæŸä¸ªå…ƒç´ å…¶ç‰µè¿åˆ°çš„é™„è¿‘çš„å…ƒç´  ","date":"2022-01-07","objectID":"/posts/redis-server-zset/:5:0","tags":["redis","ç³»åˆ—ç¯‡","æ•°æ®ç»“æ„"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·æœ‰åºé›†åˆç¯‡","uri":"/posts/redis-server-zset/"},{"categories":["Redis"],"content":"6 å‚è€ƒé“¾æ¥ğŸ”— å‹ç¼©åˆ—è¡¨-ziplist è·³è·ƒè¡¨-skiplist go è¯­è¨€å®ç° Redis ","date":"2022-01-07","objectID":"/posts/redis-server-zset/:6:0","tags":["redis","ç³»åˆ—ç¯‡","æ•°æ®ç»“æ„"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·æœ‰åºé›†åˆç¯‡","uri":"/posts/redis-server-zset/"},{"categories":["Redis"],"content":" æœ¬ç¯‡è®²è¿° Redis ä¸­çš„åŸºç¡€æ•°æ®ç»“æ„ List çš„åº•å±‚å®ç°åŸç†å’Œå¦‚ä½•é€šè¿‡ go è¯­è¨€å®ç°ä¸€ä¸ª List çš„è¿‡ç¨‹ä»¥åŠéœ€è¦æ³¨æ„çš„é—®é¢˜ã€‚ è¯´æ˜ æœ¬æ–‡ç« ä¸ºè¯¥ç³»åˆ—çš„é“¾è¡¨ï¼Œå¦‚æœéœ€è¦é˜…è¯»å…¶ä»–ç›¸å…³æ–‡ç« ï¼Œ è¯·ç‚¹å‡»è¿™é‡Œè·³è½¬æŸ¥çœ‹ ","date":"2021-12-24","objectID":"/posts/redeis-server-list/:0:0","tags":["redis","ç³»åˆ—ç¯‡","æ•°æ®ç»“æ„"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·é“¾è¡¨ç¯‡","uri":"/posts/redeis-server-list/"},{"categories":["Redis"],"content":"1 å‰è¨€ ä¼—æ‰€å‘¨çŸ¥ï¼ŒRedis ä¸­æœ‰äº”å¤§æ•°æ®ç»“æ„ï¼Œåœ¨å„ç§é¢è¯•ä¸­ä¹Ÿä¼šç»å¸¸é‡åˆ°ç›¸å…³çš„é—®é¢˜ï¼Œä»è¿™ä¸€ç¯‡å¼€å§‹ï¼Œæˆ‘æŠŠè¿™ä¸ªäº”å¤§æ•°æ®ç»“æ„ï¼ˆstring, list, set, sorted_set, hash_mapï¼‰çš„åº•å±‚åŸç†å’Œå¦‚ä½•ç”¨ go è¯­è¨€å®ç°è®²æ˜ç™½ã€‚ ","date":"2021-12-24","objectID":"/posts/redeis-server-list/:1:0","tags":["redis","ç³»åˆ—ç¯‡","æ•°æ®ç»“æ„"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·é“¾è¡¨ç¯‡","uri":"/posts/redeis-server-list/"},{"categories":["Redis"],"content":"2 listèƒ½åŠ› list æ˜¯ä¸€ä¸ªæˆ‘ä»¬å¸¸ç”¨çš„ä¸€ä¸ª Redis ç‰¹æ€§ï¼Œç‰¹å®šå°±æ˜¯å…ˆè¿›åå‡º FILO ã€‚å¹¶ä¸”æ”¯æŒåŒç«¯çš„è¯»å†™ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ä¹Ÿèƒ½å®ç°åŸºäº list çš„ å…ˆè¿›å…ˆå‡º FIFO æ¨¡å‹ã€‚ æ€»ç»“ä¸€ä¸‹ï¼ŒRedis æ”¯æŒçš„èƒ½åŠ›ï¼š åŒç«¯è¯»å†™ æ‰¹é‡è¯»å†™ list å†…éƒ¨å…ƒç´ çš„å¢åˆ æ”¹ é˜»å¡è¯»å– ","date":"2021-12-24","objectID":"/posts/redeis-server-list/:2:0","tags":["redis","ç³»åˆ—ç¯‡","æ•°æ®ç»“æ„"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·é“¾è¡¨ç¯‡","uri":"/posts/redeis-server-list/"},{"categories":["Redis"],"content":"3 list åº•å±‚åŸç† Redis å®ç° list çš„æ˜¯åŒå‘é“¾è¡¨(linked-list)ã€‚è¿™ä¸ªæ•°æ®ç»“æ„å¤§å®¶åº”è¯¥éå¸¸çš„ç†Ÿæ‚‰ï¼Œä¸”ç»å¸¸æ‹¿é“¾è¡¨å’Œæ•°ç»„è¿›è¡Œå¯¹æ¯”ã€‚ç›¸å¯¹äºæ•°ç»„ï¼Œé“¾è¡¨æœ€å¤§çš„ä¼˜åŠ¿åœ¨äºå†™å…¥å…ƒç´ æ—¶ä¸éœ€è¦è€ƒè™‘æ•°ç»„ä¸€æ · grow è¿‡ç¨‹ï¼Œåªéœ€è¦å°†æ–°å…ƒç´ è¿æ¥åˆ°é“¾è¡¨æœ€åå³å¯ï¼Œè€Œæ•°ç»„æ˜¯éœ€è¦è€ƒè™‘æ‰©å®¹ç¼©å®¹æ—¶æ•°ç»„ grow é—®é¢˜çš„ã€‚ æ•°æ®ç»“æ„ï¼š type List struct { // è®°å½•å¤´å’Œå°¾ head, tail *listNode } type listNode struct { // åŒå‘é“¾è¡¨ // ç›¸å¯¹äºå•å‘é“¾è¡¨ å¤šè®°å½•ä¸€ä¸ª prev æŒ‡å‘å‰ä¸€ä¸ªå…ƒç´  next, prev *listNode value string } ä»æ•°æ®ç»“æ„æ¥çœ‹ï¼Œå…¶å®ä¸€ç‚¹éƒ½ä¸å¤æ‚ï¼Œåªéœ€è¦è®°å½•ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªå…ƒç´ ï¼Œå…ƒç´ å†…éƒ¨è®°å½•å‰ä¸€ä¸ªå’Œåä¸€ä¸ªå…ƒç´ çš„æŒ‡é’ˆå³å¯ã€‚è¯»å†™éƒ½æ˜¯åŸºäºä¿®æ”¹å…ƒç´ å†…æŒ‡å‘çš„æŒ‡é’ˆæ¥å®Œæˆã€‚ é…åˆä¸‹é¢å›¾çœ‹ä»£ç å°±æ›´å¥½ç†è§£äº†ï¼š ","date":"2021-12-24","objectID":"/posts/redeis-server-list/:3:0","tags":["redis","ç³»åˆ—ç¯‡","æ•°æ®ç»“æ„"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·é“¾è¡¨ç¯‡","uri":"/posts/redeis-server-list/"},{"categories":["Redis"],"content":"4 listçš„å®ç° ä¸‹é¢æˆ‘ä»¬å¼€å§‹ç”¨ go è¯­è¨€æ¥å®ç° Redis ä¸­çš„ list æ•°æ®ç»“æ„çš„ç‰¹æ€§ã€‚ ","date":"2021-12-24","objectID":"/posts/redeis-server-list/:4:0","tags":["redis","ç³»åˆ—ç¯‡","æ•°æ®ç»“æ„"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·é“¾è¡¨ç¯‡","uri":"/posts/redeis-server-list/"},{"categories":["Redis"],"content":"4.1 å®šä¹‰å’Œåˆå§‹åŒ– list å®šä¹‰ï¼š type List struct { length int // è®°å½•æ€»é•¿åº¦ head, tail *listNode } type listNode struct { next, prev *listNode value string } åˆå§‹åŒ–ï¼š func newList() *List{ return new(List) } func newListNode(val string) *listNode { return \u0026listNode{ value: val, } } ","date":"2021-12-24","objectID":"/posts/redeis-server-list/:4:1","tags":["redis","ç³»åˆ—ç¯‡","æ•°æ®ç»“æ„"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·é“¾è¡¨ç¯‡","uri":"/posts/redeis-server-list/"},{"categories":["Redis"],"content":"4.2 å¢æŸ¥å…ƒç´  4.2.1 å¢åŠ å…ƒç´  // n ä¸º head æ—¶è°ƒç”¨ // å³æ–°å¢ä¸€ä¸ªå…ƒç´ å¹¶æŠŠè¯¥å…ƒç´ ç½®ä½ head func (n *listNode) addToHead(val string) *listNode { node := newListNode(val) n.prev = node node.next = n return node } // n ä¸º tail æ—¶è°ƒç”¨ // å³æ–°å¢ä¸€ä¸ªå…ƒç´ å¹¶æŠŠè¯¥å…ƒç´ ç½®ä½ tail func (n *listNode) addToTail(val string) *listNode { node := newListNode(val) n.next = node node.prev = n return node } ä»¥ä¸Šä¸¤ä¸ªæ–¹æ³•é…åˆä¸‹é¢ä¸¤ä¸ª LPushå’Œ RPush æ–¹æ³•ä½¿ç”¨ï¼š func (l *List) LPush(val string) { l.length++ // å¦‚æœlist å†…å·²ç»æœ‰å…ƒç´ ï¼Œåˆ™æŠŠæ–°å¢å…ƒç´ ç½®ä½ head if l.head != nil { l.head = l.head.addToHead(val) return } // å½“å‰ list ä¸ºç©ºï¼Œåˆ™å°†æ–°å…ƒç´ ç½®ä½ head å’Œ tail node := newListNode(val) l.head = node l.tail = node } // é€»è¾‘ä¸ä¸Šé¢ä¸€è‡´ sssss func (l *List) RPush(val string) { l.length++ if l.tail != nil { l.tail = l.tail.addToTail(val) return } node := newListNode(val) l.head = node l.tail = node } 4.2.2 popå…ƒç´  åŸºç¡€æ–¹æ³•ï¼š // pop head å…ƒç´  å¹¶è¿”å›ä¸‹ä¸€ä¸ªå…ƒç´  // pop current node and return next node func (n *listNode) popAndNext() *listNode { var next = n.next // å°†å½“å‰èŠ‚ç‚¹çš„ next ç½®ä½ç©º n.next = nil if next != nil { next.prev = nil } return next } // pop tail å…ƒç´  å¹¶è¿”å›ä¸‹ä¸€ä¸ªå…ƒç´  // pop current node and return prev node func (n *listNode) popAndPrev() *listNode { var prev = n.prev n.prev = nil if prev != nil { prev.next = nil } return prev } ä¸‹é¢æ˜¯çœŸæ­£å®ç° LPop, RPop æ–¹æ³•ï¼š // left pop ä»å·¦è¾¹ pop ä¸€ä¸ªå…ƒç´  func (l *List) LPop() (val string, ok bool) { if l.head == nil { return \"\", false } l.length-- val = l.head.value l.head = l.head.popAndNext() if l.head == nil { l.tail = nil } return val, true } // right pop ä»å³è¾¹ pop ä¸€ä¸ªå…ƒç´  func (l *List) RPop() (val string, ok bool) { if l.tail == nil { return \"\", false } l.length-- val = l.tail.value l.tail = l.tail.popAndPrev() if l.tail == nil { l.head = nil } return val, true } 4.2.3 æŸ¥è¯¢å…ƒç´  æ ¹æ® value æŸ¥è¯¢ç¬¬ä¸€ä¸ªå…ƒç´ ï¼ˆlist å†…å…ƒç´ å€¼æ˜¯å¯ä»¥é‡å¤çš„ï¼Œæ‰€ä»¥æŸ¥è¯¢ç¬¬ä¸€ä¸ªå€¼ç›¸åŒçš„å…ƒç´ ï¼‰ func (l *List) findNode(val string) *listNode { var cur = l.head for cur != nil { if cur.value == val { return cur } cur = cur.next } return nil } æ ¹ç» index æŸ¥è¯¢å…ƒç´  func (l *List) lIndexNode(i int) *listNode { if l.head == nil { return nil } // æ”¯æŒåå‘æŸ¥ï¼Œå³å¦‚æœ i å°äº 0 åˆ™è®¤ä¸ºæ˜¯å€’æ•°ç¬¬ i ä¸ªå…ƒç´ ï¼ŒæŠŠ i è¯¥ä¸ºæ­£æ•°ç¬¬ i ä¸ª if i \u003c 0 { i += l.length } if i \u003e= l.length || i \u003c 0 { return nil } var ( idx int cur = l.head reverse = i \u003e l.length/2+1 ) // ä¸ºäº†æŸ¥è¯¢æ•ˆç‡ï¼Œåšä¸€ä¸ªå°å°çš„ä¼˜åŒ– // å¦‚æœ i åœ¨å‰åŠæ®µåˆ™ä»å¤´åˆ°å°¾çš„éå†ï¼Œåä¹‹ä»å°¾åˆ°å¤´ if reverse { idx = l.length - 1 cur = l.tail } for i != idx { if reverse { idx-- cur = cur.prev } else { idx++ cur = cur.next } } return cur } 4.2.4 åˆ é™¤å…ƒç´  å·²ç»æ”¯æŒé€šè¿‡ value/index æŸ¥è¯¢å…ƒç´ äº†ï¼Œå°±å¯ä»¥åˆ é™¤ list å†…å…ƒç´ äº†ï¼Œä¸‹é¢ä»¥ä»å°¾éƒ¨å¼€å§‹åˆ é™¤ n ä¸ªå…ƒç´ ä¸ºä¾‹ï¼š // i è¡¨ç¤º index åˆ é™¤ç¬¬ i ä¸ªå…ƒç´  func (l *List) Rem(i int) int { node := l.lIndexNode(i) if node == nil { return 0 } p := node.prev n := node.next if p != nil { p.next = nil } else { // node æ˜¯ head æ‰€ä»¥æ²¡æœ‰ prev l.head = n } if n != nil { n.prev = nil } else { // node æ˜¯ tail æ‰€ä»¥æ²¡æœ‰ next l.tail = p } if l.head == nil || l.tail == nil { // åˆ é™¤äº†æœ€åä¸€ä¸ªå…ƒç´ äº† l.head = nil l.tail = nil } l.length-- return 1 } ","date":"2021-12-24","objectID":"/posts/redeis-server-list/:4:2","tags":["redis","ç³»åˆ—ç¯‡","æ•°æ®ç»“æ„"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·é“¾è¡¨ç¯‡","uri":"/posts/redeis-server-list/"},{"categories":["Redis"],"content":"4.3 é«˜çº§ç‰¹æ€§ é…åˆä¸Šé¢çš„ä¸€äº›åŸºç¡€æ–¹æ³•ä»¥åŠé“¾è¡¨çš„ç‰¹æ€§ï¼Œå¯ä»¥å†™å‡ºä¸å°‘èŠ±æ ·ç©æ³•. 4.3.1 æŸä¸ªå…ƒç´ å‰åæ’å…¥æ–°å…ƒç´  åœºæ™¯ 1 Q: å‡å¦‚æˆ‘æƒ³åœ¨ list å†…å·²çŸ¥çš„å…ƒç´ çš„å‰é¢æˆ–åé¢æ–°å¢ä¸€ä¸ªå…ƒç´ ï¼Œä»…é€šè¿‡å¢åˆ æ”¹æŸ¥æ˜¯åšä¸åˆ°ï¼Œæœ‰ä»€ä¹ˆå¥½çš„æ–¹æ³•å‘¢ï¼Ÿ A: å…¶å®è¿˜æ˜¯é€šè¿‡éå†é“¾è¡¨æ‰¾åˆ°æ’å…¥çš„ä½ç½® ä¿®æ”¹å‰åæŒ‡å‘æŒ‡é’ˆå³å¯ã€‚ å®ç°æºç å¦‚ä¸‹ï¼š // flag å¤§äº 0 æ’å…¥åˆ° target åé¢ å°äº 0 æ’å…¥å‰é¢ func (l *List) LInsert(target, newValue string, flag int) bool { if l.head == nil { return false } // æ‰¾åˆ°å…ƒç´  node := l.findNode(target) if node == nil { return false } if flag == 0 { node.value = newValue return true } newNode := \u0026listNode{value: newValue} l.length++ // insert after if flag \u003e 0 { next := node.next node.next = newNode newNode.prev = node if next == nil { l.tail = newNode } else { newNode.next = next next.prev = newNode } return true } // insert before prev := node.prev node.prev = newNode newNode.next = node if prev == nil { l.head = newNode } else { newNode.prev = prev prev.next = newNode } return true } 4.3.2 æ‰¹é‡åˆ é™¤å…ƒç´  ä»æŸä¸ªå…ƒç´ å¼€å§‹å¾€ååˆ é™¤ N ä¸ªæˆ–åˆ é™¤æ‰€æœ‰å…ƒç´ ã€‚ // ä»head å¼€å§‹éå†åˆ é™¤ n ä¸ªå€¼ç­‰äº value çš„å…ƒç´  func (l *List) LRemCountFromHead(value string, n int) (cnt int) { var ( dumbHead = \u0026listNode{ next: l.head, } // å¼•å…¥è™šæ‹Ÿ head æ˜¯ä¸ºäº† é˜²æ­¢ä»ç¬¬ä¸€ä¸ªå…ƒç´ åˆ é™¤ï¼Œç„¶åéœ€è¦é¢‘ç¹ä¿®æ”¹ l.head çš„å€¼ // åŒæ—¶ä¸ºäº†å‡å°‘è¿‡å¤šçš„ç‰¹æ®Šåˆ¤æ–­ prev = dumbHead cur = l.head next = l.head.next ) // å¼€å§‹éå† for cur != nil \u0026\u0026 n \u003e 0 { // æ‰¾æ‰“å…ƒç´  if cur.value == value { // cur å‰åçš„å…ƒç´ è¿æ¥èµ·æ¥ prev.next = next if next != nil { next.prev = prev } // cur æŒ‡å‘å‰åçš„æŒ‡é’ˆç½®ä½ç©º cur.prev, cur.next = nil, nil cnt++ n-- } else { // åªæœ‰åœ¨æ²¡æœ‰è¢«åˆ é™¤å…ƒç´ æ—¶æ‰ç§»åŠ¨ prev // *æ³¨æ„ï¼šprev ä¸èƒ½æ¯æ¬¡éƒ½ç§»åŠ¨ï¼Œå› ä¸ºä¸ç¡®å®šä¸‹ä¸€ä¸ªå…ƒç´ æ˜¯ä¸æ˜¯ä¹Ÿæ˜¯è¦è¢«åˆ é™¤çš„ï¼Œ // åªæœ‰ç¡®ä¿ cur ä¸æ˜¯æˆ‘ä»¬è¦æ‰¾çš„å…ƒç´ æ—¶å€™ æ‰ä¼šåŒæ—¶ç§»åŠ¨ä¸‰ä¸ªæŒ‡é’ˆ* prev = prev.next } // dumHead 1 2 2 4 5 // ^ ^ ^ -\u003e\u003e // prev cur next // cur å’Œ next å¾€åç§»åŠ¨ cur = next if next != nil { next = next.next } } // remove last element if prev.next == nil { l.tail = prev } l.head = dumbHead.next if l.head != nil { // if remove first element from, dumbHead.next.prev will be point to dumbHead // // In other words, l.head.tail will be not nil l.head.prev = nil } l.length -= cnt return } 4.3.3 å±€éƒ¨éå† åœºæ™¯ 2 Q: éœ€è¦è¯»å–å‰å‡ ä¸ªæˆ–è€…åå‡ ä¸ªæˆ–è€…ä»ç¬¬ N ä¸ªåˆ°ç¬¬ M ä¸ªå…ƒç´ ï¼Œä½†æ˜¯ä¸æƒ³ pop å‡ºæ¥æ€ä¹ˆåŠï¼Ÿ å±€éƒ¨éå†çš„å®ç°ï¼š func (l *List) LRange(start, stop int) (values []string) { if l.head == nil { return nil } // è¿™é‡Œéœ€è¦æ”¯æŒè´Ÿæ•°ï¼Œå› ä¸º Redis lrange æ˜¯æ”¯æŒè´Ÿæ•° // è´Ÿæ•°ä»£è¡¨å€’æ•°ç¬¬ N ä¸ª if start \u003c 0 { start = start + l.length if start \u003c 0 { start = 0 } } // éœ€è¦å¤„ç†ä¸€ä¸‹è´Ÿæ•° è™½ç„¶å®¢æˆ·ç«¯è¡¨è¾¾å¼å€’æ•°ç¬¬ N ä¸ª ä½†æ˜¯å®ç°çš„æ—¶å€™éƒ½æ˜¯ç»Ÿä¸€ä»å¤´éå†åˆ°å°¾ // å…¨éƒ¨è½¬æ¢ä¸ºæ­£æ•° if stop \u003c 0 { stop = stop + l.length } // start already \u003e=0 , so if stop \u003c 0 then this case is true if start \u003e stop || start \u003e l.length { return nil } if stop \u003e= l.length { stop = l.length - 1 } var ( head = l.head idx int ) for head != nil \u0026\u0026 idx \u003c= stop { if idx \u003e= start { values = append(values, head.value) } idx++ head = head.next } return } ","date":"2021-12-24","objectID":"/posts/redeis-server-list/:4:3","tags":["redis","ç³»åˆ—ç¯‡","æ•°æ®ç»“æ„"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·é“¾è¡¨ç¯‡","uri":"/posts/redeis-server-list/"},{"categories":["Redis"],"content":"5 æ€»ç»“ ç›®å‰ä½ç½®é™¤äº†é˜»å¡è¯»å–å¤–ï¼Œå…¶ä»–æ•°æ®ç»“æ„ç‰¹æ€§éƒ½ä»¥å…¨éƒ¨å®ç°æˆ–è€…å®ç°äº†åº•å±‚æ–¹æ³• ï¼Œä¸Šé¢å°è£…å³å¯ï¼Œå®Œæ•´ä»£ç è¯·çœ‹ GitHub é¡¹ç›®ã€‚å…³äºé˜»å¡è¿™å—ï¼Œç”±äºæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯æ˜¯é•¿é“¾æ¥ï¼Œæ‰€ä»¥å®ç°å…¶å®æ¯”è¾ƒç®€å•ï¼Œè€Œä¸”ä¹Ÿå±äºæ•°æ®ç»“æ„çš„èŒƒç•´ï¼Œæ‰€ä»¥ä¸å†è¿™é‡Œç»†è®²ï¼Œä¸‹é¢ç»™å‡ºæ€è·¯ã€‚ èµ·ä¸€ä¸ª goroutine, ç›‘å¬å¯¹åº” key çš„æ•°æ® æœ‰æ•°æ®ä¹‹å‰è¿™æ¬¡è¯·æ±‚æ—¶ä¸å“åº”ï¼ŒçŸ¥é“è¿”å›æ­£ç¡®ç»“æœæˆ–è€…å®¢æˆ·ç«¯ä¸»åŠ¨æ–­å¼€è¿æ¥ æ‹¿åˆ°æ•°æ®åï¼Œåœæ­¢ goroutine, å“åº”å®¢æˆ·ç«¯ã€‚ æ•´ä½“ä¸‹æ¥å› ä¸ºæ•°æ®å¤„ç†éƒ½æ˜¯å•è¿›ç¨‹ï¼Œä¸éœ€è¦è€ƒè™‘è¿›ç¨‹é—´èµ„æºç«äº‰é—®é¢˜ï¼Œä»£ç ç›¸å¯¹ç®€æ´å¾ˆå¤šï¼Œæ³¨æ„å¢åˆ å…ƒç´ æ—¶å‰åå…³ç³»ä»¥åŠæé™æƒ…å†µï¼ˆè¾¹ç•Œçš„å…ƒç´ çš„ä¿®æ”¹ï¼‰ã€‚ ","date":"2021-12-24","objectID":"/posts/redeis-server-list/:5:0","tags":["redis","ç³»åˆ—ç¯‡","æ•°æ®ç»“æ„"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·é“¾è¡¨ç¯‡","uri":"/posts/redeis-server-list/"},{"categories":["Redis"],"content":"6 é¡¹ç›®é“¾æ¥ğŸ”— https://github.com/yusank/godis ","date":"2021-12-24","objectID":"/posts/redeis-server-list/:6:0","tags":["redis","ç³»åˆ—ç¯‡","æ•°æ®ç»“æ„"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·é“¾è¡¨ç¯‡","uri":"/posts/redeis-server-list/"},{"categories":["Go"],"content":" Go å·²ç»ç¡®å®åœ¨ 1.18 ç‰ˆæœ¬æ”¯æŒæ³›å‹äº†ï¼Œé¢„è®¡ 2022 å¹´ 2 æœˆä»½å‘å¸ƒ 1.18 æ­£å¼ç‰ˆï¼Œåˆ°ç›®å‰ä¸ºæ­¢æ³›å‹ç›¸å…³è§„èŒƒå·²ç¡®å®šä¸”å¯ä»¥åœ¨å¼€å‘åˆ†æ”¯çš„ go ç‰ˆæœ¬ä¸­å°è¯•ä½¿ç”¨äº†ï¼Œè¿™ç¯‡æ–‡ç« å¸¦ä½ é¢†ç•¥ go çš„æ³›å‹. ","date":"2021-12-09","objectID":"/posts/go-generic/:0:0","tags":["go1.18","æ³›å‹"],"title":"Go æ³›å‹æå‰å°è¯•","uri":"/posts/go-generic/"},{"categories":["Go"],"content":"å®‰è£… go å¼€å‘ç‰ˆ æ²¡æœ‰å‘ç‰ˆæˆ‘æ€ä¹ˆæå‰å°è¯•å‘¢ï¼Ÿ åœ¨è¿™é‡Œåˆ†äº«ä¸€ä¸ªå°æŠ€å·§ï¼Œå­¦ä¼šäº†ä¹‹åä»¥åæ¯ä¸ªæ–°ç‰ˆæœ¬å‘å¸ƒå‰éƒ½å¯ä»¥æå‰å°è¯•æ–°ç‰ˆçš„ç‰¹æ€§ï¼Œæå‰å­¦ä¹ å¥½ã€‚ å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤å®‰è£…æœ€æ–°çš„ master åˆ†æ”¯ï¼š go install golang.org/dl/gotip gotip download ç°åœ¨å¯ä»¥æŠŠ gotip è¿™ä¸ªå‘½ä»¤å½“åš go å‘½ä»¤æ¥ä½¿ç”¨äº†ï¼Œ gotip version go version devel go1.18-d6c4583 Wed Dec 8 23:38:20 2021 +0000 linux/amd64 çµæ´»ä½¿ç”¨ bash alias gotip æ•²èµ·æ¥éº»çƒ¦ï¼Œæ€»æ˜¯ä¹ æƒ¯æ€§æ‰“ go build/run , æˆ‘å°±åœ¨ .bashrc æ·»åŠ äº†ä¸€è¡Œé…ç½® alias go18=\"gotip\" # å¦‚æœä½ æœ‰å•ç‹¬çš„ workspace ç›´æ¥ç”¨ go=\"gotip\" ä¹Ÿå¯ä»¥ ","date":"2021-12-09","objectID":"/posts/go-generic/:1:0","tags":["go1.18","æ³›å‹"],"title":"Go æ³›å‹æå‰å°è¯•","uri":"/posts/go-generic/"},{"categories":["Go"],"content":"æ³›å‹ ","date":"2021-12-09","objectID":"/posts/go-generic/:2:0","tags":["go1.18","æ³›å‹"],"title":"Go æ³›å‹æå‰å°è¯•","uri":"/posts/go-generic/"},{"categories":["Go"],"content":"åŸºç¡€ç”¨æ³• ç»ˆäºå¯ä»¥ä¸ç”¨ä¸º int/uint/int8/int16/int32/int64 å†™ä¸€å †ä»£ç ç±»ä¼¼çš„ä»£ç äº†ï¼ type Integer interface{ ~uint|~uint8|~uint16|~uint32|~uint64|~int|~int8|~int16|~int32|~int64 } func Max[T Integer](a, b T) T { if a \u003e b { return a } return b } func main() { fmt.Println(Max(1, 2)) // 2 fmt.Println(Max(uint(1), uint(2))) // uint(2) fmt.Println(Max(int64(1), int64(2))) // 2 } å®šä¹‰æ”¯æŒçš„ç±»å‹ Integer, | è¡¨ç¤ºå¹¶é›†ï¼Œ ~ è¡¨ç¤ºåº•å±‚æ˜¯è¯¥ç±»å‹ä¹Ÿå¯ä»¥(type CustomInt int è¿™ç§æƒ…å†µ)ã€‚è¿™ä¸ªå°±æ˜¯æœ€åŸºç¡€çš„åŸºäºæ³›å‹çš„ä»£ç äº†ï¼Œæ˜¯ä¸æ˜¯çœ‹ç€éƒ½ä¸å¤ªåƒ go ä»£ç äº†ï¼Œå“ˆå“ˆã€‚ å…¶å®ï¼Œ Integer ç±»å‹ä¸éœ€è¦æˆ‘ä»¬å®šä¹‰äº†ï¼Œgo å®˜æ–¹æ–°å¢äº† constraints åŒ…ï¼Œæ”¾äº†ä¸€äº›å¸¸ç”¨çš„æ³›å‹ç±»å‹ï¼ŒåæœŸåº”è¯¥ä¹Ÿä¼šæ‰©å±•ã€‚ // Copyright 2021 The Go Authors. All rights reserved. // Use of this source code is governed by a BSD-style // license that can be found in the LICENSE file. // Package constraints defines a set of useful constraints to be used // with type parameters. package constraints // Signed is a constraint that permits any signed integer type. // If future releases of Go add new predeclared signed integer types, // this constraint will be modified to include them. type Signed interface { ~int | ~int8 | ~int16 | ~int32 | ~int64 } // Unsigned is a constraint that permits any unsigned integer type. // If future releases of Go add new predeclared unsigned integer types, // this constraint will be modified to include them. type Unsigned interface { ~uint | ~uint8 | ~uint16 | ~uint32 | ~uint64 | ~uintptr } // Integer is a constraint that permits any integer type. // If future releases of Go add new predeclared integer types, // this constraint will be modified to include them. type Integer interface { Signed | Unsigned } // Float is a constraint that permits any floating-point type. // If future releases of Go add new predeclared floating-point types, // this constraint will be modified to include them. type Float interface { ~float32 | ~float64 } // Complex is a constraint that permits any complex numeric type. // If future releases of Go add new predeclared complex numeric types, // this constraint will be modified to include them. type Complex interface { ~complex64 | ~complex128 } // Ordered is a constraint that permits any ordered type: any type // that supports the operators \u003c \u003c= \u003e= \u003e. // If future releases of Go add new ordered types, // this constraint will be modified to include them. type Ordered interface { Integer | Float | ~string } ä¸Šé¢çš„ä»£ç å¯ä»¥ç®€åŒ–ä¸ºå¦‚ä¸‹ï¼š import ( \"constraints\" ) func Max[T constraints.Integer](a, b T) T { if a \u003e b { return a } return b } func main() { fmt.Println(Max(1, 2)) // 2 fmt.Println(Max(uint(1), uint(2))) // uint(2) fmt.Println(Max(int64(1), int64(2))) // 2 } å½“ç„¶å¦‚æœæƒ³æ‰©å±•ä¹Ÿæ˜¯å®Œå…¨å¯ä»¥ï¼Œæ¯”å¦‚ä¸Šé¢çš„ Max æ–¹æ³•è¦æ”¯æŒ float ç±»å‹çš„è¯ï¼Œè‡ªå·±å®šä¹‰ä¸€ä¸ªæ–°çš„ interface å³å¯ã€‚ type Number interface{ constraints.Integer | constraints.Float } ","date":"2021-12-09","objectID":"/posts/go-generic/:2:1","tags":["go1.18","æ³›å‹"],"title":"Go æ³›å‹æå‰å°è¯•","uri":"/posts/go-generic/"},{"categories":["Go"],"content":"èŠ±å¼ç©æ³• slice å¦‚æœä½ å†™ go çš„æ—¶é—´é•¿çš„è¯ï¼Œ åº”è¯¥ç»å†è¿‡å†™å¾ˆå¤šé•¿å¾—å¾ˆåƒæ’åºç®—æ³•ï¼Œä¹Ÿåº”è¯¥ç¾¡æ…•è¿‡python/jsçš„ç›´æ¥ string.sort()è¿™ç§å†™æ³•çš„ï¼Œç°åœ¨ç”¨æ³›å‹ä¹Ÿå¯ä»¥ç©å‡ºåŒæ ·çš„å§¿åŠ¿äº†ã€‚åºŸè¯ä¸å¤šè¯´ç›´æ¥ä¸Šè´§ï¼š type Slice[T constraints.Ordered] []T func (s Slice[T]) Sort() { sort.Slice(s,func (i,j int) bool { return s[i] \u003c s[j] }) } func main() { // éšæ—¶å®šä¹‰éšæ—¶è°ƒç”¨ï¼Œæ²¡æœ‰è¿‡å¤šçš„æ–¹æ³•è°ƒç”¨æˆ–è€…é¢å¤–çš„æ¡ä»¶åˆ¤æ–­äº† ss := Slice[string]{\"b\",\"d\",\"c\",\"a\"} ss.Sort() fmt.Println(ss) is := Slice[int]{2,4,1,3} is.Sort() fmt.Println(is) } è¿™å—ä»£ç è¿è¡ŒæˆåŠŸåï¼Œæˆ‘åæ­£æ˜¯å¾ˆçˆ½çš„ï¼Œä»¥åèµ·ç å°‘äº›å¾ˆå¤šé•¿å¾—åƒåŠŸèƒ½è¿˜ä¸€æ ·çš„ä»£ç äº†ï¼Œç­‰æ­£å¼å‘ç‰ˆåå¯ä»¥æä¸€æ³¢æ”¯æŒæ³›å‹çš„åŸºç¡€åº“äº†ã€‚ map map çš„ key-value å‡å¯ä»¥æŒ‡å®šæ³›å‹ï¼Œä»è€Œçµæ´»çš„åšä¸€äº›å¤„ç†ï¼Œä¸‹é¢ä»¥è¿”å›æŸä¸ª map çš„ key ä½œä¸ºæ•°ç»„çš„ä¾‹å­ï¼š // å®šä¹‰ä¸€ä¸ª key å¯ä»¥åšå¯¹æ¯”çš„ç±»å‹ value ä½œä¸ºä»»æ„ç±»å‹ // æ³¨ï¼š any == interface{} type Map[K constraints.Ordered, V any] map[K]V func (m Map[K,V]) Keys() []K { var result []K for k := range m { result = append(result, k) } return result } func main() { sm := Map[string,int]{\"a\":1,\"b\":2} fmt.Println(sm.Keys()) // [a, b] im := Map[int,string]{1:\"a\",2:\"b\"} fmt.Println(im.Keys()) // [1, 2] } è¿™æ ·å‡å°‘äº†å¾ˆå¤šç±»å‹åˆ¤æ–­ç±»å‹è½¬æ¢çš„è¿‡ç¨‹äº†ï¼Œåªè¦åˆå§‹åŒ–çš„æ—¶å€™å£°æ˜å¥½äº†åè¿”å›çš„å°±æ˜¯å¯¹åº”ç±»å‹çš„æ•°ç»„è€Œä¸æ˜¯ []interface{} . chan chan ä½œä¸ºåœ¨é«˜å¹¶å‘å¼‚æ­¥ç¼–ç¨‹ä¸­éå¸¸å¸¸ç”¨çš„ç‰¹æ€§ï¼Œä¹‹å‰ä¹Ÿé¢é¢†ç€åŒæ ·ç±»å‹è½¬æ¢ç±»å‹åˆ¤æ–­çš„å›°æ‰°ï¼Œè®¾æƒ³ä¸€ä¸ªåœºæ™¯ï¼Œå¦‚æœæˆ‘æœ‰ä¸ªéœ€æ±‚ï¼Œå°†æ•°ç»„è½¬æ¢æˆ channelï¼Œå¼‚æ­¥çš„å»å¤„ç†è¿™ç»„æ•°æ®ï¼Œå¦‚æœæ•°ç»„ç±»å‹æ˜¯å•ä¸ªè¿˜å¥½ å¦‚æœæˆ‘åˆæœ‰ string çš„åˆæœ‰ int çš„æœªæ¥å¯èƒ½è¿˜ä¼šæœ‰åˆ«çš„ç±»å‹ï¼Œé‚£åªèƒ½ä¸€ä¸ªç±»å‹ä¸€ä¸ªæ–¹æ³•æˆ–è€…ç»Ÿä¸€ interface ç„¶åä½¿ç”¨æ—¶ç±»å‹è½¬æ¢ã€‚å¦‚æœç”¨æ³›å‹å®ç°å‘¢ï¼Ÿ // ç±»å‹ä¹Ÿå¯ä»¥æŒ‰éœ€æ±‚é™åˆ¶åœ¨ Ordered æˆ– comparable ç­‰èŒƒå›´ func convertChan[T any](slice []T) chan T { ch := make(chan T, 1) go func() { defer close(ch) for _, v := range slice { ch \u003c- v } }() return ch } func main() { s1 := []string{\"a\", \"b\", \"c\"} // s2 := []float64{1.1, 1.2, 1.3} ch := convertChan(s1) // ch =\u003e chan string for v := range ch { fmt.Println(v) } // a, b, c } ","date":"2021-12-09","objectID":"/posts/go-generic/:2:2","tags":["go1.18","æ³›å‹"],"title":"Go æ³›å‹æå‰å°è¯•","uri":"/posts/go-generic/"},{"categories":["Go"],"content":"æ€»ç»“ æ€»ç»“ æ•´ä½“è€Œè¨€ï¼Œæ–°å¢çš„æ³›å‹æˆ‘è§‰å¾—åˆ©å¤§äºå¼Šçš„ï¼Œçœ‹èµ·æ¥æ˜¯è¯­æ³•å¤æ‚äº†å¾ˆå¤šå…¶å®å¹¶æ²¡æœ‰ï¼Œå®šä¹‰çš„æ—¶å€™é™åˆ¶ä¸€äº›å¯ç”¨çš„åŸºç¡€ç±»å‹æˆ–è€…ç›´æ¥ç”¨ any æ¥è¡¨ç¤ºæ¥å—ä»»ä½•ç±»å‹çš„å‚æ•°å³å¯ã€‚ å¯¹äºå¼€å‘è€…æ¥è¯´ç»å¯¹ä¼šå‡å°‘ä¸€éƒ¨åˆ†é‡å¤ä»£ç çš„ï¼Œä¹Ÿå¯ä»¥åšä¸€äº›æ›´å¥½çš„æŠ½è±¡ï¼Œä»é•¿è¿œæ¥è¯´å¯¹å¼€å‘è€…è¿˜æ˜¯å¥½å¤„å¾ˆå¤šçš„ã€‚ 1.18æ˜¯ç¬¬ä¸€ä¸ªæ”¯æŒæ³›å‹çš„ç‰ˆæœ¬ï¼Œè‚¯å®šä¼šè°¨æ…ä¸€äº›ï¼Œä¹‹åçš„ç‰ˆæœ¬è¯¥åŠŸèƒ½è¯´ä¸å®šä¼šå¾—åˆ°æ›´å¤šçš„æ‰©å±•å’Œæ”¯æŒï¼Œæ‰€ä»¥è¿˜æ˜¯å¾ˆæœŸå¾…çš„ã€‚ æœ€å å¦‚æœä½ å¯¹æ³›å‹æœ‰è‡ªå·±ä¸ä¸€æ ·çš„çœ‹æ³•æˆ–è€…ç”¨æ³•ï¼Œä¹Ÿå¯ä»¥æ¥è®¨è®ºè®¨è®ºã€‚ ","date":"2021-12-09","objectID":"/posts/go-generic/:3:0","tags":["go1.18","æ³›å‹"],"title":"Go æ³›å‹æå‰å°è¯•","uri":"/posts/go-generic/"},{"categories":["Go"],"content":"å‚è€ƒæ–‡æ¡£ https://bitfieldconsulting.com/golang/generics https://colobu.com/2021/10/24/go-generic-eliding-interface/ ","date":"2021-12-09","objectID":"/posts/go-generic/:4:0","tags":["go1.18","æ³›å‹"],"title":"Go æ³›å‹æå‰å°è¯•","uri":"/posts/go-generic/"},{"categories":["Redis"],"content":" è¿™ä¸€ç¯‡ä¸»è¦æ˜¯å°†å¦‚ä½•å®šä¹‰ä¸€ä¸ªæ¯”è¾ƒå®Œå–„çš„æœåŠ¡å…¥å£ä»¥åŠå¦‚ä½•ç®¡ç†æœåŠ¡çš„ç”Ÿå‘½å‘¨æœŸã€å¦‚ä½•å¤„ç† tcp çš„è¿æ¥ç®¡ç†å’Œè¯·æ±‚å¤„ç†ç­‰ç›¸å…³å†…å®¹ã€‚ è¯´æ˜ æœ¬æ–‡ç« ä¸ºè¯¥ç³»åˆ—çš„æœåŠ¡ç®¡ç†ç¯‡ï¼Œå¦‚æœéœ€è¦é˜…è¯»å…¶ä»–ç›¸å…³æ–‡ç« ï¼Œ è¯·ç‚¹å‡»è¿™é‡Œè·³è½¬æŸ¥çœ‹ ","date":"2021-12-06","objectID":"/posts/redis-server-network/:0:0","tags":["redis","ç³»åˆ—ç¯‡","ç½‘ç»œ"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·æœåŠ¡ç®¡ç†ç¯‡","uri":"/posts/redis-server-network/"},{"categories":["Redis"],"content":"å®šä¹‰æœåŠ¡ è¯¥é¡¹ç›®ä½œä¸º Redis Server, éœ€è¦å®šä¹‰ä¸€ä¸ª Server å¯¹è±¡ ä½œä¸ºæœåŠ¡å¯åŠ¨å…³é—­åŠè¯·æ±‚å¤„ç†çš„çš„å…¥å£ã€‚ type Server struct { addr string // ç›‘å¬ ip:port handler api.Handler // è¯·æ±‚å¤„ç†æ–¹æ³• listener net.Listener // ç›‘å¬å…¥å£ } func NewServer(addr string, h api.Handler) *Server { return \u0026Server{ addr: addr, handler: h, } } ","date":"2021-12-06","objectID":"/posts/redis-server-network/:1:0","tags":["redis","ç³»åˆ—ç¯‡","ç½‘ç»œ"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·æœåŠ¡ç®¡ç†ç¯‡","uri":"/posts/redis-server-network/"},{"categories":["Redis"],"content":"å¯åŠ¨æœåŠ¡ æ­£å¸¸ç›‘å¬ tcp æœåŠ¡ï¼Œå¹¶å¤„ç†è¿æ¥å³å¯ã€‚ func (s *Server) Start() error { l, err := net.Listen(\"tcp\", s.addr) if err != nil { log.Println(\"listen err:\", err) return err } log.Println(\"listen: \", l.Addr()) s.listener = l // é˜»å¡å¤„ç† s.handleListener() return nil } ","date":"2021-12-06","objectID":"/posts/redis-server-network/:2:0","tags":["redis","ç³»åˆ—ç¯‡","ç½‘ç»œ"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·æœåŠ¡ç®¡ç†ç¯‡","uri":"/posts/redis-server-network/"},{"categories":["Redis"],"content":"å¤„ç†è¿æ¥ ä¹‹åä¾¿å¯ä»¥ accept è¿æ¥è¯·æ±‚ï¼Œå¤„ç†è¯·æ±‚ã€‚åœ¨æ¯å»ºç«‹ä¸€ä¸ªæ–°çš„è¿æ¥çš„æ—¶å€™ï¼Œå¯åŠ¨ä¸€ä¸ª goroutine æ¥å¤„ç†è¯¥è¿æ¥ï¼Œä»è€Œæ”¯æŒé«˜å¹¶å‘çš„è¯·æ±‚ã€‚ // Server å†…ä¿å­˜ net.Listener ç­‰æœåŠ¡å¿…è¦å‚æ•° func (s *Server) handleListener() { for { conn, err := s.listener.Accept() if err != nil { // å¦‚æœ listener å·²è¢«å…³é—­åˆ™é€€å‡º if errors.Is(err, net.ErrClosed) { log.Println(\"closed\") break } log.Println(\"accept err:\", err) continue } log.Println(\"new conn from:\", conn.RemoteAddr().String()) // å¤„ç†è¯¥è¯·æ±‚ go s.handleConn(conn) } } å¤„ç†é€»è¾‘å¦‚ä¸‹ï¼š // handle by a new goroutine func (s *Server) handleConn(conn net.Conn) { defer func() { _ = conn.Close() }() // åˆå§‹åŒ– Server æ—¶ï¼Œå°† handler ä¹Ÿæ³¨å†Œè¿›æ¥ // Handle æ–¹æ³•çš„æ ¸å¿ƒé€»è¾‘æ—¶ï¼Œè¯»å–è¯·æ±‚å†…å®¹ï¼Œæ ¹æ®åˆ° Redis åè®®è§£æå†…å®¹ // å¹¶å¯¹è¿™æ¬¡è¯·æ±‚åšå‡ºå“åº”å¹¶è¿”å› reply reply, err := s.handler.Handle(reader) if err == io.EOF { return } if err != nil { log.Println(\"handle err:\", err) return } if len(reply) == 0 { return } _, err = conn.Write(reply) if err != nil { log.Println(\"write err:\", err) return } } ","date":"2021-12-06","objectID":"/posts/redis-server-network/:3:0","tags":["redis","ç³»åˆ—ç¯‡","ç½‘ç»œ"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·æœåŠ¡ç®¡ç†ç¯‡","uri":"/posts/redis-server-network/"},{"categories":["Redis"],"content":"å¤„ç†è¯·æ±‚ ä¸Šè¿°å¤„ç†é€»è¾‘ä¸­æ¯”è¾ƒé‡è¦çš„ä¸€ä¸ªé€»è¾‘æ˜¯ handler.Handle(reader), è¿™é‡Œé¢æ˜¯å¦‚ä½•è¯»å–è¯·æ±‚å†…å®¹å¹¶è§£æåè®®çš„ï¼Œä¸‹é¢å°†ä¼šä»¥ç®€åŒ–çš„ä»£ç é€»è¾‘ è®²è¿°å¤„ç†é€»è¾‘ï¼š func (TCPHandler) Handle(r api.Reader) ([]byte, error) { // io data to protocol msg rec, err := protocol.DecodeFromReader(r) if err != nil { return nil, err } log.Println(rec) rsp := redis.NewCommandFromReceive(rec).Execute(context.Background()) log.Println(\"rsp:\", debug.Escape(string(rsp.Encode()))) return rsp.Encode(), err } // 1. è¯»å–å†…å®¹decodeåè®® type Receive []string func DecodeFromReader(r api.Reader) (rec Receive, err error) { rec = make([]string, 0) // read first line b, err := r.ReadBytes('\\n') if err != nil { log.Println(\"readBytes err:\", err) return nil, err } // decode line content str, length, desc, err := decodeSingleLine(b) if err != nil { log.Println(\"init message err:\", err) return nil, err } // å¦‚æœæ˜¯ bulk æˆ–è€… array åˆ™éœ€è¦å¾€ä¸‹è¯»å– length è¡Œ // length ä»ç¬¬ä¸€è¡Œå†…å®¹ä¸­è§£æå‡ºæ¥ if desc == DescriptionBulkStrings { temp, err1 := readBulkStrings(r, length) if err1 != nil { log.Println(\"read bulk str err:\", err1) return nil, err1 } rec = append(rec, string(temp)) return } if desc == descriptionArrays { // won't sava array element items, err1 := readArray(r, length) if err1 != nil { log.Println(\"read bulk str err:\", err1) return nil, err1 } rec = append(rec, items...) return } rec = append(rec, str) return } // 2. å¤„ç†è¯·æ±‚ï¼ˆå¤„ç† Redis å‘½ä»¤ï¼‰ rsp := redis.NewCommandFromReceive(rec).Execute(context.Background()) // 3. å¤„ç†ç»“æœ encode æˆ Redis åè®® return rsp.Encode(), err å°ç»“æ€»ç»“ è‡³æ­¤ï¼Œä¸€ä¸ªç®€å•çš„ server ç«¯çš„èƒ½åŠ›åŸºæœ¬éƒ½æœ‰äº†ï¼Œä»æœåŠ¡å¯åŠ¨åˆ°ç›‘å¬ç«¯å£ã€å¤„ç†è¿æ¥ã€å¤„ç†è¯·æ±‚ä»¥åŠå“åº”ã€‚ ä½†æ˜¯é—®é¢˜ä¹Ÿå¾ˆå¤šï¼š è¯·æ±‚å¤„ç†å®Œè¿æ¥ä¼šæ–­å¼€ï¼Œéœ€è¦æ”¯æŒé•¿é“¾æ¥ æœåŠ¡å¯åŠ¨åç›´æ¥é˜»å¡ä¸»çº¿ç¨‹ï¼Œä¸”æ²¡æœ‰ä¼˜é›…é€€å‡ºé€»è¾‘ï¼Œå¯¼è‡´æœåŠ¡å…³é—­æ—¶å¯èƒ½å­˜åœ¨è¯·æ±‚æœªå¤„ç†å®Œçš„æƒ…å†µ goroutine æ— é™å¼€å¯å¹¶ä¸èƒ½æ›´å¥½çš„å¤„ç†å’Œç®¡ç† ä¸‹é¢é’ˆå¯¹ä»¥ä¸Šé—®é¢˜è¿›è¡Œä¸€æ­¥æ­¥ä¼˜åŒ–ã€‚ ","date":"2021-12-06","objectID":"/posts/redis-server-network/:4:0","tags":["redis","ç³»åˆ—ç¯‡","ç½‘ç»œ"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·æœåŠ¡ç®¡ç†ç¯‡","uri":"/posts/redis-server-network/"},{"categories":["Redis"],"content":"æ›´å®Œå–„çš„æœåŠ¡å®šä¹‰ type Server struct { addr string // æ–°å¢æ”¯æŒ context ä»è€Œæ›´å¥½çš„æ§åˆ¶ä¸Šä¸‹æ–‡å’Œä¸‹æ¸¸ goroutine ctx context.Context cancel context.CancelFunc handler api.Handler listener net.Listener // æ–°å¢ WaitGroup æ›´å¥½æ§åˆ¶å¹¶å‘å’Œé€€å‡ºé€»è¾‘ wg *sync.WaitGroup } Question å•ä»æœåŠ¡å®šä¹‰çœ‹ä¸å‡ºæ¥å¤ªå¤šçš„å˜åŒ–ï¼Œå³ä¾¿æ–°å¢å‡ ä¸ªå­—æ®µåˆèƒ½å¦‚ä½•è§£å†³ä¸Šé¢çš„é—®é¢˜å‘¢ï¼Ÿ ","date":"2021-12-06","objectID":"/posts/redis-server-network/:5:0","tags":["redis","ç³»åˆ—ç¯‡","ç½‘ç»œ"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·æœåŠ¡ç®¡ç†ç¯‡","uri":"/posts/redis-server-network/"},{"categories":["Redis"],"content":"æ›´ä¼˜é›…çš„æœåŠ¡å¯åœ æœåŠ¡å¯åŠ¨å’Œè¿è¡Œè¿‡ç¨‹ä¸­æ„ŸçŸ¥åˆ°æœåŠ¡ä»¥å¤–çš„ä¸€äº›æ•°æ®æ‰èƒ½åœ¨ä¸€äº›ç‰¹æ®Šæƒ…å†µä¸‹æ›´ä»å®¹çš„ handle ä½é—®é¢˜ã€‚è¿™ä¸ªæœåŠ¡ä»¥å¤–çš„æ•°æ®ä¸€èˆ¬å°±æ˜¯ç³»ç»Ÿçš„ä¿¡å·é‡(Signal) .é™¤æ­¤ä¹‹å¤–è¿˜éœ€è¦å…³å¿ƒä¸‹æ¸¸çš„ goroutine çš„æƒ…å†µï¼Œåœ¨ä¸‹æ¸¸æœåŠ¡é‡åˆ°ä¸å¯æ§çš„ Fatel äº‹ä»¶æ—¶ï¼Œä¸Šæ¸¸æœåŠ¡éœ€è¦åšåˆ¤æ–­æ˜¯å¦è¦å…³é—­æœåŠ¡ã€‚åœ¨ä¸» server éœ€è¦å…³åœæ—¶ï¼Œéœ€è¦è®©ä¸‹æ¸¸æœåŠ¡æ„ŸçŸ¥åˆ°ä¸”ç»™ä¸‹æ¸¸ goroutine å¤„ç†çš„æ—¶é—´ä½†åˆå¾—æœ‰ä¸€å®šçš„æ—¶é—´æ§åˆ¶ ä¸èƒ½æ— é™æœŸç­‰å¾…ï¼Œè¿™äº›éƒ½æ˜¯éœ€è¦è€ƒè™‘çš„é—®é¢˜ã€‚ ","date":"2021-12-06","objectID":"/posts/redis-server-network/:6:0","tags":["redis","ç³»åˆ—ç¯‡","ç½‘ç»œ"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·æœåŠ¡ç®¡ç†ç¯‡","uri":"/posts/redis-server-network/"},{"categories":["Redis"],"content":"ä¸» server çš„å¯åœ func (s *Server) Start() error { // ç›‘å¬ä¿¡å·é‡ sigChan := make(chan os.Signal, 1) signal.Notify(sigChan, syscall.SIGTERM, syscall.SIGINT, syscall.SIGQUIT) l, err := net.Listen(\"tcp\", s.addr) if err != nil { log.Println(\"listen err:\", err) return err } log.Println(\"listen: \", l.Addr()) s.listener = l // èµ·ä¸€ä¸ª goroutine å»ç­‰å¾…ä¿¡å·é‡æˆ– ctx çš„ç»“æŸ go func() { select { case \u003c-s.ctx.Done(): log.Println(\"kill by ctx\") return case sig := \u003c-sigChan: s.Stop() log.Printf(\"kill by signal:%s\", sig.String()) return } }() //é˜»å¡å¤„ç†è¿æ¥ s.handleListener() return nil } // Stop å¯ä»¥è¢« Start æ–¹æ³•è°ƒç”¨ä¹Ÿå¯ä»¥è¢« main çš„å…¶ä»–åç¨‹è°ƒç”¨ func (s *Server) Stop() { s.cancel() _ = s.listener.Close() } ","date":"2021-12-06","objectID":"/posts/redis-server-network/:6:1","tags":["redis","ç³»åˆ—ç¯‡","ç½‘ç»œ"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·æœåŠ¡ç®¡ç†ç¯‡","uri":"/posts/redis-server-network/"},{"categories":["Redis"],"content":"ä¸‹æ¸¸ handler çš„å¯åœ å¤„ç†è¿æ¥æ—¶ï¼Œç”±sync.WaitGroup æ§åˆ¶ goroutineï¼Œè¿™æ ·å¯ä»¥åœ¨æŸä¸ªè¿æ¥è¿˜æœªå¤„ç†å®Œæˆæ—¶ï¼Œå¯ä»¥ç»§ç»­é˜»å¡ï¼Œ ä»è€Œåšåˆ°æœåŠ¡å…³é—­æ—¶ç­‰å¾…æœªå¤„ç†çš„è¯·æ±‚ã€‚ func (s *Server) handleListener() { for { conn, err := s.listener.Accept() if err != nil { if errors.Is(err, net.ErrClosed) { log.Println(\"closed\") break } log.Println(\"accept err:\", err) continue } log.Println(\"new conn from:\", conn.RemoteAddr().String()) s.wg.Add(1) go s.handleConn(conn) } // wait for unDone connections s.wg.Wait() } åœ¨å¤„ç†è¿æ¥ä¸Šçš„è¯·æ±‚æ—¶ï¼Œé€šè¿‡ for å¾ªç¯ä¸€ç›´è¯»å–è¿æ¥ä¸Šçš„å†…å®¹ï¼Œå¦‚æœå®¢æˆ·ç«¯æ²¡æœ‰å†™å…¥æ¶ˆæ¯åˆ™ä¼šé˜»å¡ï¼Œå¦‚ä½•å®¢æˆ·ç«¯ä¸»åŠ¨å…³é—­è¿æ¥åˆ™ä¼šè¯»å– EOF é”™è¯¯ã€‚æ²¡å¤„ç†å®Œä¸€æ¬¡è¯·æ±‚å…ˆåˆ¤æ–­æœåŠ¡æ˜¯å¦å·²å…³é—­ï¼Œå› ä¸ºä¸Šæ¬¡å¾ˆæœ‰å¯èƒ½å·²ç»å…³é—­ä¸”åœæ­¢ç›‘å¬ç«¯å£ï¼Œç­‰å¾…ä¸‹æ¸¸å‰©ä¸‹è¯·æ±‚å¤„ç†å®Œæˆã€‚ // handle by a new goroutine func (s *Server) handleConn(conn net.Conn) { reader := bufio.NewReader(conn) // ReceiveDataAsync è¿”å›ä¸€ä¸ªç»“æ„ä½“åŒ…å«ä¸¤ä¸ª channelï¼Œå®é™…è¯»å–æ•°æ®æ˜¯å¼‚æ­¥çš„ ar := protocol.ReceiveDataAsync(reader) loop: for { select { // ctx // å¤„ç†å®Œä¸Šä¸€ä¸ªè¯·æ±‚å å¦‚æœ ctx å·²ç»è¢« cancel äº† åˆ™é€€å‡ºå¾ªç¯ç»“æŸè¿™ä¸ª connection case \u003c-s.ctx.Done(): break loop case \u003c-ar.ErrorChan: log.Println(\"handle err:\", err) break loop case rec := \u003c-ar.ReceiveChan: rsp := handleRequest(rec) reply := rsp.Encode() if len(reply) == 0 { continue } _, err := conn.Write(reply) if err != nil { log.Println(\"write err:\", err) break loop } } } _ = conn.Close() s.wg.Done() } func ReceiveDataAsync(r Reader) *AsyncReceive { var ar = \u0026AsyncReceive{ ReceiveChan: make(chan Receive, 1), ErrorChan: make(chan error, 1), } go func() { defer func() { close(ar.ReceiveChan) close(ar.ErrorChan) }() for { rec, err := DecodeFromReader(r) if err != nil { ar.ErrorChan \u003c- err if errors.Is(err, io.EOF) || errors.Is(err, net.ErrClosed) { return } log.Println(err) continue } ar.ReceiveChan \u003c- rec } }() return ar } æ€»ç»“ åˆ°è¿™é‡Œæœ¬ç¯‡å†…å®¹ç»“æŸäº†ï¼Œæ€»ç»“ä¸€ä¸‹è®²è¿°çš„å†…å®¹ï¼š ä½œä¸ºä¸€ä¸ª server ç«¯ï¼Œåœ¨å®šä¹‰å’Œæä¾›æœåŠ¡æ—¶éœ€è¦æ³¨æ„å“ªäº›æ–¹é¢ï¼Ÿ åœ¨å¤„ç†è¿æ¥å’Œè¯·æ±‚æ—¶éœ€è¦æ³¨æ„å“ªäº›é—®é¢˜ï¼Ÿ å¦‚ä½•ç®¡ç†ä¸€ä¸ªæœåŠ¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œå¦‚ä»ä»ä¸Šåˆ°ä¸‹éƒ½èƒ½ç¡®ä¿ç»Ÿä¸€çš„å¯åœï¼Œç›¸äº’ä½œç”¨å½¼æ­¤æ„ŸçŸ¥ï¼Ÿ é¡¹ç›®åœ°å€ â¤ï¸ https://github.com/yusank/godis ","date":"2021-12-06","objectID":"/posts/redis-server-network/:6:2","tags":["redis","ç³»åˆ—ç¯‡","ç½‘ç»œ"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·æœåŠ¡ç®¡ç†ç¯‡","uri":"/posts/redis-server-network/"},{"categories":["Markdown"],"content":" è¿™é‡Œæˆ‘ä¼šè®°å½•ä¸€äº› Markdown å’Œ Shortcut çš„ä½¿ç”¨æŠ€å·§ä»¥åŠå¸¸ç”¨çš„æ¨¡å—ï¼Œæ–¹ä¾¿åæœŸå†™æ–‡ç« æ—¶æŸ¥çœ‹å’Œä½¿ç”¨ã€‚ ","date":"2021-11-23","objectID":"/posts/blog_example/:0:0","tags":["æŠ€å·§"],"title":"å¥½ç”¨ä¸”å®ç”¨çš„å†™æ–‡ç« æŠ€å·§","uri":"/posts/blog_example/"},{"categories":["Markdown"],"content":"shortcuts ","date":"2021-11-23","objectID":"/posts/blog_example/:1:0","tags":["æŠ€å·§"],"title":"å¥½ç”¨ä¸”å®ç”¨çš„å†™æ–‡ç« æŠ€å·§","uri":"/posts/blog_example/"},{"categories":["Markdown"],"content":"admonition Note This is Note . Abstract This is Abstract . Info This is Info . Tip This is Tip . Success This is Success . Question This is Question . Warning This is Warning . Failure This is Failure . Danger This is Danger . Bug This is Bug . Example This is Example . Quote This is Quete . ","date":"2021-11-23","objectID":"/posts/blog_example/:1:1","tags":["æŠ€å·§"],"title":"å¥½ç”¨ä¸”å®ç”¨çš„å†™æ–‡ç« æŠ€å·§","uri":"/posts/blog_example/"},{"categories":["Markdown"],"content":"typeit markdown code Bug è¿™å—ç›®å‰å‘ç°æ˜¯æœ‰ bug çš„ï¼Œä¸ä¼šæ¢è¡Œï¼Œæ‰€ä»¥æš‚æ—¶ä¸å¯ç”¨ã€‚ graph ","date":"2021-11-23","objectID":"/posts/blog_example/:1:2","tags":["æŠ€å·§"],"title":"å¥½ç”¨ä¸”å®ç”¨çš„å†™æ–‡ç« æŠ€å·§","uri":"/posts/blog_example/"},{"categories":["Redis"],"content":" è¯´æ˜ æœ¬æ–‡ç« ä¸ºè¯¥ç³»åˆ—çš„åè®®ç¯‡ï¼Œå¦‚æœéœ€è¦é˜…è¯»å…¶ä»–ç›¸å…³æ–‡ç« ï¼Œ è¯·ç‚¹å‡»è¿™é‡Œè·³è½¬æŸ¥çœ‹ ","date":"2021-11-23","objectID":"/posts/redis-server-protocol/:0:0","tags":["redis","ç³»åˆ—ç¯‡"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·åè®®ç¯‡","uri":"/posts/redis-server-protocol/"},{"categories":["Redis"],"content":"å‰è¨€ Redis ä½œä¸ºä¸€ä¸ªå½“ä¸‹æœ€æµè¡Œçš„ NoSQL æˆ– KV æ•°æ®åº“ï¼Œå‡ ä¹åµŒå…¥åˆ°å¤§éƒ¨å¯¹æ€§èƒ½ã€æ—¶æ•ˆæ€§é«˜çš„é¡¹ç›®å†…ï¼Œå˜æˆäº†æ¯ä¸ªç¨‹åºå‘˜å°¤å…¶æ˜¯åç«¯ç¨‹åºå¿…éœ€äº†è§£çš„ä¸€ä¸ªçŸ¥è¯†ç‚¹ã€‚ æˆ‘æ˜¯æ— å½¢åœ¨ GitHub ä¸Šå‘ç°ä¸€ä¸ª Godis é¡¹ç›®ï¼Œæ˜¯å®ç°äº†å¤§éƒ¨åˆ† Redis æœåŠ¡å™¨çš„åŠŸèƒ½ã€‚ ç„¶åç¬é—´æ¿€å‘äº†æˆ‘çš„å…´è¶£ï¼Œæ—¢ç„¶ç”¨äº† Redis è¿™äº›å¹´äº†è€Œä¸”å¯¹æ ¸å¿ƒé€»è¾‘å’Œæ•°æ®ç»“æ„ä¹Ÿæ˜¯æœ‰æ‰€äº†è§£çš„ï¼Œé‚£æˆ‘ä¸ºä»€ä¹ˆä¸ä¹Ÿå†™ä¸€ä¸ªåŸºäº Go çš„ Redis æœåŠ¡å™¨ä»£ç ï¼Œå®ç°æˆ‘èƒ½å®ç°çš„æ ¸å¿ƒåŠŸèƒ½é€»è¾‘ã€‚ç›®çš„æ— å¤–ä¹ä»¥ä¸‹å‡ ç‚¹ï¼š æ›´å…¨é¢ä¸”ç³»ç»Ÿçš„äº†è§£Redis æ ¸å¿ƒé€»è¾‘å¹¶æŠŠè‡ªå·±çš„äº†è§£é€šè¿‡ä»£ç è¾“å‡ºå‡ºæ¥ æé«˜è‡ªå·±çš„ä»£ç æ°´å¹³ æé«˜è‡ªå·±çš„ç®—æ³•æ°´å¹³ï¼ˆæ¶‰åŠåˆ°å®ç° Redis æ ¸å¿ƒäº”å¤§æ•°æ®ç»“æ„ï¼‰ æ‰€ä»¥æˆ‘ä¹Ÿèµ·äº†ä¸€ä¸ªé¡¹ç›®å« Godis,ä¸€æ­¥æ­¥å°† Redis çš„é€»è¾‘é€šè¿‡Go ä»£ç å†™å‡ºæ¥ï¼Œå¹¶ä¸”åœ¨æ€§èƒ½ä¸Šå°½å¯èƒ½çš„è¿½èµ¶ Redis çš„æ€§èƒ½ã€‚ å‰æœŸæˆ‘æ›´ä¸“æ³¨äºæœ€æ ¸å¿ƒçš„ è¯·æ±‚å¤„ç†, åè®®å¤„ç†, æ•°æ®ç»“æ„å¤„ç†, å‘½ä»¤å¤„ç† ç­‰è¿™äº›åŸºç¡€æ ¸å¿ƒçš„æ¨¡å—ä¸€ä¸ªä¸ªæ”»ç ´ï¼Œè‡³äºæ•°æ®æŒä¹…åŒ–ï¼Œåˆ†å¸ƒå¼éƒ¨ç½²ï¼Œä¸»ä»æ¨¡å¼ç­‰è¿™äº›é«˜çº§ç‰¹æ€§ï¼Œæˆ‘åœ¨ç¡®ä¿ä¹‹å‰çš„åŠŸèƒ½éƒ½è¾¾åˆ°é¢„æœŸåå†è€ƒè™‘ï¼Œç›®å‰è®¡åˆ’æ˜¯æ•°æ®æŒä¹…åŒ–å¯èƒ½ä¼˜å…ˆè€ƒè™‘ã€‚ ","date":"2021-11-23","objectID":"/posts/redis-server-protocol/:1:0","tags":["redis","ç³»åˆ—ç¯‡"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·åè®®ç¯‡","uri":"/posts/redis-server-protocol/"},{"categories":["Redis"],"content":"åè®® æƒ³å®ç° Redis æœåŠ¡å™¨é¦–å…ˆæƒ³åˆ°çš„é—®é¢˜æ˜¯ï¼Œå¦‚ä½•é€šä¿¡ï¼Ÿå…¶å®éƒ½çŸ¥é“æ˜¯ tcp è¿æ¥ï¼Œæ‰€ä»¥æ›´å‡†ç¡®çš„é—®é¢˜æ˜¯ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ç”¨çš„ä»€ä¹ˆåè®®å»ä¼ è¾“æ•°æ®ï¼Ÿç­”æ¡ˆæ˜¯ RESP (REdis Serialization Protocolï¼‰ã€‚ è¯¥åè®®ä»å†…å®¹æ¥è¯´è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œå¯¹äºæœåŠ¡ç«¯å»è§£æä¹Ÿæ˜¯ç›¸å¯¹å‹å¥½ä¸”æ¶ˆè€—æ€§èƒ½å¾ˆä½ã€‚å®˜æ–¹ç»™å‡ºçš„ä¼˜ç‚¹ä¸ºä»¥ä¸‹ä¸‰ç‚¹ï¼š å®¹æ˜“å®ç° è§£æå¿« å¯è¯»æ€§é«˜ RESP åè®®ä¸ºä¸€ä¸ª request-response æ¨¡å‹çš„åè®®ï¼Œå®¢æˆ·ç«¯å‘å‡ºè¯·æ±‚å¹¶ç­‰å¾…æœåŠ¡å™¨å“åº”ï¼ŒæœåŠ¡å™¨æŒ‰åŒæ ·çš„åè®®è¿”å›æ•°æ®ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹åè®®å…·ä½“å†…å®¹ã€‚ ","date":"2021-11-23","objectID":"/posts/redis-server-protocol/:2:0","tags":["redis","ç³»åˆ—ç¯‡"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·åè®®ç¯‡","uri":"/posts/redis-server-protocol/"},{"categories":["Redis"],"content":"åŸºç¡€è¯´æ˜ åœ¨ RESP åè®®ä¸­ï¼Œæ‰€æœ‰çš„æ•°æ®çš„ç¬¬ä¸€å­—ç¬¦éƒ½æ˜¯ä»¥ä¸‹äº”ç§ç±»å‹ä¹‹ä¸€ï¼š + : ç®€å•å­—ç¬¦ä¸². - : é”™è¯¯. : : æ•´æ•°. $ : å¤æ‚å­—ç¬¦ä¸²æˆ–å¤§å—å­—ç¬¦ä¸²(bulk string). * : æ•°ç»„. æ•°æ®ç»“å°¾ ä»»ä½•ä¸€ä¸ªç±»å‹çš„æ•°æ®éƒ½æ˜¯ä»¥ \"\\r\\n\"(CRLF)ä½œä¸ºç»“æŸç¬¦. æœ¬æ–‡ä¸­çš„å¤§éƒ¨åˆ†ç¤ºä¾‹å‡æ¥è‡ªå®˜æ–¹æ–‡æ¡£ã€‚ ","date":"2021-11-23","objectID":"/posts/redis-server-protocol/:3:0","tags":["redis","ç³»åˆ—ç¯‡"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·åè®®ç¯‡","uri":"/posts/redis-server-protocol/"},{"categories":["Redis"],"content":"ç®€å•å­—ç¬¦ä¸²(Simple Strings) ç®€å•å­—ç¬¦ä¸²ä»¥ + ç¬¦å·å¼€å§‹ï¼Œç„¶åå­—ç¬¦å†…å®¹ï¼ˆä¸èƒ½åŒ…å« CR æˆ– LFï¼Œå³ä¸èƒ½æœ‰æ¢è¡Œç¬¦ï¼‰ï¼Œä»¥ CRLF(\"\\r\\n\") ç»“å°¾ã€‚ç®€å•å­—ç¬¦ä¸é€‚åˆä¼ è¾“æ•°æ®(non binary safa)ï¼Œåœ¨ Redis å†…åŸºæœ¬ç”¨äºå“åº” \"OK\" æˆ–æˆåŠŸæ ‡è¯†ã€‚ ç®€å•å­—ç¬¦ä¸² â€œ+OK\\r\\nâ€ ä¸ºäº†å®‰å…¨èµ·è§ï¼ŒRedis å†…ä¼ è¾“æ•°æ®ä¼šç”¨ Bulk Strings . ","date":"2021-11-23","objectID":"/posts/redis-server-protocol/:4:0","tags":["redis","ç³»åˆ—ç¯‡"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·åè®®ç¯‡","uri":"/posts/redis-server-protocol/"},{"categories":["Redis"],"content":"é”™è¯¯(Errors) RESP é¢„ç•™ä¸“é—¨çš„é”™è¯¯ç±»å‹ã€‚å…¶å®é”™è¯¯ç±»å‹ä¸ç®€å•å­—ç¬¦ä¸²å‡ ä¹æ²¡åŒºåˆ«ï¼Œåªæ˜¯ç¬¬ä¸€ä¸ªå­—ç¬¦æ˜¯ -, é™¤æ­¤ä¹‹å¤–åœ¨å¤„ç†å’Œç¼–ç è¿‡ç¨‹å‡æ— åŒºåˆ«ï¼Œæ›´å¤šçš„åŒºåˆ«åœ¨äºå®¢æˆ·ç«¯å¤„ç†ä¸Šã€‚ Errors â€œ-Error Message\\r\\nâ€ Errors ç±»å‹åªç”¨äºåœ¨å¤„ç†è¯·æ±‚é‡åˆ°é”™è¯¯æ—¶ï¼Œå“åº”åˆ°å®¢æˆ·ç«¯ï¼Œæ¯”å¦‚å‘½ä»¤ä¸å­˜åœ¨æˆ–å‘½ä»¤ä¸ key çš„ç±»å‹ä¸ç¬¦åˆç­‰ã€‚å®¢æˆ·ç«¯åº”è¯¥é’ˆå¯¹é”™è¯¯åšä¸€å±‚å¤„ç†ï¼Œæ–¹ä¾¿ä½¿ç”¨è€…æ„ŸçŸ¥åˆ°é”™è¯¯ã€‚ å¦ä¸€ä¸ª Errors çš„ä¾‹å­ -ERR unknown command â€˜foobarâ€™ -WRONGTYPE Operation against a key holding the wrong kind of value ä» - åˆ°ç¬¬ä¸€ä¸ªç©ºæ ¼æˆ–æ–°ä¸€è¡Œçš„å•è¯ä»£è¡¨è¿”å›çš„é”™è¯¯çš„ç±»å‹ã€‚è¿™ä¸ªæ˜¯ Redis çš„ä¸€ä¸ªå“åº”ä¹ æƒ¯(convention)ï¼Œå°†é”™è¯¯åˆ†ç±»å‹ï¼Œæ–¹ä¾¿å®¢æˆ·ç«¯æ›´çµæ´»çš„å¤„ç†ã€‚ ä»¥ä¸Šé¢çš„ä¾‹å­ä¸ºä¾‹ï¼Œ ERR æ˜¯ä¸€ä¸ªé€šç”¨çš„é”™è¯¯ï¼Œè€Œ WRONGTYPE æ˜¯ä¸€ä¸ªå…·ä½“çš„é”™è¯¯ç±»å‹ï¼Œä»£è¡¨å‘½ä»¤å’Œ key çš„ç±»å‹ä¸åŒ¹é…,è¿™ä¸ªå«é”™è¯¯å‰ç¼€Error Prefixã€‚ç«™åœ¨å®¢æˆ·ç«¯è§’åº¦æ¥è¯´ï¼Œç›¸å¯¹äºä¸€ä¸²é”™è¯¯å­—ç¬¦ä¸²ï¼Œæ‹¿åˆ°ä¸€ä¸ªå…·ä½“çš„é”™è¯¯ç±»å‹æ— å¼‚äºæ‹¿åˆ°ä¸€ä¸ª error code ä¸€æ ·ï¼Œå¯ä»¥åšä¸€ä¸ªå…·ä½“çš„æ“ä½œæ¥æ¶ˆåŒ–è¿™ä¸ªé”™è¯¯ã€‚ å½“ç„¶å¦‚æœåˆ†çš„é”™è¯¯ç±»å‹å¾ˆç»† é‚£å®¢æˆ·ç«¯å°±å¾—å†™çš„æ›´å¤æ‚åè€Œå¯èƒ½ä¼šå¯¼è‡´å¾—ä¸å¿å¤±ï¼ŒæŠ›å¼€ Redis çš„ä¹ æƒ¯ä»åè®®çš„è§’åº¦æ¥è¯´ï¼Œå¯ä»¥åœ¨éå¸¸ç®€å•çš„è¿”å›ä¸€ä¸ª false æ¥è¯´æ˜ä¸€ä¸ªé”™è¯¯æˆ–è€…å°±ä¸€è¡Œé”™è¯¯å†…å®¹ï¼Œè¿”å›ç»™ç”¨æˆ·ï¼Œè¿™ä¸ªæ›´å¤šçš„å–å†³äºå®¢æˆ·ç«¯å®ç°çš„æ—¶å€™çš„å–èˆã€‚ ","date":"2021-11-23","objectID":"/posts/redis-server-protocol/:5:0","tags":["redis","ç³»åˆ—ç¯‡"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·åè®®ç¯‡","uri":"/posts/redis-server-protocol/"},{"categories":["Redis"],"content":"æ•´æ•°(Integers) è¯¥ç±»å‹ä¸ä¸Šè¿°ä¸¤ä¸ªç±»å‹ä¹Ÿæ²¡æœ‰å¾ˆå¤§çš„åŒºåˆ«ï¼Œæ˜¯ä¸ºäº†ä¸“é—¨ä¼ è¾“æ•´æ•°è€Œå®šçš„ï¼Œä»¥: å­—ç¬¦ä¸ºå¼€å¤´ï¼Œå†…å®¹ä¸ºæ•´æ•°ä¸”ä»¥\\r\\n ç»“å°¾ï¼Œå¦‚ \":100\\r\\n\" ã€‚ æ•°å­—èŒƒå›´ æœ‰ç¬¦å· 64 ä½æ•´æ•° Redis ä¸­åƒ INCR, LLEN å’Œ LASTSAVE ç­‰å‘½ä»¤éƒ½è¿”å›æ•´æ•°ã€‚å½“ç„¶è¿”å›æ•´æ•°æ²¡æœ‰åˆ«çš„æ„ä¹‰ï¼Œåªæ˜¯è¿™äº›å‘½ä»¤çš„ç»“æœæ˜¯æ•°å­—ã€‚ é™¤äº†å‘½ä»¤ç»“æœæ˜¯æ•´æ•°æ—¶è¿”å› Integer ç±»å‹å¤–ï¼Œä¸€äº›å‘½ä»¤ç”¨æ•´æ•° 0 or 1 æ¥è¡¨ç¤º true or false,å¦‚ EXISTS, SISMEMBERã€‚ è¿˜æœ‰ä¸€äº›å‘½ä»¤æ˜¯è¿”å› 1 è¡¨ç¤ºæ“ä½œçœŸæ­£æ‰§è¡Œ(è¿™ä¹ˆè¯´æ˜¯å› ä¸ºï¼Œä¸€äº›æ“ä½œå› ä¸ºæ•°æ®å·²å­˜åœ¨æˆ–å·²è¢«æ“ä½œæ‰€ä»¥ä¸ä¼šå†æ¬¡æ“ä½œæ•°æ®è€Œç›´æ¥è¿”å›),å¦åˆ™è¿”å› 0 ï¼Œåƒ SADD, SREM, SETNX ç­‰ã€‚ ","date":"2021-11-23","objectID":"/posts/redis-server-protocol/:6:0","tags":["redis","ç³»åˆ—ç¯‡"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·åè®®ç¯‡","uri":"/posts/redis-server-protocol/"},{"categories":["Redis"],"content":"å¤æ‚å­—ç¬¦ä¸²(Bulk Strings) å¤æ‚å­—ç¬¦ä¸²ä¸º RESP ä¸­äºŒè¿›åˆ¶å®‰å…¨çš„å­—ç¬¦ä¸²ç±»å‹ï¼Œæœ€å¤§å®¹é‡ä¸º 512MBã€‚bulk string ç¼–ç æ–¹å¼å¦‚ä¸‹ï¼š ä»¥ $ä¸ºå¼€å¤´å†™å…¥å®é™…å­—ç¬¦ä¸²é•¿åº¦å¹¶ä»¥ CRLF ç»“å°¾ å®é™…å­—ç¬¦ä¸² CRLF ç»“æŸ ä»¥ Hello ä¸ºä¾‹ â€œ$5\\r\\nHello\\r\\nâ€ ç©ºå­—ç¬¦ â€œ$0\\r\\n\\r\\nâ€ å‰é¢è¯´åˆ°ç®€å•å­—ç¬¦ä¸² ä¸èƒ½åŒ…å¥½æ¢è¡Œç¬¦ï¼Œç„¶è€Œ Bulk Stringæ˜¯å…è®¸åŒ…å«è¿™ç±»ç‰¹æ®Šå­—ç¬¦çš„ï¼Œå› ä¸ºè¯»å– Bulk String æ˜¯æ ¹æ®å…¶å®šä¹‰çš„é•¿åº¦æ¥è¯»å–çš„ï¼Œè€Œä¸æ˜¯æ ¹æ®æ¢è¡Œç¬¦ã€‚ åŒ…å«æ¢è¡Œç¬¦çš„ä¾‹å­ â€œ$4\\r\\nOK\\r\\n\\r\\nâ€ è¿™æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„å¤æ‚å­—ç¬¦ä¸²å…¶å†…å®¹æ˜¯ OK\\r\\nåŒ…å«å››ä¸ªå­—ç¬¦ã€‚ æ³¨æ„ï¼š$4\\r\\nOK\\r\\n\\r\\n, ä¸‹åˆ’çº¿æ‰æ˜¯å­—ç¬¦ä¸²å†…å®¹ Bulk String æ”¯æŒ Null å€¼ï¼ˆæ³¨æ„ä¸æ˜¯ç©ºå­—ç¬¦ï¼‰ä»¥æ­¤æ¥åŒºåˆ†æ•°æ®ä¸å­˜åœ¨çš„æƒ…å†µã€‚Null çš„æƒ…å†µä¸‹ä¸å­˜åœ¨æ•°æ®ï¼Œæ‰€ä»¥é•¿åº¦ä¸º-1ï¼ˆ-1 æ˜¯åè®®å®šçš„ï¼Œå…·ä½“ä¸ºä»€ä¹ˆæ˜¯-1 I hava no idea .), æ²¡æœ‰æ•°æ®éƒ¨åˆ†ä¹Ÿæ²¡æœ‰æ•°æ®æœ€åçš„ CRLFï¼ˆç©ºå­—ç¬¦æ˜¯æœ‰çš„ï¼Œè¿™ä¸ªéœ€è¦æ³¨æ„çš„ï¼‰ Null å“åº” â€œ$-1\\r\\nâ€ å®˜æ–¹åŸæ–‡ï¼š This is called a Null Bulk String. ","date":"2021-11-23","objectID":"/posts/redis-server-protocol/:7:0","tags":["redis","ç³»åˆ—ç¯‡"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·åè®®ç¯‡","uri":"/posts/redis-server-protocol/"},{"categories":["Redis"],"content":"æ•°ç»„(Arrays) å®¢æˆ·ç«¯çš„æ‰€æœ‰è¯·æ±‚éƒ½æ˜¯ä»¥æ•°ç»„çš„æ–¹å¼ä¼ åˆ°æœåŠ¡ç«¯çš„ï¼Œè€ŒæœåŠ¡ç«¯çš„å“åº”å¦‚æœæ˜¯å¤šä¸ªå€¼ä¹Ÿéƒ½æ˜¯ä»¥æ•°ç»„çš„æ–¹å¼å“åº”ã€‚æ¯”å¦‚ ZRANGE, LRANGE, MGET ç­‰ã€‚ æ•°ç»„(Arrays) æ˜¯ä»¥ä¸‹æ–¹å¼ç¼–ç çš„ï¼š ä»¥ * ä½œä¸ºç¬¬ä¸€ä¸ªå­—ç¬¦ï¼Œç„¶åå†™å…¥æ•°ç»„çš„é•¿åº¦ï¼Œæœ€åä»¥ CRLF ç»“å°¾. ä¸€ç»„ RESP ç±»å‹çš„æ•°æ®ä½œä¸ºæ•°ç»„çš„å…ƒç´ . ç©ºæ•°ç»„ â€œ*0\\r\\nâ€ åŒ…å« foo å’Œ bar ä¸¤ä¸ª bulk string ä½œä¸ºå…ƒç´ çš„æ•°ç»„ â€œ*2\\r\\n$3\\r\\nfoo\\r\\n$3\\r\\nbar\\r\\nâ€ ä¸ºäº†é˜…è¯»æ–¹ä¾¿åŠ ä¸Šæ¢è¡Œç¬¦ï¼š *2\\r\\n $3\\r\\n foo\\r\\n $3\\r\\n bar\\r\\n ä¸éš¾å‘ç°ï¼Œæ•°ç»„åªéœ€è¦å£°æ˜é•¿åº¦å³å¯ï¼Œåé¢æ‹¼æ¥å…ƒç´ å°±å¯ä»¥ï¼Œå…ƒç´ ä¹‹å‰æ— éœ€æœ‰ä»»ä½•åˆ†éš”ç¬¦ï¼Œå…ƒç´ å¯ä»¥æ˜¯ç®€å•å­—ç¬¦ä¸², Errors, æ•´å‹,å¤æ‚å­—ç¬¦ä¸²ã€‚ä¸‹é¢ä¾‹å­æ›´æ˜æ˜¾ä½“ç°å¦‚ä½•ä½¿ç”¨åŒ…å«ä¸ç”¨å…ƒç´ çš„æ•°ç»„ï¼š æ··åˆå…ƒç´ ä¾‹å­ *5\\r\\n :1\\r\\n :2\\r\\n +SimpleString\\r\\n -Err Message\\r\\n $6\\r\\n foobar\\r\\n ","date":"2021-11-23","objectID":"/posts/redis-server-protocol/:8:0","tags":["redis","ç³»åˆ—ç¯‡"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·åè®®ç¯‡","uri":"/posts/redis-server-protocol/"},{"categories":["Redis"],"content":"Nullæ•°ç»„ ä¸å¤æ‚å­—ç¬¦ä¸²ä¸€æ ·ï¼Œæ•°ç»„ä¹Ÿæ”¯æŒè¡¨ç¤º Null å€¼ï¼Œåœ¨ BLPOP å‘½ä»¤ä¸­ï¼Œå¦‚æœæ“ä½œè¶…æ—¶ï¼Œåˆ™è¿”å›ä¸€ä¸ª Null æ•°ç»„è¡¨ç¤ºç»“æœï¼š Null Array â€œ*-1\\r\\nâ€ å®ç°å®¢æˆ·ç«¯æ—¶ï¼Œåº”è¯¥è€ƒè™‘å¹¶åŒºåˆ†å¼€ç©ºæ•°ç»„å’Œ Null æ•°ç»„ï¼ˆå¦‚æ— æ•°æ®æˆ–æ“ä½œè¶…æ—¶ï¼‰åº”è¯¥æœ‰ä¸åŒçš„å¤„ç†æ–¹å¼ã€‚ ","date":"2021-11-23","objectID":"/posts/redis-server-protocol/:8:1","tags":["redis","ç³»åˆ—ç¯‡"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·åè®®ç¯‡","uri":"/posts/redis-server-protocol/"},{"categories":["Redis"],"content":"åµŒå¥— æ•°ç»„æ˜¯æ”¯æŒå…¶å…ƒç´ ä¹Ÿæ˜¯æ•°ç»„çš„ï¼Œå¦‚ä¸‹é¢æ˜¯ä¸€ä¸ªåŒ…å«ä¸¤ä¸ªæ•°ç»„ä½œä¸ºå…ƒç´ çš„æ•°ç»„ï¼š åµŒå¥—æ•°ç»„ *2\\r\\n *3\\r\\n :1\\r\\n :2\\r\\n :3\\r\\n *2\\r\\n +Foo\\r\\n -Bar\\r\\n æŠŠ RESP åè®®è½¬æ¢æˆå¯è¯»æ€§æ›´é«˜çš„æ•°æ®åï¼š è§£ç å [[1, 2, 3], [\"Foo\", Error(\"Bar\")]] ","date":"2021-11-23","objectID":"/posts/redis-server-protocol/:8:2","tags":["redis","ç³»åˆ—ç¯‡"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·åè®®ç¯‡","uri":"/posts/redis-server-protocol/"},{"categories":["Redis"],"content":"åŒ…å« Null å…ƒç´ çš„æ•°ç»„ åœ¨ä¸ Redis äº¤äº’æ—¶, ä¸€éƒ¨åˆ†å‘½ä»¤æ˜¯æ“ä½œå¤šä¸ª keyï¼Œè¿”å›å¤šä¸ªå€¼çš„ï¼Œè¿™ä¸ªæ—¶å€™å°±æœ‰ä¸ªé—®é¢˜ï¼Œå…¶ä¸­ä¸€äº›æ“ä½œä¸æˆåŠŸæˆ–æ•°æ®ä¸å­˜åœ¨ï¼Œ è¯¥ä¸è¯¥å½±å“è¿™æ¬¡è¯·æ±‚çš„æ•´ä½“ç»“æœå‘¢ï¼Ÿ ä»¥ MGET è¿™ä¸ªå‘½ä»¤ä¸ºä¾‹ï¼Œå¦‚æœè·å–å¤šä¸ª key çš„å€¼ï¼Œè€Œå…¶ä¸­æœ‰ä¸€éƒ¨åˆ† key æ˜¯ä¸å­˜åœ¨æ—¶ï¼ŒRedis åœ¨å“åº”ä¸­ç•™ null å€¼ä»è€Œä¸å½±å“å…¶ä»– key çš„è¯»å–ï¼Œåè®®å¦‚ä¸‹ï¼š åŒ…å« Null å…ƒç´  *3\\r\\n $3\\r\\n foo\\r\\n $-1\\r\\n $3\\r\\n bar\\r\\n å®¢æˆ·ç«¯é’ˆå¯¹è¯¥å“åº”è§£æå‡ºæ¥çš„ç»“æœåº”è¯¥å¦‚ä¸‹ï¼š è§£ç å [\"foo\", nil, \"bar\"] ","date":"2021-11-23","objectID":"/posts/redis-server-protocol/:8:3","tags":["redis","ç³»åˆ—ç¯‡"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·åè®®ç¯‡","uri":"/posts/redis-server-protocol/"},{"categories":["Redis"],"content":"å®¢æˆ·ç«¯æœåŠ¡ç«¯äº¤äº’ åˆ°ç›®å‰ä¸ºæ­¢ï¼ŒRESP åè®®çš„å†…å®¹å…¨éƒ¨è¯´å®Œäº†ï¼Œå‘ç°å…¶å®è›®ç®€å•çš„ã€‚å…¶å®ç°åœ¨å»å®ç°ä¸€ä¸ªå®¢æˆ·ç«¯çš„ä»£ç æ¯”å®ç°æœåŠ¡ç«¯çš„ç®€å•å¾ˆå¤šï¼Œå› ä¸ºåªéœ€è¦ç¼–ç è§£ç åè®®å†…å®¹å³å¯ã€‚ æœåŠ¡ç«¯å’Œå®¢æˆ·å•äº¤äº’æœ€æ ¸å¿ƒå°±æ˜¯ä»¥ä¸‹ä¸¤ç‚¹ï¼š å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘èµ·è¯·æ±‚å‡ä¸ºä»¥ Bulk Strings ä½œä¸ºå…ƒç´ çš„æ•°ç»„. æœåŠ¡ç«¯å‘å®¢æˆ·ç«¯å“åº”ä»»æ„åˆæ³•çš„ RESP æ•°æ®ç±»å‹. ä»¥ LLEN mylist ä¸ºä¾‹ï¼š ä¸€æ¬¡äº¤äº’è¿‡ç¨‹ C: *2\\r\\n C: $4\\r\\n C: LLEN\\r\\n C: $6\\r\\n C: mylist\\r\\n S: :48293\\r\\n C: clientï¼Œ S:server ","date":"2021-11-23","objectID":"/posts/redis-server-protocol/:9:0","tags":["redis","ç³»åˆ—ç¯‡"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·åè®®ç¯‡","uri":"/posts/redis-server-protocol/"},{"categories":["Redis"],"content":"é«˜æ•ˆè§£æåè®® è¯¥åè®®å¯è¯»æ€§ç›¸å¯¹é«˜ï¼Œä¸æ­¤åŒæ—¶è§£ææ•ˆç‡ä¹Ÿå¾ˆé«˜ï¼Œä¸‹é¢ç»™å‡ºå¦‚ä½•è§£æè¯¥åè®®. import ( \"bytes\" \"log\" \"io\" ) func main() { var p = []byte(\"$5\\r\\nHello\\r\\n\") buf := bytes.NewBuffer(p) // read first line b, err := buf.ReadBytes('\\n') if err != nil { panic(err) } // read length ln := readBulkOrArrayLength(b) log.Println(\"string len: \",ln) // string len: 5 // read value value,err := readBulkStrings(buf, ln) if err != nil { panic(err) } log.Println(\"value: \", string(value)) // value: Hello } // è§£æé•¿åº¦ func readBulkOrArrayLength(line []byte) int { var ( ln int ) for i := 1; line[i] != '\\r'; i++ { ln = (ln * 10) + int(line[i]-'0') } return ln } // è¯»å–å†…å®¹ func readBulkStrings(r io.Reader, ln int) (val []byte, err error) { if ln \u003c= 0 { return } // è¯»å–æ—¶ å°† \\r\\n ä¹Ÿè¯»å‡ºæ¥ï¼Œä¿è¯ offset åœ¨æ–°çš„ä¸€è¡Œç¬¬ä¸€ä¸ªå­—ç¬¦ val = make([]byte, ln+2) _, err = r.Read(val) // trim last \\r\\n val = val[:ln] return } ","date":"2021-11-23","objectID":"/posts/redis-server-protocol/:10:0","tags":["redis","ç³»åˆ—ç¯‡"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·åè®®ç¯‡","uri":"/posts/redis-server-protocol/"},{"categories":["Redis"],"content":"å‚è€ƒæ–‡çŒ® https://redis.io/topics/protocol ","date":"2021-11-23","objectID":"/posts/redis-server-protocol/:11:0","tags":["redis","ç³»åˆ—ç¯‡"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·åè®®ç¯‡","uri":"/posts/redis-server-protocol/"},{"categories":["Redis"],"content":" æœ¬æ–‡ç³»åˆ—ç¯‡Redis Server å®ç°çš„å¼€ç¯‡æ–‡ç« ï¼Œå°†åˆ—å‡ºæœ¬ç³»åˆ—ç¯‡è®²è¿°çš„å†…å®¹å’Œå®ç°çš„åŠŸèƒ½åšç®€å•çš„æè¿°ã€‚ ","date":"2021-11-22","objectID":"/posts/redeis-server-introduction/:0:0","tags":["redis","ç³»åˆ—ç¯‡"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·å‰è¨€","uri":"/posts/redeis-server-introduction/"},{"categories":["Redis"],"content":"æ ¸å¿ƒå†…å®¹ ç³»åˆ—ç¯‡å°†ä¼šåˆ†æ­¥éª¤è®²è¿°å¦‚ä½•é€šè¿‡ Go è¯­è¨€å®ç°ä¸€ä¸ª Redis Server å¹¶èƒ½è¾¾åˆ°å¯ä½¿ç”¨çš„åœ°æ­¥çš„è¿‡ç¨‹ï¼Œåˆ°ç›®å‰ä¸ºæ­¢çš„æƒ³æ³•æ˜¯åˆ† ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤å®ç°å¹¶å†™å‡ºå¯¹åº”çš„æ€»ç»“æ–‡ç« ï¼š åè®®ç¯‡Â·Redis åè®®çš„ä»‹ç»å’Œå¦‚ä½•è§£æ ç½‘ç»œç¯‡Â·å¦‚ä½•æä¾›ä¸€ä¸ªé«˜æ€§èƒ½çš„ TCP æœåŠ¡ æ•°æ®ç»“æ„ç¯‡Â·å¦‚ä½•å®ç° Redis äº”å¤§æ•°æ®ç»“æ„ï¼ˆè¿™ä¸ªå¯èƒ½æ ¹æ®ç¯‡å¹…å¤§å°åˆ†å‡ ç¯‡æ–‡ç« ï¼‰ ä»£ç ç»“æ„ç¯‡Â·å¦‚ä½•å®ç°å’Œä¼˜åŒ–ä»è¯·æ±‚è¿›æ¥åˆ°æ•°æ®å¤„ç†å’Œå“åº”è¿‡ç¨‹ æµ‹è¯•ç¯‡Â·å¦‚ä½•åšä¸€ä¸ªæ€§èƒ½æµ‹è¯•å’Œæµ‹è¯•ç»“æœå¯¹æ¯” å®Œç»“ç¯‡Â·æ€»ç»“å¼€å‘å’Œè®¾è®¡è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜å’Œæ–°çš„ã€ é™¤ä»¥ä¸Šçš„è®¡åˆ’å†™çš„æ–‡ç« å¤– å¯èƒ½ä¼šå†™ä¸€äº›å¼€å‘è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ç»“æœè¿‡ç¨‹æˆ–ä¸€äº›å¿ƒå¾—ä¹Ÿä¼šä¸å®šæ—¶æ›´æ–° ","date":"2021-11-22","objectID":"/posts/redeis-server-introduction/:1:0","tags":["redis","ç³»åˆ—ç¯‡"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·å‰è¨€","uri":"/posts/redeis-server-introduction/"},{"categories":["Redis"],"content":"æ–‡ç« ä¼ é€é—¨ åè®®ç¯‡ æœåŠ¡ç®¡ç†ç¯‡ ç½‘ç»œç¯‡(ç½‘ç»œæ¨¡å‹ï¼Œæœªå‘å¸ƒ) æ•°æ®ç»“æ„Â·é“¾è¡¨ç¯‡ æ•°æ®ç»“æ„Â·è·³è¡¨ç¯‡ æ•°æ®ç»“æ„Â·å“ˆå¸Œè¡¨ç¯‡ é¡¹ç›®ç»éªŒæ€»ç»“ å¾…è¡¥å…… ","date":"2021-11-22","objectID":"/posts/redeis-server-introduction/:2:0","tags":["redis","ç³»åˆ—ç¯‡"],"title":"[ç³»åˆ—]Redis Server å®ç°Â·å‰è¨€","uri":"/posts/redeis-server-introduction/"},{"categories":["ç½‘å…³"],"content":" åˆ†äº«å¦‚ä½•åœ¨ docker ç¯å¢ƒéƒ¨ç½² apisix å’Œå¦‚ä½•å¼€å‘ lua å’Œ go è¯­è¨€çš„æ’ä»¶ä»¥åŠå¦‚ä½•ä½¿ç”¨è¿™äº›è‡ªå®šä¹‰æ’ä»¶çš„è¿‡ç¨‹ï¼Œå¸Œæœ›èƒ½å¸®åŠ©åˆ°ä½ ã€‚ ","date":"2021-11-03","objectID":"/posts/apisix_plugins/:0:0","tags":["lua","go","apisix"],"title":"apisix å¼€å‘è‡ªå®šä¹‰æ’ä»¶","uri":"/posts/apisix_plugins/"},{"categories":["ç½‘å…³"],"content":"å¦‚ä½•éƒ¨ç½² # 1. ä¸‹è½½å®˜æ–¹ docker compose é¡¹ç›® $ git clone https://github.com/apache/apisix-docker.git $ cd apisix-docker/example # 2. run docker compose $ docker-compose -p docker-apisix up -d # check docker ps $ docker ps CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 629eb9d85656 627d00c649fc \"sh -c '/usr/bin/apiâ€¦\" 24 seconds ago Up 20 seconds 0.0.0.0:9080-\u003e9080/tcp, :::9080-\u003e9080/tcp, 0.0.0.0:9091-9092-\u003e9091-9092/tcp, :::9091-9092-\u003e9091-9092/tcp, 0.0.0.0:9443-\u003e9443/tcp, :::9443-\u003e9443/tcp docker-apisix_apisix_1 c3cbca636e65 13afb861111c \"/run.sh\" 24 seconds ago Up 22 seconds 0.0.0.0:3000-\u003e3000/tcp, :::3000-\u003e3000/tcp docker-apisix_grafana_1 4a5cb9ad6239 5b0292a5e821 \"/usr/local/apisix-dâ€¦\" 24 seconds ago Up 22 seconds 0.0.0.0:9000-\u003e9000/tcp, :::9000-\u003e9000/tcp docker-apisix_apisix-dashboard_1 6430826c4095 8c7e00e786b8 \"/opt/bitnami/scriptâ€¦\" 24 seconds ago Up 21 seconds 0.0.0.0:2379-\u003e2379/tcp, :::2379-\u003e2379/tcp, 2380/tcp docker-apisix_etcd_1 c086d6e4fbd9 a618f5685492 \"/bin/prometheus --câ€¦\" 24 seconds ago Up 22 seconds 0.0.0.0:9090-\u003e9090/tcp, :::9090-\u003e9090/tcp docker-apisix_prometheus_1 1e6ea10c008f 7d0cdcc60a96 \"/docker-entrypoint.â€¦\" 24 seconds ago Up 21 seconds 0.0.0.0:9082-\u003e80/tcp, :::9082-\u003e80/tcp docker-apisix_web2_1 d4891bd0744e 7d0cdcc60a96 \"/docker-entrypoint.â€¦\" 24 seconds ago Up 22 seconds 0.0.0.0:9081-\u003e80/tcp, :::9081-\u003e80/tcp docker-apisix_web1_1 éƒ¨ç½²å®Œæˆï¼Œå¯ä»¥é€šè¿‡ localhost:9000 è®¿é—® dashboardã€‚ ","date":"2021-11-03","objectID":"/posts/apisix_plugins/:1:0","tags":["lua","go","apisix"],"title":"apisix å¼€å‘è‡ªå®šä¹‰æ’ä»¶","uri":"/posts/apisix_plugins/"},{"categories":["ç½‘å…³"],"content":"é…ç½® é»˜è®¤é…ç½®æ–‡ä»¶åœ¨ apisix-docker/example/apisix_conf ç›®å½•ä¸‹ã€‚ apisix: node_listen: 9080 # APISIX listening port enable_ipv6: false allow_admin: # http://nginx.org/en/docs/http/ngx_http_access_module.html#allow - 0.0.0.0/0 # We need to restrict ip access rules for security. 0.0.0.0/0 is for test. admin_key: - name: \"admin\" key: edd1c9f034335f136f87ad84b625c8f1 # è¿™ä¸ªå€¼éœ€è¦æ”¹çš„å¦åˆ™æœ‰å®‰å…¨éšæ‚£ role: admin # admin: manage all configuration data # viewer: only can view configuration data - name: \"viewer\" key: 4054f7cf07e344346cd3f287985e76a2 role: viewer enable_control: true control: ip: \"0.0.0.0\" port: 9092 etcd: host: # it's possible to define multiple etcd hosts addresses of the same etcd cluster. - \"http://etcd:2379\" # multiple etcd address prefix: \"/apisix\" # apisix configurations prefix timeout: 30 # 30 seconds plugin_attr: prometheus: export_addr: ip: \"0.0.0.0\" port: 9091 ","date":"2021-11-03","objectID":"/posts/apisix_plugins/:2:0","tags":["lua","go","apisix"],"title":"apisix å¼€å‘è‡ªå®šä¹‰æ’ä»¶","uri":"/posts/apisix_plugins/"},{"categories":["ç½‘å…³"],"content":"æ’ä»¶ ","date":"2021-11-03","objectID":"/posts/apisix_plugins/:3:0","tags":["lua","go","apisix"],"title":"apisix å¼€å‘è‡ªå®šä¹‰æ’ä»¶","uri":"/posts/apisix_plugins/"},{"categories":["ç½‘å…³"],"content":"lua å®˜æ–¹å¼€å‘æ•™ç¨‹ ç¤ºä¾‹æ’ä»¶ï¼š local ngx = ngx local core = require(\"apisix.core\") local plugin = require(\"apisix.plugin\") local upstream = require(\"apisix.upstream\") -- å®šä¹‰é…ç½®ï¼Œå³ä½¿ç”¨æ’ä»¶æ—¶ é…ç½®ä¸€äº›è‡ªå®šä¹‰å­—æ®µï¼Œå¦‚é‰´æƒçš„ keyï¼Œéœ€è¦æ ¡éªŒçš„ header ä¹‹ç±»çš„ local schema = { type = \"object\", properties = { value = {type = \"array\", minItems = 1} }, required = {\"value\"} } -- è¿™ä¸ªéœ€è¦äº†è§£ä¸€ä¸‹å¹²ä»€ä¹ˆçš„ local metadata_schema = { type = \"object\", properties = { ikey = {type = \"number\", minimum = 0}, skey = {type = \"string\"} }, required = {\"ikey\", \"skey\"} } local plugin_name = \"block_by_lua\" local _M = { version = 0.1, priority = 0, name = plugin_name, schema = schema, metadata_schema = metadata_schema } function _M.check_schema(conf, schema_type) if schema_type == core.schema.TYPE_METADATA then return core.schema.check(metadata_schema, conf) end return core.schema.check(schema, conf) end function _M.init() -- call this function when plugin is loaded core.log.info(plugin_name, \"loaded!\") end function _M.destroy() -- call this function when plugin is unloaded end -- uri é‡å†™é˜¶æ®µ å¦‚æœä¸éœ€è¦å°±ä¸ç”¨å®šä¹‰è¿™ä¸ªæ–¹æ³• --[[ function _M.rewrite(conf, ctx) core.log.warn(\"plugin rewrite phase, conf: \", core.json.encode(conf)) core.log.warn(\"conf_type: \", ctx.conf_type) core.log.warn(\"conf_id: \", ctx.conf_id) core.log.warn(\"conf_version: \", ctx.conf_version) end --]] --å‘½ä¸­æœåŠ¡ \u0026 è°ƒæœåŠ¡å‰ function _M.access(conf, ctx) core.log.warn(\"plugin access phase, conf: \", core.json.encode(conf)) core.log.warn(\"plugin access phase, ctx: \", core.json.encode(ctx, true)) -- return 200, {message = \"hit example plugin\"} -- 1. extract from header local pass = core.request.header(ctx, \"X-Block-Pass\") if not pass then core.response.set_header(\"X-Block-Flag\", \"Block By Lua Ext\") -- è¿”å› http çŠ¶æ€ç  åˆ™è¿™æ¬¡è¯·æ±‚æˆªæ­¢åˆ°å½“å‰æ’ä»¶ï¼Œä¸ä¼šå¾€ä¸‹èµ° return 403, {message = \"Missing pass value in header\"} end for _, val in pairs(conf.value) do if val == pass then -- return ç©ºè¡¨ç¤ºé€šè¿‡ return end end core.response.set_header(\"X-Block-Flag\", \"Block By Lua Ext\") return 403, {message = \"Invalid pass value in header.\"} end local function hello() local args = ngx.req.get_uri_args() if args[\"json\"] then return 200, {msg = \"world\"} else return 200, \"world\\n\" end end function _M.control_api() return { { -- æ³¨å†Œ controller api ç”¨äºæ¢æµ‹æ’ä»¶æ˜¯å¦æ’å…¥æˆåŠŸï¼Œä¹Ÿå¯ä»¥ç”¨äºå†…éƒ¨ä¸€äº›è¿”å› token ä¹‹ç±»çš„ç”¨å¤„ methods = {\"GET\"}, uris = {\"/v1/plugin/example-plugin/hello\"}, handler = hello } } end return _M å¦‚ä½•å®‰è£…ï¼š åˆ›å»ºç›®å½• â”œâ”€â”€ example â”‚ â””â”€â”€ apisix â”‚ â”œâ”€â”€ plugins â”‚ â”‚ â””â”€â”€ 3rd-party.lua â”‚ â””â”€â”€ stream â”‚ â””â”€â”€ plugins â”‚ â””â”€â”€ 3rd-party.lua é…ç½®æ–‡ä»¶(config.yaml)æ·»åŠ æ’ä»¶ç›®å½• apisix: ... extra_lua_path: \"/path/to/example/?.lua\" å¼€å¯æ’ä»¶(config.yaml) apisix: ... plugins: # ä» config-default.yaml æ–‡ä»¶å¤åˆ¶å‡ºæ¥ï¼Œç„¶ååŠ ä¸Šè‡ªå·±çš„æ’ä»¶ ... - your-plugin Q:å¦‚ä½•åœ¨dashboard çœ‹åˆ°è‡ªå·±çš„æ’ä»¶ï¼Ÿ A: ç›®å‰è‡ªå®šä¹‰æ’ä»¶ä¸æ”¯æŒè‡ªåŠ¨åŒæ­¥åˆ° dashboardï¼Œéœ€è¦æ‰‹åŠ¨æ·»åŠ ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š åœ¨ apisix æœºå™¨ä¸Šæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤è·å–æœ€æ–° json schemeï¼š $ curl 127.0.0.1:9092/v1/schema \u003e scheme.json 2. å°† `scheme.json` å¤åˆ¶åˆ° dashboard æœºå™¨ä¸Š `conf` ç›®å½•ä¸‹ä¸åŸæœ‰çš„æ–‡ä»¶æ›¿æ¢ï¼Œé‡å¯ dashboard æœåŠ¡ã€‚ ","date":"2021-11-03","objectID":"/posts/apisix_plugins/:3:1","tags":["lua","go","apisix"],"title":"apisix å¼€å‘è‡ªå®šä¹‰æ’ä»¶","uri":"/posts/apisix_plugins/"},{"categories":["ç½‘å…³"],"content":"go å®˜æ–¹å¼€å‘æ•™ç¨‹ ç¤ºä¾‹ä»£ç ï¼š package plugins import ( \"encoding/json\" \"net/http\" pkgHTTP \"github.com/apache/apisix-go-plugin-runner/pkg/http\" \"github.com/apache/apisix-go-plugin-runner/pkg/log\" \"github.com/apache/apisix-go-plugin-runner/pkg/plugin\" ) // åˆå§‹åŒ– func init() { // æ³¨å†Œæ’ä»¶ err := plugin.RegisterPlugin(\u0026BlockReq{}) if err != nil { log.Fatalf(\"failed to register plugin block-req: %s\", err) } } // LimitReq is a demo for a real world plugin type BlockReq struct { } // ä¸ lua æ’ä»¶å†… scheme ä¸€æ · type BlockReqConf struct { Key string `json:\"key\"` Value []string `json:\"value\"` } func (p *BlockReq) Name() string { return \"blcok-req\" } // ParseConf is called when the configuration is changed. And its output is unique per route. func (p *BlockReq) ParseConf(in []byte) (interface{}, error) { conf := BlockReqConf{} err := json.Unmarshal(in, \u0026conf) return conf, err } // Filter is called when a request hits the route func (p *BlockReq) Filter(conf interface{}, w http.ResponseWriter, r pkgHTTP.Request) { b := conf.(BlockReqConf) val := r.Header().Get(b.Key) for _, v := range b.Value { if val == v { r.Header().Set(\"X-Block-Value\", v) return } } // block request // åªè¦å†™ response çš„ header æˆ–bodyï¼Œè¯·æ±‚å°†åœåœ¨è¿™é‡Œä¸ä¼šå¾€ä¸‹ä¼ é€’ï¼Œç›´æ¥å“åº”å›å» w.Header().Add(\"X-Block-Req\", \"Block by Go ext.\") w.WriteHeader(http.StatusForbidden) } ç¼–è¯‘éƒ¨ç½² ç”¨å®˜æ–¹æä¾›çš„ Makefile è¿›è¡Œ buildï¼ˆæ³¨æ„ç¼–è¯‘ç¯å¢ƒå’Œapisix è¿è¡Œçš„ç¯å¢ƒï¼ŒæŒ‡å®šå¯¹åº”çš„ GOOSï¼ŒGOARCHï¼‰ å°†ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶æ‰“åŒ…åˆ° apisix çš„å®¹å™¨å†… ä¿®æ”¹é…ç½®æ–‡ä»¶ ext-plugin: cmd: [\"/path/to/apisix-go-plugin-runner/go-runner\", \"run\"] æ³¨æ„ï¼šä¸€ä¸ª go-runner å†…å¯ä»¥æ³¨å†Œå¤šä¸ªæ’ä»¶ï¼Œæ‰€ä»¥ä¸éœ€è¦æ‹¥æœ‰å¤šä¸ª go-runner ,æ‰€æœ‰çš„æ’ä»¶åœ¨ä¸€ä¸ªé¡¹ç›®é‡Œ ç„¶åç»Ÿä¸€ç¼–è¯‘éƒ¨ç½²å³å¯ ä½¿ç”¨ é lua æ’ä»¶éƒ½è¿è¡Œåœ¨å„è‡ªçš„ runner å†…ï¼Œæ‰€ä»¥ä½¿ç”¨çš„æ—¶å€™ä¸èƒ½ç›´æ¥åœ¨ dashboard ä¸­ä½¿ç”¨è‡ªå®šä¹‰çš„æ’ä»¶ï¼ˆlua çš„è‡ªå®šä¹‰æ’ä»¶æ˜¯å¯ä»¥çš„ï¼‰ï¼Œéœ€è¦åœ¨ ext-plugin-pre-req, ext-plugin-post-req ä¸¤ä¸ªæ’ä»¶å†…é…ç½®ä½¿ç”¨ï¼Œè¿™ä¸¤æ’ä»¶åªæœ‰è¿è¡Œæ—¶é—´ä¸ä¸€æ ·ï¼Œä¸€ä¸ªåœ¨æ‰€æœ‰æ’ä»¶ä¹‹å‰ ä¸€ä¸ªåœ¨æ‰€æœ‰æ’ä»¶ä¹‹åã€‚ä½¿ç”¨æ—¶é…ç½®å¦‚ä¸‹: \"plugins\": { \"ext-plugin-pre-req\": { \"conf\": [ { \"name\": \"blcok-req\", // æ³¨å†Œçš„ go æ’ä»¶åå­— \"value\": \"{\\\"key\\\":\\\"pass\\\", \\\"value\\\":[\\\"word\\\",\\\"port\\\"]}\" // è¯¥æ’ä»¶çš„ confï¼Œè¿™é‡Œéœ€è¦å°† json è¿›è¡Œè½¬ä¹‰ } ], \"disable\": false } } ","date":"2021-11-03","objectID":"/posts/apisix_plugins/:3:2","tags":["lua","go","apisix"],"title":"apisix å¼€å‘è‡ªå®šä¹‰æ’ä»¶","uri":"/posts/apisix_plugins/"},{"categories":["ç½‘å…³"],"content":"wasm apisix å¼€å§‹æ”¯æŒ wasm æ’ä»¶ï¼Œä½†æ˜¯å®˜æ–¹ç»™å‡ºçš„ç¤ºä¾‹å’Œæ–‡æ¡£è¿˜ä¸å¤Ÿå®Œå–„ï¼Œè¿™å—è¿˜åœ¨ç ”ç©¶ä¸­ï¼Œä¹‹åä¼šè¡¥é½ã€‚ ","date":"2021-11-03","objectID":"/posts/apisix_plugins/:3:3","tags":["lua","go","apisix"],"title":"apisix å¼€å‘è‡ªå®šä¹‰æ’ä»¶","uri":"/posts/apisix_plugins/"},{"categories":["ç½‘å…³"],"content":" æœ¬æ–‡ç®€å•ä»‹ç»å¦‚ä½•é€šè¿‡ lua è„šæœ¬å’Œ ngx_shared_dict åœ¨ nginx ä¸­åŠ¨æ€åŠ è½½åç«¯æœåŠ¡é…ç½®ä»¥åŠåŠ¨æ€æ›´æ–°æœåŠ¡é…ç½®. ","date":"2021-09-17","objectID":"/posts/nginx-lua-plugins/:0:0","tags":["nginx","lua"],"title":"nginx ä¸­ä½¿ç”¨ lua åŠ¨æ€åŠ è½½æœåŠ¡é…ç½®","uri":"/posts/nginx-lua-plugins/"},{"categories":["ç½‘å…³"],"content":"nginx ","date":"2021-09-17","objectID":"/posts/nginx-lua-plugins/:1:0","tags":["nginx","lua"],"title":"nginx ä¸­ä½¿ç”¨ lua åŠ¨æ€åŠ è½½æœåŠ¡é…ç½®","uri":"/posts/nginx-lua-plugins/"},{"categories":["ç½‘å…³"],"content":"åŠ è½½ lua è„šæœ¬ åœ¨ Nginx ä¸­éœ€è¦å¼•å…¥å’ŒåŠ è½½ lua è„šæœ¬ï¼Œä»è€Œåœ¨è·¯ç”±è½¬å‘æ—¶è¿è¡Œ lua è„šæœ¬è¿›è¡Œæˆ‘ä»¬çš„é€»è¾‘ã€‚åˆå§‹åŒ–ä»£ç å¦‚ä¸‹ï¼š http { lua_shared_dict endpoints_data 5m; #å®šä¹‰upstreamå…±äº«å†…å­˜ç©ºé—´ lua_shared_dict cache 1m; #å®šä¹‰è®¡æ•°å…±äº«ç©ºé—´ access_log nginx_access.log; lua_package_path \"/etc/nginx/lua/?.lua;;\"; init_by_lua_block { collectgarbage(\"collect\") local ok, res # åŠ è½½è„šæœ¬ configuration.lua ok, res = pcall(require, \"configuration\") if not ok then error(\"require failed: \" .. tostring(res)) else configuration = res end } # æ‰§è¡Œè„šæœ¬å†…åˆå§‹åŒ–æ–¹æ³•ï¼Œè¿™é‡Œä¸ºå¯é€‰é¡¹ï¼Œå¦‚æœæ²¡æœ‰å¯åˆå§‹åŒ–çš„ä»£ç éƒ¨åˆ† è¿™é‡Œå¯ä»¥ä¸è¦ init_worker_by_lua_block { configuration.prepare() } } ","date":"2021-09-17","objectID":"/posts/nginx-lua-plugins/:1:1","tags":["nginx","lua"],"title":"nginx ä¸­ä½¿ç”¨ lua åŠ¨æ€åŠ è½½æœåŠ¡é…ç½®","uri":"/posts/nginx-lua-plugins/"},{"categories":["ç½‘å…³"],"content":"æ‰§è¡Œ lua è„šæœ¬ å¦‚ä½•åœ¨ Nginx é…ç½®ä¸­æ‰§è¡Œ lua è„šæœ¬ï¼Œä»è€Œå®ç°ä¸€äº›ç‰¹æ®Šé€»è¾‘ï¼Ÿè¿™é‡Œç»™å‡ºä¸€ä¸ªç®€å•çš„ç¤ºä¾‹: server { # æ‰§è¡Œæœ€ç®€å•çš„ lua è„šæœ¬ location /hello { default_type 'text/plain'; content_by_lua 'ngx.say(\"hello, lua\")'; } # é…ç½®æ¥å£ # è¿™é‡Œæ˜¯æ‰§è¡ŒåŠ è½½çš„ lua è„šæœ¬ä¸­æ–¹æ³• location /configuration { client_max_body_size 5m; client_body_buffer_size 1m; proxy_buffering off; content_by_lua_block { configuration.call() # è°ƒç”¨ call() æ–¹æ³• } } # æ‰§è¡Œè¾ƒä¸ºå¤æ‚çš„ lua é€»è¾‘ location /lua { default_type 'text/plain'; # è¯»å–è¯·æ±‚ä¸­çš„ path å‚æ•° å¹¶ä»å…±äº« dict ä¸­æŸ¥è¯¢è¿™ä¸ªå€¼ï¼Œ # è¿”å›æŸ¥è¯¢åˆ°çš„ç»“æœ content_by_lua ' local path = ngx.req.get_uri_args()[\"path\"] if path == nil then ngx.say(\"path not found\") return end local data = ngx.shared.endpoints_data:get(\"/\"..path) if not data then ngx.say(\"unkonw path\") return end ngx.say(\"paths: \"..data) '; } } lua çš„è¯­æ³•ç›¸å¯¹ç®€å•å¥½ä¸Šæ‰‹ï¼Œå®ç°ä¸€äº›ç®€å•çš„é€»è¾‘ä¹Ÿå¾ˆæ–¹ä¾¿ï¼Œéå¸¸å€¼å¾—å­¦ä¹ ã€‚ ","date":"2021-09-17","objectID":"/posts/nginx-lua-plugins/:1:2","tags":["nginx","lua"],"title":"nginx ä¸­ä½¿ç”¨ lua åŠ¨æ€åŠ è½½æœåŠ¡é…ç½®","uri":"/posts/nginx-lua-plugins/"},{"categories":["ç½‘å…³"],"content":"å®Œæ•´é…ç½® å…ˆç»™å‡º Nginx çš„å®Œæ•´é…ç½®ï¼Œé‡Œé¢åŒ…æ‹¬åŠ¨æ€é…ç½®åç«¯æœåŠ¡åˆ—è¡¨å’ŒåŠ¨æ€åŠ è½½æœåŠ¡è½¬å‘çš„é€»è¾‘ï¼Œç„¶åå†ç»™å‡º lua éƒ¨åˆ†è¯¦ç»†å®ç°çš„ä»£ç ã€‚ user nginx; worker_processes 1; pid /var/run/nginx.pid; error_log nginx_error.log; events { worker_connections 1024; } http { lua_shared_dict endpoints_data 5m; #å®šä¹‰upstreamå…±äº«å†…å­˜ç©ºé—´ lua_shared_dict cache 1m; #å®šä¹‰è®¡æ•°å…±äº«ç©ºé—´ access_log nginx_access.log; lua_package_path \"/etc/nginx/lua/?.lua;;\"; init_by_lua_block { collectgarbage(\"collect\") local ok, res ok, res = pcall(require, \"configuration\") if not ok then error(\"require failed: \" .. tostring(res)) else configuration = res end } # æ‰§è¡Œè„šæœ¬å†…åˆå§‹åŒ–æ–¹æ³•ï¼Œè¿™é‡Œä¸ºå¯é€‰é¡¹ï¼Œå¦‚æœæ²¡æœ‰å¯åˆå§‹åŒ–çš„ä»£ç éƒ¨åˆ† è¿™é‡Œå¯ä»¥ä¸è¦ init_worker_by_lua_block { configuration.prepare() } include /etc/nginx/mime.types; default_type application/octet-stream; sendfile on; #tcp_nopush on; keepalive_timeout 65; #gzip on; server { # æ‰§è¡Œæœ€ç®€å•çš„ lua è„šæœ¬ location /hello { default_type 'text/plain'; content_by_lua 'ngx.say(\"hello, lua\")'; } # é…ç½®æ¥å£ # è¿™é‡Œæ˜¯æ‰§è¡ŒåŠ è½½çš„ lua è„šæœ¬ä¸­æ–¹æ³• location /configuration { client_max_body_size 5m; client_body_buffer_size 1m; proxy_buffering off; content_by_lua_block { configuration.call() # è°ƒç”¨ call() æ–¹æ³• } } # æ‰§è¡Œè¾ƒä¸ºå¤æ‚çš„ lua é€»è¾‘ location /lua { default_type 'text/plain'; # è¯»å–è¯·æ±‚ä¸­çš„ path å‚æ•° å¹¶ä»å…±äº« dict ä¸­æŸ¥è¯¢è¿™ä¸ªå€¼ï¼Œ # è¿”å›æŸ¥è¯¢åˆ°çš„ç»“æœ content_by_lua ' local path = ngx.req.get_uri_args()[\"path\"] if path == nil then ngx.say(\"path not found\") return end local data = ngx.shared.endpoints_data:get(\"/\"..path) if not data then ngx.say(\"unkonw path\") return end ngx.say(\"paths: \"..data) '; } # other path location / { set $load_ups \"\"; # åŠ¨æ€è®¾ç½®å½“å‰ upstream, æœªæ‰¾åˆ°è¿”å›404 rewrite_by_lua ' local ups = configuration.getEndpoints() if ups ~= nil then ngx.log(ngx.ERR,\"got upstream\", ups) ngx.var.load_ups = ups return end ngx.status = ngx.HTTP_NOT_FOUND ngx.exit(ngx.status) '; proxy_pass http://$load_ups$uri; add_header X-Upstream $upstream_addr always; # æ·»åŠ  backend ip } } } ","date":"2021-09-17","objectID":"/posts/nginx-lua-plugins/:1:3","tags":["nginx","lua"],"title":"nginx ä¸­ä½¿ç”¨ lua åŠ¨æ€åŠ è½½æœåŠ¡é…ç½®","uri":"/posts/nginx-lua-plugins/"},{"categories":["ç½‘å…³"],"content":"lua ","date":"2021-09-17","objectID":"/posts/nginx-lua-plugins/:2:0","tags":["nginx","lua"],"title":"nginx ä¸­ä½¿ç”¨ lua åŠ¨æ€åŠ è½½æœåŠ¡é…ç½®","uri":"/posts/nginx-lua-plugins/"},{"categories":["ç½‘å…³"],"content":"å®šä¹‰å˜é‡ å› ä¸ºéœ€è¦ç”¨åˆ° shared_dict ç‰¹æ€§ï¼Œåœ¨ lua å’Œ Nginx ä¹‹é—´å…¬ç”¨å†…å­˜å— ä»è€Œå®ç°æ•°æ®çš„åŒæ­¥å…±äº«ï¼Œæ‰€ä»¥éœ€è¦é¢„å®šä¹‰ä¸€äº›å˜é‡ã€‚ -- å¼•å…¥å˜é‡ local io = io local ngx = ngx local table = table -- å½“å‰åŒ…çš„å¯¹è±¡ï¼Œç±»ä¼¼ go è¯­è¨€çš„å®šä¹‰ç»“æ„ä½“ è®©ç»™è¿™ä¸ªç»“æ„ä½“å®ç°æ–¹æ³• local _M = {} -- ä¸ Nginx å…±äº«çš„ç©ºé—´ å¯è¯»å†™ local Endpoints = ngx.shared.endpoints_data ","date":"2021-09-17","objectID":"/posts/nginx-lua-plugins/:2:1","tags":["nginx","lua"],"title":"nginx ä¸­ä½¿ç”¨ lua åŠ¨æ€åŠ è½½æœåŠ¡é…ç½®","uri":"/posts/nginx-lua-plugins/"},{"categories":["ç½‘å…³"],"content":"åŠ¨æ€æ›´æ–°æœåŠ¡åˆ—è¡¨ æœåŠ¡åˆ—è¡¨æ˜¯é€šè¿‡è¢«è°ƒæ¥å£å®ç°ï¼Œå³æœ‰åˆ«çš„æœåŠ¡åŒºç›‘å¬æœåŠ¡èŠ‚ç‚¹(endpoint)çš„å˜åŒ–,ç„¶åè°ƒç”¨/configuration/backends æ¥å£ï¼Œè¢« Nginx é…ç½®çš„ /configuration è§„åˆ™å‘½ä¸­åè°ƒç”¨ configuration.call() æ–¹æ³•ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™ä¸ª call æ–¹æ³•çš„å®ç°ã€‚ -- call called by ngx function _M.call() -- åªå¤„ç† GET å’Œ POST if ngx.var.request_method ~= \"POST\" and ngx.var.request_method ~= \"GET\" then ngx.status = ngx.HTTP_BAD_REQUEST ngx.print(\"Only POST and GET requests are allowed!\") return end -- ç›®å‰åªå¤„ç†åç«¯æœåŠ¡çš„é…ç½® æ‰€ä»¥åˆ¤æ–­è·¯ç”± if ngx.var.request_uri == \"/configuration/backends\" then -- è°ƒç”¨å†…éƒ¨æ–¹æ³• handle_backends() return end -- éæ³•è¯·æ±‚ è¿”å› 404 ngx.status = ngx.HTTP_NOT_FOUND ngx.print(\"Not found!\") end å¤šè¯´ä¸€å¥ï¼Œè°ƒç”¨ /configuration/backends æ—¶ä¼ å‚æ˜¯åœ¨è¯·æ±‚ body é‡Œï¼Œæ ¼å¼ä¸º json æ‰€ä»¥éœ€è¦å¼•å…¥ç¬¬ä¸‰æ–¹çš„ json è§£æåŒ…ã€‚handle_backends æ–¹æ³•çš„å®ç°ï¼š -- handle_backends . local function handle_backends() if ngx.var.request_method == \"GET\" then ngx.status = ngx.HTTP_OK -- è¿”å›æŸ¥è¯¢çš„æœåŠ¡åˆ—è¡¨ local path = ngx.req.get_uri_args()[\"path\"] ngx.print(Endpoints:get(\"path\")) return end -- è¯»å–è¯·æ±‚ body local obj = fetch_request_body() if not obj then ngx.log(ngx.ERR, \"dynamic-configuration: unable to read valid request body\") ngx.status = ngx.HTTP_BAD_REQUEST return end -- é€šè¿‡ ç¬¬ä¸‰æ–¹åŒ… json è§£æ bodyåˆ° lua table local rule, err = json.decode(obj) if not rule then ngx.log(ngx.ERR, \"could not parse backends data: \", err) return end ngx.log(ngx.ERR, \"decoed rule\", obj) -- æ¸…ç©ºå…±äº«ç©ºé—´ Endpoints:flush_all() -- éå†å¹¶å†™å…¥ for _, new_rule in ipairs(rule.rules) do -- æ›´æ–° -- å°†æ•°ç»„åˆå¹¶ local succ, err1, forcible = Endpoints:set(new_rule.path, table.concat(new_rule.upstreams, \",\")) ngx.log(ngx.ERR, \"set result\", succ, err1,forcible) end ngx.status = ngx.HTTP_CREATED ngx.say(\"ok\") end -- è¯»å–è¯·æ±‚ body éƒ¨åˆ† local function fetch_request_body() ngx.req.read_body() local body = ngx.req.get_body_data() if not body then -- request body might've been written to tmp file if body \u003e client_body_buffer_size local file_name = ngx.req.get_body_file() local file = io.open(file_name, \"rb\") if not file then return nil end body = file:read(\"*all\") file:close() end return body end è¯·æ±‚ body çš„ json ç»“æ„å¦‚ä¸‹ï¼š type NginxRuleConf struct { Rules []struct{ Path string `json:\"path\"` ServiceName string `json:\"serviceName\"` Port int32 `json:\"-\"` Upstreams []string `json:\"upstreams\"` } `json:\"rules\"` } ","date":"2021-09-17","objectID":"/posts/nginx-lua-plugins/:2:2","tags":["nginx","lua"],"title":"nginx ä¸­ä½¿ç”¨ lua åŠ¨æ€åŠ è½½æœåŠ¡é…ç½®","uri":"/posts/nginx-lua-plugins/"},{"categories":["ç½‘å…³"],"content":"åŠ¨æ€è¯»å–åç«¯æœåŠ¡ ä¸Šé¢å·²ç»é€šè¿‡æ¥å£çš„æ–¹å¼åŠ¨æ€æ›´æ–°æœåŠ¡èŠ‚ç‚¹åˆ—è¡¨å¹¶å†™å…¥åˆ°å…±äº«ç©ºé—´ endpoints_data å†…ï¼Œæˆ‘ä»¬ç°åœ¨å®ç°è¯»å–æœåŠ¡åˆ—è¡¨å¹¶é€‰æ‹©å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹è¿›è¡Œæ¥å£è½¬å‘ã€‚ ä»£ç å¦‚ä¸‹ï¼š -- è½®é¡ºçš„æ–¹å¼å–èŠ‚ç‚¹ function _M.getEndpoints() local cache = ngx.shared.cache local path = ngx.var.request_uri local eps = Endpoints:get(path) if not eps then return nil end local tab = split(eps,\",\") local index = cache:get(path) if index == nil or index \u003e #tab then index = 1 end -- åŠ ä¸€ cache:set(path,index+1) return tab[index] end ","date":"2021-09-17","objectID":"/posts/nginx-lua-plugins/:2:3","tags":["nginx","lua"],"title":"nginx ä¸­ä½¿ç”¨ lua åŠ¨æ€åŠ è½½æœåŠ¡é…ç½®","uri":"/posts/nginx-lua-plugins/"},{"categories":["ç½‘å…³"],"content":"ç»“è®º è‡³æ­¤å®ç°çš„æ•ˆæœæ˜¯ï¼Œå¯ä»¥åŠ¨æ€é…ç½®å¤šä¸ªåç«¯æœåŠ¡å’Œåç«¯æœåŠ¡èŠ‚ç‚¹åˆ—è¡¨ï¼Œå¤–éƒ¨æœåŠ¡è¯·æ±‚ Nginx æ—¶ï¼Œä¼šå°è¯•ä»å·²æœ‰çš„æœåŠ¡ä¸­åŒ¹é…è½¬å‘ï¼Œå¦‚æœæœåŠ¡æœ‰å¤šä¸ªèŠ‚ç‚¹åˆ™è½®é¡ºçš„æ–¹æ³•å»è½¬å‘ã€‚å¦‚æœ‰æœåŠ¡ä¿¡æ¯å‘ç”Ÿå˜åŒ–ï¼Œåˆ™é€šè¿‡è°ƒç”¨ Nginx ä¸­é…ç½®çš„ configuration æ¥å£æ›´æ–°å³å¯ï¼Œæ— éœ€ä¿®æ”¹ Nginx é…ç½®ã€‚ ","date":"2021-09-17","objectID":"/posts/nginx-lua-plugins/:3:0","tags":["nginx","lua"],"title":"nginx ä¸­ä½¿ç”¨ lua åŠ¨æ€åŠ è½½æœåŠ¡é…ç½®","uri":"/posts/nginx-lua-plugins/"},{"categories":["kubernetes"],"content":"æœ¬æ–‡ä»‹ç»æœ¬åœ°æˆ–æœåŠ¡å™¨ä¸Šæ­å»ºå•èŠ‚ç‚¹çš„ k8s é›†ç¾¤å’Œ webUI ä»¥åŠå¯ç”¨ingressï¼Œå¯ä»¥ç”¨ä½œå¼€å‘å’Œæµ‹è¯•ç¯å¢ƒã€‚ ","date":"2021-09-07","objectID":"/posts/deploy-k8s-cluster/:0:0","tags":["k8s","docker"],"title":"éƒ¨ç½²å•æœº k8s é›†ç¾¤","uri":"/posts/deploy-k8s-cluster/"},{"categories":["kubernetes"],"content":"å‡†å¤‡å·¥ä½œ æ‰€éœ€å·¥å…·ï¼š docker minkube kubectl å¦‚ä½•å®‰è£… docker å°±ä¸å†è¿™é‡Œæ’°è¿°ã€‚ ","date":"2021-09-07","objectID":"/posts/deploy-k8s-cluster/:1:0","tags":["k8s","docker"],"title":"éƒ¨ç½²å•æœº k8s é›†ç¾¤","uri":"/posts/deploy-k8s-cluster/"},{"categories":["kubernetes"],"content":"å®‰è£… minikube å®˜æ–¹æ–‡æ¡£ Mac $ brew install minkube linux $ curl -Lo minikube https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64 \\ \u0026\u0026 chmod +x minikube å°† Minikube å¯æ‰§è¡Œæ–‡ä»¶æ·»åŠ è‡³ PATHï¼š sudo mkdir -p /usr/local/bin/ sudo install minikube /usr/local/bin/ ä¹Ÿå¯ä»¥åœ¨ GitHub ä¸Šä¸‹è½½ç³»ç»Ÿå¯¹åº”çš„äºŒçº§åˆ¶æ–‡ä»¶ ","date":"2021-09-07","objectID":"/posts/deploy-k8s-cluster/:1:1","tags":["k8s","docker"],"title":"éƒ¨ç½²å•æœº k8s é›†ç¾¤","uri":"/posts/deploy-k8s-cluster/"},{"categories":["kubernetes"],"content":"å®‰è£… kubectl å®˜æ–¹æ–‡æ¡£ Mac $ brew install kubernetes-cli Linux $ sudo apt-get update \u0026\u0026 sudo apt-get install -y apt-transport-https $ curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add - $ echo \"deb https://apt.kubernetes.io/ kubernetes-xenial main\" | sudo tee -a /etc/apt/sources.list.d/kubernetes.list $ sudo apt-get update $ sudo apt-get install -y kubectl ","date":"2021-09-07","objectID":"/posts/deploy-k8s-cluster/:1:2","tags":["k8s","docker"],"title":"éƒ¨ç½²å•æœº k8s é›†ç¾¤","uri":"/posts/deploy-k8s-cluster/"},{"categories":["kubernetes"],"content":"å¯åŠ¨\u0026æ£€æŸ¥ å¯åŠ¨ $ minikube start --vm-driver=docker æ£€æŸ¥ $ minikube status minikube type: Control Plane host: Running kubelet: Running apiserver: Running kubeconfig: Configured è‡³æ­¤é›†ç¾¤å·²ç»éƒ¨ç½²æˆåŠŸï¼Œå¯ä»¥é€šè¿‡ kubectl å‘½ä»¤æŸ¥çœ‹çŠ¶æ€ $ kubectl cluster-info Kubernetes control plane is running at https://xxx.xxx.xx.xx:8443 CoreDNS is running at https://xxx.xxx.xx.xx:8443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy ","date":"2021-09-07","objectID":"/posts/deploy-k8s-cluster/:2:0","tags":["k8s","docker"],"title":"éƒ¨ç½²å•æœº k8s é›†ç¾¤","uri":"/posts/deploy-k8s-cluster/"},{"categories":["kubernetes"],"content":"åœæ­¢\u0026æ¸…ç† åœæ­¢ $ minkube stop æ¸…ç† $ minikube delete ","date":"2021-09-07","objectID":"/posts/deploy-k8s-cluster/:3:0","tags":["k8s","docker"],"title":"éƒ¨ç½²å•æœº k8s é›†ç¾¤","uri":"/posts/deploy-k8s-cluster/"},{"categories":["kubernetes"],"content":"webUI å®‰è£… k8s ç®¡ç† dashboardã€‚ $ minikube dashboard --url ğŸ¤” Verifying dashboard health ... ğŸš€ Launching proxy ... ğŸ¤” Verifying proxy health ... http://127.0.0.1:35983/api/v1/namespaces/kubernetes-dashboard/services/http:kubernetes-dashboard:/proxy/ minikube ä¼šå®‰è£… dashboard å¹¶è¿”å›å¯è®¿é—®çš„ url, å¦‚æœæ˜¯æœ¬åœ°åˆ™ç›´æ¥è®¿é—®å³å¯ã€‚ å¦‚æœæ˜¯æœåŠ¡å™¨ä¸Šï¼Œåˆ™éœ€è¦æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š $ kubectl proxy --address='0.0.0.0' --disable-filter=true W0907 17:47:12.246841 591818 proxy.go:162] Request filter disabled, your proxy is vulnerable to XSRF attacks, please be cautious Starting to serve on [::]:8001 å¹¶é€šè¿‡http://serverIP:8001/api/v1/namespaces/kubernetes-dashboard/services/http:kubernetes-dashboard:/proxy/è®¿é—® dashboard ã€‚ ","date":"2021-09-07","objectID":"/posts/deploy-k8s-cluster/:4:0","tags":["k8s","docker"],"title":"éƒ¨ç½²å•æœº k8s é›†ç¾¤","uri":"/posts/deploy-k8s-cluster/"},{"categories":["kubernetes"],"content":"Ingress å¯åŠ¨ ingress ä¹Ÿæ˜¯éœ€è¦é€šè¿‡ minikube å‘½ä»¤æ‰§è¡Œã€‚ $ minikube addons enable ingress minikube ä¼šå¼€å¯ ingress å¹¶å®‰è£… ingress-nginx, æˆ‘ä»¬åªéœ€è¦å†™ ingress è§„åˆ™å³å¯ã€‚ç„¶åé€šè¿‡ kubectl å‘½ä»¤æŸ¥çœ‹å¯è®¿é—®çš„è™šæ‹Ÿ ipã€‚ $ kubectl get ingress NAME CLASS HOSTS ADDRESS PORTS AGE goapp-ingress \u003cnone\u003e * 192.168.49.2 80 2d $ curl 192.168.49.2/ping \"pong\" å¯ä»¥è®¿é—®çš„é€šçš„ã€‚ ç›¸å…³è¿æ¥: https://v1-18.docs.kubernetes.io/zh/docs/tasks/tools/install-minikube/ https://kubernetes.io/zh/docs/tasks/access-application-cluster/ingress-minikube/ https://stackoverflow.com/questions/47173463/how-to-access-local-kubernetes-minikube-dashboard-remotely ","date":"2021-09-07","objectID":"/posts/deploy-k8s-cluster/:5:0","tags":["k8s","docker"],"title":"éƒ¨ç½²å•æœº k8s é›†ç¾¤","uri":"/posts/deploy-k8s-cluster/"},{"categories":["Docker"],"content":"dlv ä½œä¸ºç¨‹åºè°ƒè¯•å·¥å…·åŠŸèƒ½éå¸¸å¼ºå¤§ï¼Œæ—¥å¸¸å¼€å‘å’Œæµ‹è¯•ä¸­å‡ ä¹ç¦»ä¸å¼€ debug è°ƒè¯•ã€‚ä½†æ˜¯æœ‰çš„æ—¶å€™ç”±äºæœ¬åœ°ç¯å¢ƒä¸çº¿ä¸Šç¯å¢ƒä¸ä¸€è‡´æˆ–æœ‰äº›é—®é¢˜åœ¨æœ¬åœ°æ— æ³•å¤ç°çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦åœ¨çº¿ä¸Š/æµ‹è¯•ç¯å¢ƒåš debugï¼ŒåŒæ—¶å¸Œæœ› debug ä½“éªŒèƒ½ä¸æœ¬åœ° debug ä½“éªŒä¸€è‡´ã€‚dlv å…¶å®æ˜¯æ”¯æŒè¿™ç§éœ€æ±‚çš„ï¼Œçº¿ä¸Šè¿è¡Œçº¿æœ¬åœ° debugã€‚ä»¥ä¸‹æ˜¯åŸºäº docker ç¯å¢ƒçš„è¿œç¨‹è°ƒè¯•æ­¥éª¤ï¼Œå¸Œæœ›èƒ½å¯¹é‡åˆ°è¿™ç§æƒ…å†µçš„ç å‹ä»¬å‹å¸®åŠ©ã€‚ æ‰€éœ€å·¥å…·ï¼š docker goland dlv ","date":"2021-09-06","objectID":"/posts/docker-dlv-debugging/:0:0","tags":["go","docker"],"title":"å¦‚ä½•åœ¨ docker ç¯å¢ƒä¸‹è¿›è¡Œè¿œç¨‹ dlv è°ƒè¯•","uri":"/posts/docker-dlv-debugging/"},{"categories":["Docker"],"content":"docker file # Compile stage FROM golang:1.13.8 AS build-env # Build Delve RUN go get github.com/go-delve/delve/cmd/dlv ADD . /dockerdev WORKDIR /dockerdev # ç¼–è¯‘éœ€è¦ debug çš„ç¨‹åº RUN go build -gcflags=\"all=-N -l\" -o /server # Final stage FROM debian:buster # åˆ†åˆ«æš´éœ² server å’Œ dlv ç«¯å£ EXPOSE 8000 40000 WORKDIR / COPY --from=build-env /go/bin/dlv / COPY --from=build-env /server / CMD [\"/dlv\", \"--listen=:40000\", \"--headless=true\", \"--api-version=2\", \"--accept-multiclient\", \"exec\", \"/server\"] ","date":"2021-09-06","objectID":"/posts/docker-dlv-debugging/:1:0","tags":["go","docker"],"title":"å¦‚ä½•åœ¨ docker ç¯å¢ƒä¸‹è¿›è¡Œè¿œç¨‹ dlv è°ƒè¯•","uri":"/posts/docker-dlv-debugging/"},{"categories":["Docker"],"content":"å¯åŠ¨ docker é•œåƒ $ docker run -d -p 8000:8000 -p 40000:40000 --privileged --name=dlv-debug $(ImageName):$(ImageVersion) ","date":"2021-09-06","objectID":"/posts/docker-dlv-debugging/:2:0","tags":["go","docker"],"title":"å¦‚ä½•åœ¨ docker ç¯å¢ƒä¸‹è¿›è¡Œè¿œç¨‹ dlv è°ƒè¯•","uri":"/posts/docker-dlv-debugging/"},{"categories":["Docker"],"content":"goland é…ç½® åœ¨ Goland -\u003e Run -\u003e Edit Configuration æ·»åŠ  Go Remote é…ç½® docker é•œåƒçš„ ip:port, æœ¬åœ°çš„ docker ç¯å¢ƒåˆ™ localhost:40000 å³å¯ã€‚ ç°åœ¨å°±å¯ä»¥åœ¨æœ¬åœ° Goland ç¯å¢ƒä¸‹å¯åŠ¨é…ç½® debug å°±å¯ä»¥ï¼Œæœ¬åœ° debug è¿œç¨‹ç¨‹åºï¼Œä¸æœ¬åœ° debug æ¯«æ— åŒºåˆ«ã€‚ è¿™ç§æ–¹å¼åœ¨ä¸€äº›ç‰¹å®šç¯å¢ƒï¼ˆtest ç¯å¢ƒã€è¿œç¨‹åŠå…¬ç­‰ï¼‰éå¸¸æ–¹ä¾¿ã€‚ å‚è€ƒæ–‡çŒ®ï¼š https://blog.jetbrains.com/go/2020/05/06/debugging-a-go-application-inside-a-docker-container/ ","date":"2021-09-06","objectID":"/posts/docker-dlv-debugging/:3:0","tags":["go","docker"],"title":"å¦‚ä½•åœ¨ docker ç¯å¢ƒä¸‹è¿›è¡Œè¿œç¨‹ dlv è°ƒè¯•","uri":"/posts/docker-dlv-debugging/"},{"categories":["proto"],"content":"å‰è¨€ å¦‚æœå¤§å®¶æ¥è§¦è¿‡ grpc å’Œ protobuf ï¼Œé‚£å¯¹ protoc è¿™ä¸ªå‘½ä»¤åº”è¯¥ä¸é™Œç”Ÿã€‚ protoc ä¸ºåŸºäº proto buffer æ–‡ä»¶ç”Ÿæˆä¸åŒè¯­è¨€ä»£ç çš„å·¥å…·ï¼Œåœ¨æ—¥å¸¸ä¸šåŠ¡å¼€å‘ä¸­èƒ½ç»å¸¸ç”¨åˆ°ã€‚é‚£å…ˆæŠ›å‡ºä¸€ä¸ªé—®é¢˜ï¼Œä½ æœ‰æ²¡æœ‰åŸºäº pb æ–‡ä»¶ç”Ÿæˆæ»¡è¶³è‡ªå·±ç‰¹æ®Šè¦æ±‚çš„éœ€æ±‚ï¼Ÿæ¯”å¦‚ç”Ÿæˆå¯¹åº”çš„ http ä»£ç æˆ–æ ¡éªŒå‚æ•°ç­‰ã€‚ æˆ‘ä¸ªäººéœ€æ±‚ä¸ºï¼Œé™¤äº†ç”Ÿæˆæ­£å¸¸çš„ grpc ä»£ç å¤–ï¼Œéœ€è¦ç”Ÿæˆä¸€å¥—å¯¹åº”çš„ http ä»£ç ï¼Œè€Œä¸”æœ€å¥½æ˜¯èƒ½ç›´æ¥åœ¨ gin/iris è¿™ç§ä¸»æµ web æ¡†æ¶å†…æ³¨å†Œä½¿ç”¨ã€‚ å…¶å® golang/protobuf åŒ…æ”¯æŒè‡ªå®šä¹‰æ’ä»¶çš„ï¼Œè€Œä¸”è¿˜æä¾›å¾ˆå¤šå¥½ç”¨çš„æ–¹æ³•ï¼Œæ–¹ä¾¿æˆ‘ä»¬è¯»å†™ pb æ–‡ä»¶ã€‚æˆ‘ä»¬å†™å¥½è‡ªå·±çš„æ’ä»¶å®‰è£…åˆ° $GOPATH/bin ä¸‹ï¼Œç„¶ååœ¨è°ƒç”¨ protoc å‘½ä»¤æ—¶ï¼ŒæŒ‡å®šæˆ‘ä»¬è‡ªå·±çš„æ’ä»¶åå’Œè¾“å‡ºä½ç½®å³å¯ã€‚ å…³äºè¿™ä¸ªæ’ä»¶ï¼šæˆ‘ç°æœ‰çš„éœ€æ±‚ç„¶åä¸€ç›´æ‰¾ä¸åˆ°æ¯”è¾ƒå¥½çš„è§£å†³æ–¹æ¡ˆï¼Œç›´åˆ°çœ‹åˆ° kratos é¡¹ç›®çš„ http ä»£ç ç”Ÿæˆæ’ä»¶åè±ç„¶å¼€æœ—ï¼ŒåŸºäº kratos çš„é€»è¾‘å®ç°çš„è‡ªå·±éœ€æ±‚ï¼Œæ„Ÿè°¢ kratos ä½œè€…ä»¬ã€‚ ","date":"2021-07-08","objectID":"/posts/go-protoc-http/:1:0","tags":["go","grpc","protoc"],"title":"å¦‚ä½•è‡ªå®šä¹‰ protoc æ’ä»¶","uri":"/posts/go-protoc-http/"},{"categories":["proto"],"content":"æ•ˆæœ å…ˆçœ‹åŸå§‹ pb æ–‡ä»¶ã€‚ test.proto syntax = \"proto3\"; package hello.service.v1; option go_package = \"api/hello/service/v1;v1\"; // ä¸‹è½½ `github.com/googleapis/googleapis` è‡³`GOPATH`, ç”Ÿæˆ http ä»£ç éœ€è¦ã€‚ import \"google/api/annotations.proto\"; service Hello { rpc Add(AddRequest) returns (AddResponse) { option (google.api.http) = { post: \"/api/hello/service/v1/add\" body: \"*\" }; } rpc Get(GetRequest) returns (GetResponse) { option (google.api.http) = { get: \"/api/hello/service/v1/get\" }; } } message AddRequest { uint32 id = 1; string name = 2; } message AddResponse { uint32 id = 1; string name = 2; } message GetRequest { uint32 id = 1; } message GetResponse { uint32 id = 1; string name = 2; float score = 3; bytes bs = 4; map\u003cstring, string\u003e m = 5; } å› ä¸ºæˆ‘éœ€è¦ç”Ÿæˆ http ä»£ç ï¼Œæ‰€ä»¥å®šä¹‰ rpc æ—¶ï¼Œhttp è·¯ç”±å’Œmethod éœ€è¦åœ¨ pb æ–‡ä»¶æŒ‡å®šã€‚ æˆ‘å®ç°çš„æ’ä»¶èµ·ç å« protoc-gen-go-http, å¿…é¡»ä»¥ protoc-gen å¼€å¤´å¦åˆ™ protoc ä¸è®¤ã€‚ æ‰§è¡Œå‘½ä»¤ï¼š # --go-http ä¸ºæˆ‘è‡ªå·±çš„æ’ä»¶ # å…¶ä¸­å‚æ•°æ˜¯ key=v,key2=v2 æ–¹å¼ä¼ ï¼Œæœ€åå†’å·åé¢å†™è¾“å‡ºç›®å½• protoc -I$GOPATH/src/github.com/googleapis/googleapis --proto_path=$GOPATH/src:. --go_out=. --go-http_out=router=gin:. --micro_out=. test.proto æ‰§è¡Œå®Œå‘½ä»¤åï¼Œä¼šç”Ÿæˆä¸‰ä¸ªæ–‡ä»¶åˆ†åˆ«ä¸º test.pb.go,test.pb.micro.goå’Œtest.http.pb.goï¼Œ ç”Ÿæˆçš„æ–‡ä»¶åæ˜¯å¯ä»¥è‡ªå®šä¹‰çš„ã€‚ test.pb.micro.go æ–‡ä»¶æ˜¯ç”± go-micro æä¾›çš„å·¥å…·ç”Ÿæˆ grpc ä»£ç æ–‡ä»¶ã€‚ çœ‹ä¸€ä¸‹ test.http.pb.go æ–‡ä»¶ // Code generated by protoc-gen-go-http. DO NOT EDIT. // versions: // protoc-gen-go-http v0.0.9 package v1 import ( context \"context\" gin \"github.com/gin-gonic/gin\" ) // This is a compile-time assertion to ensure that this generated file // is compatible with the galaxy package it is being compiled against. var _ context.Context const _ = gin.Version type HelloHTTPHandler interface { Add(context.Context, *AddRequest, *AddResponse) error Get(context.Context, *GetRequest, *GetResponse) error } // RegisterHelloHTTPHandler define http router handle by gin. func RegisterHelloHTTPHandler(g *gin.RouterGroup, srv HelloHTTPHandler) { g.POST(\"/api/hello/service/v1/add\", _Hello_Add0_HTTP_Handler(srv)) g.GET(\"/api/hello/service/v1/get\", _Hello_Get0_HTTP_Handler(srv)) } func _Hello_Add0_HTTP_Handler(srv HelloHTTPHandler) func(c *gin.Context) { return func(c *gin.Context) { var ( in AddRequest out AddResponse ) if err := c.ShouldBind(\u0026in); err != nil { c.AbortWithStatusJSON(400, gin.H{\"err\": err.Error()}) return } err := srv.Add(context.Background(), \u0026in, \u0026out) if err != nil { c.AbortWithStatusJSON(500, gin.H{\"err\": err.Error()}) return } c.JSON(200, \u0026out) } } func _Hello_Get0_HTTP_Handler(srv HelloHTTPHandler) func(c *gin.Context) { return func(c *gin.Context) { var ( in GetRequest out GetResponse ) if err := c.ShouldBind(\u0026in); err != nil { c.AbortWithStatusJSON(400, gin.H{\"err\": err.Error()}) return } err := srv.Get(context.Background(), \u0026in, \u0026out) if err != nil { c.AbortWithStatusJSON(500, gin.H{\"err\": err.Error()}) return } c.JSON(200, \u0026out) } } é‡ç‚¹æ˜¯ RegisterHelloHTTPHandler æ–¹æ³•ï¼Œè¿™æ ·æˆ‘å°±æ³¨å†Œä¸€ä¸ª gin.RouterGroup å’Œ HelloHTTPHandler å°±å¯ä»¥ç›´æ¥æä¾›ä¸€ä¸ª http æœåŠ¡ HelloHTTPHandler æ¥å£é‡Œæ–¹æ³•çš„ç­¾åä¸go-microç”Ÿæˆçš„ grpc æ–¹æ³•ä¿æŒäº†ä¸€è‡´ï¼Œ è¿™æ ·æˆ‘åªéœ€è¦å®ç° grpc çš„ä»£ç é‡Œå¯¹åº”çš„ Interface{} æ¥å£ï¼Œå°±å¯ä»¥æœç”¨ï¼Œå®Œå…¨ä¸ä¼šäº§ç”Ÿå¤šä½™ä»£ç ã€‚ go-micro ç”Ÿæˆçš„ pb ä»£ç ç‰‡æ®µï¼š type HelloHandler interface { Add(context.Context, *AddRequest, *AddResponse) error Get(context.Context, *GetRequest, *GetResponse) error } func RegisterHelloHandler(s server.Server, hdlr HelloHandler, opts ...server.HandlerOption) error {} æˆ‘åœ¨ main å‡½æ•°æ³¨å†Œçš„æ—¶å€™ä¹Ÿåªéœ€è¦å¤šæ³¨å†Œä¸€æ¬¡ http handler å³å¯ï¼Œ main.go // å®ƒå®ç°äº† HelloHandler type implHello struct{} RegisterHelloHandler(micro.Server, \u0026implHello) g := gin.New() // implHello å®ç°HelloHandler é‚£å°±æ˜¯å®ç°äº†HelloHTTPHandler RegisterHelloHTTPHandler(g.Group(\"/\"), \u0026implHello) æ‰€ä»¥æˆ‘å°±å¾ˆå®¹æ˜“é€šè¿‡ http æ¥å£è°ƒè¯• grpc æ–¹æ³•ï¼Œç”šè‡³å¯ä»¥å¯¹å¤–æä¾›æœåŠ¡ï¼Œä¸€ä¸¾ä¸¤å¾—ã€‚ ","date":"2021-07-08","objectID":"/posts/go-protoc-http/:2:0","tags":["go","grpc","protoc"],"title":"å¦‚ä½•è‡ªå®šä¹‰ protoc æ’ä»¶","uri":"/posts/go-protoc-http/"},{"categories":["proto"],"content":"å¦‚ä½•å®ç° ","date":"2021-07-08","objectID":"/posts/go-protoc-http/:3:0","tags":["go","grpc","protoc"],"title":"å¦‚ä½•è‡ªå®šä¹‰ protoc æ’ä»¶","uri":"/posts/go-protoc-http/"},{"categories":["proto"],"content":"ç¨‹åºå…¥å£ main.go package main import ( \"flag\" \"google.golang.org/protobuf/compiler/protogen\" \"google.golang.org/protobuf/types/pluginpb\" ) // protoc-gen-go-http å·¥å…·ç‰ˆæœ¬ // ä¸ GalaxyMicroVersion ä¿æŒä¸€è‡´ const version = \"v0.0.12\" func main() { // 1. ä¼ å‚å®šä¹‰ // å³ æ’ä»¶æ˜¯æ”¯æŒè‡ªå®šä¹‰å‚æ•°çš„ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥æ›´åŠ çµæ´»ï¼Œé’ˆå¯¹ä¸åŒçš„åœºæ™¯ç”Ÿæˆä¸åŒçš„ä»£ç  var flags flag.FlagSet // æ˜¯å¦å¿½ç•¥æ²¡æœ‰æŒ‡å®š google.api çš„æ–¹æ³• omitempty := flags.Bool(\"omitempty\", true, \"omit if google.api is empty\") // æˆ‘è¿™é‡ŒåŒæ—¶æ”¯æŒäº† gin å’Œ iris å¯ä»¥é€šè¿‡å‚æ•°æŒ‡å®šç”Ÿæˆ routerEngine := flags.String(\"router\", \"gin\", \"http router engine, choose between gin and iris\") // æ˜¯å¦ç”Ÿæ ¡éªŒä»£ç å— // å‘ç°äº†ä¸€ä¸ªå¾ˆæœ‰ç”¨çš„æ’ä»¶ github.com/envoyproxy/protoc-gen-validate // å¯ä»¥åœ¨ pb çš„ message ä¸­è®¾ç½®å‚æ•°è§„åˆ™ï¼Œç„¶åä¼šç”Ÿæˆä¸€ä¸ª validate.go çš„æ–‡ä»¶ é’ˆå¯¹æ¯ä¸ª message ç”Ÿæˆä¸€ä¸ª Validate() æ–¹æ³• // æˆ‘åœ¨æ¯ä¸ª handler å¤„ç†ä¸šåŠ¡å‰åšäº†ä¸€æ¬¡å‚æ•°æ ¡éªŒåˆ¤æ–­ï¼Œé€šè¿‡è¿™ä¸ª flag æ§åˆ¶æ˜¯å¦ç”Ÿæˆè¿™æ®µæ ¡éªŒä»£ç  genValidateCode := flags.Bool(\"validate\", false, \"add validate request params in handler\") // ç”Ÿæˆä»£ç æ—¶å‚æ•° è¿™ä¹ˆä¼ ï¼š--go-http_out=router=iris,validate=true:. gp := \u0026GenParam{ Omitempty: omitempty, RouterEngine: routerEngine, GenValidateCode: genValidateCode, } // è¿™é‡Œå°±æ˜¯å…¥å£ï¼ŒæŒ‡å®š option åæ‰§è¡Œ Run æ–¹æ³• ï¼Œæˆ‘ä»¬çš„ä¸»é€»è¾‘å°±æ˜¯åœ¨ Run æ–¹æ³• protogen.Options{ ParamFunc: flags.Set, }.Run(func(gen *protogen.Plugin) error { gen.SupportedFeatures = uint64(pluginpb.CodeGeneratorResponse_FEATURE_PROTO3_OPTIONAL) for _, f := range gen.Files { if !f.Generate { continue } // è¿™é‡Œæ˜¯æˆ‘ä»¬çš„ç”Ÿæˆä»£ç æ–¹æ³• generateFile(gen, f, gp) } return nil }) } type GenParam struct { Omitempty *bool RouterEngine *string GenValidateCode *bool } ","date":"2021-07-08","objectID":"/posts/go-protoc-http/:3:1","tags":["go","grpc","protoc"],"title":"å¦‚ä½•è‡ªå®šä¹‰ protoc æ’ä»¶","uri":"/posts/go-protoc-http/"},{"categories":["proto"],"content":"è¯»å– pb æ–‡ä»¶å®šä¹‰ http.go import ( \"fmt\" \"strings\" \"google.golang.org/genproto/googleapis/api/annotations\" \"google.golang.org/protobuf/compiler/protogen\" \"google.golang.org/protobuf/proto\" \"google.golang.org/protobuf/types/descriptorpb\" ) const ( contextPackage = protogen.GoImportPath(\"context\") ginPackage = protogen.GoImportPath(\"github.com/gin-gonic/gin\") irisPackage = protogen.GoImportPath(\"github.com/kataras/iris/v12\") ) var methodSets = make(map[string]int) // generateFile generates a _http.pb.go file containing gin/iris handler. func generateFile(gen *protogen.Plugin, file *protogen.File, gp *GenParam) *protogen.GeneratedFile { if len(file.Services) == 0 || (*gp.Omitempty \u0026\u0026 !hasHTTPRule(file.Services)) { return nil } // è¿™é‡Œæˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰æ–‡ä»¶å filename := file.GeneratedFilenamePrefix + \".pb.http.go\" g := gen.NewGeneratedFile(filename, file.GoImportPath) // å†™å…¥ä¸€äº›è­¦å‘Šä¹‹ç±»çš„ å‘Šè¯‰ç”¨æˆ·ä¸è¦ä¿®æ”¹ g.P(\"// Code generated by protoc-gen-go-http. DO NOT EDIT.\") g.P(\"// versions:\") g.P(fmt.Sprintf(\"// protoc-gen-go-http %s\", version)) g.P() g.P(\"package \", file.GoPackageName) g.P() generateFileContent(gen, file, g, gp) return g } // generateFileContent generates the _http.pb.go file content, excluding the package statement. func generateFileContent(gen *protogen.Plugin, file *protogen.File, g *protogen.GeneratedFile, gp *GenParam) { if len(file.Services) == 0 { return } // import // è¿™é‡Œæœ‰ä¸ªæ’æ›²ï¼šå…¶å® import ç›¸å…³çš„ä»£ç æˆ‘ä»¬è¿™ä¹ˆä¸éœ€è¦ç‰¹æ®ŠæŒ‡å®šï¼Œprotogen åŒ…ä¼šå¸®æˆ‘ä»¬å¤„ç†ï¼Œ // ä½†æ˜¯import çš„ path å‰çš„åˆ«åé»˜è®¤å– path æœ€åä¸€ä¸ª `/` ä¹‹åçš„å­—ç¬¦ï¼Œ // æ¯”å¦‚ï¼šgithub.com/kataras/iris/v12 è¢«å¤„ç†æˆ v12 \"github.com/kataras/iris/v12\" // è¿™ä¸ªæˆ‘ä¸å¤ªæ„¿æ„æ¥å— æ‰€ä»¥è‡ªå·±å†™å…¥ import g.P(\"// This imports are custom by galaxy micro framework.\") g.P(\"import (\") switch *gp.RouterEngine { case \"gin\": g.P(\"gin\", \" \", ginPackage) case \"iris\": g.P(\"iris\", \" \", irisPackage) } g.P(\")\") // æ³¨ï¼š æˆ‘ä»¬éš¾å…æœ‰ä¸€äº› _ \"my/package\" è¿™ç§éœ€æ±‚ï¼Œè¿™å…¶å®ä¸ç”¨è‡ªå·±å†™ ç›´æ¥è°ƒ g.Import(\"my/package\") å°±å¯ä»¥ // è¿™é‡Œå®šä¹‰ä¸€å †å˜é‡æ˜¯ä¸ºäº†ç¨‹åºç¼–è¯‘çš„æ—¶å€™ç¡®ä¿è¿™äº›åŒ…æ˜¯æ­£ç¡®çš„ï¼Œå¦‚æœåŒ…ä¸å­˜åœ¨æˆ–è€…è¿™äº›å®šä¹‰çš„åŒ…å˜é‡ä¸å­˜åœ¨éƒ½ä¼šç¼–è¯‘å¤±è´¥ g.P(\"// This is a compile-time assertion to ensure that this generated file\") g.P(\"// is compatible with the galaxy package it is being compiled against.\") // åªè¦è°ƒç”¨è¿™ä¸ª Ident æ–¹æ³• å°±ä¼šè‡ªåŠ¨å†™å…¥åˆ° import ä¸­ ï¼Œæ‰€ä»¥å¦‚æœå¯¹ import çš„åŒ…åæ²¡æœ‰ç‰¹æ®Šè¦æ±‚ï¼Œé‚£å°±ç›´æ¥ä½¿ç”¨ Ident g.P(\"var _ \", contextPackage.Ident(\"Context\")) // åƒæˆ‘è‡ªå·±è‡ªå®šä¹‰ import çš„åŒ…å°±ä¸è¦ä½¿ç”¨ Ident æ–¹æ³•ï¼Œå¦åˆ™ç”Ÿæˆçš„ä»£ç æ–‡ä»¶é‡Œæœ‰ä¸¤ä¸ªåŒä¸€ä¸ªåŒ…çš„å¼•å…¥å¯¼è‡´è¯­æ³•é”™è¯¯ switch *gp.RouterEngine { case \"gin\": g.P(\"const _ = \", \"gin.\", \"Version\") case \"iris\": g.P(\"const _ = \", \"iris.\", \"Version\") } g.P() // åˆ°è¿™é‡Œæˆ‘ä»¬å°±æŠŠåŒ…å import å’Œå˜é‡å†™å…¥æˆåŠŸäº†ï¼Œå‰©ä¸‹çš„å°±æ˜¯é’ˆå¯¹ rpc service ç”Ÿæˆå¯¹åº”çš„ handler for _, service := range file.Services { genService(gen, file, g, service, gp) } } // rpc service ä¿¡æ¯ type serviceDesc struct { ServiceType string // Greeter ServiceName string // helloworld.Greeter Metadata string // api/helloworld/helloworld.proto GenValidate bool Methods []*methodDesc MethodSets map[string]*methodDesc } // rpc æ–¹æ³•ä¿¡æ¯ type methodDesc struct { // method Name string Num int Request string Reply string // http_rule Path string Method string CamelCaseMethod string HasVars bool HasBody bool Body string ResponseBody string } // ç”Ÿæˆ service ç›¸å…³ä»£ç  func genService(gen *protogen.Plugin, file *protogen.File, g *protogen.GeneratedFile, service *protogen.Service, gp *GenParam) { if service.Desc.Options().(*descriptorpb.ServiceOptions).GetDeprecated() { g.P(\"//\") g.P(deprecationComment) } // HTTP Server. // æœåŠ¡çš„ä¸»è¦å˜é‡ï¼Œæ¯”å¦‚æœåŠ¡å æœåŠ¡ç±»å‹ç­‰ sd := \u0026serviceDesc{ ServiceType: service.GoName, ServiceName: string(service.Desc.FullName()), Metadata: file.Desc.Path(), GenValidate: *gp.GenValidateCode, } // å¼€å§‹éå†æœåŠ¡çš„æ–¹æ³• for _, method := range service.Methods { // ä¸å¤„ç† if method.Desc.IsStreamingClient() || method.Desc.IsStreamingServer() { continue } // annotations è¿™ä¸ªå°±æ˜¯æˆ‘ä»¬åœ¨ rpc æ–¹æ³•é‡Œ option é‡Œå®šä¹‰çš„ http è·¯ç”± rule, ok := proto.GetExtension(method.Desc.Options(), annotations.E_Http).(*annotations.HttpRule) if rule != nil \u0026\u0026 ok { for _, bind := range rule.AdditionalBindings { // æ‹¿åˆ° optioné‡Œå®šä¹‰çš„è·¯ç”±ï¼Œ http methodç­‰ä¿¡æ¯ sd.Methods = append(sd.Methods, buildHTTPRule(g, method, bind)) } sd.Methods = append(sd.Methods, buildHTTPRule(g, method, rule)) } else if !*gp.Omitempty { path := fmt.Sprint","date":"2021-07-08","objectID":"/posts/go-protoc-http/:3:2","tags":["go","grpc","protoc"],"title":"å¦‚ä½•è‡ªå®šä¹‰ protoc æ’ä»¶","uri":"/posts/go-protoc-http/"},{"categories":["proto"],"content":"æ¨¡æ¿æ¸²æŸ“ // execute æ–¹æ³•å®ç°ä¹Ÿå…¶å®ä¸å¤æ‚ï¼Œæ€»èµ·æ¥å°±æ˜¯ go çš„ temple åŒ…çš„ä½¿ç”¨ // æå‰å†™å¥½æ¨¡æ¿æ–‡ä»¶ï¼Œç„¶åæ‹¿åˆ°æ‰€æœ‰éœ€è¦çš„å˜é‡ï¼Œè¿›è¡Œæ¨¡æ¿æ¸²æŸ“ï¼Œå†™å…¥æ–‡ä»¶ func (s *serviceDesc) execute(routerEngine string) string { var ( name = routerEngine tmp string ) switch routerEngine { case \"gin\": tmp = ginTemplate case \"iris\": tmp = irisTemplate default: panic(\"unknown http engine\") } s.MethodSets = make(map[string]*methodDesc) for _, m := range s.Methods { s.MethodSets[m.Name] = m } buf := new(bytes.Buffer) tmpl, err := template.New(name).Parse(strings.TrimSpace(tmp)) if err != nil { panic(err) } if err = tmpl.Execute(buf, s); err != nil { panic(err) } return strings.Trim(buf.String(), \"\\r\\n\") } ","date":"2021-07-08","objectID":"/posts/go-protoc-http/:3:3","tags":["go","grpc","protoc"],"title":"å¦‚ä½•è‡ªå®šä¹‰ protoc æ’ä»¶","uri":"/posts/go-protoc-http/"},{"categories":["proto"],"content":"æ¨¡æ¿å†…å®¹ var ginTemplate = ` {{$svrType := .ServiceType}} {{$svrName := .ServiceName}} {{$validate := .GenValidate}} // è¿™é‡Œå®šä¹‰ handler interface type {{.ServiceType}}HTTPHandler interface { {{- range .MethodSets}} {{.Name}}(context.Context, *{{.Request}}, *{{.Reply}}) error {{- end}} } // Register{{.ServiceType}}HTTPHandler define http router handle by gin. // æ³¨å†Œè·¯ç”± handler func Register{{.ServiceType}}HTTPHandler(g *gin.RouterGroup, srv {{.ServiceType}}HTTPHandler) { {{- range .Methods}} g.{{.Method}}(\"{{.Path}}\", _{{$svrType}}_{{.Name}}{{.Num}}_HTTP_Handler(srv)) {{- end}} } // å®šä¹‰ handler // éå†ä¹‹å‰è§£æåˆ°æ‰€æœ‰ rpc æ–¹æ³•ä¿¡æ¯ {{range .Methods}} func _{{$svrType}}_{{.Name}}{{.Num}}_HTTP_Handler(srv {{$svrType}}HTTPHandler) func(c *gin.Context) { return func(c *gin.Context) { var ( in = new({{.Request}}) out = new({{.Reply}}) ctx = middleware.GetContextFromGinCtx(c) ) if err := c.ShouldBind(in{{.Body}}); err != nil { c.AbortWithStatusJSON(400, gin.H{\"err\": err.Error()}) return } // è¿™é‡Œå°±æ˜¯æœ€å¼€å§‹æåˆ°çš„åˆ¤æ–­æ˜¯å¦å¯ç”¨ validate // å…¶ä¸­è¿™ä¸ª api.Validator æ¥å£åªæœ‰ä¸€ä¸ªæ–¹æ³• Validate() error // æ‰€ä»¥éœ€è¦åœ¨ä¸€ä¸ªç»Ÿä¸€çš„åœ°æ–¹å®šä¹‰å¥½å¼•å…¥ä½¿ç”¨ï¼Œå»ºè®®ä¸è¦åœ¨ç”Ÿæˆçš„æ—¶å€™å†™å…¥ï¼Œå› ä¸ºè¿™ä¸ªæ˜¯é€šç”¨çš„ interface{} {{if $validate -}} // check param if v, ok := interface{}(in).(api.Validator);ok { if err := v.Validate();err != nil { c.AbortWithStatusJSON(400, gin.H{\"err\": err.Error()}) return } } {{end -}} // æ‰§è¡Œæ–¹æ³• err := srv.{{.Name}}(ctx, in, out) if err != nil { c.AbortWithStatusJSON(500, gin.H{\"err\": err.Error()}) return } c.JSON(200, out) } } {{end}} ` iris çš„æ¨¡æ¿åŸºæœ¬ç±»ä¼¼ã€‚ åˆ°è¿™é‡Œä»£ç éƒ¨åˆ†å®Œå…¨ç»“æŸï¼Œåšä¸€ä¸ªç®€å•çš„æ€»ç»“ï¼š æ„æ€éœ€æ±‚ï¼Œå³æˆ‘éœ€è¦ä»€ä¹ˆæ ·çš„æ’ä»¶ï¼Œå®ƒéœ€è¦ç»™æˆ‘ç”Ÿæˆä»€ä¹ˆçš„ä»£ç å—ï¼Ÿ æ ¹æ®éœ€æ±‚å…ˆè‡ªå·±å†™ä¸€ä¸ªé¢„æœŸä»£ç ï¼Œç„¶åæŠŠè¿™ä»½ä»£ç æ‹†è§£æˆä¸€ä¸ªæ¨¡æ¿ï¼Œæå–é‡Œé¢çš„å¯ä»¥æ¸²æŸ“çš„å˜é‡ã€‚ æ¨¡æ¿é‡Œå¯ä»¥æœ‰é€»è¾‘ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥åšä¸€äº›å‚æ•°æ ¡éªŒçš„æ–¹å¼ï¼Œç”Ÿæˆä¸åŒçš„ä»£ç ï¼Œæ¯”å¦‚é’ˆå¯¹ä¸åŒçš„ http æ–¹æ³•ï¼Œåšä¸åŒçš„å¤„ç†ï¼Œé’ˆå¯¹ä¸åŒçš„æ’ä»¶å‚æ•°ç”Ÿæˆä¸åŒçš„ä»£ç å—ã€‚ ç¨‹åºå…¥å£åˆ°æ¸²æŸ“æ–‡ä»¶å‰è¿™æ®µä»£ç ï¼ŒåŸºæœ¬éƒ½ç”¨ protogen åŒ…æä¾›çš„æ–¹æ³•ï¼Œå¯ä»¥å¯¹è¿™ä¸ªåŒ…åšä¸€äº›è°ƒç ”é˜…è¯»æ–‡æ¡£ï¼Œçœ‹çœ‹å®ƒéƒ½æä¾›ä»€ä¹ˆèƒ½åŠ›, è¯´ä¸å®šå¯ä»¥å°‘èµ°å¾ˆå¤šå¼¯è·¯ã€‚ åŸºæœ¬å°±è¿™äº›äº†ï¼Œæˆ‘ä¹Ÿæ˜¯å„ç§ç¢ç£¨ç¢ç£¨å‡ºæ¥çš„ï¼Œå»ºè®®å¤§å®¶å¤šåŠ¨æ‰‹ï¼Œåªè¦ä¸å†™æ°¸è¿œå­¦ä¸åˆ°ç²¾é«“ã€‚ ","date":"2021-07-08","objectID":"/posts/go-protoc-http/:3:4","tags":["go","grpc","protoc"],"title":"å¦‚ä½•è‡ªå®šä¹‰ protoc æ’ä»¶","uri":"/posts/go-protoc-http/"},{"categories":["Go"],"content":"å…³äºå¦‚ä½•ç”¨ go è¯­è¨€ç¼–å†™ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ã€‚è¿™é‡Œä¼šåŸºäº cobra å¼€æºåº“è¿›è¡Œå¼€å‘ã€‚cobra ä½œä¸ºä¸€ä¸ªéå¸¸æœ‰åçš„å‘½ä»¤è¡Œå·¥å…·åº“ï¼Œè¢«å¾ˆå¤šå¼€æºé¡¹ç›®å¼•å…¥ä½¿ç”¨ï¼Œå¾ˆå¤šå‘½ä»¤è¡Œå·¥å…·éƒ½èƒ½çœ‹åˆ° cobra çš„èº«å½±ã€‚cobra æä¾›ä¸€ä¸ªå®Œæ•´çš„å‘½ä»¤è¡Œçš„å·¥å…·çš„æ‰€éœ€çš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬å‘½ä»¤å®šä¹‰ã€å‘½ä»¤æ‰©å±•ã€è¯»å–å‚æ•°ç­‰ã€‚ä¸‹é¢æˆ‘ä»¬ä»¥å¼€å‘ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·çš„æµç¨‹ä¸€æ­¥æ­¥å­¦ä¹ å¦‚ä½•ä½¿ç”¨ cobra å¼€å‘ä¸€ä¸ªè‡ªå·±çš„å‘½ä»¤è¡Œå·¥å…·ã€‚ ","date":"2021-06-30","objectID":"/posts/go-cobra/:0:0","tags":["go","cobra"],"title":"å¦‚ä½•ç¼–å†™è‡ªå·±çš„ç¬¬ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·","uri":"/posts/go-cobra/"},{"categories":["Go"],"content":"åˆ›å»ºæ ¹å‘½ä»¤ æˆ‘ä»¬é¡¹ç›®æš‚ä¸”å°±å« myCmd, æˆ‘ä»¬æœ¬åœ°åˆ›å»ºä¸€ä¸ªgoé¡¹ç›®å°±å« myCmdã€‚ $ mkdir myCmd $ cd myCmd $ touch main.go $ go mod init myCmd main.go package main import ( \"log\" \"github.com/spf13/cobra\" ) var ( // å®šä¹‰ä¸»å‘½ä»¤ rootCmd = \u0026cobra.Command{ Use: \"myCmd\", Short: \"è¿™é‡Œæ˜¯å¯¹å‘½ä»¤çš„ç®€çŸ­ä»‹ç»\", Long: `è¿™é‡Œå¯ä»¥æ”¾å¯¹å‘½ä»¤çš„è¯¦ç»†ä»‹ç»ã€‚ å¯ä»¥å¤šè¡Œ`, Example: \"myCmd help\", // ä½¿ç”¨ç¤ºä¾‹ Version: \"v0.0.1\", // å®šä¹‰ç‰ˆæœ¬ } dirPath string ) func init() { // å®šä¹‰å‚æ•°ï¼Œå³ä»å‘½ä»¤è¡Œè¯»å–çš„å‚æ•°å˜é‡ // é™¤äº† PersistentFlags å¤–ï¼Œä¹Ÿå¯ä»¥ç”¨ Flags()ï¼ŒåŒºåˆ«æ˜¯ å‰ä¸€ä¸ªå¯ä»¥åœ¨å…¶å­å‘½ä»¤ä¹Ÿå¯ä»¥ç”¨ï¼Œåä¸€ä¸ªä¸èƒ½ã€‚å³PersistentFlagsæ˜¯ä¸€ä¸ªå…¨å±€çš„flagæ³¨å†Œã€‚ rootCmd.PersistentFlags().StringVarP(\u0026dirPath, \"dir\", \"d\", \".\", \"æ–‡ä»¶è·¯å¾„\") } func main() { if err := rootCmd.Execute(); err != nil { log.Fatal(err) } } è¿™æ ·æˆ‘ä»¬å°±åˆ›å»ºäº†ä¸€ä¸ªå±äºçš„è‡ªå·±çš„å‘½ä»¤ï¼Œæ‰§è¡Œçœ‹ä¸€ä¸‹æ•ˆæœã€‚ # ç›´æ¥æ‰§è¡Œ,ä¼šæ‰“å° å­—æ®µLongçš„å€¼ï¼Œ âœ./myCmd è¿™é‡Œå¯ä»¥æ”¾å¯¹å‘½ä»¤çš„è¯¦ç»†ä»‹ç»ã€‚ å¯ä»¥å¤šè¡Œ # æ‰“å°ç‰ˆæœ¬ âœ./myCmd -v myCmd version v0.0.1 # è¾“å…¥æœªçŸ¥ flag âœ./myCmd -x Error: unknown shorthand flag: 'x' in -x Usage: Examples: myCmd help Flags: -d, --dir string æ–‡ä»¶è·¯å¾„ (default \".\") -h, --help help for myCmd -v, --version version for myCmd 2021/07/04 15:18:59 unknown shorthand flag: 'x' in -x ä¸éš¾å‘ç°ï¼Œç‰ˆæœ¬å¤„ç†ï¼ŒæœªçŸ¥å‚æ•°å¤„ç†ç­‰æƒ…å†µ cobraå·²ç»åšäº†ç›¸å¯¹å®Œå–„çš„å¤„ç†ï¼Œæˆ‘ä»¬ä¸éœ€è¦åšå¤ªå¤šçš„é”™è¯¯å¤„ç†ã€‚ ç›®å‰æœªçŸ¥ï¼Œæˆ‘ä»¬çš„çš„å‘½ä»¤åªæ˜¯å®šä¹‰äº†å‘½ä»¤ï¼Œå¹¶æ²¡æœ‰æ‰§è¡Œä»»ä½•æŒ‡ä»¤ï¼Œä¸‹é¢æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªç®€å•çš„æ‰§è¡Œå‡½æ•°ã€‚cobra.Command æœ‰å¾ˆå¤šå‚æ•°å¯ä»¥å®šä¹‰æ‰§è¡Œå‡½æ•°çš„ï¼Œæˆ‘ä»¬ä»¥æœ€å¸¸ç”¨çš„çš„ Runï¼ŒRunE ä¸ºä¾‹ï¼Œåˆ†åˆ«æ˜¯ä¸è¿”å›é”™è¯¯å’Œè¿”å›é”™è¯¯çš„å‡½æ•°å®šä¹‰ã€‚ å‡å¦‚æˆ‘ä»¬çš„ä¸»å‘½ä»¤æ‰§è¡Œä¸€ä¸ªæ‰“å° d å‚æ•°ä¼ å€¼çš„ç›®å½•çš„ä¿¡æ¯ã€‚ // rootCmd RunE: printDirInfo, /* ... */ func printDirInfo(cmd *cobra.Command, args []string) error { info, err := os.Stat(dirPath) if err != nil { return err } fmt.Printf(\"name:%s, size:%d modTime:%v \\n\", info.Name(), info.Size(), info.ModTime()) return nil } æ‰§è¡Œä¸€ä¸‹å‘½ä»¤ï¼š # æŸ¥çœ‹ä¸€ä¸‹ main æ–‡ä»¶çš„ä¿¡æ¯ âœ./myCmd -d main.go name:main.go, size:759 modTime:2021-07-04 15:26:43.311399368 +0800 CST # æŸ¥çœ‹ä¸€ä¸ªä¸å­˜åœ¨çš„æ–‡ä»¶ âœ./myCmd -d main.go1 Error: stat main.go1: no such file or directory Usage: myCmd [flags] Examples: myCmd help Flags: -d, --dir string å‘½ä»¤æ‰§è¡Œç›®å½• (default \".\") -h, --help help for myCmd -v, --version version for myCmd 2021/07/04 15:30:01 stat main.go1: no such file or directory # ä¸ä»…æ‰“å°å‡ºé”™è¯¯ï¼Œå¦‚ä½•ä½¿ç”¨å‘½ä»¤ä¹Ÿä¼šåŒæ—¶æ‰“å°å‡ºæ¥ ä¸‹é¢æˆ‘ä»¬å°±æ·»åŠ æˆ‘ä»¬çš„å­å‘½ä»¤ã€‚ ","date":"2021-06-30","objectID":"/posts/go-cobra/:1:0","tags":["go","cobra"],"title":"å¦‚ä½•ç¼–å†™è‡ªå·±çš„ç¬¬ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·","uri":"/posts/go-cobra/"},{"categories":["Go"],"content":"æ·»åŠ å­å‘½ä»¤ æˆ‘ä»¬ç°åœ¨æ·»åŠ ä¸€ä¸ªå­å‘½ä»¤ï¼Œè¿™ä¸ªå­å‘½ä»¤çš„åŠŸèƒ½æ˜¯ç»Ÿè®¡å½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ä¿¡æ¯ï¼Œæˆ‘ä»¬å°±èµ·åå« statã€‚åŒæ—¶ï¼Œä¸ºäº†æ–¹ä¾¿å…¨å±€å˜é‡çš„åœ¨ä¸åŒåŒ…å†…è¯»å–ï¼Œåˆ›å»ºä¸€ä¸ª variable çš„ç›®å½•ï¼Œé‡Œé¢å­˜æ”¾å…¨å±€çš„ä¸€äº›å˜é‡ï¼ŒåŒ…å†…å˜é‡å°±æ”¾åˆ°å„è‡ªåŒ…å†…ã€‚ âœ mkdir stat âœ mkdir variable âœ touch stat/stat.go âœ touch variable/variable.go ä¸‹é¢æ˜¯statæ–‡ä»¶çš„å†…å®¹ã€‚ stat.go package stat import ( \"fmt\" \"myCmd/variable\" \"os\" \"path/filepath\" \"github.com/spf13/cobra\" ) var ( StatCmd = \u0026cobra.Command{ Use: \"stat\", Short: \"ç»Ÿè®¡ç›®å½•\", RunE: statDir, } isStatDir bool ) func init() { // è¿™é‡Œä½¿ç”¨ Flags åªåœ¨æˆ‘è¿™ä¸ªå‘½ä»¤å†…è§£æå’Œè¯»å– StatCmd.Flags().BoolVarP(\u0026isStatDir, \"stat_dir\", \"s\", false, \"æ˜¯å¦ç»Ÿè®¡ç›®å½•ä¿¡æ¯\") } func statDir(cmd *cobra.Command, args []string) error { return filepath.Walk(variable.DirPath, func(path string, info os.FileInfo, err error) error { if err != nil { return err } if info.IsDir() \u0026\u0026 !isStatDir { // ä¸ç»Ÿè®¡ return nil } fmt.Printf(\"path:%s, size:%d, modTime:%v\", path, info.Size(), info.ModTime()) return nil }) } ç„¶åå°†è¯¥å­å‘½ä»¤æ³¨å†Œçš„ä¸»å‘½ä»¤ä¸‹ã€‚ main.go package main import ( \"fmt\" \"log\" \"myCmd/stat\" \"myCmd/variable\" \"os\" \"github.com/spf13/cobra\" ) var ( rootCmd = \u0026cobra.Command{ Use: \"myCmd\", Short: \"è¿™é‡Œæ˜¯å¯¹å‘½ä»¤çš„ç®€çŸ­ä»‹ç»\", Long: `è¿™é‡Œå¯ä»¥æ”¾å¯¹å‘½ä»¤çš„è¯¦ç»†ä»‹ç»ã€‚ å¯ä»¥å¤šè¡Œ`, Example: \"myCmd help\", // ä½¿ç”¨ç¤ºä¾‹ Version: variable.Version, // å…¨å±€å˜é‡å¸¸é‡éƒ½ç§»åˆ° variable ç›®å½•ä¸‹ RunE: printDirInfo, } ) func init() { rootCmd.PersistentFlags().StringVarP(\u0026variable.DirPath, \"dir\", \"d\", \".\", \"æ–‡ä»¶è·¯å¾„\") // æ³¨å†Œå‘½ä»¤ rootCmd.AddCommand(stat.StatCmd) } func printDirInfo(cmd *cobra.Command, args []string) error { info, err := os.Stat(variable.DirPath) if err != nil { return err } fmt.Printf(\"name:%s, size:%d modTime:%v \\n\", info.Name(), info.Size(), info.ModTime()) return nil } func main() { if err := rootCmd.Execute(); err != nil { log.Fatal(err) } } å†æ¬¡æ‰§è¡Œ help æŸ¥çœ‹æˆ‘ä»¬çš„å‘½ä»¤ã€‚ âœ./myCmd -h è¿™é‡Œå¯ä»¥æ”¾å¯¹å‘½ä»¤çš„è¯¦ç»†ä»‹ç»ã€‚ å¯ä»¥å¤šè¡Œ Usage: myCmd [flags] myCmd [command] Examples: myCmd help Available Commands: help Help about any command stat ç»Ÿè®¡ç›®å½• Flags: -d, --dir string æ–‡ä»¶è·¯å¾„ (default \".\") -h, --help help for myCmd -v, --version version for myCmd Use \"myCmd [command] --help\" for more information about a command. # æŸ¥çœ‹å­å‘½ä»¤help âœ./myCmd stat -h ç»Ÿè®¡ç›®å½• Usage: myCmd stat [flags] Flags: -h, --help help for stat -s, --stat_dir æ˜¯å¦ç»Ÿè®¡ç›®å½•ä¿¡æ¯ Global Flags: -d, --dir string æ–‡ä»¶è·¯å¾„ (default \".\") # ç»Ÿè®¡ âœ./myCmd stat -d . path:go.mod, size:61, modTime:2021-07-04 15:03:33.339495852 +0800 CST path:go.sum, size:56568, modTime:2021-07-04 15:03:33.339185898 +0800 CST path:main.go, size:929, modTime:2021-07-04 15:55:07.206300444 +0800 CST path:myCmd, size:4344056, modTime:2021-07-04 16:01:12.930132286 +0800 CST path:stat/stat.go, size:691, modTime:2021-07-04 16:01:09.353487727 +0800 CST path:variable/variable.go, size:73, modTime:2021-07-04 15:48:18.345134258 +0800 CST ä¸éš¾å‘ç°ï¼Œè¿™ä¸ªå­å‘½ä»¤å¯ä»¥æ— é™åµŒå¥—ï¼Œæˆ‘ä»¬å¯ä»¥æ‹¥æœ‰äºŒçº§ä¸‰çº§å­å‘½ä»¤ï¼Œèƒ½æ»¡è¶³æˆ‘ä»¬å„ç§å„æ ·å¥‡è‘©çš„éœ€æ±‚ï¼Œå­å‘½ä»¤å¯ä»¥å¤ç”¨å…¶ä¸Šçº§ç›®å½•çš„ flagå‚æ•°ã€‚ ","date":"2021-06-30","objectID":"/posts/go-cobra/:2:0","tags":["go","cobra"],"title":"å¦‚ä½•ç¼–å†™è‡ªå·±çš„ç¬¬ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·","uri":"/posts/go-cobra/"},{"categories":["Go"],"content":"è‡ªä¸»æ›´æ–° å‡å¦‚æˆ‘ä»¬å¼€å‘å‘½ä»¤ï¼Œå·²ç»å‘å¸ƒåˆ° GitHub ä¸Šï¼Œåˆ«äººå¯ä»¥ç®€å•çš„ go get å‘½ä»¤å°±èƒ½å®‰è£…ä½¿ç”¨æˆ‘ä»¬çš„å‘½ä»¤ã€‚ä½†æ˜¯æˆ‘è¦æ˜¯å‘å¸ƒä¸€ä¸ªæ–°ç‰ˆæœ¬ï¼Œå¸Œæœ›ä½¿ç”¨çš„äººèƒ½çŸ¥é“æˆ‘çš„å‘½ä»¤å·¥å…·æœ‰æ–°ç‰ˆäº†è€Œä¸”è¦æ˜¯èƒ½æ–¹ä¾¿çš„æ›´æ–°åˆ°æœ€æ–°çš„ç‰ˆæœ¬æ˜¯ä¸æ˜¯ä¸€ä¸ªéå¸¸äººæ€§åŒ–çš„è®¾è®¡å‘¢ï¼Ÿ å…¶å®å®ç°èµ·æ¥ä¹Ÿä¸éš¾ï¼Œè¿™é‡ŒæŠ›å‡ºä¸ªæ€è·¯ã€‚å‡å¦‚æˆ‘ä»¬å‘½ä»¤æ¯æ¬¡æ‰§è¡Œçš„æ—¶å€™ï¼Œæˆ‘åšä¸€æ¬¡ç‰ˆæœ¬æ£€æŸ¥ï¼ˆä½†æ˜¯å¼ºçƒˆä¸å»ºè®®æ¯æ¬¡éƒ½æ£€æŸ¥ï¼Œæœ€å¥½æœ¬åœ°åšä¸€ä¸ªä¸Šæ¬¡æ£€æŸ¥æ—¶é—´çš„ç¼“å­˜ï¼Œæœ€å¤šä¸€å¤©æ£€æŸ¥ä¸€æ¬¡ï¼Œå¦åˆ™ç”¨æˆ·ä½“éªŒéå¸¸ä¸å¥½ï¼‰ï¼Œå¦‚æœæœ‰æ–°çš„ç‰ˆæœ¬æˆ‘å°±æé†’ç”¨æˆ·ï¼Œç”šè‡³æˆ‘å¯ä»¥æ£€æŸ¥çš„æ—¶å€™æ‹‰è¿‡æ¥æ–°ç‰ˆæœ¬çš„ feature å±•ç°ç»™ç”¨æˆ·ï¼Œï¼Œç„¶åæä¾›ä¸€ä¸ª update çš„å­å‘½ä»¤ï¼Œè‡ªæˆ‘æ›´æ–°ï¼Œè¿™ä½“éªŒæ˜¯ä¸æ˜¯å¬èµ·æ¥å°±å¾ˆä¸é”™å‘€ã€‚ è‡³äº update è¿™ä¸ªå­å‘½ä»¤å®ç°ä¹Ÿå¾ˆç®€å•ï¼Œå°è¯•æ‰§è¡Œä¸€æ¬¡ go get -u \u003cmyCmdRemoteURL\u003e å³å¯ï¼Œè™½ç„¶çœ‹èµ·æ¥æ˜¯å¯¹ go get çš„ä¸€æ¬¡å°è£…ï¼Œä½†æ˜¯å¯¹äºç”¨æˆ·æ¥è¯´å°±å¾ˆç®€å•æ–¹ä¾¿ã€‚ ","date":"2021-06-30","objectID":"/posts/go-cobra/:3:0","tags":["go","cobra"],"title":"å¦‚ä½•ç¼–å†™è‡ªå·±çš„ç¬¬ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·","uri":"/posts/go-cobra/"},{"categories":["Go"],"content":"å°å½©è›‹ åˆ°è¿™é‡Œæˆ‘ä»¬ä¸€ä¸ªå°å‘½ä»¤è¡Œå·¥å…·ä¹Ÿæœ‰æ¨¡æœ‰æ ·äº†ï¼Œä½†æ˜¯ç¼ºä¸€ä¸ªçµé­‚ï¼Œæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ å½“ç„¶æ˜¯ å‘½ä»¤çš„ç‚«é…·çš„logoï¼ï¼ï¼ å…ˆçœ‹æ•ˆæœå›¾ï¼š # æ™®é€šç‰ˆæœ¬ __ __ __ __ _____ __ __ _____ | \\/ | \\ \\ / / / ____| | \\/ | | __ \\ | \\ / | \\ \\_/ / | | | \\ / | | | | | | |\\/| | \\ / | | | |\\/| | | | | | | | | | | | | |____ | | | | | |__| | |_| |_| |_| \\_____| |_| |_| |_____/ # æ–œä½“ /| //| | \\\\ / / // ) ) /| //| | // ) ) //| // | | \\\\ / / // //| // | | // / / // | // | | \\\\/ / // // | // | | // / / // | // | | / / // // | // | | // / / // |// | | / / ((____/ / // |// | | //____/ / # å¤¸å¼ ç‰ˆæœ¬ _____ _____ _____ _____ _____ /\\ \\ |\\ \\ /\\ \\ /\\ \\ /\\ \\ /::\\____\\ |:\\____\\ /::\\ \\ /::\\____\\ /::\\ \\ /::::| | |::| | /::::\\ \\ /::::| | /::::\\ \\ /:::::| | |::| | /::::::\\ \\ /:::::| | /::::::\\ \\ /::::::| | |::| | /:::/\\:::\\ \\ /::::::| | /:::/\\:::\\ \\ /:::/|::| | |::| | /:::/ \\:::\\ \\ /:::/|::| | /:::/ \\:::\\ \\ /:::/ |::| | |::| | /:::/ \\:::\\ \\ /:::/ |::| | /:::/ \\:::\\ \\ /:::/ |::|___|______ |::|___|______ /:::/ / \\:::\\ \\ /:::/ |::|___|______ /:::/ / \\:::\\ \\ /:::/ |::::::::\\ \\ /::::::::\\ \\ /:::/ / \\:::\\ \\ /:::/ |::::::::\\ \\ /:::/ / \\:::\\ ___\\ /:::/ |:::::::::\\____\\ /::::::::::\\____\\/:::/____/ \\:::\\____\\/:::/ |:::::::::\\____\\/:::/____/ \\:::| | \\::/ / ~~~~~/:::/ / /:::/~~~~/~~ \\:::\\ \\ \\::/ /\\::/ / ~~~~~/:::/ /\\:::\\ \\ /:::|____| \\/____/ /:::/ / /:::/ / \\:::\\ \\ \\/____/ \\/____/ /:::/ / \\:::\\ \\ /:::/ / /:::/ / /:::/ / \\:::\\ \\ /:::/ / \\:::\\ \\ /:::/ / /:::/ / /:::/ / \\:::\\ \\ /:::/ / \\:::\\ /:::/ / /:::/ / \\::/ / \\:::\\ \\ /:::/ / \\:::\\ /:::/ / /:::/ / \\/____/ \\:::\\ \\ /:::/ / \\:::\\/:::/ / /:::/ / \\:::\\ \\ /:::/ / \\::::::/ / /:::/ / \\:::\\____\\ /:::/ / \\::::/ / \\::/ / \\::/ / \\::/ / \\::/____/ \\/____/ \\/____/ \\/____/ ~~ æˆ‘éšæœºé€‰äº†å‡ ä¸ªä½œä¸ºæ¼”ç¤ºï¼Œç‚¹å‡»è¿™é‡Œè·³è½¬åˆ¶ä½œè‡ªå·±å·¥å…·çš„logoï¼Œç„¶åå†ä¸»å‘½ä»¤æ³¨å†Œä¸€ä¸ª PreRun çš„å‡½æ•°ï¼Œåœ¨è¯¥å‡½æ•°å†…æ‰“å°æˆ‘ä»¬çš„logoã€‚è¿™æ ·åœ¨ä¸»é€»è¾‘æ‰§è¡Œå‰ä¼šæ‰“å°æˆ‘ä»¬çš„logoï¼Œè¾¨è¯†åº¦ä¸€ä¸‹å­æé«˜å¾ˆå¤šã€‚ å®é™…æ•ˆæœï¼š âœ./myCmd -d main.go __ __ __ __ _____ __ __ _____ | \\/ | \\ \\ / / / ____| | \\/ | | __ \\ | \\ / | \\ \\_/ / | | | \\ / | | | | | | |\\/| | \\ / | | | |\\/| | | | | | | | | | | | | |____ | | | | | |__| | |_| |_| |_| \\_____| |_| |_| |_____/ name:main.go, size:1320 modTime:2021-07-04 16:28:51.339520282 +0800 CST æš‚ä¸”å°±è¿™ä¹ˆå¤šï¼Œæ„Ÿè°¢ spf13/cobra çš„ä½œè€…ï¼Œæä¾›è¿™ä¹ˆé«˜è´¨é‡çš„å¼€æºåº“ã€‚ ","date":"2021-06-30","objectID":"/posts/go-cobra/:4:0","tags":["go","cobra"],"title":"å¦‚ä½•ç¼–å†™è‡ªå·±çš„ç¬¬ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·","uri":"/posts/go-cobra/"},{"categories":["microservice"],"content":"go-micro ä½œä¸ºæ¯”è¾ƒæµè¡Œçš„å¾®æœåŠ¡æ¡†æ¶ï¼Œå…¶è‰¯å¥½çš„æ¥å£è®¾è®¡ä¸ºåæœŸæ‰©å±•ä½¿ç”¨å¸¦æ¥äº†éå¸¸å¥½çš„ä¾¿åˆ©æ€§ã€‚æœ¬æ–‡ç« ä¸»è¦è®²åœ¨ go-micro ä¸­ç”¨ nacos ä½œä¸ºæœåŠ¡æ³¨å†Œä¸­å¿ƒå’Œé…ç½®ä¸­å¿ƒã€‚ ","date":"2021-06-23","objectID":"/posts/use-nacos-with-go-micro/:0:0","tags":["go","go-micro"],"title":"Go-Micro ä¸­ä½¿ç”¨Nacos","uri":"/posts/use-nacos-with-go-micro/"},{"categories":["microservice"],"content":"æ³¨å†Œä¸­å¿ƒ å…ˆçœ‹ä¸€ä¸‹ go-micro å®šä¹‰çš„æœåŠ¡æ³¨å†Œæ¥å£ã€‚ registry.go // æœåŠ¡æ³¨å†Œæ¥å£ type Registry interface { // åˆå§‹åŒ– Init(...Option) error // è¿”å›å¯é€‰å‚æ•° Options() Options // æœåŠ¡æ³¨å†Œ Register(*Service, ...RegisterOption) error // æœåŠ¡æ³¨é”€ Deregister(*Service, ...DeregisterOption) error // æŸ¥è¯¢æœåŠ¡ GetService(string, ...GetOption) ([]*Service, error) // åˆ—å‡ºæœåŠ¡ ListServices(...ListOption) ([]*Service, error) // ç›‘å¬æœåŠ¡ Watch(...WatchOption) (Watcher, error) String() string } åªè¦åŸºäºä»»æ„ä¸€ä¸ªæœåŠ¡æ³¨å†ŒæœåŠ¡å®ç°ä»¥ä¸Šæ¥å£ï¼Œå³å¯åœ¨ go-micro ä¸­ä½œä¸ºæ³¨å†Œä¸­å¿ƒä½¿ç”¨ã€‚å‡å¦‚æˆ‘ç”¨ä¸€ä¸ª customRegistry å®ç°æ¥å£åï¼Œåœ¨ go-micro åˆå§‹åŒ–çš„æ—¶å€™æˆ–æœåŠ¡å¯åŠ¨æ—¶å€™é€šè¿‡å¯åŠ¨å‚æ•°æŒ‡å®šå®ç°æ¥å£çš„æ¥å£çš„ String() stringæ–¹æ³•çš„è¿”å›å€¼æ¥å£ã€‚ å¦‚ï¼š // å‡å¦‚è¯¥ç»“æ„ä½“å·²å®ç° Registry æ¥å£ type customRegistry struct {} func (c *customRegistry) String() string { return \"custom\" } // ä»£ç ä¸­æŒ‡å®š func main() { micro.NewService(micro.Registry(\u0026customRegistry{})) } // å¯åŠ¨å‚æ•°æŒ‡å®š ./myApp -- registry custom å¦‚æ­¤ä¸€çœ‹ï¼Œå‘ç°éå¸¸æ–¹ä¾¿å’Œå¥½æ‰©å±•ï¼Œæ¥ä¸‹æ¥è´´å‡ºå¦‚ä½•ä½¿ç”¨nacos å®ç°è¯¥ Registry æ¥å£ã€‚ ç›´æ¥åˆ—å‡ºå…³é”®ä»£ç å—ï¼š registry.go import ( \"errors\" \"fmt\" \"net\" \"strconv\" \"time\" \"github.com/asim/go-micro/v3/cmd\" \"github.com/asim/go-micro/v3/registry\" \"github.com/nacos-group/nacos-sdk-go/v2/clients\" \"github.com/nacos-group/nacos-sdk-go/v2/clients/naming_client\" \"github.com/nacos-group/nacos-sdk-go/v2/common/constant\" \"github.com/nacos-group/nacos-sdk-go/v2/common/logger\" \"github.com/nacos-group/nacos-sdk-go/v2/vo\" ) type nacosRegistry struct { // nacos sdk çš„client client naming_client.INamingClient // å¯é€‰å‚æ•°ï¼Œåˆå§‹åŒ–çš„æ—¶å€™å¯ä»¥é€šè¿‡ registry.Option æ–¹æ³•æŒ‡å®šé…ç½® opts registry.Options } func init() { // è®¾ç½®ä¸ºé»˜è®¤é…ç½® cmd.DefaultRegistries[\"nacos\"] = NewRegistry } // NewRegistry NewRegistry func NewRegistry(opts ...registry.Option) registry.Registry { n := \u0026nacosRegistry{ opts: registry.Options{}, } if err := configure(n, opts...); err != nil { panic(err) } return n } // è¿™ä¸ªæ–¹æ³•æ€»ç»“ä¸‹æ¥å°±æ˜¯å¹²äº†ä¸€ä»¶äº‹ï¼šé…ç½®åˆå§‹åŒ– func configure(n *nacosRegistry, opts ...registry.Option) error { // set opts for _, o := range opts { o(\u0026n.opts) } clientConfig := constant.ClientConfig{} serverConfigs := make([]constant.ServerConfig, 0) contextPath := \"/nacos\" cfg, ok := n.opts.Context.Value(configKey{}).(constant.ClientConfig) if ok { clientConfig = cfg } addrs, ok := n.opts.Context.Value(addressKey{}).([]string) if !ok { addrs = []string{\"127.0.0.1:8848\"} // é»˜è®¤è¿æ¥æœ¬åœ° } for _, addr := range addrs { // check we have a port host, port, err := net.SplitHostPort(addr) if err != nil { return err } p, err := strconv.ParseUint(port, 10, 64) if err != nil { return err } serverConfigs = append(serverConfigs, constant.ServerConfig{ // Scheme: \"go.micro\", IpAddr: host, Port: p, ContextPath: contextPath, }) } if n.opts.Timeout == 0 { n.opts.Timeout = time.Second * 1 } clientConfig.TimeoutMs = uint64(n.opts.Timeout.Milliseconds()) // åˆ›å»ºå®¢æˆ·ç«¯ client, err := clients.CreateNamingClient(map[string]interface{}{ constant.KEY_SERVER_CONFIGS: serverConfigs, constant.KEY_CLIENT_CONFIG: clientConfig, }) if err != nil { return err } n.client = client return nil } func (n *nacosRegistry) Init(opts ...registry.Option) error { _ = configure(n, opts...) return nil } func (n *nacosRegistry) Options() registry.Options { return n.opts } func (n *nacosRegistry) Register(s *registry.Service, opts ...registry.RegisterOption) error { var options registry.RegisterOptions for _, o := range opts { o(\u0026options) } withContext := false // å¤„ç†å‚æ•° param := vo.RegisterInstanceParam{} if options.Context != nil { if p, ok := options.Context.Value(\"register_instance_param\").(vo.RegisterInstanceParam); ok { param = p withContext = ok } } if !withContext { host, port, err := getNodeIPPort(s) if err != nil { return err } s.Nodes[0].Metadata[\"version\"] = s.Version param.Ip = host param.Port = uint64(port) param.Metadata = s.Nodes[0].Metadata param.ServiceName = s.Name param.Enable = true param.Healthy = true param.Weight = 1.0 param.Ephemeral = true } // æ³¨å†ŒèŠ‚ç‚¹ _, err := n.client.RegisterInstance(param) return err } func (n *nacosRegistry) Deregister(s *registry.Service, opts ...registry.DeregisterOption) error { var options registry.DeregisterOptions for _, o := range opts { o(\u0026options) } withContext := false param := vo.DeregisterInst","date":"2021-06-23","objectID":"/posts/use-nacos-with-go-micro/:1:0","tags":["go","go-micro"],"title":"Go-Micro ä¸­ä½¿ç”¨Nacos","uri":"/posts/use-nacos-with-go-micro/"},{"categories":["microservice"],"content":"å…³äºå¦‚ä½•ä½¿ç”¨goçš„å¾®æœåŠ¡æ¡†æ¶ go-micro/v3 çš„ä½¿ç”¨å’Œå…¶æ’ä»¶çš„è‡ªå®šä¹‰ã€‚ç¬¬ä¸€éƒ¨åˆ†å°†æ¡†æ¶çš„æ¶æ„å¤§è‡´äº†è§£ä¸€éã€‚ ","date":"2021-06-11","objectID":"/posts/go-micro-1/:0:0","tags":["go","go-micro"],"title":"Go-Micro çš„æ¶æ„åŠå…¶ä½¿ç”¨ï¼ˆä¸€ï¼‰","uri":"/posts/go-micro-1/"},{"categories":["microservice"],"content":"æ¶æ„ ä»¥ v3.5.1 åˆ†æ”¯ä¸ºä¾‹ go-micor é¡¹ç›®çš„ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š $ tree -L 2 . â”œâ”€â”€ LICENSE â”œâ”€â”€ README.md â”œâ”€â”€ _config.yml â”œâ”€â”€ api // api æ¥å£çš„å®šä¹‰ï¼ŒåŒ…æ‹¬httpã€grpcã€routerç­‰ â”œâ”€â”€ auth // è´¦å·è®¤è¯æ¥å£çš„å®šä¹‰ â”œâ”€â”€ broker // æ¶ˆæ¯é˜Ÿåˆ—æ¥å£å®šä¹‰åŠé»˜è®¤å®ç° â”œâ”€â”€ client // å®¢æˆ·ç«¯ç›¸å…³æ¥å£å®šä¹‰å’Œå®ç° â”œâ”€â”€ cmd // å¯æ‰§è¡Œå‘½ä»¤ï¼ˆåŒ…æ‹¬ç”Ÿæˆprotobufçš„å‘½ä»¤å®ç°ï¼‰ â”œâ”€â”€ codec // code encoder â”œâ”€â”€ config // åŠ¨æ€é…ç½®çš„æ¥å£å®šä¹‰ â”œâ”€â”€ debug // debug æ¨¡å¼ â”œâ”€â”€ errors // é”™è¯¯å¤„ç† â”œâ”€â”€ examples // å„ä¸ªæ¨¡å—çš„ç¤ºä¾‹ä»£ç  â”œâ”€â”€ logger // æ—¥å¿—æ¨¡å—æ¥å£å®šä¹‰ â”œâ”€â”€ metadata // åŸæ•°æ® â”œâ”€â”€ plugins // å„ä¸ªæ¨¡å—å®šä¹‰çš„æ¥å£çš„ä¸åŒå®ç° â”œâ”€â”€ registry // æœåŠ¡æ³¨å†Œæ¥å£å®šä¹‰ â”œâ”€â”€ selector // è´Ÿè½½å‡è¡¡ â”œâ”€â”€ server // æœåŠ¡ç«¯æ¥å£å®šä¹‰ â”œâ”€â”€ store // æ•°æ®å­˜å‚¨æ¥å£å®šä¹‰ â”œâ”€â”€ sync â”œâ”€â”€ transport // è¯·æ±‚è½¬å‘ â””â”€â”€ util // å·¥å…·ç±» ä¸‹é¢æŒ‰ç›®å½•å°† go-micro çš„ä¸»è¦æ ¸å¿ƒæ¨¡å—è¿‡ä¸€éã€‚ ","date":"2021-06-11","objectID":"/posts/go-micro-1/:1:0","tags":["go","go-micro"],"title":"Go-Micro çš„æ¶æ„åŠå…¶ä½¿ç”¨ï¼ˆä¸€ï¼‰","uri":"/posts/go-micro-1/"},{"categories":["microservice"],"content":"API api å±‚ä¸ºå®šä¹‰å’Œå®ç°åŸºäºhttp/gRPCçš„api serviceã€‚å³httpè¯·æ±‚å¤„ç† è·¯ç”±å¤„ç† è·¯ç”±æ³¨å†Œç­‰ã€‚ æ¥å£å®šä¹‰ï¼š type Api interface { // Initialise options Init(...Option) error // Get the options Options() Options // Register a http handler Register(*Endpoint) error // Register a route Deregister(*Endpoint) error // Implemenation of api String() string } ç›®å½•ç»“æ„ï¼š $ tree . â”œâ”€â”€ api.go â”œâ”€â”€ api_test.go â”œâ”€â”€ handler // æ¥å£å¤„ç†æ–¹æ³• â”‚Â â”œâ”€â”€ api // å®ç° http.ServerHTTP() æ–¹æ³• â”‚Â â”œâ”€â”€ event // åŸºäºæ¶ˆæ¯é˜Ÿåˆ—çš„å®ç° â”‚Â â”œâ”€â”€ handler.go // æ¥å£å®šä¹‰ â”‚Â â”œâ”€â”€ http // åŸºäºhttpçš„å®ç° â”‚Â â”œâ”€â”€ options.go â”‚Â â”œâ”€â”€ rpc // åŸºäºrpcçš„å®ç° â”‚Â â””â”€â”€ web // æ”¯æŒwebsocketçš„å®ç° â”œâ”€â”€ proto â”‚Â â”œâ”€â”€ api.pb.go â”‚Â â”œâ”€â”€ api.pb.micro.go â”‚Â â””â”€â”€ api.proto // æ•°æ®ç»“æ„å®šä¹‰ â”œâ”€â”€ resolver // è§£æè¯·æ±‚åŠè·¯ç”± â”‚Â â”œâ”€â”€ grpc â”‚Â â”œâ”€â”€ host â”‚Â â”œâ”€â”€ options.go â”‚Â â”œâ”€â”€ path â”‚Â â”œâ”€â”€ resolver.go â”‚Â â””â”€â”€ vpath â”œâ”€â”€ router // è·¯ç”±å®šä¹‰å’Œæ³¨å†Œ â”‚Â â”œâ”€â”€ options.go â”‚Â â”œâ”€â”€ registry â”‚Â â”œâ”€â”€ router.go â”‚Â â”œâ”€â”€ static â”‚Â â””â”€â”€ util â””â”€â”€ server // æœåŠ¡å®šä¹‰å’Œå¯åŠ¨ â”œâ”€â”€ acme â”œâ”€â”€ cors â”œâ”€â”€ http â”œâ”€â”€ options.go â””â”€â”€ server.go ","date":"2021-06-11","objectID":"/posts/go-micro-1/:1:1","tags":["go","go-micro"],"title":"Go-Micro çš„æ¶æ„åŠå…¶ä½¿ç”¨ï¼ˆä¸€ï¼‰","uri":"/posts/go-micro-1/"},{"categories":["microservice"],"content":"Config config ä½œä¸ºåŠ¨æ€é…ç½®ä¸­å¿ƒçš„æ¥å£å®šä¹‰å’Œå®ç°ã€‚æ”¯æŒåŠ¨æ€åŠ è½½ã€æ’ä»¶å¼é…ç½®æºã€é…ç½®åˆå¹¶å’Œè§‚å¯Ÿé…ç½®å˜åŒ–ã€‚ æ¥å£å®šä¹‰ï¼š // Config is an interface abstraction for dynamic configuration // é…ç½®æ¥å£å®šä¹‰ type Config interface { // provide the reader.Values interface // è¯»å–åˆ°çš„é…ç½®çš„reader reader.Values // Init the config Init(opts ...Option) error // Options in the config Options() Options // Stop the config loader/watcher Close() error // Load config sources // å¯ä»¥åŠ è½½å¤šä¸ªSource Load(source ...source.Source) error // Force a source changeset sync // åŒæ­¥é…ç½®å˜åŒ– Sync() error // Watch a value for changes // è®¢é˜…é…ç½®å˜åŒ– Watch(path ...string) (Watcher, error) } // Watcher is the config watcher type Watcher interface { Next() (reader.Value, error) Stop() error } // Source is the source from which config is loaded // Source å°±æ˜¯é…ç½®æ¥æº go-micro å·²å®ç°åŸºäºconsulï¼Œetcdï¼Œfileç­‰å¤šç§é…ç½®æ¥æºï¼Œä¹Ÿå¯ä»¥è‡ªå·±å®ç°ä¸‹é¢æ¥å£æ¥ä½¿ç”¨ type Source interface { Read() (*ChangeSet, error) Write(*ChangeSet) error Watch() (Watcher, error) String() string } // Reader is an interface for merging changesets // ç”¨äºé…ç½®åˆå¹¶ // go-micro å®ç°äº†åŸºäºjsonçš„Reader,é»˜è®¤ç”¨jsonä½œä¸ºè§£æé…ç½®å†…å®¹ï¼Œå¹¶åœ¨æ’ä»¶ç›®å½•å†…å®ç°äº† toml yaml xmlç­‰æ ¼å¼çš„Encoderå¯ä»¥æŒ‰éœ€æ±‚æ›¿æ¢ type Reader interface { Merge(...*source.ChangeSet) (*source.ChangeSet, error) Values(*source.ChangeSet) (Values, error) String() string } // Values is returned by the reader // ç”¨äºè¯»å†™é…ç½®ï¼Œè¯»å–çš„é…ç½®ä¼šè¿”å› Value type Values interface { Bytes() []byte Get(path ...string) Value Set(val interface{}, path ...string) Del(path ...string) Map() map[string]interface{} Scan(v interface{}) error } // Value represents a value of any type // Value ä¸ºæ‹¿åˆ°çš„é…ç½®ï¼Œå¯ä»¥é€šè¿‡å…¶æ–¹æ³•è½¬åˆ°åŸºç¡€ç±»å‹ã€‚ type Value interface { Bool(def bool) bool Int(def int) int String(def string) string Float64(def float64) float64 Duration(def time.Duration) time.Duration StringSlice(def []string) []string StringMap(def map[string]string) map[string]string Scan(val interface{}) error Bytes() []byte } ç›®å½•ç»“æ„ï¼š $ tree -L 2 . â”œâ”€â”€ README.md â”œâ”€â”€ config.go // Config æ¥å£å®šä¹‰ â”œâ”€â”€ default.go // é»˜è®¤å®ç°çš„Config â”œâ”€â”€ default_test.go â”œâ”€â”€ encoder // encoder è§£æé…ç½®å†…å®¹ â”‚Â â”œâ”€â”€ encoder.go â”‚Â â””â”€â”€ json // jsonå®ç° â”œâ”€â”€ loader // åŠ è½½é…ç½® â”‚Â â”œâ”€â”€ loader.go â”‚Â â””â”€â”€ memory // åŸºäºå†…å­˜çš„åŠ è½½ï¼Œå³å¯åŠ¨æ—¶ä¼šå°†é…ç½®åŠ è½½åˆ°å†…å­˜ â”œâ”€â”€ options.go â”œâ”€â”€ reader // å®šä¹‰å’Œå®ç°Readerï¼Œå†…éƒ¨ä¾èµ–Encoder â”‚Â â”œâ”€â”€ json â”‚Â â”œâ”€â”€ options.go â”‚Â â”œâ”€â”€ preprocessor.go â”‚Â â”œâ”€â”€ preprocessor_test.go â”‚Â â””â”€â”€ reader.go â”œâ”€â”€ secrets // å®šä¹‰å’Œå®ç°éœ€è¦åŠ è§£å¯†çš„é…ç½® â”‚Â â”œâ”€â”€ box â”‚Â â”œâ”€â”€ secretbox â”‚Â â””â”€â”€ secrets.go â”œâ”€â”€ source // é…ç½®æ¥æº â”‚Â â”œâ”€â”€ changeset.go â”‚Â â”œâ”€â”€ cli â”‚Â â”œâ”€â”€ env // åŸºäºç¯å¢ƒå˜é‡çš„å®ç° â”‚Â â”œâ”€â”€ file // åŸºäºæœ¬åœ°æ–‡ä»¶å®ç° â”‚Â â”œâ”€â”€ flag // åŸºäºå¯åŠ¨å‚æ•°flagå®ç° â”‚Â â”œâ”€â”€ memory // åŸºäºå†…å­˜å®ç° â”‚Â â”œâ”€â”€ noop.go â”‚Â â”œâ”€â”€ options.go â”‚Â â””â”€â”€ source.go â””â”€â”€ value.go plugins/config/encoder ç›®å½•: å®ç°Encoderæ¥å£ $ tree plugins/config/encoder â”œâ”€â”€ cue â”œâ”€â”€ hcl â”œâ”€â”€ toml â”œâ”€â”€ xml â””â”€â”€ yaml plugins/config/source ç›®å½•ï¼š å®ç°Sourceæ¥å£ $ tree plugins/config/source â”œâ”€â”€ configmap â”œâ”€â”€ consul â”œâ”€â”€ etcd â”œâ”€â”€ grpc â”œâ”€â”€ mucp â”œâ”€â”€ pkger â”œâ”€â”€ runtimevar â”œâ”€â”€ url â””â”€â”€ vault ","date":"2021-06-11","objectID":"/posts/go-micro-1/:1:2","tags":["go","go-micro"],"title":"Go-Micro çš„æ¶æ„åŠå…¶ä½¿ç”¨ï¼ˆä¸€ï¼‰","uri":"/posts/go-micro-1/"},{"categories":["microservice"],"content":"Logger Logger åŒ…ä¸ºå…¨å±€æ—¥å¿—åº“ï¼Œé»˜è®¤å®ç°äº†ä¸€å¥—ï¼Œå¹¶åœ¨plugins å†…å®ç°äº†åŸºäº logrusï¼Œzapçš„ä¸ªä¸»æµçš„æ—¥å¿—çš„å®ç°ã€‚ æ¥å£å®šä¹‰ï¼š // Logger is a generic logging interface type Logger interface { // Init initialises options Init(options ...Option) error // The Logger options Options() Options // Fields set fields to always be logged Fields(fields map[string]interface{}) Logger // Log writes a log entry Log(level Level, v ...interface{}) // Logf writes a formatted log entry Logf(level Level, format string, v ...interface{}) // String returns the name of logger String() string } è‹¥éœ€è¦è‡ªå·±å®šä¹‰æ—¥å¿—æ ¼å¼å’Œæ—¥å¿—åº“ï¼Œå¯ä»¥å®ç°ä¸Šé¢æ¥å£ï¼Œå¹¶åˆå§‹åŒ–çš„æ—¶å€™æŒ‡å®šå³å¯ã€‚ ","date":"2021-06-11","objectID":"/posts/go-micro-1/:1:3","tags":["go","go-micro"],"title":"Go-Micro çš„æ¶æ„åŠå…¶ä½¿ç”¨ï¼ˆä¸€ï¼‰","uri":"/posts/go-micro-1/"},{"categories":["microservice"],"content":"plugins è¯¥ç›®å½•ä½œä¸ºæ’ä»¶ç›®å½•ï¼Œå®ç°äº†å¤§éƒ¨åˆ†é¢„å®šä¹‰çš„æ¥å£ï¼Œæ–¹ä¾¿ä½¿ç”¨çš„æ—¶å€™æ›¿æ¢æˆé»˜è®¤å®ç°çš„æ¨¡å—ä»£ç ã€‚ è¯¥ç›®å½•ä¸‹æ‰€æœ‰å­ç›®å½•å‡å¯ä»¥ä½œä¸ºgo mod package å¯¼å…¥ä½¿ç”¨ åœ¨ä¹‹åè®²å¦‚ä½•ä½¿ç”¨æ˜¯ åŒæ—¶æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨æ’ä»¶ ç›®å½•ç»“æ„ï¼š $ tree plugins â”œâ”€â”€ LICENSE â”œâ”€â”€ README.md â”œâ”€â”€ auth // ç”¨æˆ·è®¤çœŸ â”‚Â â””â”€â”€ jwt // å®ç°åŸºäºjwtçš„authæ¥å£ â”œâ”€â”€ broker // æ”¯æŒäº†å¸‚é¢ä¸Šå¤§éƒ¨åˆ†æ¶ˆæ¯é˜Ÿåˆ— â”‚Â â”œâ”€â”€ gocloud â”‚Â â”œâ”€â”€ googlepubsub â”‚Â â”œâ”€â”€ grpc â”‚Â â”œâ”€â”€ http â”‚Â â”œâ”€â”€ kafka â”‚Â â”œâ”€â”€ memory â”‚Â â”œâ”€â”€ mqtt â”‚Â â”œâ”€â”€ nats â”‚Â â”œâ”€â”€ nsq â”‚Â â”œâ”€â”€ proxy â”‚Â â”œâ”€â”€ rabbitmq â”‚Â â”œâ”€â”€ redis â”‚Â â”œâ”€â”€ segmentio â”‚Â â”œâ”€â”€ snssqs â”‚Â â”œâ”€â”€ sqs â”‚Â â”œâ”€â”€ stan â”‚Â â””â”€â”€ stomp â”œâ”€â”€ client // æ”¯æŒäº†grpc http ç­‰æ–¹å¼çš„å®¢æˆ·ç«¯å®ç° â”‚Â â”œâ”€â”€ grpc â”‚Â â”œâ”€â”€ http â”‚Â â”œâ”€â”€ mock â”‚Â â””â”€â”€ mucp â”œâ”€â”€ codec // æ¶ˆæ¯çš„ç¼–ç è§£ç çš„å®ç° â”‚Â â”œâ”€â”€ bsonrpc â”‚Â â”œâ”€â”€ json-iterator â”‚Â â”œâ”€â”€ jsonrpc2 â”‚Â â”œâ”€â”€ msgpackrpc â”‚Â â””â”€â”€ segmentio â”œâ”€â”€ config // é…ç½® â”‚ â”œâ”€â”€ encoder // é…ç½®ç¼–ç è§£ç  â”‚Â â”œâ”€â”€ cue â”‚Â â”œâ”€â”€ hcl â”‚Â â”œâ”€â”€ toml â”‚Â â”œâ”€â”€ xml â”‚Â â””â”€â”€ yaml â”‚ â””â”€â”€ source // é…ç½®æ•°æ®æº â”‚ â”œâ”€â”€ configmap â”‚ â”œâ”€â”€ consul â”‚ â”œâ”€â”€ etcd â”‚ â”œâ”€â”€ grpc â”‚ â”œâ”€â”€ mucp â”‚ â”œâ”€â”€ pkger â”‚ â”œâ”€â”€ runtimevar â”‚ â”œâ”€â”€ url â”‚ â””â”€â”€ vault â”œâ”€â”€ logger // æ—¥å¿—åº“ â”‚Â â”œâ”€â”€ apex â”‚Â â”œâ”€â”€ logrus â”‚Â â”œâ”€â”€ zap â”‚Â â””â”€â”€ zerolog â”œâ”€â”€ plugin.go â”œâ”€â”€ proxy â”‚Â â””â”€â”€ http â”œâ”€â”€ registry // æœåŠ¡å‘ç°æœåŠ¡æ³¨å†Œ â”‚Â â”œâ”€â”€ cache â”‚Â â”œâ”€â”€ consul â”‚Â â”œâ”€â”€ etcd â”‚Â â”œâ”€â”€ eureka â”‚Â â”œâ”€â”€ gossip â”‚Â â”œâ”€â”€ kubernetes â”‚Â â”œâ”€â”€ mdns â”‚Â â”œâ”€â”€ memory â”‚Â â”œâ”€â”€ multi â”‚Â â”œâ”€â”€ nats â”‚Â â”œâ”€â”€ proxy â”‚Â â””â”€â”€ zookeeper â”œâ”€â”€ release.sh â”œâ”€â”€ selector // è´Ÿè½½å‡è¡¡ â”‚Â â”œâ”€â”€ dns â”‚Â â”œâ”€â”€ label â”‚Â â”œâ”€â”€ registry â”‚Â â”œâ”€â”€ shard â”‚Â â””â”€â”€ static â”œâ”€â”€ server // åç«¯æœåŠ¡ â”‚Â â”œâ”€â”€ grpc â”‚Â â”œâ”€â”€ http â”‚Â â””â”€â”€ mucp â”œâ”€â”€ store // æ•°æ®å­˜å‚¨çš„å®ç° â”‚Â â”œâ”€â”€ cockroach â”‚Â â”œâ”€â”€ consul â”‚Â â”œâ”€â”€ file â”‚Â â”œâ”€â”€ memcached â”‚Â â”œâ”€â”€ memory â”‚Â â”œâ”€â”€ mysql â”‚Â â””â”€â”€ redis â”œâ”€â”€ sync // æ•°æ®åŒæ­¥ â”‚Â â”œâ”€â”€ etcd â”‚Â â””â”€â”€ memory â”œâ”€â”€ template.go â”œâ”€â”€ transport // æœåŠ¡ä¹‹é—´é€šè®¯æ¨¡å— â”‚Â â”œâ”€â”€ grpc â”‚Â â”œâ”€â”€ http â”‚Â â”œâ”€â”€ memory â”‚Â â”œâ”€â”€ nats â”‚Â â”œâ”€â”€ quic â”‚Â â”œâ”€â”€ rabbitmq â”‚Â â”œâ”€â”€ tcp â”‚Â â””â”€â”€ utp â””â”€â”€ wrapper // è‡ªå®šä¹‰ç»„ä»¶ æ¯”å¦‚ç›‘æ§ã€é™æµã€ç†”æ–­ã€è¿½è¸ªç­‰ â”œâ”€â”€ README.md â”œâ”€â”€ breaker // ç†”æ–­ â”œâ”€â”€ endpoint // æŒ‡å®šæœåŠ¡èŠ‚ç‚¹ â”œâ”€â”€ monitoring // ç›‘æ§ â”œâ”€â”€ ratelimiter // é™æµ â”œâ”€â”€ select // è´Ÿè½½å‡è¡¡ â”œâ”€â”€ service â”œâ”€â”€ trace // é“¾è·¯è¿½è¸ª â””â”€â”€ validator // å‚æ•°æ ¡éªŒï¼ˆå¤„ç†è¯·æ±‚æ—¶ å¯ä»¥ç»Ÿä¸€å‚æ•°æ ¡éªŒç­‰å·¥ä½œï¼‰ ","date":"2021-06-11","objectID":"/posts/go-micro-1/:1:4","tags":["go","go-micro"],"title":"Go-Micro çš„æ¶æ„åŠå…¶ä½¿ç”¨ï¼ˆä¸€ï¼‰","uri":"/posts/go-micro-1/"},{"categories":["microservice"],"content":"Registry æœåŠ¡å‘ç°/æœåŠ¡æ³¨å†Œç›¸å…³é€»è¾‘å‡åœ¨ registry åŒ…å†…å®ç°ã€‚ æ ¸å¿ƒæ¥å£å®šä¹‰ï¼š // The registry provides an interface for service discovery // and an abstraction over varying implementations // {consul, etcd, zookeeper, ...} type Registry interface { Init(...Option) error Options() Options // æœåŠ¡æ³¨å†Œ Register(*Service, ...RegisterOption) error // æœåŠ¡æ³¨é”€ Deregister(*Service, ...DeregisterOption) error // æŸ¥è¯¢æœåŠ¡ GetService(string, ...GetOption) ([]*Service, error) // åˆ—å‡ºæœåŠ¡åˆ—è¡¨ ListServices(...ListOption) ([]*Service, error) // ç›‘æ§æœåŠ¡ Watch(...WatchOption) (Watcher, error) String() string } // Watcher is an interface that returns updates // about services within the registry. type Watcher interface { // Next is a blocking call Next() (*Result, error) Stop() } ","date":"2021-06-11","objectID":"/posts/go-micro-1/:1:5","tags":["go","go-micro"],"title":"Go-Micro çš„æ¶æ„åŠå…¶ä½¿ç”¨ï¼ˆä¸€ï¼‰","uri":"/posts/go-micro-1/"},{"categories":["microservice"],"content":"Selector è´Ÿè½½å‡è¡¡é€»è¾‘ï¼Œå³å®¢æˆ·ç«¯è¯·æ±‚å…¶ä»–æœåŠ¡æ—¶å¦‚ä½•é€‰å–æœåŠ¡èŠ‚ç‚¹éƒ½æ˜¯åœ¨è¯¥åŒ…å†…å®ç°ã€‚å¯ä»¥é€šè¿‡optionæŒ‡å®šç­–ç•¥ï¼Œéšæœºï¼Œè½®è¯¢ç­‰ã€‚ æ¥å£å®šä¹‰ï¼š // Selector builds on the registry as a mechanism to pick nodes // and mark their status. This allows host pools and other things // to be built using various algorithms. type Selector interface { Init(opts ...Option) error Options() Options // Select returns a function which should return the next node Select(service string, opts ...SelectOption) (Next, error) // Mark sets the success/error against a node Mark(service string, node *registry.Node, err error) // Reset returns state back to zero for a service Reset(service string) // Close renders the selector unusable Close() error // Name of the selector String() string } // Next is a function that returns the next node // based on the selector's strategy type Next func() (*registry.Node, error) ","date":"2021-06-11","objectID":"/posts/go-micro-1/:1:6","tags":["go","go-micro"],"title":"Go-Micro çš„æ¶æ„åŠå…¶ä½¿ç”¨ï¼ˆä¸€ï¼‰","uri":"/posts/go-micro-1/"},{"categories":["microservice"],"content":"Server server åŒ…ä¸ºå®šä¹‰å’Œå®ç°ç®¡ç†æœåŠ¡ç›¸å…³é€»è¾‘ã€‚ serverçš„å®šä¹‰ï¼š // Server is a simple micro server abstraction type Server interface { // Initialise options Init(...Option) error // Retrieve the options Options() Options // Register a handler Handle(Handler) error // Create a new handler NewHandler(interface{}, ...HandlerOption) Handler // Create a new subscriber NewSubscriber(string, interface{}, ...SubscriberOption) Subscriber // Register a subscriber Subscribe(Subscriber) error // Start the server Start() error // Stop the server Stop() error // Server implementation String() string } // Router handle serving messages type Router interface { // ProcessMessage processes a message // å¤„ç†æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆæ¯ ProcessMessage(context.Context, Message) error // ServeRequest processes a request to completion // å¤„ç† http/rpc è¯·æ±‚ ServeRequest(context.Context, Request, Response) error } é»˜è®¤å®ç°äº†rpcå’Œæ¶ˆæ¯é˜Ÿåˆ—ï¼ŒhttpæœåŠ¡ å¯ä»¥ä½¿ç”¨plugins/server/http åŒ…ã€‚ ","date":"2021-06-11","objectID":"/posts/go-micro-1/:1:7","tags":["go","go-micro"],"title":"Go-Micro çš„æ¶æ„åŠå…¶ä½¿ç”¨ï¼ˆä¸€ï¼‰","uri":"/posts/go-micro-1/"},{"categories":["microservice"],"content":"Store è¯¥åŒ…å®šä¹‰äº†æ•°æ®å­˜å‚¨çš„æ¥å£ã€‚ æ¥å£å®šä¹‰ï¼š // Store is a data storage interface type Store interface { // Init initialises the store. It must perform any required setup on the backing storage implementation and check that it is ready for use, returning any errors. Init(...Option) error // Options allows you to view the current options. Options() Options // Read takes a single key name and optional ReadOptions. It returns matching []*Record or an error. Read(key string, opts ...ReadOption) ([]*Record, error) // Write() writes a record to the store, and returns an error if the record was not written. Write(r *Record, opts ...WriteOption) error // Delete removes the record with the corresponding key from the store. Delete(key string, opts ...DeleteOption) error // List returns any keys that match, or an empty list with no error if none matched. List(opts ...ListOption) ([]string, error) // Close the store Close() error // String returns the name of the implementation. String() string } å…·ä½“ä½¿ç”¨æ•°æ®åº“ç±»å‹ï¼Œåœ¨plugins/store å†…åˆå§‹åŒ–å¯¹åº”çš„å®ä¾‹ã€‚ ","date":"2021-06-11","objectID":"/posts/go-micro-1/:1:8","tags":["go","go-micro"],"title":"Go-Micro çš„æ¶æ„åŠå…¶ä½¿ç”¨ï¼ˆä¸€ï¼‰","uri":"/posts/go-micro-1/"},{"categories":["microservice"],"content":"Sync sync åŒ…ä¸ºå®šä¹‰åˆ†å¸ƒå¼é€‰ä¸¾å’Œåˆ†å¸ƒå¼é”çš„å®šä¹‰ã€‚ æ¥å£å®šä¹‰ï¼š // Sync is an interface for distributed synchronization type Sync interface { // Initialise options Init(...Option) error // Return the options Options() Options // Elect a leader // é€‰ä¸¾ Leader(id string, opts ...LeaderOption) (Leader, error) // Lock acquires a lock // ä¸Šé” Lock(id string, opts ...LockOption) error // Unlock releases a lock // é‡Šæ”¾é” Unlock(id string) error // Sync implementation String() string } // Leader provides leadership election // æä¾›åˆ†å¸ƒå¼é€‰ä¸¾ type Leader interface { // resign leadership // è¾èŒ å³æ”¾å¼ƒLeaderçŠ¶æ€ Resign() error // status returns when leadership is lost // åœ¨leader çŠ¶æ€å¤±å»æ—¶ï¼Œchannelå†…å¯è¯»å– Status() chan bool } ","date":"2021-06-11","objectID":"/posts/go-micro-1/:1:9","tags":["go","go-micro"],"title":"Go-Micro çš„æ¶æ„åŠå…¶ä½¿ç”¨ï¼ˆä¸€ï¼‰","uri":"/posts/go-micro-1/"},{"categories":["é¢è¯•"],"content":"ç»å†äº†2ä¸ªæœˆçš„é¢è¯•æŠ˜ç£¨ï¼Œæ‹¿åˆ°offeræ€»ç®—ç»“æŸäº†è¿™æ®µæ—¶é—´ã€‚ä¸»è¦æ˜¯æƒ³è®°å½•é¢è¯•ä¸­é‡åˆ°çš„é—®é¢˜ï¼Œåˆ—å‡ºæ¥çš„é—®é¢˜ä¸ä¸€å®šæœ‰ç­”æ¡ˆï¼Œæœ‰ç­”æ¡ˆä¹Ÿä¸ä¸€å®šæ˜¯æœ€ä½³ç­”æ¡ˆï¼Œæ‰€ä»¥è¿˜æ˜¯çœ‹é—®é¢˜ä¸ºä¸»ï¼Œç­”æ¡ˆè‡ªè¡Œè§£å†³ã€‚ çŸ¥è¯†æ¶æ„ ","date":"2021-05-31","objectID":"/posts/go-interview/:0:0","tags":["é¢è¯•","ç»éªŒ"],"title":"Go é¢è¯•æ€»ç»“","uri":"/posts/go-interview/"},{"categories":["é¢è¯•"],"content":"æ•°æ®åº“ ","date":"2021-05-31","objectID":"/posts/go-interview/:1:0","tags":["é¢è¯•","ç»éªŒ"],"title":"Go é¢è¯•æ€»ç»“","uri":"/posts/go-interview/"},{"categories":["é¢è¯•"],"content":"MySQL ç´¢å¼• B+tree ç´¢å¼• æ•°æ®å­˜å‚¨ä½ç½®-åœ¨å¶å­èŠ‚ç‚¹ ç›¸é‚»èŠ‚ç‚¹æ˜¯é“¾è¡¨ç»“æ„ è¿™æ ·å¯ä»¥å®ç° range æŸ¥è¯¢ è”åˆç´¢å¼• æœ€å·¦åŸåˆ™ ç´¢å¼•ä¸èƒ½æ˜¯è¡¨è¾¾å¼çš„ä¸€éƒ¨åˆ† å¦åˆ™ä¸èµ°ç´¢å¼• ä¸ºä»€ä¹ˆä¸»é”®æ˜¯é€’å¢çš„ï¼Œéšæœºä¼šæ€ä¹ˆæ ·ï¼Ÿ å¦‚æœä½¿ç”¨éè‡ªå¢ä¸»é”®ï¼ˆå¦‚æœèº«ä»½è¯å·æˆ–å­¦å·ç­‰ï¼‰ï¼Œç”±äºæ¯æ¬¡æ’å…¥ä¸»é”®çš„å€¼è¿‘ä¼¼äºéšæœºï¼Œå› æ­¤æ¯æ¬¡æ–°çºªå½•éƒ½è¦è¢«æ’åˆ°ç°æœ‰ç´¢å¼•é¡µå¾—ä¸­é—´æŸä¸ªä½ç½®ï¼Œæ­¤æ—¶MySQLä¸å¾—ä¸ä¸ºäº†å°†æ–°è®°å½•æ’åˆ°åˆé€‚ä½ç½®è€Œç§»åŠ¨æ•°æ®ï¼Œç”šè‡³ç›®æ ‡é¡µé¢å¯èƒ½å·²ç»è¢«å›å†™åˆ°ç£ç›˜ä¸Šè€Œä»ç¼“å­˜ä¸­æ¸…æ‰ï¼Œæ­¤æ—¶åˆè¦ä»ç£ç›˜ä¸Šè¯»å›æ¥ï¼Œè¿™å¢åŠ äº†å¾ˆå¤šå¼€é”€ï¼ŒåŒæ—¶é¢‘ç¹çš„ç§»åŠ¨ã€åˆ†é¡µæ“ä½œé€ æˆäº†å¤§é‡çš„ç¢ç‰‡ï¼Œå¾—åˆ°äº†ä¸å¤Ÿç´§å‡‘çš„ç´¢å¼•ç»“æ„ï¼Œåç»­ä¸å¾—ä¸é€šè¿‡OPTIMIZE TABLEæ¥é‡å»ºè¡¨å¹¶ä¼˜åŒ–å¡«å……é¡µé¢ã€‚ å“ˆå¸Œç´¢å¼• - ç²¾å‡†æŸ¥è¯¢ èšç°‡ç´¢å¼•å’Œéèšç°‡ç´¢å¼• äº‹åŠ¡ äº‹åŠ¡çš„å››ç§ç‰¹æ€§ï¼š åŸå­æ€§ï¼šä¸€ä¸ªäº‹åŠ¡ï¼ˆtransactionï¼‰ä¸­çš„æ‰€æœ‰æ“ä½œï¼Œè¦ä¹ˆå…¨éƒ¨å®Œæˆï¼Œè¦ä¹ˆå…¨éƒ¨ä¸å®Œæˆï¼Œä¸ä¼šç»“æŸåœ¨ä¸­é—´æŸä¸ªç¯èŠ‚ã€‚äº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œä¼šè¢«å›æ»šï¼ˆRollbackï¼‰åˆ°äº‹åŠ¡å¼€å§‹å‰çš„çŠ¶æ€ï¼Œå°±åƒè¿™ä¸ªäº‹åŠ¡ä»æ¥æ²¡æœ‰æ‰§è¡Œè¿‡ä¸€æ ·ã€‚ è‡´æ€§ï¼šåœ¨äº‹åŠ¡å¼€å§‹ä¹‹å‰å’Œäº‹åŠ¡ç»“æŸä»¥åï¼Œæ•°æ®åº“çš„å®Œæ•´æ€§æ²¡æœ‰è¢«ç ´åã€‚è¿™è¡¨ç¤ºå†™å…¥çš„èµ„æ–™å¿…é¡»å®Œå…¨ç¬¦åˆæ‰€æœ‰çš„é¢„è®¾è§„åˆ™ï¼Œè¿™åŒ…å«èµ„æ–™çš„ç²¾ç¡®åº¦ã€ä¸²è”æ€§ä»¥åŠåç»­æ•°æ®åº“å¯ä»¥è‡ªå‘æ€§åœ°å®Œæˆé¢„å®šçš„å·¥ä½œã€‚ éš”ç¦»æ€§ï¼šæ•°æ®åº“å…è®¸å¤šä¸ªå¹¶å‘äº‹åŠ¡åŒæ—¶å¯¹å…¶æ•°æ®è¿›è¡Œè¯»å†™å’Œä¿®æ”¹çš„èƒ½åŠ›ï¼Œéš”ç¦»æ€§å¯ä»¥é˜²æ­¢å¤šä¸ªäº‹åŠ¡å¹¶å‘æ‰§è¡Œæ—¶ç”±äºäº¤å‰æ‰§è¡Œè€Œå¯¼è‡´æ•°æ®çš„ä¸ä¸€è‡´ã€‚äº‹åŠ¡éš”ç¦»åˆ†ä¸ºä¸åŒçº§åˆ«ï¼ŒåŒ…æ‹¬è¯»æœªæäº¤ï¼ˆRead uncommittedï¼‰ã€è¯»æäº¤ï¼ˆread committedï¼‰ã€å¯é‡å¤è¯»ï¼ˆrepeatable readï¼‰å’Œä¸²è¡ŒåŒ–ï¼ˆSerializableï¼‰ã€‚ æŒä¹…æ€§ï¼šäº‹åŠ¡å¤„ç†ç»“æŸåï¼Œå¯¹æ•°æ®çš„ä¿®æ”¹å°±æ˜¯æ°¸ä¹…çš„ï¼Œå³ä¾¿ç³»ç»Ÿæ•…éšœä¹Ÿä¸ä¼šä¸¢å¤±ã€‚ äº‹åŠ¡çš„éš”ç¦»çº§åˆ«ï¼š æœªæäº¤è¯»(Read Uncommitted)ï¼šå…è®¸è„è¯»ï¼Œä¹Ÿå°±æ˜¯å¯èƒ½è¯»å–åˆ°å…¶ä»–ä¼šè¯ä¸­æœªæäº¤äº‹åŠ¡ä¿®æ”¹çš„æ•°æ® æäº¤è¯»(Read Committed)ï¼šåªèƒ½è¯»å–åˆ°å·²ç»æäº¤çš„æ•°æ®ã€‚Oracleç­‰å¤šæ•°æ•°æ®åº“é»˜è®¤éƒ½æ˜¯è¯¥çº§åˆ« (ä¸é‡å¤è¯») å¯é‡å¤è¯»(Repeated Read)ï¼šå¯é‡å¤è¯»ã€‚åœ¨åŒä¸€ä¸ªäº‹åŠ¡å†…çš„æŸ¥è¯¢éƒ½æ˜¯äº‹åŠ¡å¼€å§‹æ—¶åˆ»ä¸€è‡´çš„ï¼ŒInnoDBé»˜è®¤çº§åˆ«ã€‚åœ¨SQLæ ‡å‡†ä¸­ï¼Œè¯¥éš”ç¦»çº§åˆ«æ¶ˆé™¤äº†ä¸å¯é‡å¤è¯»ï¼Œä½†æ˜¯è¿˜å­˜åœ¨å¹»è±¡è¯» ä¸²è¡Œè¯»(Serializable)ï¼šå®Œå…¨ä¸²è¡ŒåŒ–çš„è¯»ï¼Œæ¯æ¬¡è¯»éƒ½éœ€è¦è·å¾—è¡¨çº§å…±äº«é”ï¼Œè¯»å†™ç›¸äº’éƒ½ä¼šé˜»å¡ éš”ç¦»çº§åˆ« è„è¯»ï¼ˆDirty Readï¼‰ ä¸å¯é‡å¤è¯»ï¼ˆNonRepeatable Readï¼‰ å¹»è¯»ï¼ˆPhantom Readï¼‰ æœªæäº¤è¯»ï¼ˆRead uncommittedï¼‰ å¯èƒ½ å¯èƒ½ å¯èƒ½ å·²æäº¤è¯»ï¼ˆRead committedï¼‰ ä¸å¯èƒ½ å¯èƒ½ å¯èƒ½ å¯é‡å¤è¯»ï¼ˆRepeatable readï¼‰ ä¸å¯èƒ½ ä¸å¯èƒ½ å¯èƒ½ï¼ˆinnodb ä¸å­˜åœ¨ï¼‰ å¯ä¸²è¡ŒåŒ–ï¼ˆSerializable ï¼‰ ä¸å¯èƒ½ ä¸å¯èƒ½ ä¸å¯èƒ½ åˆ†åº“åˆ†è¡¨ æ°´å¹³ï¼š æ°´å¹³åˆ†è¡¨ â€“ è¡¨ä¹‹é—´ç»“æ„ç›¸åŒ è¡¨ä¹‹é—´æ•°æ®ä¸ç›¸åŒ æ‰€æœ‰è¡¨çš„æ•°æ®å¹¶é›†æ˜¯æ€»æ•°æ®ï¼ˆå•è¡¨æ•°æ®é‡å¾ˆå¤§ï¼Œå½±å“sqlæ€§èƒ½ï¼‰ æ°´å¹³åˆ†åº“ â€“ åº“ä¹‹é—´è¡¨ç»“æ„ç›¸åŒ åº“ä¹‹é—´æ•°æ®ä¸ç›¸åŒ æ‰€æœ‰åº“æ•°æ®çš„å¹¶é›†æ˜¯æ€»æ•°æ®ï¼ˆå¹¶å‘é‡å¾ˆé«˜ï¼Œcpu ç½‘ç»œæ‰›ä¸ä½ï¼Œåˆ†åº“ç¼“è§£å‹åŠ›ï¼‰ å‚ç›´ï¼š å‚ç›´åˆ†è¡¨ â€“ è¡¨ä¹‹é—´ç»“æ„ä¸ç›¸åŒï¼Œæ•°æ®æ ¹æ®æŸä¸ªå­—æ®µå…³è”ï¼Œç¼“è§£ioæ€§èƒ½ å‚ç›´åˆ†åº“ â€“ åº“ä¹‹å‰çš„è¡¨ä¹‹é—´ç»“æ„ä¸ç›¸åŒï¼ŒæœåŠ¡å‹åŠ›å¾ˆé«˜ å¯ä»¥è€ƒè™‘æ‹†å‡ºå»åšå•ç‹¬æœåŠ¡äº† æ–¹æ¡ˆï¼š æ–¹æ¡ˆä¸€ï¼ˆæ°´å¹³æ‰©å®¹åº“ï¼‰ é‡‡ç”¨åŒå€æ‰©å®¹ç­–ç•¥ï¼Œé¿å…æ•°æ®è¿ç§»ã€‚æ‰©å®¹å‰æ¯ä¸ªèŠ‚ç‚¹çš„æ•°æ®ï¼Œæœ‰ä¸€åŠè¦è¿ç§»è‡³ä¸€ä¸ªæ–°å¢èŠ‚ç‚¹ä¸­ï¼Œå¯¹åº”å…³ç³»æ¯”è¾ƒç®€å•ã€‚ å…·ä½“æ“ä½œå¦‚ä¸‹(å‡è®¾å·²æœ‰ 2 ä¸ªèŠ‚ç‚¹ A/Bï¼Œè¦åŒå€æ‰©å®¹è‡³ A/A2/B/B2 è¿™ 4 ä¸ªèŠ‚ç‚¹)ï¼š æ— éœ€åœæ­¢åº”ç”¨æœåŠ¡å™¨ï¼› æ–°å¢ä¸¤ä¸ªæ•°æ®åº“ A2/B2 ä½œä¸ºä»åº“ï¼Œè®¾ç½®ä¸»ä»åŒæ­¥å…³ç³»ä¸ºï¼šA=\u003eA2ã€B=\u003eB2ï¼Œç›´è‡³ä¸»ä»æ•°æ®åŒæ­¥å®Œæ¯•(æ—©æœŸæ•°æ®å¯æ‰‹å·¥åŒæ­¥)ï¼› è°ƒæ•´åˆ†ç‰‡è§„åˆ™å¹¶ä½¿ä¹‹ç”Ÿæ•ˆï¼š åŸ ID%2=0 =\u003e A æ”¹ä¸º ID%4=0 =\u003e A, ID%4=2 =\u003e A2ï¼› åŸ ID%2=1 =\u003e B æ”¹ä¸º ID%4=1 =\u003e B, ID%4=3 =\u003e B2ã€‚ è§£é™¤æ•°æ®åº“å®ä¾‹çš„ä¸»ä»åŒæ­¥å…³ç³»ï¼Œå¹¶ä½¿ä¹‹ç”Ÿæ•ˆï¼› æ­¤æ—¶ï¼Œå››ä¸ªèŠ‚ç‚¹çš„æ•°æ®éƒ½å·²å®Œæ•´ï¼Œåªæ˜¯æœ‰å†—ä½™(å¤šå­˜äº†å’Œè‡ªå·±é…å¯¹çš„èŠ‚ç‚¹çš„é‚£éƒ¨åˆ†æ•°æ®)ï¼Œæ‹©æœºæ¸…é™¤å³å¯(è¿‡åéšæ—¶è¿›è¡Œï¼Œä¸å½±å“ä¸šåŠ¡)ã€‚ æ–¹æ¡ˆäºŒï¼ˆæ°´å¹³æ‰©å®¹è¡¨-åŒå†™ï¼‰ ç¬¬ä¸€æ­¥ï¼šï¼ˆåŒæ­¥åŒå†™ï¼‰ä¿®æ”¹åº”ç”¨é…ç½®å’Œä»£ç ï¼ŒåŠ ä¸ŠåŒå†™ï¼Œéƒ¨ç½² ç¬¬äºŒæ­¥ï¼šï¼ˆåŒæ­¥åŒå†™ï¼‰å°†è€åº“ä¸­çš„è€æ•°æ®å¤åˆ¶åˆ°æ–°åº“ä¸­ ç¬¬ä¸‰æ­¥ï¼šï¼ˆåŒæ­¥åŒå†™ï¼‰ä»¥è€åº“ä¸ºå‡†æ ¡å¯¹æ–°åº“ä¸­çš„è€æ•°æ® ç¬¬å››æ­¥ï¼šï¼ˆåŒæ­¥åŒå†™ï¼‰ä¿®æ”¹åº”ç”¨é…ç½®å’Œä»£ç ï¼Œå»æ‰åŒå†™ï¼Œéƒ¨ç½²ï¼› ","date":"2021-05-31","objectID":"/posts/go-interview/:1:1","tags":["é¢è¯•","ç»éªŒ"],"title":"Go é¢è¯•æ€»ç»“","uri":"/posts/go-interview/"},{"categories":["é¢è¯•"],"content":"Redis æ•°æ®ç»“æ„ String ç®€å•åŠ¨æ€å­—ç¬¦ä¸² ç¼–ç æ–¹å¼ä¸åŒä¼šæœ‰ä»€ä¹ˆå½±å“ Set åº•å±‚å“ˆå¸Œè¡¨ ZSet memberå­˜åœ¨å“ˆå¸Œè¡¨ä¸­ score å­˜åœ¨è·³è¡¨é‡Œ æŸ¥è¯¢æ’å…¥æ—¶é—´å¤æ‚ logn ä¸ºä»€ä¹ˆç”¨è·³è¡¨ List åŒå‘é“¾è¡¨ç»“æ„ Hmap å“ˆå¸Œè¡¨ æ€§èƒ½ ä¸ºä»€ä¹ˆè¿™ä¹ˆå¿« ä¸ºä»€ä¹ˆè¿™ä¹ˆå¿«2 æ•°æ®å‡å­˜åœ¨å†…å­˜ï¼ˆå¼•å‘å‡ºæŒä¹…åŒ–é—®é¢˜ï¼‰ é«˜æ•ˆçš„æ•°æ®ç»“æ„ å•çº¿ç¨‹ï¼Œçœå»çº¿ç¨‹é—´ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ—¶é—´ ä»¥åŠä¸éœ€è¦è€ƒè™‘é” ç½‘ç»œio å¤šè·¯å¤ç”¨ å¯ä»¥è®©å•ä¸ªçº¿ç¨‹å¤„ç†å¤šä¸ªè¯·æ±‚è¿æ¥ å‡å°‘ç½‘ç»œio Redisé‡‡ç”¨è‡ªå·±å®ç°çš„äº‹ä»¶åˆ†ç¦»å™¨ï¼Œæ•ˆç‡æ¯”è¾ƒé«˜ï¼Œå†…éƒ¨é‡‡ç”¨éé˜»å¡çš„æ‰§è¡Œæ–¹å¼ï¼Œååèƒ½åŠ›æ¯”è¾ƒå¤§ã€‚ æŒä¹…åŒ– ä¸¤ç§æŒä¹…åŒ–ï¼š RDBæŒä¹…åŒ– å³å†…å­˜æ•°æ®å®šæ—¶dumpåˆ°ç£ç›˜ä¸Šã€‚ fork ä¸€ä¸ªå­è¿›ç¨‹ å°†æ•°æ®å†™å…¥ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ å†™å…¥æˆåŠŸå æ›¿æ¢æºæ–‡ä»¶ã€‚ å¿«ç…§çš„æ•°æ®æ˜¯æˆªæ­¢forkå‘½ä»¤æ‰§è¡Œçš„é‚£ä¸€åˆ» AOF å°†Redisçš„æ“ä½œæ—¥å¿—ä»¥è¿½åŠ çš„æ–¹å¼å†™å…¥æ–‡ä»¶ã€‚ å°†æ¯ä¸€ä¸ªå†™ã€åˆ æ“ä½œè®°å½•ä¸‹æ¥ã€‚é»˜è®¤é…ç½®æ—¶æ¯ç§’åŒæ­¥ä¸€æ¬¡ã€‚ RDBå­˜åœ¨å“ªäº›ä¼˜åŠ¿å‘¢ï¼Ÿ 1). ä¸€æ—¦é‡‡ç”¨è¯¥æ–¹å¼ï¼Œé‚£ä¹ˆä½ çš„æ•´ä¸ªRedisæ•°æ®åº“å°†åªåŒ…å«ä¸€ä¸ªæ–‡ä»¶ï¼Œè¿™å¯¹äºæ–‡ä»¶å¤‡ä»½è€Œè¨€æ˜¯éå¸¸å®Œç¾çš„ã€‚æ¯”å¦‚ï¼Œä½ å¯èƒ½æ‰“ç®—æ¯ä¸ªå°æ—¶å½’æ¡£ä¸€æ¬¡æœ€è¿‘24å°æ—¶çš„æ•°æ®ï¼ŒåŒæ—¶è¿˜è¦æ¯å¤©å½’æ¡£ä¸€æ¬¡æœ€è¿‘30å¤©çš„æ•°æ®ã€‚é€šè¿‡è¿™æ ·çš„å¤‡ä»½ç­–ç•¥ï¼Œä¸€æ—¦ç³»ç»Ÿå‡ºç°ç¾éš¾æ€§æ•…éšœï¼Œæˆ‘ä»¬å¯ä»¥éå¸¸å®¹æ˜“çš„è¿›è¡Œæ¢å¤ã€‚ 2). å¯¹äºç¾éš¾æ¢å¤è€Œè¨€ï¼ŒRDBæ˜¯éå¸¸ä¸é”™çš„é€‰æ‹©ã€‚å› ä¸ºæˆ‘ä»¬å¯ä»¥éå¸¸è½»æ¾çš„å°†ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶å‹ç¼©åå†è½¬ç§»åˆ°å…¶å®ƒå­˜å‚¨ä»‹è´¨ä¸Šã€‚ 3). æ€§èƒ½æœ€å¤§åŒ–ã€‚å¯¹äºRedisçš„æœåŠ¡è¿›ç¨‹è€Œè¨€ï¼Œåœ¨å¼€å§‹æŒä¹…åŒ–æ—¶ï¼Œå®ƒå”¯ä¸€éœ€è¦åšçš„åªæ˜¯forkå‡ºå­è¿›ç¨‹ï¼Œä¹‹åå†ç”±å­è¿›ç¨‹å®Œæˆè¿™äº›æŒä¹…åŒ–çš„å·¥ä½œï¼Œè¿™æ ·å°±å¯ä»¥æå¤§çš„é¿å…æœåŠ¡è¿›ç¨‹æ‰§è¡ŒIOæ“ä½œäº†ã€‚ 4). ç›¸æ¯”äºAOFæœºåˆ¶ï¼Œå¦‚æœæ•°æ®é›†å¾ˆå¤§ï¼ŒRDBçš„å¯åŠ¨æ•ˆç‡ä¼šæ›´é«˜ã€‚ RDBåˆå­˜åœ¨å“ªäº›åŠ£åŠ¿å‘¢ï¼Ÿ 1). å¦‚æœä½ æƒ³ä¿è¯æ•°æ®çš„é«˜å¯ç”¨æ€§ï¼Œå³æœ€å¤§é™åº¦çš„é¿å…æ•°æ®ä¸¢å¤±ï¼Œé‚£ä¹ˆRDBå°†ä¸æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚å› ä¸ºç³»ç»Ÿä¸€æ—¦åœ¨å®šæ—¶æŒä¹…åŒ–ä¹‹å‰å‡ºç°å®•æœºç°è±¡ï¼Œæ­¤å‰æ²¡æœ‰æ¥å¾—åŠå†™å…¥ç£ç›˜çš„æ•°æ®éƒ½å°†ä¸¢å¤±ã€‚ 2). ç”±äºRDBæ˜¯é€šè¿‡forkå­è¿›ç¨‹æ¥ååŠ©å®Œæˆæ•°æ®æŒä¹…åŒ–å·¥ä½œçš„ï¼Œå› æ­¤ï¼Œå¦‚æœå½“æ•°æ®é›†è¾ƒå¤§æ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•´ä¸ªæœåŠ¡å™¨åœæ­¢æœåŠ¡å‡ ç™¾æ¯«ç§’ï¼Œç”šè‡³æ˜¯1ç§’é’Ÿã€‚ AOFçš„ä¼˜åŠ¿æœ‰å“ªäº›å‘¢ï¼Ÿ 1). è¯¥æœºåˆ¶å¯ä»¥å¸¦æ¥æ›´é«˜çš„æ•°æ®å®‰å…¨æ€§ï¼Œå³æ•°æ®æŒä¹…æ€§ã€‚Redisä¸­æä¾›äº†3ä¸­åŒæ­¥ç­–ç•¥ï¼Œå³æ¯ç§’åŒæ­¥ã€æ¯ä¿®æ”¹åŒæ­¥å’Œä¸åŒæ­¥ã€‚äº‹å®ä¸Šï¼Œæ¯ç§’åŒæ­¥ä¹Ÿæ˜¯å¼‚æ­¥å®Œæˆçš„ï¼Œå…¶æ•ˆç‡ä¹Ÿæ˜¯éå¸¸é«˜çš„ï¼Œæ‰€å·®çš„æ˜¯ä¸€æ—¦ç³»ç»Ÿå‡ºç°å®•æœºç°è±¡ï¼Œé‚£ä¹ˆè¿™ä¸€ç§’é’Ÿä¹‹å†…ä¿®æ”¹çš„æ•°æ®å°†ä¼šä¸¢å¤±ã€‚è€Œæ¯ä¿®æ”¹åŒæ­¥ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶è§†ä¸ºåŒæ­¥æŒä¹…åŒ–ï¼Œå³æ¯æ¬¡å‘ç”Ÿçš„æ•°æ®å˜åŒ–éƒ½ä¼šè¢«ç«‹å³è®°å½•åˆ°ç£ç›˜ä¸­ã€‚å¯ä»¥é¢„è§ï¼Œè¿™ç§æ–¹å¼åœ¨æ•ˆç‡ä¸Šæ˜¯æœ€ä½çš„ã€‚è‡³äºæ— åŒæ­¥ï¼Œæ— éœ€å¤šè¨€ï¼Œæˆ‘æƒ³å¤§å®¶éƒ½èƒ½æ­£ç¡®çš„ç†è§£å®ƒã€‚ 2). ç”±äºè¯¥æœºåˆ¶å¯¹æ—¥å¿—æ–‡ä»¶çš„å†™å…¥æ“ä½œé‡‡ç”¨çš„æ˜¯appendæ¨¡å¼ï¼Œå› æ­¤åœ¨å†™å…¥è¿‡ç¨‹ä¸­å³ä½¿å‡ºç°å®•æœºç°è±¡ï¼Œä¹Ÿä¸ä¼šç ´åæ—¥å¿—æ–‡ä»¶ä¸­å·²ç»å­˜åœ¨çš„å†…å®¹ã€‚ç„¶è€Œå¦‚æœæˆ‘ä»¬æœ¬æ¬¡æ“ä½œåªæ˜¯å†™å…¥äº†ä¸€åŠæ•°æ®å°±å‡ºç°äº†ç³»ç»Ÿå´©æºƒé—®é¢˜ï¼Œä¸ç”¨æ‹…å¿ƒï¼Œåœ¨Redisä¸‹ä¸€æ¬¡å¯åŠ¨ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡redis-check-aofå·¥å…·æ¥å¸®åŠ©æˆ‘ä»¬è§£å†³æ•°æ®ä¸€è‡´æ€§çš„é—®é¢˜ã€‚ 3). å¦‚æœæ—¥å¿—è¿‡å¤§ï¼ŒRediså¯ä»¥è‡ªåŠ¨å¯ç”¨rewriteæœºåˆ¶ã€‚å³Redisä»¥appendæ¨¡å¼ä¸æ–­çš„å°†ä¿®æ”¹æ•°æ®å†™å…¥åˆ°è€çš„ç£ç›˜æ–‡ä»¶ä¸­ï¼ŒåŒæ—¶Redisè¿˜ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶ç”¨äºè®°å½•æ­¤æœŸé—´æœ‰å“ªäº›ä¿®æ”¹å‘½ä»¤è¢«æ‰§è¡Œã€‚å› æ­¤åœ¨è¿›è¡Œrewriteåˆ‡æ¢æ—¶å¯ä»¥æ›´å¥½çš„ä¿è¯æ•°æ®å®‰å…¨æ€§ã€‚ 4). AOFåŒ…å«ä¸€ä¸ªæ ¼å¼æ¸…æ™°ã€æ˜“äºç†è§£çš„æ—¥å¿—æ–‡ä»¶ç”¨äºè®°å½•æ‰€æœ‰çš„ä¿®æ”¹æ“ä½œã€‚äº‹å®ä¸Šï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡è¯¥æ–‡ä»¶å®Œæˆæ•°æ®çš„é‡å»ºã€‚ AOFçš„åŠ£åŠ¿æœ‰å“ªäº›å‘¢ï¼Ÿ 1). å¯¹äºç›¸åŒæ•°é‡çš„æ•°æ®é›†è€Œè¨€ï¼ŒAOFæ–‡ä»¶é€šå¸¸è¦å¤§äºRDBæ–‡ä»¶ã€‚RDB åœ¨æ¢å¤å¤§æ•°æ®é›†æ—¶çš„é€Ÿåº¦æ¯” AOF çš„æ¢å¤é€Ÿåº¦è¦å¿«ã€‚ 2). æ ¹æ®åŒæ­¥ç­–ç•¥çš„ä¸åŒï¼ŒAOFåœ¨è¿è¡Œæ•ˆç‡ä¸Šå¾€å¾€ä¼šæ…¢äºRDBã€‚æ€»ä¹‹ï¼Œæ¯ç§’åŒæ­¥ç­–ç•¥çš„æ•ˆç‡æ˜¯æ¯”è¾ƒé«˜çš„ï¼ŒåŒæ­¥ç¦ç”¨ç­–ç•¥çš„æ•ˆç‡å’ŒRDBä¸€æ ·é«˜æ•ˆã€‚ äºŒè€…é€‰æ‹©çš„æ ‡å‡†ï¼Œå°±æ˜¯çœ‹ç³»ç»Ÿæ˜¯æ„¿æ„ç‰ºç‰²ä¸€äº›æ€§èƒ½ï¼Œæ¢å–æ›´é«˜çš„ç¼“å­˜ä¸€è‡´æ€§ï¼ˆaofï¼‰ï¼Œè¿˜æ˜¯æ„¿æ„å†™æ“ä½œé¢‘ç¹çš„æ—¶å€™ï¼Œä¸å¯ç”¨å¤‡ä»½æ¥æ¢å–æ›´é«˜çš„æ€§èƒ½ï¼Œå¾…æ‰‹åŠ¨è¿è¡Œsaveçš„æ—¶å€™ï¼Œå†åšå¤‡ä»½ï¼ˆrdbï¼‰ã€‚rdbè¿™ä¸ªå°±æ›´æœ‰äº› eventually consistentçš„æ„æ€äº†ã€‚ å†…å­˜æ¨¡å‹ å†…å­˜æ¨¡å‹ ","date":"2021-05-31","objectID":"/posts/go-interview/:1:2","tags":["é¢è¯•","ç»éªŒ"],"title":"Go é¢è¯•æ€»ç»“","uri":"/posts/go-interview/"},{"categories":["é¢è¯•"],"content":"MongoDB å¾…è¡¥å…… ","date":"2021-05-31","objectID":"/posts/go-interview/:1:3","tags":["é¢è¯•","ç»éªŒ"],"title":"Go é¢è¯•æ€»ç»“","uri":"/posts/go-interview/"},{"categories":["é¢è¯•"],"content":"ç¼“å­˜ å¸¸è§ç¼“å­˜ç­–ç•¥ ä¸€è‡´æ€§å“ˆå¸Œ è§£å†³æŸä¸ªç¼“å­˜èŠ‚ç‚¹å®•æœºçš„æƒ…å†µã€‚ ç¼“å­˜ç©¿é€ æè¿°ï¼šç¼“å­˜ç©¿é€æ˜¯æŒ‡ç¼“å­˜å’Œæ•°æ®åº“ä¸­éƒ½æ²¡æœ‰çš„æ•°æ®ï¼Œè€Œç”¨æˆ·ä¸æ–­å‘èµ·è¯·æ±‚ï¼Œå¦‚å‘èµ·ä¸ºidä¸ºâ€œ-1â€çš„æ•°æ®æˆ–idä¸ºç‰¹åˆ«å¤§ä¸å­˜åœ¨çš„æ•°æ®ã€‚è¿™æ—¶çš„ç”¨æˆ·å¾ˆå¯èƒ½æ˜¯æ”»å‡»è€…ï¼Œæ”»å‡»ä¼šå¯¼è‡´æ•°æ®åº“å‹åŠ›è¿‡å¤§ã€‚ è§£å†³æ–¹æ¡ˆï¼š æ¥å£å±‚å¢åŠ æ ¡éªŒï¼Œå¦‚ç”¨æˆ·é‰´æƒæ ¡éªŒï¼ŒidåšåŸºç¡€æ ¡éªŒï¼Œid\u003c=0çš„ç›´æ¥æ‹¦æˆªã€‚ ä»ç¼“å­˜å–ä¸åˆ°çš„æ•°æ®ï¼Œåœ¨æ•°æ®åº“ä¸­ä¹Ÿæ²¡æœ‰å–åˆ°ï¼Œè¿™æ—¶ä¹Ÿå¯ä»¥å°†key-valueå¯¹å†™ä¸ºkey-nullï¼Œç¼“å­˜æœ‰æ•ˆæ—¶é—´å¯ä»¥è®¾ç½®çŸ­ç‚¹ï¼Œå¦‚30ç§’ï¼ˆè®¾ç½®å¤ªé•¿ä¼šå¯¼è‡´æ­£å¸¸æƒ…å†µä¹Ÿæ²¡æ³•ä½¿ç”¨ï¼‰ã€‚è¿™æ ·å¯ä»¥é˜²æ­¢æ”»å‡»ç”¨æˆ·åå¤ç”¨åŒä¸€ä¸ªidæš´åŠ›æ”»å‡»ã€‚ å¸ƒéš†è¿‡æ»¤å™¨ï¼šå°†æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„æ•°æ®å“ˆå¸Œåˆ°ä¸€ä¸ªè¶³å¤Ÿå¤§çš„bitmapä¸­ï¼Œä¸€ä¸ªä¸€å®šä¸å­˜åœ¨çš„æ•°æ®ä¼šè¢« è¿™ä¸ªbitmapæ‹¦æˆªæ‰ï¼Œä»è€Œé¿å…äº†å¯¹åº•å±‚å­˜å‚¨ç³»ç»Ÿçš„æŸ¥è¯¢å‹åŠ›ã€‚ å¸ƒéš†è¿‡æ»¤å™¨åŸç†ï¼šå¯¹keyè¿›è¡Œå¤šä¸ª(n)hashç®—æ³• å¹¶å°†å…¶å€¼ä¸ bitArray é•¿åº¦m è¿›è¡Œå–æ¨¡ å¹¶å¯¹åº”çš„ä½ç½®ç½®ä½1ï¼Œå½“ä¸€ä¸ªæ–°çš„keyè¿›è¡ŒæŸ¥è¯¢æ—¶ å…ˆæŸ¥è¯¢å…¶nä¸ªhashç®—æ³•åçš„å„ä¸ªä½ç½®æ˜¯å¦ä¸º1 å¦‚æœéƒ½ä¸º1 åˆ™è¿™ä¸ªkeyå¯èƒ½å­˜åœ¨ å¦‚æœæœ‰ä»»æ„ä¸€ä¸ªä½ç½®ä¸æ˜¯1 åˆ™è¿™ä¸ªkey ä¸€å®šä¸å­˜åœ¨ã€‚ ç¼“å­˜å‡»ç©¿ æè¿°ï¼šç¼“å­˜å‡»ç©¿æ˜¯æŒ‡ç¼“å­˜ä¸­æ²¡æœ‰ä½†æ•°æ®åº“ä¸­æœ‰çš„æ•°æ®ï¼ˆä¸€èˆ¬æ˜¯ç¼“å­˜æ—¶é—´åˆ°æœŸï¼‰ï¼Œè¿™æ—¶ç”±äºå¹¶å‘ç”¨æˆ·ç‰¹åˆ«å¤šï¼ŒåŒæ—¶è¯»ç¼“å­˜æ²¡è¯»åˆ°æ•°æ®ï¼ŒåˆåŒæ—¶å»æ•°æ®åº“å»å–æ•°æ®ï¼Œå¼•èµ·æ•°æ®åº“å‹åŠ›ç¬é—´å¢å¤§ï¼Œé€ æˆè¿‡å¤§å‹åŠ› è§£å†³æ–¹æ¡ˆï¼š çƒ­ç‚¹æ•°æ®ä¸åšè¿‡æœŸ äº’æ–¥é”ã€‚å¦‚æœæ•°æ®ç¼“å­˜ä¸å­˜åœ¨ åˆ™å…ˆè¿›è¡Œä¸Šé”è¯»æ•°æ®å†™ç¼“å­˜é‡Šæ”¾é” ç¼“å­˜é›ªå´© æè¿°ï¼šç¼“å­˜é›ªå´©æ˜¯æŒ‡ç¼“å­˜ä¸­æ•°æ®å¤§æ‰¹é‡åˆ°è¿‡æœŸæ—¶é—´ï¼Œè€ŒæŸ¥è¯¢æ•°æ®é‡å·¨å¤§ï¼Œå¼•èµ·æ•°æ®åº“å‹åŠ›è¿‡å¤§ç”šè‡³downæœºã€‚å’Œç¼“å­˜å‡»ç©¿ä¸åŒçš„æ˜¯ï¼Œç¼“å­˜å‡»ç©¿æŒ‡å¹¶å‘æŸ¥åŒä¸€æ¡æ•°æ®ï¼Œç¼“å­˜é›ªå´©æ˜¯ä¸åŒæ•°æ®éƒ½è¿‡æœŸäº†ï¼Œå¾ˆå¤šæ•°æ®éƒ½æŸ¥ä¸åˆ°ä»è€ŒæŸ¥æ•°æ®åº“ã€‚ è§£å†³æ–¹æ¡ˆï¼š è¿‡æœŸæ—¶é—´åŠ éšæœºæ•° çƒ­ç‚¹æ•°æ®ä¸è¿‡æœŸ åˆ†å¸ƒå¼ç¼“å­˜ å°†çƒ­ç‚¹æ•°æ®æ‹†åˆ†åˆ°ä¸åŒçš„å®ä¾‹ ","date":"2021-05-31","objectID":"/posts/go-interview/:1:4","tags":["é¢è¯•","ç»éªŒ"],"title":"Go é¢è¯•æ€»ç»“","uri":"/posts/go-interview/"},{"categories":["é¢è¯•"],"content":"è¯­è¨€ç‰¹æ€§ ","date":"2021-05-31","objectID":"/posts/go-interview/:2:0","tags":["é¢è¯•","ç»éªŒ"],"title":"Go é¢è¯•æ€»ç»“","uri":"/posts/go-interview/"},{"categories":["é¢è¯•"],"content":"GMP è°ƒåº¦ è°ƒåº¦2 æ¦‚å¿µ Gï¼šä»£è¡¨ä¸€ä¸ªgoroutineå¯¹è±¡ï¼Œæ¯æ¬¡goè°ƒç”¨çš„æ—¶å€™ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªGå¯¹è±¡ï¼Œå®ƒåŒ…æ‹¬æ ˆã€æŒ‡ä»¤æŒ‡é’ˆä»¥åŠå¯¹äºè°ƒç”¨goroutineså¾ˆé‡è¦çš„å…¶å®ƒä¿¡æ¯ï¼Œæ¯”å¦‚é˜»å¡å®ƒçš„ä»»ä½•channelï¼Œå…¶ä¸»è¦æ•°æ®ç»“æ„ï¼š type g struct { stack stack // æè¿°äº†çœŸå®çš„æ ˆå†…å­˜ï¼ŒåŒ…æ‹¬ä¸Šä¸‹ç•Œ m *m // å½“å‰çš„m sched gobuf // goroutineåˆ‡æ¢æ—¶ï¼Œç”¨äºä¿å­˜gçš„ä¸Šä¸‹æ–‡ param unsafe.Pointer // ç”¨äºä¼ é€’å‚æ•°ï¼Œç¡çœ æ—¶å…¶ä»–goroutineå¯ä»¥è®¾ç½®paramï¼Œå”¤é†’æ—¶è¯¥goroutineå¯ä»¥è·å– atomicstatus uint32 stackLock uint32 goid int64 // goroutineçš„ID waitsince int64 // gè¢«é˜»å¡çš„å¤§ä½“æ—¶é—´ lockedm *m // Gè¢«é”å®šåªåœ¨è¿™ä¸ªmä¸Šè¿è¡Œ } M: ä»£è¡¨å†…æ ¸çº¿ç¨‹(Pthread)ï¼Œå®ƒæœ¬èº«å°±ä¸ä¸€ä¸ªå†…æ ¸çº¿ç¨‹è¿›è¡Œç»‘å®šï¼Œgoroutine è¿è¡Œåœ¨Mä¸Šã€‚ type m struct { /* 1. æ‰€æœ‰è°ƒç”¨æ ˆçš„Goroutine,è¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒç‰¹æ®Šçš„Goroutineã€‚ 2. æ™®é€šçš„Goroutineæ ˆæ˜¯åœ¨Heapåˆ†é…çš„å¯å¢é•¿çš„stack,è€Œg0çš„stackæ˜¯Må¯¹åº”çš„çº¿ç¨‹æ ˆã€‚ 3. æ‰€æœ‰è°ƒåº¦ç›¸å…³ä»£ç ,ä¼šå…ˆåˆ‡æ¢åˆ°è¯¥Goroutineçš„æ ˆå†æ‰§è¡Œã€‚ */ g0 *g curg *g // Må½“å‰ç»‘å®šçš„ç»“æ„ä½“G // SPã€PCå¯„å­˜å™¨ç”¨äºç°åœºä¿æŠ¤å’Œç°åœºæ¢å¤ vdsoSP uintptr vdsoPC uintptr // çœç•¥â€¦} Pï¼šP(Processor)æ˜¯ä¸€ä¸ªæŠ½è±¡çš„æ¦‚å¿µï¼Œå¹¶ä¸æ˜¯çœŸæ­£çš„ç‰©ç†CPUã€‚æ‰€ä»¥å½“Pæœ‰ä»»åŠ¡æ—¶éœ€è¦åˆ›å»ºæˆ–è€…å”¤é†’ä¸€ä¸ªç³»ç»Ÿçº¿ç¨‹æ¥æ‰§è¡Œå®ƒé˜Ÿåˆ—é‡Œçš„ä»»åŠ¡ã€‚æ‰€ä»¥P/Méœ€è¦è¿›è¡Œç»‘å®šï¼Œæ„æˆä¸€ä¸ªæ‰§è¡Œå•å…ƒã€‚ På†³å®šäº†åŒæ—¶å¯ä»¥å¹¶å‘ä»»åŠ¡çš„æ•°é‡ï¼Œå¯é€šè¿‡GOMAXPROCSé™åˆ¶åŒæ—¶æ‰§è¡Œç”¨æˆ·çº§ä»»åŠ¡çš„æ“ä½œç³»ç»Ÿçº¿ç¨‹ã€‚å¯ä»¥é€šè¿‡runtime.GOMAXPROCSè¿›è¡ŒæŒ‡å®šã€‚åœ¨Go1.5ä¹‹åGOMAXPROCSè¢«é»˜è®¤è®¾ç½®å¯ç”¨çš„æ ¸æ•°ï¼Œè€Œä¹‹å‰åˆ™é»˜è®¤ä¸º1ã€‚ // è‡ªå®šä¹‰è®¾ç½®GOMAXPROCSæ•°é‡ func GOMAXPROCS(n int) int { /* 1. GOMAXPROCSè®¾ç½®å¯æ‰§è¡Œçš„CPUçš„æœ€å¤§æ•°é‡,åŒæ—¶è¿”å›ä¹‹å‰çš„è®¾ç½®ã€‚ 2. å¦‚æœn \u003c 1,åˆ™ä¸æ›´æ”¹å½“å‰çš„å€¼ã€‚ */ ret := int(gomaxprocs) stopTheWorld(\"GOMAXPROCS\") // startTheWorldå¯åŠ¨æ—¶,ä½¿ç”¨newprocsã€‚ newprocs = int32(n) startTheWorld() return ret } // é»˜è®¤Pè¢«ç»‘å®šåˆ°æ‰€æœ‰CPUæ ¸ä¸Š // P == cpu.cores func getproccount() int32 { const maxCPUs = 64 * 1024 var buf [maxCPUs / 8]byte // è·å–CPU Core r := sched_getaffinity(0, unsafe.Sizeof(buf), \u0026buf[0]) n := int32(0) for _, v := range buf[:r] { for v != 0 { n += int32(v \u0026 1) v \u003e\u003e= 1 } } if n == 0 { n = 1 } return n } // ä¸€ä¸ªè¿›ç¨‹é»˜è®¤è¢«ç»‘å®šåœ¨æ‰€æœ‰CPUæ ¸ä¸Š,è¿”å›æ‰€æœ‰CPU coreã€‚ // è·å–è¿›ç¨‹çš„CPUäº²å’Œæ€§æ©ç ç³»ç»Ÿè°ƒç”¨ // rax 204 ; ç³»ç»Ÿè°ƒç”¨ç  // system_call sys_sched_getaffinity; ç³»ç»Ÿè°ƒç”¨åç§° // rid pid ; è¿›ç¨‹å· // rsi unsigned int len // rdx unsigned long *user_mask_ptr sys_linux_amd64.s: TEXT runtimeÂ·sched_getaffinity(SB),NOSPLIT,$0 MOVQ pid+0(FP), DI MOVQ len+8(FP), SI MOVQ buf+16(FP), DX MOVL $SYS_sched_getaffinity, AX SYSCALL MOVL AX, ret+24(FP) RET è°ƒåº¦è¿‡ç¨‹ é¦–å…ˆåˆ›å»ºä¸€ä¸ªGå¯¹è±¡ï¼ŒGå¯¹è±¡ä¿å­˜åˆ°Pæœ¬åœ°é˜Ÿåˆ—æˆ–è€…æ˜¯å…¨å±€é˜Ÿåˆ—ã€‚Pæ­¤æ—¶å»å”¤é†’ä¸€ä¸ªMã€‚Pç»§ç»­æ‰§è¡Œå®ƒçš„æ‰§è¡Œåºã€‚Må¯»æ‰¾æ˜¯å¦æœ‰ç©ºé—²çš„Pï¼Œå¦‚æœæœ‰åˆ™å°†è¯¥Gå¯¹è±¡ç§»åŠ¨åˆ°å®ƒæœ¬èº«ã€‚æ¥ä¸‹æ¥Mæ‰§è¡Œä¸€ä¸ªè°ƒåº¦å¾ªç¯(è°ƒç”¨Gå¯¹è±¡-\u003eæ‰§è¡Œ-\u003eæ¸…ç†çº¿ç¨‹â†’ç»§ç»­æ‰¾æ–°çš„Goroutineæ‰§è¡Œ)ã€‚ Mæ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œéšæ—¶ä¼šå‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚å½“å‘ç”Ÿä¸Šçº¿æ–‡åˆ‡æ¢æ—¶ï¼Œéœ€è¦å¯¹æ‰§è¡Œç°åœºè¿›è¡Œä¿æŠ¤ï¼Œä»¥ä¾¿ä¸‹æ¬¡è¢«è°ƒåº¦æ‰§è¡Œæ—¶è¿›è¡Œç°åœºæ¢å¤ã€‚Goè°ƒåº¦å™¨Mçš„æ ˆä¿å­˜åœ¨Gå¯¹è±¡ä¸Šï¼Œåªéœ€è¦å°†Mæ‰€éœ€è¦çš„å¯„å­˜å™¨(SPã€PCç­‰)ä¿å­˜åˆ°Gå¯¹è±¡ä¸Šå°±å¯ä»¥å®ç°ç°åœºä¿æŠ¤ã€‚å½“è¿™äº›å¯„å­˜å™¨æ•°æ®è¢«ä¿æŠ¤èµ·æ¥ï¼Œå°±éšæ—¶å¯ä»¥åšä¸Šä¸‹æ–‡åˆ‡æ¢äº†ï¼Œåœ¨ä¸­æ–­ä¹‹å‰æŠŠç°åœºä¿å­˜èµ·æ¥ã€‚å¦‚æœæ­¤æ—¶Gä»»åŠ¡è¿˜æ²¡æœ‰æ‰§è¡Œå®Œï¼ŒMå¯ä»¥å°†ä»»åŠ¡é‡æ–°ä¸¢åˆ°Pçš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡è¢«è°ƒåº¦æ‰§è¡Œã€‚å½“å†æ¬¡è¢«è°ƒåº¦æ‰§è¡Œæ—¶ï¼ŒMé€šè¿‡è®¿é—®Gçš„vdsoSPã€vdsoPCå¯„å­˜å™¨è¿›è¡Œç°åœºæ¢å¤(ä»ä¸Šæ¬¡ä¸­æ–­ä½ç½®ç»§ç»­æ‰§è¡Œ)ã€‚ å¤šä¸ªçº¿ç¨‹ä¸‹å¦‚ä½•è°ƒåº¦ æŠ›å‡ºä¸€ä¸ªé—®é¢˜ï¼šæ¯ä¸ªPé‡Œé¢çš„Gæ‰§è¡Œæ—¶é—´æ˜¯ä¸å¯æ§çš„ï¼Œå¦‚æœå¤šä¸ªPåŒæ—¶åœ¨æ‰§è¡Œï¼Œä¼šä¸ä¼šå‡ºç°æœ‰çš„Pé‡Œé¢çš„Gæ‰§è¡Œä¸å®Œï¼Œæœ‰çš„Pé‡Œé¢å‡ ä¹æ²¡æœ‰Gå¯æ‰§è¡Œå‘¢ï¼Ÿ è¿™å°±è¦ä»Mçš„è‡ªå¾ªç¯è¿‡ç¨‹ä¸­å¦‚ä½•è·å–Gã€å½’è¿˜Gçš„è¡Œä¸ºè¯´èµ·äº† æœ‰ä¸¤ç§é€”å¾„ï¼š1.å€ŸåŠ©å…¨å±€é˜Ÿåˆ— sched.runq ä½œä¸ºä¸­ä»‹ï¼Œæœ¬åœ°Pé‡Œçš„Gå¤ªå¤šçš„è¯å°±æ”¾å…¨å±€é‡Œï¼ŒGå¤ªå°‘çš„è¯å°±ä»å…¨å±€å–ã€‚ 2.å…¨å±€åˆ—è¡¨é‡Œæ²¡æœ‰çš„è¯ç›´æ¥ä»P1é‡Œå·å–(steal)ã€‚(æ›´å¤šMåœ¨æ‰§è¡Œçš„è¯ï¼ŒåŒæ ·çš„åŸç†ï¼Œè¿™é‡Œå°±åªæ‹¿2ä¸ªæ¥ä¸¾ä¾‹) è°ƒåº¦å¾ªç¯ä¸­å¦‚ä½•è®©å‡ºCPU æ­£å¸¸å®Œæˆè®©å‡ºCPU ä¸»åŠ¨è®©å‡ºCPU time.Sleep(),IOé˜»å¡ç­‰ æŠ¢å è®©å‡ºCPU æŠ¢å å¼è°ƒåº¦ æ¦‚å¿µï¼šæšä¸¾æ‰€æœ‰çš„P å¦‚æœPåœ¨ç³»ç»Ÿè°ƒç”¨ä¸­(_Psyscall), ä¸”ç»è¿‡äº†ä¸€æ¬¡sysmonå¾ªç¯(20us~10ms), åˆ™æŠ¢å è¿™ä¸ªPï¼Œ è°ƒç”¨handoffpè§£é™¤Må’ŒPä¹‹é—´çš„å…³è”ï¼Œ å¦‚æœPåœ¨è¿è¡Œä¸­(_Prunning), ä¸”ç»è¿‡äº†ä¸€æ¬¡sysmonå¾ªç¯å¹¶ä¸”Gè¿è¡Œæ—¶é—´è¶…è¿‡forcePreemptNS(10ms), åˆ™æŠ¢å è¿™ä¸ªP å¹¶è®¾ç½®g.preempt = trueï¼Œg.stackguard0 = stackPreemptã€‚ ä¸ºä»€ä¹ˆè®¾ç½®äº†stackguardå°±å¯ä»¥å®ç°æŠ¢å ? å› ä¸ºè¿™ä¸ªå€¼ç”¨äºæ£€æŸ¥å½“å‰æ ˆç©ºé—´æ˜¯å¦è¶³å¤Ÿ, goå‡½æ•°çš„å¼€å¤´ä¼šæ¯”å¯¹è¿™ä¸ªå€¼åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å¼ æ ˆã€‚ newstackå‡½æ•°åˆ¤æ–­g.stackguard0ç­‰äºstackPreempt, å°±çŸ¥é“è¿™æ˜¯æŠ¢å è§¦å‘çš„, è¿™æ—¶ä¼šå†æ£€æŸ¥ä¸€éæ˜¯å¦è¦æŠ¢å ã€‚ æŠ¢å æœºåˆ¶ä¿è¯äº†ä¸ä¼šæœ‰ä¸€ä¸ªGé•¿æ—¶é—´çš„è¿è¡Œå¯¼è‡´å…¶ä»–Gæ— æ³•è¿è¡Œçš„æƒ…å†µå‘ç”Ÿã€‚ ä¸»åŠ¨è®©å‡ºCPU time.Sleep() timeSleep å‡½æ•°é‡Œé€šè¿‡ addtimerLocked æŠŠå®šæ—¶å™¨åŠ å…¥åˆ° timer ç®¡ç†å™¨ï¼ˆtimer é€šè¿‡æœ€å°å †çš„æ•°æ®ç»“æ„å­˜æ”¾æ¯ä¸ªå®šæ—¶å™¨ï¼Œåœ¨è¿™ä¸åšè¯¦ç»†è¯´æ˜ï¼‰åï¼Œå†é€šè¿‡ goparkunlock å®ç°æŠŠå½“å‰Gä¼‘çœ ï¼Œè¿™é‡Œçœ‹åˆ°äº†ä¸Šé¢æåˆ°çš„ gopark æ–¹æ³•è¿›è¡Œè°ƒåº¦å¾ªç¯çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚ åœ¨ addtimerLocked æ–¹æ³•çš„æœ€ä¸‹é¢æœ‰ä¸ªé€»è¾‘åœ¨è¿è¡ŒæœŸé—´å¼€å¯äº†â€™å…¨å±€æ—¶é—´äº‹ä»¶é©±åŠ¨å™¨â€™timerproc,è¯¥æ–¹æ³•ä¼šå…¨ç¨‹éå†æœ€å°å †ï¼Œå¯»æ‰¾æœ€æ—©è¿›å…¥ timer ç®¡ç†å™¨çš„å®šæ—¶å™¨ï¼Œç„¶åå”¤é†’ã€‚ä»–æ˜¯æ€ä¹ˆæ‰¾åˆ°è¦å”¤é†’å“ªä¸ªGçš„ï¼Ÿå›å¤´çœ‹ä¸‹ timeSleep æ–¹æ³•é‡ŒæŠŠå½“æ—¶æ­£åœ¨æ‰§è¡Œçš„Gä»¥åŠå”¤é†’æ–¹æ³• goroutineReady å¸¦åˆ°äº†æ¯ä¸ªå®šæ—¶å™¨é‡Œï¼Œè€Œåœ¨ timerproc åˆ™é€šè¿‡æ‰¾åˆ°æœŸçš„å®šæ—¶å™¨æ‰§è¡Œf(arg, seq) å³é€šè¿‡ goroutineReady æ–¹æ³•å”¤é†’ã€‚æ–¹æ³•è°ƒç”¨è¿‡ç¨‹: goroutineReady() -\u003e ready() // runtime/time.go func timeSleep(ns int64) { if ns \u003c= 0 { return } t := getg().timer if t == nil { t = new(timer) getg().timer = t } *t = timer{} // æ¯ä¸ªå®šæ—¶ä»»åŠ¡éƒ½åˆ›å»ºä¸€ä¸ªtimer t.when = nanotime() + ns t.f = goroutineReady // è®°å½•å”¤é†’è¯¥Gçš„æ–¹æ³•,å”¤é†’æ—¶é€šè¿‡è¯¥æ–¹æ³•æ‰§è¡Œå”¤é†’ t.arg = getg() // æŠŠtimerä¸å½“å‰Gå…³è”,æ—¶é—´åˆ°äº†å”¤é†’æ—¶é€šè¿‡è¯¥å‚æ•°æ‰¾åˆ°æ‰€åœ¨çš„G lock(\u0026timers.lock) addtimerLocked(t) // æŠŠtimeræ·»åŠ åˆ°æœ€å°å †é‡Œ goparkunlock(\u0026timers.lock, \"sleep\", traceEvGoSleep, 2) // åˆ‡åˆ°G0è®©å‡ºCPU,è¿›å…¥ä¼‘çœ  } æ€»ç»“ï¼štime.Sleep æƒ³è¦è¿›å…¥é˜»å¡(ä¼‘çœ )çŠ¶æ€ï¼Œå…¶å®æ˜¯é€šè¿‡ gopark æ–¹æ³•ç»™è‡ªå·±æ ‡è®°ä¸ª_Gwaiting çŠ¶æ€ï¼Œç„¶åæŠŠè‡ªå·±æ‰€å ç”¨çš„CPUçº¿ç¨‹èµ„æºç»™é‡Šæ”¾å‡ºæ¥ï¼Œç»§ç»­æ‰§è¡Œè°ƒåº¦ä»»åŠ¡ï¼Œè°ƒåº¦å…¶å®ƒçš„Gæ¥è¿è¡Œã€‚è€Œå”¤é†’æ˜¯é€šè¿‡æŠŠGæ›´æ”¹å›_Grunnable çŠ¶æ€åï¼Œç„¶åæŠŠGæ”¾å…¥åˆ°Pçš„å¾…è¿è¡Œé˜Ÿåˆ—é‡Œç­‰å¾…æ‰§è¡Œã€‚é€šè¿‡è¿™ç‚¹è¿˜å¯ä»¥çœ‹å‡ºä¼‘çœ ä¸­çš„Gå…¶å®å¹¶ä¸å ç”¨ CPU èµ„æºï¼Œæœ€å¤šæ˜¯å ç”¨å†…å­˜ï¼Œæ˜¯ä¸ªå¾ˆè½»é‡çº§çš„é˜»å¡ã€‚ Mutex Mutex.Lock æ–¹æ³•é€šè¿‡è°ƒç”¨ runtime_SemacquireMutex æœ€ç»ˆè¿˜æ˜¯è°ƒç”¨ goparkunlock å®ç°æŠŠGè¿›å…¥åˆ°ä¼‘çœ çŠ¶æ€ã€‚åœ¨è¿›å…¥ä¼‘çœ ","date":"2021-05-31","objectID":"/posts/go-interview/:2:1","tags":["é¢è¯•","ç»éªŒ"],"title":"Go é¢è¯•æ€»ç»“","uri":"/posts/go-interview/"},{"categories":["é¢è¯•"],"content":"åƒåœ¾å›æ”¶ ä¸‰è‰²æ ‡è®° å“ªäº›æƒ…å†µä¸‹ä¸è¢«åƒåœ¾å›æ”¶ï¼Ÿ å¼ºä¸‰è‰²å’Œå¼±ä¸‰è‰² å†™å±éšœ ","date":"2021-05-31","objectID":"/posts/go-interview/:2:2","tags":["é¢è¯•","ç»éªŒ"],"title":"Go é¢è¯•æ€»ç»“","uri":"/posts/go-interview/"},{"categories":["é¢è¯•"],"content":"channel ","date":"2021-05-31","objectID":"/posts/go-interview/:2:3","tags":["é¢è¯•","ç»éªŒ"],"title":"Go é¢è¯•æ€»ç»“","uri":"/posts/go-interview/"},{"categories":["é¢è¯•"],"content":"slice ","date":"2021-05-31","objectID":"/posts/go-interview/:2:4","tags":["é¢è¯•","ç»éªŒ"],"title":"Go é¢è¯•æ€»ç»“","uri":"/posts/go-interview/"},{"categories":["é¢è¯•"],"content":"map æ€ä¹ˆè§£å†³è¯»å†™å¹¶å‘ï¼ˆé™¤äº†é”ï¼‰ sync.Map äº†è§£ä¸€ä¸‹ ","date":"2021-05-31","objectID":"/posts/go-interview/:2:5","tags":["é¢è¯•","ç»éªŒ"],"title":"Go é¢è¯•æ€»ç»“","uri":"/posts/go-interview/"},{"categories":["é¢è¯•"],"content":"httpåº“ ","date":"2021-05-31","objectID":"/posts/go-interview/:2:6","tags":["é¢è¯•","ç»éªŒ"],"title":"Go é¢è¯•æ€»ç»“","uri":"/posts/go-interview/"},{"categories":["é¢è¯•"],"content":"interface iface æœ‰æ–¹æ³•çš„interface{} eface æ²¡æœ‰æ–¹æ³•çš„interface{} ","date":"2021-05-31","objectID":"/posts/go-interview/:2:7","tags":["é¢è¯•","ç»éªŒ"],"title":"Go é¢è¯•æ€»ç»“","uri":"/posts/go-interview/"},{"categories":["é¢è¯•"],"content":"å…¶ä»– å˜é‡é€ƒé€¸ ","date":"2021-05-31","objectID":"/posts/go-interview/:2:8","tags":["é¢è¯•","ç»éªŒ"],"title":"Go é¢è¯•æ€»ç»“","uri":"/posts/go-interview/"},{"categories":["é¢è¯•"],"content":"é¡¹ç›®ç»éªŒ ","date":"2021-05-31","objectID":"/posts/go-interview/:3:0","tags":["é¢è¯•","ç»éªŒ"],"title":"Go é¢è¯•æ€»ç»“","uri":"/posts/go-interview/"},{"categories":["é¢è¯•"],"content":"å¾®æœåŠ¡ ","date":"2021-05-31","objectID":"/posts/go-interview/:3:1","tags":["é¢è¯•","ç»éªŒ"],"title":"Go é¢è¯•æ€»ç»“","uri":"/posts/go-interview/"},{"categories":["é¢è¯•"],"content":"æœåŠ¡é™æµé™é€Ÿç†”æ–­ æœåŠ¡ç†”æ–­ ","date":"2021-05-31","objectID":"/posts/go-interview/:3:2","tags":["é¢è¯•","ç»éªŒ"],"title":"Go é¢è¯•æ€»ç»“","uri":"/posts/go-interview/"},{"categories":["é¢è¯•"],"content":"æç°ä¸ªäººèƒ½åŠ›çš„ç‚¹ å¼•å…¥ etcdï¼ŒåŸºäº etcd å¼€å‘æœåŠ¡é—´é€šä¿¡çš„åŸºç¡€åº“ è§£å†³æœåŠ¡é—´é€šä¿¡å’ŒæœåŠ¡é€‰ä¸¾é—®é¢˜ å¼•å…¥nsq ä¿®æ”¹æºç  æ”¯æŒå»¶è¿Ÿæ¶ˆæ¯æŒä¹…åŒ–ï¼ŒäºŒæ¬¡å¼€å‘ SDK æ”¯æŒè¿æ¥æ±  å¼€å‘é¡¹ç›®åŸºç¡€æ¶æ„ï¼Œä¸€é”®ç”Ÿæˆæ–°é¡¹ç›® å¼€å‘åŸºç¡€ lib åŒ…ï¼Œwechat åŒ… ï¼Œcommon åŒ…ï¼Œ eventbus-lib ï¼Œhtlog-go æé«˜å¼€å‘æ•ˆç‡ è§„èŒƒåŒ–é¡¹ç›®å¼€å‘+ä¸Šçº¿æµç¨‹ï¼Œè§„èŒƒåŒ–æ¶æ„ å¼€å‘ç»Ÿä¸€çš„å†…éƒ¨æ¶ˆæ¯æœåŠ¡ï¼Œè§„èŒƒå†…æœé£ä¹¦/ä¼ä¸šå¾®ä¿¡æ¶ˆæ¯çš„å‘é€ åå°æœåŠ¡å•ç‚¹ç™»å½•åŠŸèƒ½ æœåŠ¡æ‹†è§£ å‘å¾®æœåŠ¡æ–¹å‘æ”¹è¿› æ•æ„Ÿè¯ å»ºç«‹è¯åº“ç»“æ„ï¼ˆB-treeï¼‰é»‘ç™½åå•çš„ç¼“å­˜ è‡ªæˆ‘ä»‹ç»ï¼š éƒ¨é—¨å†…çš„å®šä½ï¼šåç«¯å¼€å‘+åŸºç¡€æœåŠ¡æ­å»º å…³æ³¨æ–°æŠ€æœ¯ è¡¨ç°å‡ºæŒç»­å­¦ä¹  å²—ä½åŒ¹é…åº¦ ","date":"2021-05-31","objectID":"/posts/go-interview/:3:3","tags":["é¢è¯•","ç»éªŒ"],"title":"Go é¢è¯•æ€»ç»“","uri":"/posts/go-interview/"},{"categories":["é¢è¯•"],"content":"ç³»ç»Ÿè®¾è®¡ ç³»ç»Ÿè®¾è®¡ ","date":"2021-05-31","objectID":"/posts/go-interview/:3:4","tags":["é¢è¯•","ç»éªŒ"],"title":"Go é¢è¯•æ€»ç»“","uri":"/posts/go-interview/"},{"categories":["é¢è¯•"],"content":"ç®—æ³• githubé¡¹ç›® ","date":"2021-05-31","objectID":"/posts/go-interview/:4:0","tags":["é¢è¯•","ç»éªŒ"],"title":"Go é¢è¯•æ€»ç»“","uri":"/posts/go-interview/"},{"categories":["é¢è¯•"],"content":"å † æœ€å°å †/æœ€å¤§å † topK ç®—æ³•çš„å®ç°ï¼š hash åŠ  å°é¡¶å † å †æ’åº ","date":"2021-05-31","objectID":"/posts/go-interview/:4:1","tags":["é¢è¯•","ç»éªŒ"],"title":"Go é¢è¯•æ€»ç»“","uri":"/posts/go-interview/"},{"categories":["é¢è¯•"],"content":"é“¾è¡¨ å•å‘é“¾è¡¨/åŒå‘é“¾è¡¨ é“¾è¡¨æ‰¾ç¯ï¼ˆå¿«æ…¢æŒ‡é’ˆï¼‰ é“¾è¡¨å±€éƒ¨/å…¨éƒ¨æ—‹è½¬ï¼ˆå³ä¿®æ”¹æ–¹å‘ï¼‰ é—®é¢˜ï¼šæŸ¥æ‰¾å€’æ•°ç¬¬ K ä¸ªèŠ‚ç‚¹ ","date":"2021-05-31","objectID":"/posts/go-interview/:4:2","tags":["é¢è¯•","ç»éªŒ"],"title":"Go é¢è¯•æ€»ç»“","uri":"/posts/go-interview/"},{"categories":["é¢è¯•"],"content":"äºŒå‰æ ‘ äºŒå‰æ ‘çš„äº”ç§éå† å‰åº æ ¹-å·¦-å³ ä¸­åº å·¦-æ ¹-å³ ååº å·¦-å³-æ ¹ å±‚æ¬¡éå† ä¸€å±‚ä¸€å±‚ä»å·¦åˆ°å³ é”¯é½¿éå†ï¼ˆså‹éå†ï¼‰æ¯ä¸€å±‚æ¢æ–¹å‘ äºŒå‰æ ‘æŸ¥æ‰¾ æŸ¥æ‰¾æœ€è¿‘è·¯åŠ² æŸ¥æ‰¾å…±åŒç¥–å…ˆï¼ˆæœ€è¿‘ç¥–å…ˆï¼‰ äºŒå‰æ ‘çš„è½¬æ¢ å·¦å³è½¬æ¢ å…¶ä»– æ‰“å°å³è§†å›¾å·¦è§†å›¾ï¼ˆå³æ‰“å°æ¯ä¸€å±‚çš„æœ€å³è¾¹æˆ–æœ€å·¦è¾¹ï¼‰ ","date":"2021-05-31","objectID":"/posts/go-interview/:4:3","tags":["é¢è¯•","ç»éªŒ"],"title":"Go é¢è¯•æ€»ç»“","uri":"/posts/go-interview/"},{"categories":["é¢è¯•"],"content":"å›æº¯æ³•é€’å½’æ³• ç†è§£å›æº¯é€’å½’çš„æ¯ä¸€å±‚å †æ ˆæƒ…å†µï¼Œå­¦ä¼šä»€ä¹ˆæƒ…å†µä¸‹ä½¿ç”¨å›æº¯/é€’å½’ ","date":"2021-05-31","objectID":"/posts/go-interview/:4:4","tags":["é¢è¯•","ç»éªŒ"],"title":"Go é¢è¯•æ€»ç»“","uri":"/posts/go-interview/"},{"categories":["é¢è¯•"],"content":"åŠ¨æ€è§„åˆ’ï¼ˆDPï¼‰ æ‰¾è·¯çº¿æ•°é‡ï¼Œçˆ¬å°é˜¶ï¼ŒèƒŒåŒ…é—®é¢˜ æ•°ç»„ç­‰å’Œåˆ†ç»„é—®é¢˜ ","date":"2021-05-31","objectID":"/posts/go-interview/:4:5","tags":["é¢è¯•","ç»éªŒ"],"title":"Go é¢è¯•æ€»ç»“","uri":"/posts/go-interview/"},{"categories":["é¢è¯•"],"content":"è®¡ç®—æœºåŸºç¡€ ","date":"2021-05-31","objectID":"/posts/go-interview/:5:0","tags":["é¢è¯•","ç»éªŒ"],"title":"Go é¢è¯•æ€»ç»“","uri":"/posts/go-interview/"},{"categories":["é¢è¯•"],"content":"åŸºç¡€æ¦‚å¿µ é—®é¢˜ï¼šæŸ¥çœ‹å½“å‰æœåŠ¡å™¨çš„æ€§èƒ½\u0026æŸ¥çœ‹ go å¼€çš„çº¿ç¨‹æ•°ï¼Ÿ é—®é¢˜ï¼šè¿›ç¨‹çº¿ç¨‹åç¨‹çš„åŒºåˆ«ï¼Ÿ é—®é¢˜ï¼šselect poll epoll çš„åŒºåˆ«ï¼Ÿ select æœ‰å¤§å°é™åˆ¶ æ•ˆç‡ä½ å¯¹ socket æ˜¯çº¿æ€§æ‰«æ åŒæ­¥å¤šè·¯å¤ç”¨ O(n) poll ä¸ select ç±»ä¼¼ ä½†æ˜¯ç”¨çš„é“¾è¡¨ç»“æ„ æ‰€ä»¥æ²¡æœ‰å¤§å°é™åˆ¶ åŒæ­¥å¤šè·¯å¤ç”¨ O(n) epollå¯ä»¥ç†è§£ä¸ºevent pollï¼Œä¸åŒäºå¿™è½®è¯¢å’Œæ— å·®åˆ«è½®è¯¢ï¼Œepollä¼šæŠŠå“ªä¸ªæµå‘ç”Ÿäº†æ€æ ·çš„I/Oäº‹ä»¶é€šçŸ¥æˆ‘ä»¬ã€‚æ‰€ä»¥æˆ‘ä»¬è¯´epollå®é™…ä¸Šæ˜¯äº‹ä»¶é©±åŠ¨ï¼ˆæ¯ä¸ªäº‹ä»¶å…³è”ä¸Šfdï¼‰çš„ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯¹è¿™äº›æµçš„æ“ä½œéƒ½æ˜¯æœ‰æ„ä¹‰çš„ã€‚ï¼ˆå¤æ‚åº¦é™ä½åˆ°äº†O(1)ï¼‰ ç›¸å…³é“¾æ¥ ","date":"2021-05-31","objectID":"/posts/go-interview/:5:1","tags":["é¢è¯•","ç»éªŒ"],"title":"Go é¢è¯•æ€»ç»“","uri":"/posts/go-interview/"},{"categories":["é¢è¯•"],"content":"tcp/udp tcpå¿…å¤‡ é—®é¢˜ï¼štcp time await å‘ç”Ÿåœ¨å“ªç«¯ï¼Ÿ A: å‘ç”Ÿåœ¨å››æ¬¡æŒ¥æ‰‹æ—¶å®¢æˆ·ç«¯ï¼Œæœ€åä¼šç­‰2MSLã€‚ é—®é¢˜ï¼šä¸ºä»€ä¹ˆå®¢æˆ·ç«¯æœ€åè¿˜è¦ç­‰å¾…2MSLï¼Ÿ ç­”ï¼šMSLï¼ˆMaximum Segment Lifetimeï¼‰ï¼ŒTCPå…è®¸ä¸åŒçš„å®ç°å¯ä»¥è®¾ç½®ä¸åŒçš„MSLå€¼ã€‚ç¬¬ä¸€ï¼Œä¿è¯å®¢æˆ·ç«¯å‘é€çš„æœ€åä¸€ä¸ªACKæŠ¥æ–‡èƒ½å¤Ÿåˆ°è¾¾æœåŠ¡å™¨ï¼Œå› ä¸ºè¿™ä¸ªACKæŠ¥æ–‡å¯èƒ½ä¸¢å¤±ã€‚ç«™åœ¨æœåŠ¡å™¨çš„è§’åº¦çœ‹æ¥ï¼Œæˆ‘å·²ç»å‘é€äº†FIN+ACKæŠ¥æ–‡è¯·æ±‚æ–­å¼€äº†ï¼Œå®¢æˆ·ç«¯è¿˜æ²¡æœ‰ç»™æˆ‘å›åº”ï¼Œåº”è¯¥æ˜¯æˆ‘å‘é€çš„è¯·æ±‚æ–­å¼€æŠ¥æ–‡å®ƒæ²¡æœ‰æ”¶åˆ°ï¼Œäºæ˜¯æœåŠ¡å™¨åˆä¼šé‡æ–°å‘é€ä¸€æ¬¡ï¼Œè€Œå®¢æˆ·ç«¯å°±èƒ½åœ¨è¿™ä¸ª2MSLæ—¶é—´æ®µå†…æ”¶åˆ°è¿™ä¸ªé‡ä¼ çš„æŠ¥æ–‡ï¼Œæ¥ç€ç»™å‡ºå›åº”æŠ¥æ–‡ï¼Œå¹¶ä¸”ä¼šé‡å¯2MSLè®¡æ—¶å™¨ã€‚å¦‚æœå®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡ç«¯çš„FIN+ACKæŠ¥æ–‡åï¼Œå‘é€ä¸€ä¸ªACKç»™æœåŠ¡ç«¯ä¹‹åå°±â€œè‡ªç§â€åœ°ç«‹é©¬è¿›å…¥CLOSEDçŠ¶æ€ï¼Œå¯èƒ½ä¼šå¯¼è‡´æœåŠ¡ç«¯æ— æ³•ç¡®è®¤æ”¶åˆ°æœ€åçš„ACKæŒ‡ä»¤ï¼Œä¹Ÿå°±æ— æ³•è¿›å…¥CLOSEDçŠ¶æ€ï¼Œè¿™æ˜¯å®¢æˆ·ç«¯ä¸è´Ÿè´£ä»»çš„è¡¨ç°ã€‚ç¬¬äºŒï¼Œé˜²æ­¢å¤±æ•ˆè¯·æ±‚ã€‚é˜²æ­¢ç±»ä¼¼ä¸â€œä¸‰æ¬¡æ¡æ‰‹â€ä¸­æåˆ°äº†çš„â€œå·²ç»å¤±æ•ˆçš„è¿æ¥è¯·æ±‚æŠ¥æ–‡æ®µâ€å‡ºç°åœ¨æœ¬è¿æ¥ä¸­ã€‚å®¢æˆ·ç«¯å‘é€å®Œæœ€åä¸€ä¸ªç¡®è®¤æŠ¥æ–‡åï¼Œåœ¨è¿™ä¸ª2MSLæ—¶é—´ä¸­ï¼Œå°±å¯ä»¥ä½¿æœ¬è¿æ¥æŒç»­çš„æ—¶é—´å†…æ‰€äº§ç”Ÿçš„æ‰€æœ‰æŠ¥æ–‡æ®µéƒ½ä»ç½‘ç»œä¸­æ¶ˆå¤±ã€‚è¿™æ ·æ–°çš„è¿æ¥ä¸­ä¸ä¼šå‡ºç°æ—§è¿æ¥çš„è¯·æ±‚æŠ¥æ–‡ã€‚ åœ¨TIME_WAITçŠ¶æ€æ— æ³•çœŸæ­£é‡Šæ”¾å¥æŸ„èµ„æºï¼Œåœ¨æ­¤æœŸé—´ï¼ŒSocketä¸­ä½¿ç”¨çš„æœ¬åœ°ç«¯å£åœ¨é»˜è®¤æƒ…å†µä¸‹ä¸èƒ½å†è¢«ä½¿ç”¨ã€‚è¯¥é™åˆ¶å¯¹äºå®¢æˆ·ç«¯æœºå™¨æ¥è¯´æ˜¯æ— æ‰€è°“çš„ï¼Œä½†å¯¹äºé«˜å¹¶å‘æœåŠ¡å™¨æ¥è¯´ï¼Œä¼šæå¤§åœ°é™åˆ¶æœ‰æ•ˆè¿æ¥çš„åˆ›å»ºæ•°é‡ï¼Œç§°ä¸ºæ€§èƒ½ç“¶é¢ˆã€‚æ‰€ä»¥å»ºè®®å°†é«˜å¹¶å‘æœåŠ¡å™¨TIME_WAITè¶…æ—¶æ—¶é—´è°ƒå°ã€‚RFC793ä¸­è§„å®šMSLä¸º2åˆ†é’Ÿã€‚ä½†æ˜¯åœ¨å½“å‰çš„é«˜é€Ÿç½‘ç»œä¸­ï¼Œ2åˆ†é’Ÿçš„ç­‰å¾…æ—¶é—´ä¼šé€ æˆèµ„æºçš„æå¤§æµªè´¹ï¼Œåœ¨é«˜å¹¶å‘æœåŠ¡å™¨ä¸Šé€šå¸¸ä¼šä½¿ç”¨æ›´å°çš„å€¼ã€‚ ","date":"2021-05-31","objectID":"/posts/go-interview/:5:2","tags":["é¢è¯•","ç»éªŒ"],"title":"Go é¢è¯•æ€»ç»“","uri":"/posts/go-interview/"},{"categories":["é¢è¯•"],"content":"http è°ˆè°ˆHTTP https ç›¸å…³ ","date":"2021-05-31","objectID":"/posts/go-interview/:5:3","tags":["é¢è¯•","ç»éªŒ"],"title":"Go é¢è¯•æ€»ç»“","uri":"/posts/go-interview/"},{"categories":["é¢è¯•"],"content":"grpc ","date":"2021-05-31","objectID":"/posts/go-interview/:5:4","tags":["é¢è¯•","ç»éªŒ"],"title":"Go é¢è¯•æ€»ç»“","uri":"/posts/go-interview/"},{"categories":["é¢è¯•"],"content":"å…¶ä»–QA Q: è§£é‡Šgraceful å¹³æ»‘é‡å¯ï¼Ÿ Qï¼š ","date":"2021-05-31","objectID":"/posts/go-interview/:6:0","tags":["é¢è¯•","ç»éªŒ"],"title":"Go é¢è¯•æ€»ç»“","uri":"/posts/go-interview/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"è¯­è¨€ç¯‡ï¼Œæå‡ºå¸¸è§çš„å¼€å‘ä¸Šçš„ä¸å¥½çš„ã€ä¸è§„èŒƒçš„å†™æ³•ï¼Œå¹¶ç»™å‡ºæ›´å¥½çš„å†™æ³•ã€‚ Uber æ˜¯ä¸€å®¶ç¾å›½ç¡…è°·çš„ç§‘æŠ€å…¬å¸ï¼Œä¹Ÿæ˜¯ Go è¯­è¨€çš„æ—©æœŸ adopterã€‚å…¶å¼€æºäº†å¾ˆå¤š golang é¡¹ç›®ï¼Œè¯¸å¦‚è¢« Gopher åœˆç†ŸçŸ¥çš„ zapã€jaeger ç­‰ã€‚2018 å¹´å¹´æœ« Uber å°†å†…éƒ¨çš„ Go é£æ ¼è§„èŒƒ å¼€æºåˆ° GitHubï¼Œç»è¿‡ä¸€å¹´çš„ç§¯ç´¯å’Œæ›´æ–°ï¼Œè¯¥è§„èŒƒå·²ç»åˆå…·è§„æ¨¡ï¼Œå¹¶å—åˆ°å¹¿å¤§ Gopher çš„å…³æ³¨ã€‚æœ¬æ–‡æ˜¯è¯¥è§„èŒƒçš„ä¸­æ–‡ç‰ˆæœ¬ï¼Œå¹¶åŠ ä»¥ä½œè€…ä¸ªäººçš„ä¸€äº›çœ‹æ³•ï¼Œé uber å®˜æ–¹çš„å»ºè®®å’Œçœ‹æ³• æœ¬äººä¼šåŠ ä»¥æ ‡æ³¨ã€‚ ","date":"2020-11-25","objectID":"/posts/go-standard/:0:0","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"ä»‹ç» æ ·å¼ (style) æ˜¯æ”¯é…æˆ‘ä»¬ä»£ç çš„æƒ¯ä¾‹ã€‚æœ¯è¯­æ ·å¼æœ‰ç‚¹ç”¨è¯ä¸å½“ï¼Œå› ä¸ºè¿™äº›çº¦å®šæ¶µç›–çš„èŒƒå›´ä¸é™äºç”± gofmt æ›¿æˆ‘ä»¬å¤„ç†çš„æºæ–‡ä»¶æ ¼å¼ã€‚ æœ¬æŒ‡å—çš„ç›®çš„æ˜¯é€šè¿‡è¯¦ç»†æè¿°åœ¨ Uber ç¼–å†™ Go ä»£ç çš„æ³¨æ„äº‹é¡¹æ¥ç®¡ç†è¿™ç§å¤æ‚æ€§ã€‚è¿™äº›è§„åˆ™çš„å­˜åœ¨æ˜¯ä¸ºäº†ä½¿ä»£ç åº“æ˜“äºç®¡ç†ï¼ŒåŒæ—¶ä»ç„¶å…è®¸å·¥ç¨‹å¸ˆæ›´æœ‰æ•ˆåœ°ä½¿ç”¨ Go è¯­è¨€åŠŸèƒ½ã€‚ è¯¥æŒ‡å—æœ€åˆç”± Prashant Varanasi å’Œ Simon Newton ç¼–å†™ï¼Œç›®çš„æ˜¯ä½¿ä¸€äº›åŒäº‹èƒ½å¿«é€Ÿä½¿ç”¨ Goã€‚å¤šå¹´æ¥ï¼Œè¯¥æŒ‡å—å·²æ ¹æ®å…¶ä»–äººçš„åé¦ˆè¿›è¡Œäº†ä¿®æ”¹ã€‚ æœ¬æ–‡æ¡£è®°å½•äº†æˆ‘ä»¬åœ¨ Uber éµå¾ªçš„ Go ä»£ç ä¸­çš„æƒ¯ç”¨çº¦å®šã€‚å…¶ä¸­è®¸å¤šæ˜¯ Go çš„é€šç”¨å‡†åˆ™ï¼Œè€Œå…¶ä»–æ‰©å±•å‡†åˆ™ä¾èµ–äºä¸‹é¢å¤–éƒ¨çš„æŒ‡å—ï¼š Effective Go The Go common mistakes guide æ‰€æœ‰ä»£ç éƒ½åº”è¯¥é€šè¿‡golintå’Œgo vetçš„æ£€æŸ¥å¹¶æ— é”™è¯¯ã€‚æˆ‘ä»¬å»ºè®®æ‚¨å°†ç¼–è¾‘å™¨è®¾ç½®ä¸ºï¼š ä¿å­˜æ—¶è¿è¡Œ goimports è¿è¡Œ golint å’Œ go vet æ£€æŸ¥é”™è¯¯ æ‚¨å¯ä»¥åœ¨ä»¥ä¸‹ Go ç¼–è¾‘å™¨å·¥å…·æ”¯æŒé¡µé¢ä¸­æ‰¾åˆ°æ›´ä¸ºè¯¦ç»†çš„ä¿¡æ¯ï¼š https://github.com/golang/go/wiki/IDEsAndTextEditorPlugins ","date":"2020-11-25","objectID":"/posts/go-standard/:1:0","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"æŒ‡å¯¼åŸåˆ™ ","date":"2020-11-25","objectID":"/posts/go-standard/:2:0","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"æŒ‡å‘ interface çš„æŒ‡é’ˆ æ‚¨å‡ ä¹ä¸éœ€è¦æŒ‡å‘æ¥å£ç±»å‹çš„æŒ‡é’ˆã€‚æ‚¨åº”è¯¥å°†æ¥å£ä½œä¸ºå€¼è¿›è¡Œä¼ é€’ï¼Œåœ¨è¿™æ ·çš„ä¼ é€’è¿‡ç¨‹ä¸­ï¼Œå®è´¨ä¸Šä¼ é€’çš„åº•å±‚æ•°æ®ä»ç„¶å¯ä»¥æ˜¯æŒ‡é’ˆã€‚ æ¥å£å®è´¨ä¸Šåœ¨åº•å±‚ç”¨ä¸¤ä¸ªå­—æ®µè¡¨ç¤ºï¼š ä¸€ä¸ªæŒ‡å‘æŸäº›ç‰¹å®šç±»å‹ä¿¡æ¯çš„æŒ‡é’ˆã€‚æ‚¨å¯ä»¥å°†å…¶è§†ä¸º\"type\"ã€‚ æ•°æ®æŒ‡é’ˆã€‚å¦‚æœå­˜å‚¨çš„æ•°æ®æ˜¯æŒ‡é’ˆï¼Œåˆ™ç›´æ¥å­˜å‚¨ã€‚å¦‚æœå­˜å‚¨çš„æ•°æ®æ˜¯ä¸€ä¸ªå€¼ï¼Œåˆ™å­˜å‚¨æŒ‡å‘è¯¥å€¼çš„æŒ‡é’ˆã€‚ å¦‚æœå¸Œæœ›æ¥å£æ–¹æ³•ä¿®æ”¹åŸºç¡€æ•°æ®ï¼Œåˆ™å¿…é¡»ä½¿ç”¨æŒ‡é’ˆä¼ é€’(å°†å¯¹è±¡æŒ‡é’ˆèµ‹å€¼ç»™æ¥å£å˜é‡)ã€‚ type F interface { f() } type S1 struct{} func (s S1) f() {} type S2 struct{} func (s *S2) f() {} // f1.f()æ— æ³•ä¿®æ”¹åº•å±‚æ•°æ® // f2.f() å¯ä»¥ä¿®æ”¹åº•å±‚æ•°æ®,ç»™æ¥å£å˜é‡f2èµ‹å€¼æ—¶ä½¿ç”¨çš„æ˜¯å¯¹è±¡æŒ‡é’ˆ var f1 F:= S1{} var f2 F:= \u0026S2{} ","date":"2020-11-25","objectID":"/posts/go-standard/:2:1","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"Interface åˆç†æ€§éªŒè¯ åœ¨ç¼–è¯‘æ—¶éªŒè¯æ¥å£çš„ç¬¦åˆæ€§ã€‚è¿™åŒ…æ‹¬ï¼š å°†å®ç°ç‰¹å®šæ¥å£çš„å¯¼å‡ºç±»å‹ä½œä¸ºæ¥å£API çš„ä¸€éƒ¨åˆ†è¿›è¡Œæ£€æŸ¥ å®ç°åŒä¸€æ¥å£çš„(å¯¼å‡ºå’Œéå¯¼å‡º)ç±»å‹å±äºå®ç°ç±»å‹çš„é›†åˆ ä»»ä½•è¿åæ¥å£åˆç†æ€§æ£€æŸ¥çš„åœºæ™¯,éƒ½ä¼šç»ˆæ­¢ç¼–è¯‘,å¹¶é€šçŸ¥ç»™ç”¨æˆ· è¡¥å……:ä¸Šé¢3æ¡æ˜¯ç¼–è¯‘å™¨å¯¹æ¥å£çš„æ£€æŸ¥æœºåˆ¶, å¤§ä½“æ„æ€æ˜¯é”™è¯¯ä½¿ç”¨æ¥å£ä¼šåœ¨ç¼–è¯‘æœŸæŠ¥é”™. æ‰€ä»¥å¯ä»¥åˆ©ç”¨è¿™ä¸ªæœºåˆ¶è®©éƒ¨åˆ†é—®é¢˜åœ¨ç¼–è¯‘æœŸæš´éœ². Bad Good // å¦‚æœHandleræ²¡æœ‰å®ç°http.Handler,ä¼šåœ¨è¿è¡Œæ—¶æŠ¥é”™ type Handler struct { // ... } func (h *Handler) ServeHTTP( w http.ResponseWriter, r *http.Request, ) { ... } type Handler struct { // ... } // ç”¨äºè§¦å‘ç¼–è¯‘æœŸçš„æ¥å£çš„åˆç†æ€§æ£€æŸ¥æœºåˆ¶ // å¦‚æœHandleræ²¡æœ‰å®ç°http.Handler,ä¼šåœ¨ç¼–è¯‘æœŸæŠ¥é”™ var _ http.Handler = (*Handler)(nil) func (h *Handler) ServeHTTP( w http.ResponseWriter, r *http.Request, ) { // ... } å¦‚æœ *Handler ä¸ http.Handler çš„æ¥å£ä¸åŒ¹é…, é‚£ä¹ˆè¯­å¥ var _ http.Handler = (*Handler)(nil) å°†æ— æ³•ç¼–è¯‘é€šè¿‡. èµ‹å€¼çš„å³è¾¹åº”è¯¥æ˜¯æ–­è¨€ç±»å‹çš„é›¶å€¼ã€‚ å¯¹äºæŒ‡é’ˆç±»å‹ï¼ˆå¦‚ *Handlerï¼‰ã€åˆ‡ç‰‡å’Œæ˜ å°„ï¼Œè¿™æ˜¯ nilï¼› å¯¹äºç»“æ„ç±»å‹ï¼Œè¿™æ˜¯ç©ºç»“æ„ã€‚ type LogHandler struct { h http.Handler log *zap.Logger } var _ http.Handler = LogHandler{} func (h LogHandler) ServeHTTP( w http.ResponseWriter, r *http.Request, ) { // ... } ","date":"2020-11-25","objectID":"/posts/go-standard/:2:2","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"æ¥æ”¶å™¨ (receiver) ä¸æ¥å£ ä½¿ç”¨å€¼æ¥æ”¶å™¨çš„æ–¹æ³•æ—¢å¯ä»¥é€šè¿‡å€¼è°ƒç”¨ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æŒ‡é’ˆè°ƒç”¨ã€‚ å¸¦æŒ‡é’ˆæ¥æ”¶å™¨çš„æ–¹æ³•åªèƒ½é€šè¿‡æŒ‡é’ˆæˆ– addressable valuesè°ƒç”¨. ä¾‹å¦‚ï¼Œ type S struct { data string } func (s S) Read() string { return s.data } func (s *S) Write(str string) { s.data = str } sVals := map[int]S{1: {\"A\"}} // ä½ åªèƒ½é€šè¿‡å€¼è°ƒç”¨ Read sVals[1].Read() // è¿™ä¸èƒ½ç¼–è¯‘é€šè¿‡ï¼š // sVals[1].Write(\"test\") sPtrs := map[int]*S{1: {\"A\"}} // é€šè¿‡æŒ‡é’ˆæ—¢å¯ä»¥è°ƒç”¨ Readï¼Œä¹Ÿå¯ä»¥è°ƒç”¨ Write æ–¹æ³• sPtrs[1].Read() sPtrs[1].Write(\"test\") ç±»ä¼¼çš„,å³ä½¿æ–¹æ³•æœ‰äº†å€¼æ¥æ”¶å™¨,ä¹ŸåŒæ ·å¯ä»¥ç”¨æŒ‡é’ˆæ¥æ”¶å™¨æ¥æ»¡è¶³æ¥å£. type F interface { f() } type S1 struct{} func (s S1) f() {} type S2 struct{} func (s *S2) f() {} s1Val := S1{} s1Ptr := \u0026S1{} s2Val := S2{} s2Ptr := \u0026S2{} var i F i = s1Val i = s1Ptr i = s2Ptr // ä¸‹é¢ä»£ç æ— æ³•é€šè¿‡ç¼–è¯‘ã€‚å› ä¸º s2Val æ˜¯ä¸€ä¸ªå€¼ï¼Œè€Œ S2 çš„ f æ–¹æ³•ä¸­æ²¡æœ‰ä½¿ç”¨å€¼æ¥æ”¶å™¨ // i = s2Val Effective Go ä¸­æœ‰ä¸€æ®µå…³äº pointers vs. values çš„ç²¾å½©è®²è§£ã€‚ è¡¥å……: ä¸€ä¸ªç±»å‹å¯ä»¥æœ‰å€¼æ¥æ”¶å™¨æ–¹æ³•é›†å’ŒæŒ‡é’ˆæ¥æ”¶å™¨æ–¹æ³•é›† å€¼æ¥æ”¶å™¨æ–¹æ³•é›†æ˜¯æŒ‡é’ˆæ¥æ”¶å™¨æ–¹æ³•é›†çš„å­é›†,åä¹‹ä¸æ˜¯ è§„åˆ™ å€¼å¯¹è±¡åªå¯ä»¥ä½¿ç”¨å€¼æ¥æ”¶å™¨æ–¹æ³•é›† æŒ‡é’ˆå¯¹è±¡å¯ä»¥ä½¿ç”¨ å€¼æ¥æ”¶å™¨æ–¹æ³•é›† + æŒ‡é’ˆæ¥æ”¶å™¨æ–¹æ³•é›† æ¥å£çš„åŒ¹é…(æˆ–è€…å«å®ç°) ç±»å‹å®ç°äº†æ¥å£çš„æ‰€æœ‰æ–¹æ³•,å«åŒ¹é… å…·ä½“çš„è®²,è¦ä¹ˆæ˜¯ç±»å‹çš„å€¼æ–¹æ³•é›†åŒ¹é…æ¥å£,è¦ä¹ˆæ˜¯æŒ‡é’ˆæ–¹æ³•é›†åŒ¹é…æ¥å£ å…·ä½“çš„åŒ¹é…åˆ†ä¸¤ç§: å€¼æ–¹æ³•é›†å’Œæ¥å£åŒ¹é… ç»™æ¥å£å˜é‡èµ‹å€¼çš„ä¸ç®¡æ˜¯å€¼è¿˜æ˜¯æŒ‡é’ˆå¯¹è±¡,éƒ½ok,å› ä¸ºéƒ½åŒ…å«å€¼æ–¹æ³•é›† æŒ‡é’ˆæ–¹æ³•é›†å’Œæ¥å£åŒ¹é… åªèƒ½å°†æŒ‡é’ˆå¯¹è±¡èµ‹å€¼ç»™æ¥å£å˜é‡,å› ä¸ºåªæœ‰æŒ‡é’ˆæ–¹æ³•é›†å’Œæ¥å£åŒ¹é… å¦‚æœå°†å€¼å¯¹è±¡èµ‹å€¼ç»™æ¥å£å˜é‡,ä¼šåœ¨ç¼–è¯‘æœŸæŠ¥é”™(ä¼šè§¦å‘æ¥å£åˆç†æ€§æ£€æŸ¥æœºåˆ¶) ä¸ºå•¥ i = s2Val ä¼šæŠ¥é”™,å› ä¸ºå€¼æ–¹æ³•é›†å’Œæ¥å£ä¸åŒ¹é…. ","date":"2020-11-25","objectID":"/posts/go-standard/:2:3","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"é›¶å€¼ Mutex æ˜¯æœ‰æ•ˆçš„ é›¶å€¼ sync.Mutex å’Œ sync.RWMutex æ˜¯æœ‰æ•ˆçš„ã€‚æ‰€ä»¥æŒ‡å‘ mutex çš„æŒ‡é’ˆåŸºæœ¬æ˜¯ä¸å¿…è¦çš„ã€‚ BadGood mu := new(sync.Mutex) mu.Lock() var mu sync.Mutex mu.Lock() å¦‚æœä½ ä½¿ç”¨ç»“æ„ä½“æŒ‡é’ˆï¼Œmutex å¯ä»¥éæŒ‡é’ˆå½¢å¼ä½œä¸ºç»“æ„ä½“çš„ç»„æˆå­—æ®µï¼Œæˆ–è€…æ›´å¥½çš„æ–¹å¼æ˜¯ç›´æ¥åµŒå…¥åˆ°ç»“æ„ä½“ä¸­ã€‚ å¦‚æœæ˜¯ç§æœ‰ç»“æ„ä½“ç±»å‹æˆ–æ˜¯è¦å®ç° Mutex æ¥å£çš„ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨åµŒå…¥ mutex çš„æ–¹æ³•ï¼š type smap struct { sync.Mutex // only for unexported typesï¼ˆä»…é€‚ç”¨äºéå¯¼å‡ºç±»å‹ï¼‰ data map[string]string } func newSMap() *smap { return \u0026smap{ data: make(map[string]string), } } func (m *smap) Get(k string) string { m.Lock() defer m.Unlock() return m.data[k] } type SMap struct { mu sync.Mutex // å¯¹äºå¯¼å‡ºç±»å‹ï¼Œè¯·ä½¿ç”¨ç§æœ‰é” data map[string]string } func NewSMap() *SMap { return \u0026SMap{ data: make(map[string]string), } } func (m *SMap) Get(k string) string { m.mu.Lock() defer m.mu.Unlock() return m.data[k] } ä¸ºç§æœ‰ç±»å‹æˆ–éœ€è¦å®ç°äº’æ–¥æ¥å£çš„ç±»å‹åµŒå…¥ã€‚ å¯¹äºå¯¼å‡ºçš„ç±»å‹ï¼Œè¯·ä½¿ç”¨ä¸“ç”¨å­—æ®µã€‚ ","date":"2020-11-25","objectID":"/posts/go-standard/:2:4","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"åœ¨è¾¹ç•Œå¤„æ‹·è´ Slices å’Œ Maps slices å’Œ maps åŒ…å«äº†æŒ‡å‘åº•å±‚æ•°æ®çš„æŒ‡é’ˆï¼Œå› æ­¤åœ¨éœ€è¦å¤åˆ¶å®ƒä»¬æ—¶è¦ç‰¹åˆ«æ³¨æ„ã€‚ æ¥æ”¶ Slices å’Œ Maps è¯·è®°ä½ï¼Œå½“ map æˆ– slice ä½œä¸ºå‡½æ•°å‚æ•°ä¼ å…¥æ—¶ï¼Œå¦‚æœæ‚¨å­˜å‚¨äº†å¯¹å®ƒä»¬çš„å¼•ç”¨ï¼Œåˆ™ç”¨æˆ·å¯ä»¥å¯¹å…¶è¿›è¡Œä¿®æ”¹ã€‚ Bad Good func (d *Driver) SetTrips(trips []Trip) { d.trips = trips } trips := ... d1.SetTrips(trips) // ä½ æ˜¯è¦ä¿®æ”¹ d1.trips å—ï¼Ÿ trips[0] = ... func (d *Driver) SetTrips(trips []Trip) { d.trips = make([]Trip, len(trips)) copy(d.trips, trips) } trips := ... d1.SetTrips(trips) // è¿™é‡Œæˆ‘ä»¬ä¿®æ”¹ trips[0]ï¼Œä½†ä¸ä¼šå½±å“åˆ° d1.trips trips[0] = ... è¿”å› slices æˆ– maps åŒæ ·ï¼Œè¯·æ³¨æ„ç”¨æˆ·å¯¹æš´éœ²å†…éƒ¨çŠ¶æ€çš„ map æˆ– slice çš„ä¿®æ”¹ã€‚ BadGood type Stats struct { mu sync.Mutex counters map[string]int } // Snapshot è¿”å›å½“å‰çŠ¶æ€ã€‚ func (s *Stats) Snapshot() map[string]int { s.mu.Lock() defer s.mu.Unlock() return s.counters } // snapshot ä¸å†å—äº’æ–¥é”ä¿æŠ¤ // å› æ­¤å¯¹ snapshot çš„ä»»ä½•è®¿é—®éƒ½å°†å—åˆ°æ•°æ®ç«äº‰çš„å½±å“ // å½±å“ stats.counters snapshot := stats.Snapshot() type Stats struct { mu sync.Mutex counters map[string]int } func (s *Stats) Snapshot() map[string]int { s.mu.Lock() defer s.mu.Unlock() result := make(map[string]int, len(s.counters)) for k, v := range s.counters { result[k] = v } return result } // snapshot ç°åœ¨æ˜¯ä¸€ä¸ªæ‹·è´ snapshot := stats.Snapshot() ","date":"2020-11-25","objectID":"/posts/go-standard/:2:5","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"ä½¿ç”¨ defer é‡Šæ”¾èµ„æº ä½¿ç”¨ defer é‡Šæ”¾èµ„æºï¼Œè¯¸å¦‚æ–‡ä»¶å’Œé”ã€‚ BadGood p.Lock() if p.count \u003c 10 { p.Unlock() return p.count } p.count++ newCount := p.count p.Unlock() return newCount // å½“æœ‰å¤šä¸ª return åˆ†æ”¯æ—¶ï¼Œå¾ˆå®¹æ˜“é—å¿˜ unlock p.Lock() defer p.Unlock() if p.count \u003c 10 { return p.count } p.count++ return p.count // æ›´å¯è¯» Defer çš„å¼€é”€éå¸¸å°ï¼Œåªæœ‰åœ¨æ‚¨å¯ä»¥è¯æ˜å‡½æ•°æ‰§è¡Œæ—¶é—´å¤„äºçº³ç§’çº§çš„ç¨‹åº¦æ—¶ï¼Œæ‰åº”é¿å…è¿™æ ·åšã€‚ä½¿ç”¨ defer æå‡å¯è¯»æ€§æ˜¯å€¼å¾—çš„ï¼Œå› ä¸ºä½¿ç”¨å®ƒä»¬çš„æˆæœ¬å¾®ä¸è¶³é“ã€‚å°¤å…¶é€‚ç”¨äºé‚£äº›ä¸ä»…ä»…æ˜¯ç®€å•å†…å­˜è®¿é—®çš„è¾ƒå¤§çš„æ–¹æ³•ï¼Œåœ¨è¿™äº›æ–¹æ³•ä¸­å…¶ä»–è®¡ç®—çš„èµ„æºæ¶ˆè€—è¿œè¶…è¿‡ deferã€‚ ","date":"2020-11-25","objectID":"/posts/go-standard/:2:6","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"Channel çš„ size è¦ä¹ˆæ˜¯ 1ï¼Œè¦ä¹ˆæ˜¯æ— ç¼“å†²çš„ channel é€šå¸¸ size åº”ä¸º 1 æˆ–æ˜¯æ— ç¼“å†²çš„ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œchannel æ˜¯æ— ç¼“å†²çš„ï¼Œå…¶ size ä¸ºé›¶ã€‚ä»»ä½•å…¶ä»–å°ºå¯¸éƒ½å¿…é¡»ç»è¿‡ä¸¥æ ¼çš„å®¡æŸ¥ã€‚æˆ‘ä»¬éœ€è¦è€ƒè™‘å¦‚ä½•ç¡®å®šå¤§å°ï¼Œè€ƒè™‘æ˜¯ä»€ä¹ˆé˜»æ­¢äº† channel åœ¨é«˜è´Ÿè½½ä¸‹å’Œé˜»å¡å†™æ—¶çš„å†™å…¥ï¼Œä»¥åŠå½“è¿™ç§æƒ…å†µå‘ç”Ÿæ—¶ç³»ç»Ÿé€»è¾‘æœ‰å“ªäº›å˜åŒ–ã€‚(ç¿»è¯‘è§£é‡Šï¼šæŒ‰ç…§åŸæ–‡æ„æ€æ˜¯éœ€è¦ç•Œå®šé€šé“è¾¹ç•Œï¼Œç«æ€æ¡ä»¶ï¼Œä»¥åŠé€»è¾‘ä¸Šä¸‹æ–‡æ¢³ç†) BadGood // åº”è¯¥è¶³ä»¥æ»¡è¶³ä»»ä½•æƒ…å†µï¼ c := make(chan int, 64) // å¤§å°ï¼š1 c := make(chan int, 1) // æˆ–è€… // æ— ç¼“å†² channelï¼Œå¤§å°ä¸º 0 c := make(chan int) ","date":"2020-11-25","objectID":"/posts/go-standard/:2:7","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"æšä¸¾ä» 1 å¼€å§‹ åœ¨ Go ä¸­å¼•å…¥æšä¸¾çš„æ ‡å‡†æ–¹æ³•æ˜¯å£°æ˜ä¸€ä¸ªè‡ªå®šä¹‰ç±»å‹å’Œä¸€ä¸ªä½¿ç”¨äº† iota çš„ const ç»„ã€‚ç”±äºå˜é‡çš„é»˜è®¤å€¼ä¸º 0ï¼Œå› æ­¤é€šå¸¸åº”ä»¥éé›¶å€¼å¼€å¤´æšä¸¾ã€‚ BadGood type Operation int const ( Add Operation = iota Subtract Multiply ) // Add=0, Subtract=1, Multiply=2 type Operation int const ( Add Operation = iota + 1 Subtract Multiply ) // Add=1, Subtract=2, Multiply=3 åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½¿ç”¨é›¶å€¼æ˜¯æœ‰æ„ä¹‰çš„ï¼ˆæšä¸¾ä»é›¶å¼€å§‹ï¼‰ï¼Œä¾‹å¦‚ï¼Œå½“é›¶å€¼æ˜¯ç†æƒ³çš„é»˜è®¤è¡Œä¸ºæ—¶ã€‚ type LogOutput int const ( LogToStdout LogOutput = iota LogToFile LogToRemote ) // LogToStdout=0, LogToFile=1, LogToRemote=2 ","date":"2020-11-25","objectID":"/posts/go-standard/:2:8","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"ä½¿ç”¨ time å¤„ç†æ—¶é—´ æ—¶é—´å¤„ç†å¾ˆå¤æ‚ã€‚å…³äºæ—¶é—´çš„é”™è¯¯å‡è®¾é€šå¸¸åŒ…æ‹¬ä»¥ä¸‹å‡ ç‚¹ã€‚ ä¸€å¤©æœ‰ 24 å°æ—¶ ä¸€å°æ—¶æœ‰ 60 åˆ†é’Ÿ ä¸€å‘¨æœ‰ä¸ƒå¤© ä¸€å¹´ 365 å¤© è¿˜æœ‰æ›´å¤š ä¾‹å¦‚ï¼Œ1 è¡¨ç¤ºåœ¨ä¸€ä¸ªæ—¶é—´ç‚¹ä¸ŠåŠ ä¸Š 24 å°æ—¶å¹¶ä¸æ€»æ˜¯äº§ç”Ÿä¸€ä¸ªæ–°çš„æ—¥å†æ—¥ã€‚ å› æ­¤ï¼Œåœ¨å¤„ç†æ—¶é—´æ—¶å§‹ç»ˆä½¿ç”¨ \"time\" åŒ…ï¼Œå› ä¸ºå®ƒæœ‰åŠ©äºä»¥æ›´å®‰å…¨ã€æ›´å‡†ç¡®çš„æ–¹å¼å¤„ç†è¿™äº›ä¸æ­£ç¡®çš„å‡è®¾ã€‚ ä½¿ç”¨ time.Time è¡¨è¾¾ç¬æ—¶æ—¶é—´ åœ¨å¤„ç†æ—¶é—´çš„ç¬é—´æ—¶ä½¿ç”¨ time.timeï¼Œåœ¨æ¯”è¾ƒã€æ·»åŠ æˆ–å‡å»æ—¶é—´æ—¶ä½¿ç”¨ time.Time ä¸­çš„æ–¹æ³•ã€‚ BadGood func isActive(now, start, stop int) bool { return start \u003c= now \u0026\u0026 now \u003c stop } func isActive(now, start, stop time.Time) bool { return (start.Before(now) || start.Equal(now)) \u0026\u0026 now.Before(stop) } ä½¿ç”¨ time.Duration è¡¨è¾¾æ—¶é—´æ®µ åœ¨å¤„ç†æ—¶é—´æ®µæ—¶ä½¿ç”¨ time.Duration . BadGood func poll(delay int) { for { // ... time.Sleep(time.Duration(delay) * time.Millisecond) } } poll(10) // æ˜¯å‡ ç§’é’Ÿè¿˜æ˜¯å‡ æ¯«ç§’? func poll(delay time.Duration) { for { // ... time.Sleep(delay) } } poll(10*time.Second) å›åˆ°ç¬¬ä¸€ä¸ªä¾‹å­ï¼Œåœ¨ä¸€ä¸ªæ—¶é—´ç¬é—´åŠ ä¸Š 24 å°æ—¶ï¼Œæˆ‘ä»¬ç”¨äºæ·»åŠ æ—¶é—´çš„æ–¹æ³•å–å†³äºæ„å›¾ã€‚å¦‚æœæˆ‘ä»¬æƒ³è¦ä¸‹ä¸€ä¸ªæ—¥å†æ—¥(å½“å‰å¤©çš„ä¸‹ä¸€å¤©)çš„åŒä¸€ä¸ªæ—¶é—´ç‚¹ï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨ Time.AddDateã€‚ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬æƒ³ä¿è¯æŸä¸€æ—¶åˆ»æ¯”å‰ä¸€æ—¶åˆ»æ™š 24 å°æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨ Time.Addã€‚ newDay := t.AddDate(0 /* years */, 0, /* months */, 1 /* days */) maybeNewDay := t.Add(24 * time.Hour) å¯¹å¤–éƒ¨ç³»ç»Ÿä½¿ç”¨ time.Time å’Œ time.Duration å°½å¯èƒ½åœ¨ä¸å¤–éƒ¨ç³»ç»Ÿçš„äº¤äº’ä¸­ä½¿ç”¨ time.Duration å’Œ time.Time ä¾‹å¦‚ : Command-line æ ‡å¿—: flag é€šè¿‡ time.ParseDuration æ”¯æŒ time.Duration JSON: encoding/json é€šè¿‡å…¶ UnmarshalJSON method æ–¹æ³•æ”¯æŒå°† time.Time ç¼–ç ä¸º RFC 3339 å­—ç¬¦ä¸² SQL: database/sql æ”¯æŒå°† DATETIME æˆ– TIMESTAMP åˆ—è½¬æ¢ä¸º time.Timeï¼Œå¦‚æœåº•å±‚é©±åŠ¨ç¨‹åºæ”¯æŒåˆ™è¿”å› YAML: gopkg.in/yaml.v2 æ”¯æŒå°† time.Time ä½œä¸º RFC 3339 å­—ç¬¦ä¸²ï¼Œå¹¶é€šè¿‡ time.ParseDuration æ”¯æŒ time.Durationã€‚ å½“ä¸èƒ½åœ¨è¿™äº›äº¤äº’ä¸­ä½¿ç”¨ time.Duration æ—¶ï¼Œè¯·ä½¿ç”¨ int æˆ– float64ï¼Œå¹¶åœ¨å­—æ®µåç§°ä¸­åŒ…å«å•ä½ã€‚ ä¾‹å¦‚ï¼Œç”±äº encoding/json ä¸æ”¯æŒ time.Durationï¼Œå› æ­¤è¯¥å•ä½åŒ…å«åœ¨å­—æ®µçš„åç§°ä¸­ã€‚ BadGood // {\"interval\": 2} type Config struct { Interval int `json:\"interval\"` } // {\"intervalMillis\": 2000} type Config struct { IntervalMillis int `json:\"intervalMillis\"` } å½“åœ¨è¿™äº›äº¤äº’ä¸­ä¸èƒ½ä½¿ç”¨ time.Time æ—¶ï¼Œé™¤éè¾¾æˆä¸€è‡´ï¼Œå¦åˆ™ä½¿ç”¨ string å’Œ RFC 3339 ä¸­å®šä¹‰çš„æ ¼å¼æ—¶é—´æˆ³ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒTime.UnmarshalText ä½¿ç”¨æ­¤æ ¼å¼ï¼Œå¹¶å¯é€šè¿‡ time.RFC3339 åœ¨ Time.Format å’Œ time.Parse ä¸­ä½¿ç”¨ã€‚ å°½ç®¡è¿™åœ¨å®è·µä¸­å¹¶ä¸æˆé—®é¢˜ï¼Œä½†è¯·è®°ä½ï¼Œ\"time\" åŒ…ä¸æ”¯æŒè§£æé—°ç§’æ—¶é—´æˆ³ï¼ˆ8728ï¼‰ï¼Œä¹Ÿä¸åœ¨è®¡ç®—ä¸­è€ƒè™‘é—°ç§’ï¼ˆ15190ï¼‰ã€‚å¦‚æœæ‚¨æ¯”è¾ƒä¸¤ä¸ªæ—¶é—´ç¬é—´ï¼Œåˆ™å·®å¼‚å°†ä¸åŒ…æ‹¬è¿™ä¸¤ä¸ªç¬é—´ä¹‹é—´å¯èƒ½å‘ç”Ÿçš„é—°ç§’ã€‚ ","date":"2020-11-25","objectID":"/posts/go-standard/:2:9","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"é”™è¯¯ç±»å‹ Go ä¸­æœ‰å¤šç§å£°æ˜é”™è¯¯ï¼ˆError) çš„é€‰é¡¹ï¼š errors.New å¯¹äºç®€å•é™æ€å­—ç¬¦ä¸²çš„é”™è¯¯ fmt.Errorf ç”¨äºæ ¼å¼åŒ–çš„é”™è¯¯å­—ç¬¦ä¸² å®ç° Error() æ–¹æ³•çš„è‡ªå®šä¹‰ç±»å‹ ç”¨ \"pkg/errors\".Wrap çš„ Wrapped errors è¿”å›é”™è¯¯æ—¶ï¼Œè¯·è€ƒè™‘ä»¥ä¸‹å› ç´ ä»¥ç¡®å®šæœ€ä½³é€‰æ‹©ï¼š è¿™æ˜¯ä¸€ä¸ªä¸éœ€è¦é¢å¤–ä¿¡æ¯çš„ç®€å•é”™è¯¯å—ï¼Ÿå¦‚æœæ˜¯è¿™æ ·ï¼Œerrors.New è¶³å¤Ÿäº†ã€‚ å®¢æˆ·éœ€è¦æ£€æµ‹å¹¶å¤„ç†æ­¤é”™è¯¯å—ï¼Ÿå¦‚æœæ˜¯è¿™æ ·ï¼Œåˆ™åº”ä½¿ç”¨è‡ªå®šä¹‰ç±»å‹å¹¶å®ç°è¯¥ Error() æ–¹æ³•ã€‚ æ‚¨æ˜¯å¦æ­£åœ¨ä¼ æ’­ä¸‹æ¸¸å‡½æ•°è¿”å›çš„é”™è¯¯ï¼Ÿå¦‚æœæ˜¯è¿™æ ·ï¼Œè¯·æŸ¥çœ‹æœ¬æ–‡åé¢æœ‰å…³é”™è¯¯åŒ…è£… section on error wrapping éƒ¨åˆ†çš„å†…å®¹ã€‚ å¦åˆ™ fmt.Errorf å°±å¯ä»¥äº†ã€‚ å¦‚æœå®¢æˆ·ç«¯éœ€è¦æ£€æµ‹é”™è¯¯ï¼Œå¹¶ä¸”æ‚¨å·²ä½¿ç”¨åˆ›å»ºäº†ä¸€ä¸ªç®€å•çš„é”™è¯¯ errors.Newï¼Œè¯·ä½¿ç”¨ä¸€ä¸ªé”™è¯¯å˜é‡ã€‚ BadGood // package foo func Open() error { return errors.New(\"could not open\") } // package bar func use() { if err := foo.Open(); err != nil { if err.Error() == \"could not open\" { // handle } else { panic(\"unknown error\") } } } // package foo var ErrCouldNotOpen = errors.New(\"could not open\") func Open() error { return ErrCouldNotOpen } // package bar if err := foo.Open(); err != nil { if err == foo.ErrCouldNotOpen { // handle } else { panic(\"unknown error\") } } å¦‚æœæ‚¨æœ‰å¯èƒ½éœ€è¦å®¢æˆ·ç«¯æ£€æµ‹çš„é”™è¯¯ï¼Œå¹¶ä¸”æƒ³å‘å…¶ä¸­æ·»åŠ æ›´å¤šä¿¡æ¯ï¼ˆä¾‹å¦‚ï¼Œå®ƒä¸æ˜¯é™æ€å­—ç¬¦ä¸²ï¼‰ï¼Œåˆ™åº”ä½¿ç”¨è‡ªå®šä¹‰ç±»å‹ã€‚ BadGood func open(file string) error { return fmt.Errorf(\"file %q not found\", file) } func use() { if err := open(\"testfile.txt\"); err != nil { if strings.Contains(err.Error(), \"not found\") { // handle } else { panic(\"unknown error\") } } } type errNotFound struct { file string } func (e errNotFound) Error() string { return fmt.Sprintf(\"file %q not found\", e.file) } func open(file string) error { return errNotFound{file: file} } func use() { if err := open(\"testfile.txt\"); err != nil { if _, ok := err.(errNotFound); ok { // handle } else { panic(\"unknown error\") } } } ç›´æ¥å¯¼å‡ºè‡ªå®šä¹‰é”™è¯¯ç±»å‹æ—¶è¦å°å¿ƒï¼Œå› ä¸ºå®ƒä»¬å·²æˆä¸ºç¨‹åºåŒ…å…¬å…± API çš„ä¸€éƒ¨åˆ†ã€‚æœ€å¥½å…¬å¼€åŒ¹é…å™¨åŠŸèƒ½ä»¥æ£€æŸ¥é”™è¯¯ã€‚ // package foo type errNotFound struct { file string } func (e errNotFound) Error() string { return fmt.Sprintf(\"file %q not found\", e.file) } func IsNotFoundError(err error) bool { _, ok := err.(errNotFound) return ok } func Open(file string) error { return errNotFound{file: file} } // package bar if err := foo.Open(\"foo\"); err != nil { if foo.IsNotFoundError(err) { // handle } else { panic(\"unknown error\") } } ","date":"2020-11-25","objectID":"/posts/go-standard/:2:10","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"é”™è¯¯åŒ…è£… (Error Wrapping) ä¸€ä¸ªï¼ˆå‡½æ•°/æ–¹æ³•ï¼‰è°ƒç”¨å¤±è´¥æ—¶ï¼Œæœ‰ä¸‰ç§ä¸»è¦çš„é”™è¯¯ä¼ æ’­æ–¹å¼ï¼š å¦‚æœæ²¡æœ‰è¦æ·»åŠ çš„å…¶ä»–ä¸Šä¸‹æ–‡ï¼Œå¹¶ä¸”æ‚¨æƒ³è¦ç»´æŠ¤åŸå§‹é”™è¯¯ç±»å‹ï¼Œåˆ™è¿”å›åŸå§‹é”™è¯¯ã€‚ æ·»åŠ ä¸Šä¸‹æ–‡ï¼Œä½¿ç”¨ \"pkg/errors\".Wrap ä»¥ä¾¿é”™è¯¯æ¶ˆæ¯æä¾›æ›´å¤šä¸Šä¸‹æ–‡ ,\"pkg/errors\".Cause å¯ç”¨äºæå–åŸå§‹é”™è¯¯ã€‚ å¦‚æœè°ƒç”¨è€…ä¸éœ€è¦æ£€æµ‹æˆ–å¤„ç†çš„ç‰¹å®šé”™è¯¯æƒ…å†µï¼Œä½¿ç”¨ fmt.Errorfã€‚ å»ºè®®åœ¨å¯èƒ½çš„åœ°æ–¹æ·»åŠ ä¸Šä¸‹æ–‡ï¼Œä»¥ä½¿æ‚¨è·å¾—è¯¸å¦‚â€œè°ƒç”¨æœåŠ¡ fooï¼šè¿æ¥è¢«æ‹’ç»â€ä¹‹ç±»çš„æ›´æœ‰ç”¨çš„é”™è¯¯ï¼Œè€Œä¸æ˜¯è¯¸å¦‚â€œè¿æ¥è¢«æ‹’ç»â€ä¹‹ç±»çš„æ¨¡ç³Šé”™è¯¯ã€‚ åœ¨å°†ä¸Šä¸‹æ–‡æ·»åŠ åˆ°è¿”å›çš„é”™è¯¯æ—¶ï¼Œè¯·é¿å…ä½¿ç”¨â€œfailed toâ€ä¹‹ç±»çš„çŸ­è¯­ä»¥ä¿æŒä¸Šä¸‹æ–‡ç®€æ´ï¼Œè¿™äº›çŸ­è¯­ä¼šé™ˆè¿°æ˜æ˜¾çš„å†…å®¹ï¼Œå¹¶éšç€é”™è¯¯åœ¨å †æ ˆä¸­çš„æ¸—é€è€Œé€æ¸å †ç§¯ï¼š BadGood s, err := store.New() if err != nil { return fmt.Errorf( \"failed to create new store: %s\", err) } s, err := store.New() if err != nil { return fmt.Errorf( \"new store: %s\", err) } failed to x: failed to y: failed to create new store: the error x: y: new store: the error ä½†æ˜¯ï¼Œä¸€æ—¦å°†é”™è¯¯å‘é€åˆ°å¦ä¸€ä¸ªç³»ç»Ÿï¼Œå°±åº”è¯¥æ˜ç¡®æ¶ˆæ¯æ˜¯é”™è¯¯æ¶ˆæ¯ï¼ˆä¾‹å¦‚ä½¿ç”¨erræ ‡è®°ï¼Œæˆ–åœ¨æ—¥å¿—ä¸­ä»¥â€Failedâ€ä¸ºå‰ç¼€ï¼‰ã€‚ å¦è¯·å‚è§ Donâ€™t just check errors, handle them gracefully. ä¸è¦åªæ˜¯æ£€æŸ¥é”™è¯¯ï¼Œè¦ä¼˜é›…åœ°å¤„ç†é”™è¯¯ ","date":"2020-11-25","objectID":"/posts/go-standard/:2:11","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"å¤„ç†ç±»å‹æ–­è¨€å¤±è´¥ type assertion çš„å•ä¸ªè¿”å›å€¼å½¢å¼é’ˆå¯¹ä¸æ­£ç¡®çš„ç±»å‹å°†äº§ç”Ÿ panicã€‚å› æ­¤ï¼Œè¯·å§‹ç»ˆä½¿ç”¨â€œcomma okâ€çš„æƒ¯ç”¨æ³•ã€‚ BadGood t := i.(string) t, ok := i.(string) if !ok { // ä¼˜é›…åœ°å¤„ç†é”™è¯¯ } ","date":"2020-11-25","objectID":"/posts/go-standard/:2:12","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"ä¸è¦ panic åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è¿è¡Œçš„ä»£ç å¿…é¡»é¿å…å‡ºç° panicã€‚panic æ˜¯ cascading failures çº§è”å¤±è´¥çš„ä¸»è¦æ ¹æº ã€‚å¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œè¯¥å‡½æ•°å¿…é¡»è¿”å›é”™è¯¯ï¼Œå¹¶å…è®¸è°ƒç”¨æ–¹å†³å®šå¦‚ä½•å¤„ç†å®ƒã€‚ BadGood func run(args []string) { if len(args) == 0 { panic(\"an argument is required\") } // ... } func main() { run(os.Args[1:]) } func run(args []string) error { if len(args) == 0 { return errors.New(\"an argument is required\") } // ... return nil } func main() { if err := run(os.Args[1:]); err != nil { fmt.Fprintln(os.Stderr, err) os.Exit(1) } } panic/recover ä¸æ˜¯é”™è¯¯å¤„ç†ç­–ç•¥ã€‚ä»…å½“å‘ç”Ÿä¸å¯æ¢å¤çš„äº‹æƒ…ï¼ˆä¾‹å¦‚ï¼šnil å¼•ç”¨ï¼‰æ—¶ï¼Œç¨‹åºæ‰å¿…é¡» panicã€‚ç¨‹åºåˆå§‹åŒ–æ˜¯ä¸€ä¸ªä¾‹å¤–ï¼šç¨‹åºå¯åŠ¨æ—¶åº”ä½¿ç¨‹åºä¸­æ­¢çš„ä¸è‰¯æƒ…å†µå¯èƒ½ä¼šå¼•èµ· panicã€‚ var _statusTemplate = template.Must(template.New(\"name\").Parse(\"_statusHTML\")) å³ä½¿åœ¨æµ‹è¯•ä»£ç ä¸­ï¼Œä¹Ÿä¼˜å…ˆä½¿ç”¨t.Fatalæˆ–è€…t.FailNowè€Œä¸æ˜¯ panic æ¥ç¡®ä¿å¤±è´¥è¢«æ ‡è®°ã€‚ BadGood // func TestFoo(t *testing.T) f, err := ioutil.TempFile(\"\", \"test\") if err != nil { panic(\"failed to set up test\") } // func TestFoo(t *testing.T) f, err := ioutil.TempFile(\"\", \"test\") if err != nil { t.Fatal(\"failed to set up test\") } ","date":"2020-11-25","objectID":"/posts/go-standard/:2:13","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"ä½¿ç”¨ go.uber.org/atomic ä½¿ç”¨ sync/atomic åŒ…çš„åŸå­æ“ä½œå¯¹åŸå§‹ç±»å‹ (int32, int64ç­‰ï¼‰è¿›è¡Œæ“ä½œï¼Œå› ä¸ºå¾ˆå®¹æ˜“å¿˜è®°ä½¿ç”¨åŸå­æ“ä½œæ¥è¯»å–æˆ–ä¿®æ”¹å˜é‡ã€‚ go.uber.org/atomic é€šè¿‡éšè—åŸºç¡€ç±»å‹ä¸ºè¿™äº›æ“ä½œå¢åŠ äº†ç±»å‹å®‰å…¨æ€§ã€‚æ­¤å¤–ï¼Œå®ƒåŒ…æ‹¬ä¸€ä¸ªæ–¹ä¾¿çš„atomic.Boolç±»å‹ã€‚ BadGood type foo struct { running int32 // atomic } func (f* foo) start() { if atomic.SwapInt32(\u0026f.running, 1) == 1 { // already runningâ€¦ return } // start the Foo } func (f *foo) isRunning() bool { return f.running == 1 // race! } type foo struct { running atomic.Bool } func (f *foo) start() { if f.running.Swap(true) { // already runningâ€¦ return } // start the Foo } func (f *foo) isRunning() bool { return f.running.Load() } ","date":"2020-11-25","objectID":"/posts/go-standard/:2:14","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"é¿å…å¯å˜å…¨å±€å˜é‡ ä½¿ç”¨é€‰æ‹©ä¾èµ–æ³¨å…¥æ–¹å¼é¿å…æ”¹å˜å…¨å±€å˜é‡ã€‚ æ—¢é€‚ç”¨äºå‡½æ•°æŒ‡é’ˆåˆé€‚ç”¨äºå…¶ä»–å€¼ç±»å‹ BadGood // sign.go var _timeNow = time.Now func sign(msg string) string { now := _timeNow() return signWithTime(msg, now) } // sign.go type signer struct { now func() time.Time } func newSigner() *signer { return \u0026signer{ now: time.Now, } } func (s *signer) Sign(msg string) string { now := s.now() return signWithTime(msg, now) } // sign_test.go func TestSign(t *testing.T) { oldTimeNow := _timeNow _timeNow = func() time.Time { return someFixedTime } defer func() { _timeNow = oldTimeNow }() assert.Equal(t, want, sign(give)) } // sign_test.go func TestSigner(t *testing.T) { s := newSigner() s.now = func() time.Time { return someFixedTime } assert.Equal(t, want, s.Sign(give)) } ","date":"2020-11-25","objectID":"/posts/go-standard/:2:15","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"é¿å…åœ¨å…¬å…±ç»“æ„ä¸­åµŒå…¥ç±»å‹ è¿™äº›åµŒå…¥çš„ç±»å‹æ³„æ¼å®ç°ç»†èŠ‚ã€ç¦æ­¢ç±»å‹æ¼”åŒ–å’Œæ¨¡ç³Šçš„æ–‡æ¡£ã€‚ å‡è®¾æ‚¨ä½¿ç”¨å…±äº«çš„ AbstractList å®ç°äº†å¤šç§åˆ—è¡¨ç±»å‹ï¼Œè¯·é¿å…åœ¨å…·ä½“çš„åˆ—è¡¨å®ç°ä¸­åµŒå…¥ AbstractListã€‚ ç›¸åï¼Œåªéœ€æ‰‹åŠ¨å°†æ–¹æ³•å†™å…¥å…·ä½“çš„åˆ—è¡¨ï¼Œè¯¥åˆ—è¡¨å°†å§”æ‰˜ç»™æŠ½è±¡åˆ—è¡¨ã€‚ type AbstractList struct {} // æ·»åŠ å°†å®ä½“æ·»åŠ åˆ°åˆ—è¡¨ä¸­ã€‚ func (l *AbstractList) Add(e Entity) { // ... } // ç§»é™¤ä»åˆ—è¡¨ä¸­ç§»é™¤å®ä½“ã€‚ func (l *AbstractList) Remove(e Entity) { // ... } BadGood // ConcreteList æ˜¯ä¸€ä¸ªå®ä½“åˆ—è¡¨ã€‚ type ConcreteList struct { *AbstractList } // ConcreteList æ˜¯ä¸€ä¸ªå®ä½“åˆ—è¡¨ã€‚ type ConcreteList struct { list *AbstractList } // æ·»åŠ å°†å®ä½“æ·»åŠ åˆ°åˆ—è¡¨ä¸­ã€‚ func (l *ConcreteList) Add(e Entity) { return l.list.Add(e) } // ç§»é™¤ä»åˆ—è¡¨ä¸­ç§»é™¤å®ä½“ã€‚ func (l *ConcreteList) Remove(e Entity) { return l.list.Remove(e) } Go å…è®¸ ç±»å‹åµŒå…¥ ä½œä¸ºç»§æ‰¿å’Œç»„åˆä¹‹é—´çš„æŠ˜è¡·ã€‚ å¤–éƒ¨ç±»å‹è·å–åµŒå…¥ç±»å‹çš„æ–¹æ³•çš„éšå¼å‰¯æœ¬ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™äº›æ–¹æ³•å§”æ‰˜ç»™åµŒå…¥å®ä¾‹çš„åŒä¸€æ–¹æ³•ã€‚ ç»“æ„è¿˜è·å¾—ä¸ç±»å‹åŒåçš„å­—æ®µã€‚ æ‰€ä»¥ï¼Œå¦‚æœåµŒå…¥çš„ç±»å‹æ˜¯ publicï¼Œé‚£ä¹ˆå­—æ®µæ˜¯ publicã€‚ä¸ºäº†ä¿æŒå‘åå…¼å®¹æ€§ï¼Œå¤–éƒ¨ç±»å‹çš„æ¯ä¸ªæœªæ¥ç‰ˆæœ¬éƒ½å¿…é¡»ä¿ç•™åµŒå…¥ç±»å‹ã€‚ å¾ˆå°‘éœ€è¦åµŒå…¥ç±»å‹ã€‚ è¿™æ˜¯ä¸€ç§æ–¹ä¾¿ï¼Œå¯ä»¥å¸®åŠ©æ‚¨é¿å…ç¼–å†™å†—é•¿çš„å§”æ‰˜æ–¹æ³•ã€‚ å³ä½¿åµŒå…¥å…¼å®¹çš„æŠ½è±¡åˆ—è¡¨ interfaceï¼Œè€Œä¸æ˜¯ç»“æ„ä½“ï¼Œè¿™å°†ä¸ºå¼€å‘äººå‘˜æä¾›æ›´å¤§çš„çµæ´»æ€§æ¥æ”¹å˜æœªæ¥ï¼Œä½†ä»ç„¶æ³„éœ²äº†å…·ä½“åˆ—è¡¨ä½¿ç”¨æŠ½è±¡å®ç°çš„ç»†èŠ‚ã€‚ BadGood // AbstractList æ˜¯å„ç§å®ä½“åˆ—è¡¨çš„é€šç”¨å®ç°ã€‚ type AbstractList interface { Add(Entity) Remove(Entity) } // ConcreteList æ˜¯ä¸€ä¸ªå®ä½“åˆ—è¡¨ã€‚ type ConcreteList struct { AbstractList } // ConcreteList æ˜¯ä¸€ä¸ªå®ä½“åˆ—è¡¨ã€‚ type ConcreteList struct { list *AbstractList } // æ·»åŠ å°†å®ä½“æ·»åŠ åˆ°åˆ—è¡¨ä¸­ã€‚ func (l *ConcreteList) Add(e Entity) { return l.list.Add(e) } // ç§»é™¤ä»åˆ—è¡¨ä¸­ç§»é™¤å®ä½“ã€‚ func (l *ConcreteList) Remove(e Entity) { return l.list.Remove(e) } æ— è®ºæ˜¯ä½¿ç”¨åµŒå…¥å¼ç»“æ„è¿˜æ˜¯ä½¿ç”¨åµŒå…¥å¼æ¥å£ï¼ŒåµŒå…¥å¼ç±»å‹éƒ½ä¼šé™åˆ¶ç±»å‹çš„æ¼”åŒ–. å‘åµŒå…¥å¼æ¥å£æ·»åŠ æ–¹æ³•æ˜¯ä¸€ä¸ªç ´åæ€§çš„æ”¹å˜ã€‚ åˆ é™¤åµŒå…¥ç±»å‹æ˜¯ä¸€ä¸ªç ´åæ€§çš„æ”¹å˜ã€‚ å³ä½¿ä½¿ç”¨æ»¡è¶³ç›¸åŒæ¥å£çš„æ›¿ä»£æ–¹æ³•æ›¿æ¢åµŒå…¥ç±»å‹ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªç ´åæ€§çš„æ”¹å˜ã€‚ å°½ç®¡ç¼–å†™è¿™äº›å§”æ‰˜æ–¹æ³•æ˜¯ä¹å‘³çš„ï¼Œä½†æ˜¯é¢å¤–çš„å·¥ä½œéšè—äº†å®ç°ç»†èŠ‚ï¼Œç•™ä¸‹äº†æ›´å¤šçš„æ›´æ”¹æœºä¼šï¼Œè¿˜æ¶ˆé™¤äº†åœ¨æ–‡æ¡£ä¸­å‘ç°å®Œæ•´åˆ—è¡¨æ¥å£çš„é—´æ¥æ€§æ“ä½œã€‚ ","date":"2020-11-25","objectID":"/posts/go-standard/:2:16","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"é¿å…ä½¿ç”¨å†…ç½®åç§° Goè¯­è¨€è§„èŒƒlanguage specification æ¦‚è¿°äº†å‡ ä¸ªå†…ç½®çš„ï¼Œ ä¸åº”åœ¨Goé¡¹ç›®ä¸­ä½¿ç”¨çš„åç§°æ ‡è¯†predeclared identifiersã€‚ æ ¹æ®ä¸Šä¸‹æ–‡çš„ä¸åŒï¼Œå°†è¿™äº›æ ‡è¯†ç¬¦ä½œä¸ºåç§°é‡å¤ä½¿ç”¨ï¼Œ å°†åœ¨å½“å‰ä½œç”¨åŸŸï¼ˆæˆ–ä»»ä½•åµŒå¥—ä½œç”¨åŸŸï¼‰ä¸­éšè—åŸå§‹æ ‡è¯†ç¬¦ï¼Œæˆ–è€…æ··æ·†ä»£ç ã€‚ åœ¨æœ€å¥½çš„æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨ä¼šæŠ¥é”™ï¼›åœ¨æœ€åçš„æƒ…å†µä¸‹ï¼Œè¿™æ ·çš„ä»£ç å¯èƒ½ä¼šå¼•å…¥æ½œåœ¨çš„ã€éš¾ä»¥æ¢å¤çš„é”™è¯¯ã€‚ BadGood var error string // `error` ä½œç”¨åŸŸéšå¼è¦†ç›– // or func handleErrorMessage(error string) { // `error` ä½œç”¨åŸŸéšå¼è¦†ç›– } var errorMessage string // `error` æŒ‡å‘å†…ç½®çš„éè¦†ç›– // or func handleErrorMessage(msg string) { // `error` æŒ‡å‘å†…ç½®çš„éè¦†ç›– } type Foo struct { // è™½ç„¶è¿™äº›å­—æ®µåœ¨æŠ€æœ¯ä¸Šä¸æ„æˆé˜´å½±ï¼Œä½†`error`æˆ–`string`å­—ç¬¦ä¸²çš„é‡æ˜ å°„ç°åœ¨æ˜¯ä¸æ˜ç¡®çš„ã€‚ error error string string } func (f Foo) Error() error { // `error` å’Œ `f.error` åœ¨è§†è§‰ä¸Šæ˜¯ç›¸ä¼¼çš„ return f.error } func (f Foo) String() string { // `string` and `f.string` åœ¨è§†è§‰ä¸Šæ˜¯ç›¸ä¼¼çš„ return f.string } type Foo struct { // `error` and `string` ç°åœ¨æ˜¯æ˜ç¡®çš„ã€‚ err error str string } func (f Foo) Error() error { return f.err } func (f Foo) String() string { return f.str } æ³¨æ„ï¼Œç¼–è¯‘å™¨åœ¨ä½¿ç”¨é¢„å…ˆåˆ†éš”çš„æ ‡è¯†ç¬¦æ—¶ä¸ä¼šç”Ÿæˆé”™è¯¯ï¼Œ ä½†æ˜¯è¯¸å¦‚go vetä¹‹ç±»çš„å·¥å…·ä¼šæ­£ç¡®åœ°æŒ‡å‡ºè¿™äº›å’Œå…¶ä»–æƒ…å†µä¸‹çš„éšå¼é—®é¢˜ã€‚ ","date":"2020-11-25","objectID":"/posts/go-standard/:2:17","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"é¿å…ä½¿ç”¨ init() å°½å¯èƒ½é¿å…ä½¿ç”¨init()ã€‚å½“init()æ˜¯ä¸å¯é¿å…æˆ–å¯å–çš„ï¼Œä»£ç åº”å…ˆå°è¯•ï¼š æ— è®ºç¨‹åºç¯å¢ƒæˆ–è°ƒç”¨å¦‚ä½•ï¼Œéƒ½è¦å®Œå…¨ç¡®å®šã€‚ é¿å…ä¾èµ–äºå…¶ä»–init()å‡½æ•°çš„é¡ºåºæˆ–å‰¯ä½œç”¨ã€‚è™½ç„¶init()é¡ºåºæ˜¯æ˜ç¡®çš„ï¼Œä½†ä»£ç å¯ä»¥æ›´æ”¹ï¼Œ å› æ­¤init()å‡½æ•°ä¹‹é—´çš„å…³ç³»å¯èƒ½ä¼šä½¿ä»£ç å˜å¾—è„†å¼±å’Œå®¹æ˜“å‡ºé”™ã€‚ é¿å…è®¿é—®æˆ–æ“ä½œå…¨å±€æˆ–ç¯å¢ƒçŠ¶æ€ï¼Œå¦‚æœºå™¨ä¿¡æ¯ã€ç¯å¢ƒå˜é‡ã€å·¥ä½œç›®å½•ã€ç¨‹åºå‚æ•°/è¾“å…¥ç­‰ã€‚ é¿å…I/Oï¼ŒåŒ…æ‹¬æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œå’Œç³»ç»Ÿè°ƒç”¨ã€‚ ä¸èƒ½æ»¡è¶³è¿™äº›è¦æ±‚çš„ä»£ç å¯èƒ½å±äºè¦ä½œä¸ºmain()è°ƒç”¨çš„ä¸€éƒ¨åˆ†ï¼ˆæˆ–ç¨‹åºç”Ÿå‘½å‘¨æœŸä¸­çš„å…¶ä»–åœ°æ–¹ï¼‰ï¼Œ æˆ–è€…ä½œä¸ºmain()æœ¬èº«çš„ä¸€éƒ¨åˆ†å†™å…¥ã€‚ç‰¹åˆ«æ˜¯ï¼Œæ‰“ç®—ç”±å…¶ä»–ç¨‹åºä½¿ç”¨çš„åº“åº”è¯¥ç‰¹åˆ«æ³¨æ„å®Œå…¨ç¡®å®šæ€§ï¼Œ è€Œä¸æ˜¯æ‰§è¡Œâ€œinit magicâ€ BadGood type Foo struct { // ... } var _defaultFoo Foo func init() { _defaultFoo = Foo{ // ... } } var _defaultFoo = Foo{ // ... } // or, ä¸ºäº†æ›´å¥½çš„å¯æµ‹è¯•æ€§: var _defaultFoo = defaultFoo() func defaultFoo() Foo { return Foo{ // ... } } type Config struct { // ... } var _config Config func init() { // Bad: åŸºäºå½“å‰ç›®å½• cwd, _ := os.Getwd() // Bad: I/O raw, _ := ioutil.ReadFile( path.Join(cwd, \"config\", \"config.yaml\"), ) yaml.Unmarshal(raw, \u0026_config) } type Config struct { // ... } func loadConfig() Config { cwd, err := os.Getwd() // handle err raw, err := ioutil.ReadFile( path.Join(cwd, \"config\", \"config.yaml\"), ) // handle err var config Config yaml.Unmarshal(raw, \u0026config) return config } è€ƒè™‘åˆ°ä¸Šè¿°æƒ…å†µï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œinit()å¯èƒ½æ›´å¯å–æˆ–æ˜¯å¿…è¦çš„ï¼Œå¯èƒ½åŒ…æ‹¬ï¼š ä¸èƒ½è¡¨ç¤ºä¸ºå•ä¸ªèµ‹å€¼çš„å¤æ‚è¡¨è¾¾å¼ã€‚ å¯æ’å…¥çš„é’©å­ï¼Œå¦‚database/sqlã€ç¼–ç ç±»å‹æ³¨å†Œè¡¨ç­‰ã€‚ å¯¹Google Cloud Functionså’Œå…¶ä»–å½¢å¼çš„ç¡®å®šæ€§é¢„è®¡ç®—çš„ä¼˜åŒ–ã€‚ ","date":"2020-11-25","objectID":"/posts/go-standard/:2:18","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"è¿½åŠ æ—¶ä¼˜å…ˆæŒ‡å®šåˆ‡ç‰‡å®¹é‡ è¿½åŠ æ—¶ä¼˜å…ˆæŒ‡å®šåˆ‡ç‰‡å®¹é‡ åœ¨å°½å¯èƒ½çš„æƒ…å†µä¸‹ï¼Œåœ¨åˆå§‹åŒ–è¦è¿½åŠ çš„åˆ‡ç‰‡æ—¶ä¸ºmake()æä¾›ä¸€ä¸ªå®¹é‡å€¼ã€‚ BadGood for n := 0; n \u003c b.N; n++ { data := make([]int, 0) for k := 0; k \u003c size; k++{ data = append(data, k) } } for n := 0; n \u003c b.N; n++ { data := make([]int, 0, size) for k := 0; k \u003c size; k++{ data = append(data, k) } } BenchmarkBad-4 100000000 2.48s BenchmarkGood-4 100000000 0.21s ","date":"2020-11-25","objectID":"/posts/go-standard/:2:19","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"æ€§èƒ½ æ€§èƒ½æ–¹é¢çš„ç‰¹å®šå‡†åˆ™åªé€‚ç”¨äºé«˜é¢‘åœºæ™¯ã€‚ ","date":"2020-11-25","objectID":"/posts/go-standard/:3:0","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"ä¼˜å…ˆä½¿ç”¨ strconv è€Œä¸æ˜¯ fmt å°†åŸè¯­è½¬æ¢ä¸ºå­—ç¬¦ä¸²æˆ–ä»å­—ç¬¦ä¸²è½¬æ¢æ—¶ï¼Œstrconvé€Ÿåº¦æ¯”fmtå¿«ã€‚ BadGood for i := 0; i \u003c b.N; i++ { s := fmt.Sprint(rand.Int()) } for i := 0; i \u003c b.N; i++ { s := strconv.Itoa(rand.Int()) } BenchmarkFmtSprint-4 143 ns/op 2 allocs/op BenchmarkStrconv-4 64.2 ns/op 1 allocs/op ","date":"2020-11-25","objectID":"/posts/go-standard/:3:1","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"é¿å…å­—ç¬¦ä¸²åˆ°å­—èŠ‚çš„è½¬æ¢ ä¸è¦åå¤ä»å›ºå®šå­—ç¬¦ä¸²åˆ›å»ºå­—èŠ‚ sliceã€‚ç›¸åï¼Œè¯·æ‰§è¡Œä¸€æ¬¡è½¬æ¢å¹¶æ•è·ç»“æœã€‚ BadGood for i := 0; i \u003c b.N; i++ { w.Write([]byte(\"Hello world\")) } data := []byte(\"Hello world\") for i := 0; i \u003c b.N; i++ { w.Write(data) } BenchmarkBad-4 50000000 22.2 ns/op BenchmarkGood-4 500000000 3.25 ns/op ","date":"2020-11-25","objectID":"/posts/go-standard/:3:2","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"æŒ‡å®šå®¹å™¨å®¹é‡ å°½å¯èƒ½æŒ‡å®šå®¹å™¨å®¹é‡ï¼Œä»¥ä¾¿ä¸ºå®¹å™¨é¢„å…ˆåˆ†é…å†…å­˜ã€‚è¿™å°†åœ¨æ·»åŠ å…ƒç´ æ—¶æœ€å°åŒ–åç»­åˆ†é…ï¼ˆé€šè¿‡å¤åˆ¶å’Œè°ƒæ•´å®¹å™¨å¤§å°ï¼‰ã€‚ æŒ‡å®šMapå®¹é‡æç¤º åœ¨å°½å¯èƒ½çš„æƒ…å†µä¸‹ï¼Œåœ¨ä½¿ç”¨ make() åˆå§‹åŒ–çš„æ—¶å€™æä¾›å®¹é‡ä¿¡æ¯ make(map[T1]T2, hint) å‘make()æä¾›å®¹é‡æç¤ºä¼šåœ¨åˆå§‹åŒ–æ—¶å°è¯•è°ƒæ•´mapçš„å¤§å°ï¼Œè¿™å°†å‡å°‘åœ¨å°†å…ƒç´ æ·»åŠ åˆ°mapæ—¶ä¸ºmapé‡æ–°åˆ†é…å†…å­˜ã€‚ æ³¨æ„ï¼Œä¸slicesä¸åŒã€‚map capacityæç¤ºå¹¶ä¸ä¿è¯å®Œå…¨çš„æŠ¢å å¼åˆ†é…ï¼Œè€Œæ˜¯ç”¨äºä¼°è®¡æ‰€éœ€çš„hashmap bucketçš„æ•°é‡ã€‚ å› æ­¤ï¼Œåœ¨å°†å…ƒç´ æ·»åŠ åˆ°mapæ—¶ï¼Œç”šè‡³åœ¨æŒ‡å®šmapå®¹é‡æ—¶ï¼Œä»å¯èƒ½å‘ç”Ÿåˆ†é…ã€‚ BadGood m := make(map[string]os.FileInfo) files, _ := ioutil.ReadDir(\"./files\") for _, f := range files { m[f.Name()] = f } files, _ := ioutil.ReadDir(\"./files\") m := make(map[string]os.FileInfo, len(files)) for _, f := range files { m[f.Name()] = f } m æ˜¯åœ¨æ²¡æœ‰å¤§å°æç¤ºçš„æƒ…å†µä¸‹åˆ›å»ºçš„ï¼› åœ¨è¿è¡Œæ—¶å¯èƒ½ä¼šæœ‰æ›´å¤šåˆ†é…ã€‚ m æ˜¯æœ‰å¤§å°æç¤ºåˆ›å»ºçš„ï¼›åœ¨è¿è¡Œæ—¶å¯èƒ½ä¼šæœ‰æ›´å°‘çš„åˆ†é…ã€‚ æŒ‡å®šåˆ‡ç‰‡å®¹é‡ åœ¨å°½å¯èƒ½çš„æƒ…å†µä¸‹ï¼Œåœ¨ä½¿ç”¨make()åˆå§‹åŒ–åˆ‡ç‰‡æ—¶æä¾›å®¹é‡ä¿¡æ¯ï¼Œç‰¹åˆ«æ˜¯åœ¨è¿½åŠ åˆ‡ç‰‡æ—¶ã€‚ make([]T, length, capacity) ä¸mapsä¸åŒï¼Œslice capacityä¸æ˜¯ä¸€ä¸ªæç¤ºï¼šç¼–è¯‘å™¨å°†ä¸ºæä¾›ç»™make()çš„sliceçš„å®¹é‡åˆ†é…è¶³å¤Ÿçš„å†…å­˜ï¼Œ è¿™æ„å‘³ç€åç»­çš„append()`æ“ä½œå°†å¯¼è‡´é›¶åˆ†é…ï¼ˆç›´åˆ°sliceçš„é•¿åº¦ä¸å®¹é‡åŒ¹é…ï¼Œåœ¨æ­¤ä¹‹åï¼Œä»»ä½•appendéƒ½å¯èƒ½è°ƒæ•´å¤§å°ä»¥å®¹çº³å…¶ä»–å…ƒç´ ï¼‰ã€‚ BadGood for n := 0; n \u003c b.N; n++ { data := make([]int, 0) for k := 0; k \u003c size; k++{ data = append(data, k) } } for n := 0; n \u003c b.N; n++ { data := make([]int, 0, size) for k := 0; k \u003c size; k++{ data = append(data, k) } } BenchmarkBad-4 100000000 2.48s BenchmarkGood-4 100000000 0.21s ","date":"2020-11-25","objectID":"/posts/go-standard/:3:3","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"è§„èŒƒ ","date":"2020-11-25","objectID":"/posts/go-standard/:4:0","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"ä¸€è‡´æ€§ æœ¬æ–‡ä¸­æ¦‚è¿°çš„ä¸€äº›æ ‡å‡†éƒ½æ˜¯å®¢è§‚æ€§çš„è¯„ä¼°ï¼Œæ˜¯æ ¹æ®åœºæ™¯ã€ä¸Šä¸‹æ–‡ã€æˆ–è€…ä¸»è§‚æ€§çš„åˆ¤æ–­ï¼› ä½†æ˜¯æœ€é‡è¦çš„æ˜¯ï¼Œä¿æŒä¸€è‡´. ä¸€è‡´æ€§çš„ä»£ç æ›´å®¹æ˜“ç»´æŠ¤ã€æ˜¯æ›´åˆç†çš„ã€éœ€è¦æ›´å°‘çš„å­¦ä¹ æˆæœ¬ã€å¹¶ä¸”éšç€æ–°çš„çº¦å®šå‡ºç°æˆ–è€…å‡ºç°é”™è¯¯åæ›´å®¹æ˜“è¿ç§»ã€æ›´æ–°ã€ä¿®å¤ bug ç›¸åï¼Œåœ¨ä¸€ä¸ªä»£ç åº“ä¸­åŒ…å«å¤šä¸ªå®Œå…¨ä¸åŒæˆ–å†²çªçš„ä»£ç é£æ ¼ä¼šå¯¼è‡´ç»´æŠ¤æˆæœ¬å¼€é”€ã€ä¸ç¡®å®šæ€§å’Œè®¤çŸ¥åå·®ã€‚æ‰€æœ‰è¿™äº›éƒ½ä¼šç›´æ¥å¯¼è‡´é€Ÿåº¦é™ä½ã€ä»£ç å®¡æŸ¥ç—›è‹¦ã€è€Œä¸”å¢åŠ  bug æ•°é‡ã€‚ å°†è¿™äº›æ ‡å‡†åº”ç”¨äºä»£ç åº“æ—¶ï¼Œå»ºè®®åœ¨ packageï¼ˆæˆ–æ›´å¤§ï¼‰çº§åˆ«è¿›è¡Œæ›´æ”¹ï¼Œå­åŒ…çº§åˆ«çš„åº”ç”¨ç¨‹åºé€šè¿‡å°†å¤šä¸ªæ ·å¼å¼•å…¥åˆ°åŒä¸€ä»£ç ä¸­ï¼Œè¿åäº†ä¸Šè¿°å…³æ³¨ç‚¹ã€‚ ","date":"2020-11-25","objectID":"/posts/go-standard/:4:1","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"ç›¸ä¼¼çš„å£°æ˜æ”¾åœ¨ä¸€ç»„ Go è¯­è¨€æ”¯æŒå°†ç›¸ä¼¼çš„å£°æ˜æ”¾åœ¨ä¸€ä¸ªç»„å†…ã€‚ BadGood import \"a\" import \"b\" import ( \"a\" \"b\" ) è¿™åŒæ ·é€‚ç”¨äºå¸¸é‡ã€å˜é‡å’Œç±»å‹å£°æ˜ï¼š BadGood const a = 1 const b = 2 var a = 1 var b = 2 type Area float64 type Volume float64 const ( a = 1 b = 2 ) var ( a = 1 b = 2 ) type ( Area float64 Volume float64 ) ä»…å°†ç›¸å…³çš„å£°æ˜æ”¾åœ¨ä¸€ç»„ã€‚ä¸è¦å°†ä¸ç›¸å…³çš„å£°æ˜æ”¾åœ¨ä¸€ç»„ã€‚ BadGood type Operation int const ( Add Operation = iota + 1 Subtract Multiply ENV_VAR = \"MY_ENV\" ) type Operation int const ( Add Operation = iota + 1 Subtract Multiply ) const ENV_VAR = \"MY_ENV\" åˆ†ç»„ä½¿ç”¨çš„ä½ç½®æ²¡æœ‰é™åˆ¶ï¼Œä¾‹å¦‚ï¼šä½ å¯ä»¥åœ¨å‡½æ•°å†…éƒ¨ä½¿ç”¨å®ƒä»¬ï¼š BadGood func f() string { var red = color.New(0xff0000) var green = color.New(0x00ff00) var blue = color.New(0x0000ff) ... } func f() string { var ( red = color.New(0xff0000) green = color.New(0x00ff00) blue = color.New(0x0000ff) ) ... } ","date":"2020-11-25","objectID":"/posts/go-standard/:4:2","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"import åˆ†ç»„ å¯¼å…¥åº”è¯¥åˆ†ä¸ºä¸¤ç»„ï¼š æ ‡å‡†åº“ å½“å‰é¡¹ç›®å†…çš„å¼•ç”¨ ç¬¬ä¸‰æ–¹åº“ é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™æ˜¯ goimports åº”ç”¨çš„åˆ†ç»„ã€‚ BadGood import ( \"fmt\" \"os\" \"go.uber.org/atomic\" \"golang.org/x/sync/errgroup\" \"currentProject/model\" \"currentProject/handler\" ) import ( \"fmt\" \"os\" \"currentProject/model\" \"currentProject/handler\" \"go.uber.org/atomic\" \"golang.org/x/sync/errgroup\" ) ","date":"2020-11-25","objectID":"/posts/go-standard/:4:3","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"åŒ…å å½“å‘½ååŒ…æ—¶ï¼Œè¯·æŒ‰ä¸‹é¢è§„åˆ™é€‰æ‹©ä¸€ä¸ªåç§°ï¼š å…¨éƒ¨å°å†™ã€‚æ²¡æœ‰å¤§å†™æˆ–ä¸‹åˆ’çº¿ã€‚ å¤§å¤šæ•°ä½¿ç”¨å‘½åå¯¼å…¥çš„æƒ…å†µä¸‹ï¼Œä¸éœ€è¦é‡å‘½åã€‚ ç®€çŸ­è€Œç®€æ´ã€‚è¯·è®°ä½ï¼Œåœ¨æ¯ä¸ªä½¿ç”¨çš„åœ°æ–¹éƒ½å®Œæ•´æ ‡è¯†äº†è¯¥åç§°ã€‚ ä¸ç”¨å¤æ•°ã€‚ä¾‹å¦‚net/urlï¼Œè€Œä¸æ˜¯net/urlsã€‚ ä¸è¦ç”¨â€œcommonâ€ï¼Œâ€œutilâ€ï¼Œâ€œsharedâ€æˆ–â€œlibâ€ã€‚è¿™äº›æ˜¯ä¸å¥½çš„ï¼Œä¿¡æ¯é‡ä¸è¶³çš„åç§°ã€‚(åº”è¯¥ä½¿ç”¨æ›´å…·ä½“çš„å‘½åæ–¹å¼ å¦‚httputil, mathutil ç­‰ã€‚) å¦è¯·å‚é˜… Package Names å’Œ Go åŒ…æ ·å¼æŒ‡å—. ","date":"2020-11-25","objectID":"/posts/go-standard/:4:4","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"å‡½æ•°å æˆ‘ä»¬éµå¾ª Go ç¤¾åŒºå…³äºä½¿ç”¨ MixedCaps ä½œä¸ºå‡½æ•°å çš„çº¦å®šã€‚æœ‰ä¸€ä¸ªä¾‹å¤–ï¼Œä¸ºäº†å¯¹ç›¸å…³çš„æµ‹è¯•ç”¨ä¾‹è¿›è¡Œåˆ†ç»„ï¼Œå‡½æ•°åå¯èƒ½åŒ…å«ä¸‹åˆ’çº¿ï¼Œå¦‚ï¼šTestMyFunction_WhatIsBeingTested. ","date":"2020-11-25","objectID":"/posts/go-standard/:4:5","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"å¯¼å…¥åˆ«å å¦‚æœç¨‹åºåŒ…åç§°ä¸å¯¼å…¥è·¯å¾„çš„æœ€åä¸€ä¸ªå…ƒç´ ä¸åŒ¹é…ï¼Œåˆ™å¿…é¡»ä½¿ç”¨å¯¼å…¥åˆ«åã€‚ import ( \"net/http\" client \"example.com/client-go\" trace \"example.com/trace/v2\" ) åœ¨æ‰€æœ‰å…¶ä»–æƒ…å†µä¸‹ï¼Œé™¤éå¯¼å…¥ä¹‹é—´æœ‰ç›´æ¥å†²çªï¼Œå¦åˆ™åº”é¿å…å¯¼å…¥åˆ«åã€‚ BadGood import ( \"fmt\" \"os\" nettrace \"golang.net/x/trace\" ) import ( \"fmt\" \"os\" \"runtime/trace\" nettrace \"golang.net/x/trace\" ) ","date":"2020-11-25","objectID":"/posts/go-standard/:4:6","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"å‡½æ•°åˆ†ç»„ä¸é¡ºåº å‡½æ•°åº”æŒ‰ç²—ç•¥çš„è°ƒç”¨é¡ºåºæ’åºã€‚ åŒä¸€æ–‡ä»¶ä¸­çš„å‡½æ•°åº”æŒ‰æ¥æ”¶è€…åˆ†ç»„ã€‚ å› æ­¤ï¼Œå¯¼å‡ºçš„å‡½æ•°åº”å…ˆå‡ºç°åœ¨æ–‡ä»¶ä¸­ï¼Œæ”¾åœ¨struct, const, varå®šä¹‰çš„åé¢ã€‚ åœ¨å®šä¹‰ç±»å‹ä¹‹åï¼Œä½†åœ¨æ¥æ”¶è€…çš„å…¶ä½™æ–¹æ³•ä¹‹å‰ï¼Œå¯èƒ½ä¼šå‡ºç°ä¸€ä¸ª newXYZ()/NewXYZ() ç”±äºå‡½æ•°æ˜¯æŒ‰æ¥æ”¶è€…åˆ†ç»„çš„ï¼Œå› æ­¤æ™®é€šå·¥å…·å‡½æ•°åº”åœ¨æ–‡ä»¶æœ«å°¾å‡ºç°ã€‚ BadGood func (s *something) Cost() { return calcCost(s.weights) } type something struct{ ... } func calcCost(n []int) int {...} func (s *something) Stop() {...} func newSomething() *something { return \u0026something{} } type something struct{ ... } func newSomething() *something { return \u0026something{} } func (s *something) Cost() { return calcCost(s.weights) } func (s *something) Stop() {...} func calcCost(n []int) int {...} ","date":"2020-11-25","objectID":"/posts/go-standard/:4:7","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"å‡å°‘åµŒå¥— ä»£ç åº”é€šè¿‡å°½å¯èƒ½å…ˆå¤„ç†é”™è¯¯æƒ…å†µ/ç‰¹æ®Šæƒ…å†µå¹¶å°½æ—©è¿”å›æˆ–ç»§ç»­å¾ªç¯æ¥å‡å°‘åµŒå¥—ã€‚å‡å°‘åµŒå¥—å¤šä¸ªçº§åˆ«çš„ä»£ç çš„ä»£ç é‡ã€‚ BadGood for _, v := range data { if v.F1 == 1 { v = process(v) if err := v.Call(); err == nil { v.Send() } else { return err } } else { log.Printf(\"Invalid v: %v\", v) } } for _, v := range data { if v.F1 != 1 { log.Printf(\"Invalid v: %v\", v) continue } v = process(v) if err := v.Call(); err != nil { return err } v.Send() } ","date":"2020-11-25","objectID":"/posts/go-standard/:4:8","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"ä¸å¿…è¦çš„ else å¦‚æœåœ¨ if çš„ä¸¤ä¸ªåˆ†æ”¯ä¸­éƒ½è®¾ç½®äº†å˜é‡ï¼Œåˆ™å¯ä»¥å°†å…¶æ›¿æ¢ä¸ºå•ä¸ª ifã€‚ BadGood var a int if b { a = 100 } else { a = 10 } a := 10 if b { a = 100 } ","date":"2020-11-25","objectID":"/posts/go-standard/:4:9","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"é¡¶å±‚å˜é‡å£°æ˜ åœ¨é¡¶å±‚ï¼Œä½¿ç”¨æ ‡å‡†varå…³é”®å­—ã€‚è¯·å‹¿æŒ‡å®šç±»å‹ï¼Œé™¤éå®ƒä¸è¡¨è¾¾å¼çš„ç±»å‹ä¸åŒã€‚ BadGood var _s string = F() func F() string { return \"A\" } var _s = F() // ç”±äº F å·²ç»æ˜ç¡®äº†è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹ï¼Œå› æ­¤æˆ‘ä»¬æ²¡æœ‰å¿…è¦æ˜¾å¼æŒ‡å®š_s çš„ç±»å‹ // è¿˜æ˜¯é‚£ç§ç±»å‹ func F() string { return \"A\" } å¦‚æœè¡¨è¾¾å¼çš„ç±»å‹ä¸æ‰€éœ€çš„ç±»å‹ä¸å®Œå…¨åŒ¹é…ï¼Œè¯·æŒ‡å®šç±»å‹ã€‚ type myError struct{} func (myError) Error() string { return \"error\" } func F() myError { return myError{} } var _e error = F() // F è¿”å›ä¸€ä¸ª myError ç±»å‹çš„å®ä¾‹ï¼Œä½†æ˜¯æˆ‘ä»¬è¦ error ç±»å‹ ","date":"2020-11-25","objectID":"/posts/go-standard/:4:10","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"å¯¹äºæœªå¯¼å‡ºçš„é¡¶å±‚å¸¸é‡å’Œå˜é‡ï¼Œä½¿ç”¨_ä½œä¸ºå‰ç¼€ åœ¨æœªå¯¼å‡ºçš„é¡¶çº§varså’Œconstsï¼Œ å‰é¢åŠ ä¸Šå‰ç¼€_ï¼Œä»¥ä½¿å®ƒä»¬åœ¨ä½¿ç”¨æ—¶æ˜ç¡®è¡¨ç¤ºå®ƒä»¬æ˜¯å…¨å±€ç¬¦å·ã€‚ ä¾‹å¤–ï¼šæœªå¯¼å‡ºçš„é”™è¯¯å€¼ï¼Œåº”ä»¥errå¼€å¤´ã€‚ åŸºæœ¬ä¾æ®ï¼šé¡¶çº§å˜é‡å’Œå¸¸é‡å…·æœ‰åŒ…èŒƒå›´ä½œç”¨åŸŸã€‚ä½¿ç”¨é€šç”¨åç§°å¯èƒ½å¾ˆå®¹æ˜“åœ¨å…¶ä»–æ–‡ä»¶ä¸­æ„å¤–ä½¿ç”¨é”™è¯¯çš„å€¼ã€‚ BadGood // foo.go const ( defaultPort = 8080 defaultUser = \"user\" ) // bar.go func Bar() { defaultPort := 9090 ... fmt.Println(\"Default port\", defaultPort) // We will not see a compile error if the first line of // Bar() is deleted. } // foo.go const ( _defaultPort = 8080 _defaultUser = \"user\" ) ","date":"2020-11-25","objectID":"/posts/go-standard/:4:11","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"ç»“æ„ä½“ä¸­çš„åµŒå…¥ åµŒå…¥å¼ç±»å‹ï¼ˆä¾‹å¦‚ mutexï¼‰åº”ä½äºç»“æ„ä½“å†…çš„å­—æ®µåˆ—è¡¨çš„é¡¶éƒ¨ï¼Œå¹¶ä¸”å¿…é¡»æœ‰ä¸€ä¸ªç©ºè¡Œå°†åµŒå…¥å¼å­—æ®µä¸å¸¸è§„å­—æ®µåˆ†éš”å¼€ã€‚ BadGood type Client struct { version int http.Client } type Client struct { http.Client version int } å†…åµŒåº”è¯¥æä¾›åˆ‡å®çš„å¥½å¤„ï¼Œæ¯”å¦‚ä»¥è¯­ä¹‰ä¸Šåˆé€‚çš„æ–¹å¼æ·»åŠ æˆ–å¢å¼ºåŠŸèƒ½ã€‚ å®ƒåº”è¯¥åœ¨å¯¹ç”¨æˆ·ä¸åˆ©å½±å“çš„æƒ…å†µä¸‹å®Œæˆè¿™é¡¹å·¥ä½œï¼ˆå¦è¯·å‚è§ï¼šé¿å…åœ¨å…¬å…±ç»“æ„ä¸­åµŒå…¥ç±»å‹Avoid Embedding Types in Public Structsï¼‰ã€‚ åµŒå…¥ ä¸åº”è¯¥: çº¯ç²¹æ˜¯ä¸ºäº†ç¾è§‚æˆ–æ–¹ä¾¿ã€‚ ä½¿å¤–éƒ¨ç±»å‹æ›´éš¾æ„é€ æˆ–ä½¿ç”¨ã€‚ å½±å“å¤–éƒ¨ç±»å‹çš„é›¶å€¼ã€‚å¦‚æœå¤–éƒ¨ç±»å‹æœ‰ä¸€ä¸ªæœ‰ç”¨çš„é›¶å€¼ï¼Œåˆ™åœ¨åµŒå…¥å†…éƒ¨ç±»å‹ä¹‹ååº”è¯¥ä»ç„¶æœ‰ä¸€ä¸ªæœ‰ç”¨çš„é›¶å€¼ã€‚ ä½œä¸ºåµŒå…¥å†…éƒ¨ç±»å‹çš„å‰¯ä½œç”¨ï¼Œä»å¤–éƒ¨ç±»å‹å…¬å¼€ä¸ç›¸å…³çš„å‡½æ•°æˆ–å­—æ®µã€‚ å…¬å¼€æœªå¯¼å‡ºçš„ç±»å‹ã€‚ å½±å“å¤–éƒ¨ç±»å‹çš„å¤åˆ¶å½¢å¼ã€‚ æ›´æ”¹å¤–éƒ¨ç±»å‹çš„APIæˆ–ç±»å‹è¯­ä¹‰ã€‚ åµŒå…¥å†…éƒ¨ç±»å‹çš„éè§„èŒƒå½¢å¼ã€‚ å…¬å¼€å¤–éƒ¨ç±»å‹çš„å®ç°è¯¦ç»†ä¿¡æ¯ã€‚ å…è®¸ç”¨æˆ·è§‚å¯Ÿæˆ–æ§åˆ¶ç±»å‹å†…éƒ¨ã€‚ é€šè¿‡åŒ…è£…çš„æ–¹å¼æ”¹å˜å†…éƒ¨å‡½æ•°çš„ä¸€èˆ¬è¡Œä¸ºï¼Œè¿™ç§åŒ…è£…æ–¹å¼ä¼šç»™ç”¨æˆ·å¸¦æ¥ä¸€äº›æ„æ–™ä¹‹å¤–æƒ…å†µã€‚ ç®€å•åœ°è¯´ï¼Œæœ‰æ„è¯†åœ°å’Œæœ‰ç›®çš„åœ°åµŒå…¥ã€‚ä¸€ç§å¾ˆå¥½çš„æµ‹è¯•ä½“éªŒæ˜¯ï¼Œ â€œæ˜¯å¦æ‰€æœ‰è¿™äº›å¯¼å‡ºçš„å†…éƒ¨æ–¹æ³•/å­—æ®µéƒ½å°†ç›´æ¥æ·»åŠ åˆ°å¤–éƒ¨ç±»å‹â€ å¦‚æœç­”æ¡ˆæ˜¯someæˆ–noï¼Œä¸è¦åµŒå…¥å†…éƒ¨ç±»å‹-è€Œæ˜¯ä½¿ç”¨å­—æ®µã€‚ BadGood type A struct { // Bad: A.Lock() and A.Unlock() ç°åœ¨å¯ç”¨ // ä¸æä¾›ä»»ä½•åŠŸèƒ½æ€§å¥½å¤„ï¼Œå¹¶å…è®¸ç”¨æˆ·æ§åˆ¶æœ‰å…³Açš„å†…éƒ¨ç»†èŠ‚ã€‚ sync.Mutex } type countingWriteCloser struct { // Good: Write() åœ¨å¤–å±‚æä¾›ç”¨äºç‰¹å®šç›®çš„ï¼Œ // å¹¶ä¸”å§”æ‰˜å·¥ä½œåˆ°å†…éƒ¨ç±»å‹çš„Write()ä¸­ã€‚ io.WriteCloser count int } func (w *countingWriteCloser) Write(bs []byte) (int, error) { w.count += len(bs) return w.WriteCloser.Write(bs) } type Book struct { // Bad: æŒ‡é’ˆæ›´æ”¹é›¶å€¼çš„æœ‰ç”¨æ€§ io.ReadWriter // other fields } // later var b Book b.Read(...) // panic: nil pointer b.String() // panic: nil pointer b.Write(...) // panic: nil pointer type Book struct { // Good: æœ‰ç”¨çš„é›¶å€¼ bytes.Buffer // other fields } // later var b Book b.Read(...) // ok b.String() // ok b.Write(...) // ok type Client struct { sync.Mutex sync.WaitGroup bytes.Buffer url.URL } type Client struct { mtx sync.Mutex wg sync.WaitGroup buf bytes.Buffer url url.URL } ","date":"2020-11-25","objectID":"/posts/go-standard/:4:12","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"ä½¿ç”¨å­—æ®µååˆå§‹åŒ–ç»“æ„ä½“ åˆå§‹åŒ–ç»“æ„ä½“æ—¶ï¼Œåº”è¯¥æŒ‡å®šå­—æ®µåç§°ã€‚ç°åœ¨ç”± go vet å¼ºåˆ¶æ‰§è¡Œã€‚ BadGood k := User{\"John\", \"Doe\", true} k := User{ FirstName: \"John\", LastName: \"Doe\", Admin: true, } ä¾‹å¤–ï¼šå¦‚æœæœ‰ 3 ä¸ªæˆ–æ›´å°‘çš„å­—æ®µï¼Œåˆ™å¯ä»¥åœ¨æµ‹è¯•è¡¨ä¸­çœç•¥å­—æ®µåç§°ã€‚ tests := []struct{ op Operation want string }{ {Add, \"add\"}, {Subtract, \"subtract\"}, } ","date":"2020-11-25","objectID":"/posts/go-standard/:4:13","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"æœ¬åœ°å˜é‡å£°æ˜ å¦‚æœå°†å˜é‡æ˜ç¡®è®¾ç½®ä¸ºæŸä¸ªå€¼ï¼Œåˆ™åº”ä½¿ç”¨çŸ­å˜é‡å£°æ˜å½¢å¼ (:=)ã€‚ BadGood var s = \"foo\" s := \"foo\" ä½†æ˜¯ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œvar ä½¿ç”¨å…³é”®å­—æ—¶é»˜è®¤å€¼ä¼šæ›´æ¸…æ™°ã€‚ä¾‹å¦‚ï¼Œå£°æ˜ç©ºåˆ‡ç‰‡ã€‚ BadGood func f(list []int) { filtered := []int{} for _, v := range list { if v \u003e 10 { filtered = append(filtered, v) } } } func f(list []int) { var filtered []int for _, v := range list { if v \u003e 10 { filtered = append(filtered, v) } } } ","date":"2020-11-25","objectID":"/posts/go-standard/:4:14","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"nil æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ slice nil æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„é•¿åº¦ä¸º 0 çš„ sliceï¼Œè¿™æ„å‘³ç€ï¼Œ æ‚¨ä¸åº”æ˜ç¡®è¿”å›é•¿åº¦ä¸ºé›¶çš„åˆ‡ç‰‡ã€‚åº”è¯¥è¿”å›nil æ¥ä»£æ›¿ã€‚ BadGood if x == \"\" { return []int{} } if x == \"\" { return nil } è¦æ£€æŸ¥åˆ‡ç‰‡æ˜¯å¦ä¸ºç©ºï¼Œè¯·å§‹ç»ˆä½¿ç”¨len(s) == 0ã€‚è€Œé nilã€‚ BadGood func isEmpty(s []string) bool { return s == nil } func isEmpty(s []string) bool { return len(s) == 0 } é›¶å€¼åˆ‡ç‰‡ï¼ˆç”¨varå£°æ˜çš„åˆ‡ç‰‡ï¼‰å¯ç«‹å³ä½¿ç”¨ï¼Œæ— éœ€è°ƒç”¨make()åˆ›å»ºã€‚ BadGood nums := []int{} // or, nums := make([]int) if add1 { nums = append(nums, 1) } if add2 { nums = append(nums, 2) } var nums []int if add1 { nums = append(nums, 1) } if add2 { nums = append(nums, 2) } è®°ä½ï¼Œè™½ç„¶nilåˆ‡ç‰‡æ˜¯æœ‰æ•ˆçš„åˆ‡ç‰‡ï¼Œä½†å®ƒä¸ç­‰äºé•¿åº¦ä¸º0çš„åˆ‡ç‰‡ï¼ˆä¸€ä¸ªä¸ºnilï¼Œå¦ä¸€ä¸ªä¸æ˜¯ï¼‰ï¼Œå¹¶ä¸”åœ¨ä¸åŒçš„æƒ…å†µä¸‹ï¼ˆä¾‹å¦‚åºåˆ—åŒ–ï¼‰ï¼Œè¿™ä¸¤ä¸ªåˆ‡ç‰‡çš„å¤„ç†æ–¹å¼å¯èƒ½ä¸åŒã€‚ ","date":"2020-11-25","objectID":"/posts/go-standard/:4:15","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"ç¼©å°å˜é‡ä½œç”¨åŸŸ å¦‚æœæœ‰å¯èƒ½ï¼Œå°½é‡ç¼©å°å˜é‡ä½œç”¨èŒƒå›´ã€‚é™¤éå®ƒä¸ å‡å°‘åµŒå¥—çš„è§„åˆ™å†²çªã€‚ BadGood err := ioutil.WriteFile(name, data, 0644) if err != nil { return err } if err := ioutil.WriteFile(name, data, 0644); err != nil { return err } å¦‚æœéœ€è¦åœ¨ if ä¹‹å¤–ä½¿ç”¨å‡½æ•°è°ƒç”¨çš„ç»“æœï¼Œåˆ™ä¸åº”å°è¯•ç¼©å°èŒƒå›´ã€‚ BadGood if data, err := ioutil.ReadFile(name); err == nil { err = cfg.Decode(data) if err != nil { return err } fmt.Println(cfg) return nil } else { return err } data, err := ioutil.ReadFile(name) if err != nil { return err } if err := cfg.Decode(data); err != nil { return err } fmt.Println(cfg) return nil ","date":"2020-11-25","objectID":"/posts/go-standard/:4:16","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"é¿å…å‚æ•°è¯­ä¹‰ä¸æ˜ç¡®(Avoid Naked Parameters) å‡½æ•°è°ƒç”¨ä¸­çš„æ„ä¹‰ä¸æ˜ç¡®çš„å‚æ•°å¯èƒ½ä¼šæŸå®³å¯è¯»æ€§ã€‚å½“å‚æ•°åç§°çš„å«ä¹‰ä¸æ˜æ˜¾æ—¶ï¼Œè¯·ä¸ºå‚æ•°æ·»åŠ  C æ ·å¼æ³¨é‡Š (/* ... */) BadGood // func printInfo(name string, isLocal, done bool) printInfo(\"foo\", true, true) // func printInfo(name string, isLocal, done bool) printInfo(\"foo\", true /* isLocal */, true /* done */) å¯¹äºä¸Šé¢çš„ç¤ºä¾‹ä»£ç ï¼Œè¿˜æœ‰ä¸€ç§æ›´å¥½çš„å¤„ç†æ–¹å¼æ˜¯å°†ä¸Šé¢çš„ bool ç±»å‹æ¢æˆè‡ªå®šä¹‰ç±»å‹ã€‚å°†æ¥ï¼Œè¯¥å‚æ•°å¯ä»¥æ”¯æŒä¸ä»…ä»…å±€é™äºä¸¤ä¸ªçŠ¶æ€ï¼ˆtrue/falseï¼‰ã€‚ type Region int const ( UnknownRegion Region = iota Local ) type Status int const ( StatusReady Status= iota + 1 StatusDone // Maybe we will have a StatusInProgress in the future. ) func printInfo(name string, region Region, status Status) ","date":"2020-11-25","objectID":"/posts/go-standard/:4:17","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"ä½¿ç”¨åŸå§‹å­—ç¬¦ä¸²å­—é¢å€¼ï¼Œé¿å…è½¬ä¹‰ Go æ”¯æŒä½¿ç”¨ åŸå§‹å­—ç¬¦ä¸²å­—é¢å€¼ï¼Œä¹Ÿå°±æ˜¯ \" ` \" æ¥è¡¨ç¤ºåŸç”Ÿå­—ç¬¦ä¸²ï¼Œåœ¨éœ€è¦è½¬ä¹‰çš„åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬åº”è¯¥å°½é‡ä½¿ç”¨è¿™ç§æ–¹æ¡ˆæ¥æ›¿æ¢ã€‚ å¯ä»¥è·¨è¶Šå¤šè¡Œå¹¶åŒ…å«å¼•å·ã€‚ä½¿ç”¨è¿™äº›å­—ç¬¦ä¸²å¯ä»¥é¿å…æ›´éš¾é˜…è¯»çš„æ‰‹å·¥è½¬ä¹‰çš„å­—ç¬¦ä¸²ã€‚ BadGood wantError := \"unknown name:\\\"test\\\"\" wantError := `unknown error:\"test\"` ","date":"2020-11-25","objectID":"/posts/go-standard/:4:18","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"åˆå§‹åŒ– Struct å¼•ç”¨ åœ¨åˆå§‹åŒ–ç»“æ„å¼•ç”¨æ—¶ï¼Œè¯·ä½¿ç”¨\u0026T{}ä»£æ›¿new(T)ï¼Œä»¥ä½¿å…¶ä¸ç»“æ„ä½“åˆå§‹åŒ–ä¸€è‡´ã€‚ BadGood sval := T{Name: \"foo\"} // inconsistent sptr := new(T) sptr.Name = \"bar\" sval := T{Name: \"foo\"} sptr := \u0026T{Name: \"bar\"} ","date":"2020-11-25","objectID":"/posts/go-standard/:4:19","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"åˆå§‹åŒ– Maps å¯¹äºç©º map è¯·ä½¿ç”¨ make(..) åˆå§‹åŒ–ï¼Œ å¹¶ä¸” map æ˜¯é€šè¿‡ç¼–ç¨‹æ–¹å¼å¡«å……çš„ã€‚ è¿™ä½¿å¾— map åˆå§‹åŒ–åœ¨è¡¨ç°ä¸Šä¸åŒäºå£°æ˜ï¼Œå¹¶ä¸”å®ƒè¿˜å¯ä»¥æ–¹ä¾¿åœ°åœ¨ make åæ·»åŠ å¤§å°æç¤ºã€‚ BadGood var ( // m1 è¯»å†™å®‰å…¨; // m2 åœ¨å†™å…¥æ—¶ä¼š panic m1 = map[T1]T2{} m2 map[T1]T2 ) var ( // m1 è¯»å†™å®‰å…¨; // m2 åœ¨å†™å…¥æ—¶ä¼š panic m1 = make(map[T1]T2) m2 map[T1]T2 ) å£°æ˜å’Œåˆå§‹åŒ–çœ‹èµ·æ¥éå¸¸ç›¸ä¼¼çš„ã€‚ å£°æ˜å’Œåˆå§‹åŒ–çœ‹èµ·æ¥å·®åˆ«éå¸¸å¤§ã€‚ åœ¨å°½å¯èƒ½çš„æƒ…å†µä¸‹ï¼Œè¯·åœ¨åˆå§‹åŒ–æ—¶æä¾› map å®¹é‡å¤§å°ï¼Œè¯¦ç»†è¯·çœ‹ æŒ‡å®šMapå®¹é‡æç¤ºã€‚ å¦å¤–ï¼Œå¦‚æœ map åŒ…å«å›ºå®šçš„å…ƒç´ åˆ—è¡¨ï¼Œåˆ™ä½¿ç”¨ map literals(map åˆå§‹åŒ–åˆ—è¡¨) åˆå§‹åŒ–æ˜ å°„ã€‚ BadGood m := make(map[T1]T2, 3) m[k1] = v1 m[k2] = v2 m[k3] = v3 m := map[T1]T2{ k1: v1, k2: v2, k3: v3, } åŸºæœ¬å‡†åˆ™æ˜¯ï¼šåœ¨åˆå§‹åŒ–æ—¶ä½¿ç”¨ map åˆå§‹åŒ–åˆ—è¡¨ æ¥æ·»åŠ ä¸€ç»„å›ºå®šçš„å…ƒç´ ã€‚å¦åˆ™ä½¿ç”¨ make (å¦‚æœå¯ä»¥ï¼Œè¯·å°½é‡æŒ‡å®š map å®¹é‡)ã€‚ ","date":"2020-11-25","objectID":"/posts/go-standard/:4:20","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"ç¼–ç¨‹æ¨¡å¼ ","date":"2020-11-25","objectID":"/posts/go-standard/:5:0","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"è¡¨é©±åŠ¨æµ‹è¯• å½“æµ‹è¯•é€»è¾‘æ˜¯é‡å¤çš„æ—¶å€™ï¼Œé€šè¿‡ subtests ä½¿ç”¨ table é©±åŠ¨çš„æ–¹å¼ç¼–å†™ case ä»£ç çœ‹ä¸Šå»ä¼šæ›´ç®€æ´ã€‚è€Œä¸”ç›®å‰ç¼–è¯‘å™¨å¯ä»¥é€šè¿‡å¿«æ·é”®å¿«é€Ÿç”Ÿæˆå•å…ƒæµ‹è¯•æ–¹æ³•ï¼Œå¯ä»¥å¸®åŠ©å…»æˆè‰¯å¥½ä¹ æƒ¯ã€‚ BadGood // func TestSplitHostPort(t *testing.T) host, port, err := net.SplitHostPort(\"192.0.2.0:8000\") require.NoError(t, err) assert.Equal(t, \"192.0.2.0\", host) assert.Equal(t, \"8000\", port) host, port, err = net.SplitHostPort(\"192.0.2.0:http\") require.NoError(t, err) assert.Equal(t, \"192.0.2.0\", host) assert.Equal(t, \"http\", port) host, port, err = net.SplitHostPort(\":8000\") require.NoError(t, err) assert.Equal(t, \"\", host) assert.Equal(t, \"8000\", port) host, port, err = net.SplitHostPort(\"1:8\") require.NoError(t, err) assert.Equal(t, \"1\", host) assert.Equal(t, \"8\", port) // func TestSplitHostPort(t *testing.T) tests := []struct{ give string wantHost string wantPort string }{ { give: \"192.0.2.0:8000\", wantHost: \"192.0.2.0\", wantPort: \"8000\", }, { give: \"192.0.2.0:http\", wantHost: \"192.0.2.0\", wantPort: \"http\", }, { give: \":8000\", wantHost: \"\", wantPort: \"8000\", }, { give: \"1:8\", wantHost: \"1\", wantPort: \"8\", }, } for _, tt := range tests { t.Run(tt.give, func(t *testing.T) { host, port, err := net.SplitHostPort(tt.give) require.NoError(t, err) assert.Equal(t, tt.wantHost, host) assert.Equal(t, tt.wantPort, port) }) } å¾ˆæ˜æ˜¾ï¼Œä½¿ç”¨ test table çš„æ–¹å¼åœ¨ä»£ç é€»è¾‘æ‰©å±•çš„æ—¶å€™ï¼Œæ¯”å¦‚æ–°å¢ test caseï¼Œéƒ½ä¼šæ˜¾å¾—æ›´åŠ çš„æ¸…æ™°ã€‚ æˆ‘ä»¬éµå¾ªè¿™æ ·çš„çº¦å®šï¼šå°†ç»“æ„ä½“åˆ‡ç‰‡ç§°ä¸ºtestsã€‚ æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹ç§°ä¸ºttã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬é¼“åŠ±ä½¿ç”¨giveå’Œwantå‰ç¼€è¯´æ˜æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹çš„è¾“å…¥å’Œè¾“å‡ºå€¼ã€‚ tests := []struct{ give string wantHost string wantPort string }{ // ... } for _, tt := range tests { // ... } ","date":"2020-11-25","objectID":"/posts/go-standard/:5:1","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"åŠŸèƒ½é€‰é¡¹ åŠŸèƒ½é€‰é¡¹æ˜¯ä¸€ç§æ¨¡å¼ï¼Œæ‚¨å¯ä»¥åœ¨å…¶ä¸­å£°æ˜ä¸€ä¸ªä¸é€æ˜ Option ç±»å‹ï¼Œè¯¥ç±»å‹åœ¨æŸäº›å†…éƒ¨ç»“æ„ä¸­è®°å½•ä¿¡æ¯ã€‚æ‚¨æ¥å—è¿™äº›é€‰é¡¹çš„å¯å˜ç¼–å·ï¼Œå¹¶æ ¹æ®å†…éƒ¨ç»“æ„ä¸Šçš„é€‰é¡¹è®°å½•çš„å…¨éƒ¨ä¿¡æ¯é‡‡å–è¡ŒåŠ¨ã€‚ å°†æ­¤æ¨¡å¼ç”¨äºæ‚¨éœ€è¦æ‰©å±•çš„æ„é€ å‡½æ•°å’Œå…¶ä»–å…¬å…± API ä¸­çš„å¯é€‰å‚æ•°ï¼Œå°¤å…¶æ˜¯åœ¨è¿™äº›åŠŸèƒ½ä¸Šå·²ç»å…·æœ‰ä¸‰ä¸ªæˆ–æ›´å¤šå‚æ•°çš„æƒ…å†µä¸‹ã€‚ BadGood // package db func Open( addr string, cache bool, logger *zap.Logger ) (*Connection, error) { // ... } // package db type Option interface { // ... } func WithCache(c bool) Option { // ... } func WithLogger(log *zap.Logger) Option { // ... } // Open creates a connection. func Open( addr string, opts ...Option, ) (*Connection, error) { // ... } å¿…é¡»å§‹ç»ˆæä¾›ç¼“å­˜å’Œè®°å½•å™¨å‚æ•°ï¼Œå³ä½¿ç”¨æˆ·å¸Œæœ›ä½¿ç”¨é»˜è®¤å€¼ã€‚ db.Open(addr, db.DefaultCache, zap.NewNop()) db.Open(addr, db.DefaultCache, log) db.Open(addr, false /* cache */, zap.NewNop()) db.Open(addr, false /* cache */, log) åªæœ‰åœ¨éœ€è¦æ—¶æ‰æä¾›é€‰é¡¹ã€‚ db.Open(addr) db.Open(addr, db.WithLogger(log)) db.Open(addr, db.WithCache(false)) db.Open( addr, db.WithCache(false), db.WithLogger(log), ) Our suggested way of implementing this pattern is with an Option interface that holds an unexported method, recording options on an unexported options struct. æˆ‘ä»¬å»ºè®®å®ç°æ­¤æ¨¡å¼çš„æ–¹æ³•æ˜¯ä½¿ç”¨ä¸€ä¸ª Option æ¥å£ï¼Œè¯¥æ¥å£ä¿å­˜ä¸€ä¸ªæœªå¯¼å‡ºçš„æ–¹æ³•ï¼Œåœ¨ä¸€ä¸ªæœªå¯¼å‡ºçš„ options ç»“æ„ä¸Šè®°å½•é€‰é¡¹ã€‚ type options struct { cache bool logger *zap.Logger } type Option interface { apply(*options) } type cacheOption bool func (c cacheOption) apply(opts *options) { opts.cache = bool(c) } func WithCache(c bool) Option { return cacheOption(c) } type loggerOption struct { Log *zap.Logger } func (l loggerOption) apply(opts *options) { opts.logger = l.Log } func WithLogger(log *zap.Logger) Option { return loggerOption{Log: log} } // Open creates a connection. func Open( addr string, opts ...Option, ) (*Connection, error) { options := options{ cache: defaultCache, logger: zap.NewNop(), } for _, o := range opts { o.apply(\u0026options) } // ... } æ³¨æ„: è¿˜æœ‰ä¸€ç§ä½¿ç”¨é—­åŒ…å®ç°è¿™ä¸ªæ¨¡å¼çš„æ–¹æ³•ï¼Œä½†æ˜¯æˆ‘ä»¬ç›¸ä¿¡ä¸Šé¢çš„æ¨¡å¼ä¸ºä½œè€…æä¾›äº†æ›´å¤šçš„çµæ´»æ€§ï¼Œå¹¶ä¸”æ›´å®¹æ˜“å¯¹ç”¨æˆ·è¿›è¡Œè°ƒè¯•å’Œæµ‹è¯•ã€‚ç‰¹åˆ«æ˜¯ï¼Œåœ¨ä¸å¯èƒ½è¿›è¡Œæ¯”è¾ƒçš„æƒ…å†µä¸‹å®ƒå…è®¸åœ¨æµ‹è¯•å’Œæ¨¡æ‹Ÿä¸­å¯¹é€‰é¡¹è¿›è¡Œæ¯”è¾ƒã€‚æ­¤å¤–ï¼Œå®ƒè¿˜å…è®¸é€‰é¡¹å®ç°å…¶ä»–æ¥å£ï¼ŒåŒ…æ‹¬ fmt.Stringerï¼Œå…è®¸ç”¨æˆ·è¯»å–é€‰é¡¹çš„å­—ç¬¦ä¸²è¡¨ç¤ºå½¢å¼ã€‚ è¿˜å¯ä»¥å‚è€ƒä¸‹é¢èµ„æ–™ï¼š Self-referential functions and the design of options Functional options for friendly APIs ","date":"2020-11-25","objectID":"/posts/go-standard/:5:2","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"Linting æ¯”ä»»ä½• â€œblessedâ€ linter é›†æ›´é‡è¦çš„æ˜¯ï¼Œlintåœ¨ä¸€ä¸ªä»£ç åº“ä¸­å§‹ç»ˆä¿æŒä¸€è‡´ã€‚ å»ºè®®è‡³å°‘ä½¿ç”¨ä»¥ä¸‹lintersï¼Œå› ä¸ºæˆ‘è®¤ä¸ºå®ƒä»¬æœ‰åŠ©äºå‘ç°æœ€å¸¸è§çš„é—®é¢˜ï¼Œå¹¶åœ¨ä¸éœ€è¦è§„å®šçš„æƒ…å†µä¸‹ä¸ºä»£ç è´¨é‡å»ºç«‹ä¸€ä¸ªé«˜æ ‡å‡†ï¼š errcheck ä»¥ç¡®ä¿é”™è¯¯å¾—åˆ°å¤„ç† goimports æ ¼å¼åŒ–ä»£ç å’Œç®¡ç† imports golint æŒ‡å‡ºå¸¸è§çš„æ–‡ä½“é”™è¯¯ govet åˆ†æä»£ç ä¸­çš„å¸¸è§é”™è¯¯ staticcheck å„ç§é™æ€åˆ†ææ£€æŸ¥ ","date":"2020-11-25","objectID":"/posts/go-standard/:6:0","tags":["go"],"title":"Go è¯­è¨€å¼€å‘åŠå¸¸ç”¨åº“çš„ä½¿ç”¨è§„èŒƒ(è¯­è¨€ç¯‡)","uri":"/posts/go-standard/"},{"categories":["æºç è§£è¯»"],"content":"Go çš„ map ä½œä¸ºè¯¥è¯­è¨€æœ€å¸¸è§çš„åŸºç¡€æ•°æ®ç»“æ„ä¹‹ä¸€ã€‚ ","date":"2020-06-14","objectID":"/posts/go-map/:0:0","tags":["go"],"title":"Go Map æºç è§£è¯»","uri":"/posts/go-map/"},{"categories":["æºç è§£è¯»"],"content":"æºç è§£è¯» Go è¯­è¨€å®ç°çš„ map å¹¶éæ˜¯å®Œå…¨çš„å“ˆå¸Œ map ï¼Œæ˜¯ä¸€ç§ç±»ä¼¼ä¸¤å±‚æ ‘çŠ¶çš„ç»“æ„ï¼Œæ ¹æ® key çš„å“ˆå¸Œå€¼çš„ä½å…«ä½ å†³å®šç¬¬ä¸€å±‚çš„ä½ç½®ï¼Œæ ¹æ®é«˜å…«ä½å†³å®šç¬¬äºŒå±‚ï¼Œå¦‚æœç¬¬äºŒå±‚æ‰€åœ¨å†²çªäº†åˆ™ä¼šæœ‰ä¸€ä¸ªé¢å¤–çš„ä½ç½® ç”¨äºå­˜å‚¨å“ˆå¸Œç¢°æ’çš„ kvã€‚çœ‹å›¾ä¼šå¸®åŠ©ç†è§£ï¼š ","date":"2020-06-14","objectID":"/posts/go-map/:1:0","tags":["go"],"title":"Go Map æºç è§£è¯»","uri":"/posts/go-map/"},{"categories":["æºç è§£è¯»"],"content":"å›¾è§£ï¼š ","date":"2020-06-14","objectID":"/posts/go-map/:1:1","tags":["go"],"title":"Go Map æºç è§£è¯»","uri":"/posts/go-map/"},{"categories":["æºç è§£è¯»"],"content":"æ•°æ®ç»“æ„ æºç åœ¨ go/src/runtime/map.go æ–‡ä»¶ä¸­ï¼š // map çš„å®ç° type hmap struct { count int // å·²ä½¿ç”¨ä½ç½®æ•°ï¼ˆå³ len() æ–¹æ³•ä¼šè¿”å›è¯¥å€¼ï¼‰ï¼Œä¹‹æ‰€ä»¥è¯´å·²ä½¿ç”¨çš„æ˜¯å› ä¸ºå¹¶éæ‰€æœ‰çš„ä½ç½®éƒ½å­˜æ”¾ä½ç½® flags uint8 // mapçš„çŠ¶æ€ï¼Œé€šè¿‡è¯¥å­—æ®µåˆ¤æ–­å½“å‰æ˜¯å¦è¢«æŸä¸ªè¿›ç¨‹è¿›è¡Œå†™æ“ä½œ B uint8 // 2^B ä¸ºæ¡¶çš„æ•°é‡ï¼Œ Bä¸º 3 æ—¶ 2^3 ä¸€å…± 8 ä¸ªæ¡¶ noverflow uint16 // æº¢å‡ºçš„æ¡¶æ•°é‡ hash0 uint32 // hash seed buckets unsafe.Pointer // æ¡¶çš„æ•°ç»„ oldbuckets unsafe.Pointer // æ—§æ¡¶çš„æ•°ç»„ã€‚map æ‰©å®¹æ—¶ åŸ buckets å˜æˆ oldbuckets å¹¶å°†æ•°æ®é€æ­¥è¿ç§»ï¼Œå¹¶éä¸€æ¬¡æ€§è¿ç§» nevacuate uintptr // æ‰©å®¹è¿›åº¦è®°å½• extra *mapextra // é¢å¤–ä¿¡æ¯ã€‚å­˜å‚¨éæŒ‡é’ˆæ•°æ®ï¼ˆä¸ºäº†ä¼˜åŒ–ç©ºé—´ï¼‰ } type mapextra struct { // ä¸ºäº†ä¼˜åŒ–ç©ºé—´ å°†éæŒ‡é’ˆæ•°æ®å­˜å‚¨åœ¨ mapextraé‡Œ overflow *[]*bmap // å¯¹åº” hmap.buckets oldoverflow *[]*bmap // å¯¹åº” hmap.oldbuckets // æŒ‡å‘ä¸‹ä¸€ä¸ªç©ºé—²çš„ bucket nextOverflow *bmap } // bucket å³æ¡¶ type bmap struct { // tophash å­˜å‚¨æ¯ä¸ª key çš„ tophash å³ key çš„å‰å…«ä½ï¼Œç”¨äºåˆ¤æ–­è¯»å–çš„ key æ˜¯å¦åœ¨å½“å‰æ¡¶é‡Œã€‚ tophash [bucketCnt]uint8 // ä¹‹åæ˜¯ key-value çš„æ ¼å­ï¼Œæ¯ä¸ªæ¡¶æœ€å¤šåªèƒ½å­˜ 8 ä¸ªä¸” ä»¥ key1...key8value1...value8 çš„å½¢å¼å­˜å‚¨ã€‚ // è¿˜æœ‰ä¸€ä¸ª overflow ç”¨äºæŒ‡å‘ä¸‹ä¸€ä¸ªæ¡¶ã€‚ } ","date":"2020-06-14","objectID":"/posts/go-map/:1:2","tags":["go"],"title":"Go Map æºç è§£è¯»","uri":"/posts/go-map/"},{"categories":["æºç è§£è¯»"],"content":"è¯»å– æŒ‰ key è¯»å– éå† ","date":"2020-06-14","objectID":"/posts/go-map/:1:3","tags":["go"],"title":"Go Map æºç è§£è¯»","uri":"/posts/go-map/"},{"categories":["æºç è§£è¯»"],"content":"å†™å…¥ ","date":"2020-06-14","objectID":"/posts/go-map/:1:4","tags":["go"],"title":"Go Map æºç è§£è¯»","uri":"/posts/go-map/"},{"categories":["æºç è§£è¯»"],"content":"åˆ é™¤ coming soon ","date":"2020-06-14","objectID":"/posts/go-map/:1:5","tags":["go"],"title":"Go Map æºç è§£è¯»","uri":"/posts/go-map/"},{"categories":null,"content":"æŠ€æœ¯å¿ å®çˆ±å¥½è€…ï¼Œå–œæ¬¢è¿åŠ¨ï¼Œå–œæ¬¢ä¸å¤§è‡ªç„¶è¿‘è·ç¦»æ¥è§¦ã€‚ ç›®å‰ä¸»è¦ç»å†åœ¨å¾®æœåŠ¡ã€æœåŠ¡æ¶æ„ã€æœåŠ¡æ²»ç†æ–¹å‘ å·¥ä½œå†…å®¹ç›®å‰åå‘äº Kubernetes ç»„ä»¶å¼€å‘ã€ç½‘å…³ã€å¼¹æ€§ä¼¸ç¼©ç­‰ æœ‰è¿‡å®é™…é«˜å¹¶å‘åœºæ™¯çš„ç»éªŒ å–œæ¬¢åˆ†äº«æ„¿æ„åˆ†äº« å…³äºæˆ‘ï¼š é‚®ç®±ï¼šyusankurban@gmail.com åæ ‡ï¼šåŒ—äº¬ å¾®ä¿¡ï¼šyusank77 æ¬¢è¿å„è·¯å¤§ç¥å…³æ³¨å…¬ä¼—å·ï¼Œæå‡ºå®è´µçš„æ„è§ï¼Œè°¢è°¢~ å…¬ä¼—å·äºŒç»´ç  ","date":"2020-03-09","objectID":"/about/:0:0","tags":null,"title":"About me","uri":"/about/"},{"categories":["æºç è§£è¯»"],"content":"Go çš„ channel ä½œä¸ºè¯¥è¯­è¨€å¾ˆé‡è¦çš„ç‰¹æ€§ï¼Œä½œä¸ºä¸€ä¸ª gopher æœ‰å¿…è¦è¯¦ç»†äº†è§£å…¶å®ç°åŸç†ã€‚ åŸç†è§£è¯» Go è¯­è¨€çš„ channel å®ç°æºç åœ¨go/src/runtime/chan.go æ–‡ä»¶é‡Œã€‚ï¼ˆgo version ï¼š1.13.4ï¼‰ ","date":"2020-03-06","objectID":"/posts/go-channel/:0:0","tags":["go"],"title":"Go Channel æºç è§£è¯»","uri":"/posts/go-channel/"},{"categories":["æºç è§£è¯»"],"content":"æ•°æ®ç»“æ„ é¦–å…ˆçœ‹ä¸€ä¸‹åŸºç¡€æ•°æ®ç»“æ„ï¼š // go è¯­è¨€çš„ channel ç»“æ„ä»¥é˜Ÿåˆ—çš„å½¢å¼å®ç° type hchan struct { qcount uint // total data in the queueï¼Œé˜Ÿåˆ—ä¸­å…ƒç´ æ€»æ•° dataqsiz uint // size of the circular queueï¼Œå¾ªç¯é˜Ÿåˆ—çš„å¤§å° buf unsafe.Pointer // points to an array of dataqsiz elementsï¼Œ æŒ‡å‘å¾ªç¯é˜Ÿåˆ—ä¸­å…ƒç´ çš„æŒ‡é’ˆ elemsize uint16 // å…ƒç´  size closed uint32 // channel æ˜¯å¦å…³é—­æ ‡å¿— elemtype *_type // element type // channel å…ƒç´ ç±»å‹ sendx uint // send index // å†™å…¥ channel å…ƒç´ çš„ç´¢å¼• recvx uint // receive index // ä» channel è¯»å–çš„å…ƒç´ ç´¢å¼• recvq waitq // list of recv waiters // è¯»å– channel çš„ç­‰å¾…é˜Ÿåˆ—ï¼ˆå³é˜»å¡çš„åç¨‹ï¼‰ sendq waitq // list of send waiters // å†™å…¥ channel çš„ç­‰å¾…é˜Ÿåˆ— // lock protects all fields in hchan, as well as several // fields in sudogs blocked on this channel. lock mutex // äº’æ–¥é” } // åŒå‘é“¾è¡¨ç»“æ„ï¼Œå…¶ä¸­æ¯ä¸€ä¸ªå…ƒç´ ä»£è¡¨ç€ç­‰å¾…è¯»å–æˆ–å†™å…¥ channel çš„åç¨‹ type waitq struct { first *sudog last *sudog } é€šè¿‡æºç æ•°æ®ç»“æ„ï¼Œå¯¹ go çš„ channel å®ç°æœ‰äº†åˆæ­¥çš„äº†è§£ï¼Œè§£ç­”äº†åœ¨æˆ‘ä»¬è¯»å–æˆ–å†™å…¥ channel æ—¶ï¼Œå…¶ä¸­å…ƒç´ åœ¨å“ªå„¿ï¼Œæˆ‘ä»¬çš„åç¨‹åœ¨å“ªå„¿ç­‰å¾…ç­‰æ•°æ®ç›¸å…³é—®é¢˜ã€‚ channel åº•å±‚å®ç°æ˜¯ä»¥é˜Ÿåˆ—ä½œä¸ºè½½ä½“ï¼Œé€šè¿‡äº’æ–¥é”ä¿è¯åœ¨åŒä¸€ä¸ªæ—¶é—´ç‚¹ï¼Œåªæœ‰ä¸€ä¸ªå¾…è¯»å–çš„åç¨‹è¯»å…ƒç´ æˆ–å¾…å†™å…¥çš„åç¨‹å†™å…¥å…ƒç´ ã€‚ å¦‚æœæœ‰å¤šä¸ªåç¨‹åŒæ—¶è¯»å– channel æ—¶ï¼Œä»–ä»¬ä¼šè¿›å…¥è¯»å–ç­‰å¾…é˜Ÿåˆ—ï¼šrecvqï¼Œåä¹‹è¿›å…¥å†™å…¥ç­‰å¾…é˜Ÿåˆ—ï¼šsendqã€‚ buf ä½œä¸ºæŒ‡é’ˆï¼ŒæŒ‡å‘ channel ä¸­å­˜å‚¨å…ƒç´ çš„æ•°ç»„çš„åœ°å€ã€‚ sendx,recvx ä½œä¸ºchannel é˜Ÿåˆ—ä¸­å†™å…¥å’Œè¯»å–åˆ°å…ƒç´ çš„ç´¢å¼•å€¼ã€‚ closed ä¸º channel å½“å‰æ˜¯å¦å·²è¢«å…³é—­æ ‡å¿—ã€‚ ","date":"2020-03-06","objectID":"/posts/go-channel/:1:0","tags":["go"],"title":"Go Channel æºç è§£è¯»","uri":"/posts/go-channel/"},{"categories":["æºç è§£è¯»"],"content":"ä¸»è¦æ–¹æ³•ï¼ˆfuncï¼‰ ä»¥æˆ‘ä»¬å¸¸ç”¨çš„ make(chan Type), å†™å…¥å…ƒç´ (chan \u003c- element)å’Œè¯»å–å…ƒç´ (\u003c-chan)ä¸ºä¾‹ ","date":"2020-03-06","objectID":"/posts/go-channel/:2:0","tags":["go"],"title":"Go Channel æºç è§£è¯»","uri":"/posts/go-channel/"},{"categories":["æºç è§£è¯»"],"content":"åˆå§‹åŒ–ï¼ˆmakeï¼‰ åœ¨å®é™…ä½¿ç”¨ä¸­ æˆ‘ä¼šç”¨ä¸‹é¢çš„ä»£ç åˆå§‹åŒ–ä¸€ä¸ª channelï¼š make(chan Type, size int) å…¶å®ç°æºç å…¥ä¸‹ï¼š // t ä¸º channel ç±»å‹ï¼Œsize ä¸ºæˆ‘ä»¬ä¼ å…¥ channel å¤§å° func makechan(t *chantype, size int) *hchan { elem := t.elem // å¦‚æœ size è¶…è¿‡å£°æ˜ç±»å‹æœ€å¤§å€¼ ç¼–è¯‘çš„æ—¶å€™ä¼šæŠ¥é”™ï¼Œä½†æ˜¯è¿™é‡Œå¤šä¸€æ¬¡åˆ¤æ–­ä¸ºäº†æ›´å®‰å…¨ if elem.size \u003e= 1\u003c\u003c16 { // æŠ›å‡ºå¼‚å¸¸ throw(\"makechan: invalid channel element type\") } // align ä¸ºç±»å‹çš„å¯¹é½ç³»æ•°ï¼Œä¸åŒå¹³å°ä¸Šå¯¹å…¶ç³»æ•°ä¸å®Œå…¨ä¸€æ ·ï¼Œä½†æ˜¯éƒ½æœ€å¤§å€¼ maxAlign=8 // ä¸åŒç±»å‹çš„å¯¹é½ç³»æ•°ä¸ä¸€æ · ä½†æ˜¯å‡ä»¥ 2^N å½¢å¼ if hchanSize%maxAlign != 0 || elem.align \u003e maxAlign { throw(\"makechan: bad alignment\") } // æ£€æŸ¥æ˜¯å¦channel å¤§å°å€¼æ˜¯å¦æº¢å‡º mem, overflow := math.MulUintptr(elem.size, uintptr(size)) if overflow || mem \u003e maxAlloc-hchanSize || size \u003c 0 { panic(plainError(\"makechan: size out of range\")) } // æ ¹æ® size å’ŒåŸå§‹æ˜¯å¦ä¸ºæŒ‡é’ˆæƒ…å†µï¼Œåˆ†é…å†…å­˜åˆå§‹åŒ– channel var c *hchan switch { // channel size ä¸º 0 case mem == 0: c = (*hchan)(mallocgc(hchanSize, nil, true)) c.buf = c.raceaddr() case elem.ptrdata == 0: // å…ƒç´ ä¸åŒ…å«æŒ‡é’ˆï¼Œåˆ™å°†ä¸ºå…ƒç´ åˆ†é…å†…å­˜ï¼Œå¹¶å°† buf æŒ‡å‘è¯¥åœ°å€ c = (*hchan)(mallocgc(hchanSize+mem, nil, true)) c.buf = add(unsafe.Pointer(c), hchanSize) default: // å…ƒç´ åŒ…å«æŒ‡é’ˆï¼Œbuf æŒ‡å‘è¯¥æŒ‡é’ˆæŒ‡å‘åœ°å€ c = new(hchan) c.buf = mallocgc(mem, elem, true) } c.elemsize = uint16(elem.size) c.elemtype = elem c.dataqsiz = uint(size) return c } å¯ä»¥çœ‹å‡ºï¼Œchannel ä¸­çš„å…ƒç´ æœ€ç»ˆéƒ½æ˜¯ä»¥æŒ‡é’ˆçš„æ–¹å¼å­˜å‚¨ï¼Œå³ä¾¿åˆå§‹åŒ–æ—¶ ç”¨éæŒ‡é’ˆç±»å‹ï¼ˆå¦‚ stringï¼‰ï¼Œåœ¨åˆå§‹åŒ–è¯çš„æ—¶å€™ ä¼šå…ˆåˆ†é…å†…å­˜ å¹¶å°† channel çš„å…ƒç´ æŒ‡é’ˆå­—æ®µæŒ‡å‘è¯¥åœ°å€ã€‚ ","date":"2020-03-06","objectID":"/posts/go-channel/:2:1","tags":["go"],"title":"Go Channel æºç è§£è¯»","uri":"/posts/go-channel/"},{"categories":["æºç è§£è¯»"],"content":"å†™å…¥ å…ˆç»™å‡ºæºç ï¼š // entry point for c \u003c- x from compiled code // ä»£ç é‡ `c \u003c- x` ç¼–è¯‘æ—¶ï¼Œä¼šç¼–è¯‘æˆè¯¥æ–¹æ³•ä»è€Œè¢«è°ƒç”¨ func chansend1(c *hchan, elem unsafe.Pointer) { chansend(c, elem, true, getcallerpc()) } /* * generic single channel send/recv * If block is not nil, * then the protocol will not * sleep but return if it could * not complete. * * sleep can wake up with g.param == nil * when a channel involved in the sleep has * been closed. it is easiest to loop and re-run * the operation; we'll see that it's now closed. */ // å‘ channel å†™å…¥ // c: channel // ep: å†™å…¥å…ƒç´ åœ°å€ // block: è¡¨ç¤ºè¯¥ channel æ˜¯å¦è¢«é˜»å¡ // callerpc: func chansend(c *hchan, ep unsafe.Pointer, block bool, callerpc uintptr) bool { if c == nil { // return or panic } if raceenabled { // ä¸åŒåç¨‹ä¹‹å‰ç«äº‰å†™å…¥ racereadpc(c.raceaddr(), callerpc, funcPC(chansend)) } // æ²¡æœ‰é˜»å¡ \u0026\u0026 æœªå…³é—­ \u0026\u0026 ï¼ˆchannel ä¸ºç©ºä¸”æ²¡æœ‰åç¨‹è¯»å– æˆ– channel å·²æ»¡ï¼Œç›´æ¥è¿”å› falseï¼‰ if !block \u0026\u0026 c.closed == 0 \u0026\u0026 ((c.dataqsiz == 0 \u0026\u0026 c.recvq.first == nil) || (c.dataqsiz \u003e 0 \u0026\u0026 c.qcount == c.dataqsiz)) { return false } var t0 int64 if blockprofilerate \u003e 0 { t0 = cputicks() } // ä¸Šé” å‡†å¤‡å†™ lock(\u0026c.lock) // å·²å…³é—­ è§£é”å¹¶ panic if c.closed != 0 { unlock(\u0026c.lock) panic(plainError(\"send on closed channel\")) } // ä»ç­‰å¾…è¯»å–çš„é˜Ÿåˆ—ä¸­ æ‹¿å‡ºç¬¬ä¸€ä¸ªåç¨‹ï¼Œå†™å…¥å¹¶å‘é€åˆ°è¯¥åç¨‹ if sg := c.recvq.dequeue(); sg != nil { // Found a waiting receiver. We pass the value we want to send // directly to the receiver, bypassing the channel buffer (if any). send(c, sg, ep, func() { unlock(\u0026c.lock) }, 3) return true } // å¦‚æœ channel ç¼“å­˜æœ‰ç©ºé—´ï¼Œåˆ™å‘ç¼“å­˜ä¸­å†™å…¥ // æ­¤æ—¶æ˜¯ channel æ˜¯æœ‰ buffer channel if c.qcount \u003c c.dataqsiz { // Space is available in the channel buffer. Enqueue the element to send. qp := chanbuf(c, c.sendx) // åº”è¯¥æ˜¯åç¨‹ä¹‹é—´ç«äº‰ï¼Œæš‚æ—¶æ²¡æœ‰å®Œå…¨ææ‡‚ if raceenabled { raceacquire(qp) racerelease(qp) } // å†™å…¥ç¼“å­˜ typedmemmove(c.elemtype, qp, ep) // å†™å…¥ä½ç½®åŠ ä¸€ c.sendx++ // å¦‚æœå†™å®Œ buffer æ»¡äº†ï¼Œå°†ä½ç½®ç½®ä½ 0 if c.sendx == c.dataqsiz { c.sendx = 0 } // channel æ•°æ®æ€»æ•°åŠ ä¸€ c.qcount++ // è§£é” unlock(\u0026c.lock) return true } // å¦‚æœæ˜¯éé˜»å¡ç±»å‹ channelï¼Œåˆ™åªè¿”å› if !block { unlock(\u0026c.lock) return false } // å¦‚æœæ˜¯é˜»å¡ç±»å‹ï¼Œåˆ™ä¸€ç›´é˜»å¡ä¸€ç›´åˆ°è¢«è¯»å–ï¼Œä¿è¯æ•°æ®åœ¨è¢«è¯»å–ä¹‹å‰ä¸è¢«å†…å­˜å›æ”¶ // Block on the channel. Some receiver will complete our operation for us. gp := getg() mysg := acquireSudog() mysg.releasetime = 0 if t0 != 0 { mysg.releasetime = -1 } KeepAlive(ep) // someone woke us up. if mysg != gp.waiting { throw(\"G waiting list is corrupted\") } gp.waiting = nil if gp.param == nil { if c.closed == 0 { throw(\"chansend: spurious wakeup\") } panic(plainError(\"send on closed channel\")) } gp.param = nil if mysg.releasetime \u003e 0 { blockevent(mysg.releasetime-t0, 2) } mysg.c = nil releaseSudog(mysg) return true } ","date":"2020-03-06","objectID":"/posts/go-channel/:2:2","tags":["go"],"title":"Go Channel æºç è§£è¯»","uri":"/posts/go-channel/"},{"categories":["æºç è§£è¯»"],"content":"è¯»å– è¿‘æœŸè¡¥å……ã€‚ã€‚ã€‚ ä½¿ç”¨ Channelæ˜¯Goä¸­çš„ä¸€ä¸ªæ ¸å¿ƒç±»å‹ï¼Œä½ å¯ä»¥æŠŠå®ƒçœ‹æˆä¸€ä¸ªç®¡é“ï¼Œé€šè¿‡å®ƒå¹¶å‘æ ¸å¿ƒå•å…ƒå°±å¯ä»¥å‘é€æˆ–è€…æ¥æ”¶æ•°æ®è¿›è¡Œé€šè®¯(communication)ã€‚ å®ƒçš„æ“ä½œç¬¦æ˜¯ç®­å¤´Â \u003c-Â ã€‚ ch \u003c- v v := \u003c-ch (ç®­å¤´çš„æŒ‡å‘å°±æ˜¯æ•°æ®çš„æµå‘) å°±åƒ map å’Œ slice æ•°æ®ç±»å‹ä¸€æ ·, channelå¿…é¡»å…ˆåˆ›å»ºå†ä½¿ç”¨: ch := make(chan int) ","date":"2020-03-06","objectID":"/posts/go-channel/:2:3","tags":["go"],"title":"Go Channel æºç è§£è¯»","uri":"/posts/go-channel/"},{"categories":["æºç è§£è¯»"],"content":"Channel ç±»å‹ Channelç±»å‹çš„å®šä¹‰æ ¼å¼å¦‚ä¸‹ï¼š ChannelType = ( \"chan\" | \"chan\" \"\u003c-\" | \"\u003c-\" \"chan\" ) ElementType . å®ƒåŒ…æ‹¬ä¸‰ç§ç±»å‹çš„å®šä¹‰ã€‚å¯é€‰çš„\u003c-ä»£è¡¨channelçš„æ–¹å‘ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šæ–¹å‘ï¼Œé‚£ä¹ˆChannelå°±æ˜¯åŒå‘çš„ï¼Œæ—¢å¯ä»¥æ¥æ”¶æ•°æ®ï¼Œä¹Ÿå¯ä»¥å‘é€æ•°æ®ã€‚ chan T // å¯ä»¥æ¥æ”¶å’Œå‘é€ç±»å‹ä¸º T çš„æ•°æ® chan\u003c- float64 // åªå¯ä»¥ç”¨æ¥å‘é€ float64 ç±»å‹çš„æ•°æ® \u003c-chan int // åªå¯ä»¥ç”¨æ¥æ¥æ”¶ int ç±»å‹çš„æ•°æ® \u003c-æ€»æ˜¯ä¼˜å…ˆå’Œæœ€å·¦è¾¹çš„ç±»å‹ç»“åˆã€‚(The \u003c- operator associates with the leftmost chan possible) chan\u003c- chan int // ç­‰ä»· chan\u003c- (chan int) chan\u003c- \u003c-chan int // ç­‰ä»· chan\u003c- (\u003c-chan int) \u003c-chan \u003c-chan int // ç­‰ä»· \u003c-chan (\u003c-chan int) chan (\u003c-chan int) ä½¿ç”¨makeåˆå§‹åŒ–Channel,å¹¶ä¸”å¯ä»¥è®¾ç½®å®¹é‡: make(chan int, 100) å®¹é‡(capacity)ä»£è¡¨Channelå®¹çº³çš„æœ€å¤šçš„å…ƒç´ çš„æ•°é‡ï¼Œä»£è¡¨Channelçš„ç¼“å­˜çš„å¤§å°ã€‚ å¦‚æœæ²¡æœ‰è®¾ç½®å®¹é‡ï¼Œæˆ–è€…å®¹é‡è®¾ç½®ä¸º0, è¯´æ˜Channelæ²¡æœ‰ç¼“å­˜ï¼Œåªæœ‰senderå’Œreceiveréƒ½å‡†å¤‡å¥½äº†åå®ƒä»¬çš„é€šè®¯(communication)æ‰ä¼šå‘ç”Ÿ(Blocking)ã€‚å¦‚æœè®¾ç½®äº†ç¼“å­˜ï¼Œå°±æœ‰å¯èƒ½ä¸å‘ç”Ÿé˜»å¡ï¼Œ åªæœ‰bufferæ»¡äº†å sendæ‰ä¼šé˜»å¡ï¼Œ è€Œåªæœ‰ç¼“å­˜ç©ºäº†åreceiveæ‰ä¼šé˜»å¡ã€‚ä¸€ä¸ªnil channelä¸ä¼šé€šä¿¡ã€‚ å¯ä»¥é€šè¿‡å†…å»ºçš„closeæ–¹æ³•å¯ä»¥å…³é—­Channelã€‚ ä½ å¯ä»¥åœ¨å¤šä¸ªgoroutineä»/å¾€ ä¸€ä¸ªchannel ä¸­ receive/send æ•°æ®, ä¸å¿…è€ƒè™‘é¢å¤–çš„åŒæ­¥æªæ–½ã€‚ Channelå¯ä»¥ä½œä¸ºä¸€ä¸ªå…ˆå…¥å…ˆå‡º(FIFO)çš„é˜Ÿåˆ—ï¼Œæ¥æ”¶çš„æ•°æ®å’Œå‘é€çš„æ•°æ®çš„é¡ºåºæ˜¯ä¸€è‡´çš„ã€‚ channelçš„ receiveæ”¯æŒÂ multi-valued assignmentï¼Œå¦‚ v, ok := \u003c-ch å®ƒå¯ä»¥ç”¨æ¥æ£€æŸ¥Channelæ˜¯å¦å·²ç»è¢«å…³é—­äº†ã€‚ sendè¯­å¥ sendè¯­å¥ç”¨æ¥å¾€Channelä¸­å‘é€æ•°æ®ï¼Œ å¦‚ch \u003c- 3ã€‚ å®ƒçš„å®šä¹‰å¦‚ä¸‹: SendStmt = Channel \"\u003c-\" Expression . Channel = Expression . åœ¨é€šè®¯(communication)å¼€å§‹å‰channelå’Œexpressionå¿…é€‰å…ˆæ±‚å€¼å‡ºæ¥(evaluated)ï¼Œæ¯”å¦‚ä¸‹é¢çš„(3+4)å…ˆè®¡ç®—å‡º7ç„¶åå†å‘é€ç»™channelã€‚ c := make(chan int) defer close(c) go func() { c \u003c- 3 + 4 }() i := \u003c-c fmt.Println(i) sendè¢«æ‰§è¡Œå‰(proceed)é€šè®¯(communication)ä¸€ç›´è¢«é˜»å¡ç€ã€‚å¦‚å‰æ‰€è¨€ï¼Œæ— ç¼“å­˜çš„channelåªæœ‰åœ¨receiverå‡†å¤‡å¥½åsendæ‰è¢«æ‰§è¡Œã€‚å¦‚æœæœ‰ç¼“å­˜ï¼Œå¹¶ä¸”ç¼“å­˜æœªæ»¡ï¼Œåˆ™sendä¼šè¢«æ‰§è¡Œã€‚ å¾€ä¸€ä¸ªå·²ç»è¢«closeçš„channelä¸­ç»§ç»­å‘é€æ•°æ®ä¼šå¯¼è‡´run-time panicã€‚ å¾€nil channelä¸­å‘é€æ•°æ®ä¼šä¸€è‡´è¢«é˜»å¡ç€ã€‚ receive æ“ä½œç¬¦ \u003c-chç”¨æ¥ä»channel chä¸­æ¥æ”¶æ•°æ®ï¼Œè¿™ä¸ªè¡¨è¾¾å¼ä¼šä¸€ç›´è¢«block,ç›´åˆ°æœ‰æ•°æ®å¯ä»¥æ¥æ”¶ã€‚ ä»ä¸€ä¸ªnil channelä¸­æ¥æ”¶æ•°æ®ä¼šä¸€ç›´è¢«blockã€‚ ä»ä¸€ä¸ªè¢«closeçš„channelä¸­æ¥æ”¶æ•°æ®ä¸ä¼šè¢«é˜»å¡ï¼Œè€Œæ˜¯ç«‹å³è¿”å›ï¼Œæ¥æ”¶å®Œå·²å‘é€çš„æ•°æ®åä¼šè¿”å›å…ƒç´ ç±»å‹çš„é›¶å€¼(zero value)ã€‚ å¦‚å‰æ‰€è¿°ï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸€ä¸ªé¢å¤–çš„è¿”å›å‚æ•°æ¥æ£€æŸ¥channelæ˜¯å¦å…³é—­ã€‚ x, ok := \u003c-ch x, ok = \u003c-ch var x, ok = \u003c-ch ","date":"2020-03-06","objectID":"/posts/go-channel/:3:0","tags":["go"],"title":"Go Channel æºç è§£è¯»","uri":"/posts/go-channel/"},{"categories":["æºç è§£è¯»"],"content":"blocking ç¼ºçœæƒ…å†µä¸‹ï¼Œå‘é€å’Œæ¥æ”¶ä¼šä¸€ç›´é˜»å¡ç€ï¼ŒçŸ¥é“å¦ä¸€æ–¹å‡†å¤‡å¥½ã€‚è¿™ç§æ–¹å¼å¯ä»¥ç”¨æ¥åœ¨gororutineä¸­è¿›è¡ŒåŒæ­¥ï¼Œè€Œä¸å¿…ä½¿ç”¨æ˜¾ç¤ºçš„é”æˆ–è€…æ¡ä»¶å˜é‡ã€‚ å¦‚å®˜æ–¹çš„ä¾‹å­ä¸­x, y := \u003c-c, \u003c-cè¿™å¥ä¼šä¸€ç›´ç­‰å¾…è®¡ç®—ç»“æœå‘é€åˆ°channelä¸­ã€‚ import \"fmt\" func sum(s []int, c chan int) { sum := 0 for _, v := range s { sum += v } c \u003c- sum } func main() { s := []int{7, 2, 8, -9, 4, 0} c := make(chan int) go sum(s[:len(s)/2], c) go sum(s[len(s)/2:], c) x, y := \u003c-c, \u003c-c // receive from c fmt.Println(x, y, x+y) } ","date":"2020-03-06","objectID":"/posts/go-channel/:4:0","tags":["go"],"title":"Go Channel æºç è§£è¯»","uri":"/posts/go-channel/"},{"categories":["æºç è§£è¯»"],"content":"Buffered Channels makeçš„ç¬¬äºŒä¸ªå‚æ•°æŒ‡å®šç¼“å­˜çš„å¤§å°ï¼šch := make(chan int, 100)ã€‚ é€šè¿‡ç¼“å­˜çš„ä½¿ç”¨ï¼Œå¯ä»¥å°½é‡é¿å…é˜»å¡ï¼Œæä¾›åº”ç”¨çš„æ€§èƒ½ã€‚ ","date":"2020-03-06","objectID":"/posts/go-channel/:5:0","tags":["go"],"title":"Go Channel æºç è§£è¯»","uri":"/posts/go-channel/"},{"categories":["æºç è§£è¯»"],"content":"Range for â€¦â€¦ rangeè¯­å¥å¯ä»¥å¤„ç†Channelã€‚ func main() { go func() { time.Sleep(1 * time.Hour) }() c := make(chan int) go func() { for i := 0; i \u003c 10; i = i + 1 { c \u003c- i } close(c) }() for i := range c { fmt.Println(i) } fmt.Println(\"Finished\") } range cäº§ç”Ÿçš„è¿­ä»£å€¼ä¸ºChannelä¸­å‘é€çš„å€¼ï¼Œå®ƒä¼šä¸€ç›´è¿­ä»£çŸ¥é“channelè¢«å…³é—­ã€‚ä¸Šé¢çš„ä¾‹å­ä¸­å¦‚æœæŠŠclose(c)æ³¨é‡Šæ‰ï¼Œç¨‹åºä¼šä¸€ç›´é˜»å¡åœ¨for â€¦â€¦ rangeé‚£ä¸€è¡Œã€‚ ","date":"2020-03-06","objectID":"/posts/go-channel/:6:0","tags":["go"],"title":"Go Channel æºç è§£è¯»","uri":"/posts/go-channel/"},{"categories":["æºç è§£è¯»"],"content":"select selectè¯­å¥é€‰æ‹©ä¸€ç»„å¯èƒ½çš„sendæ“ä½œå’Œreceiveæ“ä½œå»å¤„ç†ã€‚å®ƒç±»ä¼¼switch,ä½†æ˜¯åªæ˜¯ç”¨æ¥å¤„ç†é€šè®¯(communication)æ“ä½œã€‚ å®ƒçš„caseå¯ä»¥æ˜¯sendè¯­å¥ï¼Œä¹Ÿå¯ä»¥æ˜¯receiveè¯­å¥ï¼Œäº¦æˆ–è€…defaultã€‚ receiveè¯­å¥å¯ä»¥å°†å€¼èµ‹å€¼ç»™ä¸€ä¸ªæˆ–è€…ä¸¤ä¸ªå˜é‡ã€‚å®ƒå¿…é¡»æ˜¯ä¸€ä¸ªreceiveæ“ä½œã€‚ æœ€å¤šå…è®¸æœ‰ä¸€ä¸ªdefault case,å®ƒå¯ä»¥æ”¾åœ¨caseåˆ—è¡¨çš„ä»»ä½•ä½ç½®ï¼Œå°½ç®¡æˆ‘ä»¬å¤§éƒ¨åˆ†ä¼šå°†å®ƒæ”¾åœ¨æœ€åã€‚ import \"fmt\" func fibonacci(c, quit chan int) { x, y := 0, 1 for { select { case c \u003c- x: x, y = y, x+y case \u003c-quit: fmt.Println(\"quit\") return } } } func main() { c := make(chan int) quit := make(chan int) go func() { for i := 0; i \u003c 10; i++ { fmt.Println(\u003c-c) } quit \u003c- 0 }() fibonacci(c, quit) } å¦‚æœæœ‰åŒæ—¶å¤šä¸ªcaseå»å¤„ç†,æ¯”å¦‚åŒæ—¶æœ‰å¤šä¸ªchannelå¯ä»¥æ¥æ”¶æ•°æ®ï¼Œé‚£ä¹ˆGoä¼šä¼ªéšæœºçš„é€‰æ‹©ä¸€ä¸ªcaseå¤„ç†(pseudo-random)ã€‚å¦‚æœæ²¡æœ‰caseéœ€è¦å¤„ç†ï¼Œåˆ™ä¼šé€‰æ‹©defaultå»å¤„ç†ï¼Œå¦‚æœdefault caseå­˜åœ¨çš„æƒ…å†µä¸‹ã€‚å¦‚æœæ²¡æœ‰default caseï¼Œåˆ™selectè¯­å¥ä¼šé˜»å¡ï¼Œç›´åˆ°æŸä¸ªcaseéœ€è¦å¤„ç†ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œnil channelä¸Šçš„æ“ä½œä¼šä¸€ç›´è¢«é˜»å¡ï¼Œå¦‚æœæ²¡æœ‰default case,åªæœ‰nil channelçš„selectä¼šä¸€ç›´è¢«é˜»å¡ã€‚ selectè¯­å¥å’Œswitchè¯­å¥ä¸€æ ·ï¼Œå®ƒä¸æ˜¯å¾ªç¯ï¼Œå®ƒåªä¼šé€‰æ‹©ä¸€ä¸ªcaseæ¥å¤„ç†ï¼Œå¦‚æœæƒ³ä¸€ç›´å¤„ç†channelï¼Œä½ å¯ä»¥åœ¨å¤–é¢åŠ ä¸€ä¸ªæ— é™çš„forå¾ªç¯ï¼š for { select { case c \u003c- x: x, y = y, x+y case \u003c-quit: fmt.Println(\"quit\") return } } ","date":"2020-03-06","objectID":"/posts/go-channel/:7:0","tags":["go"],"title":"Go Channel æºç è§£è¯»","uri":"/posts/go-channel/"},{"categories":["æºç è§£è¯»"],"content":"timeout selectæœ‰å¾ˆé‡è¦çš„ä¸€ä¸ªåº”ç”¨å°±æ˜¯è¶…æ—¶å¤„ç†ã€‚ å› ä¸ºä¸Šé¢æˆ‘ä»¬æåˆ°ï¼Œå¦‚æœæ²¡æœ‰caseéœ€è¦å¤„ç†ï¼Œselectè¯­å¥å°±ä¼šä¸€ç›´é˜»å¡ç€ã€‚è¿™æ—¶å€™æˆ‘ä»¬å¯èƒ½å°±éœ€è¦ä¸€ä¸ªè¶…æ—¶æ“ä½œï¼Œç”¨æ¥å¤„ç†è¶…æ—¶çš„æƒ…å†µã€‚ ä¸‹é¢è¿™ä¸ªä¾‹å­æˆ‘ä»¬ä¼šåœ¨2ç§’åå¾€channel c1ä¸­å‘é€ä¸€ä¸ªæ•°æ®ï¼Œä½†æ˜¯selectè®¾ç½®ä¸º1ç§’è¶…æ—¶,å› æ­¤æˆ‘ä»¬ä¼šæ‰“å°å‡ºtimeout 1,è€Œä¸æ˜¯result 1ã€‚ import \"time\" import \"fmt\" func main() { c1 := make(chan string, 1) go func() { time.Sleep(time.Second * 2) c1 \u003c- \"result 1\" }() select { case res := \u003c-c1: fmt.Println(res) case \u003c-time.After(time.Second * 1): fmt.Println(\"timeout 1\") } } å…¶å®å®ƒåˆ©ç”¨çš„æ˜¯time.Afteræ–¹æ³•ï¼Œå®ƒè¿”å›ä¸€ä¸ªç±»å‹ä¸º\u003c-chan Timeçš„å•å‘çš„channelï¼Œåœ¨æŒ‡å®šçš„æ—¶é—´å‘é€ä¸€ä¸ªå½“å‰æ—¶é—´ç»™è¿”å›çš„channelä¸­ã€‚ ","date":"2020-03-06","objectID":"/posts/go-channel/:7:1","tags":["go"],"title":"Go Channel æºç è§£è¯»","uri":"/posts/go-channel/"},{"categories":["æºç è§£è¯»"],"content":"Timer å’Œ Ticker æˆ‘ä»¬çœ‹ä¸€ä¸‹å…³äºæ—¶é—´çš„ä¸¤ä¸ªChannelã€‚ timeræ˜¯ä¸€ä¸ªå®šæ—¶å™¨ï¼Œä»£è¡¨æœªæ¥çš„ä¸€ä¸ªå•ä¸€äº‹ä»¶ï¼Œä½ å¯ä»¥å‘Šè¯‰timerä½ è¦ç­‰å¾…å¤šé•¿æ—¶é—´ï¼Œå®ƒæä¾›ä¸€ä¸ªChannelï¼Œåœ¨å°†æ¥çš„é‚£ä¸ªæ—¶é—´é‚£ä¸ªChannelæä¾›äº†ä¸€ä¸ªæ—¶é—´å€¼ã€‚ä¸‹é¢çš„ä¾‹å­ä¸­ç¬¬äºŒè¡Œä¼šé˜»å¡2ç§’é’Ÿå·¦å³çš„æ—¶é—´ï¼Œç›´åˆ°æ—¶é—´åˆ°äº†æ‰ä¼šç»§ç»­æ‰§è¡Œã€‚ timer1 := time.NewTimer(time.Second * 2) \u003c-timer1.C fmt.Println(\"Timer 1 expired\") å½“ç„¶å¦‚æœä½ åªæ˜¯æƒ³å•çº¯çš„ç­‰å¾…çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨time.Sleepæ¥å®ç°ã€‚ ä½ è¿˜å¯ä»¥ä½¿ç”¨timer.Stopæ¥åœæ­¢è®¡æ—¶å™¨ã€‚ timer2 := time.NewTimer(time.Second) go func() { \u003c-timer2.C fmt.Println(\"Timer 2 expired\") }() stop2 := timer2.Stop() if stop2 { fmt.Println(\"Timer 2 stopped\") } tickeræ˜¯ä¸€ä¸ªå®šæ—¶è§¦å‘çš„è®¡æ—¶å™¨ï¼Œå®ƒä¼šä»¥ä¸€ä¸ªé—´éš”(interval)å¾€Channelå‘é€ä¸€ä¸ªäº‹ä»¶(å½“å‰æ—¶é—´)ï¼Œè€ŒChannelçš„æ¥æ”¶è€…å¯ä»¥ä»¥å›ºå®šçš„æ—¶é—´é—´éš”ä»Channelä¸­è¯»å–äº‹ä»¶ã€‚ä¸‹é¢çš„ä¾‹å­ä¸­tickeræ¯500æ¯«ç§’è§¦å‘ä¸€æ¬¡ï¼Œä½ å¯ä»¥è§‚å¯Ÿè¾“å‡ºçš„æ—¶é—´ã€‚ ticker := time.NewTicker(time.Millisecond * 500) go func() { for t := range ticker.C { fmt.Println(\"Tick at\", t) } }() ç±»ä¼¼timer, tickerä¹Ÿå¯ä»¥é€šè¿‡Stopæ–¹æ³•æ¥åœæ­¢ã€‚ä¸€æ—¦å®ƒåœæ­¢ï¼Œæ¥æ”¶è€…ä¸å†ä¼šä»channelä¸­æ¥æ”¶æ•°æ®äº†ã€‚ ","date":"2020-03-06","objectID":"/posts/go-channel/:8:0","tags":["go"],"title":"Go Channel æºç è§£è¯»","uri":"/posts/go-channel/"},{"categories":["æºç è§£è¯»"],"content":"close å†…å»ºçš„closeæ–¹æ³•å¯ä»¥ç”¨æ¥å…³é—­channelã€‚ æ€»ç»“ä¸€ä¸‹channelå…³é—­åsenderçš„receiveræ“ä½œã€‚ å¦‚æœchannel cå·²ç»è¢«å…³é—­,ç»§ç»­å¾€å®ƒå‘é€æ•°æ®ä¼šå¯¼è‡´panic: send on closed channel: import \"time\" func main() { go func() { time.Sleep(time.Hour) }() c := make(chan int, 10) c \u003c- 1 c \u003c- 2 close(c) c \u003c- 3 } ä½†æ˜¯ä»è¿™ä¸ªå…³é—­çš„channelä¸­ä¸ä½†å¯ä»¥è¯»å–å‡ºå·²å‘é€çš„æ•°æ®ï¼Œè¿˜å¯ä»¥ä¸æ–­çš„è¯»å–é›¶å€¼: c := make(chan int, 10) c \u003c- 1 c \u003c- 2 close(c) fmt.Println(\u003c-c) //1 fmt.Println(\u003c-c) //2 fmt.Println(\u003c-c) //0 fmt.Println(\u003c-c) //0 ä½†æ˜¯å¦‚æœé€šè¿‡rangeè¯»å–ï¼Œchannelå…³é—­åforå¾ªç¯ä¼šè·³å‡ºï¼š c := make(chan int, 10) c \u003c- 1 c \u003c- 2 close(c) for i := range c { fmt.Println(i) } é€šè¿‡i, ok := \u003c-cå¯ä»¥æŸ¥çœ‹Channelçš„çŠ¶æ€ï¼Œåˆ¤æ–­å€¼æ˜¯é›¶å€¼è¿˜æ˜¯æ­£å¸¸è¯»å–çš„å€¼ã€‚ c := make(chan int, 10) close(c) i, ok := \u003c-c fmt.Printf(\"%d, %t\", i, ok) //0, false ","date":"2020-03-06","objectID":"/posts/go-channel/:9:0","tags":["go"],"title":"Go Channel æºç è§£è¯»","uri":"/posts/go-channel/"},{"categories":["æºç è§£è¯»"],"content":"åŒæ­¥ channelå¯ä»¥ç”¨åœ¨goroutineä¹‹é—´çš„åŒæ­¥ã€‚ ä¸‹é¢çš„ä¾‹å­ä¸­main goroutineé€šè¿‡done channelç­‰å¾…workerå®Œæˆä»»åŠ¡ã€‚ workeråšå®Œä»»åŠ¡ååªéœ€å¾€channelå‘é€ä¸€ä¸ªæ•°æ®å°±å¯ä»¥é€šçŸ¥main goroutineä»»åŠ¡å®Œæˆã€‚ import ( \"fmt\" \"time\" ) func worker(done chan bool) { time.Sleep(time.Second) // é€šçŸ¥ä»»åŠ¡å·²å®Œæˆ done \u003c- true } func main() { done := make(chan bool, 1) go worker(done) // ç­‰å¾…ä»»åŠ¡å®Œæˆ \u003c-done } [å‚è€ƒèµ„æ–™]ï¼š https://gobyexample.com/channels https://tour.golang.org/concurrency/2 https://golang.org/ref/spec#Select_statements https://github.com/a8m/go-lang-cheat-sheet http://devs.cloudimmunity.com/gotchas-and-common-mistakes-in-go-golang/ ","date":"2020-03-06","objectID":"/posts/go-channel/:10:0","tags":["go"],"title":"Go Channel æºç è§£è¯»","uri":"/posts/go-channel/"},{"categories":["ä¸ªäºº"],"content":"ç”±äºä¸Šä¸€ä¸ªåšå®¢é¡¹ç›®çš„åŸæ–‡ä»¶ä¸¢å¤±ï¼Œæ— æ³•ç»§ç»­æ›´æ–°ï¼Œåªä¼šé‡æ–°å¼€å¯æ–°çš„åšå®¢é¡¹ç›®ï¼Œé‡æ–°åšèµ·~ æŠ€æœ¯åŸå› åŸåšå®¢å·²ä¸‹çº¿ï¼ŒåŸåšå®¢æŠ€æœ¯æ–‡æ¡£ä¼šé€æ­¥åŒæ­¥åˆ°æ–°åšå®¢ä¸Šã€‚ ","date":"2020-03-06","objectID":"/posts/my-first-post/:0:0","tags":null,"title":"æ–°çš„ç¯‡ç« ","uri":"/posts/my-first-post/"},{"categories":["åŸºç¡€çŸ¥è¯†"],"content":"ç”¨ GO å®ç°å›¾ç‰‡å¤„ç†å’Œæ–‡å­—åˆæˆ Go çš„å›¾ç‰‡å¤„ç† æœ€è¿‘éœ€è¦ä¸€ä¸ªåˆæˆæ˜ä¿¡ç‰‡çš„å·¥å…·ï¼Œå³å¾€èƒŒæ™¯å›¾çš„å›ºå®šä½ç½®ä¸Šæ·»åŠ ä¸€ä¸ªå›¾ç‰‡å’Œä¸€æ®µæ–‡å­—ï¼Œ æœ€ååˆæˆä¸€å¼ å›¾ç‰‡ã€‚ç”±äºæ˜¯ go ç¨‹åºçš„ä¸€ä¸ªå­åŠŸèƒ½ï¼Œæ‰€ä»¥æˆ‘æƒ³æˆ‘åªåŠ æ‹¿ go å†™å¥½äº†ï¼Œæ­£å¥½æœ‰ go çš„ image åº“ï¼Œæ‹¿æ¥ç»ƒç»ƒã€‚ ","date":"2017-08-22","objectID":"/posts/go-image/:0:0","tags":["go","å›¾ç‰‡å¤„ç†"],"title":"Go Image","uri":"/posts/go-image/"},{"categories":["åŸºç¡€çŸ¥è¯†"],"content":"å›¾ç‰‡åˆæˆ å›¾ç‰‡åˆæˆæˆ‘ç”¨åˆ°äº†è¿™ä¸ªåº“ github.com/disintegration/imaging ä»£ç ï¼š package main import ( \"fmt\" \"image\" \"github.com/disintegration/imaging\" ) func HandleUserImage(fileName string) (string, error) { m, err := imaging.Open(\"target.jpg\") if err != nil { fmt.Printf(\"open file failed\") } bm, err := imaging.Open(\"bg.jpg\") if err != nil { fmt.Printf(\"open file failed\") } // å›¾ç‰‡æŒ‰æ¯”ä¾‹ç¼©æ”¾ dst := imaging.Resize(m, 200, 200, imaging.Lanczos) // å°†å›¾ç‰‡ç²˜è´´åˆ°èƒŒæ™¯å›¾çš„å›ºå®šä½ç½® result := imaging.Overlay(bm, dst, image.Pt(120, 140), 1) fileName := fmt.Sprintf(\"%d.jpg\", fileName) err = imaging.Save(result, fileName) if err != nil { return \"\", err } return fileName, nil } ä»¥ä¸Šæ˜¯å°† target.jpg æ–‡ä»¶å…ˆè¿›è¡Œç¼©æ”¾ï¼Œå†è´´åˆ° bg.jpg æ–‡ä»¶çš„ ï¼ˆ120ï¼Œ140ï¼‰ä½ç½®ï¼Œæœ€åä¿å­˜æˆæ–‡ä»¶ã€‚ ","date":"2017-08-22","objectID":"/posts/go-image/:1:0","tags":["go","å›¾ç‰‡å¤„ç†"],"title":"Go Image","uri":"/posts/go-image/"},{"categories":["åŸºç¡€çŸ¥è¯†"],"content":"å›¾ç‰‡ä¸Šå†™æ–‡å­— ä»¥ä¸‹æ˜¯å†™æ–‡å­—å’Œè´´å›¾çš„ä¸€å—ç”¨çš„å®ä¾‹ï¼š package main import ( \"fmt\" \"image\" \"image/color\" \"io/ioutil\" \"github.com/disintegration/imaging\" \"github.com/golang/freetype\" \"github.com/golang/freetype/truetype\" \"golang.org/x/image/font\" ) func main() { HandleUserImage() } // HandleUserImage paste user image onto background func HandleUserImage() (string, error) { m, err := imaging.Open(\"target.png\") if err != nil { fmt.Printf(\"open file failed\") } bm, err := imaging.Open(\"bg.jpg\") if err != nil { fmt.Printf(\"open file failed\") } // å›¾ç‰‡æŒ‰æ¯”ä¾‹ç¼©æ”¾ dst := imaging.Resize(m, 200, 200, imaging.Lanczos) // å°†å›¾ç‰‡ç²˜è´´åˆ°èƒŒæ™¯å›¾çš„å›ºå®šä½ç½® result := imaging.Overlay(bm, dst, image.Pt(120, 140), 1) writeOnImage(result) fileName := fmt.Sprintf(\"%d.jpg\", 1234) err = imaging.Save(result, fileName) if err != nil { return \"\", err } return fileName, nil } var dpi = flag.Float64(\"dpi\", 256, \"screen resolution\") func writeOnImage(target *image.NRGBA) { c := freetype.NewContext() c.SetDPI(*dpi) c.SetClip(target.Bounds()) c.SetDst(target) c.SetHinting(font.HintingFull) // è®¾ç½®æ–‡å­—é¢œè‰²ã€å­—ä½“ã€å­—å¤§å° c.SetSrc(image.NewUniform(color.RGBA{R: 240, G: 240, B: 245, A: 180})) c.SetFontSize(16) fontFam, err := getFontFamily() if err != nil { fmt.Println(\"get font family error\") } c.SetFont(fontFam) pt := freetype.Pt(500, 400) _, err = c.DrawString(\"æˆ‘æ˜¯æ°´å°\", pt) if err != nil { fmt.Printf(\"draw error: %v \\n\", err) } } func getFontFamily() (*truetype.Font, error) { // è¿™é‡Œéœ€è¦è¯»å–ä¸­æ–‡å­—ä½“ï¼Œå¦åˆ™ä¸­æ–‡æ–‡å­—ä¼šå˜æˆæ–¹æ ¼ fontBytes, err := ioutil.ReadFile(\"Hei.ttc\") if err != nil { fmt.Println(\"read file error:\", err) return \u0026truetype.Font{}, err } f, err := freetype.ParseFont(fontBytes) if err != nil { fmt.Println(\"parse font error:\", err) return \u0026truetype.Font{}, err } return f, err æœ€åæ¥ä¸€å¼ æ•ˆæœå›¾ ","date":"2017-08-22","objectID":"/posts/go-image/:2:0","tags":["go","å›¾ç‰‡å¤„ç†"],"title":"Go Image","uri":"/posts/go-image/"},{"categories":["åŸºç¡€çŸ¥è¯†"],"content":"æ€»ç»“ åšçš„è¿‡ç¨‹ä¸­ï¼Œåˆä½œè¿™ä¸€å—æ¯”è¾ƒå¥½åšï¼Œä½†æ˜¯å›¾ç‰‡ä¸Šå†™æ–‡å­—ï¼Œç›¸å¯¹æ¯”è¾ƒéº»çƒ¦ï¼Œè€Œä¸” freetype åº“å¹¶æ²¡æœ‰é»˜è®¤çš„ä¸­è‹±æ–‡å­—ä½“ï¼Œå¦‚æœä¸æŒ‡å®šå­—ä½“ä¼šæŠ¥é”™ï¼Œè€Œä¸”å­—ä½“æ ¼å¼åªé™åˆ¶äº ttf å’Œ ttc ä¸¤ç§ã€‚ ","date":"2017-08-22","objectID":"/posts/go-image/:3:0","tags":["go","å›¾ç‰‡å¤„ç†"],"title":"Go Image","uri":"/posts/go-image/"},{"categories":["ç½‘ç»œç¼–ç¨‹"],"content":"udp å’Œ tcp çš„ç®€å•æ¯”è¾ƒå’Œç”¨ go å®ç°æœ€ç®€å•çš„ udp å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ â€¦â€¦ ç”¨ go å®ç°ç®€å•çš„ udp ç”¨æˆ·æ•°æ®åŒ…åè®®ï¼ˆè‹±è¯­ï¼šUser Datagram Protocolï¼Œç¼©å†™ä¸ºUDPï¼‰ï¼Œåˆç§°ç”¨æˆ·æ•°æ®æŠ¥æ–‡åè®®ï¼Œæ˜¯ä¸€ä¸ªç®€å•çš„é¢å‘æ•°æ®æŠ¥çš„ä¼ è¾“å±‚åè®®ï¼Œæ­£å¼è§„èŒƒä¸ºRFC 768ã€‚ åœ¨TCP/IPæ¨¡å‹ä¸­ï¼ŒUDPä¸ºç½‘ç»œå±‚ä»¥ä¸Šå’Œåº”ç”¨å±‚ä»¥ä¸‹æä¾›äº†ä¸€ä¸ªç®€å•çš„æ¥å£ã€‚UDPåªæä¾›æ•°æ®çš„ä¸å¯é ä¼ é€’ï¼Œå®ƒä¸€æ—¦æŠŠåº”ç”¨ç¨‹åºå‘ç»™ç½‘ç»œå±‚çš„æ•°æ®å‘é€å‡ºå»ï¼Œå°±ä¸ä¿ç•™æ•°æ®å¤‡ä»½ï¼ˆæ‰€ä»¥UDPæœ‰æ—¶å€™ä¹Ÿè¢«è®¤ä¸ºæ˜¯ä¸å¯é çš„æ•°æ®æŠ¥åè®®ï¼‰ã€‚UDPåœ¨IPæ•°æ®æŠ¥çš„å¤´éƒ¨ä»…ä»…åŠ å…¥äº†å¤ç”¨å’Œæ•°æ®æ ¡éªŒï¼ˆå­—æ®µï¼‰ã€‚ ","date":"2017-08-02","objectID":"/posts/go-udp/:0:0","tags":["go","udp"],"title":"Go UDP Socket","uri":"/posts/go-udp/"},{"categories":["ç½‘ç»œç¼–ç¨‹"],"content":"UDP ä¸ TCP çš„æ¯”è¾ƒ UDP â€“ ç”¨æˆ·æ•°æ®åè®®åŒ…ï¼Œæ˜¯ä¸€ä¸ªç®€å•çš„é¢å‘æ•°æ®æŠ¥çš„è¿è¾“å±‚åè®®ã€‚UDP ä¸æä¾›å¯é æ€§ï¼Œå®ƒåªæ˜¯æŠŠåº”ç”¨ç¨‹åºç»™ IP å±‚çš„æ•°æ®æŠ¥å‘é€å‡ºå»ï¼Œä½†æ˜¯å¹¶ä¸èƒ½ä¿è¯ä»–ä»¬èƒ½è¾¾åˆ°ç›®çš„åœ°ã€‚ç”±äº UDP åœ¨ä¼ è¾“æ•°æ®æŠ¥ä¹‹å‰ä¸ç”¨åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¹‹é—´å»ºç«‹è¿æ¥ï¼Œä¸”æ²¡æœ‰è¶…æ—¶æœºåˆ¶ï¼Œæ•…è€Œä¼ è¾“é€Ÿåº¦å¾ˆå¿«ã€‚ TCP â€“ ä¼ è¾“æ§åˆ¶åè®®ï¼Œæä¾›çš„æ˜¯é¢å‘è¿æ¥ï¼Œå¯é çš„å­—èŠ‚æµæœåŠ¡ã€‚å½“å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å½¼æ­¤äº¤æ¢æ•°æ®å‰ï¼Œå¿…é¡»å…ˆåœ¨åŒæ–¹ä¹‹é—´å»ºç«‹ TCP è¿æ¥ï¼Œä¹‹åæ‰èƒ½ä¼ è¾“æ•°æ®ã€‚TCP æä¾›è¶…æ—¶é‡å‘ï¼Œä¸¢å¼ƒé‡å¤æ•°æ®ï¼Œæ£€éªŒæ•°æ®ï¼Œæµé‡æ§åˆ¶ç­‰åŠŸèƒ½ï¼Œä¿è¯æ•°æ®èƒ½ä»ä¸€æ®µä¼ åˆ°å¦ä¸€ç«¯ã€‚ - TCP UDP æ˜¯å¦è¿æ¥ é¢å‘è¿æ¥ é¢å‘éè¿æ¥ ä¼ è¾“å¯é æ€§ å¯é  ä¼šä¸¢åŒ…ï¼Œä¸å¯é  åº”ç”¨åœºæ™¯ ä¼ è¾“æ•°æ®é‡å¤§ ä¼ è¾“æ•°æ®é‡å° é€Ÿåº¦ æ…¢ å¿« ","date":"2017-08-02","objectID":"/posts/go-udp/:1:0","tags":["go","udp"],"title":"Go UDP Socket","uri":"/posts/go-udp/"},{"categories":["ç½‘ç»œç¼–ç¨‹"],"content":"TCP ä¸ UDP çš„é€‰æ‹© å½“æ•°æ®ä¼ è¾“çš„æ€§èƒ½å¿…é¡»è®©ä½äºæ•°æ®ä¼ è¾“çš„å®Œæ•´æ€§ã€å¯æ§åˆ¶æ€§å’Œå¯é æ€§æ—¶ï¼ŒTCPåè®®æ˜¯å½“ç„¶çš„é€‰æ‹©ã€‚å½“å¼ºè°ƒä¼ è¾“æ€§èƒ½è€Œä¸æ˜¯ä¼ è¾“çš„å®Œæ•´æ€§æ—¶ï¼Œå¦‚ï¼šéŸ³é¢‘å’Œå¤šåª’ä½“åº”ç”¨ï¼ŒUDPæ˜¯æœ€å¥½çš„é€‰æ‹©ã€‚åœ¨æ•°æ®ä¼ è¾“æ—¶é—´å¾ˆçŸ­ï¼Œä»¥è‡³äºæ­¤å‰çš„è¿æ¥è¿‡ç¨‹æˆä¸ºæ•´ä¸ªæµé‡ä¸»ä½“çš„æƒ…å†µä¸‹ï¼ŒUDPä¹Ÿæ˜¯ä¸€ä¸ªå¥½çš„é€‰æ‹©ï¼Œå¦‚ï¼šDNSäº¤æ¢ã€‚æŠŠSNMPå»ºç«‹åœ¨UDPä¸Šçš„éƒ¨åˆ†åŸå› æ˜¯è®¾è®¡è€…è®¤ä¸ºå½“å‘ç”Ÿç½‘ç»œé˜»å¡æ—¶ï¼ŒUDPè¾ƒä½çš„å¼€é”€ä½¿å…¶æœ‰æ›´å¥½çš„æœºä¼šå»ä¼ é€ç®¡ç†æ•°æ®ã€‚TCPä¸°å¯Œçš„åŠŸèƒ½æœ‰æ—¶ä¼šå¯¼è‡´ä¸å¯é¢„æ–™çš„æ€§èƒ½ä½ä¸‹ï¼Œä½†æ˜¯æˆ‘ä»¬ç›¸ä¿¡åœ¨ä¸è¿œçš„å°†æ¥ï¼ŒTCPå¯é çš„ç‚¹å¯¹ç‚¹è¿æ¥å°†ä¼šç”¨äºç»å¤§å¤šæ•°çš„ç½‘ç»œåº”ç”¨ã€‚ ","date":"2017-08-02","objectID":"/posts/go-udp/:2:0","tags":["go","udp"],"title":"Go UDP Socket","uri":"/posts/go-udp/"},{"categories":["ç½‘ç»œç¼–ç¨‹"],"content":"UDP ä½¿ç”¨åœºæ™¯ åœ¨é€‰æ‹©ä½¿ç”¨åè®®çš„æ—¶å€™ï¼Œé€‰æ‹©UDPå¿…é¡»è¦è°¨æ…ã€‚åœ¨ç½‘ç»œè´¨é‡ä»¤äººååˆ†ä¸æ»¡æ„çš„ç¯å¢ƒä¸‹ï¼ŒUDPåè®®æ•°æ®åŒ…ä¸¢å¤±ä¼šæ¯”è¾ƒä¸¥é‡ã€‚ä½†æ˜¯ç”±äºUDPçš„ç‰¹æ€§ï¼šå®ƒä¸å±äºè¿æ¥å‹åè®®ï¼Œå› è€Œå…·æœ‰èµ„æºæ¶ˆè€—å°ï¼Œå¤„ç†é€Ÿåº¦å¿«çš„ä¼˜ç‚¹ï¼Œæ‰€ä»¥é€šå¸¸éŸ³é¢‘ã€è§†é¢‘å’Œæ™®é€šæ•°æ®åœ¨ä¼ é€æ—¶ä½¿ç”¨UDPè¾ƒå¤šï¼Œå› ä¸ºå®ƒä»¬å³ä½¿å¶å°”ä¸¢å¤±ä¸€ä¸¤ä¸ªæ•°æ®åŒ…ï¼Œä¹Ÿä¸ä¼šå¯¹æ¥æ”¶ç»“æœäº§ç”Ÿå¤ªå¤§å½±å“ã€‚è€Œä¸”å¦‚æœåœ¨å†…ç½‘çš„æƒ…å†µä¸‹ï¼Œä¸¢åŒ…ç‡ä¹Ÿå¾ˆä½ï¼Œæ‰€ä»¥å†…ç½‘çš„æ•°æ®ä¼ è¾“ä¹Ÿå¯ä»¥ç”¨ UDP åè®®ã€‚æˆ‘ä»¬å¸¸ç”¨çš„ QQï¼Œä¸€éƒ¨åˆ†æ•°æ®ä¼ è¾“åŠŸèƒ½ä¹Ÿæ˜¯ç”¨ UDPåè®®æ¥å®ç°çš„ã€‚ ","date":"2017-08-02","objectID":"/posts/go-udp/:3:0","tags":["go","udp"],"title":"Go UDP Socket","uri":"/posts/go-udp/"},{"categories":["ç½‘ç»œç¼–ç¨‹"],"content":"å®ç° ä¸‹é¢åˆ†åˆ«æ˜¯æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯å®ç°ä»£ç ï¼š æœåŠ¡ç«¯ä»£ç  server.go: package main import ( \"fmt\" \"net\" ) func main() { // è§£æåœ°å€ addr, err := net.ResolveUDPAddr(\"udp\", \":3017\") if err != nil { fmt.Println(\"Can't resolve addr:\", err.Error()) panic(err) } // ç›‘å¬ç«¯å£ conn, err := net.ListenUDP(\"udp\", addr) if err != nil { fmt.Println(\"listen error:\", err.Error()) panic(err) } defer conn.Close() for { handlerClient(conn) } } func handlerClient(conn *net.UDPConn) { data := make([]byte, 1024) // ä» UDP ä¸­è¯»å–å†…å®¹å¹¶å†™åˆ° data _, remoteAddr, err := conn.ReadFromUDP(data) if err != nil { fmt.Println(\"read udp msg failed with:\", err.Error()) return } // ç»™æ”¶åˆ°æ¶ˆæ¯çš„ client å†™å›ä¿¡æ¯ conn.WriteToUDP([]byte(\"a\"), remoteAddr) } å®¢æˆ·ç«¯ä»£ç client.goï¼š package client import ( \"fmt\" \"net\" ) var ( // Connection *net.UDPConn Connection []*net.UDPConn ) // Client åˆ›å»ºä¸€ä¸ª UDP è¿æ¥ func Client() { addr, err := net.ResolveUDPAddr(\"udp\", \"127.0.0.1:3017\") if err != nil { fmt.Println(\"Can't resolve address: \", err) panic(err) } conn, err := net.DialUDP(\"udp\", nil, addr) if err != nil { fmt.Println(\"Can't dial: \", err) panic(err) } Connection = append(Connection, conn) } // WriteTo åƒä¼ å…¥å‚æ•° conn å†™æ•°æ® func WriteTo(conn *net.UDPConn) { _, err := conn.Write([]byte(\"hello from the other site\")) if err != nil { fmt.Println(\"failed:\", err) } data := make([]byte, 1024) _, err = conn.Read(data) if err != nil { fmt.Println(\"failed to read UDP msg because of \", err) } } ","date":"2017-08-02","objectID":"/posts/go-udp/:4:0","tags":["go","udp"],"title":"Go UDP Socket","uri":"/posts/go-udp/"},{"categories":["ç½‘ç»œç¼–ç¨‹"],"content":"æ€»ç»“ ä»¥ä¸Šæ˜¯ä¸€ä¸ªæœ€ç®€å•çš„ UDP å®¢æˆ·ç«¯æœåŠ¡å™¨çš„ä»£ç ï¼Œåªæœ‰å¯åŠ¨æœåŠ¡å’Œæ”¶å‘æ¶ˆæ¯çš„åŠŸèƒ½ï¼Œä½†å®é™…åº”ç”¨ UDP åè®®åˆ°å…·ä½“éœ€æ±‚çš„æ—¶å€™ï¼Œéœ€è¦è€ƒè™‘çš„é—®é¢˜å¾ˆå¤šï¼Œæ¯”å¦‚åŒ…çš„è®¾è®¡ï¼ŒåŒ…å¤´çš„è®¾è®¡ï¼Œé”™è¯¯å¤„ç†ï¼Œä¸¢åŒ…å¤„ç†ï¼ŒåŒ…é¡ºåºè°ƒæ¢å¤„ç†ç­‰ã€‚æ‰€ä»¥éœ€è¦ç”¨åˆ°ä¼ è¾“æ•°æ®åè®®çš„æ—¶å€™ï¼Œè¯·è€ƒè™‘å¥½éœ€æ±‚å’Œå¯èƒ½é‡åˆ°çš„é—®é¢˜ï¼Œä»¥åŠå¯¹é—®é¢˜çš„å¤„ç†æ–¹æ¡ˆã€‚ ","date":"2017-08-02","objectID":"/posts/go-udp/:5:0","tags":["go","udp"],"title":"Go UDP Socket","uri":"/posts/go-udp/"},{"categories":["ç½‘ç»œç¼–ç¨‹"],"content":"è½¬è½½æ–‡ç«  Goè¯­è¨€TCP Socketç¼–ç¨‹ æ–‡ç« åŸå§‹åœ°å€: http://tonybai.com/2015/11/17/tcp-programming-in-golang/ Golangçš„ä¸»è¦ è®¾è®¡ç›®æ ‡ä¹‹ä¸€å°±æ˜¯é¢å‘å¤§è§„æ¨¡åç«¯æœåŠ¡ç¨‹åºï¼Œç½‘ç»œé€šä¿¡è¿™å—æ˜¯æœåŠ¡ç«¯ ç¨‹åºå¿…ä¸å¯å°‘ä¹Ÿæ˜¯è‡³å…³é‡è¦çš„ä¸€éƒ¨åˆ†ã€‚åœ¨æ—¥å¸¸åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°Goä¸­çš„netä»¥åŠå…¶subdirectoriesä¸‹çš„åŒ…å‡æ˜¯â€œé«˜é¢‘+åˆšéœ€â€ï¼Œè€ŒTCP socketåˆ™æ˜¯ç½‘ç»œç¼–ç¨‹çš„ä¸»æµï¼Œå³ä¾¿æ‚¨æ²¡æœ‰ç›´æ¥ä½¿ç”¨åˆ°netä¸­æœ‰å…³TCP Socketæ–¹é¢çš„æ¥å£ï¼Œä½†net/httpæ€»æ˜¯ç”¨åˆ°äº†å§ï¼Œhttpåº•å±‚ä¾æ—§æ˜¯ç”¨tcp socketå®ç°çš„ã€‚ ç½‘ç»œç¼–ç¨‹æ–¹é¢ï¼Œæˆ‘ä»¬æœ€å¸¸ç”¨çš„å°±æ˜¯tcp socketç¼–ç¨‹äº†ï¼Œåœ¨posixæ ‡å‡†å‡ºæ¥åï¼Œsocketåœ¨å„å¤§ä¸»æµOSå¹³å°ä¸Šéƒ½å¾—åˆ°äº†å¾ˆå¥½çš„æ”¯æŒã€‚å…³äºtcp programmingï¼Œæœ€å¥½çš„èµ„æ–™è«è¿‡äºW. Richard Stevens çš„ç½‘ç»œç¼–ç¨‹åœ£ç»ã€ŠUNIXç½‘ç»œ ç¼–ç¨‹ å·1ï¼šå¥—æ¥å­—è”ç½‘APIã€‹ äº†ï¼Œä¹¦ä¸­å…³äºtcp socketæ¥å£çš„å„ç§ä½¿ç”¨ã€è¡Œä¸ºæ¨¡å¼ã€å¼‚å¸¸å¤„ç†è®²è§£çš„ååˆ†ç»†è‡´ã€‚Goæ˜¯è‡ªå¸¦runtimeçš„è·¨å¹³å°ç¼–ç¨‹è¯­è¨€ï¼ŒGoä¸­æš´éœ²ç»™è¯­è¨€ä½¿ç”¨è€…çš„tcp socket apiæ˜¯å»ºç«‹OSåŸç”Ÿtcp socketæ¥å£ä¹‹ä¸Šçš„ã€‚ç”±äºGo runtimeè°ƒåº¦çš„éœ€è¦ï¼Œgolang tcp socketæ¥å£åœ¨è¡Œä¸ºç‰¹ç‚¹ä¸å¼‚å¸¸å¤„ç†æ–¹é¢ä¸OSåŸç”Ÿæ¥å£æœ‰ç€ä¸€äº›å·®åˆ«ã€‚è¿™ç¯‡åšæ–‡çš„ç›®æ ‡å°±æ˜¯æ•´ç†å‡ºå…³äºGo tcp socketåœ¨å„ä¸ªåœºæ™¯ä¸‹çš„ä½¿ç”¨æ–¹æ³•ã€è¡Œä¸ºç‰¹ç‚¹ä»¥åŠæ³¨æ„äº‹é¡¹ã€‚ ","date":"2017-07-31","objectID":"/posts/go-tcp/:0:0","tags":["go","tcp"],"title":"Go TCP Socket","uri":"/posts/go-tcp/"},{"categories":["ç½‘ç»œç¼–ç¨‹"],"content":"ä¸€ã€æ¨¡å‹ ä»tcp socketè¯ç”Ÿåï¼Œç½‘ç»œç¼–ç¨‹æ¶æ„æ¨¡å‹ä¹Ÿå‡ ç»æ¼”åŒ–ï¼Œå¤§è‡´æ˜¯ï¼šâ€œæ¯è¿›ç¨‹ä¸€ä¸ªè¿æ¥â€ â€“\u003e â€œæ¯çº¿ç¨‹ä¸€ä¸ªè¿æ¥â€ â€“\u003e â€œNon-Block + I/Oå¤šè·¯å¤ç”¨(linux epoll/windows iocp/freebsd darwin kqueue/solaris Event Port)â€ã€‚ä¼´éšç€æ¨¡å‹çš„æ¼”åŒ–ï¼ŒæœåŠ¡ç¨‹åºæ„ˆåŠ å¼ºå¤§ï¼Œå¯ä»¥æ”¯æŒæ›´å¤šçš„è¿æ¥ï¼Œè·å¾—æ›´å¥½çš„å¤„ç†æ€§èƒ½ã€‚ ç›®å‰ä¸»æµweb serverä¸€èˆ¬å‡é‡‡ç”¨çš„éƒ½æ˜¯â€Non-Block + I/Oå¤šè·¯å¤ç”¨â€ï¼ˆæœ‰çš„ä¹Ÿç»“åˆäº†å¤šçº¿ç¨‹ã€å¤šè¿›ç¨‹ï¼‰ã€‚ä¸è¿‡I/Oå¤šè·¯å¤ç”¨ä¹Ÿç»™ä½¿ç”¨è€…å¸¦æ¥äº†ä¸å°çš„å¤æ‚åº¦ï¼Œä»¥è‡³äºåç»­å‡ºç°äº†è®¸å¤šé«˜æ€§èƒ½çš„I/Oå¤šè·¯å¤ç”¨æ¡†æ¶ï¼Œ æ¯”å¦‚libeventã€libevã€libuvç­‰ï¼Œä»¥å¸®åŠ©å¼€å‘è€…ç®€åŒ–å¼€å‘å¤æ‚æ€§ï¼Œé™ä½å¿ƒæ™ºè´Ÿæ‹…ã€‚ä¸è¿‡Goçš„è®¾è®¡è€…ä¼¼ä¹è®¤ä¸ºI/Oå¤šè·¯å¤ç”¨çš„è¿™ç§é€šè¿‡å›è°ƒæœºåˆ¶å‰²è£‚æ§åˆ¶æµ çš„æ–¹å¼ä¾æ—§å¤æ‚ï¼Œä¸”æœ‰æ‚–äºâ€œä¸€èˆ¬é€»è¾‘â€è®¾è®¡ï¼Œä¸ºæ­¤Goè¯­è¨€å°†è¯¥â€œå¤æ‚æ€§â€éšè—åœ¨Runtimeä¸­äº†ï¼šGoå¼€å‘è€…æ— éœ€å…³æ³¨socketæ˜¯å¦æ˜¯ non-blockçš„ï¼Œä¹Ÿæ— éœ€äº²è‡ªæ³¨å†Œæ–‡ä»¶æè¿°ç¬¦çš„å›è°ƒï¼Œåªéœ€åœ¨æ¯ä¸ªè¿æ¥å¯¹åº”çš„goroutineä¸­ä»¥**â€œblock I/Oâ€**çš„æ–¹å¼å¯¹å¾…socketå¤„ç†å³å¯ï¼Œè¿™å¯ä»¥è¯´å¤§å¤§é™ä½äº†å¼€å‘äººå‘˜çš„å¿ƒæ™ºè´Ÿæ‹…ã€‚ä¸€ä¸ªå…¸å‹çš„Go serverç«¯ç¨‹åºå¤§è‡´å¦‚ä¸‹ï¼š //go-tcpsock/server.go func handleConn(c net.Conn) { defer c.Close() for { // read from the connection // ... ... // write to the connection //... ... } } func main() { l, err := net.Listen(\"tcp\", \":8888\") if err != nil { fmt.Println(\"listen error:\", err) return } for { c, err := l.Accept() if err != nil { fmt.Println(\"accept error:\", err) break } // start a new goroutine to handle // the new connection. go handleConn(c) } } ç”¨æˆ·å±‚çœ¼ä¸­çœ‹åˆ°çš„goroutineä¸­çš„â€œblock socketâ€ï¼Œå®é™…ä¸Šæ˜¯é€šè¿‡Go runtimeä¸­çš„netpolleré€šè¿‡Non-block socket + I/Oå¤šè·¯å¤ç”¨æœºåˆ¶â€œæ¨¡æ‹Ÿâ€å‡ºæ¥çš„ï¼ŒçœŸå®çš„underlying socketå®é™…ä¸Šæ˜¯non-blockçš„ï¼Œåªæ˜¯runtimeæ‹¦æˆªäº†åº•å±‚socketç³»ç»Ÿè°ƒç”¨çš„é”™è¯¯ç ï¼Œå¹¶é€šè¿‡netpollerå’Œgoroutine è°ƒåº¦è®©goroutineâ€œé˜»å¡â€åœ¨ç”¨æˆ·å±‚å¾—åˆ°çš„Socket fdä¸Šã€‚æ¯”å¦‚ï¼šå½“ç”¨æˆ·å±‚é’ˆå¯¹æŸä¸ªsocket fdå‘èµ·readæ“ä½œæ—¶ï¼Œå¦‚æœè¯¥socket fdä¸­å°šæ— æ•°æ®ï¼Œé‚£ä¹ˆruntimeä¼šå°†è¯¥socket fdåŠ å…¥åˆ°netpollerä¸­ç›‘å¬ï¼ŒåŒæ—¶å¯¹åº”çš„goroutineè¢«æŒ‚èµ·ï¼Œç›´åˆ°runtimeæ”¶åˆ°socket fd æ•°æ®readyçš„é€šçŸ¥ï¼Œruntimeæ‰ä¼šé‡æ–°å”¤é†’ç­‰å¾…åœ¨è¯¥socket fdä¸Šå‡†å¤‡readçš„é‚£ä¸ªGoroutineã€‚è€Œè¿™ä¸ªè¿‡ç¨‹ä»Goroutineçš„è§†è§’æ¥çœ‹ï¼Œå°±åƒæ˜¯readæ“ä½œä¸€ç›´blockåœ¨é‚£ä¸ªsocket fdä¸Šä¼¼çš„ã€‚å…·ä½“å®ç°ç»†èŠ‚åœ¨åç»­åœºæ™¯ä¸­ä¼šæœ‰è¡¥å……æè¿°ã€‚ ","date":"2017-07-31","objectID":"/posts/go-tcp/:1:0","tags":["go","tcp"],"title":"Go TCP Socket","uri":"/posts/go-tcp/"},{"categories":["ç½‘ç»œç¼–ç¨‹"],"content":"äºŒã€TCPè¿æ¥çš„å»ºç«‹ ä¼—æ‰€å‘¨çŸ¥ï¼ŒTCP Socketçš„è¿æ¥çš„å»ºç«‹éœ€è¦ç»å†å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„ä¸‰æ¬¡æ¡æ‰‹çš„è¿‡ç¨‹ã€‚è¿æ¥å»ºç«‹è¿‡ç¨‹ä¸­ï¼ŒæœåŠ¡ç«¯æ˜¯ä¸€ä¸ªæ ‡å‡†çš„Listen + Acceptçš„ç»“æ„(å¯å‚è€ƒä¸Šé¢çš„ä»£ç )ï¼Œè€Œåœ¨å®¢æˆ·ç«¯Goè¯­è¨€ä½¿ç”¨net.Dialæˆ–DialTimeoutè¿›è¡Œè¿æ¥å»ºç«‹ï¼š é˜»å¡Dialï¼š conn, err := net.Dial(\"tcp\", \"google.com:80\") if err != nil { //handle error } // read or write on conn æˆ–æ˜¯å¸¦ä¸Šè¶…æ—¶æœºåˆ¶çš„Dialï¼š conn, err := net.DialTimeout(\"tcp\", \":8080\", 2 * time.Second) if err != nil { //handle error } // read or write on conn å¯¹äºå®¢æˆ·ç«¯è€Œè¨€ï¼Œè¿æ¥çš„å»ºç«‹ä¼šé‡åˆ°å¦‚ä¸‹å‡ ç§æƒ…å½¢ï¼š ","date":"2017-07-31","objectID":"/posts/go-tcp/:2:0","tags":["go","tcp"],"title":"Go TCP Socket","uri":"/posts/go-tcp/"},{"categories":["ç½‘ç»œç¼–ç¨‹"],"content":"1ã€ç½‘ç»œä¸å¯è¾¾æˆ–å¯¹æ–¹æœåŠ¡æœªå¯åŠ¨ å¦‚æœä¼ ç»™Dialçš„Addræ˜¯å¯ä»¥ç«‹å³åˆ¤æ–­å‡ºç½‘ç»œä¸å¯è¾¾ï¼Œæˆ–è€…Addrä¸­ç«¯å£å¯¹åº”çš„æœåŠ¡æ²¡æœ‰å¯åŠ¨ï¼Œç«¯å£æœªè¢«ç›‘å¬ï¼ŒDialä¼šå‡ ä¹ç«‹å³è¿”å›é”™è¯¯ï¼Œæ¯”å¦‚ï¼š //go-tcpsock/conn_establish/client1.go ... ... func main() { log.Println(\"begin dial...\") conn, err := net.Dial(\"tcp\", \":8888\") if err != nil { log.Println(\"dial error:\", err) return } defer conn.Close() log.Println(\"dial ok\") } å¦‚æœæœ¬æœº8888ç«¯å£æœªæœ‰æœåŠ¡ç¨‹åºç›‘å¬ï¼Œé‚£ä¹ˆæ‰§è¡Œä¸Šé¢ç¨‹åºï¼ŒDialä¼šå¾ˆå¿«è¿”å›é”™è¯¯ï¼š $go run client1.go 2015/11/16 14:37:41 begin dial... 2015/11/16 14:37:41 dial error: dial tcp :8888: getsockopt: connection refused ","date":"2017-07-31","objectID":"/posts/go-tcp/:2:1","tags":["go","tcp"],"title":"Go TCP Socket","uri":"/posts/go-tcp/"},{"categories":["ç½‘ç»œç¼–ç¨‹"],"content":"2ã€å¯¹æ–¹æœåŠ¡çš„listen backlogæ»¡ è¿˜æœ‰ä¸€ç§åœºæ™¯å°±æ˜¯å¯¹æ–¹æœåŠ¡å™¨å¾ˆå¿™ï¼Œç¬é—´æœ‰å¤§é‡clientç«¯è¿æ¥å°è¯•å‘serverå»ºç«‹ï¼Œserverç«¯çš„listen backlogé˜Ÿåˆ—æ»¡ï¼Œserver acceptä¸åŠæ—¶((å³ä¾¿ä¸acceptï¼Œé‚£ä¹ˆåœ¨backlogæ•°é‡èŒƒç•´é‡Œé¢ï¼Œconnectéƒ½ä¼šæ˜¯æˆåŠŸçš„ï¼Œå› ä¸ºnew connå·²ç»åŠ å…¥åˆ°server sideçš„listen queueä¸­äº†ï¼Œacceptåªæ˜¯ä»queueä¸­å–å‡ºä¸€ä¸ªconnè€Œå·²)ï¼Œè¿™å°†å¯¼è‡´clientç«¯Dialé˜»å¡ã€‚æˆ‘ä»¬è¿˜æ˜¯é€šè¿‡ä¾‹å­æ„Ÿå—Dialçš„è¡Œä¸ºç‰¹ç‚¹ï¼š æœåŠ¡ç«¯ä»£ç ï¼š //go-tcpsock/conn_establish/server2.go ... ... func main() { l, err := net.Listen(\"tcp\", \":8888\") if err != nil { log.Println(\"error listen:\", err) return } defer l.Close() log.Println(\"listen ok\") var i int for { time.Sleep(time.Second * 10) if _, err := l.Accept(); err != nil { log.Println(\"accept error:\", err) break } i++ log.Printf(\"%d: accept a new connection\\n\", i) } } å®¢æˆ·ç«¯ä»£ç ï¼š //go-tcpsock/conn_establish/client2.go ... ... func establishConn(i int) net.Conn { conn, err := net.Dial(\"tcp\", \":8888\") if err != nil { log.Printf(\"%d: dial error: %s\", i, err) return nil } log.Println(i, \":connect to server ok\") return conn } func main() { var sl []net.Conn for i := 1; i \u003c 1000; i++ { conn := establishConn(i) if conn != nil { sl = append(sl, conn) } } time.Sleep(time.Second * 10000) } ä»ç¨‹åºå¯ä»¥çœ‹å‡ºï¼ŒæœåŠ¡ç«¯åœ¨listenæˆåŠŸåï¼Œæ¯éš”10sé’Ÿacceptä¸€æ¬¡ã€‚å®¢æˆ·ç«¯åˆ™æ˜¯ä¸²è¡Œçš„å°è¯•å»ºç«‹è¿æ¥ã€‚è¿™ä¸¤ä¸ªç¨‹åºåœ¨Darwinä¸‹çš„æ‰§è¡Œ ç»“æœï¼š $go run server2.go 2015/11/16 21:55:41 listen ok 2015/11/16 21:55:51 1: accept a new connection 2015/11/16 21:56:01 2: accept a new connection ... ... $go run client2.go 2015/11/16 21:55:44 1 :connect to server ok 2015/11/16 21:55:44 2 :connect to server ok 2015/11/16 21:55:44 3 :connect to server ok ... ... 2015/11/16 21:55:44 126 :connect to server ok 2015/11/16 21:55:44 127 :connect to server ok 2015/11/16 21:55:44 128 :connect to server ok 2015/11/16 21:55:52 129 :connect to server ok 2015/11/16 21:56:03 130 :connect to server ok 2015/11/16 21:56:14 131 :connect to server ok ... ... å¯ä»¥çœ‹å‡ºClientåˆå§‹æ—¶æˆåŠŸåœ°ä¸€æ¬¡æ€§å»ºç«‹äº†128ä¸ªè¿æ¥ï¼Œç„¶ååç»­æ¯é˜»å¡è¿‘10sæ‰èƒ½æˆåŠŸå»ºç«‹ä¸€æ¡è¿æ¥ã€‚ä¹Ÿå°±æ˜¯è¯´åœ¨serverç«¯ backlogæ»¡æ—¶(æœªåŠæ—¶accept)ï¼Œå®¢æˆ·ç«¯å°†é˜»å¡åœ¨Dialä¸Šï¼Œç›´åˆ°serverç«¯è¿›è¡Œä¸€æ¬¡acceptã€‚è‡³äºä¸ºä»€ä¹ˆæ˜¯128ï¼Œè¿™ä¸darwin ä¸‹çš„é»˜è®¤è®¾ç½®æœ‰å…³ï¼š $sysctl -a|grep kern.ipc.somaxconn kern.ipc.somaxconn: 128 å¦‚æœæˆ‘åœ¨ubuntu 14.04ä¸Šè¿è¡Œä¸Šè¿°serverç¨‹åºï¼Œæˆ‘ä»¬çš„clientç«¯åˆå§‹å¯ä»¥æˆåŠŸå»ºç«‹499æ¡è¿æ¥ã€‚ å¦‚æœserverä¸€ç›´ä¸acceptï¼Œclientç«¯ä¼šä¸€ç›´é˜»å¡ä¹ˆï¼Ÿæˆ‘ä»¬å»æ‰acceptåçš„ç»“æœæ˜¯ï¼šåœ¨Darwinä¸‹ï¼Œclientç«¯ä¼šé˜»å¡å¤§ çº¦1åˆ†å¤šé’Ÿæ‰ä¼šè¿”å›timeoutï¼š 2015/11/16 22:03:31 128 :connect to server ok 2015/11/16 22:04:48 129: dial error: dial tcp :8888: getsockopt: operation timed out è€Œå¦‚æœserverè¿è¡Œåœ¨ubuntu 14.04ä¸Šï¼Œclientä¼¼ä¹ä¸€ç›´é˜»å¡ï¼Œæˆ‘ç­‰äº†10å¤šåˆ†é’Ÿä¾æ—§æ²¡æœ‰è¿”å›ã€‚ é˜»å¡ä¸å¦çœ‹æ¥ä¸serverç«¯çš„ç½‘ç»œå®ç°å’Œè®¾ç½®æœ‰å…³ã€‚ ","date":"2017-07-31","objectID":"/posts/go-tcp/:2:2","tags":["go","tcp"],"title":"Go TCP Socket","uri":"/posts/go-tcp/"},{"categories":["ç½‘ç»œç¼–ç¨‹"],"content":"3ã€ç½‘ç»œå»¶è¿Ÿè¾ƒå¤§ï¼ŒDialé˜»å¡å¹¶è¶…æ—¶ å¦‚æœç½‘ç»œå»¶è¿Ÿè¾ƒå¤§ï¼ŒTCPæ¡æ‰‹è¿‡ç¨‹å°†æ›´åŠ è‰°éš¾åå·ï¼ˆå„ç§ä¸¢åŒ…ï¼‰ï¼Œæ—¶é—´æ¶ˆè€—çš„è‡ªç„¶ä¹Ÿä¼šæ›´é•¿ã€‚Dialè¿™æ—¶ä¼šé˜»å¡ï¼Œå¦‚æœé•¿æ—¶é—´ä¾æ—§æ— æ³•å»ºç«‹è¿æ¥ï¼Œåˆ™Dialä¹Ÿä¼šè¿”å›â€œ getsockopt: operation timed outâ€é”™è¯¯ã€‚ åœ¨è¿æ¥å»ºç«‹é˜¶æ®µï¼Œå¤šæ•°æƒ…å†µä¸‹ï¼ŒDialæ˜¯å¯ä»¥æ»¡è¶³éœ€æ±‚çš„ï¼Œå³ä¾¿é˜»å¡ä¸€å°ä¼šå„¿ã€‚ä½†å¯¹äºæŸäº›ç¨‹åºè€Œè¨€ï¼Œéœ€è¦æœ‰ä¸¥æ ¼çš„è¿æ¥æ—¶é—´é™å®šï¼Œå¦‚æœä¸€å®šæ—¶é—´å†…æ²¡èƒ½æˆåŠŸå»ºç«‹è¿æ¥ï¼Œç¨‹åºå¯èƒ½ä¼šéœ€è¦æ‰§è¡Œä¸€æ®µâ€œå¼‚å¸¸â€å¤„ç†é€»è¾‘ï¼Œä¸ºæ­¤æˆ‘ä»¬å°±éœ€è¦DialTimeoutäº†ã€‚ä¸‹é¢çš„ä¾‹å­å°†Dialçš„æœ€é•¿é˜»å¡æ—¶é—´é™åˆ¶åœ¨2så†…ï¼Œè¶…å‡ºè¿™ä¸ªæ—¶é•¿ï¼ŒDialå°†è¿”å›timeout errorï¼š //go-tcpsock/conn_establish/client3.go ... ... func main() { log.Println(\"begin dial...\") conn, err := net.DialTimeout(\"tcp\", \"104.236.176.96:80\", 2*time.Second) if err != nil { log.Println(\"dial error:\", err) return } defer conn.Close() log.Println(\"dial ok\") } æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼ˆéœ€è¦æ¨¡æ‹Ÿä¸€ä¸ªå»¶è¿Ÿè¾ƒå¤§çš„ç½‘ç»œç¯å¢ƒï¼‰ï¼š $go run client3.go 2015/11/17 09:28:34 begin dial... 2015/11/17 09:28:36 dial error: dial tcp 104.236.176.96:80: i/o timeout ","date":"2017-07-31","objectID":"/posts/go-tcp/:2:3","tags":["go","tcp"],"title":"Go TCP Socket","uri":"/posts/go-tcp/"},{"categories":["ç½‘ç»œç¼–ç¨‹"],"content":"ä¸‰ã€Socketè¯»å†™ è¿æ¥å»ºç«‹èµ·æ¥åï¼Œæˆ‘ä»¬å°±è¦åœ¨connä¸Šè¿›è¡Œè¯»å†™ï¼Œä»¥å®Œæˆä¸šåŠ¡é€»è¾‘ã€‚å‰é¢è¯´è¿‡Go runtimeéšè—äº†I/Oå¤šè·¯å¤ç”¨çš„å¤æ‚æ€§ã€‚è¯­è¨€ä½¿ç”¨è€…åªéœ€é‡‡ç”¨goroutine+Block I/Oçš„æ¨¡å¼å³å¯æ»¡è¶³å¤§éƒ¨åˆ†åœºæ™¯éœ€æ±‚ã€‚DialæˆåŠŸåï¼Œæ–¹æ³•è¿”å›ä¸€ä¸ªnet.Connæ¥å£ç±»å‹å˜é‡å€¼ï¼Œè¿™ä¸ªæ¥å£å˜é‡çš„åŠ¨æ€ç±»å‹ä¸ºä¸€ä¸ª*TCPConnï¼š //$GOROOT/src/net/tcpsock_posix.go type TCPConn struct { conn } TCPConnå†…åµŒäº†ä¸€ä¸ªunexportedç±»å‹ï¼šconnï¼Œå› æ­¤TCPConnâ€ç»§æ‰¿â€äº†connçš„Readå’ŒWriteæ–¹æ³•ï¼Œåç»­é€šè¿‡Dialè¿”å›å€¼è°ƒç”¨çš„Writeå’ŒReadæ–¹æ³•å‡æ˜¯net.connçš„æ–¹æ³•ï¼š //$GOROOT/src/net/net.go type conn struct { fd *netFD } func (c *conn) ok() bool { return c != nil \u0026\u0026 c.fd != nil } // Implementation of the Conn interface. // Read implements the Conn Read method. func (c *conn) Read(b []byte) (int, error) { if !c.ok() { return 0, syscall.EINVAL } n, err := c.fd.Read(b) if err != nil \u0026\u0026 err != io.EOF { err = \u0026OpError{Op: \"read\", Net: c.fd.net, Source: c.fd.laddr, Addr: c.fd.raddr, Err: err} } return n, err } // Write implements the Conn Write method. func (c *conn) Write(b []byte) (int, error) { if !c.ok() { return 0, syscall.EINVAL } n, err := c.fd.Write(b) if err != nil { err = \u0026OpError{Op: \"write\", Net: c.fd.net, Source: c.fd.laddr, Addr: c.fd.raddr, Err: err} } return n, err } ä¸‹é¢æˆ‘ä»¬å…ˆæ¥é€šè¿‡å‡ ä¸ªåœºæ™¯æ¥æ€»ç»“ä¸€ä¸‹conn.Readçš„è¡Œä¸ºç‰¹ç‚¹ã€‚ ","date":"2017-07-31","objectID":"/posts/go-tcp/:3:0","tags":["go","tcp"],"title":"Go TCP Socket","uri":"/posts/go-tcp/"},{"categories":["ç½‘ç»œç¼–ç¨‹"],"content":"1ã€Socketä¸­æ— æ•°æ® è¿æ¥å»ºç«‹åï¼Œå¦‚æœå¯¹æ–¹æœªå‘é€æ•°æ®åˆ°socketï¼Œæ¥æ”¶æ–¹(Server)ä¼šé˜»å¡åœ¨Readæ“ä½œä¸Šï¼Œè¿™å’Œå‰é¢æåˆ°çš„â€œæ¨¡å‹â€åŸç†æ˜¯ä¸€è‡´çš„ã€‚æ‰§è¡Œè¯¥Readæ“ä½œçš„goroutineä¹Ÿä¼šè¢«æŒ‚èµ·ã€‚runtimeä¼šç›‘è§†è¯¥socketï¼Œç›´åˆ°å…¶æœ‰æ•°æ®æ‰ä¼šé‡æ–° è°ƒåº¦è¯¥socketå¯¹åº”çš„Goroutineå®Œæˆreadã€‚ç”±äºç¯‡å¹…åŸå› ï¼Œè¿™é‡Œå°±ä¸åˆ—ä»£ç äº†ï¼Œä¾‹å­å¯¹åº”çš„ä»£ç æ–‡ä»¶ï¼šgo-tcpsock/read_writeä¸‹çš„client1.goå’Œserver1.goã€‚ ","date":"2017-07-31","objectID":"/posts/go-tcp/:3:1","tags":["go","tcp"],"title":"Go TCP Socket","uri":"/posts/go-tcp/"},{"categories":["ç½‘ç»œç¼–ç¨‹"],"content":"2ã€Socketä¸­æœ‰éƒ¨åˆ†æ•°æ® å¦‚æœsocketä¸­æœ‰éƒ¨åˆ†æ•°æ®ï¼Œä¸”é•¿åº¦å°äºä¸€æ¬¡Readæ“ä½œæ‰€æœŸæœ›è¯»å‡ºçš„æ•°æ®é•¿åº¦ï¼Œé‚£ä¹ˆReadå°†ä¼šæˆåŠŸè¯»å‡ºè¿™éƒ¨åˆ†æ•°æ®å¹¶è¿”å›ï¼Œè€Œä¸æ˜¯ç­‰å¾…æ‰€æœ‰æœŸæœ›æ•°æ®å…¨éƒ¨è¯»å–åå†è¿”å›ã€‚ Clientç«¯ï¼š //go-tcpsock/read_write/client2.go ... ... func main() { if len(os.Args) \u003c= 1 { fmt.Println(\"usage: go run client2.go YOUR_CONTENT\") return } log.Println(\"begin dial...\") conn, err := net.Dial(\"tcp\", \":8888\") if err != nil { log.Println(\"dial error:\", err) return } defer conn.Close() log.Println(\"dial ok\") time.Sleep(time.Second * 2) data := os.Args[1] conn.Write([]byte(data)) time.Sleep(time.Second * 10000) } Serverç«¯ï¼š //go-tcpsock/read_write/server2.go ... ... func handleConn(c net.Conn) { defer c.Close() for { // read from the connection var buf = make([]byte, 10) log.Println(\"start to read from conn\") n, err := c.Read(buf) if err != nil { log.Println(\"conn read error:\", err) return } log.Printf(\"read %d bytes, content is %s\\n\", n, string(buf[:n])) } } ... ... æˆ‘ä»¬é€šè¿‡client2.goå‘é€â€hiâ€åˆ°Serverç«¯ï¼š è¿è¡Œç»“æœ: $go run client2.go hi 2015/11/17 13:30:53 begin dial... 2015/11/17 13:30:53 dial ok $go run server2.go 2015/11/17 13:33:45 accept a new connection 2015/11/17 13:33:45 start to read from conn 2015/11/17 13:33:47 read 2 bytes, content is hi ... Clientå‘socketä¸­å†™å…¥ä¸¤ä¸ªå­—èŠ‚æ•°æ®(â€œhiâ€)ï¼ŒServerç«¯åˆ›å»ºä¸€ä¸ªlen = 10çš„sliceï¼Œç­‰å¾…Readå°†è¯»å–çš„æ•°æ®æ”¾å…¥sliceï¼›Serveréšåè¯»å–åˆ°é‚£ä¸¤ä¸ªå­—èŠ‚ï¼šâ€hiâ€ã€‚ReadæˆåŠŸè¿”å›ï¼Œn =2 ï¼Œerr = nilã€‚ ","date":"2017-07-31","objectID":"/posts/go-tcp/:3:2","tags":["go","tcp"],"title":"Go TCP Socket","uri":"/posts/go-tcp/"},{"categories":["ç½‘ç»œç¼–ç¨‹"],"content":"3ã€Socketä¸­æœ‰è¶³å¤Ÿæ•°æ® å¦‚æœsocketä¸­æœ‰æ•°æ®ï¼Œä¸”é•¿åº¦å¤§äºç­‰äºä¸€æ¬¡Readæ“ä½œæ‰€æœŸæœ›è¯»å‡ºçš„æ•°æ®é•¿åº¦ï¼Œé‚£ä¹ˆReadå°†ä¼šæˆåŠŸè¯»å‡ºè¿™éƒ¨åˆ†æ•°æ®å¹¶è¿”å›ã€‚è¿™ä¸ªæƒ…æ™¯æ˜¯æœ€ç¬¦åˆæˆ‘ä»¬å¯¹Readçš„æœŸå¾…çš„äº†ï¼šReadå°†ç”¨Socketä¸­çš„æ•°æ®å°†æˆ‘ä»¬ä¼ å…¥çš„sliceå¡«æ»¡åè¿”å›ï¼šn = 10, err = nilã€‚ æˆ‘ä»¬é€šè¿‡client2.goå‘Server2å‘é€å¦‚ä¸‹å†…å®¹ï¼šabcdefghij12345ï¼Œæ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š $go run client2.go abcdefghij12345 2015/11/17 13:38:00 begin dial... 2015/11/17 13:38:00 dial ok $go run server2.go 2015/11/17 13:38:00 accept a new connection 2015/11/17 13:38:00 start to read from conn 2015/11/17 13:38:02 read 10 bytes, content is abcdefghij 2015/11/17 13:38:02 start to read from conn 2015/11/17 13:38:02 read 5 bytes, content is 12345 clientç«¯å‘é€çš„å†…å®¹é•¿åº¦ä¸º15ä¸ªå­—èŠ‚ï¼ŒServerç«¯Read bufferçš„é•¿åº¦ä¸º10ï¼Œå› æ­¤Server Readç¬¬ä¸€æ¬¡è¿”å›æ—¶åªä¼šè¯»å–10ä¸ªå­—èŠ‚ï¼›Socketä¸­è¿˜å‰©ä½™5ä¸ªå­—èŠ‚æ•°æ®ï¼ŒServerå†æ¬¡Readæ—¶ä¼šæŠŠå‰©ä½™æ•°æ®è¯»å‡ºï¼ˆå¦‚ï¼šæƒ…å½¢2ï¼‰ã€‚ ","date":"2017-07-31","objectID":"/posts/go-tcp/:3:3","tags":["go","tcp"],"title":"Go TCP Socket","uri":"/posts/go-tcp/"},{"categories":["ç½‘ç»œç¼–ç¨‹"],"content":"4ã€Socketå…³é—­ å¦‚æœclientç«¯ä¸»åŠ¨å…³é—­äº†socketï¼Œé‚£ä¹ˆServerçš„Readå°†ä¼šè¯»åˆ°ä»€ä¹ˆå‘¢ï¼Ÿè¿™é‡Œåˆ†ä¸ºâ€œæœ‰æ•°æ®å…³é—­â€å’Œâ€œæ— æ•°æ®å…³é—­â€ã€‚ â€œæœ‰æ•°æ®å…³é—­â€æ˜¯æŒ‡åœ¨clientå…³é—­æ—¶ï¼Œsocketä¸­è¿˜æœ‰serverç«¯æœªè¯»å–çš„æ•°æ®ï¼Œæˆ‘ä»¬åœ¨go-tcpsock/read_write/client3.goå’Œserver3.goä¸­æ¨¡æ‹Ÿè¿™ç§æƒ…å†µï¼š $go run client3.go hello 2015/11/17 13:50:57 begin dial... 2015/11/17 13:50:57 dial ok $go run server3.go 2015/11/17 13:50:57 accept a new connection 2015/11/17 13:51:07 start to read from conn 2015/11/17 13:51:07 read 5 bytes, content is hello 2015/11/17 13:51:17 start to read from conn 2015/11/17 13:51:17 conn read error: EOF ä»è¾“å‡ºç»“æœæ¥çœ‹ï¼Œå½“clientç«¯close socketé€€å‡ºåï¼Œserver3ä¾æ—§æ²¡æœ‰å¼€å§‹Readï¼Œ10såç¬¬ä¸€æ¬¡ReadæˆåŠŸè¯»å‡ºäº†5ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œå½“ç¬¬äºŒæ¬¡Readæ—¶ï¼Œç”±äºclientç«¯ socketå…³é—­ï¼ŒReadè¿”å›EOF errorã€‚ é€šè¿‡ä¸Šé¢è¿™ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çŒœæµ‹å‡ºâ€œæ— æ•°æ®å…³é—­â€æƒ…å½¢ä¸‹çš„ç»“æœï¼Œé‚£å°±æ˜¯Readç›´æ¥è¿”å›EOF errorã€‚ ","date":"2017-07-31","objectID":"/posts/go-tcp/:3:4","tags":["go","tcp"],"title":"Go TCP Socket","uri":"/posts/go-tcp/"},{"categories":["ç½‘ç»œç¼–ç¨‹"],"content":"5ã€è¯»å–æ“ä½œè¶…æ—¶ æœ‰äº›åœºåˆå¯¹Readçš„é˜»å¡æ—¶é—´æœ‰ä¸¥æ ¼é™åˆ¶ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒReadçš„è¡Œä¸ºåˆ°åº•æ˜¯ä»€ä¹ˆæ ·çš„å‘¢ï¼Ÿåœ¨è¿”å›è¶…æ—¶é”™è¯¯æ—¶ï¼Œæ˜¯å¦ä¹ŸåŒæ—¶Readäº†ä¸€éƒ¨åˆ†æ•°æ®äº†å‘¢ï¼Ÿè¿™ä¸ªå®éªŒæ¯”è¾ƒéš¾äºæ¨¡æ‹Ÿï¼Œä¸‹é¢çš„æµ‹è¯•ç»“æœä¹Ÿæœªå¿…èƒ½åæ˜ å‡ºæ‰€æœ‰å¯èƒ½ç»“æœã€‚æˆ‘ä»¬ç¼–å†™äº†client4.goå’Œserver4.goæ¥æ¨¡æ‹Ÿè¿™ä¸€æƒ…å½¢ã€‚ //go-tcpsock/read_write/client4.go ... ... func main() { log.Println(\"begin dial...\") conn, err := net.Dial(\"tcp\", \":8888\") if err != nil { log.Println(\"dial error:\", err) return } defer conn.Close() log.Println(\"dial ok\") data := make([]byte, 65536) conn.Write(data) time.Sleep(time.Second * 10000) } //go-tcpsock/read_write/server4.go ... ... func handleConn(c net.Conn) { defer c.Close() for { // read from the connection time.Sleep(10 * time.Second) var buf = make([]byte, 65536) log.Println(\"start to read from conn\") c.SetReadDeadline(time.Now().Add(time.Microsecond * 10)) n, err := c.Read(buf) if err != nil { log.Printf(\"conn read %d bytes, error: %s\", n, err) if nerr, ok := err.(net.Error); ok \u0026\u0026 nerr.Timeout() { continue } return } log.Printf(\"read %d bytes, content is %s\\n\", n, string(buf[:n])) } } åœ¨Serverç«¯æˆ‘ä»¬é€šè¿‡Connçš„SetReadDeadlineæ–¹æ³•è®¾ç½®äº†10å¾®ç§’çš„è¯»è¶…æ—¶æ—¶é—´ï¼ŒServerçš„æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š $go run server4.go 2015/11/17 14:21:17 accept a new connection 2015/11/17 14:21:27 start to read from conn 2015/11/17 14:21:27 conn read 0 bytes, error: read tcp 127.0.0.1:8888-\u003e127.0.0.1:60970: i/o timeout 2015/11/17 14:21:37 start to read from conn 2015/11/17 14:21:37 read 65536 bytes, content is è™½ç„¶æ¯æ¬¡éƒ½æ˜¯10å¾®ç§’è¶…æ—¶ï¼Œä½†ç»“æœä¸åŒï¼Œç¬¬ä¸€æ¬¡Readè¶…æ—¶ï¼Œè¯»å‡ºæ•°æ®é•¿åº¦ä¸º0ï¼›ç¬¬äºŒæ¬¡è¯»å–æ‰€æœ‰æ•°æ®æˆåŠŸï¼Œæ²¡æœ‰è¶…æ—¶ã€‚åå¤æ‰§è¡Œäº†å¤šæ¬¡ï¼Œæ²¡èƒ½å‡ºç°â€œè¯»å‡ºéƒ¨åˆ†æ•°æ®ä¸”è¿”å›è¶…æ—¶é”™è¯¯â€çš„æƒ…å†µã€‚ å’Œè¯»ç›¸æ¯”ï¼ŒWriteé‡åˆ°çš„æƒ…å½¢ä¸€æ ·ä¸å°‘ï¼Œæˆ‘ä»¬ä¹Ÿé€ä¸€çœ‹ä¸€ä¸‹ã€‚ ","date":"2017-07-31","objectID":"/posts/go-tcp/:3:5","tags":["go","tcp"],"title":"Go TCP Socket","uri":"/posts/go-tcp/"},{"categories":["ç½‘ç»œç¼–ç¨‹"],"content":"1ã€æˆåŠŸå†™ å‰é¢ä¾‹å­ç€é‡äºReadï¼Œclientç«¯åœ¨Writeæ—¶å¹¶æœªåˆ¤æ–­Writeçš„è¿”å›å€¼ã€‚æ‰€è°“â€œæˆåŠŸå†™â€æŒ‡çš„å°±æ˜¯Writeè°ƒç”¨è¿”å›çš„nä¸é¢„æœŸè¦å†™å…¥çš„æ•°æ®é•¿åº¦ç›¸ç­‰ï¼Œä¸”error = nilã€‚è¿™æ˜¯æˆ‘ä»¬åœ¨è°ƒç”¨Writeæ—¶é‡åˆ°çš„æœ€å¸¸è§çš„æƒ…å½¢ï¼Œè¿™é‡Œä¸å†ä¸¾ä¾‹äº†ã€‚ ","date":"2017-07-31","objectID":"/posts/go-tcp/:3:6","tags":["go","tcp"],"title":"Go TCP Socket","uri":"/posts/go-tcp/"},{"categories":["ç½‘ç»œç¼–ç¨‹"],"content":"2ã€å†™é˜»å¡ TCPè¿æ¥é€šä¿¡ä¸¤ç«¯çš„OSéƒ½ä¼šä¸ºè¯¥è¿æ¥ä¿ç•™æ•°æ®ç¼“å†²ï¼Œä¸€ç«¯è°ƒç”¨Writeåï¼Œå®é™…ä¸Šæ•°æ®æ˜¯å†™å…¥åˆ°OSçš„åè®®æ ˆçš„æ•°æ®ç¼“å†²çš„ã€‚TCPæ˜¯å…¨åŒå·¥é€šä¿¡ï¼Œå› æ­¤æ¯ä¸ªæ–¹å‘éƒ½æœ‰ç‹¬ç«‹çš„æ•°æ®ç¼“å†²ã€‚å½“å‘é€æ–¹å°†å¯¹æ–¹çš„æ¥æ”¶ç¼“å†²åŒºä»¥åŠè‡ªèº«çš„å‘é€ç¼“å†²åŒºå†™æ»¡åï¼ŒWriteå°±ä¼šé˜»å¡ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼šclient5.goå’Œserver.goã€‚ //go-tcpsock/read_write/client5.go ... ... func main() { log.Println(\"begin dial...\") conn, err := net.Dial(\"tcp\", \":8888\") if err != nil { log.Println(\"dial error:\", err) return } defer conn.Close() log.Println(\"dial ok\") data := make([]byte, 65536) var total int for { n, err := conn.Write(data) if err != nil { total += n log.Printf(\"write %d bytes, error:%s\\n\", n, err) break } total += n log.Printf(\"write %d bytes this time, %d bytes in total\\n\", n, total) } log.Printf(\"write %d bytes in total\\n\", total) time.Sleep(time.Second * 10000) } //go-tcpsock/read_write/server5.go ... ... func handleConn(c net.Conn) { defer c.Close() time.Sleep(time.Second * 10) for { // read from the connection time.Sleep(5 * time.Second) var buf = make([]byte, 60000) log.Println(\"start to read from conn\") n, err := c.Read(buf) if err != nil { log.Printf(\"conn read %d bytes, error: %s\", n, err) if nerr, ok := err.(net.Error); ok \u0026\u0026 nerr.Timeout() { continue } } log.Printf(\"read %d bytes, content is %s\\n\", n, string(buf[:n])) } } ... ... Server5åœ¨å‰10sä¸­å¹¶ä¸Readæ•°æ®ï¼Œå› æ­¤å½“client5ä¸€ç›´å°è¯•å†™å…¥æ—¶ï¼Œå†™åˆ°ä¸€å®šé‡åå°±ä¼šå‘ç”Ÿé˜»å¡ï¼š $go run client5.go 2015/11/17 14:57:33 begin dial... 2015/11/17 14:57:33 dial ok 2015/11/17 14:57:33 write 65536 bytes this time, 65536 bytes in total 2015/11/17 14:57:33 write 65536 bytes this time, 131072 bytes in total 2015/11/17 14:57:33 write 65536 bytes this time, 196608 bytes in total 2015/11/17 14:57:33 write 65536 bytes this time, 262144 bytes in total 2015/11/17 14:57:33 write 65536 bytes this time, 327680 bytes in total 2015/11/17 14:57:33 write 65536 bytes this time, 393216 bytes in total 2015/11/17 14:57:33 write 65536 bytes this time, 458752 bytes in total 2015/11/17 14:57:33 write 65536 bytes this time, 524288 bytes in total 2015/11/17 14:57:33 write 65536 bytes this time, 589824 bytes in total 2015/11/17 14:57:33 write 65536 bytes this time, 655360 bytes in total åœ¨Darwinä¸Šï¼Œè¿™ä¸ªsizeå¤§çº¦åœ¨679468bytesã€‚åç»­å½“server5æ¯éš”5sè¿›è¡ŒReadæ—¶ï¼ŒOS socketç¼“å†²åŒºè…¾å‡ºäº†ç©ºé—´ï¼Œclient5å°±åˆå¯ä»¥å†™å…¥äº†ï¼š $go run server5.go 2015/11/17 15:07:01 accept a new connection 2015/11/17 15:07:16 start to read from conn 2015/11/17 15:07:16 read 60000 bytes, content is 2015/11/17 15:07:21 start to read from conn 2015/11/17 15:07:21 read 60000 bytes, content is 2015/11/17 15:07:26 start to read from conn 2015/11/17 15:07:26 read 60000 bytes, content is .... clientç«¯ï¼š 2015/11/17 15:07:01 write 65536 bytes this time, 720896 bytes in total 2015/11/17 15:07:06 write 65536 bytes this time, 786432 bytes in total 2015/11/17 15:07:16 write 65536 bytes this time, 851968 bytes in total 2015/11/17 15:07:16 write 65536 bytes this time, 917504 bytes in total 2015/11/17 15:07:27 write 65536 bytes this time, 983040 bytes in total 2015/11/17 15:07:27 write 65536 bytes this time, 1048576 bytes in total .... ... ","date":"2017-07-31","objectID":"/posts/go-tcp/:3:7","tags":["go","tcp"],"title":"Go TCP Socket","uri":"/posts/go-tcp/"},{"categories":["ç½‘ç»œç¼–ç¨‹"],"content":"3ã€å†™å…¥éƒ¨åˆ†æ•°æ® Writeæ“ä½œå­˜åœ¨å†™å…¥éƒ¨åˆ†æ•°æ®çš„æƒ…å†µï¼Œæ¯”å¦‚ä¸Šé¢ä¾‹å­ä¸­ï¼Œå½“clientç«¯è¾“å‡ºæ—¥å¿—åœç•™åœ¨â€œwrite 65536 bytes this time, 655360 bytes in totalâ€æ—¶ï¼Œæˆ‘ä»¬æ€æ‰server5ï¼Œè¿™æ—¶æˆ‘ä»¬ä¼šçœ‹åˆ°client5è¾“å‡ºä»¥ä¸‹æ—¥å¿—ï¼š ... 2015/11/17 15:19:14 write 65536 bytes this time, 655360 bytes in total 2015/11/17 15:19:16 write 24108 bytes, error:write tcp 127.0.0.1:62245-\u003e127.0.0.1:8888: write: broken pipe 2015/11/17 15:19:16 write 679468 bytes in total æ˜¾ç„¶Writeå¹¶éåœ¨655360è¿™ä¸ªåœ°æ–¹é˜»å¡çš„ï¼Œè€Œæ˜¯åç»­åˆå†™å…¥24108åå‘ç”Ÿäº†é˜»å¡ï¼Œserverç«¯socketå…³é—­åï¼Œæˆ‘ä»¬çœ‹åˆ°Wroteè¿”å›er != nilä¸”n = 24108ï¼Œç¨‹åºéœ€è¦å¯¹è¿™éƒ¨åˆ†å†™å…¥çš„24108å­—èŠ‚åšç‰¹å®šå¤„ç†ã€‚ ","date":"2017-07-31","objectID":"/posts/go-tcp/:3:8","tags":["go","tcp"],"title":"Go TCP Socket","uri":"/posts/go-tcp/"},{"categories":["ç½‘ç»œç¼–ç¨‹"],"content":"4ã€å†™å…¥è¶…æ—¶ å¦‚æœéè¦ç»™Writeå¢åŠ ä¸€ä¸ªæœŸé™ï¼Œé‚£æˆ‘ä»¬å¯ä»¥è°ƒç”¨SetWriteDeadlineæ–¹æ³•ã€‚æˆ‘ä»¬copyä¸€ä»½client5.goï¼Œå½¢æˆclient6.goï¼Œåœ¨client6.goçš„Writeä¹‹å‰å¢åŠ ä¸€è¡Œtimeoutè®¾ç½®ä»£ç ï¼š conn.SetWriteDeadline(time.Now().Add(time.Microsecond * 10)) å¯åŠ¨server6.goï¼Œå¯åŠ¨client6.goï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å†™å…¥è¶…æ—¶çš„æƒ…å†µä¸‹ï¼ŒWriteçš„è¿”å›ç»“æœï¼š $go run client6.go 2015/11/17 15:26:34 begin dial... 2015/11/17 15:26:34 dial ok 2015/11/17 15:26:34 write 65536 bytes this time, 65536 bytes in total ... ... 2015/11/17 15:26:34 write 65536 bytes this time, 655360 bytes in total 2015/11/17 15:26:34 write 24108 bytes, error:write tcp 127.0.0.1:62325-\u003e127.0.0.1:8888: i/o timeout 2015/11/17 15:26:34 write 679468 bytes in total å¯ä»¥çœ‹åˆ°åœ¨å†™å…¥è¶…æ—¶æ—¶ï¼Œä¾æ—§å­˜åœ¨éƒ¨åˆ†æ•°æ®å†™å…¥çš„æƒ…å†µã€‚ ç»¼ä¸Šä¾‹å­ï¼Œè™½ç„¶Goç»™æˆ‘ä»¬æä¾›äº†é˜»å¡I/Oçš„ä¾¿åˆ©ï¼Œä½†åœ¨è°ƒç”¨Readå’ŒWriteæ—¶ä¾æ—§è¦ç»¼åˆéœ€è¦æ–¹æ³•è¿”å›çš„nå’Œerrçš„ç»“æœï¼Œä»¥åšå‡ºæ­£ç¡®å¤„ç†ã€‚net.connå®ç°äº†io.Readerå’Œio.Writeræ¥å£ï¼Œå› æ­¤å¯ä»¥è¯•ç”¨ä¸€äº›wrapperåŒ…è¿›è¡Œsocketè¯»å†™ï¼Œæ¯”å¦‚bufioåŒ…ä¸‹é¢çš„Writerå’ŒReaderã€io/ioutilä¸‹çš„å‡½æ•°ç­‰ã€‚ ","date":"2017-07-31","objectID":"/posts/go-tcp/:3:9","tags":["go","tcp"],"title":"Go TCP Socket","uri":"/posts/go-tcp/"},{"categories":["ç½‘ç»œç¼–ç¨‹"],"content":"Goroutine safe åŸºäºgoroutineçš„ç½‘ç»œæ¶æ„æ¨¡å‹ï¼Œå­˜åœ¨åœ¨ä¸åŒgoroutineé—´å…±äº«connçš„æƒ…å†µï¼Œé‚£ä¹ˆconnçš„è¯»å†™æ˜¯å¦æ˜¯goroutine safeçš„å‘¢ï¼Ÿåœ¨æ·±å…¥è¿™ä¸ªé—®é¢˜ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆä»åº”ç”¨æ„ä¹‰ä¸Šæ¥çœ‹readæ“ä½œå’Œwriteæ“ä½œçš„goroutine-safeå¿…è¦æ€§ã€‚ å¯¹äºreadæ“ä½œè€Œè¨€ï¼Œç”±äºTCPæ˜¯é¢å‘å­—èŠ‚æµï¼Œconn.Readæ— æ³•æ­£ç¡®åŒºåˆ†æ•°æ®çš„ä¸šåŠ¡è¾¹ç•Œï¼Œå› æ­¤å¤šä¸ªgoroutineå¯¹åŒä¸€ä¸ªconnè¿›è¡Œreadçš„æ„ä¹‰ä¸å¤§ï¼Œgoroutineè¯»åˆ°ä¸å®Œæ•´çš„ä¸šåŠ¡åŒ…åå€’æ˜¯å¢åŠ äº†ä¸šåŠ¡å¤„ç†çš„éš¾åº¦ã€‚å¯¹ä¸Writeæ“ä½œè€Œè¨€ï¼Œå€’æ˜¯æœ‰å¤šä¸ªgoroutineå¹¶å‘å†™çš„æƒ…å†µã€‚ä¸è¿‡connè¯»å†™æ˜¯å¦goroutine-safeçš„æµ‹è¯•ä¸æ˜¯å¾ˆå¥½åšï¼Œæˆ‘ä»¬å…ˆæ·±å…¥ä¸€ä¸‹runtimeä»£ç ï¼Œå…ˆä»ç†è®ºä¸Šç»™è¿™ä¸ªé—®é¢˜å®šä¸ªæ€§ï¼š net.connåªæ˜¯*netFDçš„wrapperç»“æ„ï¼Œæœ€ç»ˆWriteå’ŒReadéƒ½ä¼šè½åœ¨å…¶ä¸­çš„fdä¸Šï¼š type conn struct { fd *netFD } netFDåœ¨ä¸åŒå¹³å°ä¸Šæœ‰ç€ä¸åŒçš„å®ç°ï¼Œæˆ‘ä»¬ä»¥net/fd_unix.goä¸­çš„netFDä¸ºä¾‹ï¼š // Network file descriptor. type netFD struct { // locking/lifetime of sysfd + serialize access to Read and Write methods fdmu fdMutex // immutable until Close sysfd int family int sotype int isConnected bool net string laddr Addr raddr Addr // wait server pd pollDesc } æˆ‘ä»¬çœ‹åˆ°netFDä¸­åŒ…å«äº†ä¸€ä¸ªruntimeå®ç°çš„fdMutexç±»å‹å­—æ®µï¼Œä»æ³¨é‡Šä¸Šæ¥çœ‹ï¼Œè¯¥fdMutexç”¨æ¥ä¸²è¡ŒåŒ–å¯¹è¯¥netFDå¯¹åº”çš„sysfdçš„Writeå’ŒReadæ“ä½œã€‚ä»è¿™ä¸ªæ³¨é‡Šä¸Šæ¥çœ‹ï¼Œæ‰€æœ‰å¯¹connçš„Readå’ŒWriteæ“ä½œéƒ½æ˜¯æœ‰fdMutexäº’æ–¥çš„ï¼Œä»netFDçš„Readå’ŒWriteæ–¹æ³•çš„å®ç°ä¹Ÿè¯å®äº†è¿™ä¸€ç‚¹ï¼š func (fd *netFD) Read(p []byte) (n int, err error) { if err := fd.readLock(); err != nil { return 0, err } defer fd.readUnlock() if err := fd.pd.PrepareRead(); err != nil { return 0, err } for { n, err = syscall.Read(fd.sysfd, p) if err != nil { n = 0 if err == syscall.EAGAIN { if err = fd.pd.WaitRead(); err == nil { continue } } } err = fd.eofError(n, err) break } if _, ok := err.(syscall.Errno); ok { err = os.NewSyscallError(\"read\", err) } return } func (fd *netFD) Write(p []byte) (nn int, err error) { if err := fd.writeLock(); err != nil { return 0, err } defer fd.writeUnlock() if err := fd.pd.PrepareWrite(); err != nil { return 0, err } for { var n int n, err = syscall.Write(fd.sysfd, p[nn:]) if n \u003e 0 { nn += n } if nn == len(p) { break } if err == syscall.EAGAIN { if err = fd.pd.WaitWrite(); err == nil { continue } } if err != nil { break } if n == 0 { err = io.ErrUnexpectedEOF break } } if _, ok := err.(syscall.Errno); ok { err = os.NewSyscallError(\"write\", err) } return nn, err } æ¯æ¬¡Writeæ“ä½œéƒ½æ˜¯å—lockä¿æŠ¤ï¼Œç›´åˆ°æ­¤æ¬¡æ•°æ®å…¨éƒ¨writeå®Œã€‚å› æ­¤åœ¨åº”ç”¨å±‚é¢ï¼Œè¦æƒ³ä¿è¯å¤šä¸ªgoroutineåœ¨ä¸€ä¸ªconnä¸Šwriteæ“ä½œçš„Safeï¼Œéœ€è¦ä¸€æ¬¡writeå®Œæ•´å†™å…¥ä¸€ä¸ªâ€œä¸šåŠ¡åŒ…â€ï¼›ä¸€æ—¦å°†ä¸šåŠ¡åŒ…çš„å†™å…¥æ‹†åˆ†ä¸ºå¤šæ¬¡writeï¼Œé‚£å°±æ— æ³•ä¿è¯æŸä¸ªGoroutineçš„æŸâ€œä¸šåŠ¡åŒ…â€æ•°æ®åœ¨connå‘é€çš„è¿ç»­æ€§ã€‚ åŒæ—¶ä¹Ÿå¯ä»¥çœ‹å‡ºå³ä¾¿æ˜¯Readæ“ä½œï¼Œä¹Ÿæ˜¯lockä¿æŠ¤çš„ã€‚å¤šä¸ªGoroutineå¯¹åŒä¸€connçš„å¹¶å‘è¯»ä¸ä¼šå‡ºç°è¯»å‡ºå†…å®¹é‡å çš„æƒ…å†µï¼Œä½†å†…å®¹æ–­ç‚¹æ˜¯ä¾ runtimeè°ƒåº¦æ¥éšæœºç¡®å®šçš„ã€‚å­˜åœ¨ä¸€ä¸ªä¸šåŠ¡åŒ…æ•°æ®ï¼Œ1/3å†…å®¹è¢«goroutine-1è¯»èµ°ï¼Œå¦å¤–2/3è¢«å¦å¤–ä¸€ä¸ªgoroutine-2è¯» èµ°çš„æƒ…å†µã€‚æ¯”å¦‚ä¸€ä¸ªå®Œæ•´åŒ…ï¼šworldï¼Œå½“goroutineçš„read slice size \u003c 5æ—¶ï¼Œå­˜åœ¨å¯èƒ½ï¼šä¸€ä¸ªgoroutineè¯»åˆ° â€œworlâ€,å¦å¤–ä¸€ä¸ªgoroutineè¯»å‡ºâ€dâ€ã€‚ ","date":"2017-07-31","objectID":"/posts/go-tcp/:3:10","tags":["go","tcp"],"title":"Go TCP Socket","uri":"/posts/go-tcp/"},{"categories":["ç½‘ç»œç¼–ç¨‹"],"content":"å››ã€Socketå±æ€§ åŸç”ŸSocket APIæä¾›äº†ä¸°å¯Œçš„sockoptè®¾ç½®æ¥å£ï¼Œä½†Golangæœ‰è‡ªå·±çš„ç½‘ç»œæ¶æ„æ¨¡å‹ï¼Œgolangæä¾›çš„socket optionsæ¥å£ä¹Ÿæ˜¯åŸºäºä¸Šè¿°æ¨¡å‹çš„å¿…è¦çš„å±æ€§è®¾ç½®ã€‚åŒ…æ‹¬ SetKeepAlive SetKeepAlivePeriod SetLinger SetNoDelay ï¼ˆé»˜è®¤no delayï¼‰ SetWriteBuffer SetReadBuffer ä¸è¿‡ä¸Šé¢çš„Methodæ˜¯TCPConnçš„ï¼Œè€Œä¸æ˜¯Connçš„ï¼Œè¦ä½¿ç”¨ä¸Šé¢çš„Methodçš„ï¼Œéœ€è¦type assertionï¼š tcpConn, ok := c.(*TCPConn) if !ok { //error handle } tcpConn.SetNoDelay(true) å¯¹äºlistener socket, golangé»˜è®¤é‡‡ç”¨äº† SO_REUSEADDRï¼Œè¿™æ ·å½“ä½ é‡å¯ listenerç¨‹åºæ—¶ï¼Œä¸ä¼šå› ä¸ºaddress in useçš„é”™è¯¯è€Œå¯åŠ¨å¤±è´¥ã€‚è€Œlisten backlogçš„é»˜è®¤å€¼æ˜¯é€šè¿‡è·å–ç³»ç»Ÿçš„è®¾ç½®å€¼å¾—åˆ°çš„ã€‚ä¸åŒç³»ç»Ÿä¸åŒï¼šmac 128, linux 512ç­‰ã€‚ ","date":"2017-07-31","objectID":"/posts/go-tcp/:4:0","tags":["go","tcp"],"title":"Go TCP Socket","uri":"/posts/go-tcp/"},{"categories":["ç½‘ç»œç¼–ç¨‹"],"content":"äº”ã€å…³é—­è¿æ¥ å’Œå‰é¢çš„æ–¹æ³•ç›¸æ¯”ï¼Œå…³é—­è¿æ¥ç®—æ˜¯æœ€ç®€å•çš„æ“ä½œäº†ã€‚ç”±äºsocketæ˜¯å…¨åŒå·¥çš„ï¼Œclientå’Œserverç«¯åœ¨å·±æ–¹å·²å…³é—­çš„socketå’Œå¯¹æ–¹å…³é—­çš„socketä¸Šæ“ä½œçš„ç»“æœæœ‰ä¸åŒã€‚çœ‹ä¸‹é¢ä¾‹å­ï¼š //go-tcpsock/conn_close/client1.go ... ... func main() { log.Println(\"begin dial...\") conn, err := net.Dial(\"tcp\", \":8888\") if err != nil { log.Println(\"dial error:\", err) return } conn.Close() log.Println(\"close ok\") var buf = make([]byte, 32) n, err := conn.Read(buf) if err != nil { log.Println(\"read error:\", err) } else { log.Printf(\"read % bytes, content is %s\\n\", n, string(buf[:n])) } n, err = conn.Write(buf) if err != nil { log.Println(\"write error:\", err) } else { log.Printf(\"write % bytes, content is %s\\n\", n, string(buf[:n])) } time.Sleep(time.Second * 1000) } //go-tcpsock/conn_close/server1.go ... ... func handleConn(c net.Conn) { defer c.Close() // read from the connection var buf = make([]byte, 10) log.Println(\"start to read from conn\") n, err := c.Read(buf) if err != nil { log.Println(\"conn read error:\", err) } else { log.Printf(\"read %d bytes, content is %s\\n\", n, string(buf[:n])) } n, err = c.Write(buf) if err != nil { log.Println(\"conn write error:\", err) } else { log.Printf(\"write %d bytes, content is %s\\n\", n, string(buf[:n])) } } ... ... ä¸Šè¿°ä¾‹å­çš„æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š $go run server1.go 2015/11/17 17:00:51 accept a new connection 2015/11/17 17:00:51 start to read from conn 2015/11/17 17:00:51 conn read error: EOF 2015/11/17 17:00:51 write 10 bytes, content is $go run client1.go 2015/11/17 17:00:51 begin dial... 2015/11/17 17:00:51 close ok 2015/11/17 17:00:51 read error: read tcp 127.0.0.1:64195-\u003e127.0.0.1:8888: use of closed network connection 2015/11/17 17:00:51 write error: write tcp 127.0.0.1:64195-\u003e127.0.0.1:8888: use of closed network connection ä»client1çš„ç»“æœæ¥çœ‹ï¼Œåœ¨å·±æ–¹å·²ç»å…³é—­çš„socketä¸Šå†è¿›è¡Œreadå’Œwriteæ“ä½œï¼Œä¼šå¾—åˆ°â€use of closed network connectionâ€ errorï¼› ä»server1çš„æ‰§è¡Œç»“æœæ¥çœ‹ï¼Œåœ¨å¯¹æ–¹å…³é—­çš„socketä¸Šæ‰§è¡Œreadæ“ä½œä¼šå¾—åˆ°EOF errorï¼Œä½†writeæ“ä½œä¼šæˆåŠŸï¼Œå› ä¸ºæ•°æ®ä¼šæˆåŠŸå†™å…¥å·±æ–¹çš„å†…æ ¸socketç¼“å†²åŒºä¸­ï¼Œå³ä¾¿æœ€ç»ˆå‘ä¸åˆ°å¯¹æ–¹socketç¼“å†²åŒºäº†ï¼Œå› ä¸ºå·±æ–¹socketå¹¶æœªå…³é—­ã€‚å› æ­¤å½“å‘ç°å¯¹æ–¹socketå…³é—­åï¼Œå·±æ–¹åº”è¯¥æ­£ç¡®åˆç†å¤„ç†è‡ªå·±çš„socketï¼Œå†ç»§ç»­writeå·²ç»æ— ä»»ä½•æ„ä¹‰äº†ã€‚ ","date":"2017-07-31","objectID":"/posts/go-tcp/:5:0","tags":["go","tcp"],"title":"Go TCP Socket","uri":"/posts/go-tcp/"},{"categories":["ç½‘ç»œç¼–ç¨‹"],"content":"å…­ã€å°ç»“ æœ¬æ–‡æ¯”è¾ƒåŸºç¡€ï¼Œä½†å´å¾ˆé‡è¦ï¼Œæ¯•ç«Ÿgolangæ˜¯é¢å‘å¤§è§„æ¨¡æœåŠ¡åç«¯çš„ï¼Œå¯¹é€šä¿¡ç¯èŠ‚çš„ç»†èŠ‚çš„æ·±å…¥ç†è§£ä¼šå¤§æœ‰è£¨ç›Šã€‚å¦å¤–Goçš„goroutine+é˜»å¡é€šä¿¡çš„ç½‘ç»œé€šä¿¡æ¨¡å‹é™ä½äº†å¼€å‘è€…å¿ƒæ™ºè´Ÿæ‹…ï¼Œç®€åŒ–äº†é€šä¿¡çš„å¤æ‚æ€§ï¼Œè¿™ç‚¹å°¤ä¸ºé‡è¦ã€‚ æœ¬æ–‡ä»£ç å®éªŒç¯å¢ƒï¼šgo 1.5.1 on Darwin amd64ä»¥åŠéƒ¨åˆ†åœ¨ubuntu 14.04 amd64ã€‚ æœ¬æ–‡demoä»£ç åœ¨è¿™é‡Œå¯ä»¥æ‰¾åˆ°ã€‚ Â© 2015, bigwhite. ç‰ˆæƒæ‰€æœ‰. ","date":"2017-07-31","objectID":"/posts/go-tcp/:6:0","tags":["go","tcp"],"title":"Go TCP Socket","uri":"/posts/go-tcp/"},{"categories":["Docker"],"content":"å…³äº å®¹å™¨ã€Docker çš„åŸºç¡€çŸ¥è¯†ã€åŸºç¡€æ“ä½œå’Œå¸¸ç”¨çš„å‘½ä»¤ã€‚ Docker åŸºç¡€çŸ¥è¯†å’Œä½¿ç”¨ ","date":"2017-07-17","objectID":"/posts/docker/:0:0","tags":["go","docker"],"title":"Docker åŸºç¡€çŸ¥è¯†å’ŒåŸºæœ¬æ“ä½œ","uri":"/posts/docker/"},{"categories":["Docker"],"content":"å…³äºDocker ","date":"2017-07-17","objectID":"/posts/docker/:1:0","tags":["go","docker"],"title":"Docker åŸºç¡€çŸ¥è¯†å’ŒåŸºæœ¬æ“ä½œ","uri":"/posts/docker/"},{"categories":["Docker"],"content":"å®¹å™¨æŠ€æœ¯ å¯¹äºå®¹å™¨ï¼Œç›®å‰å¹¶æ²¡æœ‰ä¸€ä¸ªä¸¥æ ¼çš„å®šä¹‰ï¼Œä½†æ˜¯æ™®éè¢«è®¤å¯çš„è¯´æ³•æ˜¯ï¼Œå®ƒé¦–å…ˆå¿…é¡»æ˜¯ä¸€ä¸ªç›¸å¯¹ç‹¬ç«‹çš„ç¯å¢ƒï¼Œåœ¨è¿™ä¸€ç‚¹ä¸Šæœ‰ç‚¹ç±»ä¼¼è™šæ‹Ÿæœºï¼Œä½†æ˜¯æ²¡æœ‰è™šæ‹Ÿæœºé‚£ä¹ˆå½»åº•ã€‚å¦å¤–ï¼Œåœ¨ä¸€ä¸ªå®¹å™¨ç¯å¢ƒä¸­ï¼Œåº”è¯¥æœ€å°åŒ–å…¶å¯¹å¤–ç•Œçš„å½±å“ï¼Œæ¯”å¦‚ä¸èƒ½åœ¨å®¹å™¨ä¸­å§hostä¸Šçš„èµ„æºè€—å°½ï¼Œè¿™å°±æ˜¯èµ„æºçš„æ§åˆ¶ã€‚ å®¹å™¨æŠ€æœ¯ä¹‹æ‰€ä»¥å—æ¬¢è¿ï¼Œä¸€ä¸ªé‡è¦çš„åŸå› æ˜¯å®ƒå·²ç»é›†æˆåˆ°äº† Linux å†…æ ¸ä¸­ï¼Œå·²ç»è¢«å½“ä½œ Linux å†…æ ¸åŸç”Ÿæä¾›çš„ç‰¹å¾ã€‚å½“ç„¶å…¶ä»–å¹³å°ä¹Ÿæœ‰ç›¸åº”çš„å®¹å™¨æŠ€æœ¯ï¼Œä½†æ˜¯æˆ‘ä»¬è®¨è®ºçš„ä»¥åŠDockeræ¶‰åŠçš„éƒ½æ˜¯æŒ‡ Linux å¹³å°ä¸Šçš„å®¹å™¨æŠ€æœ¯ã€‚ ä¸€èˆ¬æ¥è¯´ï¼Œå®¹å™¨æŠ€æœ¯ä¸»è¦åŒ…æ‹¬Namespaceå’ŒCgroupä¸¤ä¸ªå†…æ ¸ç‰¹å¾ã€‚ Namespace å‘½åç©ºé—´ï¼Œå®ƒä¸»è¦åšçš„æ˜¯è®¿é—®éš”ç¦»ã€‚å…¶åŸç†æ˜¯å¯¹ä¸€ç±»èµ„æºè¿›è¡ŒæŠ½è±¡ï¼Œå¹¶å°†å…¶å°è£…åœ¨ä¸€èµ·æä¾›ç»™å®¹å™¨ä½¿ç”¨ï¼Œå¯¹äºè¿™ç±»èµ„æºï¼Œå› ä¸ºæ¯ä¸ªå®¹å™¨éƒ½æœ‰è‡ªå·±çš„æŠ½è±¡ï¼Œè€Œä»–ä»¬å½¼æ­¤ä¹‹é—´æ˜¯ä¸å¯è§çš„ï¼Œæ‰€ä»¥å°±åšåˆ°è®¿é—®éš”ç¦»ã€‚ Cgroupæ˜¯ control group çš„ç®€ç§°ï¼Œåˆç§°ä¸ºæ§åˆ¶ç»„ï¼Œå®ƒä¸»è¦æ˜¯æ§åˆ¶èµ„æºæ§åˆ¶ã€‚å…¶åŸç†æ˜¯å°†ä¸€ç»„è¿›ç¨‹æ”¾åœ¨ä¸€ä¸ªæ§åˆ¶ç»„é‡Œï¼Œé€šè¿‡ç»™è¿™ä¸ªæ§åˆ¶ç»„åˆ†é…æŒ‡å®šçš„å¯ç”¨èµ„æºï¼Œè¾¾åˆ°æ§åˆ¶è¿™ä¸€ç»„è¿›ç¨‹å¯ç”¨èµ„æºçš„ç›®çš„ã€‚ å®¹å™¨æœ€æ ¸å¿ƒæŠ€æœ¯æ˜¯ Namespace+Cgroupï¼Œä½†æ˜¯å…‰æœ‰è¿™ä¸¤ä¸ªæŠ½è±¡çš„æŠ€æœ¯æ¦‚å¿µæ˜¯æ— æ³•ç»„æˆä¸€ä¸ªå®Œæ•´çš„å®¹å™¨çš„ã€‚ å¯¹äº linux å®¹å™¨çš„æœ€å°ç»„æˆï¼Œæ˜¯ç”±ä¸€ä¸‹å››ä¸ªéƒ¨åˆ†æ„æˆï¼š Cgroupï¼š èµ„æºæ§åˆ¶ã€‚ Namespaceï¼š è®¿é—®éš”ç¦»ã€‚ rootfsï¼š ç³»ç»Ÿæ–‡ä»¶éš”ç¦»ã€‚ å®¹å™¨å¼•æ“ï¼š ç”Ÿå‘½å‘¨æœŸæ§åˆ¶ã€‚ ","date":"2017-07-17","objectID":"/posts/docker/:1:1","tags":["go","docker"],"title":"Docker åŸºç¡€çŸ¥è¯†å’ŒåŸºæœ¬æ“ä½œ","uri":"/posts/docker/"},{"categories":["Docker"],"content":"å®¹å™¨çš„åˆ›å»ºåŸç† ä»£ç ä¸€ pid = clone(fun, stack, flags, clone_arg); (flags: CLONE_NEWPID | CLONE_NEWNS | CLONE_NEWUSER | CLONE_NEWNET | CLONE_NEWIPC | CLONE_NEWUTS | ...) å¯¹äºä»¥ä¸Šä»£ç ï¼Œé€šè¿‡cloneç³»ç»Ÿè°ƒç”¨ï¼Œå¹¶ä¼ å…¥å„ä¸ªNamespaceå¯¹åº”çš„clone flagï¼Œåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„å­è¿›ç¨‹ï¼Œè¯¥è¿›ç¨‹æ‹¥æœ‰è‡ªå·±çš„Namespaceã€‚ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œè¯¥è¿›ç¨‹æ‹¥æœ‰è‡ªå·±çš„pid,mount,user,net,ipc,uts namespace ã€‚ ä»£ç äºŒï¼š echo $pid \u003e /sys/fs/cgroup/cpu/tasks echo $pid \u003e /sys/fs/cgroup/cpuset/tasks echo $pid \u003e /sys/fs/cgroup/blkio/tasks echo $pid \u003e /sys/fs/cgroup/memory/tasks echo $pid \u003e /sys/fs/cgroup/devices/tasks echo $pid \u003e /sys/fs/cgroup/freezer/tasks å¯¹äºä»£ç äºŒï¼Œå°†ä»£ç ä¸€ä¸­çš„pidå†™å…¥å„ä¸ªCgroupå­ç³»ç»Ÿä¸­ï¼Œè¿™æ ·è¯¥è¿›ç¨‹å°±å¯ä»¥å—åˆ°ç›¸åº”Cgroupå­ç³»ç»Ÿçš„æ§åˆ¶ã€‚ ä»£ç ä¸‰ï¼š fun () { ... pivot_root(\"path_of_rootfs/\", path); ... exec(\"/bin/bash\"); ... } å¯¹äºä»£ç ä¸‰ï¼Œè¯¥funå‡½æ•°ç”±ä¸Šé¢ç”Ÿæˆçš„æ–°è¿›ç¨‹æ‰§è¡Œï¼Œåœ¨funå‡½æ•°ä¸­ï¼Œé€šè¿‡pivot_rootç³»ç»Ÿè°ƒç”¨ï¼Œä½¿è¿›ç¨‹è¿›å…¥æ–°çš„rootfsï¼Œä¹‹åé€šè¿‡execç³»ç»Ÿè°ƒç”¨ï¼Œåœ¨æ–°çš„Namespace,Cgroup,rootfsä¸­æ‰§è¡Œ\"/bin/bash\"ç¨‹åºã€‚ é€šè¿‡ä»¥ä¸Šæ“ä½œï¼ŒæˆåŠŸåœ¨ä¸€ä¸ªâ€œå®¹å™¨â€ä¸­è¿è¡Œäº†ä¸€ä¸ªbashç¨‹åºã€‚å¯¹äºCgroupå’ŒNamespaceçš„æŠ€æœ¯ç»†èŠ‚ï¼Œæˆ‘ä»¬ä¸‹ä¸€èŠ‚è¯¦ç»†æè¿° ","date":"2017-07-17","objectID":"/posts/docker/:1:2","tags":["go","docker"],"title":"Docker åŸºç¡€çŸ¥è¯†å’ŒåŸºæœ¬æ“ä½œ","uri":"/posts/docker/"},{"categories":["Docker"],"content":"Cgroup Cgroup æ˜¯ä»€ä¹ˆ Cgroupæ˜¯control group çš„ç®€å†™ï¼Œå±äº Linux å†…æ ¸æä¾›çš„ä¸€ä¸ªç‰¹æ€§ï¼Œç”¨äºé™åˆ¶å’Œéš”ç¦»ä¸€ç»„è¿›ç¨‹å¯¹ç³»ç»Ÿèµ„æºçš„ä½¿ç”¨ã€‚è¿™äº›èµ„æºä¸»è¦åŒ…æ‹¬ CPUï¼Œ å†…å­˜ï¼Œ block I/Oï¼ˆæ•°æ®å— I/Oï¼‰ å’Œç½‘ç»œå®½å¸¦ã€‚ Cgroup ä» 2.6.24ç‰ˆæœ¬è¿›å…¥å†…æ ¸ä¸»çº¿ï¼Œç›®å‰å„å¤§å‘è¡Œç‰ˆlinuxéƒ½é»˜è®¤æ‰“å¼€äº† Cgroup ç‰¹æ€§ ä»å®ç°çš„è§’åº¦æ¥çœ‹ï¼ŒCgroup å®ç°äº†ä¸€ä¸ªé€šç”¨çš„è¿›ç¨‹åˆ†ç»„çš„æ¡†æ¶ï¼Œè€Œä¸åŒèµ„æºçš„å…·ä½“ç®¡ç†åˆ™æ˜¯ç”±å„ä¸ª Cgroup å­ç³»ç»Ÿå®ç°çš„ã€‚æˆªæ­¢å†…æ ¸4.1ç‰ˆæœ¬ï¼ŒCgroup ä¸­å®ç°çš„å­ç³»ç»Ÿçš„åŠå…¶ä½œç”¨å¦‚ä¸‹ï¼š devicesï¼š è®¾å¤‡æƒé™æ§åˆ¶ cpusetï¼š åˆ†é…æŒ‡å®šçš„CPUå’Œå†…å­˜èŠ‚ç‚¹ cpuï¼š æ§åˆ¶ CPU å ç”¨ç‡ cpuacctï¼š ç»Ÿè®¡ CPU ä½¿ç”¨æƒ…å†µ memoryï¼š é™åˆ¶å†…å­˜çš„ä½¿ç”¨ä¸Šé™ freezerï¼š å†»ç»“ï¼ˆæš‚åœï¼‰Cgroup ä¸­çš„è¿›ç¨‹ net_clsï¼š é…åˆtcï¼ˆtraffic controllerï¼‰é™åˆ¶ç½‘ç»œå®½å¸¦ net_prioï¼š è®¾ç½®è¿›ç¨‹çš„ç½‘ç»œæµé‡ä¼˜å…ˆçº§ huge_tlbï¼š é™åˆ¶HugeTLBï¼ˆå—è¡¨ç¼“å†²åŒºï¼‰çš„ä½¿ç”¨ perf_eventï¼š å…è®¸ Perf å·¥å…·åŸºäºCgroupåˆ†ç»„åšæ€§èƒ½æµ‹è¯• ","date":"2017-07-17","objectID":"/posts/docker/:1:3","tags":["go","docker"],"title":"Docker åŸºç¡€çŸ¥è¯†å’ŒåŸºæœ¬æ“ä½œ","uri":"/posts/docker/"},{"categories":["Docker"],"content":"Namespace Namespace æ˜¯ä»€ä¹ˆ Namespace æ˜¯å°†å†…æ ¸çš„å…¨å±€èµ„æºåšå°è£…ï¼Œä½¿å¾—æ¯ä¸ªNamespaceéƒ½æœ‰æœ‰ä¸€ä»½ç‹¬ç«‹çš„èµ„æºï¼Œå› æ­¤ä¸åŒçš„è¿›ç¨‹å„è‡ªçš„ Namespace å†…å¯¹åŒä¸€ä¸ªèµ„æºçš„ä½¿ç”¨ä¸ä¼šäº’ç›¸å¹²æ‰°ã€‚ ä¸¾ä¸ªä¾‹å­ï¼Œæ‰§è¡Œ sethostname è¿™ä¸ªç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œå¯ä»¥æ”¹å˜ç³»ç»Ÿçš„ä¸»æœºåï¼Œè¿™ä¸ªä¸»æœºåå°±æ˜¯ä¸€ä¸ªå†…æ ¸çš„å…¨å±€èµ„æºã€‚å†…æ ¸é€šè¿‡å®ç° UTS Namespaceï¼Œå¯ä»¥å°†ä¸åŒçš„è¿›ç¨‹åˆ†éš”åœ¨ä¸åŒçš„ UTS Namespace ä¸­ï¼Œåœ¨æŸä¸ª Namespace ä¿®æ”¹ä¸»æœºåæ—¶ï¼Œå¦ä¸€ä¸ª Namespace çš„ä¸»æœºåè¿˜æ˜¯ä¿æŒä¸å˜ã€‚ ç›®å‰ Linux å†…æ ¸æ€»å…±å®ç°äº†6ç§ Namespaceï¼š IPCï¼š éš”ç¦» System V IPC å’Œ POSIX æ¶ˆæ¯é˜Ÿåˆ— Networkï¼š éš”ç¦»ç½‘ç»œèµ„æº Mountï¼š éš”ç¦»æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ç‚¹ PIDï¼š éš”ç¦»è¿›ç¨‹ ID UTSï¼š éš”ç¦»ä¸»æœºåå’ŒåŸŸå Userï¼š éš”ç¦»ç”¨æˆ· ID å’Œ ç»„ ID Namespace å’Œ Cgroup çš„ä½¿ç”¨æ˜¯çµæ´»çš„ï¼ŒåŒæ—¶ä¹Ÿæœ‰ä¸å°‘éœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼Œå› æ­¤ç›´æ¥æ“ä½œ Namespace å’Œ Cgroup å¹¶ä¸æ˜¯å¾ˆå®¹æ˜“ã€‚æ­£æ˜¯å› ä¸ºè¿™äº›åŸå› ï¼ŒDocker é€šè¿‡ Libcontainer æ¥å¤„ç†è¿™äº›åº•å±‚çš„äº‹æƒ…ã€‚è¿™æ ·ä¸€æ¥ï¼ŒDocker åªéœ€ç®€å•åœ°è°ƒç”¨ Libcontainer çš„ API ï¼Œå°±èƒ½å°†å®Œæ•´çš„å®¹å™¨æ­å»ºèµ·æ¥ã€‚è€Œä½œä¸º Docker çš„ç”¨æˆ·ï¼Œå°±æ›´ä¸ç”¨æ“å¿ƒè¿™äº›äº‹æƒ…äº†ã€‚ ","date":"2017-07-17","objectID":"/posts/docker/:1:4","tags":["go","docker"],"title":"Docker åŸºç¡€çŸ¥è¯†å’ŒåŸºæœ¬æ“ä½œ","uri":"/posts/docker/"},{"categories":["Docker"],"content":"å®¹å™¨é€ å°± Docker å…³äºå®¹å™¨æ˜¯å¦æ˜¯ Docker çš„æŠ€æœ¯æ ¸å¿ƒæŠ€æœ¯ï¼Œä¸šç•Œä¸€ç›´å­˜åœ¨ç€äº‰è®®ã€‚ åœ¨ç†è§£äº†å®¹å™¨ï¼Œç†è§£äº†å®¹å™¨çš„æ ¸å¿ƒæŠ€æœ¯ Cgroup å’Œ Namespaceï¼Œç†è§£äº†å®¹å™¨æŠ€æœ¯å¦‚ä½•å·§å¦™ä¸”è½»é‡åœ°å®ç°â€œå®¹å™¨â€æœ¬èº«çš„èµ„æºæ§åˆ¶å’Œè®¿é—®éš”ç¦»ä¹‹åï¼Œå¯ä»¥çœ‹åˆ° Docker å’Œå®¹å™¨æ˜¯ä¸€ç§å®Œç¾çš„èåˆå’Œè¾…åŠ©ç›¸æˆçš„å…³ç³»ï¼Œå®ƒä»¬ä¸æ˜¯å”¯ä¸€çš„æ­é…ï¼Œä½†ä¸€å®šæ˜¯æœ€å®Œç¾çš„ç»“åˆï¼ˆç›®å‰æ¥è¯´ï¼‰ã€‚ä¸å…¶è¯´æ˜¯å®¹å™¨é€ å°±äº† Docker ï¼Œ ä¸å¦‚è¯´æ˜¯å®ƒä»¬é€ å°±äº†å½¼æ­¤ï¼Œå®¹å™¨æŠ€æœ¯è®© Docker å¾—åˆ°æ›´å¤šçš„åº”ç”¨å’Œæ¨å¹¿ï¼ŒDocker ä¹Ÿä½¿å¾—å®¹å™¨æŠ€æœ¯è¢«æ›´å¤šäººç†ŸçŸ¥ã€‚ ","date":"2017-07-17","objectID":"/posts/docker/:1:5","tags":["go","docker"],"title":"Docker åŸºç¡€çŸ¥è¯†å’ŒåŸºæœ¬æ“ä½œ","uri":"/posts/docker/"},{"categories":["Docker"],"content":"åŸºæœ¬æ“ä½œ ","date":"2017-07-17","objectID":"/posts/docker/:2:0","tags":["go","docker"],"title":"Docker åŸºç¡€çŸ¥è¯†å’ŒåŸºæœ¬æ“ä½œ","uri":"/posts/docker/"},{"categories":["Docker"],"content":"å¯åŠ¨å®¹å™¨ æ–°å»ºå¹¶å¯åŠ¨ æ‰€éœ€çš„å‘½ä»¤æ˜¯ docker run ä¾‹å¦‚ï¼š $ docker run ubuntu:14.04 /bin/echo 'hello, worl' å®¹å™¨æ‰§è¡Œåé¢çš„å‘½ä»¤ç›´æ¥å°±ä¼šç»ˆæ­¢ . ä¸‹é¢çš„å‘½ä»¤ä¼šå¯åŠ¨å®¹å™¨å¹¶èµ·ä¸€ä¸ª bash ç»ˆç«¯,å…è®¸ç”¨æˆ·è¿›è¡Œäº¤äº’ $ docker run -t -i ubuntu:14.04 /bin/bash å…¶ä¸­ -t è®© Docker åˆ†é…ä¸€ä¸ªä¼ªç»ˆç«¯ (pseudo-tty) å¹¶ç»‘å®šåˆ°å®¹å™¨çš„æ ‡å‡†è¾“å…¥ä¸Š, -i åˆ™è®©å®¹å™¨çš„æ ‡å‡†è¾“å…¥ä¿æŒæ‰“å¼€ . åˆ©ç”¨ docker run æ¥åˆ›å»ºå®¹å™¨æ˜¯, Docker åœ¨åå°è¿è¡Œçš„æ ‡å‡†æ“ä½œåŒ…æ‹¬: æ£€æŸ¥æœ¬åœ°æ˜¯å¦å­˜åœ¨æŒ‡å®šçš„é•œåƒ,ä¸å­˜åœ¨å°±ä»å…±æœ‰ä»“åº“ä¸‹è½½ åˆ©ç”¨é•œåƒåˆ›å»ºå¹¶å¯åŠ¨ä¸€ä¸ªå®¹å™¨ åˆ†é…ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿå¹¶åœ¨åªè¯»çš„é•œåƒå±‚å¤–é¢æŒ‚è½½ä¸€å±‚å¯è¯»å†™å±‚ åœ¨å®¿ä¸»ä¸»æœºé…ç½®çš„ç½‘æ¡¥æ¥å£ä¸­æ¡¥æ¥ä¸€ä¸ªè™šæ‹Ÿæ¥å£åˆ°å®¹å™¨ä¸­å» ä»åœ°å€æ± é…ç½®ä¸€ä¸ª ip åœ°å€ç»™å®¹å™¨ æ‰§è¡Œç”¨æˆ·æŒ‡å®šçš„åº”ç”¨ç¨‹åº æ‰§è¡Œå®Œæ¯•åå®¹å™¨ç»ˆæ­¢ å¯åŠ¨å·²ç»ˆæ­¢å®¹å™¨ å¯ä»¥åˆ©ç”¨ docker start å‘½ä»¤,ç›´æ¥å°†ä¸€ä¸ªå·²ç»ç»ˆæ­¢çš„å®¹å™¨å¯åŠ¨è¿è¡Œ . å¯ä»¥é€šè¿‡ docker ps -a æŸ¥çœ‹æ‰€æœ‰çš„å®¹å™¨å’Œå…¶çŠ¶æ€ CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES aada74689bf7 cockroachdb/cockroach \"/cockroach/cockro...\" 3 weeks ago Exited (137) 3 weeks ago roach_master 2e9eb6cf3f66 owncloud \"/entrypoint.sh ap...\" 3 weeks ago Up 3 weeks 0.0.0.0:80-\u003e80/tcp owncloud 91290c737c73 postgres \"docker-entrypoint...\" 3 weeks ago Up 3 weeks 5432/tcp owncloud-postgres 8f546ec65e61 mysql \"docker-entrypoint...\" 3 weeks ago Up 3 weeks 0.0.0.0:3306-\u003e3306/tcp mysql ä¸éš¾å‘ç° name ä¸º roch_master çš„å®¹å™¨å·²ç»ç»ˆæ­¢äº†,æƒ³é‡æ–°å¯åŠ¨å®ƒ,å¯ä»¥æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ $ docker start aada74689bf7 å‚æ•°ä¸ºå®¹å™¨çš„ id . ","date":"2017-07-17","objectID":"/posts/docker/:2:1","tags":["go","docker"],"title":"Docker åŸºç¡€çŸ¥è¯†å’ŒåŸºæœ¬æ“ä½œ","uri":"/posts/docker/"},{"categories":["Docker"],"content":"åå°( background )è¿è¡Œ åœ¨å¾ˆå¤šæ—¶å€™,æˆ‘ä»¬éœ€è¦è®© docker åœ¨åå°è¿è¡Œè€Œå¹¶ä¸æ˜¯æŠŠæ‰§è¡Œç»“æœç›´æ¥è¾“å‡ºå‡ºæ¥. è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥æ·»åŠ  -d å‚æ•°æ¥å®ç° å¦‚æœä½¿ç”¨ -d å‚æ•°è¿è¡Œå®¹å™¨ $ docker run -d mysql:5.7.17 77b2dc01fe0f3f1265df143181e7b9af5e05279a884f4776ee75350ea9d8017a åªä¼šè¾“å‡ºè¿è¡Œçš„å®¹å™¨ id, è€Œè¾“å‡ºç»“æœå¯ä»¥ç”¨ docker logs æŸ¥çœ‹ . $ docker logs [container ID or NAMES] ","date":"2017-07-17","objectID":"/posts/docker/:2:2","tags":["go","docker"],"title":"Docker åŸºç¡€çŸ¥è¯†å’ŒåŸºæœ¬æ“ä½œ","uri":"/posts/docker/"},{"categories":["Docker"],"content":"ç»ˆæ­¢å®¹å™¨ å¯ä»¥ä½¿ç”¨ docker stop æ¥ç»ˆæ­¢æ­£åœ¨è¿è¡Œçš„å®¹å™¨ . æ­¤å¤–,å½“ Docker å®¹å™¨ä¸­æŒ‡å®šçš„åº”ç”¨ç»ˆç»“æ—¶, å®¹å™¨ä¹Ÿè‡ªåŠ¨ç»ˆæ­¢ . ä¾‹å¦‚è¿è¡Œä¸€ä¸ªå®¹å™¨æ—¶,æŒ‡å®šäº†ä¸€ä¸ªç»ˆç«¯å,å½“é€€å‡ºç»ˆç«¯çš„æ—¶å€™,æ‰€åˆ›å»ºçš„å®¹å™¨ä¹Ÿä¼šç«‹åˆ»ç»ˆæ­¢ . ç»ˆæ­¢çŠ¶æ€çš„å®¹å™¨, å¯ä»¥é€šè¿‡ docker start æ¥é‡æ–°å¯åŠ¨ . æ­¤å¤–,docker restart å‘½ä»¤ä¼šå°†ä¸€ä¸ªè¿è¡Œæ€çš„å®¹å™¨ç»ˆæ­¢,ç„¶åé‡æ–°å¯åŠ¨å®ƒ . ","date":"2017-07-17","objectID":"/posts/docker/:2:3","tags":["go","docker"],"title":"Docker åŸºç¡€çŸ¥è¯†å’ŒåŸºæœ¬æ“ä½œ","uri":"/posts/docker/"},{"categories":["Docker"],"content":"è¿›å…¥å®¹å™¨ åœ¨ä½¿ç”¨ -d å‚æ•°æ—¶, docker å®¹å™¨ä¼šåœ¨åå°è¿è¡Œ. æœ‰äº›æ—¶å€™éœ€è¦è¿›å…¥å®¹å™¨,å¦‚è¿è¡Œæ•°æ®åº“æ—¶,éœ€è¦è¿›å…¥å¢åˆ æ”¹æŸ¥åº“é‡Œçš„å†…å®¹. è¿›å…¥å®¹å™¨æœ‰å¾ˆå¤šç§åŠæ³•. attach å‘½ä»¤ docker attach æ˜¯ Docker è‡ªå¸¦çš„å‘½ä»¤,ç”¨æ³•\u0008 ä½†æ˜¯ä½¿ç”¨ attach å‘½ä»¤æœ‰ä¸ªç¼ºé™·,å³å¤šä¸ªçª—å£åŒæ—¶ç”¨ attach å‘½ä»¤åˆ°åŒä¸€ä¸ªå®¹å™¨çš„æ—¶å€™,æ‰€æœ‰çš„çª—å£éƒ½æ˜¯åŒæ­¥æ˜¾ç¤ºçš„,å¦‚æœå…¶ä¸­ä¸€ä¸ªçª—å£é˜»å¡çš„æ—¶å€™,å…¶ä»–çª—å£ä¹Ÿæ— æ³•ä½¿ç”¨ . nsenter å‘½ä»¤ è¿™ä¸ªå·¥å…·éœ€è¦ç”¨å¦‚ä¸‹å‘½ä»¤å®‰è£… $ docker run --rm -v /usr/local/bin:/target jpetazzo/nsenter ä½¿ç”¨æ–¹æ³•ä¹Ÿæ¯”è¾ƒç®€å•,é¦–å…ˆæ˜¯ä½ è¦è¿›å…¥çš„å®¹å™¨çš„ ID $ PID=$(docker inspect --format {{.State.Pid}} \u003ccontainer ID or NAMES\u003e) ç„¶åé€šè¿‡è¿™ä¸ª PID è¿›å…¥å®¹å™¨ $ nsenter --target $PID --mount --uts --ipc --net --pid å¦‚æœæ— æ³•é€šè¿‡ä¸Šè¿°çš„å‘½ä»¤è¿æ¥åˆ°å®¹å™¨,æœ‰å¯èƒ½æ˜¯å› ä¸ºå®¿ä¸»çš„é»˜è®¤ shell åœ¨å®¹å™¨ä¸­å¹¶ä¸å­˜åœ¨,æ¯”å¦‚ zsh, å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æ˜¾ç¤ºåœ°ä½¿ç”¨ bash . exec å‘½ä»¤ $docker exec -it [container ID or NAMES] -i -t å‰é¢è¯´è¿‡ä¸ºäº†æ ‡å‡†è¾“å…¥è¾“å‡ºä¿æŒæ‰“å¼€ . ","date":"2017-07-17","objectID":"/posts/docker/:2:4","tags":["go","docker"],"title":"Docker åŸºç¡€çŸ¥è¯†å’ŒåŸºæœ¬æ“ä½œ","uri":"/posts/docker/"},{"categories":["Docker"],"content":"å¯¼å‡ºå’Œå¯¼å…¥å®¹å™¨ å¯¼å‡ºå®¹å™¨ å¦‚æœè¦å¯¼å‡ºæœ¬åœ°æŸä¸ªå®¹å™¨,å¯ä»¥ä½¿ç”¨ docker export å‘½ä»¤ . $ docker export [container ID or NAMES] \u003e target.tar è¿™æ ·å°†å¯¼å‡ºå®¹å™¨å¿«ç…§åˆ°æœ¬åœ°æ–‡ä»¶ . å¯¼å…¥å®¹å™¨å¿«ç…§ å¯ä»¥ä½¿ç”¨ docker import ä»å®¹å™¨å¿«ç…§æ–‡ä»¶å¯¼å…¥é•œåƒ, $ cat target.tar | docker import - test/mysql:v1.0 $ sudo docker images REPOSITORY TAG IMAGE ID CREATED VIRTUAL SIZE test/ubuntu v1.0 9d37a6082e97 About a minute ago 171.3 MB æ­¤å¤–,è¿˜å¯ä»¥é€šè¿‡æŒ‡å®š URL æˆ–è€…æŸä¸ªç›®å½•æ¥å¯¼å…¥ $ docker import http://example.com/exampleimage.tgz example/imagerepo *æ³¨ï¼šç”¨æˆ·æ—¢å¯ä»¥ä½¿ç”¨ docker load æ¥å¯¼å…¥é•œåƒå­˜å‚¨æ–‡ä»¶åˆ°æœ¬åœ°é•œåƒåº“,ä¹Ÿå¯ä»¥ä½¿ç”¨ docker import æ¥å¯¼å…¥ä¸€ä¸ªå®¹å™¨å¿«ç…§åˆ°æœ¬åœ°é•œåƒåº“ .è¿™ä¸¤è€…çš„åŒºåˆ«åœ¨äºå®¹å™¨å¿«ç…§æ–‡ä»¶å°†ä¸¢å¼ƒæ‰€æœ‰çš„å†å²è®°å½•å’Œå…ƒæ•°æ®ä¿¡æ¯ï¼ˆå³ä»…ä¿å­˜å®¹å™¨å½“æ—¶çš„å¿«ç…§çŠ¶æ€ï¼‰,è€Œé•œåƒå­˜å‚¨æ–‡ä»¶å°†ä¿å­˜å®Œæ•´è®°å½•,ä½“ç§¯ä¹Ÿè¦å¤§ .æ­¤å¤–,ä»å®¹å™¨å¿«ç…§æ–‡ä»¶å¯¼å…¥æ—¶å¯ä»¥é‡æ–°æŒ‡å®šæ ‡ç­¾ç­‰å…ƒæ•°æ®ä¿¡æ¯ . ","date":"2017-07-17","objectID":"/posts/docker/:2:5","tags":["go","docker"],"title":"Docker åŸºç¡€çŸ¥è¯†å’ŒåŸºæœ¬æ“ä½œ","uri":"/posts/docker/"},{"categories":["Docker"],"content":"åˆ é™¤å®¹å™¨ å•ç‹¬åˆ é™¤ å¯ä»¥ä½¿ç”¨ docker rm æ¥åˆ é™¤ä¸€ä¸ªå¤„äºç»ˆæ­¢çŠ¶æ€çš„å®¹å™¨ . $ docker rm [container ID or NAMES] å¦‚æœè¦åˆ é™¤ä¸€ä¸ªè¿è¡Œä¸­çš„å®¹å™¨,å¯ä»¥æ·»åŠ  -f å‚æ•° .Docker ä¼šå‘é€ SIGKILL ä¿¡å·ç»™å®¹å™¨ . æ¸…ç†æ‰€æœ‰å¤„äºç»ˆæ­¢çŠ¶æ€çš„å®¹å™¨ ç”¨ docker ps -a å‘½ä»¤å¯ä»¥æŸ¥çœ‹æ‰€æœ‰å·²åˆ›å»ºçš„åŒ…æ‹¬ç»ˆæ­¢çŠ¶æ€çš„å®¹å™¨,å¦‚æœæƒ³æ‰¹é‡åˆ é™¤å¤šä¸ªå®¹å™¨çš„è¯(å½“ç„¶æ˜¯ç»ˆæ­¢çŠ¶æ€çš„å®¹å™¨) ,å¯ä»¥ç”¨è¿™ä¸ªå‘½ä»¤ $ docker rm $(docker ps -a -q) *æ³¨æ„ï¼šè¿™ä¸ªå‘½ä»¤å…¶å®ä¼šè¯•å›¾åˆ é™¤æ‰€æœ‰çš„åŒ…æ‹¬è¿˜åœ¨è¿è¡Œä¸­çš„å®¹å™¨,ä¸è¿‡å°±åƒä¸Šé¢æè¿‡çš„ docker rm é»˜è®¤å¹¶ä¸ä¼šåˆ é™¤è¿è¡Œä¸­çš„å®¹å™¨ . ","date":"2017-07-17","objectID":"/posts/docker/:2:6","tags":["go","docker"],"title":"Docker åŸºç¡€çŸ¥è¯†å’ŒåŸºæœ¬æ“ä½œ","uri":"/posts/docker/"},{"categories":["Docker"],"content":"è®¿é—®ä»“åº“ ä»“åº“ï¼ˆRepositoryï¼‰æ˜¯é›†ä¸­å­˜æ”¾é•œåƒçš„åœ°æ–¹ . ä¸€ä¸ªå®¹æ˜“æ··æ·†çš„æ¦‚å¿µæ˜¯æ³¨å†ŒæœåŠ¡å™¨ï¼ˆRegistryï¼‰ .å®é™…ä¸Šæ³¨å†ŒæœåŠ¡å™¨æ˜¯ç®¡ç†ä»“åº“çš„å…·ä½“æœåŠ¡å™¨,æ¯ä¸ªæœåŠ¡å™¨ä¸Šå¯ä»¥æœ‰å¤šä¸ªä»“åº“,è€Œæ¯ä¸ªä»“åº“ä¸‹é¢æœ‰å¤šä¸ªé•œåƒ .ä»è¿™æ–¹é¢æ¥è¯´,ä»“åº“å¯ä»¥è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªå…·ä½“çš„é¡¹ç›®æˆ–ç›®å½• .ä¾‹å¦‚å¯¹äºä»“åº“åœ°å€dl.dockerpool.com/ubuntu æ¥è¯´, dl.dockerpool.com æ˜¯æ³¨å†ŒæœåŠ¡å™¨åœ°å€, ubuntu æ˜¯ä»“åº“å . å¤§éƒ¨åˆ†æ—¶å€™,å¹¶ä¸éœ€è¦ä¸¥æ ¼åŒºåˆ†è¿™ä¸¤è€…çš„æ¦‚å¿µ . ","date":"2017-07-17","objectID":"/posts/docker/:3:0","tags":["go","docker"],"title":"Docker åŸºç¡€çŸ¥è¯†å’ŒåŸºæœ¬æ“ä½œ","uri":"/posts/docker/"},{"categories":["Docker"],"content":"Docker Hub ç›®å‰ Docker å®˜æ–¹ç»´æŠ¤äº†ä¸€ä¸ªå…¬å…±ä»“åº“ Docker Hub, ä½†æ˜¯å¼€å§‹æŠŠé˜µåœ°ç§»åˆ° Docker Store è¿™ä¸ªå¹³å°ä¸Š,å…¶ä¸Šèƒ½æ‰¾åˆ°å‡ ä¹æ‰€æœ‰çš„èƒ½æƒ³å¾—åˆ°çš„å®¹å™¨, ä¸å¯å°è§‘ . ç™»å½• å¯ä»¥é€šè¿‡æ‰§è¡Œ docker login å‘½ä»¤æ¥è¾“å…¥ç”¨æˆ·åã€å¯†ç å’Œé‚®ç®±æ¥å®Œæˆæ³¨å†Œå’Œç™»å½• . æ³¨å†ŒæˆåŠŸå,æœ¬åœ°ç”¨æˆ·ç›®å½•çš„.dockercfg ä¸­å°†ä¿å­˜ç”¨æˆ·çš„è®¤è¯ä¿¡æ¯ . åŸºæœ¬æ“ä½œ ç”¨æˆ·æ— éœ€ç™»å½•å³å¯é€šè¿‡ docker search å‘½ä»¤æ¥æŸ¥æ‰¾å®˜æ–¹ä»“åº“ä¸­çš„é•œåƒ, å¹¶åˆ©ç”¨ docker pull å‘½ä»¤æ¥å°†å®ƒä¸‹è½½åˆ°æœ¬åœ° . ä»¥æœç´¢ mongo ä¸ºå…³é”®å­—æœç´¢: $ docker search mongo NAME DESCRIPTION STARS OFFICIAL AUTOMATED mongo MongoDB document databases provide high av... 3427 [OK] mongo-express Web-based MongoDB admin interface, written... 168 [OK] mvertes/alpine-mongo light MongoDB container 51 [OK] mongoclient/mongoclient Official docker image for Mongoclient, fea... 29 [OK] torusware/speedus-mongo Always lastmod official MongoDB docker ima... 9 [OK] mongooseim/mongooseim-docker MongooseIM server the latest stable version 9 [OK] â€‹æœç´¢ç»“æœå¯ä»¥çœ‹åˆ°å¾ˆå¤šåŒ…å«å…³é”®å­—çš„é•œåƒ,å…¶ä¸­åŒ…æ‹¬é•œåƒåå­—ã€æè¿°ã€æ˜Ÿæ•°ï¼ˆè¡¨ç¤ºè¯¥é•œåƒçš„å—æ¬¢è¿ç¨‹åº¦ï¼‰ã€æ˜¯å¦å®˜æ–¹åˆ›å»ºã€æ˜¯å¦è‡ªåŠ¨åˆ›å»º . å®˜æ–¹çš„é•œåƒè¯´æ˜æ˜¯å®˜æ–¹é¡¹ç›®ç»„åˆ›å»ºå’Œç»´æŠ¤çš„,automated èµ„æºå…è®¸ç”¨æˆ·éªŒè¯é•œåƒçš„æ¥æºå’Œå†…å®¹ . â€‹æ ¹æ®æ˜¯å¦ä¸ºå®˜æ–¹æä¾›, é•œåƒèµ„æºå¯åˆ†ä¸ºä¸¤ç±» . ä¸€ç±»æ˜¯ç´¯ç±»ä¼¼ mongoè¿™æ ·çš„åŸºç¡€é•œåƒ . è¿™äº›é•œåƒç”± Docker çš„ç”¨æˆ·åˆ›å»ºã€éªŒè¯ã€æ”¯æŒã€æä¾› . è¿™æ ·çš„é•œåƒå¾€å¾€æ˜¯ä½¿ç”¨å•ä¸ªå•è¯ä½œä¸ºåå­— . å¦ä¸€ç§ç±»å‹,æ¯”å¦‚mvertes/alpine-mongo é•œåƒ,å®ƒæ˜¯ç”± Docker çš„ç”¨æˆ·åˆ›å»ºå¹¶ç»´æŠ¤çš„,å¾€å¾€å¸¦æœ‰ç”¨æˆ·åç§°å‰ç¼€ . å¯ä»¥é€šè¿‡å‰ç¼€ user_name/ æ¥æŒ‡å®šä½¿ç”¨æŸä¸ªç”¨æˆ·æä¾›çš„é•œåƒ . å¦å¤–,åœ¨æŸ¥æ‰¾çš„æ—¶å€™é€šè¿‡ -s N å‚æ•°å¯ä»¥æŒ‡å®šä»…æ˜¾ç¤ºæ˜Ÿæ•°ä¸º N ä»¥ä¸Šçš„é•œåƒ ï¼ˆæ–°ç‰ˆæœ¬çš„ Docker æ¨èä½¿ç”¨ --flter=stars=N å‚æ•°ï¼‰ . ä¸‹è½½é•œåƒåˆ°æœ¬åœ° $ sudo docker pull centos Pulling repository centos 0b443ba03958: Download complete 539c0211cd76: Download complete 511136ea3c5a: Download complete 7064731afe90: Download complete ç”¨æˆ·ä¹Ÿå¯ä»¥ç™»å½•ä¹‹åé€šè¿‡ docker push å‘½ä»¤æ¥è®²é•œåƒæ¨é€åˆ° Docker Hub . è‡ªåŠ¨åˆ›å»º â€‹è‡ªåŠ¨åˆ›å»ºï¼ˆautomated buildsï¼‰åŠŸèƒ½å¯¹äºéœ€è¦ç»å¸¸å‡çº§é•œåƒå†…ç¨‹åºæ¥è¯´,ååˆ†æ–¹ä¾¿ .æœ‰æ—¶å€™,ç”¨æˆ·åˆ›å»ºäº†é•œåƒå®‰è£…äº†æŸä¸ªè½¯ä»¶,å¦‚æœè½¯ä»¶å‘å¸ƒæ–°ç‰ˆæœ¬åˆ™éœ€è¦æ‰‹åŠ¨æ›´æ–°é•œåƒ . .è€Œè‡ªåŠ¨åˆ›å»ºå…è®¸ç”¨æˆ·é€šè¿‡ Docker Hub æŒ‡å®šè·Ÿè¸ªä¸€ä¸ªç›®æ ‡ç½‘ç«™ï¼ˆç›®å‰æ”¯æŒ GitHubæˆ– BitBucketï¼‰ä¸Šçš„é¡¹ç›®,ä¸€æ—¦é¡¹ç›®å‘ç”Ÿæ–°çš„æäº¤,åˆ™è‡ªåŠ¨æ‰§è¡Œåˆ›å»º . è¦é…ç½®è‡ªåŠ¨åˆ›å»º,åŒ…æ‹¬å¦‚ä¸‹çš„æ­¥éª¤ï¼š åˆ›å»ºå¹¶ç™»å½• Docker Hub,ä»¥åŠç›®æ ‡ç½‘ç«™ï¼› åœ¨ç›®æ ‡ç½‘ç«™ä¸­è¿æ¥å¸æˆ·åˆ° Docker Hubï¼› åœ¨ Docker Hub ä¸­ é…ç½®ä¸€ä¸ªè‡ªåŠ¨åˆ›å»ºï¼› é€‰å–ä¸€ä¸ªç›®æ ‡ç½‘ç«™ä¸­çš„é¡¹ç›®ï¼ˆéœ€è¦å« Dockerfileï¼‰å’Œåˆ†æ”¯ï¼› æŒ‡å®š Dockerfile çš„ä½ç½®,å¹¶æäº¤åˆ›å»º . ä¹‹å,å¯ä»¥ åœ¨Docker Hub çš„ è‡ªåŠ¨åˆ›å»ºé¡µé¢ ä¸­è·Ÿè¸ªæ¯æ¬¡åˆ›å»ºçš„çŠ¶æ€ . ","date":"2017-07-17","objectID":"/posts/docker/:3:1","tags":["go","docker"],"title":"Docker åŸºç¡€çŸ¥è¯†å’ŒåŸºæœ¬æ“ä½œ","uri":"/posts/docker/"},{"categories":["Docker"],"content":"ç§æœ‰ä»“åº“ æœ‰æ—¶å€™ä½¿ç”¨ Docker Hub è¿™æ ·çš„å…¬å…±ä»“åº“ç”±äºç½‘ç»œç­‰åŸå› å¯èƒ½ä¸æ–¹ä¾¿,ç”¨æˆ·å¯ä»¥åˆ›å»ºä¸€ä¸ªæœ¬åœ°ä»“åº“ä¾›ç§äººä½¿ç”¨ . éœ€è¦ç”¨åˆ° docker-registry å·¥å…· . docker-registry æ˜¯å®˜æ–¹æä¾›çš„å·¥å…·,å¯ä»¥ç”¨äºæ„å»ºç§æœ‰çš„é•œåƒä»“åº“ . å®‰è£…è¿è¡Œ docker-registry å®¹å™¨è¿è¡Œ åœ¨å®‰è£…äº† Docker å,å¯ä»¥é€šè¿‡è·å–å®˜æ–¹ registry é•œåƒæ¥è¿è¡Œ . $ docker run -d -p 5000:5000 registry è¿™å°†ä½¿ç”¨å®˜æ–¹çš„ registry é•œåƒæ¥å¯åŠ¨æœ¬åœ°çš„ç§æœ‰ä»“åº“ .ç”¨æˆ·å¯ä»¥é€šè¿‡åˆ¶å®šå‚æ•°æ¥é…ç½®ç§æœ‰ä»“åº“ä½ç½®,ä¾‹å¦‚é…ç½®é•œåƒå­˜å‚¨åˆ° Amazon S3 æœåŠ¡ . $ sudo docker run \\ -e SETTINGS_FLAVOR=s3 \\ -e AWS_BUCKET=acme-docker \\ -e STORAGE_PATH=/registry \\ -e AWS_KEY=AKIAHSHB43HS3J92MXZ \\ -e AWS_SECRET=xdDowwlK7TJajV1Y7EoOZrmuPEJlHYcNP2k4j49T \\ -e SEARCH_BACKEND=sqlalchemy \\ -p 5000:5000 \\ registry æ­¤å¤–,è¿˜å¯ä»¥æŒ‡å®šæœ¬åœ°è·¯å¾„ï¼ˆå¦‚/home/user/registry-conf ï¼‰ä¸‹çš„é…ç½®æ–‡ä»¶ . $ sudo docker run -d -p 5000:5000 -v /home/user/registry-conf:/r egistry-conf -e DOCKER_REGISTRY_CONFIG=/registry-conf/config.yml registry é»˜è®¤æƒ…å†µä¸‹,ä»“åº“ä¼šè¢«åˆ›å»ºåœ¨å®¹å™¨çš„ /var/lib/registry ä¸‹ .å¯ä»¥é€šè¿‡ -v å‚æ•°æ¥å°†é•œåƒæ–‡ä»¶å­˜æ”¾åœ¨æœ¬åœ°çš„æŒ‡å®šè·¯å¾„ . ä¾‹å¦‚ä¸‹é¢çš„ä¾‹å­å°†ä¸Šä¼ çš„é•œåƒæ”¾åˆ° /opt/data/registy ç›®å½• . $ sudo docker run -d -p 5000:5000 -v /opt/data/registry:/var/lib /registry registry æœ¬åœ°å®‰è£… å¯¹äº Ubuntu æˆ– CentOS ç­‰å‘è¡Œç‰ˆ,å¯ä»¥ç›´æ¥å®‰è£… . Ubuntu $ sudo apt-get install -y build-essential python-dev libevent-dev python-pip liblzma-dev $ sudo pip install docker-registry CentOS $ sudo yum install -y python-devel libevent-devel python-pip gcc xz-devel $ sudo python-pip install docker-registry ä¹Ÿå¯ä»¥ä» docker-registry é¡¹ç›®ä¸‹è½½æºç è¿›è¡Œå®‰è£… . $ sudo apt-get install build-essential python-dev libevent-dev python-pip libssl-dev liblzma-dev libffi-dev $ git clone https://github.com/docker/docker-registry.git $ cd docker-registry $ sudo python setup.py install ç„¶åä¿®æ”¹é…ç½®æ–‡ä»¶,ä¸»è¦ä¿®æ”¹ dev æ¨¡æ¿æ®µçš„ storage_path åˆ°æœ¬åœ°çš„å­˜å‚¨ä»“åº“çš„è·¯å¾„ . $ cp config/config_sample.yml config/config.yml ä¹‹åå¯åŠ¨ web æœåŠ¡ . $ sudo gunicorn -c contrib/gunicorn.py docker_registry.wsgi:application æˆ–è€… $ sudo gunicorn --access-logfile - --error-logfile - -k gevent -b 0.0.0.0:5000 -w 4 --max-requests 100 docker_registry.wsgi:application æ­¤æ—¶ä½¿ç”¨ crul è®¿é—®æœ¬åœ°çš„ 5000 ç«¯å£,çœ‹åˆ°è¾“å‡º docker-registry çš„ç‰ˆæœ¬ä¿¡æ¯è¯´æ˜è¿è¡ŒæˆåŠŸ . *æ³¨ ï¼š config/config_sample.yml æ–‡ä»¶æ—¶ç¤ºä¾‹é…ç½®æ–‡ä»¶ åœ¨ç§æœ‰ä»“åº“ä¸Šä¼ ã€ä¸‹è½½ã€æœç´¢é•œåƒ åˆ›å»ºå¥½ç§æœ‰ä»“åº“ä¹‹å,å°±å¯ä»¥ä½¿ç”¨ docker tag æ¥æ ‡è®°ä¸€ä¸ªé•œåƒ,ç„¶åæ¨é€å®ƒåˆ°ä»“åº“,åˆ«çš„æœºå™¨ä¸Šå°±å¯ä»¥ä¸‹è½½äº† .å¦‚ ç§æœ‰ä»“åº“åœ°å€ä¸º 1192.168.7.26:5000 å…ˆåœ¨æœ¬æœºä¸ŠæŸ¥çœ‹å·²æœ‰çš„é•œåƒ . $ docker images REPOSITORY TAG IMAGE ID CREATED SIZE node latest f93ba6280cbd 3 weeks ago 667MB cockroachdb/cockroach latest 404f7ee26d38 4 weeks ago 163MB postgres latest ca3a55649cfc 7 weeks ago 269MB tomcat latest 0785a1d16826 7 weeks ago 367MB owncloud latest 2327c8d59618 8 weeks ago 572MB mysql latest e799c7f9ae9c 2 months ago 407MB ä½¿ç”¨ docker tag å°† tomcat è¿™ä¸ªé•œåƒæ ‡è®°ä¸º 192.168.7.26ï¼š5000/test [root@vultr ~]# docker tag tomcat 192.168.7.26:5000/test [root@vultr ~]# docker images REPOSITORY TAG IMAGE ID CREATED SIZE node latest f93ba6280cbd 3 weeks ago 667MB cockroachdb/cockroach latest 404f7ee26d38 4 weeks ago 163MB postgres latest ca3a55649cfc 7 weeks ago 269MB 192.168.7.26:5000/test latest 0785a1d16826 7 weeks ago 367MB tomcat latest 0785a1d16826 7 weeks ago 367MB owncloud latest 2327c8d59618 8 weeks ago 572MB mysql latest e799c7f9ae9c 2 months ago 407MB ç”¨ docker push ä¸Šä¼ æ ‡è®°çš„é•œåƒ . $ docker push 192.168.7.26:5000/test The push refers to a repository [192.168.7.26:5000/test] (len: 1) Sending image list Pushing repository 192.168.7.26:5000/test (1 tags) Image 511136ea3c5a already pushed, skipping Image 9bad880da3d2 already pushed, skipping Image 25f11f5fb0cb already pushed, skipping Image ebc34468f71d already pushed, skipping Image 2318d26665ef already pushed, skipping Image ba5877dc9bec already pushed, skipping Pushing tag for rev [ba5877dc9bec] on {http://192.168.7.26:5000/ v1/repositories/test/tags/latest} ç”¨ curl æŸ¥çœ‹ä»“åº“ä¸­çš„é•œåƒ curl http://192.168.7.26:5000/v1/search {\"num_results\": 7, \"query\": \"\", \"results\": [{\"description\": \"\",\"name\": \"library/miaxis_j2ee\"}, {\"description\": \"\", \"name\": \"library/tomcat\"}, {\"description\": \"\", \"name\": \"library/ubuntu\"}, {\"description\": \"\", \"name\": \"library/ubuntu_office\"}, {\"description\": \"\", \"name\": \"library/desktop_ubu\"}, {\"description\": \"\", \"name\": \"dockerfile/ubuntu\"}, {\"description\": \"\", \"name\": \"library/test\"}]} è¿™é‡Œå¯ä»¥çœ‹åˆ° {\"description\": \"\", \"name\": \"library/test\"} ,è¡¨é¢é•œåƒå·²ç»ä¸Šä¼ æˆåŠŸäº† . ä¸‹è½½å¯ä»¥ç”¨å¦ä¸€å°æœºå™¨å»ä¸‹è½½è¿™ä¸ªé•œåƒ . $ docker pull 192.168.7.26","date":"2017-07-17","objectID":"/posts/docker/:3:2","tags":["go","docker"],"title":"Docker åŸºç¡€çŸ¥è¯†å’ŒåŸºæœ¬æ“ä½œ","uri":"/posts/docker/"},{"categories":["Docker"],"content":"ä»“åº“é…ç½®æ–‡ä»¶ Docker çš„ registry åˆ©ç”¨é…ç½®æ–‡ä»¶æä¾› äº†ä¸€äº›ä»“åº“çš„æ¨¡æ¿ï¼ˆflavorï¼‰,ç”¨æˆ·å¯ä»¥ç›´æ¥ä½¿ç”¨å®ƒä»¬æ¥è¿›è¡Œå¼€å‘æˆ–èº«äº§ç¯å¢ƒ . æ¨¡æ¿ åœ¨ config_sample.yml æ–‡ä»¶ä¸­,å¯ä»¥çœ‹åˆ°ä¸€äº›ç°æˆçš„æ¨¡æ¿æ®µï¼š common ï¼šåŸºç¡€é…ç½® local ï¼šå­˜å‚¨æ•°æ®åˆ°æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ s3 ï¼šå­˜å‚¨æ•°æ®åˆ° AWS S3 ä¸­ dev ï¼šä½¿ç”¨ local æ¨¡æ¿çš„åŸºæœ¬é…ç½® test ï¼šå•å…ƒæµ‹è¯•ä½¿ç”¨ prod ï¼šç”Ÿäº§ç¯å¢ƒé…ç½®ï¼ˆåŸºæœ¬ä¸Šè·Ÿs3é…ç½®ç±»ä¼¼ï¼‰ gcs ï¼šå­˜å‚¨æ•°æ®åˆ° Google çš„äº‘å­˜å‚¨ swift ï¼šå­˜å‚¨æ•°æ®åˆ° OpenStack Swift æœåŠ¡ glance ï¼šå­˜å‚¨æ•°æ®åˆ° OpenStack Glance æœåŠ¡,æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸ºåå¤‡ glance-swift ï¼šå­˜å‚¨æ•°æ®åˆ° OpenStack Glance æœåŠ¡,Swift ä¸ºåå¤‡ elliptics ï¼šå­˜å‚¨æ•°æ®åˆ° Elliptics key/value å­˜å‚¨ ç”¨æˆ·å¯ä»¥æ·»åŠ è‡ªå®šä¹‰çš„æ¨¡æ¿æ®µ . é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨çš„æ¨¡æ¿æ˜¯ dev ,è¦æ˜¯ä½¿ç”¨æŸä¸ªæ¨¡æ¿ä½œä¸ºé»˜è®¤å€¼,å¯ä»¥æ·»åŠ  SETTING-FLAVOR åˆ°ç¯å¢ƒå˜é‡ä¸­å», export SETTING_FLAVOR=dev å¦å¤–,é…ç½®æ–‡ä»¶ä¸­æ”¯æŒä»ç¯å¢ƒå˜é‡ä¸­åŠ è½½,è¯­æ³•æ ¼å¼ä¸º _env:VARIABLENAME[:DEFAULT] ç¤ºä¾‹é…ç½® common: loglevel: info search_backend: \"_env:SEARCH_BACKEND:\" sqlalchemy_index_database: \"_env:SQLALCHEMY_INDEX_DATABASE:sqlite:////tmp/docker-re gistry.db\" prod: loglevel: warn storage: s3 s3_access_key: _env:AWS_S3_ACCESS_KEY s3_secret_key: _env:AWS_S3_SECRET_KEY s3_bucket: _env:AWS_S3_BUCKET boto_bucket: _env:AWS_S3_BUCKET storage_path: /srv/docker smtp_host: localhost from_addr: docker@myself.com to_addr: my@myself.com dev: loglevel: debug storage: local storage_path: /home/myself/docker test: storage: local storage_path: /tmp/tmpdockertmp ","date":"2017-07-17","objectID":"/posts/docker/:3:3","tags":["go","docker"],"title":"Docker åŸºç¡€çŸ¥è¯†å’ŒåŸºæœ¬æ“ä½œ","uri":"/posts/docker/"},{"categories":["Docker"],"content":"Docker æ•°æ®ç®¡ç† åœ¨å®¹å™¨ç®¡ç†ä¸­æ•°æ®ä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼š æ•°æ®å· ï¼ˆData volumesï¼‰ æ•°æ®å·å®¹å™¨ ï¼ˆData volume containersï¼‰ ","date":"2017-07-17","objectID":"/posts/docker/:4:0","tags":["go","docker"],"title":"Docker åŸºç¡€çŸ¥è¯†å’ŒåŸºæœ¬æ“ä½œ","uri":"/posts/docker/"},{"categories":["Docker"],"content":"æ•°æ®å· æ•°æ®å·æ˜¯ä¸€ä¸ªå¯æä¾›ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ä½¿ç”¨çš„ç‰¹æ®Šç›®å½•,å®ƒç»•è¿‡ UFS, å¯ä»¥æä¾›å¾ˆå¤šæœ‰ç”¨çš„ç‰¹å¾ï¼š æ•°æ®å·å¯ä»¥å†è£æœŸé—´å…±äº«å’Œé‡ç”¨ å¯¹æ•°æ®å·çš„ä¿®æ”¹ç«‹é©¬ç”Ÿæ•ˆ å¯¹æ•°æ®åŠçš„æ›´æ–°,ä¸ä¼šå½±å“é•œåƒ æ•°æ®å·é»˜è®¤ä¼šä¸€ç›´å­˜åœ¨,å³ä½¿å®¹å™¨è¢«åˆ é™¤ æ³¨ï¼šæ•°æ®å·çš„ä½¿ç”¨,ç±»ä¼¼äºLinux ä¸‹å¯¹ç›®å½•æˆ–æ–‡ä»¶è¿›è¡Œ mount, é•œåƒä¸­çš„è¢«æŒ‡å®šä¸ºæŒ‚è½½ç‚¹çš„ç›®å½•ä¸­çš„æ–‡ä»¶ä¼šéšè—æ‰,èƒ½æ˜¾ç¤ºçœ‹çš„æ˜¯æŒ‚è½½çš„æ•°æ®å· åˆ›å»ºä¸€ä¸ªæ•°æ®å· â€‹åœ¨ä½¿ç”¨ docker run å‘½ä»¤çš„æ—¶å€™,ä½¿ç”¨ -v å‚æ•°æ¥åˆ›å»ºä¸€ä¸ªæ•°æ®å·å¹¶æŒ‚è½½åˆ°å®¹å™¨é‡Œ .åœ¨ä¸€æ¬¡ run ä¸­å¯ä»¥æŒ‚è½½å¤šä¸ªæ•°æ®å· . ä¸‹é¢åˆ›å»ºä¸€ä¸ªåä¸º web çš„å®¹å™¨,å¹¶åŠ è½½ä¸€ä¸ªæ•°æ®å·åˆ°å®¹å™¨çš„ /webapp ç›®å½• . $ docker run -d -p --name web -v /webapp training/webapp python app.py æ³¨ï¼šä¹Ÿå¯ä»¥åœ¨ Docker ä¸­ä½¿ç”¨ volume æ¥æ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªæ–°çš„å·åˆ°æœ‰è¯¥é•œåƒåˆ›å»ºçš„ä»»æ„å®¹å™¨ . åˆ é™¤æ•°æ®å· æ•°æ®å·æ˜¯è¢«è®¾è®¡ç”¨æ¥æŒä¹…åŒ–æ•°æ®çš„,å®ƒçš„ç”Ÿå‘½å‘¨æœŸç‹¬ç«‹äºå®¹å™¨,Docker ä¸ä¼šåœ¨å®¹å™¨è¢«åˆ é™¤åè‡ªåŠ¨åˆ é™¤æ•°æ®å·,å¹¶ä¸”ä¹Ÿä¸å­˜åœ¨åƒåœ¾å›æ”¶è¿™æ ·çš„æœºåˆ¶æ¥å¤„ç†æ²¡æœ‰ä»»ä½•å®¹å™¨å¼•ç”¨çš„æ•°æ®å· .æ—¥å…‰éœ€è¦åœ¨åˆ é™¤å®¹å™¨çš„åŒæ—¶ç§»é™¤æ•°æ®å·,å¯ä»¥å†åˆ é™¤å®¹å™¨çš„æ—¶å€™ä½¿ç”¨ docker rm -v è¿™ä¸ªå‘½ä»¤ . æŒ‚è½½ä¸€ä¸ªä¸»å¥ç›®å½•ä½œä¸ºæ•°æ®å· ä½¿ç”¨ -v å‚æ•°ä¹Ÿå¯ä»¥æŒ‡å®šæŒ‚è½½ä¸€ä¸ªæœ¬åœ°ä¸»æœºçš„ç›®å½•åˆ°å®¹å™¨ä¸­å» . $ sudo docker run -d -P --name web -v /src/webapp:/opt/webapp training/webapp python app.py â€‹ ä¸Šé¢çš„å‘½ä»¤åŠ è½½ä¸»æœºçš„ /src/webapp ç›®å½•åˆ°å®¹å™¨çš„ /opt/webapp ç›®å½• .è¿™ä¸ªåŠŸèƒ½åœ¨è¿›è¡Œæµ‹è¯•çš„æ—¶å€™ååˆ†æ–¹ä¾¿,æ¯”å¦‚ç”¨æˆ·å¯ä»¥æ”¾ç½®ä¸€äº›ç¨‹åºåˆ°æœ¬åœ°ç›®å½•ä¸­,æ¥æŸ¥çœ‹å®¹å™¨æ˜¯å¦æ­£å¸¸å·¥ä½œ .æœ¬åœ°ç›®å½•çš„è·¯å¾„å¿…é¡»æ˜¯ç»å¯¹è·¯å¾„,å¦‚æœç›®å½•ä¸å­˜åœ¨ Dockerä¼šè‡ªåŠ¨ä¸ºä½ åˆ›å»ºå®ƒ . æ³¨ï¼šDockerfile ä¸­ä¸æ”¯æŒè¿™ç§ç”¨æ³•,å› ä¸º Dockerfile æ˜¯ä¸ºäº†ç§»æ¤å’Œåˆ†äº«ç”¨çš„ . ç„¶è€Œ,ä¸åŒçš„æ“ä½œç³»ç»Ÿçš„è·¯å¾„æ ¼å¼ä¸ä¸€æ ·,æ‰€ä»¥ç›®å‰è¿˜ä¸æ”¯æŒ Docker æŒ‚è½½æ•°æ®å·çš„é»˜è®¤æƒé™æ˜¯è¯»å†™, ç”¨æˆ·ä¹Ÿå¯ä»¥é€šè¿‡ :ro æŒ‡å®šä¸ºåªè¯» $ sudo docker run -d -P --name web -v /src/webapp:/opt/webapp:ro training/webapp python app.py åŠ äº† :ro ä¹‹å,å°±æŒ‚è½½ä¸ºåªè¯»äº† . æŸ¥çœ‹æ•°æ®å·çš„å…·ä½“ä¿¡æ¯ åœ¨ä¸»æœºé‡Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯ä»¥æŸ¥çœ‹æŒ‡å®šå®¹å™¨çš„ä¿¡æ¯ $ docker inspect web ... åœ¨è¾“å‡ºçš„å†…å®¹ä¸­æ‰¾åˆ°å…¶ä¸­å’Œæ•°æ®å·ç›¸å…³çš„éƒ¨åˆ†,å¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„æ•°æ®å·éƒ½æ˜¯åˆ›å»ºåœ¨ä¸»å¥çš„ /var/lib/docker/volumes/ ä¸‹é¢çš„ \"Volumes\": { \"/webapp\": \"/var/lib/docker/volumes/fac362...80535\" }, \"VolumesRW\": { \"/webapp\": true } ... æ³¨ï¼šä» Docker 1.8.0 èµ·,æ•°æ®å·é…ç½®åœ¨ â€œMountsâ€ Key ä¸‹é¢, å¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„æ•°æ®å·éƒ½æ˜¯åˆ›å»ºåœ¨ä¸»æœºçš„ /mnt/sda1/var/lib/docker/volumes/... ä¸‹é¢äº† . \"Mounts\": [ { \"Name\": \"b53ebd40054dae599faf7c9666acfe205c3e922 fc3e8bc3f2fd178ed788f1c29\", \"Source\": \"/mnt/sda1/var/lib/docker/volumes/b53e bd40054dae599faf7c9666acfe205c3e922fc3e8bc3f2fd178ed788f1c29/_data\", \"Destination\": \"/webapp\", \"Driver\": \"local\", \"Mode\": \"\", \"RW\": true, \"Propagation\": \"\" } ] ... æŒ‚è½½ä¸€ä¸ªæœ¬åœ°ä¸»æœºæ–‡ä»¶ä½œä¸ºæ•°æ®å· -v å‚æ•°ä¹Ÿå¯ä»¥ä»ä¸»æœºæŒ‚è½½å•ä¸ªæ–‡ä»¶åˆ°æ–‡ä»¶åˆ°å®¹å™¨ä¸­ $ sudo docker run --rm -it -v ~/.bash_history:/.bash_history ubuntu /bin/bash è¿™æ ·å°±å¯ä»¥è®°å½•åœ¨å®¹å™¨è¾“å…¥è¿‡å¾—å‘½ä»¤äº† . ","date":"2017-07-17","objectID":"/posts/docker/:4:1","tags":["go","docker"],"title":"Docker åŸºç¡€çŸ¥è¯†å’ŒåŸºæœ¬æ“ä½œ","uri":"/posts/docker/"},{"categories":["Docker"],"content":"æ•°æ®å·å®¹å™¨ å¦‚æœä½ æœ‰ä¸€äº›æŒç»­æ›´æ–°çš„æ•°æ®éœ€è¦åœ¨å®¹å™¨ä¹‹é—´å…±äº«,æœ€å¥½åˆ›å»ºæ•°æ®å·å®¹å™¨ . æ•°æ®å·å®¹å™¨,å…¶å®å°±æ˜¯ä¸€ä¸ªæ­£å¸¸çš„å®¹å™¨,ä¸“é—¨ç”¨æ¥æä¾›æ•°æ®å·ä¾›å…¶ä»–å®¹å™¨æŒ‚è½½çš„ . é¦–å…ˆ,åˆ›å»ºä¸€ä¸ªåä¸º dbdata çš„æ•°æ®å·å®¹å™¨ï¼š $ sudo docker run -d -v /dbdata --name dbdata training/postgres echo Data-only container for postgres ç„¶å,åœ¨å…¶ä»–å®¹å™¨ä¸­ä½¿ç”¨ --volumes-from æ¥æŒ‚è½½ dbdata å®¹å™¨ä¸­çš„æ•°æ®å· . $ sudo docker run -d --volumes-form dbdata --name db1 training/postgres $ sudo docker run -d --volumes-form dbdata --name db2 training/postgres å¯ä»¥ä½¿ç”¨è¶…è¿‡ä¸€ä¸ªçš„--volumes-from å‚æ•°æ¥æŒ‡å®šä»å¤šä¸ªå®¹å™¨æŒ‚è½½ä¸åŒçš„æ•°æ®å· . ä¹Ÿå¯ä»¥ä»å…¶ä»–å·²ç»æŒ‚è½½äº†æ•°æ®å·çš„å®¹å™¨æ¥çº§è”æŒ‚è½½æ•°æ®å· . $ docker run -d --name db3 --volumes-from db1 training/postgres æ³¨ï¼šä½¿ç”¨ --volumes-from å‚æ•°æ‰€æŒ‚è½½æ•°æ®å·çš„å®¹å™¨è‡ªå·±å¹¶ä¸éœ€è¦ä¿æŒè¿è¡ŒçŠ¶æ€ å¦‚æœåˆ é™¤äº†æŒ‚è½½çš„å®¹å™¨ï¼ˆåŒ…æ‹¬ dbdataã€db1 å’Œ db2 ï¼‰,æ•°æ®å·å¹¶ä¸ä¼šè¢«è‡ªåŠ¨åˆ é™¤ .å¦‚æœåˆ é™¤ä¸€ä¸ªæ•°æ®å·,å¿…é¡»åœ¨åˆ é™¤æœ€åä¸€ä¸ªè¿˜æŒ‚ç€å®ƒçš„å®¹å™¨æ—¶ä½¿ç”¨ docker rm -v å‘½ä»¤æ¥æŒ‡å®šåŒæ—¶åˆ é™¤å…³è”çš„å®¹å™¨ .è¿™å¯ä»¥è®©ç”¨æˆ·åœ¨å®¹å™¨ä¹‹é—´å‡çº§å’Œç§»åˆ°æ•°æ®å· . åˆ©ç”¨æ•°æ®å·å®¹å™¨æ¥å¤‡ä»½ã€æ¢å¤ã€è¿ç§»æ•°æ®å· å¯ä»¥åˆ©ç”¨æ•°æ®å·å¯¹å…¶ä¸­çš„æ•°æ®è¿›è¡Œå¤‡ä»½ã€æ¢å¤å’Œè¿ç§» . å¤‡ä»½ é¦–å…ˆä½¿ç”¨ --volumes-from æ ‡è®°æ¥åˆ›å»ºä¸€ä¸ªåŠ è½½ dbdata æ•°æ®å·çš„å®¹å™¨,å¹¶ä»ä¸»æœºæŒ‚è½½å½“å‰ç›®å½•åˆ°å®¹å™¨çš„ /backup ç›®å½• .å‘½ä»¤å¦‚ä¸‹ï¼š $ sudo docker run --volumes-from dbdata -v$(pwd):/backup ubuntu tar cvf /backup/backup.tar /dbdata å®¹å™¨å¯åŠ¨å,ä½¿ç”¨äº† tar å‘½ä»¤æ¥å°† dbdata å·å¤‡ä»½ä¸ºå®¹å™¨ä¸­ /backup/backup.tar æ–‡ä»¶,ä¹Ÿå°±æ˜¯ä¸»æœºå½“å‰ç›®å½•ä¸‹çš„åä¸º backup.tar çš„æ–‡ä»¶ . æ¢å¤ å¦‚æœè¦æ¢å¤æ•°æ®åˆ°ä¸€ä¸ªå®¹å™¨,é¦–å…ˆåˆ›å»ºä¸€ä¸ªå¸¦æœ‰ç©ºæ•°æ®å·çš„å®¹å™¨ dbdata2 . $ docker run -v /dbdata --name dbdata2 ubuntu /bin/bash ç„¶ååˆ›å»ºå¦ä¸€ä¸ªå®¹å™¨,æŒ‚è½½ dbdata2 å®¹å™¨å·ä¸­çš„æ•°æ®å·,å¹¶ä½¿ç”¨ untar è§£å‹å¤‡ä»½æ–‡ä»¶åˆ°æŒ‚è½½çš„å®¹å™¨å·ä¸­ . $ sudo docker run --volumes-form dbdata2 -v $(pwd):/backup busybox tar xvf /backup/backup.tar ä¸ºäº†æŸ¥çœ‹/éªŒè¯æ¢å¤çš„æ•°æ®,å¯ä»¥å†å¯åŠ¨ä¸€ä¸ªå®¹å™¨æŒ‚è½½åŒæ ·çš„å®¹å™¨å·æ¥æŸ¥çœ‹ $ docker run --volumes-from dbdata2 busybox /bin/ls dbdata è¿ç§»æ•°æ®å· ä»£å†™ . . . Docker ä¸­çš„ç½‘ç»œ Docker å…è®¸é€šè¿‡å¤–éƒ¨è®¿é—®å®¹å™¨æˆ–å®¹å™¨äº’è”çš„æ–¹å¼æ¥æä¾›ç½‘ç»œæœåŠ¡ . ","date":"2017-07-17","objectID":"/posts/docker/:4:2","tags":["go","docker"],"title":"Docker åŸºç¡€çŸ¥è¯†å’ŒåŸºæœ¬æ“ä½œ","uri":"/posts/docker/"},{"categories":["Docker"],"content":"å¤–éƒ¨è®¿é—®å®¹å™¨ å®¹å™¨ä¸­å¯ä»¥ä¸è¿è¡Œä¸€äº›ç½‘ç»œåº”ç”¨,è¦è®©å¤–éƒ¨ä¹Ÿå¯ä»¥è®¿é—®è¿™äº›åº”ç”¨,å¯ä»¥é€šè¿‡ -P æˆ– -p å‚æ•°æ¥æŒ‡å®šç«¯å£æ˜ å°„ . å½“ä½¿ç”¨ -P å‚æ•°æ—¶,Docker ä¼šéšæœºæ˜ å°„ä¸€ä¸ª 49000~49900 çš„ç«¯å£åˆ°å†…éƒ¨å®¹å™¨å¼€æ”¾çš„ç½‘ç»œç«¯å£ . ä½¿ç”¨ docker ps å¯ä»¥çœ‹åˆ°,æœ¬åœ°ä¸»æœºçš„49155 è¢«æ˜ å°„åˆ°äº†å®¹å™¨çš„5000 ç«¯å£ . æ­¤æ—¶è®¿é—®æœ¬æœºçš„49155 ç«¯å£å³å¯è®¿é—®å®¹å™¨å†… web åº”ç”¨æä¾›çš„ç•Œé¢ . $ sudo docker run -d -P training/webapp python app.py $ sudo docker ps -l CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES bc533791f3f5 training/webapp:latest python app.py 5 seconds ag o Up 2 seconds 0.0.0.0:49155-\u003e5000/tcp nostalgic_morse -P ï¼ˆå°å†™ï¼‰åˆ™å¯ä»¥æŒ‡å®šè¦æ˜ å°„çš„ç«¯å£,å¹¶ä¸”åœ¨ä¸€ä¸ªæŒ‡å®šç«¯å£ä¸Šåªå¯ä»¥ç»‘å®šä¸€ä¸ªå®¹å™¨ .æ”¯æŒçš„æ ¼å¼æœ‰ ip:HostPort:containerPort ip::containerPort hostPort:containerPort ","date":"2017-07-17","objectID":"/posts/docker/:5:0","tags":["go","docker"],"title":"Docker åŸºç¡€çŸ¥è¯†å’ŒåŸºæœ¬æ“ä½œ","uri":"/posts/docker/"},{"categories":["Docker"],"content":"æ˜ å°„æ‰€æœ‰æ¥å£åœ°å€ ä½¿ç”¨ hostPort ï¼šcontainerPort æ ¼å¼æœ¬åœ°çš„5000ç«¯å£æ˜ å°„åˆ°å®¹å™¨çš„5000ç«¯å£,å¯ä»¥æ‰§è¡Œ $ docker run -d -p 5000:5000 training/webapp python app.py æ­¤æ—¶é»˜è®¤ä¼šç»‘å®šæœ¬åœ°æ‰€æœ‰æ¥å£ä¸Šçš„æ‰€æœ‰æ¥å£ . ","date":"2017-07-17","objectID":"/posts/docker/:5:1","tags":["go","docker"],"title":"Docker åŸºç¡€çŸ¥è¯†å’ŒåŸºæœ¬æ“ä½œ","uri":"/posts/docker/"},{"categories":["Docker"],"content":"æ˜ å°„åˆ°æŒ‡å®šåœ°å€çš„æŒ‡å®šç«¯å£ å¯ä»¥ä½¿ç”¨ ip:hostPort:containerPort æ ¼å¼æŒ‡å®šæ˜ å°„ä½¿ç”¨ä¸€ä¸ªç‰¹å®šåœ°å€,æ¯”å¦‚ localhost åœ°å€ 127.0.0.1 $ sudo docker run -d -p 127.0.0.1:5000:5000 training/webapp python app.py ","date":"2017-07-17","objectID":"/posts/docker/:5:2","tags":["go","docker"],"title":"Docker åŸºç¡€çŸ¥è¯†å’ŒåŸºæœ¬æ“ä½œ","uri":"/posts/docker/"},{"categories":["Docker"],"content":"æŸ¥çœ‹æ˜ å°„ç«¯å£é…ç½® ä½¿ç”¨ docker port æ¥æŸ¥çœ‹å½“å‰æ˜ å°„çš„ç«¯å£é…ç½®,ä¹Ÿå¯ä»¥æŸ¥çœ‹åˆ°ç»‘å®šçš„åœ°å€ $ docker port gogs 22/tcp -\u003e 0.0.0.0:10022 3000/tcp -\u003e 0.0.0.0:10080 å¯ä»¥çœ‹åˆ° gogs æœ‰ä¸¤ä¸ªå®¹å™¨å†…çš„ç«¯å£ 22, 3000 åˆ†åˆ«æ˜ å°„ä¸»æœºçš„10022,10080 ç«¯å£ . æ³¨ï¼š -p å¯ä»¥å¤šæ¬¡ä½¿ç”¨æ¥ç»‘å®šå¤šä¸ªç«¯å£,ä¹Ÿå°±æ˜¯è¯´ä¸€æ¡å‘½ä»¤å¯ä»¥æœ‰å¤šä¸ª -p ,å¦‚ï¼šä¸Šé¢ğŸ‘†çš„ gogs å®¹å™¨å°±ç»‘å®šäº†ä¿©ç«¯å£ ","date":"2017-07-17","objectID":"/posts/docker/:5:3","tags":["go","docker"],"title":"Docker åŸºç¡€çŸ¥è¯†å’ŒåŸºæœ¬æ“ä½œ","uri":"/posts/docker/"},{"categories":["Docker"],"content":"å®¹å™¨äº’è” å®¹å™¨çš„è¿æ¥ï¼ˆlinkingï¼‰ç³»ç»Ÿæ˜¯é™¤äº†ç«¯å£æ˜ å°„å¤–,å¦ä¸€ç§è·Ÿå®¹å™¨ä¸­åº”ç”¨äº¤äº’çš„æ–¹å¼ .è¯¥ç³»ç»Ÿä¼šåœ¨æºå’Œæ¥å—å®¹å™¨ä¹‹é—´åˆ›å»ºä¸€ä¸ªé€šé“,æ¥å—å®¹å™¨å¯ä»¥çœ‹åˆ°æºå®¹å™¨æŒ‡å®šçš„ä¿¡æ¯ . ","date":"2017-07-17","objectID":"/posts/docker/:6:0","tags":["go","docker"],"title":"Docker åŸºç¡€çŸ¥è¯†å’ŒåŸºæœ¬æ“ä½œ","uri":"/posts/docker/"},{"categories":["Docker"],"content":"è‡ªå®šä¹‰å®¹å™¨å‘½å è¿æ¥ç³»ç»Ÿä¾æ®å®¹å™¨çš„åç§°æ¥æ‰§è¡Œ .å› æ­¤,é¦–å…ˆéœ€è¦è‡ªå®šä¹‰ä¸€ä¸ªå¥½è®°çš„å®¹å™¨å‘½å . è™½ç„¶åˆ›å»ºå®¹å™¨çš„æ—¶å€™,ç³»ç»Ÿé»˜è®¤ä¼šåˆ†é…ç»™ä¸€ä¸ªåå­— .ä½†æ˜¯è‡ªå®šä¹‰å‘½åå®¹å™¨çš„è¯,ç¬¬ä¸€,å¥½è®°,ç¬¬äºŒ,å¯ä»¥ä½œä¸ºæœ‰ç”¨çš„å‚è€ƒçš„ . ä½¿ç”¨ --name å‚æ•°å¯ä»¥ä¸ºå®¹å™¨è‡ªå®šä¹‰å‘½å . $ docker run -d -p 8181:4040 --name own-cloud owncloud ä½¿ç”¨ docker ps æ¥æŸ¥çœ‹æ­£è¿è¡Œçš„å®¹å™¨ CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 2c2e766e86fd owncloud \"/entrypoint.sh ap...\" 23 hours ago Up 23 hours 80/tcp, 0.0.0.0:8181-\u003e4040/tcp own-cloud ä½¿ç”¨ docker inspect å‘½ä»¤æ¥æŸ¥çœ‹å®¹å™¨åå­— $ docker inspect -f \"{{.Name}}\" 2c2e766e86fd /own-cloud æ³¨ï¼šå®¹å™¨çš„åç§°æ˜¯å”¯ä¸€çš„ .å¦‚æœå·²ç»å‘½åäº†ä¸€ä¸ªå« own-cloud çš„å®¹å™¨,å½“ä½ å†æ¬¡ä½¿ç”¨è¿™ä¸ªåè¯çš„æ—¶å€™,éœ€è¦å…ˆæŠŠä¹‹å‰çš„çš„åŒåå®¹å™¨åˆ é™¤ tipsï¼šåœ¨æ‰§è¡Œ docker run çš„æ—¶å€™å¯ä»¥æ·»åŠ  â€”rm å‚æ•°,è¿™æ ·å®¹å™¨åœ¨ç»ˆæ­¢åç«‹åˆ»åˆ é™¤ .æ³¨æ„,â€”rm å’Œ -d å‚æ•°ä¸èƒ½åŒæ—¶ä½¿ç”¨ . ","date":"2017-07-17","objectID":"/posts/docker/:6:1","tags":["go","docker"],"title":"Docker åŸºç¡€çŸ¥è¯†å’ŒåŸºæœ¬æ“ä½œ","uri":"/posts/docker/"},{"categories":["Docker"],"content":"å®¹å™¨äº’è” ä½¿ç”¨ --link å‚æ•°å¯ä»¥è®©å®¹å™¨ä¹‹é—´å®‰å…¨çš„è¿›è¡Œäº¤äº’ . ä¸‹é¢æ˜¯,è¿è¡Œ Nginx å®¹å™¨çš„æ—¶å€™æŠŠ gogs è¿™ä¸ªå®¹å™¨è¿æ¥ä¸Š docker run -d --name my_nginx --link gogs:app --link own-cloud:app2 -p 80:80 -v /root/nginx/config:/etc/nginx/conf.d nginx æ­¤æ—¶,gogs å®¹å™¨å’Œ my_nginx å®¹å™¨å»ºç«‹äº’è”å…³ç³» --link å‚æ•°çš„æ ¼å¼ä¸º --link name:alias ,å…¶ä¸­ name æ˜¯è¦è¿æ¥çš„å®¹å™¨åç§°, alias æ˜¯è¿™ä¸ªè¿æ¥çš„åˆ«å . å¯ä»¥é€šè¿‡ docker inspect å‘½ä»¤æŸ¥çœ‹ my_nginx å®¹å™¨ä¿¡æ¯,å°±ä¼šå‘ç°æœ‰è¿™ä¹ˆä¸€æ®µä¿¡æ¯ \"Links\": [ \"/gogs:/trusting_brown/app\", \"/own-cloud:/trusting_brown/app2\" ], è¡¨é¢æ­¤å®¹å™¨å·²ç»è¿ä¸Šä¸¤ä¸ªå®¹å™¨, gogs å’Œ own-cloud,trusting_brown æ˜¯ç³»ç»Ÿåˆ†é…ç»™ Nginx çš„åç§°,è¿æ¥åç§°åˆ†åˆ«æ˜¯ app å’Œ app2 . Docker åœ¨ä¸¤ä¸ªäº’è”çš„å®¹å™¨ä¹‹é—´åˆ›å»ºäº†ä¸€ä¸ªå®‰å…¨çš„éš§é“,è€Œä¸”ä¸ç”¨æ˜ å°„åˆ°å®ƒä»¬çš„ç«¯å£åˆ°ä¸»æœºä¸Š .åœ¨å¯åŠ¨è¢«è¿æ¥çš„å®¹å™¨çš„æ—¶å€™ä¸ç”¨æ·»åŠ  -p æˆ– -P å‚æ•°,ä»è€Œé¿å…æš´éœ²ç«¯å£åˆ°å¤–éƒ¨ç½‘ç»œä¸Š . è¿æ¥ä¹‹å,åœ¨ Nginx å®¹å™¨é‡Œ,å°±ä¼šå‘ç”Ÿä¸¤ä¸ªå˜åŒ– . ä¸€æ˜¯ç¯å¢ƒå˜é‡ .åœ¨ Nginx å®¹å™¨ä¸­ä¼šå‡ºç°6ä¸ªæ–°å¢çš„ç¯å¢ƒå˜é‡,è¿™äº›ç¯å¢ƒå˜é‡çš„åç§°åˆ†è´æ—¶ç”±è¢«è¿æ¥çš„æœåŠ¡åˆ«åã€ç«¯å£ç­‰æ‹¼æ¥è€Œæˆçš„ . ç”±äºèµ·å¾— gogs å®¹å™¨æœ‰ä¸¤ä¸ªç«¯å£,æ‰€ä»¥å…¶ä¸­ APP_PORTã€APP_NAMEã€APP_ENV_GOGS_CUSTOM æ˜¯å…¬ç”¨çš„,å…¶å®ƒ8ä¸ªå˜é‡æ¯å››ä¸ªçš„åˆ†åˆ«å¯¹åº”22, 3000 ç«¯å£ # env | grep APP APP_PORT_3000_TCP=tcp://172.17.0.2:3000 APP_PORT_22_TCP_PROTO=tcp APP_ENV_GOGS_CUSTOM=/data/gogs APP_PORT_3000_TCP_ADDR=172.17.0.2 APP_PORT_3000_TCP_PROTO=tcp APP_PORT_22_TCP_PORT=22 APP_PORT_3000_TCP_PORT=3000 APP_PORT=tcp://172.17.0.2:22 APP_NAME=/my_nginx/app APP_PORT_22_TCP=tcp://172.17.0.2:22 APP_PORT_22_TCP_ADDR=172.17.0.2 äºŒæ˜¯ hosts æ–‡ä»¶ .åœ¨ Nginx å®¹å™¨çš„ hosts æ–‡ä»¶çœ‹åˆ°ä¸‹é¢çš„è®°å½• .è¿™å°±æ˜¯è¯´,ä¸€åˆ‡è®¿é—® è¿æ¥åˆ«åï¼ˆappï¼‰ã€å®¹å™¨ IDï¼ˆac4c0cf35adfï¼‰å’Œå®¹å™¨åï¼ˆgogsï¼‰çš„è¯·æ±‚éƒ½ä¼šè¢«é‡æ–°å¯¼å‘åˆ°å®æ—¶å®é™…çš„ app çš„ ip åœ°å€ä¸Š . # cat /etc/hosts | grep app 172.17.0.2 app ac4c0cf35adf gogs ","date":"2017-07-17","objectID":"/posts/docker/:6:2","tags":["go","docker"],"title":"Docker åŸºç¡€çŸ¥è¯†å’ŒåŸºæœ¬æ“ä½œ","uri":"/posts/docker/"},{"categories":["Docker"],"content":"é«˜çº§ç½‘ç»œé…ç½® å½“ Docker å¯åŠ¨æ—¶,ä¼šè‡ªåŠ¨çš„ä¸»æœºä¸Šåˆ›å»ºä¸€ä¸ª docker0 è™šæ‹Ÿç½‘æ¡¥,å®é™…ä¸Šæ˜¯ Linux çš„ä¸€ä¸ª bridge,å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªè½¯ä»¶äº¤æ¢æœº .å®ƒä¼šæŒ‚è½½åˆ°å®ƒçš„ç½‘å£ä¹‹é—´è¿›è¡Œè½¬å‘ . $ ip addr | grep docker0 docker0: \u003cBROADCAST,MULTICAST,UP,LOWER_UP\u003e mtu 1500 qdisc noqueue state UP link/ether 02:42:23:c6:3f:1c brd ff:ff:ff:ff:ff:ff inet 172.17.0.1/16 scope global docker0 valid_lft forever preferred_lft forever inet6 fe80::42:23ff:fec6:3f1c/64 scope link valid_lft forever preferred_lft forever åŒæ—¶,Docker éšæœºåˆ†ä¸€ä¸ªæœ¬åœ°æœªå ç”¨çš„ç§æœ‰ç½‘æ®µï¼ˆåœ¨ RFC1919 ä¸­å®šä¹‰ï¼‰ä¸­çš„ä¸€ä¸ªåœ°å€ç»™ docker0 æ¥å£ .æ¯”å¦‚æˆ‘çš„ä¸»æœºä¸Šçš„ docker0 ip ä¸º 172.17.0.1 ,æ©ç ä¸º 255.255.0.0 .æ­¤åå¯åŠ¨çš„å®¹å™¨å†…çš„ç½‘å£ä¹Ÿä¼šè‡ªåŠ¨åˆ†é…æœ‰ä¸ªä¸€ä¸ªåŒä¸€ç½‘æ®µï¼ˆ172.17.0.0/16ï¼‰çš„åœ°å€ . å½“åˆ›å»ºä¸€ä¸ª Docker å®¹å™¨çš„æ—¶å€™,åŒæ—¶ä¼šåˆ›å»ºä¸€å¯¹ vath pair æ¥å£ï¼ˆå½“æ•°æ®åŒ…å‘é€åˆ°ä¸€ä¸ªæ¥å£,å¦ä¸€ä¸ªæ¥å£ä¹Ÿå¯ä»¥æ”¶åˆ°ç›¸åŒçš„æ•°æ®åŒ…ï¼‰ .è¿™å¯¹æ¥å£ä¸€æ®µåœ¨å®¹å™¨å†…,å³ eth0 ï¼›å¦ä¸€ç«¯åœ¨æœ¬åœ°å¹¶æŒ‚è½½åˆ° docker0 ç½‘æ¡¥,åç§°ä»¥ veth å¼€å¤´ .é€šè¿‡è¿™ç§æ–¹å¼,ä¸»æœºå¯ä»¥è·Ÿå®¹å™¨é€šä¿¡,å®¹å™¨ä¹‹é—´ä¹Ÿå¯ä»¥ç›¸äº’é€šä¿¡ . Docker å°±åˆ›å»ºäº†åœ¨ä¸»æœºå’Œæ‰€æœ‰å®¹å™¨ä¹‹é—´ä¸€ä¸ªè™šæ‹Ÿå…±äº«ç½‘ç»œ . â€‹ å›¾ i.i docker ç½‘ç»œ æ¥ä¸‹æ¥éƒ¨åˆ†å°†ä»‹ç»åœ¨ä¸€äº›åœºæ™¯ä¸­,Docker æ‰€æœ‰çš„ç½‘ç»œå®šåˆ¶é…ç½® .ä»¥åŠé€šè¿‡ Linux å‘½ä»¤æ¥è°ƒæ•´ã€è¡¥å……ã€ç”šè‡³æ›¿æ¢ Docker é»˜è®¤çš„ç½‘ç»œé…ç½® . ","date":"2017-07-17","objectID":"/posts/docker/:7:0","tags":["go","docker"],"title":"Docker åŸºç¡€çŸ¥è¯†å’ŒåŸºæœ¬æ“ä½œ","uri":"/posts/docker/"},{"categories":["Docker"],"content":"å¿«é€Ÿé…ç½® ä¸‹é¢æ˜¯ä¸€ä¸ªè·Ÿ Docker ç½‘ç»œç›¸å…³çš„å‘½ä»¤åˆ—è¡¨ . å…¶ä¸­æœ‰äº›å‘½ä»¤é€‰é¡¹åªæœ‰åœ¨ Docker æœåŠ¡å¯åŠ¨çš„æ—¶å€™æ‰èƒ½é…ç½®,è€Œä¸”ä¸èƒ½é©¬ä¸Šç”Ÿæ•ˆ . -b BRIDGE or --bridge==BRIDGE â€“æŒ‡å®šå®¹å™¨æŒ‚è½½çš„ç½‘æ¡¥ --bip=CIDR â€” å®šåˆ¶ docker0 çš„æ©ç  -H SOCKET... or --host=SOCKETâ€¦ â€”Docker æœåŠ¡ç«¯æ¥å—å‘½ä»¤çš„é€šé“ --icc=true|false â€“æ˜¯å¦æ”¯æŒå®¹å™¨ä¹‹é—´è¿›è¡Œé€šä¿¡ --ip-forward=true|false â€”å®¹å™¨æ˜¯å¦èƒ½è®¿é—®å¤–ç½‘ï¼ˆè¯¦ç»†è§£æè¯·çœ‹ä¸‹æ–‡çš„å®¹å™¨é€šä¿¡ï¼‰ --iptables=true|false â€“æ˜¯å¦å…è®¸ Docker æ·»åŠ  iptables è§„åˆ™ --mtu=BYTES â€”å®¹å™¨ç½‘ç»œä¸­çš„ MTU ä¸‹é¢çš„ä¸¤ä¸ªå‘½ä»¤æ—¢å¯ä»¥åœ¨æœåŠ¡å¯åŠ¨æ—¶æŒ‡å®š,ä¹Ÿå¯ä»¥ Docker å®¹å™¨å¯åŠ¨ï¼ˆdocker run ï¼‰æ—¶å€™æŒ‡å®š . åœ¨ Docker æœåŠ¡å¯åŠ¨çš„æ—¶å€™æŒ‡å®šåˆ™ä¼šæˆä¸ºé»˜è®¤å€¼,åé¢æ‰§è¡Œdocker run æ—¶å¯ä»¥è¦†ç›–è®¾ç½®çš„é»˜è®¤å€¼ . --dns=IP_ADDRESSâ€¦ â€”ä½¿ç”¨æŒ‡å®šçš„ DNS æœåŠ¡å™¨ --dns-search=DOMAIN... æŒ‡å®š DNS æœç´¢åŸŸ æœ€åè¿™äº›é€‰é¡¹åªæœ‰åœ¨ docker run æ‰§è¡Œæ—¶ä½¿ç”¨,å› ä¸ºå®ƒæ˜¯é’ˆå¯¹å®¹å™¨çš„ç‰¹æ€§å†…å®¹ . -h HOSTNAME or --hostname=HOSTNAME â€“é…ç½®å®¹å™¨ä¸»æœºå --link=CONRATAINER_NAME:ALIAS â€”æ·»åŠ åˆ°å¦ä¸€ä¸ªå®¹å™¨çš„è¿æ¥ ","date":"2017-07-17","objectID":"/posts/docker/:7:1","tags":["go","docker"],"title":"Docker åŸºç¡€çŸ¥è¯†å’ŒåŸºæœ¬æ“ä½œ","uri":"/posts/docker/"},{"categories":["æºç è§£è¯»"],"content":"go çš„ interface çš„å®ç°å’ŒåŸç†ã€‚ Go interface ","date":"2017-06-08","objectID":"/posts/go-interface/:0:0","tags":["go"],"title":"GO interface","uri":"/posts/go-interface/"},{"categories":["æºç è§£è¯»"],"content":"interface åœ¨ Golang ä¸­ interface æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„æ¦‚å¿µå’Œç‰¹æ€§ã€‚ ","date":"2017-06-08","objectID":"/posts/go-interface/:1:0","tags":["go"],"title":"GO interface","uri":"/posts/go-interface/"},{"categories":["æºç è§£è¯»"],"content":"ä»€ä¹ˆæ˜¯ interfaceï¼Ÿ In object-oriented programming, a protocol or interface is a common means for unrelated objects to communicate with each other. These are definitions of methods and values which the objects agree upon in order to co-operate. â€” wikipedia è¿™æ˜¯ wikipedia å…³äº protocal çš„å®šä¹‰ï¼Œå°† interface ç±»æ¯”å¦‚ protocal æ˜¯ä¸€ç§éå¸¸åŠ©äºç†è§£çš„æ–¹å¼ã€‚protocolï¼Œä¸­æ–‡ä¸€èˆ¬å«åšåè®®ï¼Œæ¯”å¦‚ç½‘ç»œä¼ è¾“ä¸­çš„ TCP åè®®ã€‚protocol å¯ä»¥è®¤ä¸ºæ˜¯ä¸€ç§åŒæ–¹ä¸ºäº†äº¤æµè€Œåšå‡ºçš„çº¦å®šï¼Œinterface å¯ä»¥ç±»æ¯”å¦‚æ­¤ã€‚ åœ¨ Golang ä¸­ï¼Œinterface æ˜¯ä¸€ç§æŠ½è±¡ç±»å‹ï¼Œç›¸å¯¹äºæŠ½è±¡ç±»å‹çš„æ˜¯å…·ä½“ç±»å‹ï¼ˆconcrete typeï¼‰ï¼šintï¼Œstringã€‚å¦‚ä¸‹æ˜¯ io åŒ…é‡Œé¢çš„ä¾‹å­ã€‚ // Writer is the interface that wraps the basic Write method. // // Write writes len(p) bytes from p to the underlying data stream. // It returns the number of bytes written from p (0 \u003c= n \u003c= len(p)) // and any error encountered that caused the write to stop early. // Write must return a non-nil error if it returns n \u003c len(p). // Write must not modify the slice data, even temporarily. // // Implementations must not retain p. type Writer interface { Write(p []byte) (n int, err error) } // Closer is the interface that wraps the basic Close method. // // The behavior of Close after the first call is undefined. // Specific implementations may document their own behavior. type Closer interface { Close() error } åœ¨ Golang ä¸­ï¼Œinterface æ˜¯ä¸€ç»„ method çš„é›†åˆï¼Œæ˜¯ duck-type programming (é¸­å­ç±»å‹)çš„ä¸€ç§ä½“ç°ã€‚ä¸å…³å¿ƒå±æ€§ï¼ˆæ•°æ®ï¼‰ï¼Œåªå…³å¿ƒè¡Œä¸ºï¼ˆæ–¹æ³•ï¼‰ã€‚å…·ä½“ä½¿ç”¨ä¸­ä½ å¯ä»¥è‡ªå®šä¹‰è‡ªå·±çš„ structï¼Œå¹¶æä¾›ç‰¹å®šçš„ interface é‡Œé¢çš„ method å°±å¯ä»¥æŠŠå®ƒå½“æˆ interface æ¥ä½¿ç”¨ã€‚ä¸‹é¢æ˜¯ä¸€ç§ interface çš„å…¸å‹ç”¨æ³•ï¼Œå®šä¹‰å‡½æ•°çš„æ—¶å€™å‚æ•°å®šä¹‰æˆ interfaceï¼Œè°ƒç”¨å‡½æ•°çš„æ—¶å€™å°±å¯ä»¥åšåˆ°éå¸¸çš„çµæ´»ã€‚ type MyInterface interface{ Print() } func TestFunc(x MyInterface) {} type MyStruct struct {} func (me MyStruct) Print() {} func main() { var me MyStruct TestFunc(me) } ","date":"2017-06-08","objectID":"/posts/go-interface/:1:1","tags":["go"],"title":"GO interface","uri":"/posts/go-interface/"},{"categories":["æºç è§£è¯»"],"content":"ä¸ºä»€ä¹ˆ interface Gopher China ä¸Šç»™å‡ºäº†ä¸‹é¢çš„ä¸‰ä¸ªç†ç”±ï¼š writing generic algorithm ï¼ˆæ³›å‹ç¼–ç¨‹ï¼‰ hiding implementation detail ï¼ˆéšè—å…·ä½“å®ç°ï¼‰ providing interception points ï¼ˆæä¾›ç›‘å¬ç‚¹/æ‹¦æˆªç‚¹ï¼Ÿï¼‰ write generic algorithm ä¸¥æ ¼æ¥è¯´ï¼Œåœ¨ Golang ä¸­å¹¶ä¸æ”¯æŒæ³›å‹ç¼–ç¨‹ã€‚åœ¨ C++ ç­‰é«˜çº§è¯­è¨€ä¸­ä½¿ç”¨æ³›å‹ç¼–ç¨‹éå¸¸çš„ç®€å•ï¼Œæ‰€ä»¥æ³›å‹ç¼–ç¨‹ä¸€ç›´æ˜¯ Golang è¯Ÿç—…æœ€å¤šçš„åœ°æ–¹ã€‚ä½†æ˜¯ä½¿ç”¨ interface æˆ‘ä»¬å¯ä»¥å®ç°æ³›å‹ç¼–ç¨‹ï¼Œæˆ‘è¿™é‡Œç®€å•è¯´ä¸€ä¸‹ï¼Œå…·ä½“å¯ä»¥å‚è€ƒæˆ‘å‰é¢ç»™å‡ºæ¥çš„é‚£ç¯‡æ–‡ç« ã€‚æ¯”å¦‚æˆ‘ä»¬ç°åœ¨è¦å†™ä¸€ä¸ªæ³›å‹ç®—æ³•ï¼Œå½¢å‚å®šä¹‰é‡‡ç”¨ interface å°±å¯ä»¥äº†ï¼Œä»¥æ ‡å‡†åº“çš„ sort ä¸ºä¾‹ã€‚ package sort // A type, typically a collection, that satisfies sort.Interface can be // sorted by the routines in this package. The methods require that the // elements of the collection be enumerated by an integer index. type Interface interface { // Len is the number of elements in the collection. Len() int // Less reports whether the element with // index i should sort before the element with index j. Less(i, j int) bool // Swap swaps the elements with indexes i and j. Swap(i, j int) } ... // Sort sorts data. // It makes one call to data.Len to determine n, and O(n*log(n)) calls to // data.Less and data.Swap. The sort is not guaranteed to be stable. func Sort(data Interface) { // Switch to heapsort if depth of 2*ceil(lg(n+1)) is reached. n := data.Len() maxDepth := 0 for i := n; i \u003e 0; i \u003e\u003e= 1 { maxDepth++ } maxDepth *= 2 quickSort(data, 0, n, maxDepth) } Sort å‡½æ•°çš„å½¢å‚æ˜¯ä¸€ä¸ª interfaceï¼ŒåŒ…å«äº†ä¸‰ä¸ªæ–¹æ³•ï¼šLen()ï¼ŒLess(i,j int)ï¼ŒSwap(i, j int)ã€‚ä½¿ç”¨çš„æ—¶å€™ä¸ç®¡æ•°ç»„çš„å…ƒç´ ç±»å‹æ˜¯ä»€ä¹ˆç±»å‹ï¼ˆint, float, stringâ€¦ï¼‰ï¼Œåªè¦æˆ‘ä»¬å®ç°äº†è¿™ä¸‰ä¸ªæ–¹æ³•å°±å¯ä»¥ä½¿ç”¨ Sort å‡½æ•°ï¼Œè¿™æ ·å°±å®ç°äº†â€œæ³›å‹ç¼–ç¨‹â€ã€‚æœ‰ä¸€ç‚¹æ¯”è¾ƒéº»çƒ¦çš„æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦å°†æ•°ç»„è‡ªå®šä¹‰ä¸€ä¸‹ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚ type Person struct { Name string Age int } func (p Person) String() string { return fmt.Sprintf(\"%s: %d\", p.Name, p.Age) } // ByAge implements sort.Interface for []Person based on // the Age field. type ByAge []Person //è‡ªå®šä¹‰ func (a ByAge) Len() int { return len(a) } func (a ByAge) Swap(i, j int) { a[i], a[j] = a[j], a[i] } func (a ByAge) Less(i, j int) bool { return a[i].Age \u003c a[j].Age } func main() { people := []Person{ {\"Bob\", 31}, {\"John\", 42}, {\"Michael\", 17}, {\"Jenny\", 26}, } fmt.Println(people) sort.Sort(ByAge(people)) fmt.Println(people) } å¦å¤– Gopher China ä¸Šè¿˜æåˆ°äº†ä¸€ä¸ªæ¯”è¾ƒæœ‰è¶£çš„ä¸œè¥¿å’Œå¤§å®¶åˆ†äº«ä¸€ä¸‹ã€‚åœ¨æˆ‘ä»¬è®¾è®¡å‡½æ•°çš„æ—¶å€™ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¥½çš„å‡†åˆ™ã€‚ Be conservative in what you send, be liberal in what you accept. â€” Robustness Principle å¯¹åº”åˆ° Golang å°±æ˜¯ï¼š Return concrete types, receive interfaces as parameter. â€” Robustness Principle applied to Go è¯è¯´è¿™ä¹ˆè¯´ï¼Œä½†æ˜¯å½“æˆ‘ä»¬ç¿»é˜… Golang æºç çš„æ—¶å€™ï¼Œæœ‰äº›å‡½æ•°çš„è¿”å›å€¼ä¹Ÿæ˜¯ interfaceã€‚ hiding implement detail éšè—å…·ä½“å®ç°ï¼Œè¿™ä¸ªå¾ˆå¥½ç†è§£ã€‚æ¯”å¦‚æˆ‘è®¾è®¡ä¸€ä¸ªå‡½æ•°ç»™ä½ è¿”å›ä¸€ä¸ª interfaceï¼Œé‚£ä¹ˆä½ åªèƒ½é€šè¿‡ interface é‡Œé¢çš„æ–¹æ³•æ¥åšä¸€äº›æ“ä½œï¼Œä½†æ˜¯å†…éƒ¨çš„å…·ä½“å®ç°æ˜¯å®Œå…¨ä¸çŸ¥é“çš„ã€‚Francesc ä¸¾äº†ä¸ª context çš„ä¾‹å­ã€‚ context æœ€å…ˆç”± google æä¾›ï¼Œç°åœ¨å·²ç»çº³å…¥äº†æ ‡å‡†åº“ï¼Œè€Œä¸”åœ¨åŸæœ‰ context çš„åŸºç¡€ä¸Šå¢åŠ äº†ï¼šcancelCtxï¼ŒtimerCtxï¼ŒvalueCtxã€‚è¯­è¨€çš„è¡¨è¾¾æœ‰æ—¶å€™ç•¥æ˜¾è‹ç™½æ— åŠ›ï¼Œçœ‹ä¸€ä¸‹ context åŒ…çš„ä»£ç å§ã€‚ func WithCancel(parent Context) (ctx Context, cancel CancelFunc) { c := newCancelCtx(parent) propagateCancel(parent, \u0026c) return \u0026c, func() { c.cancel(true, Canceled) } } è¡¨æ˜ä¸Š WithCancel å‡½æ•°è¿”å›çš„è¿˜æ˜¯ä¸€ä¸ª Context interfaceï¼Œä½†æ˜¯è¿™ä¸ª interface çš„å…·ä½“å®ç°æ˜¯ cancelCtx structã€‚ // newCancelCtx returns an initialized cancelCtx. func newCancelCtx(parent Context) cancelCtx { return cancelCtx{ Context: parent, done: make(chan struct{}), } } // A cancelCtx can be canceled. When canceled, it also cancels any children // that implement canceler. type cancelCtx struct { Context //æ³¨æ„ä¸€ä¸‹è¿™ä¸ªåœ°æ–¹ done chan struct{} // closed by the first cancel call. mu sync.Mutex children map[canceler]struct{} // set to nil by the first cancel call err error // set to non-nil by the first cancel call } func (c *cancelCtx) Done() \u003c-chan struct{} { return c.done } func (c *cancelCtx) Err() error { c.mu.Lock() defer c.mu.Unlock() return c.err } func (c *cancelCtx) String() string { return fmt.Sprintf(\"%v.WithCancel\", c.Context) } å°½ç®¡å†…éƒ¨å®ç°ä¸Šä¸‹é¢ä¸‰ä¸ªå‡½æ•°è¿”å›çš„å…·ä½“ struct ï¼ˆéƒ½å®ç°äº† Context interfaceï¼‰ä¸åŒï¼Œä½†æ˜¯å¯¹äºä½¿ç”¨è€…æ¥è¯´æ˜¯å®Œå…¨æ— æ„ŸçŸ¥çš„ã€‚ func WithCancel(parent Context) (ctx Context, cancel CancelFunc) //è¿”å› cancelCtx func WithDeadline(parent Context, deadline time.Time) (Context, CancelFunc) //è¿”å› timerCtx func WithValue(parent Context, key, val interface{}) Context //è¿”å› valueCtx providing interception points è¿™é‡Œçš„ interception æƒ³è¡¨è¾¾çš„æ„æ€åº”è¯¥æ˜¯ wrapper æˆ–è€…è£…é¥°å™¨ï¼Œä»–ç»™å‡ºäº†ä¸€ä¸ªä¾‹å­å¦‚ä¸‹ï¼š type header struct { rt http.RoundTripper v map[string]string } func (h header) RoundTrip(r *htt","date":"2017-06-08","objectID":"/posts/go-interface/:1:2","tags":["go"],"title":"GO interface","uri":"/posts/go-interface/"},{"categories":["æºç è§£è¯»"],"content":"éä¾µå…¥å¼ ä»€ä¹ˆæ˜¯ä¾µå…¥å¼å‘¢ï¼Ÿæ¯”å¦‚ Java çš„ interface å®ç°éœ€è¦æ˜¾ç¤ºçš„å£°æ˜ã€‚ public class MyWriter implements io.Writer {} è¿™æ ·å°±æ„å‘³ç€å¦‚æœè¦å®ç°å¤šä¸ª interface éœ€è¦æ˜¾ç¤ºåœ°å†™å¾ˆå¤šéï¼ŒåŒæ—¶ package çš„ä¾èµ–è¿˜éœ€è¦è¿›è¡Œç®¡ç†ã€‚Dependency is evilã€‚æ¯”å¦‚æˆ‘è¦å®ç° io åŒ…é‡Œé¢çš„ Readerï¼ŒWriterï¼ŒReadWriter æ¥å£ï¼Œä»£ç å¯ä»¥åƒä¸‹é¢è¿™æ ·å†™ã€‚ type MyIO struct {} func (io *MyIO) Read(p []byte) (n int, err error) {...} func (io *MyIO) Write(p []byte) (n int, err error) {...} // io package type Reader interface { Read(p []byte) (n int, err error) } type Writer interface { Write(p []byte) (n int, err error) } type ReadWriter interface { Reader Writer } è¿™ç§å†™æ³•çœŸçš„å¾ˆæ–¹ä¾¿ï¼Œè€Œä¸”ä¸ç”¨å»æ˜¾ç¤ºçš„ import io packageï¼Œinterface åº•å±‚å®ç°çš„æ—¶å€™ä¼šåŠ¨æ€çš„æ£€æµ‹ã€‚è¿™æ ·ä¹Ÿä¼šå¼•å…¥ä¸€äº›é—®é¢˜ï¼š æ€§èƒ½ä¸‹é™ã€‚ä½¿ç”¨ interface ä½œä¸ºå‡½æ•°å‚æ•°ï¼Œruntime çš„æ—¶å€™ä¼šåŠ¨æ€çš„ç¡®å®šè¡Œä¸ºã€‚è€Œä½¿ç”¨ struct ä½œä¸ºå‚æ•°ï¼Œç¼–è¯‘æœŸé—´å°±å¯ä»¥ç¡®å®šäº†ã€‚ ä¸çŸ¥é“ struct å®ç°å“ªäº› interfaceã€‚è¿™ä¸ªé—®é¢˜å¯ä»¥ä½¿ç”¨ guru å·¥å…·æ¥è§£å†³ã€‚ ç»¼ä¸Šï¼ŒGolang interface çš„è¿™ç§éä¾µå…¥å®ç°çœŸçš„å¾ˆéš¾è¯´å®ƒæ˜¯å¥½ï¼Œè¿˜æ˜¯åã€‚ä½†æ˜¯å¯ä»¥è‚¯å®šçš„ä¸€ç‚¹æ˜¯ï¼Œå¯¹å¼€å‘äººå‘˜æ¥è¯´ä»£ç å†™èµ·æ¥æ›´ç®€å•äº†ã€‚ ","date":"2017-06-08","objectID":"/posts/go-interface/:1:3","tags":["go"],"title":"GO interface","uri":"/posts/go-interface/"},{"categories":["æºç è§£è¯»"],"content":"interface type assertion interface åƒå…¶ä»–ç±»å‹è½¬æ¢çš„æ—¶å€™ä¸€èˆ¬æˆ‘ä»¬ç§°ä½œæ–­è¨€ï¼Œä¸¾ä¸ªä¾‹å­ã€‚ func do(v interface{}) { n := v.(int) // might panic } è¿™æ ·å†™çš„åå¤„åœ¨äºï¼šä¸€æ—¦æ–­è¨€å¤±è´¥ï¼Œç¨‹åºå°†ä¼š panicã€‚ä¸€ç§é¿å… panic çš„å†™æ³•æ˜¯ä½¿ç”¨ type assertionã€‚ func do(v interface{}) { n, ok := v.(int) if !ok { // æ–­è¨€å¤±è´¥å¤„ç† } } å¯¹äº interface çš„æ“ä½œå¯ä»¥ä½¿ç”¨ reflect åŒ…æ¥å¤„ç†ï¼Œå…³äº reflect åŒ…çš„åŸç†å’Œä½¿ç”¨å¯ä»¥å‚è€ƒæˆ‘çš„æ–‡ç« ã€‚ ","date":"2017-06-08","objectID":"/posts/go-interface/:1:4","tags":["go"],"title":"GO interface","uri":"/posts/go-interface/"},{"categories":["æºç è§£è¯»"],"content":"æ€»ç»“ interface æ˜¯ Golang çš„ä¸€ç§é‡è¦çš„ç‰¹æ€§ï¼Œä½†æ˜¯è¿™æ˜¯ä»¥ runtime ä¸ºä»£ä»·çš„ï¼Œä¹Ÿå°±æ„å‘³ç€æ€§èƒ½çš„æŸå¤±ï¼ˆå…³äº interface çš„åº•å±‚å®ç°ä¹‹åæœ‰æ—¶é—´å†å†™ï¼‰ã€‚æŠ›å¼€æ€§èƒ½ä¸è°ˆï¼Œinterface å¯¹äºå¦‚ä½•è®¾è®¡æˆ‘ä»¬çš„ä»£ç ç¡®å®ç»™äº†ä¸€ä¸ªå¾ˆå¥½çš„æ€è€ƒã€‚ ","date":"2017-06-08","objectID":"/posts/go-interface/:1:5","tags":["go"],"title":"GO interface","uri":"/posts/go-interface/"},{"categories":["æºç è§£è¯»"],"content":"å‚è€ƒ Golang â€œæ³›å‹ç¼–ç¨‹â€ è°ˆä¸€è°ˆ Golang çš„ interface å’Œ reflect understanding golang interface(Gopher China) â€” youtube understanding golang interface(Gopher China) â€” slide ","date":"2017-06-08","objectID":"/posts/go-interface/:2:0","tags":["go"],"title":"GO interface","uri":"/posts/go-interface/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"go ä»£ç çš„ä¸€äº›è§„èŒƒå’Œå‘½åè§„åˆ™â€¦â€¦ Golang ä»£ç è§„èŒƒ ","date":"2017-06-04","objectID":"/posts/go-format/:0:0","tags":["go"],"title":"Go Format","uri":"/posts/go-format/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"é¡¹ç›®ç›®å½•ç»“æ„ PROJECT_NAME â”œâ”€â”€ README.md ä»‹ç»è½¯ä»¶åŠæ–‡æ¡£å…¥å£ â”œâ”€â”€ bin ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶,æ‰§è¡Œ./build.shè‡ªåŠ¨ç”Ÿæˆï¼Œè¯¥ç›®å½•ä¹Ÿç”¨äºç¨‹åºæ‰“åŒ… â”œâ”€â”€ build.sh è‡ªåŠ¨ç¼–è¯‘çš„è„šæœ¬ â”œâ”€â”€ doc è¯¥é¡¹ç›®çš„æ–‡æ¡£ â”œâ”€â”€ pack æ‰“åŒ…åçš„ç¨‹åºæ”¾åœ¨æ­¤å¤„ â”œâ”€â”€ pack.sh è‡ªåŠ¨æ‰“åŒ…çš„è„šæœ¬ï¼Œç”Ÿæˆç±»ä¼¼xxxx.20170713_14:45:35.tar.gzçš„æ–‡ä»¶ï¼Œæ”¾åœ¨packæ–‡ä»¶ä¸‹ â””â”€â”€ src è¯¥é¡¹ç›®çš„æºä»£ç  â”œâ”€â”€ main é¡¹ç›®ä¸»å‡½æ•° â”œâ”€â”€ model é¡¹ç›®ä»£ç  â”œâ”€â”€ research åœ¨å®ç°è¯¥é¡¹ç›®ä¸­æ¢ç©¶çš„ä¸€äº›ç¨‹åº â””â”€â”€ vendor å­˜æ”¾goçš„åº“ â”œâ”€â”€ github.com/xxx ç¬¬ä¸‰æ–¹åº“ â””â”€â”€ xxx.com/obc å…¬å¸å†…éƒ¨çš„å…¬å…±åº“ é¡¹ç›®çš„ç›®å½•ç»“æ„å°½é‡åšåˆ°ç®€æ˜ã€å±‚æ¬¡æ˜ç¡®ã€‚ ","date":"2017-06-04","objectID":"/posts/go-format/:1:0","tags":["go"],"title":"Go Format","uri":"/posts/go-format/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"å‘½åè§„èŒƒ ","date":"2017-06-04","objectID":"/posts/go-format/:2:0","tags":["go"],"title":"Go Format","uri":"/posts/go-format/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"æ–‡ä»¶åå‘½åè§„èŒƒ ç”¨å°å†™ï¼Œå°½é‡è§åæ€ä¹‰ï¼Œçœ‹è§æ–‡ä»¶åå°±å¯ä»¥çŸ¥é“è¿™ä¸ªæ–‡ä»¶ä¸‹çš„å¤§æ¦‚å†…å®¹ï¼Œå¯¹äºæºä»£ç é‡Œçš„æ–‡ä»¶ï¼Œæ–‡ä»¶åè¦å¾ˆå¥½çš„ä»£è¡¨äº†ä¸€ä¸ªæ¨¡å—å®ç°çš„åŠŸèƒ½ã€‚ ","date":"2017-06-04","objectID":"/posts/go-format/:2:1","tags":["go"],"title":"Go Format","uri":"/posts/go-format/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"åŒ…å åŒ…åç”¨å°å†™ï¼Œä½¿ç”¨çŸ­å‘½åï¼Œå°½é‡ä¸è¦å’Œæ ‡å‡†åº“å†²çªã€‚ ","date":"2017-06-04","objectID":"/posts/go-format/:2:2","tags":["go"],"title":"Go Format","uri":"/posts/go-format/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"æ¥å£å å•ä¸ªå‡½æ•°çš„æ¥å£ä»¥ er ä½œä¸ºåç¼€ï¼Œå¦‚ Readerï¼Œ Writer æ¥å£çš„å®ç°åˆ™å»æ‰åç¼€ type Reader interface { Read(p []byte) (int, error) } ä¸¤ä¸ªå‡½æ•°çš„æ¥å£åç»¼åˆä¸¤ä¸ªå‡½æ•°å type WriteFlusher interface { Write([]byte) (int, error) Flush() error } ä¸‰ä¸ªä»¥ä¸Šå‡½æ•°çš„æ¥å£åï¼Œç±»ä¼¼äºç»“æ„ä½“å type Car interface { Start([]byte) Stop() error Recover() } ","date":"2017-06-04","objectID":"/posts/go-format/:2:3","tags":["go"],"title":"Go Format","uri":"/posts/go-format/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"å˜é‡ å…¨å±€å˜é‡ï¼šé‡‡ç”¨é©¼å³°å‘½åæ³•ï¼Œä»…é™åœ¨åŒ…å†…çš„å…¨å±€å˜é‡ï¼ŒåŒ…å¤–å¼•ç”¨éœ€è¦å†™æ¥å£ï¼Œæä¾›è°ƒç”¨ï¼› å±€éƒ¨å˜é‡ï¼šé©¼å³°å¼ï¼Œç¬¬ä¸€ä¸ªå•è¯çš„é¦–å­—æ¯å°å†™ï¼Œå¦‚æœ‰ä¸¤ä¸ªä»¥ä¸Šå•è¯ç»„æˆçš„å˜é‡åï¼Œç¬¬äºŒä¸ªå•è¯å¼€å§‹é¦–å­—æ¯å¤§å†™ã€‚ ","date":"2017-06-04","objectID":"/posts/go-format/:2:4","tags":["go"],"title":"Go Format","uri":"/posts/go-format/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"å¸¸é‡ å…¨å±€ï¼šé©¼å³°å‘½åï¼Œæ¯ä¸ªå•è¯çš„é¦–å­—æ¯å¤§å†™ å±€éƒ¨ï¼šä¸å˜é‡çš„é£æ ¼ä¸€æ · ","date":"2017-06-04","objectID":"/posts/go-format/:2:5","tags":["go"],"title":"Go Format","uri":"/posts/go-format/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"å‡½æ•°å å‡½æ•°åé‡‡ç”¨é©¼å³°å‘½åæ³•ï¼Œä¸è¦ä½¿ç”¨ä¸‹åˆ’çº¿ã€‚ ","date":"2017-06-04","objectID":"/posts/go-format/:3:0","tags":["go"],"title":"Go Format","uri":"/posts/go-format/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"import è§„èŒƒ importåœ¨å¤šè¡Œçš„æƒ…å†µä¸‹ï¼Œgoimports ä¼šè‡ªåŠ¨å¸®ä½ æ ¼å¼åŒ–ï¼Œåœ¨ä¸€ä¸ªæ–‡ä»¶é‡Œé¢å¼•å…¥äº†ä¸€ä¸ªpackageï¼Œå»ºè®®é‡‡ç”¨å¦‚ä¸‹æ ¼å¼ï¼š import ( \"fmt\" ) å¦‚æœä½ çš„åŒ…å¼•å…¥äº†ä¸‰ç§ç±»å‹çš„åŒ…ï¼Œæ ‡å‡†åº“åŒ…ï¼Œç¨‹åºå†…éƒ¨åŒ…ï¼Œç¬¬ä¸‰æ–¹åŒ…ï¼Œå»ºè®®é‡‡ç”¨å¦‚ä¸‹æ–¹å¼è¿›è¡Œç»„ç»‡ä½ çš„åŒ…ï¼š import { \"net\" \"strings\" \"github.com/astaxie/beego\" \"gopkg.in/mgo.v2\" \"myproject/models\" \"myproject/utils\" } é¡¹ç›®ä¸­æœ€å¥½ä¸è¦ä½¿ç”¨ç›¸å¯¹è·¯å¾„å¯¼å…¥åŒ…ï¼š // è¿™æ˜¯ä¸å¥½çš„å¯¼å…¥ import â€œ../netâ€ // è¿™æ˜¯æ­£ç¡®çš„åšæ³• import â€œxxxx.com/proj/netâ€ ","date":"2017-06-04","objectID":"/posts/go-format/:4:0","tags":["go"],"title":"Go Format","uri":"/posts/go-format/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"é”™è¯¯å¤„ç† errorä½œä¸ºå‡½æ•°çš„å€¼è¿”å›,å¿…é¡»å°½å¿«å¯¹errorè¿›è¡Œå¤„ç† é‡‡ç”¨ç‹¬ç«‹çš„é”™è¯¯æµè¿›è¡Œå¤„ç† ä¸è¦é‡‡ç”¨è¿™ç§æ–¹å¼ if err != nil { // error handling } else { // normal code } è€Œé‡‡ç”¨ä»¥ä¸‹æ–¹å¼ if err != nil { // error handling return // or continue, etc. } // normal code å¦‚æœè¿”å›å€¼éœ€è¦åˆå§‹åŒ–ï¼Œåˆ™é‡‡ç”¨ä»¥ä¸‹æ–¹å¼ x, err := f() if err != nil { // error handling return } // use x ","date":"2017-06-04","objectID":"/posts/go-format/:5:0","tags":["go"],"title":"Go Format","uri":"/posts/go-format/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"panic åœ¨é€»è¾‘å¤„ç†ä¸­ç¦ç”¨panic åœ¨ main åŒ…ä¸­åªæœ‰å½“å®åœ¨ä¸å¯è¿è¡Œçš„æƒ…å†µé‡‡ç”¨ panicï¼Œä¾‹å¦‚æ–‡ä»¶æ— æ³•æ‰“å¼€ï¼Œæ•°æ®åº“æ— æ³•è¿æ¥å¯¼è‡´ç¨‹åºæ— æ³• æ­£å¸¸è¿è¡Œï¼Œä½†æ˜¯å¯¹äºå…¶ä»–çš„ package å¯¹å¤–çš„æ¥å£ä¸èƒ½æœ‰ panicï¼Œåªèƒ½åœ¨åŒ…å†…é‡‡ç”¨ã€‚ å»ºè®®åœ¨ main åŒ…ä¸­ä½¿ç”¨ log.Fatal æ¥è®°å½•é”™è¯¯ï¼Œè¿™æ ·å°±å¯ä»¥ç”± log æ¥ç»“æŸç¨‹åºã€‚ ","date":"2017-06-04","objectID":"/posts/go-format/:5:1","tags":["go"],"title":"Go Format","uri":"/posts/go-format/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"Recover recover ç”¨äºæ•è· runtime çš„å¼‚å¸¸ï¼Œç¦æ­¢æ»¥ç”¨ recoverï¼Œåœ¨å¼€å‘æµ‹è¯•é˜¶æ®µå°½é‡ä¸è¦ç”¨ recoverï¼Œrecover ä¸€èˆ¬æ”¾åœ¨ä½ è®¤ä¸ºä¼šæœ‰ä¸å¯é¢„æœŸçš„å¼‚å¸¸çš„åœ°æ–¹ã€‚ func server(workChan \u003c-chan *Work) { for work := range workChan { go safelyDo(work) } } func safelyDo(work *Work) { defer func() { if err := recover(); err != nil { log.Println(\"work failed:\", err) } }() // do å‡½æ•°å¯èƒ½ä¼šæœ‰ä¸å¯é¢„æœŸçš„å¼‚å¸¸ do(work) } ","date":"2017-06-04","objectID":"/posts/go-format/:6:0","tags":["go"],"title":"Go Format","uri":"/posts/go-format/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"Defer defer åœ¨å‡½æ•° return ä¹‹å‰æ‰§è¡Œï¼Œå¯¹äºä¸€äº›èµ„æºçš„å›æ”¶ç”¨ defer æ˜¯å¥½çš„ï¼Œä½†ä¹Ÿç¦æ­¢æ»¥ç”¨ deferï¼Œdefer æ˜¯éœ€è¦æ¶ˆè€—æ€§èƒ½çš„,æ‰€ä»¥é¢‘ç¹è°ƒç”¨çš„å‡½æ•°å°½é‡ä¸è¦ä½¿ç”¨ deferã€‚ // Contents returns the file's contents as a string. func Contents(filename string) (string, error) { f, err := os.Open(filename) if err != nil { return \"\", err } defer f.Close() // f.Close will run when we're finished. var result []byte buf := make([]byte, 100) for { n, err := f.Read(buf[0:]) result = append(result, buf[0:n]...) // append is discussed later. if err != nil { if err == io.EOF { break } return \"\", err // f will be closed if we return here. } } return string(result), nil // f will be closed if we return here. } ","date":"2017-06-04","objectID":"/posts/go-format/:7:0","tags":["go"],"title":"Go Format","uri":"/posts/go-format/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"æ§åˆ¶ç»“æ„ ","date":"2017-06-04","objectID":"/posts/go-format/:8:0","tags":["go"],"title":"Go Format","uri":"/posts/go-format/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"if ifæ¥å—åˆå§‹åŒ–è¯­å¥ï¼Œçº¦å®šå¦‚ä¸‹æ–¹å¼å»ºç«‹å±€éƒ¨å˜é‡ if err := file.Chmod(0664); err != nil { return err } ","date":"2017-06-04","objectID":"/posts/go-format/:8:1","tags":["go"],"title":"Go Format","uri":"/posts/go-format/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"for é‡‡ç”¨çŸ­å£°æ˜å»ºç«‹å±€éƒ¨å˜é‡ sum := 0 for i := 0; i \u003c 10; i++ { sum += i } ","date":"2017-06-04","objectID":"/posts/go-format/:8:2","tags":["go"],"title":"Go Format","uri":"/posts/go-format/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"range å¦‚æœåªéœ€è¦ç¬¬ä¸€é¡¹ï¼ˆkeyï¼‰ï¼Œå°±ä¸¢å¼ƒç¬¬äºŒä¸ªï¼š for key := range m { if key.expired() { delete(m, key) } } å¦‚æœåªéœ€è¦ç¬¬äºŒé¡¹ï¼Œåˆ™æŠŠç¬¬ä¸€é¡¹ç½®ä¸ºä¸‹åˆ’çº¿ sum := 0 for _, value := range array { sum += value } ","date":"2017-06-04","objectID":"/posts/go-format/:8:3","tags":["go"],"title":"Go Format","uri":"/posts/go-format/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"return å°½æ—©returnï¼šä¸€æ—¦æœ‰é”™è¯¯å‘ç”Ÿï¼Œé©¬ä¸Šè¿”å› f, err := os.Open(name) if err != nil { return err } d, err := f.Stat() if err != nil { f.Close() return err } codeUsing(f, d) ","date":"2017-06-04","objectID":"/posts/go-format/:8:4","tags":["go"],"title":"Go Format","uri":"/posts/go-format/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"æ–¹æ³•æ¥æ”¶å™¨ åç§°ä¸€èˆ¬é‡‡ç”¨ struct çš„ç¬¬ä¸€ä¸ªå­—æ¯ä¸”ä¸ºå°å†™ï¼Œ è€Œä¸æ˜¯ thisï¼Œme æˆ– self type Transfer struct{} func(t *Transfer) Get() {} å¦‚æœæ¥æ”¶è€…æ˜¯ mapï¼Œ slice æˆ–è€… chanï¼Œä¸è¦ç”¨æŒ‡é’ˆä¼ é€’ //Map package main import ( \"fmt\" ) type mp map[string]string func (m mp) Set(k, v string) { m[k] = v } func main() { m := make(mp) m.Set(\"k\", \"v\") fmt.Println(m) } //Channel package main import ( \"fmt\" ) type ch chan interface{} func (c ch) Push(i interface{}) { c \u003c- i } func (c ch) Pop() interface{} { return \u003c-c } func main() { c := make(ch, 1) c.Push(\"i\") fmt.Println(c.Pop()) } å¦‚æœéœ€è¦å¯¹ slice è¿›è¡Œä¿®æ”¹ï¼Œé€šè¿‡è¿”å›å€¼çš„æ–¹å¼é‡æ–°å¤åˆ¶ //Slice package main import ( \"fmt\" ) type slice []byte func main() { s := make(slice, 0) s = s.addOne(42) fmt.Println(s) } func (s slice) addOne(b byte) []byte { return append(s, b) } å¦‚æœæ¥æ”¶è€…æ˜¯å«æœ‰ sync.Mutex æˆ–è€…ç±»ä¼¼åŒæ­¥å­—æ®µçš„ç»“æ„ä½“ï¼Œå¿…é¡»ä½¿ç”¨æŒ‡é’ˆä¼ é€’é¿å…å¤åˆ¶ package main import ( \"sync\" ) type T struct { m sync.Mutex } func (t *T) lock() { t.m.Lock() } /* Wrong !!! func (t T) lock() { t.m.Lock() } */ func main() { t := new(T) t.lock() } å¦‚æœæ¥æ”¶è€…æ˜¯å¤§çš„ç»“æ„ä½“æˆ–è€…æ•°ç»„ï¼Œä½¿ç”¨æŒ‡é’ˆä¼ é€’ä¼šæ›´æœ‰æ•ˆç‡ã€‚ package main import ( \"fmt\" ) type T struct { data [1024]byte } func (t *T) Get() byte { return t.data[0] } func main() { t := new(T) fmt.Println(t.Get()) } ","date":"2017-06-04","objectID":"/posts/go-format/:9:0","tags":["go"],"title":"Go Format","uri":"/posts/go-format/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"ä¸€é”®ä»£ç è§„èŒƒ ä½¿ç”¨ JetBrain ç³»åˆ— IDE çš„åŒå­¦ï¼Œå¯ä»¥æŒ‰å¿«æ·é”®æˆ–è€…é¼ æ ‡å³é”®æ¥ä¸€é”®ä½¿ç”¨ go æä¾›çš„ format å‘½ä»¤; å¿«æ·é”®ï¼š cmd + option + shift + f å¯¹å½“å‰æ–‡ä»¶è¿›è¡Œ format cmd + option + shift + p å¯¹å½“å‰é¡¹ç›®æ‰€æœ‰ go æ–‡ä»¶è¿›è¡Œ format é¼ æ ‡å³é”®ï¼š åœ¨ IDE å†…ç‚¹å‡»é¼ æ ‡å³é”®ï¼Œé€‰æ‹© Go Tools,ç„¶åå¯ä»¥é€‰æ‹©å¯¹å•ä¸ªæ–‡ä»¶æˆ–é¡¹ç›®è¿›è¡Œ formatã€‚ ç”¨ vscode çš„åŒå­¦ï¼Œåœ¨è®¾ç½®é‡Œé¢åŠ ä¸Šä»¥ä¸‹è¯­å¥å³å¯ä»¥ä¿å­˜æ–‡ä»¶åè‡ªåŠ¨è¿›è¡Œ format \"go.formatOnSave\": true ","date":"2017-06-04","objectID":"/posts/go-format/:10:0","tags":["go"],"title":"Go Format","uri":"/posts/go-format/"},{"categories":["ä»£ç è§„èŒƒ"],"content":"æ€»ç»“ ä»£ç é£æ ¼å’Œä»£ç è§„èŒƒæ˜¯ä½“ç°ä¸€ä¸ªç¨‹åºå‘˜çš„åŸºæœ¬ç´ è´¨çš„ä¸€é¡¹æŒ‡æ ‡ï¼Œä¹Ÿæ˜¯å¯¹è‡ªå·±çš„ä»£ç å’Œä»–äººçš„ä¸€ä¸ªæœ€åŸºæœ¬çš„å°Šé‡ã€‚ ","date":"2017-06-04","objectID":"/posts/go-format/:11:0","tags":["go"],"title":"Go Format","uri":"/posts/go-format/"},{"categories":null,"content":"Go æµ‹è¯•ç”¨ä¾‹ å¼€å‘ç¨‹åºå…¶ä¸­å¾ˆé‡è¦çš„ä¸€ç‚¹æ˜¯æµ‹è¯•ï¼Œæˆ‘ä»¬å¦‚ä½•ä¿è¯ä»£ç çš„è´¨é‡ï¼Œå¦‚ä½•ä¿è¯æ¯ä¸ªå‡½æ•°æ˜¯å¯è¿è¡Œï¼Œè¿è¡Œç»“æœæ˜¯æ­£ç¡®çš„ï¼Œåˆå¦‚ä½•ä¿è¯å†™å‡ºæ¥çš„ä»£ç æ€§èƒ½æ˜¯å¥½çš„ï¼Œæˆ‘ä»¬çŸ¥é“å•å…ƒæµ‹è¯•çš„é‡ç‚¹åœ¨äºå‘ç°ç¨‹åºè®¾è®¡æˆ–å®ç°çš„é€»è¾‘é”™è¯¯ï¼Œä½¿é—®é¢˜åŠæ—©æš´éœ²ï¼Œä¾¿äºé—®é¢˜çš„å®šä½è§£å†³ï¼Œè€Œæ€§èƒ½æµ‹è¯•çš„é‡ç‚¹åœ¨äºå‘ç°ç¨‹åºè®¾è®¡ä¸Šçš„ä¸€äº›é—®é¢˜ï¼Œè®©çº¿ä¸Šçš„ç¨‹åºèƒ½å¤Ÿåœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹è¿˜èƒ½ä¿æŒç¨³å®šã€‚æœ¬å°èŠ‚å°†å¸¦ç€è¿™ä¸€è¿ä¸²çš„é—®é¢˜æ¥è®²è§£Goè¯­è¨€ä¸­å¦‚ä½•æ¥å®ç°å•å…ƒæµ‹è¯•å’Œæ€§èƒ½æµ‹è¯•ã€‚ Goè¯­è¨€ä¸­è‡ªå¸¦æœ‰ä¸€ä¸ªè½»é‡çº§çš„æµ‹è¯•æ¡†æ¶testingå’Œè‡ªå¸¦çš„go testå‘½ä»¤æ¥å®ç°å•å…ƒæµ‹è¯•å’Œæ€§èƒ½æµ‹è¯•ï¼Œtestingæ¡†æ¶å’Œå…¶ä»–è¯­è¨€ä¸­çš„æµ‹è¯•æ¡†æ¶ç±»ä¼¼ï¼Œä½ å¯ä»¥åŸºäºè¿™ä¸ªæ¡†æ¶å†™é’ˆå¯¹ç›¸åº”å‡½æ•°çš„æµ‹è¯•ç”¨ä¾‹ï¼Œä¹Ÿå¯ä»¥åŸºäºè¯¥æ¡†æ¶å†™ç›¸åº”çš„å‹åŠ›æµ‹è¯•ç”¨ä¾‹ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥è®©æˆ‘ä»¬ä¸€ä¸€æ¥çœ‹ä¸€ä¸‹æ€ä¹ˆå†™ã€‚ å¦å¤–å»ºè®®å®‰è£…gotestsæ’ä»¶è‡ªåŠ¨ç”Ÿæˆæµ‹è¯•ä»£ç : go get -u -v github.com/cweill/gotests/... ","date":"2017-06-01","objectID":"/posts/go-test/:0:0","tags":["go"],"title":"GO test","uri":"/posts/go-test/"},{"categories":null,"content":"å¦‚ä½•ç¼–å†™æµ‹è¯•ç”¨ä¾‹ ç”±äºgo testå‘½ä»¤åªèƒ½åœ¨ä¸€ä¸ªç›¸åº”çš„ç›®å½•ä¸‹æ‰§è¡Œæ‰€æœ‰æ–‡ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¥ä¸‹æ¥æ–°å»ºä¸€ä¸ªé¡¹ç›®ç›®å½•gotest,è¿™æ ·æˆ‘ä»¬æ‰€æœ‰çš„ä»£ç å’Œæµ‹è¯•ä»£ç éƒ½åœ¨è¿™ä¸ªç›®å½•ä¸‹ã€‚ æ¥ä¸‹æ¥æˆ‘ä»¬åœ¨è¯¥ç›®å½•ä¸‹é¢åˆ›å»ºä¸¤ä¸ªæ–‡ä»¶ï¼šgotest.goå’Œgotest_test.go gotest.go:è¿™ä¸ªæ–‡ä»¶é‡Œé¢æˆ‘ä»¬æ˜¯åˆ›å»ºäº†ä¸€ä¸ªåŒ…ï¼Œé‡Œé¢æœ‰ä¸€ä¸ªå‡½æ•°å®ç°äº†é™¤æ³•è¿ç®—: package gotest import ( \"errors\" ) func Division(a, b float64) (float64, error) { if b == 0 { return 0, errors.New(\"é™¤æ•°ä¸èƒ½ä¸º0\") } return a / b, nil } gotest_test.go:è¿™æ˜¯æˆ‘ä»¬çš„å•å…ƒæµ‹è¯•æ–‡ä»¶ï¼Œä½†æ˜¯è®°ä½ä¸‹é¢çš„è¿™äº›åŸåˆ™ï¼š æ–‡ä»¶åå¿…é¡»æ˜¯_test.goç»“å°¾çš„ï¼Œè¿™æ ·åœ¨æ‰§è¡Œgo testçš„æ—¶å€™æ‰ä¼šæ‰§è¡Œåˆ°ç›¸åº”çš„ä»£ç  ä½ å¿…é¡»import testingè¿™ä¸ªåŒ… æ‰€æœ‰çš„æµ‹è¯•ç”¨ä¾‹å‡½æ•°å¿…é¡»æ˜¯Testå¼€å¤´ æµ‹è¯•ç”¨ä¾‹ä¼šæŒ‰ç…§æºä»£ç ä¸­å†™çš„é¡ºåºä¾æ¬¡æ‰§è¡Œ æµ‹è¯•å‡½æ•°TestXxx()çš„å‚æ•°æ˜¯testing.Tï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¯¥ç±»å‹æ¥è®°å½•é”™è¯¯æˆ–è€…æ˜¯æµ‹è¯•çŠ¶æ€ æµ‹è¯•æ ¼å¼ï¼šfunc TestXxx (t *testing.T),Xxxéƒ¨åˆ†å¯ä»¥ä¸ºä»»æ„çš„å­—æ¯æ•°å­—çš„ç»„åˆï¼Œä½†æ˜¯é¦–å­—æ¯ä¸èƒ½æ˜¯å°å†™å­—æ¯[a-z]ï¼Œä¾‹å¦‚Testintdivæ˜¯é”™è¯¯çš„å‡½æ•°åã€‚ å‡½æ•°ä¸­é€šè¿‡è°ƒç”¨testing.Tçš„Error, Errorf, FailNow, Fatal, FatalIfæ–¹æ³•ï¼Œè¯´æ˜æµ‹è¯•ä¸é€šè¿‡ï¼Œè°ƒç”¨Logæ–¹æ³•ç”¨æ¥è®°å½•æµ‹è¯•çš„ä¿¡æ¯ã€‚ ä¸‹é¢æ˜¯æˆ‘ä»¬çš„æµ‹è¯•ç”¨ä¾‹çš„ä»£ç ï¼š package gotest import ( \"testing\" ) func Test_Division_1(t *testing.T) { if i, e := Division(6, 2); i != 3 || e != nil { //try a unit test on function t.Error(\"é™¤æ³•å‡½æ•°æµ‹è¯•æ²¡é€šè¿‡\") // å¦‚æœä¸æ˜¯å¦‚é¢„æœŸçš„é‚£ä¹ˆå°±æŠ¥é”™ } else { t.Log(\"ç¬¬ä¸€ä¸ªæµ‹è¯•é€šè¿‡äº†\") //è®°å½•ä¸€äº›ä½ æœŸæœ›è®°å½•çš„ä¿¡æ¯ } } func Test_Division_2(t *testing.T) { t.Error(\"å°±æ˜¯ä¸é€šè¿‡\") } æˆ‘ä»¬åœ¨é¡¹ç›®ç›®å½•ä¸‹é¢æ‰§è¡Œgo test,å°±ä¼šæ˜¾ç¤ºå¦‚ä¸‹ä¿¡æ¯ï¼š --- FAIL: Test_Division_2 (0.00 seconds) gotest_test.go:16: å°±æ˜¯ä¸é€šè¿‡ FAIL exit status 1 FAIL gotest 0.013s ä»è¿™ä¸ªç»“æœæ˜¾ç¤ºæµ‹è¯•æ²¡æœ‰é€šè¿‡ï¼Œå› ä¸ºåœ¨ç¬¬äºŒä¸ªæµ‹è¯•å‡½æ•°ä¸­æˆ‘ä»¬å†™æ­»äº†æµ‹è¯•ä¸é€šè¿‡çš„ä»£ç t.Errorï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªå‡½æ•°æ‰§è¡Œçš„æƒ…å†µæ€ä¹ˆæ ·å‘¢ï¼Ÿé»˜è®¤æƒ…å†µä¸‹æ‰§è¡Œgo testæ˜¯ä¸ä¼šæ˜¾ç¤ºæµ‹è¯•é€šè¿‡çš„ä¿¡æ¯çš„ï¼Œæˆ‘ä»¬éœ€è¦å¸¦ä¸Šå‚æ•°go test -vï¼Œè¿™æ ·å°±ä¼šæ˜¾ç¤ºå¦‚ä¸‹ä¿¡æ¯ï¼š === RUN Test_Division_1 --- PASS: Test_Division_1 (0.00 seconds) gotest_test.go:11: ç¬¬ä¸€ä¸ªæµ‹è¯•é€šè¿‡äº† === RUN Test_Division_2 --- FAIL: Test_Division_2 (0.00 seconds) gotest_test.go:16: å°±æ˜¯ä¸é€šè¿‡ FAIL exit status 1 FAIL gotest 0.012s ä¸Šé¢çš„è¾“å‡ºè¯¦ç»†çš„å±•ç¤ºäº†è¿™ä¸ªæµ‹è¯•çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬çœ‹åˆ°æµ‹è¯•å‡½æ•°1Test_Division_1æµ‹è¯•é€šè¿‡ï¼Œè€Œæµ‹è¯•å‡½æ•°2Test_Division_2æµ‹è¯•å¤±è´¥äº†ï¼Œæœ€åå¾—å‡ºç»“è®ºæµ‹è¯•ä¸é€šè¿‡ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æŠŠæµ‹è¯•å‡½æ•°2ä¿®æ”¹æˆå¦‚ä¸‹ä»£ç ï¼š func Test_Division_2(t *testing.T) { if _, e := Division(6, 0); e == nil { //try a unit test on function t.Error(\"Division did not work as expected.\") // å¦‚æœä¸æ˜¯å¦‚é¢„æœŸçš„é‚£ä¹ˆå°±æŠ¥é”™ } else { t.Log(\"one test passed.\", e) //è®°å½•ä¸€äº›ä½ æœŸæœ›è®°å½•çš„ä¿¡æ¯ } } ç„¶åæˆ‘ä»¬æ‰§è¡Œgo test -vï¼Œå°±æ˜¾ç¤ºå¦‚ä¸‹ä¿¡æ¯ï¼Œæµ‹è¯•é€šè¿‡äº†ï¼š === RUN Test_Division_1 --- PASS: Test_Division_1 (0.00 seconds) gotest_test.go:11: ç¬¬ä¸€ä¸ªæµ‹è¯•é€šè¿‡äº† === RUN Test_Division_2 --- PASS: Test_Division_2 (0.00 seconds) gotest_test.go:20: one test passed. é™¤æ•°ä¸èƒ½ä¸º0 PASS ok gotest 0.013s ","date":"2017-06-01","objectID":"/posts/go-test/:1:0","tags":["go"],"title":"GO test","uri":"/posts/go-test/"},{"categories":null,"content":"å¦‚ä½•ç¼–å†™å‹åŠ›æµ‹è¯• å‹åŠ›æµ‹è¯•ç”¨æ¥æ£€æµ‹å‡½æ•°(æ–¹æ³•ï¼‰çš„æ€§èƒ½ï¼Œå’Œç¼–å†™å•å…ƒåŠŸèƒ½æµ‹è¯•çš„æ–¹æ³•ç±»ä¼¼,æ­¤å¤„ä¸å†èµ˜è¿°ï¼Œä½†éœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š å‹åŠ›æµ‹è¯•ç”¨ä¾‹å¿…é¡»éµå¾ªå¦‚ä¸‹æ ¼å¼ï¼Œå…¶ä¸­XXXå¯ä»¥æ˜¯ä»»æ„å­—æ¯æ•°å­—çš„ç»„åˆï¼Œä½†æ˜¯é¦–å­—æ¯ä¸èƒ½æ˜¯å°å†™å­—æ¯ func BenchmarkXXX(b *testing.B) { ... } go testä¸ä¼šé»˜è®¤æ‰§è¡Œå‹åŠ›æµ‹è¯•çš„å‡½æ•°ï¼Œå¦‚æœè¦æ‰§è¡Œå‹åŠ›æµ‹è¯•éœ€è¦å¸¦ä¸Šå‚æ•°-test.benchï¼Œè¯­æ³•:-test.bench=\"test_name_regex\",ä¾‹å¦‚go test -test.bench=\".*\"è¡¨ç¤ºæµ‹è¯•å…¨éƒ¨çš„å‹åŠ›æµ‹è¯•å‡½æ•° åœ¨å‹åŠ›æµ‹è¯•ç”¨ä¾‹ä¸­,è¯·è®°å¾—åœ¨å¾ªç¯ä½“å†…ä½¿ç”¨testing.B.N,ä»¥ä½¿æµ‹è¯•å¯ä»¥æ­£å¸¸çš„è¿è¡Œ æ–‡ä»¶åä¹Ÿå¿…é¡»ä»¥_test.goç»“å°¾ ä¸‹é¢æˆ‘ä»¬æ–°å»ºä¸€ä¸ªå‹åŠ›æµ‹è¯•æ–‡ä»¶webbench_test.goï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š package gotest import ( \"testing\" ) func Benchmark_Division(b *testing.B) { for i := 0; i \u003c b.N; i++ { //use b.N for looping Division(4, 5) } } func Benchmark_TimeConsumingFunction(b *testing.B) { b.StopTimer() //è°ƒç”¨è¯¥å‡½æ•°åœæ­¢å‹åŠ›æµ‹è¯•çš„æ—¶é—´è®¡æ•° //åšä¸€äº›åˆå§‹åŒ–çš„å·¥ä½œ,ä¾‹å¦‚è¯»å–æ–‡ä»¶æ•°æ®,æ•°æ®åº“è¿æ¥ä¹‹ç±»çš„, //è¿™æ ·è¿™äº›æ—¶é—´ä¸å½±å“æˆ‘ä»¬æµ‹è¯•å‡½æ•°æœ¬èº«çš„æ€§èƒ½ b.StartTimer() //é‡æ–°å¼€å§‹æ—¶é—´ for i := 0; i \u003c b.N; i++ { Division(4, 5) } } æˆ‘ä»¬æ‰§è¡Œå‘½ä»¤go test -file webbench_test.go -test.bench=\".*\"ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹ç»“æœï¼š PASS Benchmark_Division 500000000 7.76 ns/op Benchmark_TimeConsumingFunction 500000000 7.80 ns/op ok gotest 9.364s ä¸Šé¢çš„ç»“æœæ˜¾ç¤ºæˆ‘ä»¬æ²¡æœ‰æ‰§è¡Œä»»ä½•TestXXXçš„å•å…ƒæµ‹è¯•å‡½æ•°ï¼Œæ˜¾ç¤ºçš„ç»“æœåªæ‰§è¡Œäº†å‹åŠ›æµ‹è¯•å‡½æ•°ï¼Œç¬¬ä¸€æ¡æ˜¾ç¤ºäº†Benchmark_Divisionæ‰§è¡Œäº†500000000æ¬¡ï¼Œæ¯æ¬¡çš„æ‰§è¡Œå¹³å‡æ—¶é—´æ˜¯7.76çº³ç§’ï¼Œç¬¬äºŒæ¡æ˜¾ç¤ºäº†Benchmark_TimeConsumingFunctionæ‰§è¡Œäº†500000000ï¼Œæ¯æ¬¡çš„å¹³å‡æ‰§è¡Œæ—¶é—´æ˜¯7.80çº³ç§’ã€‚æœ€åä¸€æ¡æ˜¾ç¤ºæ€»å…±çš„æ‰§è¡Œæ—¶é—´ã€‚ ","date":"2017-06-01","objectID":"/posts/go-test/:2:0","tags":["go"],"title":"GO test","uri":"/posts/go-test/"},{"categories":null,"content":"å°ç»“ é€šè¿‡ä¸Šé¢å¯¹å•å…ƒæµ‹è¯•å’Œå‹åŠ›æµ‹è¯•çš„å­¦ä¹ ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°testingåŒ…å¾ˆè½»é‡ï¼Œç¼–å†™å•å…ƒæµ‹è¯•å’Œå‹åŠ›æµ‹è¯•ç”¨ä¾‹éå¸¸ç®€å•ï¼Œé…åˆå†…ç½®çš„go testå‘½ä»¤å°±å¯ä»¥éå¸¸æ–¹ä¾¿çš„è¿›è¡Œæµ‹è¯•ï¼Œè¿™æ ·åœ¨æˆ‘ä»¬æ¯æ¬¡ä¿®æ”¹å®Œä»£ç ,æ‰§è¡Œä¸€ä¸‹go testå°±å¯ä»¥ç®€å•çš„å®Œæˆå›å½’æµ‹è¯•äº†ã€‚ ","date":"2017-06-01","objectID":"/posts/go-test/:3:0","tags":["go"],"title":"GO test","uri":"/posts/go-test/"},{"categories":["åŸºç¡€çŸ¥è¯†"],"content":"GO æ–‡ä»¶æ“ä½œ åœ¨ä»»ä½•è®¡ç®—æœºè®¾å¤‡ä¸­ï¼Œæ–‡ä»¶æ˜¯éƒ½æ˜¯å¿…é¡»çš„å¯¹è±¡ï¼Œè€Œåœ¨Webç¼–ç¨‹ä¸­,æ–‡ä»¶çš„æ“ä½œä¸€ç›´æ˜¯Webç¨‹åºå‘˜ç»å¸¸é‡åˆ°çš„é—®é¢˜,æ–‡ä»¶æ“ä½œåœ¨Webåº”ç”¨ä¸­æ˜¯å¿…é¡»çš„,éå¸¸æœ‰ç”¨çš„,æˆ‘ä»¬ç»å¸¸é‡åˆ°ç”Ÿæˆæ–‡ä»¶ç›®å½•,æ–‡ä»¶(å¤¹)ç¼–è¾‘ç­‰æ“ä½œ,ç°åœ¨æˆ‘ä»¬æ¥çœ‹çœ‹ go å¯¹æ–‡ä»¶æ˜¯æ€ä¹ˆæ“ä½œçš„ã€‚ ","date":"2017-05-22","objectID":"/posts/go-file/:0:0","tags":["go"],"title":"Go æ–‡ä»¶æ“ä½œ","uri":"/posts/go-file/"},{"categories":["åŸºç¡€çŸ¥è¯†"],"content":"ç›®å½•æ“ä½œ æ–‡ä»¶æ“ä½œçš„å¤§å¤šæ•°å‡½æ•°éƒ½æ˜¯åœ¨osåŒ…é‡Œé¢ï¼Œä¸‹é¢åˆ—ä¸¾äº†å‡ ä¸ªç›®å½•æ“ä½œçš„ï¼š func Mkdir(name string, perm FileMode) error åˆ›å»ºåç§°ä¸ºnameçš„ç›®å½•ï¼Œæƒé™è®¾ç½®æ˜¯permï¼Œä¾‹å¦‚0777 func MkdirAll(path string, perm FileMode) error æ ¹æ®pathåˆ›å»ºå¤šçº§å­ç›®å½•ï¼Œä¾‹å¦‚ test/test1/test2ã€‚ func Remove(name string) error åˆ é™¤åç§°ä¸ºnameçš„ç›®å½•ï¼Œå½“ç›®å½•ä¸‹æœ‰æ–‡ä»¶æˆ–è€…å…¶ä»–ç›®å½•æ—¶ä¼šå‡ºé”™ func RemoveAll(path string) error æ ¹æ®pathåˆ é™¤å¤šçº§å­ç›®å½•ï¼Œå¦‚æœpathæ˜¯å•ä¸ªåç§°ï¼Œé‚£ä¹ˆè¯¥ç›®å½•ä¸‹çš„å­ç›®å½•å…¨éƒ¨åˆ é™¤ã€‚ ä»¥ä¸‹æ˜¯ç®€å•çš„ä½¿ç”¨ï¼š package main import ( \"fmt\" \"os\" ) func main() { os.Mkdir(\"test\", 0777) os.MkdirAll(\"test/test1/test2\", 0777) err := os.Remove(\"test\") if err != nil { fmt.Printf(\"crash with error %v \\n\", err) } os.RemoveAll(\"test\") } ","date":"2017-05-22","objectID":"/posts/go-file/:1:0","tags":["go"],"title":"Go æ–‡ä»¶æ“ä½œ","uri":"/posts/go-file/"},{"categories":["åŸºç¡€çŸ¥è¯†"],"content":"æ–‡ä»¶æ“ä½œ ","date":"2017-05-22","objectID":"/posts/go-file/:2:0","tags":["go"],"title":"Go æ–‡ä»¶æ“ä½œ","uri":"/posts/go-file/"},{"categories":["åŸºç¡€çŸ¥è¯†"],"content":"å»ºç«‹ä¸æ‰“å¼€æ–‡ä»¶ æ–°å»ºæ–‡ä»¶å¯ä»¥é€šè¿‡å¦‚ä¸‹ä¸¤ä¸ªæ–¹æ³• func Create(name string) (file *File, err Error) æ ¹æ®æä¾›çš„æ–‡ä»¶ååˆ›å»ºæ–°çš„æ–‡ä»¶ï¼Œè¿”å›ä¸€ä¸ªæ–‡ä»¶å¯¹è±¡ï¼Œé»˜è®¤æƒé™æ˜¯0666çš„æ–‡ä»¶ï¼Œè¿”å›çš„æ–‡ä»¶å¯¹è±¡æ˜¯å¯è¯»å†™çš„ã€‚ func NewFile(fd uintptr, name string) *File æ ¹æ®æ–‡ä»¶æè¿°ç¬¦åˆ›å»ºç›¸åº”çš„æ–‡ä»¶ï¼Œè¿”å›ä¸€ä¸ªæ–‡ä»¶å¯¹è±¡ é€šè¿‡å¦‚ä¸‹ä¸¤ä¸ªæ–¹æ³•æ¥æ‰“å¼€æ–‡ä»¶ï¼š func Open(name string) (file *File, err Error) è¯¥æ–¹æ³•æ‰“å¼€ä¸€ä¸ªåç§°ä¸ºnameçš„æ–‡ä»¶ï¼Œä½†æ˜¯æ˜¯åªè¯»æ–¹å¼ï¼Œå†…éƒ¨å®ç°å…¶å®è°ƒç”¨äº†OpenFileã€‚ func OpenFile(name string, flag int, perm uint32) (file *File, err Error) æ‰“å¼€åç§°ä¸ºnameçš„æ–‡ä»¶ï¼Œflagæ˜¯æ‰“å¼€çš„æ–¹å¼ï¼Œåªè¯»ã€è¯»å†™ç­‰ï¼Œpermæ˜¯æƒé™ ","date":"2017-05-22","objectID":"/posts/go-file/:2:1","tags":["go"],"title":"Go æ–‡ä»¶æ“ä½œ","uri":"/posts/go-file/"},{"categories":["åŸºç¡€çŸ¥è¯†"],"content":"å†™æ–‡ä»¶ å†™æ–‡ä»¶å‡½æ•°ï¼š func (file *File) Write(b []byte) (n int, err Error) å†™å…¥byteç±»å‹çš„ä¿¡æ¯åˆ°æ–‡ä»¶ func (file *File) WriteAt(b []byte, off int64) (n int, err Error) åœ¨æŒ‡å®šä½ç½®å¼€å§‹å†™å…¥byteç±»å‹çš„ä¿¡æ¯ func (file *File) WriteString(s string) (ret int, err Error) å†™å…¥stringä¿¡æ¯åˆ°æ–‡ä»¶ å†™æ–‡ä»¶çš„ç¤ºä¾‹ä»£ç  package main import ( \"fmt\" \"os\" ) func main() { userFile := \"yusank.txt\" fout, err := os.Create(userFile) if err != nil { fmt.Println(userFile, err) return } defer fout.Close() for i := 0; i \u003c 10; i++ { fout.WriteString(\"Just a test!\\r\\n\") fout.Write([]byte(\"Just a test!\\r\\n\")) } } ","date":"2017-05-22","objectID":"/posts/go-file/:2:2","tags":["go"],"title":"Go æ–‡ä»¶æ“ä½œ","uri":"/posts/go-file/"},{"categories":["åŸºç¡€çŸ¥è¯†"],"content":"è¯»æ–‡ä»¶ è¯»æ–‡ä»¶å‡½æ•°ï¼š func (file *File) Read(b []byte) (n int, err Error) è¯»å–æ•°æ®åˆ°bä¸­ func (file *File) ReadAt(b []byte, off int64) (n int, err Error) ä» off å¼€å§‹è¯»å–æ•°æ®åˆ° b ä¸­ è¯»æ–‡ä»¶çš„ç¤ºä¾‹ä»£ç : package main import ( \"fmt\" \"os\" ) func main() { userFile := \"yusank.txt\" fl, err := os.Open(userFile) if err != nil { fmt.Println(userFile, err) return } defer fl.Close() buf := make([]byte, 1024) for { n, _ := fl.Read(buf) if 0 == n { break } os.Stdout.Write(buf[:n]) } } ","date":"2017-05-22","objectID":"/posts/go-file/:2:3","tags":["go"],"title":"Go æ–‡ä»¶æ“ä½œ","uri":"/posts/go-file/"},{"categories":["åŸºç¡€çŸ¥è¯†"],"content":"åˆ é™¤æ–‡ä»¶ Goè¯­è¨€é‡Œé¢åˆ é™¤æ–‡ä»¶å’Œåˆ é™¤æ–‡ä»¶å¤¹æ˜¯åŒä¸€ä¸ªå‡½æ•° func Remove(name string) Error è°ƒç”¨è¯¥å‡½æ•°å°±å¯ä»¥åˆ é™¤æ–‡ä»¶åä¸ºnameçš„æ–‡ä»¶ ","date":"2017-05-22","objectID":"/posts/go-file/:2:4","tags":["go"],"title":"Go æ–‡ä»¶æ“ä½œ","uri":"/posts/go-file/"},{"categories":["åŸºç¡€çŸ¥è¯†"],"content":"è®¡ç®—æ–‡ä»¶å“ˆå¸Œå€¼ åœ¨ç½‘ç»œä¸Šä¼ è¾“æ–‡ä»¶å®Œæˆåï¼Œå¾€å¾€éƒ½ä¼šæœ‰ä¸€æ­¥æ–‡ä»¶çš„æ ¡éªŒã€‚éœ€è¦ç¡®è®¤ä¼ è¿‡æ¥çš„æ–‡ä»¶æ˜¯å¦æ˜¯æŸåçš„ã€‚ å°æ–‡ä»¶ ä»£ç ï¼š package main import ( \"crypto/md5\" \"fmt\" \"io\" \"os\" ) func main() { testFile := \"/path/to/file\" file, err := os.Open(testFile) if err != nil { fmt.Println(err) return } // ä»¥ä¸Šæ˜¯ä¸ºäº†è·çš„ os.File å¯¹è±¡ md5h := md5.New() io.Copy(md5h, file) fmt.Printf(\"%x\", md5h.Sum([]byte(\"\"))) // æ‰“å°å‡ºæ¥çš„æ˜¯ MD5 ç®—æ³•ä¸‹çš„å“ˆå¸Œç»“æœ } å¤§æ–‡ä»¶ ä»£ç ï¼š package main import ( \"crypto/md5\" \"fmt\" \"io\" \"math\" \"os\" ) const filechunk = 8192 // å‡å®š 8KB ä»¥ä¸Šä¸ºå¤§æ–‡ä»¶ func main() { file, err := os.Open(\"utf8.txt\") if err != nil { panic(err.Error()) } defer file.Close() // è®¡ç®—å¤§å° info, _ := file.Stat() filesize := info.Size() blocks := uint64(math.Ceil(float64(filesize) / float64(filechunk))) hash := md5.New() for i := uint64(0); i \u003c blocks; i++ { blocksize := int(math.Min(filechunk, float64(filesize-int64(i*filechunk)))) buf := make([]byte, blocksize) file.Read(buf) io.WriteString(hash, string(buf)) // append into the hash } fmt.Printf(\"%s checksum is %x\\n\", file.Name(), hash.Sum(nil)) } ä»£ç å†…å®¹æ˜¯æ‰“å¼€æœ¬åœ°æ–‡ä»¶åˆ†å—è¯»å–è¿›è¡Œå“ˆå¸Œè®¡ç®—ï¼Œåœ¨ç½‘ç»œä¼ è¾“ä¸­ï¼Œå¯ä»¥æ¯æ¬¡ä¼ å…¥ä¸€åŒ…çš„æ–‡ä»¶ï¼Œå…ˆç”¨ io.WriteString() æ–¹æ³•æ·»åŠ åˆ°å“ˆå¸Œå¹¶åœ¨æœ€åè¿›è¡Œ hash.Sum() æ“ä½œ ","date":"2017-05-22","objectID":"/posts/go-file/:2:5","tags":["go"],"title":"Go æ–‡ä»¶æ“ä½œ","uri":"/posts/go-file/"},{"categories":["ç½‘ç»œç¼–ç¨‹"],"content":"Unix ç½‘ç»œç¼–ç¨‹ â€‹ å·II - è¿›ç¨‹é—´é€šä¿¡ IPCæ˜¯è¿›ç¨‹é—´é€šä¿¡ï¼ˆinterprocess communicationï¼‰çš„ç®€ç§°ã€‚ä¼ ç»Ÿä¸Šè¯¥æœ¯è¯­æè¿°çš„æ˜¯è¿è¡Œåœ¨æŸä¸ªæ“ä½œç³»ç»Ÿä¹‹ä¸Šçš„ä¸åŒè¿›ç¨‹é—´å„ç§æ¶ˆæ¯ä¼ é€’ï¼ˆmessage passingï¼‰çš„æ–¹å¼ã€‚ è¿›ç¨‹é—´çš„é€šä¿¡ä¸€èˆ¬æ˜¯ä¸€ä¸‹å››ç§å½¢å¼ï¼š æ¶ˆæ¯ä¼ é€’ï¼ˆç®¡é“ã€FIFOå’Œæ¶ˆæ¯é˜Ÿåˆ—ï¼‰ï¼› åŒæ­¥ï¼ˆäº’æ–¥é‡ã€æ¡ä»¶å˜é‡ã€è¯»å†™é”ã€æ–‡ä»¶å’Œè®°å½•é”ã€ä¿¡å·é‡ï¼‰ï¼› å…±äº«å†…å­˜ï¼ˆåŒ¿åçš„å’Œå…·åçš„ï¼‰ï¼› è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼ˆSolaris é—¨å’Œ Sun RPCï¼‰ã€‚ æ¶ˆæ¯é˜Ÿåˆ— æ¶ˆæ¯ä¼ é€’ï¼š ç®¡é“å’ŒFIFOï¼› Posix æ¶ˆæ¯é˜Ÿåˆ—ï¼› System Væ¶ˆæ¯é˜Ÿåˆ—ã€‚ ","date":"2017-04-22","objectID":"/posts/unix-network/:0:0","tags":["unix"],"title":"Unix ç½‘ç»œç¼–ç¨‹","uri":"/posts/unix-network/"},{"categories":["ç½‘ç»œç¼–ç¨‹"],"content":"ç®¡é“å’ŒFIFO ç®¡é“æ˜¯æœ€åˆçš„Unix IPC å½¢å¼ã€‚ç”±äºç®¡é“æ²¡æœ‰åå­—ï¼Œæ‰€ä»¥å®ƒåªèƒ½ç”¨äºæœ‰äº²ç¼˜å…³ç³»çš„è¿›ç¨‹é—´çš„é€šä¿¡ã€‚ å®ç°æœºåˆ¶ï¼š ç®¡é“æ˜¯ç”±å†…æ ¸ç®¡ç†çš„ä¸€ä¸ªç¼“å†²åŒºï¼Œç›¸å½“äºæˆ‘ä»¬æ”¾å…¥å†…å­˜ä¸­çš„ä¸€ä¸ªçº¸æ¡ã€‚ç®¡é“çš„ä¸€ç«¯è¿æ¥ä¸€ä¸ªè¿›ç¨‹çš„è¾“å‡ºã€‚è¿™ä¸ªè¿›ç¨‹ä¼šå‘ç®¡é“ä¸­æ”¾å…¥ä¿¡æ¯ã€‚ç®¡é“çš„å¦ä¸€ç«¯è¿æ¥ä¸€ä¸ªè¿›ç¨‹çš„è¾“å…¥ï¼Œè¿™ä¸ªè¿›ç¨‹å–å‡ºè¢«æ”¾å…¥ç®¡é“çš„ä¿¡æ¯ã€‚ä¸€ä¸ªç¼“å†²åŒºä¸éœ€è¦å¾ˆå¤§ï¼Œå®ƒè¢«è®¾è®¡æˆä¸ºç¯å½¢çš„æ•°æ®ç»“æ„ï¼Œä»¥ä¾¿ç®¡é“å¯ä»¥è¢«å¾ªç¯åˆ©ç”¨ã€‚å½“ç®¡é“ä¸­æ²¡æœ‰ä¿¡æ¯çš„è¯ï¼Œä»ç®¡é“ä¸­è¯»å–çš„è¿›ç¨‹ä¼šç­‰å¾…ï¼Œç›´åˆ°å¦ä¸€ç«¯çš„è¿›ç¨‹æ”¾å…¥ä¿¡æ¯ã€‚å½“ç®¡é“è¢«æ”¾æ»¡ä¿¡æ¯çš„æ—¶å€™ï¼Œå°è¯•æ”¾å…¥ä¿¡æ¯çš„è¿›ç¨‹ä¼šç­‰å¾…ï¼Œç›´åˆ°å¦ä¸€ç«¯çš„è¿›ç¨‹å–å‡ºä¿¡æ¯ã€‚å½“ä¸¤ä¸ªè¿›ç¨‹éƒ½ç»ˆç»“çš„æ—¶å€™ï¼Œç®¡é“ä¹Ÿè‡ªåŠ¨æ¶ˆå¤±ã€‚ #include \u003cunistd.h\u003e int pipe (int fd[2]) //è¿”å›ï¼šè‹¥æˆåŠŸè¿”å›0ï¼Œè‹¥å‡ºé”™è¿”å›-1 è¯¥å‡½æ•°è¿”å›ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼šfd[0] å’Œ fd[1]ã€‚å‰è€…æ‰“å¼€æ¥è¯»ï¼Œåè€…æ‰“å¼€æ¥å†™ã€‚ ç®¡é“å°½ç®¡æ˜¯å•ä¸ªè¿›ç¨‹åˆ›å»ºï¼Œä½†æ˜¯ç®¡é“çš„å…¸å‹ç”¨é€”æ˜¯ä¸ºä¸¤ä¸ªä¸åŒçš„è¿›ç¨‹ï¼ˆä¸€ä¸ªçˆ¶è¿›ç¨‹ï¼Œä¸€ä¸ªå­è¿›ç¨‹ï¼‰æä¾›è¿›ç¨‹é—´çš„é€šä¿¡æ‰‹æ®µã€‚ â€‹ æ•°æ®æµ Â»Â»Â» é¦–å…ˆæ˜¯ï¼Œç”±ä¸€ä¸ªè¿›ç¨‹ï¼ˆå®ƒå°†æˆä¸ºçˆ¶è¿›ç¨‹ï¼‰åˆ›å»ºä¸€ä¸ª pipe åè°ƒç”¨ fork æ´¾ç”Ÿä¸€ä¸ªè‡ªèº«çš„å‰¯æœ¬ï¼Œæ¥ç€å…³é—­ç€ä¸ª pipe çš„è¯»æˆç«¯ï¼Œå­è¿›ç¨‹å…³é—­åŒä¸€ä¸ª pipe çš„å†™å…¥ç«¯ã€‚è¿™å°±æ˜¯è¿›ç¨‹é—´æä¾›äº†ä¸€ä¸ªå•å‘æ•°æ®æµï¼Œå¦‚ä¸‹å›¾ã€‚ int main(void) { int n; int fd[2]; pid_t pid; char line[MAXLINE]; if(pipe(fd) === 0){ // å…ˆå»ºç«‹ç®¡é“å¾—åˆ°ä¸€å¯¹æ–‡ä»¶æè¿°ç¬¦ exit(0); } if((pid = fork()) == 0) // çˆ¶è¿›ç¨‹æŠŠæ–‡ä»¶æè¿°ç¬¦å¤åˆ¶ç»™å­è¿›ç¨‹ exit(1); else if(pid \u003e 0){ // çˆ¶è¿›ç¨‹å†™ close(fd[0]); // å…³é—­è¯»æè¿°ç¬¦ write(fd[1], \"\\nhello world\\n\", 14); } else{ // å­è¿›ç¨‹è¯» close(fd[1]); // å…³é—­å†™ç«¯ n = read(fd[0], line, MAXLINE); write(STDOUT_FILENO, line, n); } exit(0); } technicallyï¼Œè‡ªä»å¯ä»¥åœ¨è¿›ç¨‹é—´ä¼ é€’æè¿°ç¬¦åï¼Œç®¡é“ä¹Ÿèƒ½ç”¨äºæ— äº²ç¼˜å…³ç³»çš„è¿›ç¨‹é—´ï¼Œè€Œç°å®ä¸­ç®¡é“é€šå¸¸ç”¨äºå…·æœ‰å…±åŒç¥–å…ˆçš„è¿›ç¨‹é—´ã€‚ FIFOï¼šå‘½åç®¡é“(named PIPE) ç®¡é“å°½ç®¡å¯¹å¾ˆå¤šæ“ä½œæ¥è¯´æ˜¯å¾ˆæœ‰ç”¨çš„ï¼Œä½†æ˜¯å®ƒçš„æ ¹æœ¬å±€é™æ€§åœ¨äºæ²¡æœ‰åå­—ï¼Œä»è€Œåªèƒ½ç”±äº²ç¼˜å…³ç³»çš„è¿›ç¨‹ï¼ˆçˆ¶å­è¿›ç¨‹ï¼‰ä½¿ç”¨ã€‚ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜ï¼ŒLinuxæä¾›äº†FIFOæ–¹å¼è¿æ¥è¿›ç¨‹ã€‚æœ‰äº†FIFOä¹‹åè¿™ä¸€ç¼ºç‚¹å¾—ä»¥æ”¹æ­£ã€‚FIFOæœ‰æ—¶ä¹Ÿç§°ä¹‹ä¸ºæœ‰åç®¡é“ï¼ˆnamed pipeï¼‰ã€‚FIFOé™¤äº†æœ‰ç®¡é“çš„åŠŸèƒ½å¤–ï¼Œå®ƒè¿˜å…è®¸æ— äº²ç¼˜å…³ç³»çš„è¿›ç¨‹çš„é€šä¿¡ã€‚pipe å’Œ FIFO éƒ½æ˜¯ä½¿ç”¨é€šå¸¸çš„ read å’Œ write å‡½æ•°è®¿é—®çš„ã€‚ FIFO (First in, First out)ä¸ºä¸€ç§ç‰¹æ®Šçš„æ–‡ä»¶ç±»å‹ï¼Œå®ƒåœ¨æ–‡ä»¶ç³»ç»Ÿä¸­æœ‰å¯¹åº”çš„è·¯å¾„ã€‚å½“ä¸€ä¸ªè¿›ç¨‹ä»¥è¯»(r)çš„æ–¹å¼æ‰“å¼€è¯¥æ–‡ä»¶ï¼Œè€Œå¦ä¸€ä¸ªè¿›ç¨‹ä»¥å†™(w)çš„æ–¹å¼æ‰“å¼€è¯¥æ–‡ä»¶ï¼Œé‚£ä¹ˆå†…æ ¸å°±ä¼šåœ¨è¿™ä¸¤ä¸ªè¿›ç¨‹ä¹‹é—´å»ºç«‹ç®¡é“ï¼Œæ‰€ä»¥FIFOå®é™…ä¸Šä¹Ÿç”±å†…æ ¸ç®¡ç†ï¼Œä¸ä¸ç¡¬ç›˜æ‰“äº¤é“ã€‚ä¹‹æ‰€ä»¥å«FIFOï¼Œæ˜¯å› ä¸ºç®¡é“æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—æ•°æ®ç»“æ„ï¼Œæœ€æ—©æ”¾å…¥çš„æ•°æ®è¢«æœ€å…ˆè¯»å‡ºæ¥ï¼Œä»è€Œä¿è¯ä¿¡æ¯äº¤æµçš„é¡ºåºã€‚FIFOåªæ˜¯å€Ÿç”¨äº†æ–‡ä»¶ç³»ç»Ÿ(file system,å‘½åç®¡é“æ˜¯ä¸€ç§ç‰¹æ®Šç±»å‹çš„æ–‡ä»¶ï¼Œå› ä¸ºLinuxä¸­æ‰€æœ‰äº‹ç‰©éƒ½æ˜¯æ–‡ä»¶ï¼Œå®ƒåœ¨æ–‡ä»¶ç³»ç»Ÿä¸­ä»¥æ–‡ä»¶åçš„å½¢å¼å­˜åœ¨ã€‚)æ¥ä¸ºç®¡é“å‘½åã€‚å†™æ¨¡å¼çš„è¿›ç¨‹å‘FIFOæ–‡ä»¶ä¸­å†™å…¥ï¼Œè€Œè¯»æ¨¡å¼çš„è¿›ç¨‹ä»FIFOæ–‡ä»¶ä¸­è¯»å‡ºã€‚å½“åˆ é™¤FIFOæ–‡ä»¶æ—¶ï¼Œç®¡é“è¿æ¥ä¹Ÿéšä¹‹æ¶ˆå¤±ã€‚FIFOçš„å¥½å¤„åœ¨äºæˆ‘ä»¬å¯ä»¥é€šè¿‡æ–‡ä»¶çš„è·¯å¾„æ¥è¯†åˆ«ç®¡é“ï¼Œä»è€Œè®©æ²¡æœ‰äº²ç¼˜å…³ç³»çš„è¿›ç¨‹ä¹‹é—´å»ºç«‹è¿æ¥ #include \u003csys/types.h\u003e #include \u003csys/stat.h\u003e int mkfifo (const char *pathname, mode_t mode); // è¿”å›ï¼š æˆåŠŸè¿”å›0ï¼Œå‡ºé”™è¿”å› -1 å…¶ä¸­ pathname æ˜¯ä¸€ä¸ªæ™®é€šçš„ Unix è·¯å¾„åï¼Œå®ƒæ˜¯è¯¥ FIFO çš„åå­—ã€‚ mkfifo å‡½æ•°ä¸­å‚æ•° mode æŒ‡å®š FIFO çš„è¯»å†™æƒé™ã€‚ mkfifo å‡½æ•°æ˜¯è¦ä¹ˆåˆ›å»ºä¸€ä¸ªæ–°çš„ FIFO ï¼Œè¦ä¹ˆè¿”å›ä¸€ä¸ª EEXIST é”™è¯¯ï¼ˆå¦‚æœè¯¥ FIFO å·²å­˜åœ¨ï¼‰ï¼Œå¦‚æœä¸å¸Œæœ›åˆ›å»ºä¸€ä¸ªæ–°çš„ FIFO é‚£å°±ç”¨ open å‡½æ•°å°±å¯ä»¥ã€‚ FIFO ä¸èƒ½æ‰“å¼€æ—¢å†™åˆè¯»ã€‚ å¦‚æœä¸€ä¸ª FIFO åªè¯»ä¸å†™ï¼Œåªå†™ä¸è¯»éƒ½ä¼šå½¢æˆé˜»å¡ã€‚ ä¸‹è¾¹æ˜¯ä¸€ä¸ªç®€å•åœ°ä¾‹å­ï¼š #include \u003cstdio.h\u003e #include \u003cstdlib.h\u003e #include \u003csys/types.h\u003e #include \u003csys/stat.h\u003e # define FIFO1 \"/tmp/my_fifo\" int main() { int res = mkfifo(\"/tmp/my_fifo\", 0777); if (res == 0) { printf(\"FIFO created/n\"); } // æ‰“å¼€FIFO //writefd = Open(FIFO1, O_WRONLY | O_NONBLOCK, 0) //readfd = Open(FIFO1, O_RDONLY, 0) exit(EXIT_SUCCESS); } open ç¬¬äºŒä¸ªå‚æ•°ä¸­çš„é€‰é¡¹O_NONBLOCKï¼Œé€‰é¡¹O_NONBLOCKè¡¨ç¤ºéé˜»å¡ï¼ŒåŠ ä¸Šè¿™ä¸ªé€‰é¡¹åï¼Œè¡¨ç¤ºopenè°ƒç”¨æ˜¯éé˜»å¡çš„ï¼Œå¦‚æœæ²¡æœ‰è¿™ä¸ªé€‰é¡¹ï¼Œåˆ™è¡¨ç¤ºopenè°ƒç”¨æ˜¯é˜»å¡çš„ã€‚ å¯¹äºä»¥åªè¯»æ–¹å¼ï¼ˆO_RDONLYï¼‰æ‰“å¼€çš„FIFOæ–‡ä»¶ï¼Œå¦‚æœopenè°ƒç”¨æ˜¯é˜»å¡çš„ï¼ˆå³ç¬¬äºŒä¸ªå‚æ•°ä¸ºO_RDONLYï¼‰ï¼Œé™¤éæœ‰ä¸€ä¸ªè¿›ç¨‹ä»¥å†™æ–¹å¼æ‰“å¼€åŒä¸€ä¸ªFIFOï¼Œå¦åˆ™å®ƒä¸ä¼šè¿”å›ï¼›å¦‚æœopenè°ƒç”¨æ˜¯éé˜»å¡çš„çš„ï¼ˆå³ç¬¬äºŒä¸ªå‚æ•°ä¸ºO_RDONLY|O_NONBLOCKï¼‰ï¼Œåˆ™å³ä½¿æ²¡æœ‰å…¶ä»–è¿›ç¨‹ä»¥å†™æ–¹å¼æ‰“å¼€åŒä¸€ä¸ªFIFOæ–‡ä»¶ï¼Œopenè°ƒç”¨å°†æˆåŠŸå¹¶ç«‹å³è¿”å›ã€‚ å¯¹äºä»¥åªå†™æ–¹å¼ï¼ˆO_WRONLYï¼‰æ‰“å¼€çš„FIFOæ–‡ä»¶ï¼Œå¦‚æœopenè°ƒç”¨æ˜¯é˜»å¡çš„ï¼ˆå³ç¬¬äºŒä¸ªå‚æ•°ä¸ºO_WRONLYï¼‰ï¼Œopenè°ƒç”¨å°†è¢«é˜»å¡ï¼Œç›´åˆ°æœ‰ä¸€ä¸ªè¿›ç¨‹ä»¥åªè¯»æ–¹å¼æ‰“å¼€åŒä¸€ä¸ªFIFOæ–‡ä»¶ä¸ºæ­¢ï¼›å¦‚æœopenè°ƒç”¨æ˜¯éé˜»å¡çš„ï¼ˆå³ç¬¬äºŒä¸ªå‚æ•°ä¸ºO_WRONLY|O_NONBLOCKï¼‰ï¼Œopenæ€»ä¼šç«‹å³è¿”å›ï¼Œä½†å¦‚æœæ²¡æœ‰å…¶ä»–è¿›ç¨‹ä»¥åªè¯»æ–¹å¼æ‰“å¼€åŒä¸€ä¸ªFIFOæ–‡ä»¶ï¼Œopenè°ƒç”¨å°†è¿”å›-1ï¼Œå¹¶ä¸”FIFOä¹Ÿä¸ä¼šè¢«æ‰“å¼€ã€‚ å…³äºç®¡é“æˆ– FIFO çš„è¯»å†™çš„è‹¥å¹²è§„åˆ™ï¼š å¦‚æœè¯·æ±‚è¯»å‡ºçš„æ•°æ®é‡å¤šäºç®¡é“æˆ– FIFO ä¸­å½“å‰çš„å¯ç”¨æ•°æ®é‡ï¼Œé‚£ä¹ˆåªä¼šè¿”å›è¿™äº›å¯ç”¨çš„æ•°æ®ã€‚ å¦‚æœè¯·æ±‚ä½ å†™å…¥çš„æ•°æ®çš„å­—èŠ‚æ•°å°äºæˆ–ç­‰äº PIPE_BUF (å¯åŸå­åœ°å†™å…¥å¾€ä¸€ä¸ªç®¡é“æˆ– FIFO çš„æœ€å¤§æ•°æ®é‡ï¼Œ Posix è¦æ±‚è‡³å°‘ä¸º512)ï¼Œé‚£ä¹ˆ write æ“ä½œä¿è¯æ˜¯åŸå­çš„ã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœä¸¤ä¸ªè¿›ç¨‹å·®ä¸å¤šåŒæ—¶å¾€åŒä¸€ä¸ªç®¡é“æˆ– FIFO å†™ï¼Œé‚£ä¹ˆä¸ç®¡æ˜¯å…ˆå†™å…¥æ¥è‡ªç¬¬ä¸€ä¸ªè¿›ç¨‹çš„æ‰€æœ‰æ•°æ®å†å†™ç¬¬äºŒä¸ªï¼Œè¿˜æ˜¯é¡ºåºé¢ å€’è¿‡æ¥ã€‚ç³»ç»Ÿéƒ½ä¸ä¼šç›¸äº’æ··æ‚æ¥è‡ªä¸¤ä¸ªè¿›ç¨‹çš„æ•°æ®ã€‚ç„¶è€Œå¦‚æœæ•°æ®çš„å­—èŠ‚æ•°å¤§äº PIPE_BUF ï¼Œé‚£ä¹ˆ write æ“ä½œä¸èƒ½ä¿è¯æ˜¯åŸå­çš„ã€‚ ä¸æ­¢ä»¥ä¸Šè¿™äº›ã€‚ã€‚ã€‚ å°ç»“ï¼š FIFO ä¸ç®¡é“ç±»ä¼¼ï¼Œä½†æ˜¯å®ƒç”¨ mkfifo åˆ›å»ºï¼Œä¹‹åéœ€è¦open æ‰“å¼€ã€‚æ‰“å¼€ç®¡é“å¿…é¡»å°å¿ƒï¼Œå› ä¸ºè®¸å¤šè§„åˆ™ï¼ˆread åªå†™ç®¡é“ã€write åªè¯»ç®¡é“ã€ä»ç©ºçš„ç®¡é“æˆ–FIFO read ç­‰çš„æƒ…å†µçš„è¿”å›ç»“æœã€‚ï¼‰åˆ¶çº¦ç€ open çš„é˜»å¡ä¸å¦ã€‚ ","date":"2017-04-22","objectID":"/posts/unix-network/:1:0","tags":["unix"],"title":"Unix ç½‘ç»œç¼–ç¨‹","uri":"/posts/unix-network/"},{"categories":["ç½‘ç»œç¼–ç¨‹"],"content":"Posix IPC Posixâ€“å¯ç§»æ¤æ€§æ“ä½œç³»ç»Ÿæ¥å£ï¼ˆProtable operating system interfaceï¼‰ æœ‰å…³Unixæ ‡å‡†åŒ–çš„å¤§å¤šæ•°æ´»åŠ¨æ˜¯ç”± Posix å’Œ Open Group åšçš„ã€‚ Posix ä¸æ˜¯å•ä¸€çš„æ ‡å‡†ï¼Œæ˜¯ä¸€ç³»åˆ—çš„æ ‡å‡†ã€‚ ä»¥ä¸‹ä¸‰ç§ç±»å‹çš„IPCåˆæˆä¸ºâ€œPosix IPCâ€ Posix æ¶ˆæ¯é˜Ÿåˆ— Posix ä¿¡å·é‡ Posix å…±äº«å†…å­˜åŒº ","date":"2017-04-22","objectID":"/posts/unix-network/:2:0","tags":["unix"],"title":"Unix ç½‘ç»œç¼–ç¨‹","uri":"/posts/unix-network/"},{"categories":["ç½‘ç»œç¼–ç¨‹"],"content":"Posix æ¶ˆæ¯é˜Ÿåˆ— æ¶ˆæ¯é˜Ÿåˆ—å¯è®¤ä¸ºæ˜¯ä¸ªæ¶ˆæ¯é“¾è¡¨ã€‚æœ‰è¶³å¤Ÿå†™æƒé™çš„è¿›ç¨‹å¯å¾€é˜Ÿåˆ—æ”¾ç½®ä¿¡æ¯ï¼Œæœ‰è¶³å¤Ÿè¯»æƒé™çš„è¿›ç¨‹å¯ä»é˜Ÿåˆ—è¯»å–ä¿¡æ¯ã€‚æ¯ä¸€ä¸ªä¿¡æ¯éƒ½æ˜¯ä¸€æ¡è®°å½•ï¼Œå®ƒæ˜¯ç”±å‘é€è€…èµ‹äºˆä¸€ä¸ªä¼˜å…ˆçº§ã€‚åœ¨æŸä¸ªè¿›ç¨‹å¾€ä¸€ä¸ªé˜Ÿåˆ—å†™å…¥æ¶ˆæ¯ä¹‹å‰ï¼Œå¹¶ä¸éœ€è¦å¦ä¸€ä¸ªè¿›ç¨‹åœ¨è¯¥é˜Ÿåˆ—ä¸Šç­‰å¾…æ¶ˆæ¯çš„åˆ°è¾¾ã€‚è¿™æ ¹ç®¡é“å’Œ FIFO æ˜¯ç›¸åçš„ã€‚ ä¸€ä¸ªè¿›ç¨‹å¯ä»¥å¾€æŸäº›é˜Ÿåˆ—å†™å…¥ä¸€äº›ä¿¡æ¯ï¼Œç„¶åç»ˆæ­¢ï¼Œå†è®©å¦å¤–ä¸€ä¸ªè¿›ç¨‹åœ¨ä»¥åçš„æŸä¸ªæ—¶åˆ»è¯»å–è¿™äº›ä¿¡æ¯ã€‚ Posix æ¶ˆæ¯é˜Ÿåˆ—å’Œä¸‹é¢è®²çš„System V æ¶ˆæ¯é˜Ÿåˆ—æœ‰è®¸å¤šçš„ç›¸ä¼¼æ€§ã€‚ä»¥ä¸‹æ˜¯ä¸»è¦çš„å·®åˆ«ï¼š å¯¹ Posix æ¶ˆæ¯é˜Ÿåˆ—çš„è¯»æ€»æ˜¯è¿”å›æœ€é«˜ä¼˜å…ˆçº§çš„æœ€æ—©æ¶ˆæ¯ï¼Œå¯¹ System V æ¶ˆæ¯é˜Ÿåˆ—çš„è¯»åˆ™å¯ä»¥è¿”å›ä»»æ„æŒ‡å®šä¼˜å…ˆçº§çš„æ¶ˆæ¯ï¼› å½“å¾€ä¸€ä¸ªç©ºé˜Ÿåˆ—æ”¾ç½®ä¸€ä¸ªä¿¡æ¯æ—¶ï¼ŒPosix æ¶ˆæ¯é˜Ÿåˆ—å…è®¸äº§ç”Ÿä¸€ä¸ªä¿¡å·æˆ–å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ï¼ŒSystem Væ¶ˆæ¯é˜Ÿåˆ—åˆ™æ˜¯ä¸æä¾›ç±»ä¼¼çš„æœºåˆ¶ã€‚ é˜Ÿåˆ—ä¸­çš„æ¯ä¸€ä¸ªæ¶ˆæ¯éƒ½æœ‰å¦‚ä¸‹å±æ€§ï¼š ä¸€ä¸ªæ— ç¬¦å·æ•´æ•°ä¼˜å…ˆçº§ï¼ˆPosixï¼‰æˆ– ä¸€ä¸ªé•¿æ•´æ•°ç±»å‹ï¼ˆsystem Vï¼‰ï¼› æ¶ˆæ¯çš„æ•°æ®éƒ¨åˆ†é•¿åº¦ï¼ˆå¯ä»¥ä¸º0ï¼‰ï¼› æ•°æ®æœ¬èº«ï¼ˆå¦‚æœé•¿åº¦å¤§äº0ï¼‰ã€‚ ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—çš„å¯èƒ½å¸ƒå±€ã€‚ æˆ‘ä»¬æ‰€è®¾æƒ³çš„æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œè¯¥é“¾è¡¨çš„æœ‰ä¸­å«æœ‰å½“å‰é˜Ÿåˆ—çš„ä¸¤ä¸ªå±æ€§ï¼šé˜Ÿåˆ—ä¸­å…è®¸çš„æœ€å¤§å¼€é”€æ•°ä»¥åŠæ¯ä¸€ä¸ªæ¶ˆæ¯çš„æœ€å¤§å¤§å°ã€‚ **mq_open ,mq_close å’Œ mq_unlink å‡½æ•° **ï¼š mq_open å‡½æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„æ¶ˆæ¯é˜Ÿåˆ—æˆ–æ‰“å¼€ä¸€ä¸ªå·²å­˜åœ¨çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚ # include \u003cmqueue.h\u003e mqd_t mq_open (const char *name, int oflag, ... /* mode_t mode, struct mq_attr *attr */); //è¿”å›ï¼š æˆåŠŸè¿”å›æ¶ˆæ¯å¯¹åˆ—æè¿°ç¬¦ï¼Œå‡ºé”™è¿”å›-1 å…¶ä¸­ name æœ‰è‡ªå·±çš„ä¸€å¥—å‘½åè§„åˆ™ï¼Œå› ä¸º Posix IPC ä½¿ç”¨â€œPosix IPC åå­—â€è¿›è¡Œæ ‡è¯†ã€‚ä¸ºæ–¹ä¾¿äºç§»æ¤èµ·è§ï¼ŒPosix IPC åå­—å¿…é¡»ä»¥æ–œæ ç¬¦å¼€å¤´å¹¶ä¸”ä¸èƒ½å†åŒ…å«ä»»ä½•æ–œæ ç¬¦ã€‚ oflag æ˜¯O_RDONLYã€O_WRONLY æˆ– O_RDWR ä¹‹ä¸€ï¼Œ å¯èƒ½æŒ‰ä½æˆ–ä¸ŠO_CREATE(è‹¥ä¸å­˜åœ¨åˆ™åˆ›å»º)ã€O_EXCL(ä¸O_CREATEä¸€èµ·ï¼Œè‹¥å·²å­˜åœ¨è¿”å›EEXIST é”™è¯¯)æˆ– O_NONBLOCKï¼ˆéé˜»å¡æ ‡è¯†ç¬¦ï¼‰ã€‚ å½“å®é™…æ“ä½œåˆ›å»ºä¸€ä¸ªæ–°çš„æ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼ˆæŒ‡å®šO_CREATEæ ‡å¿—ï¼Œä¸”è¯·æ±‚çš„é˜Ÿåˆ—ä¸å­˜åœ¨ï¼‰ï¼Œmode å’Œ attr å‚æ•°æ˜¯éœ€è¦çš„ã€‚modeä¸Šé¢ä»‹ç»è¿‡ã€‚attrå‚æ•°ç”¨äºç»™æ–°é˜Ÿåˆ—æŒ‡å®šæŸäº›å±æ€§ã€‚ mq_open è¿”å›å€¼ç§°ä¸ºæ¶ˆæ¯é˜Ÿåˆ—æè¿°ç¬¦ï¼ˆmessage queue descriptorï¼‰ï¼Œè¿™ä¸ªå€¼ç”¨ä½œå…¶ä»–æ¶ˆæ¯é˜Ÿåˆ—å‡½æ•°çš„ç¬¬ä¸€å‚æ•°ã€‚ å·²æ‰“å¼€çš„æ¶ˆæ¯é˜Ÿåˆ—æ˜¯ç”± mq_close å…³é—­çš„ã€‚ #include \u003cmqueue.h\u003e int mq_close(mqd_t mqdes) //è¿”å›ï¼š æˆåŠŸè¿”å›0ï¼Œå‡ºé”™è¿”å›-1 å…³é—­ä¹‹åè°ƒç”¨è¿›ç¨‹ä¸å†ä½¿ç”¨è¯¥æè¿°ç¬¦ï¼Œä½†å…¶æ¶ˆæ¯é˜Ÿåˆ—å¹¶ä¸ä»ç³»ç»Ÿä¸­åˆ é™¤ã€‚ä¸€ä¸ªè¿›ç¨‹ç»ˆæ­¢æ—¶ï¼Œå®ƒæ‰“å¼€ç€çš„æ¶ˆæ¯é˜Ÿåˆ—éƒ½å…³é—­ï¼Œå°±åƒè°ƒç”¨mq_close ä¸€æ ·ã€‚ è¦ä»ç³»ç»Ÿä¸­åˆ é™¤æ¶ˆæ¯é˜Ÿåˆ—åˆ™ç”¨mq_unlink å‡½æ•°ï¼Œå…¶ç¬¬ä¸€å‚æ•°ä¸º mq_open çš„ç¬¬ä¸€å‚æ•° nameã€‚ # include \u003cmqueue.h\u003e int mq_unlink(const char *name) //è¿”å›ï¼š æˆåŠŸè¿”å›0ï¼Œå‡ºé”™è¿”å›-1 mq_getattr å’Œ mq_setattr å‡½æ•° æ¶ˆæ¯é˜Ÿåˆ—æœ‰å››ä¸ªå±æ€§ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°æ˜¯è·å–å’Œä¿®æ”¹è¿™äº›å±æ€§ã€‚ mq_flags //é˜Ÿåˆ—é˜»å¡æ ‡å¿—ä½ mq_maxmsg //é˜Ÿåˆ—æœ€å¤§å…è®¸æ¶ˆæ¯æ•° mq_msgsize //é˜Ÿåˆ—æ¶ˆæ¯æœ€å¤§å­—èŠ‚æ•° mq_curmsgs //é˜Ÿåˆ—å½“å‰æ¶ˆæ¯æ¡æ•° #include \u003cmqueue.h\u003e int mq_getattr(mqd_t mqdes,struct mq_attr *attr); int mq_setattr(mqd_t mqdes,const struct mq_attr *attr, struct mq_attr *oattr); //è¿”å›ï¼šå‡æˆåŠŸè¿”å›0ï¼Œå‡ºé”™è¿”å›-1 mq_send å’Œ mq_receive å‡½æ•° â€‹ è¿™ä¸¤ä¸ªå‡½æ•°åˆ†åˆ«å¾€ä¸€ä¸ªé˜Ÿåˆ—æ”¾ç½®ä¸€ä¸ªä¿¡æ¯å’Œä»ä¸€ä¸ªé˜Ÿåˆ—å–èµ°ä¸€ä¸ªæ¶ˆæ¯ã€‚æ¯ä¸€ä¸ªæ¶ˆæ¯éƒ½æœ‰ä¼˜å…ˆçº§ï¼Œå®ƒæ˜¯ä¸€ä¸ªå°äºMQ_PRIO_MAX çš„æ— ç¬¦å·æ•´æ•°ã€‚Posixè¦æ±‚è¿™ä¸ªä¸Šé™è‡³å°‘ä¸º32. â€‹ mq_receive æ€»æ˜¯è¿”å›æ‰€æŒ‡å®šé˜Ÿåˆ—ä¸­ä¼˜å…ˆçº§æœ€é«˜çš„çš„æœ€æ—©æ¶ˆæ¯ï¼Œè€Œä¸”è¯¥ä¼˜å…ˆçº§èƒ½éšè¯¥æ¶ˆæ¯çš„å†…å®¹åŠå…¶é•¿åº¦ä¸€åŒè¿”å›ã€‚ #include \u003cmqueue.h\u003e int mq_send(mqd_t mqdes, const char *ptr, size_t len, unsigned int prio); //è¿”å›ï¼š æˆåŠŸè¿”å›0ï¼Œå‡ºé”™è¿”å›-1 ssize_t mq_reccevie(mqd_t mqdes, char *ptr, size_t len, unsigned int *priop); //è¿”å›ï¼š æˆåŠŸè¿”å›æ¶ˆæ¯ä¸­çš„å­—èŠ‚æ•°ï¼Œå‡ºé”™è¿”å›-1 mq_receive çš„ len å‚æ•°çš„å€¼ä¸èƒ½å°äºèƒ½åŠ åˆ°æ‰€æŒ‡å®šé˜Ÿåˆ—ä¸­çš„æœ€å¤§å¤§å°ï¼ˆè¯¥é˜Ÿåˆ— mq_attr ç»“æ„çš„ mq_msgsize ï¼‰ã€‚è¦æ˜¯ len å°äºè¯¥å€¼ï¼Œ mq_receiveç«‹å³è¿”å› EMSGSIZE é”™è¯¯ã€‚ mq_send çš„ prio å‚æ•°æ˜¯å¾…å‘ä¿¡æ¯çš„ä¼˜å…ˆçº§ï¼Œå…¶å€¼å¿…é¡»å°äº MQ_PRIO_MAX ã€‚å¦‚æœ mq_receive çš„ priop å‚æ•°æ˜¯ä¸€ä¸ªéç©ºæŒ‡é’ˆï¼Œæ‰€è¿”å›æ¶ˆæ¯çš„ä¼˜å…ˆçº§å°±é€šè¿‡è¯¥æŒ‡é’ˆå­˜æ”¾ã€‚å¦‚æœåº”ç”¨ä¸å¿…ä½¿ç”¨ä¼˜å…ˆçº§ä¸åŒçš„æ¶ˆæ¯ï¼Œé‚£å°±ç»™mq_send æŒ‡é’ˆå€¼ä¸º0çš„ä¼˜å…ˆçº§ï¼Œç»™ mq_receive æŒ‡å®šä¸€ä¸ªç©ºæŒ‡é’ˆä½œä¸ºå…¶æœ€åä¸€ä¸ªå‚æ•°ã€‚ å¾€æŸä¸ªé˜Ÿåˆ—ä¸­å¢åŠ ä¸€ä¸ªæ¶ˆæ¯ #include \u003cmqueue.h\u003e int main(int argc, char **argv) { mqd_t mqd; //æè¿°ç¬¦ void *ptr; //æŒ‡å‘ç¼“å†²åŒºçš„æŒ‡é’ˆ size_t len; //é•¿åº¦ uint_t prio; //ä¼˜å…ˆåº¦ if (argc != 4) err_quit(\"usage: mqsend \u003cname\u003e \u003c#bytes\u003e \u003cpriority\u003e\"); len = atoi(argv[2]); prio = atoi(argv[3]); mqd = Mq_open(argv[1], O_WRONLY); // åˆ›å»ºä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ— ptr = Calloc(len, sizeof(char));// æ‰€ç”¨çš„ç¼“å†²åŒºç”¨collocåˆ†é…ï¼Œè¯¥å‡½æ•°ä¼šæŠŠè¯¥ç¼“å†²åŒºåˆå§‹åŒ–ä¸º0 Mq_send(mqd, ptr, len, prio); exit(0); } å¾…å‘æ¶ˆæ¯çš„å¤§å°å’Œä¼˜å…ˆçº§å¿…é¡»ä½œä¸ºå‘½ä»¤è¡Œå‚æ•°æŒ‡å®šã€‚ ä»æŸé˜Ÿåˆ—è¯»å‡ºä¸‹ä¸€ä¸ªä¿¡æ¯ #include \"unpipc.h\" int main(int argc, char **argv) { int c,flags; mqd_t maq; ssize_t n; uint_t prio; void *buff; struct mq_attr attr; flags = O_RDONLY; while ( (c = Getopt(argc, argv, \"n\")) != -1) { switch (c) { case 'n': flags |= O_NONBLOCK; break; } } if (optind != argc - 1) err_quit(\"usage: mqreceive [-n] \u003cname\u003e\"); mqd =Mq_open(argv[optind], flags); Mq_getattr(mqd, \u0026attr); buff = Malloc(attr.mq_msgsize); n = Mq_receive(mqd, buff, attr.mq_msgsize, \u0026prio); printf(\"read %ld bytes, priority = %u\\n\", (long) n, prio); exit(0); } å‘½ä»¤è¡Œé€‰é¡¹ -n æŒ‡å®šéé˜»å¡å±æ€§ï¼Œè¿™æ ·å¦‚æœæ‰€æŒ‡å®šçš„é˜Ÿåˆ—ä¸­æ²¡æœ‰æ¶ˆæ¯ï¼Œ åˆ™è¿”å›ä¸€ä¸ªé”™è¯¯ã€‚ è°ƒç”¨ mq_getattr æ‰“å¼€é˜Ÿåˆ—å¹¶å–å¾—å±æ€§ã€‚éœ€è¦ç¡®å®šæœ€å¤§æ¶ˆæ¯å¤§å°ï¼Œå› ä¸ºå¿…é¡»ä¸ºè°ƒç”¨çš„ mq_receive åˆ†é…ä¸€ä¸ªè¿™æ ·å¤§å°çš„ç¼“å†²åŒºã€‚æœ€åè¾“å‡ºæ‰€è¯»å‡ºæ¶ˆæ¯çš„å¤§å°åŠå…¶å±æ€§ã€‚ solaris %mqcreate /test1 åˆ›å»ºå¹¶è·å–å±æ€§ solaris %mqgetattr /test1 max solaris % mqsend /test1 100 9999 ä»¥æ— æ•ˆçš„ä¼˜å…ˆçº§å‘é€ mq_send error: Invalid argument solaris % mqsend /test1 100 6 100å­—èŠ‚ï¼Œä¼˜å…ˆçº§6 solaris % mqsend /test1 50 18 50å­—èŠ‚ï¼Œä¼˜å…ˆçº§18 solaris % mqsend /test1 33 18 33å­—èŠ‚ï¼Œä¼˜å…ˆçº§18 solaris % mqreceive /test1 read 50 bytes, priority = 18 è¿”å›ä¼˜å…ˆçº§æœ€é«˜çš„æœ€æ—©æ¶ˆæ¯ solaris % mqreceive /test1 read 33 bytes, priority = 18 solaris % mqreceive /test1 read 100 bytes, priority = 6 solaris % mqreceive /test1 æŒ‡å®šéé˜»å¡å±æ€§ï¼Œé˜Ÿåˆ—ä¸ºç©º mq_recevie error: Resource temporarily unavalibale æ¶ˆæ¯é˜Ÿåˆ—é™åˆ¶","date":"2017-04-22","objectID":"/posts/unix-network/:3:0","tags":["unix"],"title":"Unix ç½‘ç»œç¼–ç¨‹","uri":"/posts/unix-network/"},{"categories":["ç½‘ç»œç¼–ç¨‹"],"content":"System V æ¶ˆæ¯é˜Ÿåˆ— ä»¥ä¸‹ä¸‰ç§ç±»å‹çš„IPCç§°ä¸º System V IPCï¼š System V æ¶ˆæ¯é˜Ÿåˆ—ï¼› System V ä¿¡å·é‡ï¼› System V å…±äº«å†…å­˜åŒºã€‚ è¿™ä¸ªç§°ä¸ºä½œä¸ºè¿™ä¸‰ä¸ªIPCæœºåˆ¶çš„é€šç§°æ˜¯å› ä¸ºå®ƒä»¬æºè‡ª System V Unix ã€‚è¿™ä¸‰ç§IPCæœ€å…ˆå‡ºç°åœ¨AT\u0026T System v UNIXä¸Šé¢ï¼Œå¹¶éµå¾ªXSIæ ‡å‡†ï¼Œæœ‰æ—¶å€™ä¹Ÿè¢«ç§°ä¸ºXSI IPCã€‚ System V æ¶ˆæ¯é˜Ÿåˆ—ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—æ ‡è¯†ç¬¦ï¼ˆmessage queue identifierï¼‰ æ ‡è¯†ã€‚æœ‰è¶³å¤Ÿæƒé™çš„ä»»ä½•è¿›ç¨‹å¯å¾€é˜Ÿåˆ—æ”¾ç½®ä¿¡æ¯ï¼Œæœ‰è¶³å¤Ÿæƒé™çš„ä»»ä½•è¿›ç¨‹å¯ä»é˜Ÿåˆ—è¯»å–ä¿¡æ¯ã€‚è·Ÿ Posix ä¸€æ ·ï¼Œåœ¨æŸä¸ªè¿›ç¨‹å¾€ä¸€ä¸ªé˜Ÿåˆ—å†™å…¥æ¶ˆæ¯ä¹‹å‰ï¼Œä¸æ±‚å¦å¤–æŸä¸ªè¿›ç¨‹æ­£åœ¨ç­‰å¾…è¯¥é˜Ÿåˆ—ä¸Šä¸€ä¸ªæ¶ˆæ¯çš„åˆ°è¾¾ã€‚ å¯¹äºç³»ç»Ÿçš„æ¯ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå†…æ ¸ç»´æŠ¤ä¸€ä¸ªå®šä¹‰åœ¨ \u003csys/msg.h\u003e å¤´æ–‡ä»¶ä¸­çš„ä¿¡æ¯ç»“æ„. struct msqid_ds { struct ipc_perm msg_perm //operation permission structure struct msg *msg_frist //ptr to frist message on queue struct msg *msg_last //ptr to last message on queue msglen_t msg_cbytes //current #bytes on queue msgqnum_t msg_qnum //number of messages currently on queue msglen_t msg_qbytes //maximum number of bytes allowed on queue pid_t msg_lspid //process ID of last msgsnd() pid_t msg_lrpid //process ID of last msgrcv() time_t msg_stime //time of last msgsnd() time_t msg_rtime //time of last msgrcv() time_t msg_ctime //time of last change } Unix 98 ä¸è¦æ±‚æœ‰ msg_fristã€msg_last å’Œ msg_cbytes æˆå‘˜ã€‚ç„¶è€Œæ™®é€šçš„æºè‡ª System V çš„å®ç°ä¸­å¯ä»¥æ‰¾åˆ°è¿™ä¸‰ä¸ªæˆå‘˜ã€‚å°±ç®—æä¾›äº†è¿™ä¸¤ä¸ªæŒ‡é’ˆï¼Œé‚£ä¹ˆå®ƒä»¬æŒ‡å‘çš„æ˜¯å†…æ ¸å†…å­˜ç©ºé—´ï¼Œå¯¹äºåº”ç”¨æ¥è¯´åŸºæœ¬æ²¡æœ‰ä½œç”¨çš„ã€‚ æˆ‘ä»¬å¯ä»¥å°†å†…æ ¸ä¸­æŸä¸ªç‰¹å®šçš„æ¶ˆæ¯é˜Ÿåˆ—ç”»ä¸ºä¸€ä¸ªæ¶ˆæ¯é“¾è¡¨ï¼Œå¦‚å›¾ã€‚ msgget å‡½æ•° msgget å‡½æ•°ç”¨äºåˆ›å»ºä¸€ä¸ªæ–°çš„æ¶ˆæ¯é˜Ÿåˆ—æˆ–è®¿é—®ä¸€ä¸ªå·²å­˜åœ¨çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚ #include \u003csys/msg.h\u003e int msgget (key_t key, int oflag) //è¿”å›ï¼š æˆåŠŸè¿”å›éè´Ÿæ ‡è¯†ç¬¦ï¼Œå‡ºé”™è¿”å›-1 è¿”å›å€¼æ˜¯ä¸€ä¸ªæ•´æ•°æ ‡è¯†ç¬¦ï¼Œå…¶ä»–ä¸‰ä¸ªmsgå‡½æ•°å°±ç”¨å®ƒæ¥æŒ‡ä»£è¯¥é˜Ÿåˆ—ã€‚ oflagæ˜¯è¯»å†™æƒé™çš„ç»„åˆã€‚ï¼ˆç¨å¾®å¤æ‚ã€‚ã€‚ã€‚ï¼‰ å½“åˆ›å»ºä¸€ä¸ªæ–°çš„æ¶ˆæ¯é˜Ÿåˆ—çš„æ—¶ï¼Œmsqid_ds ç»“æ„çš„å¦‚ä¸‹æˆå‘˜è¢«åˆå§‹åŒ–ã€‚ msg_perm ç»“æ„çš„ uid å’Œ cuid æˆå‘˜è¢«è®¾ç½®æˆå½“å‰è¿›ç¨‹çš„æœ‰æ•ˆç”¨æˆ·IDï¼Œgid å’Œ cgid æˆå‘˜è¢«è®¾ç½®æˆå½“å‰çš„è¿›ç¨‹çš„æœ‰æ•ˆç»„IDã€‚ oflag ä¸­çš„è¯»å†™æƒé™ä½å­˜æ”¾åœ¨msg_perm.mode ä¸­ã€‚ msg_qnumã€msg_lspidï¼Œmsg_lrpidã€msg_stime å’Œ msg_rtime è¢«è®¾ç½®ä¸º0. msg_ctime è¢«è®¾ç½®ä¸ºå½“å‰æ—¶é—´ã€‚ msg_qbytes è¢«è®¾ç½®æˆç³»ç»Ÿé™åˆ¶å€¼ã€‚ struct ipc_perm { key_t key; /*è°ƒç”¨shmget()æ—¶ç»™å‡ºçš„å…³é”®å­—*/ uid_t uid; /*å…±äº«å†…å­˜æ‰€æœ‰è€…çš„æœ‰æ•ˆç”¨æˆ·ID */ gid_t gid; /* å…±äº«å†…å­˜æ‰€æœ‰è€…æ‰€å±ç»„çš„æœ‰æ•ˆç»„ID*/ uid_t cuid; /* å…±äº«å†…å­˜åˆ›å»º è€…çš„æœ‰æ•ˆç”¨æˆ·ID*/ gid_t cgid; /* å…±äº«å†…å­˜åˆ›å»ºè€…æ‰€å±ç»„çš„æœ‰æ•ˆç»„ID*/ mode_t mode; /* Permissions + SHM_DESTå’ŒSHM_LOCKEDæ ‡å¿—*/ ulong_t seq; /* åºåˆ—å·*/ }; â€‹ msgsnd å‡½æ•° ä½¿ç”¨ msgget å‡½æ•°æ‰“å¼€ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—åï¼Œä½¿ç”¨ msgsnd å‡½æ•°å¾€å…¶ä¸Šæ”¾ç½®ä¸€ä¸ªæ¶ˆæ¯ã€‚ # include \u003csys/msg.h\u003e int msgsnd(int msqid, const void *ptr,size_t length, int flag); å…¶ä¸­msqid æ˜¯ç”±msgget å‡½æ•°è¿”å›çš„æ ‡è¯†ç¬¦ã€‚ptr æ˜¯ä¸€ä¸ªç»“æ„æŒ‡é’ˆï¼Œè¯¥ç»“æ„å…·æœ‰å¦‚ä¸‹çš„æ¨¡æ¿ï¼š struct msgbuf { long mtype; // message type ,must be \u003e 0 char mtext[1] // message data }; æ¶ˆæ¯ç±»å‹å¿…é¡»å¤§äº0ï¼Œå› ä¸ºå¯¹äº msgrcv å‡½æ•°æ¥è¯´ï¼Œéæ­£çš„æ¶ˆæ¯ç±»å‹ç”¨ä½œç‰¹æ®Šçš„æŒ‡ç¤ºå™¨ã€‚ mtextè™½ç„¶èµ·åæ˜¯ text ï¼Œä½†æ˜¯æ¶ˆæ¯ç±»å‹å¹¶ä¸å±€é™äºæ–‡æœ¬ã€‚ä»»ä½•å½¢å¼çš„æ•°æ®éƒ½æ˜¯å…è®¸çš„ã€‚å†…æ ¸æ ¹æœ¬ä¸è§£é‡Šæ¶ˆ æ¯æ•°æ®çš„å†…å®¹ã€‚ptr æ‰€æŒ‡å‘çš„æ˜¯ä¸€ä¸ªå«æœ‰æ¶ˆæ¯ç±»å‹çš„é•¿æ•´æ•°ï¼Œæ¶ˆæ¯æœ¬èº«åˆ™ç´§è·Ÿç€å®ƒä¹‹åã€‚ msgsnd çš„ length å‚æ•°ä»¥å­—èŠ‚ä¸ºå•ä½æŒ‡å®šå¾…å‘é€æ¶ˆæ¯çš„é•¿åº¦ã€‚æ˜¯ç”¨æˆ·è‡ªå®šä¹‰çš„ï¼Œå¯ä»¥æ˜¯0. flag å‚æ•°æ—¢å¯ä»¥æ˜¯0ï¼Œä¹Ÿå¯ä»¥æ˜¯IPC_NOWAIT ã€‚IPC_NOWAIT æ ‡å¿—ä½¿å¾— msgsnd è°ƒç”¨éé˜»å¡ï¼šå¦‚æœæ²¡æœ‰å­˜æ”¾æ–°æ¶ˆæ¯çš„å¯ç”¨ç©ºé—´ï¼Œè¯¥å‡½æ•°é©¬ä¸Šè¿”å›ã€‚è¿™ä¸ªæ¡ä»¶å¯èƒ½å‘ç”Ÿçš„æƒ…å†µåŒ…æ‹¬ï¼š åœ¨æŒ‡å®šçš„é˜Ÿåˆ—ä¸­å·²æœ‰å¤ªå¤šçš„å­—èŠ‚ï¼ˆå¯¹åº” è¯¥é˜Ÿåˆ—çš„msqid_ds ç»“æ„ä¸­çš„msg_qbytes å€¼ï¼‰ï¼› åœ¨ç³»ç»ŸèŒƒå›´å­˜åœ¨å¤ªå¤šçš„æ¶ˆæ¯ã€‚ å¦‚æœä¸¤ä¸ªæ¡ä»¶ä¸€ä¸ªå­˜åœ¨ï¼Œè€Œä¸”IPC_NOWAITæ ‡å¿—å·²æŒ‡å®šï¼Œmsgsnd å°±è¿”å›ä¸€ä¸ªEAGAIN é”™è¯¯ã€‚å¦‚æœä¸¤ä¸ªæ¡ä»¶ä¸€ä¸ªå­˜åœ¨ï¼Œæ ‡å¿—æœªæŒ‡å®šï¼Œé‚£ä¹ˆè°ƒç”¨çº¿ç¨‹å°±è¢«æŠ•å…¥ç¡çœ ï¼Œç›´åˆ°ï¼š å…·å¤‡å­˜æ”¾æ–°æ¶ˆæ¯çš„ç©ºé—´ï¼› ç”± msqgid æ ‡è¯†çš„æ¶ˆæ¯é˜Ÿåˆ—ä»ç³»ç»Ÿä¸­åˆ é™¤ï¼ˆè¿™ä¸ªæƒ…å†µä¸‹å›è¿”å›ä¸€ä¸ªEIDRM é”™è¯¯ï¼‰ï¼› è°ƒç”¨çº¿ç¨‹è¢«æŸä¸ªæ•è·çš„ä¿¡æ¯æ‰€ä¸­æ–­ã€‚ ","date":"2017-04-22","objectID":"/posts/unix-network/:4:0","tags":["unix"],"title":"Unix ç½‘ç»œç¼–ç¨‹","uri":"/posts/unix-network/"},{"categories":["æŠ€æœ¯"],"content":"è·¨åŸŸèµ„æºå…±äº« CORS è¯¦è§£ CORSæ˜¯ä¸€ä¸ªW3Cæ ‡å‡†ï¼Œå…¨ç§°æ˜¯\"è·¨åŸŸèµ„æºå…±äº«\"ï¼ˆCross-origin resource sharingï¼‰ã€‚ å®ƒå…è®¸æµè§ˆå™¨å‘è·¨æºæœåŠ¡å™¨ï¼Œå‘å‡ºXMLHttpRequestè¯·æ±‚ï¼Œä»è€Œå…‹æœäº†AJAXåªèƒ½åŒæºä½¿ç”¨çš„é™åˆ¶ã€‚ æœ¬æ–‡è¯¦ç»†ä»‹ç»CORSçš„å†…éƒ¨æœºåˆ¶ã€‚ ","date":"2017-01-30","objectID":"/posts/cors/:0:0","tags":["go","cors"],"title":"è·¨åŸŸèµ„æºå…±äº« CORS è¯¦è§£","uri":"/posts/cors/"},{"categories":["æŠ€æœ¯"],"content":"ä¸€ã€ç®€ä»‹ CORSéœ€è¦æµè§ˆå™¨å’ŒæœåŠ¡å™¨åŒæ—¶æ”¯æŒã€‚ç›®å‰ï¼Œæ‰€æœ‰æµè§ˆå™¨éƒ½æ”¯æŒè¯¥åŠŸèƒ½ï¼ŒIEæµè§ˆå™¨ä¸èƒ½ä½äºIE10ã€‚ æ•´ä¸ªCORSé€šä¿¡è¿‡ç¨‹ï¼Œéƒ½æ˜¯æµè§ˆå™¨è‡ªåŠ¨å®Œæˆï¼Œä¸éœ€è¦ç”¨æˆ·å‚ä¸ã€‚å¯¹äºå¼€å‘è€…æ¥è¯´ï¼ŒCORSé€šä¿¡ä¸åŒæºçš„AJAXé€šä¿¡æ²¡æœ‰å·®åˆ«ï¼Œä»£ç å®Œå…¨ä¸€æ ·ã€‚æµè§ˆå™¨ä¸€æ—¦å‘ç°AJAXè¯·æ±‚è·¨æºï¼Œå°±ä¼šè‡ªåŠ¨æ·»åŠ ä¸€äº›é™„åŠ çš„å¤´ä¿¡æ¯ï¼Œæœ‰æ—¶è¿˜ä¼šå¤šå‡ºä¸€æ¬¡é™„åŠ çš„è¯·æ±‚ï¼Œä½†ç”¨æˆ·ä¸ä¼šæœ‰æ„Ÿè§‰ã€‚ å› æ­¤ï¼Œå®ç°CORSé€šä¿¡çš„å…³é”®æ˜¯æœåŠ¡å™¨ã€‚åªè¦æœåŠ¡å™¨å®ç°äº†CORSæ¥å£ï¼Œå°±å¯ä»¥è·¨æºé€šä¿¡ã€‚ ","date":"2017-01-30","objectID":"/posts/cors/:1:0","tags":["go","cors"],"title":"è·¨åŸŸèµ„æºå…±äº« CORS è¯¦è§£","uri":"/posts/cors/"},{"categories":["æŠ€æœ¯"],"content":"äºŒã€ä¸¤ç§è¯·æ±‚ æµè§ˆå™¨å°†CORSè¯·æ±‚åˆ†æˆä¸¤ç±»ï¼šç®€å•è¯·æ±‚ï¼ˆsimple requestï¼‰å’Œéç®€å•è¯·æ±‚ï¼ˆnot-so-simple requestï¼‰ã€‚ åªè¦åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸¤å¤§æ¡ä»¶ï¼Œå°±å±äºç®€å•è¯·æ±‚ã€‚ è¯·æ±‚æ–¹æ³•æ˜¯ä»¥ä¸‹ä¸‰ç§æ–¹æ³•ä¹‹ä¸€ï¼š HEAD GET POST ï¼ˆ2ï¼‰HTTPçš„å¤´ä¿¡æ¯ä¸è¶…å‡ºä»¥ä¸‹å‡ ç§å­—æ®µï¼š Accept Accept-Language Content-Language Last-Event-ID Content-Typeï¼šåªé™äºä¸‰ä¸ªå€¼application/x-www-form-urlencodedã€multipart/form-dataã€text/plain å‡¡æ˜¯ä¸åŒæ—¶æ»¡è¶³ä¸Šé¢ä¸¤ä¸ªæ¡ä»¶ï¼Œå°±å±äºéç®€å•è¯·æ±‚ã€‚ æµè§ˆå™¨å¯¹è¿™ä¸¤ç§è¯·æ±‚çš„å¤„ç†ï¼Œæ˜¯ä¸ä¸€æ ·çš„ã€‚ ","date":"2017-01-30","objectID":"/posts/cors/:2:0","tags":["go","cors"],"title":"è·¨åŸŸèµ„æºå…±äº« CORS è¯¦è§£","uri":"/posts/cors/"},{"categories":["æŠ€æœ¯"],"content":"ä¸‰ã€ç®€å•è¯·æ±‚ ","date":"2017-01-30","objectID":"/posts/cors/:3:0","tags":["go","cors"],"title":"è·¨åŸŸèµ„æºå…±äº« CORS è¯¦è§£","uri":"/posts/cors/"},{"categories":["æŠ€æœ¯"],"content":"3.1 åŸºæœ¬æµç¨‹ å¯¹äºç®€å•è¯·æ±‚ï¼Œæµè§ˆå™¨ç›´æ¥å‘å‡ºCORSè¯·æ±‚ã€‚å…·ä½“æ¥è¯´ï¼Œå°±æ˜¯åœ¨å¤´ä¿¡æ¯ä¹‹ä¸­ï¼Œå¢åŠ ä¸€ä¸ªOriginå­—æ®µã€‚ ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼Œæµè§ˆå™¨å‘ç°è¿™æ¬¡è·¨æºAJAXè¯·æ±‚æ˜¯ç®€å•è¯·æ±‚ï¼Œå°±è‡ªåŠ¨åœ¨å¤´ä¿¡æ¯ä¹‹ä¸­ï¼Œæ·»åŠ ä¸€ä¸ªOriginå­—æ®µã€‚ GET /cors HTTP/1.1 Origin: http://api.bob.com Host: api.alice.com Accept-Language: en-US Connection: keep-alive User-Agent: Mozilla/5.0... ä¸Šé¢çš„å¤´ä¿¡æ¯ä¸­ï¼ŒOriginå­—æ®µç”¨æ¥è¯´æ˜ï¼Œæœ¬æ¬¡è¯·æ±‚æ¥è‡ªå“ªä¸ªæºï¼ˆåè®® + åŸŸå + ç«¯å£ï¼‰ã€‚æœåŠ¡å™¨æ ¹æ®è¿™ä¸ªå€¼ï¼Œå†³å®šæ˜¯å¦åŒæ„è¿™æ¬¡è¯·æ±‚ã€‚ å¦‚æœOriginæŒ‡å®šçš„æºï¼Œä¸åœ¨è®¸å¯èŒƒå›´å†…ï¼ŒæœåŠ¡å™¨ä¼šè¿”å›ä¸€ä¸ªæ­£å¸¸çš„HTTPå›åº”ã€‚æµè§ˆå™¨å‘ç°ï¼Œè¿™ä¸ªå›åº”çš„å¤´ä¿¡æ¯æ²¡æœ‰åŒ…å«Access-Control-Allow-Originå­—æ®µï¼ˆè¯¦è§ä¸‹æ–‡ï¼‰ï¼Œå°±çŸ¥é“å‡ºé”™äº†ï¼Œä»è€ŒæŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œè¢«XMLHttpRequestçš„onerrorå›è°ƒå‡½æ•°æ•è·ã€‚æ³¨æ„ï¼Œè¿™ç§é”™è¯¯æ— æ³•é€šè¿‡çŠ¶æ€ç è¯†åˆ«ï¼Œå› ä¸ºHTTPå›åº”çš„çŠ¶æ€ç æœ‰å¯èƒ½æ˜¯200ã€‚ å¦‚æœOriginæŒ‡å®šçš„åŸŸååœ¨è®¸å¯èŒƒå›´å†…ï¼ŒæœåŠ¡å™¨è¿”å›çš„å“åº”ï¼Œä¼šå¤šå‡ºå‡ ä¸ªå¤´ä¿¡æ¯å­—æ®µã€‚ Access-Control-Allow-Origin: http://api.bob.com Access-Control-Allow-Credentials: true Access-Control-Expose-Headers: FooBar Content-Type: text/html; charset=utf-8 ä¸Šé¢çš„å¤´ä¿¡æ¯ä¹‹ä¸­ï¼Œæœ‰ä¸‰ä¸ªä¸CORSè¯·æ±‚ç›¸å…³çš„å­—æ®µï¼Œéƒ½ä»¥Access-Control-å¼€å¤´ã€‚ ï¼ˆ1ï¼‰Access-Control-Allow-Origin è¯¥å­—æ®µæ˜¯å¿…é¡»çš„ã€‚å®ƒçš„å€¼è¦ä¹ˆæ˜¯è¯·æ±‚æ—¶Originå­—æ®µçš„å€¼ï¼Œè¦ä¹ˆæ˜¯ä¸€ä¸ª*ï¼Œè¡¨ç¤ºæ¥å—ä»»æ„åŸŸåçš„è¯·æ±‚ã€‚ ï¼ˆ2ï¼‰Access-Control-Allow-Credentials è¯¥å­—æ®µå¯é€‰ã€‚å®ƒçš„å€¼æ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæ˜¯å¦å…è®¸å‘é€Cookieã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒCookieä¸åŒ…æ‹¬åœ¨CORSè¯·æ±‚ä¹‹ä¸­ã€‚è®¾ä¸ºtrueï¼Œå³è¡¨ç¤ºæœåŠ¡å™¨æ˜ç¡®è®¸å¯ï¼ŒCookieå¯ä»¥åŒ…å«åœ¨è¯·æ±‚ä¸­ï¼Œä¸€èµ·å‘ç»™æœåŠ¡å™¨ã€‚è¿™ä¸ªå€¼ä¹Ÿåªèƒ½è®¾ä¸ºtrueï¼Œå¦‚æœæœåŠ¡å™¨ä¸è¦æµè§ˆå™¨å‘é€Cookieï¼Œåˆ é™¤è¯¥å­—æ®µå³å¯ã€‚ ï¼ˆ3ï¼‰Access-Control-Expose-Headers è¯¥å­—æ®µå¯é€‰ã€‚CORSè¯·æ±‚æ—¶ï¼ŒXMLHttpRequestå¯¹è±¡çš„getResponseHeader()æ–¹æ³•åªèƒ½æ‹¿åˆ°6ä¸ªåŸºæœ¬å­—æ®µï¼šCache-Controlã€Content-Languageã€Content-Typeã€Expiresã€Last-Modifiedã€Pragmaã€‚å¦‚æœæƒ³æ‹¿åˆ°å…¶ä»–å­—æ®µï¼Œå°±å¿…é¡»åœ¨Access-Control-Expose-Headersé‡Œé¢æŒ‡å®šã€‚ä¸Šé¢çš„ä¾‹å­æŒ‡å®šï¼ŒgetResponseHeader('FooBar')å¯ä»¥è¿”å›FooBarå­—æ®µçš„å€¼ã€‚ ","date":"2017-01-30","objectID":"/posts/cors/:3:1","tags":["go","cors"],"title":"è·¨åŸŸèµ„æºå…±äº« CORS è¯¦è§£","uri":"/posts/cors/"},{"categories":["æŠ€æœ¯"],"content":"3.2 withCredentials å±æ€§ ä¸Šé¢è¯´åˆ°ï¼ŒCORSè¯·æ±‚é»˜è®¤ä¸å‘é€Cookieå’ŒHTTPè®¤è¯ä¿¡æ¯ã€‚å¦‚æœè¦æŠŠCookieå‘åˆ°æœåŠ¡å™¨ï¼Œä¸€æ–¹é¢è¦æœåŠ¡å™¨åŒæ„ï¼ŒæŒ‡å®šAccess-Control-Allow-Credentialså­—æ®µã€‚ Access-Control-Allow-Credentials: true å¦ä¸€æ–¹é¢ï¼Œå¼€å‘è€…å¿…é¡»åœ¨AJAXè¯·æ±‚ä¸­æ‰“å¼€withCredentialså±æ€§ã€‚ var xhr = new XMLHttpRequest(); xhr.withCredentials = true; å¦åˆ™ï¼Œå³ä½¿æœåŠ¡å™¨åŒæ„å‘é€Cookieï¼Œæµè§ˆå™¨ä¹Ÿä¸ä¼šå‘é€ã€‚æˆ–è€…ï¼ŒæœåŠ¡å™¨è¦æ±‚è®¾ç½®Cookieï¼Œæµè§ˆå™¨ä¹Ÿä¸ä¼šå¤„ç†ã€‚ ä½†æ˜¯ï¼Œå¦‚æœçœç•¥withCredentialsè®¾ç½®ï¼Œæœ‰çš„æµè§ˆå™¨è¿˜æ˜¯ä¼šä¸€èµ·å‘é€Cookieã€‚è¿™æ—¶ï¼Œå¯ä»¥æ˜¾å¼å…³é—­withCredentialsã€‚ xhr.withCredentials = false; éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœè¦å‘é€Cookieï¼ŒAccess-Control-Allow-Originå°±ä¸èƒ½è®¾ä¸ºæ˜Ÿå·ï¼Œå¿…é¡»æŒ‡å®šæ˜ç¡®çš„ã€ä¸è¯·æ±‚ç½‘é¡µä¸€è‡´çš„åŸŸåã€‚åŒæ—¶ï¼ŒCookieä¾ç„¶éµå¾ªåŒæºæ”¿ç­–ï¼Œåªæœ‰ç”¨æœåŠ¡å™¨åŸŸåè®¾ç½®çš„Cookieæ‰ä¼šä¸Šä¼ ï¼Œå…¶ä»–åŸŸåçš„Cookieå¹¶ä¸ä¼šä¸Šä¼ ï¼Œä¸”ï¼ˆè·¨æºï¼‰åŸç½‘é¡µä»£ç ä¸­çš„document.cookieä¹Ÿæ— æ³•è¯»å–æœåŠ¡å™¨åŸŸåä¸‹çš„Cookieã€‚ ","date":"2017-01-30","objectID":"/posts/cors/:3:2","tags":["go","cors"],"title":"è·¨åŸŸèµ„æºå…±äº« CORS è¯¦è§£","uri":"/posts/cors/"},{"categories":["æŠ€æœ¯"],"content":"å››ã€éç®€å•è¯·æ±‚ ","date":"2017-01-30","objectID":"/posts/cors/:4:0","tags":["go","cors"],"title":"è·¨åŸŸèµ„æºå…±äº« CORS è¯¦è§£","uri":"/posts/cors/"},{"categories":["æŠ€æœ¯"],"content":"4.1 é¢„æ£€è¯·æ±‚ éç®€å•è¯·æ±‚æ˜¯é‚£ç§å¯¹æœåŠ¡å™¨æœ‰ç‰¹æ®Šè¦æ±‚çš„è¯·æ±‚ï¼Œæ¯”å¦‚è¯·æ±‚æ–¹æ³•æ˜¯PUTæˆ–DELETEï¼Œæˆ–è€…Content-Typeå­—æ®µçš„ç±»å‹æ˜¯application/jsonã€‚ éç®€å•è¯·æ±‚çš„CORSè¯·æ±‚ï¼Œä¼šåœ¨æ­£å¼é€šä¿¡ä¹‹å‰ï¼Œå¢åŠ ä¸€æ¬¡HTTPæŸ¥è¯¢è¯·æ±‚ï¼Œç§°ä¸º\"é¢„æ£€\"è¯·æ±‚ï¼ˆpreflightï¼‰ã€‚ æµè§ˆå™¨å…ˆè¯¢é—®æœåŠ¡å™¨ï¼Œå½“å‰ç½‘é¡µæ‰€åœ¨çš„åŸŸåæ˜¯å¦åœ¨æœåŠ¡å™¨çš„è®¸å¯åå•ä¹‹ä¸­ï¼Œä»¥åŠå¯ä»¥ä½¿ç”¨å“ªäº›HTTPåŠ¨è¯å’Œå¤´ä¿¡æ¯å­—æ®µã€‚åªæœ‰å¾—åˆ°è‚¯å®šç­”å¤ï¼Œæµè§ˆå™¨æ‰ä¼šå‘å‡ºæ­£å¼çš„XMLHttpRequestè¯·æ±‚ï¼Œå¦åˆ™å°±æŠ¥é”™ã€‚ ä¸‹é¢æ˜¯ä¸€æ®µæµè§ˆå™¨çš„JavaScriptè„šæœ¬ã€‚ var url = 'http://api.alice.com/cors'; var xhr = new XMLHttpRequest(); xhr.open('PUT', url, true); xhr.setRequestHeader('X-Custom-Header', 'value'); xhr.send(); ä¸Šé¢ä»£ç ä¸­ï¼ŒHTTPè¯·æ±‚çš„æ–¹æ³•æ˜¯PUTï¼Œå¹¶ä¸”å‘é€ä¸€ä¸ªè‡ªå®šä¹‰å¤´ä¿¡æ¯X-Custom-Headerã€‚ æµè§ˆå™¨å‘ç°ï¼Œè¿™æ˜¯ä¸€ä¸ªéç®€å•è¯·æ±‚ï¼Œå°±è‡ªåŠ¨å‘å‡ºä¸€ä¸ª\"é¢„æ£€\"è¯·æ±‚ï¼Œè¦æ±‚æœåŠ¡å™¨ç¡®è®¤å¯ä»¥è¿™æ ·è¯·æ±‚ã€‚ä¸‹é¢æ˜¯è¿™ä¸ª\"é¢„æ£€\"è¯·æ±‚çš„HTTPå¤´ä¿¡æ¯ã€‚ OPTIONS /cors HTTP/1.1 Origin: http://api.bob.com Access-Control-Request-Method: PUT Access-Control-Request-Headers: X-Custom-Header Host: api.alice.com Accept-Language: en-US Connection: keep-alive User-Agent: Mozilla/5.0... â€œé¢„æ£€\"è¯·æ±‚ç”¨çš„è¯·æ±‚æ–¹æ³•æ˜¯OPTIONSï¼Œè¡¨ç¤ºè¿™ä¸ªè¯·æ±‚æ˜¯ç”¨æ¥è¯¢é—®çš„ã€‚å¤´ä¿¡æ¯é‡Œé¢ï¼Œå…³é”®å­—æ®µæ˜¯Originï¼Œè¡¨ç¤ºè¯·æ±‚æ¥è‡ªå“ªä¸ªæºã€‚ é™¤äº†Originå­—æ®µï¼Œâ€œé¢„æ£€\"è¯·æ±‚çš„å¤´ä¿¡æ¯åŒ…æ‹¬ä¸¤ä¸ªç‰¹æ®Šå­—æ®µã€‚ ï¼ˆ1ï¼‰Access-Control-Request-Method è¯¥å­—æ®µæ˜¯å¿…é¡»çš„ï¼Œç”¨æ¥åˆ—å‡ºæµè§ˆå™¨çš„CORSè¯·æ±‚ä¼šç”¨åˆ°å“ªäº›HTTPæ–¹æ³•ï¼Œä¸Šä¾‹æ˜¯PUTã€‚ ï¼ˆ2ï¼‰Access-Control-Request-Headers è¯¥å­—æ®µæ˜¯ä¸€ä¸ªé€—å·åˆ†éš”çš„å­—ç¬¦ä¸²ï¼ŒæŒ‡å®šæµè§ˆå™¨CORSè¯·æ±‚ä¼šé¢å¤–å‘é€çš„å¤´ä¿¡æ¯å­—æ®µï¼Œä¸Šä¾‹æ˜¯X-Custom-Headerã€‚ ","date":"2017-01-30","objectID":"/posts/cors/:4:1","tags":["go","cors"],"title":"è·¨åŸŸèµ„æºå…±äº« CORS è¯¦è§£","uri":"/posts/cors/"},{"categories":["æŠ€æœ¯"],"content":"4.2 é¢„æ£€è¯·æ±‚çš„å›åº” æœåŠ¡å™¨æ”¶åˆ°\"é¢„æ£€\"è¯·æ±‚ä»¥åï¼Œæ£€æŸ¥äº†Originã€Access-Control-Request-Methodå’ŒAccess-Control-Request-Headerså­—æ®µä»¥åï¼Œç¡®è®¤å…è®¸è·¨æºè¯·æ±‚ï¼Œå°±å¯ä»¥åšå‡ºå›åº”ã€‚ HTTP/1.1 200 OK Date: Mon, 01 Dec 2008 01:15:39 GMT Server: Apache/2.0.61 (Unix) Access-Control-Allow-Origin: http://api.bob.com Access-Control-Allow-Methods: GET, POST, PUT Access-Control-Allow-Headers: X-Custom-Header Content-Type: text/html; charset=utf-8 Content-Encoding: gzip Content-Length: 0 Keep-Alive: timeout=2, max=100 Connection: Keep-Alive Content-Type: text/plain ä¸Šé¢çš„HTTPå›åº”ä¸­ï¼Œå…³é”®çš„æ˜¯Access-Control-Allow-Originå­—æ®µï¼Œè¡¨ç¤ºhttp://api.bob.comå¯ä»¥è¯·æ±‚æ•°æ®ã€‚è¯¥å­—æ®µä¹Ÿå¯ä»¥è®¾ä¸ºæ˜Ÿå·ï¼Œè¡¨ç¤ºåŒæ„ä»»æ„è·¨æºè¯·æ±‚ã€‚ Access-Control-Allow-Origin: * å¦‚æœæµè§ˆå™¨å¦å®šäº†\"é¢„æ£€\"è¯·æ±‚ï¼Œä¼šè¿”å›ä¸€ä¸ªæ­£å¸¸çš„HTTPå›åº”ï¼Œä½†æ˜¯æ²¡æœ‰ä»»ä½•CORSç›¸å…³çš„å¤´ä¿¡æ¯å­—æ®µã€‚è¿™æ—¶ï¼Œæµè§ˆå™¨å°±ä¼šè®¤å®šï¼ŒæœåŠ¡å™¨ä¸åŒæ„é¢„æ£€è¯·æ±‚ï¼Œå› æ­¤è§¦å‘ä¸€ä¸ªé”™è¯¯ï¼Œè¢«XMLHttpRequestå¯¹è±¡çš„onerrorå›è°ƒå‡½æ•°æ•è·ã€‚æ§åˆ¶å°ä¼šæ‰“å°å‡ºå¦‚ä¸‹çš„æŠ¥é”™ä¿¡æ¯ã€‚ XMLHttpRequest cannot load http://api.alice.com. Origin http://api.bob.com is not allowed by Access-Control-Allow-Origin. æœåŠ¡å™¨å›åº”çš„å…¶ä»–CORSç›¸å…³å­—æ®µå¦‚ä¸‹ã€‚ Access-Control-Allow-Methods: GET, POST, PUT Access-Control-Allow-Headers: X-Custom-Header Access-Control-Allow-Credentials: true Access-Control-Max-Age: 1728000 ï¼ˆ1ï¼‰Access-Control-Allow-Methods è¯¥å­—æ®µå¿…éœ€ï¼Œå®ƒçš„å€¼æ˜¯é€—å·åˆ†éš”çš„ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¡¨æ˜æœåŠ¡å™¨æ”¯æŒçš„æ‰€æœ‰è·¨åŸŸè¯·æ±‚çš„æ–¹æ³•ã€‚æ³¨æ„ï¼Œè¿”å›çš„æ˜¯æ‰€æœ‰æ”¯æŒçš„æ–¹æ³•ï¼Œè€Œä¸å•æ˜¯æµè§ˆå™¨è¯·æ±‚çš„é‚£ä¸ªæ–¹æ³•ã€‚è¿™æ˜¯ä¸ºäº†é¿å…å¤šæ¬¡\"é¢„æ£€\"è¯·æ±‚ã€‚ ï¼ˆ2ï¼‰Access-Control-Allow-Headers å¦‚æœæµè§ˆå™¨è¯·æ±‚åŒ…æ‹¬Access-Control-Request-Headerså­—æ®µï¼Œåˆ™Access-Control-Allow-Headerså­—æ®µæ˜¯å¿…éœ€çš„ã€‚å®ƒä¹Ÿæ˜¯ä¸€ä¸ªé€—å·åˆ†éš”çš„å­—ç¬¦ä¸²ï¼Œè¡¨æ˜æœåŠ¡å™¨æ”¯æŒçš„æ‰€æœ‰å¤´ä¿¡æ¯å­—æ®µï¼Œä¸é™äºæµè§ˆå™¨åœ¨\"é¢„æ£€\"ä¸­è¯·æ±‚çš„å­—æ®µã€‚ ï¼ˆ3ï¼‰Access-Control-Allow-Credentials è¯¥å­—æ®µä¸ç®€å•è¯·æ±‚æ—¶çš„å«ä¹‰ç›¸åŒã€‚ ï¼ˆ4ï¼‰Access-Control-Max-Age è¯¥å­—æ®µå¯é€‰ï¼Œç”¨æ¥æŒ‡å®šæœ¬æ¬¡é¢„æ£€è¯·æ±‚çš„æœ‰æ•ˆæœŸï¼Œå•ä½ä¸ºç§’ã€‚ä¸Šé¢ç»“æœä¸­ï¼Œæœ‰æ•ˆæœŸæ˜¯20å¤©ï¼ˆ1728000ç§’ï¼‰ï¼Œå³å…è®¸ç¼“å­˜è¯¥æ¡å›åº”1728000ç§’ï¼ˆå³20å¤©ï¼‰ï¼Œåœ¨æ­¤æœŸé—´ï¼Œä¸ç”¨å‘å‡ºå¦ä¸€æ¡é¢„æ£€è¯·æ±‚ã€‚ ","date":"2017-01-30","objectID":"/posts/cors/:4:2","tags":["go","cors"],"title":"è·¨åŸŸèµ„æºå…±äº« CORS è¯¦è§£","uri":"/posts/cors/"},{"categories":["æŠ€æœ¯"],"content":"4.3 æµè§ˆå™¨çš„æ­£å¸¸è¯·æ±‚å’Œå›åº” ä¸€æ—¦æœåŠ¡å™¨é€šè¿‡äº†\"é¢„æ£€\"è¯·æ±‚ï¼Œä»¥åæ¯æ¬¡æµè§ˆå™¨æ­£å¸¸çš„CORSè¯·æ±‚ï¼Œå°±éƒ½è·Ÿç®€å•è¯·æ±‚ä¸€æ ·ï¼Œä¼šæœ‰ä¸€ä¸ªOriginå¤´ä¿¡æ¯å­—æ®µã€‚æœåŠ¡å™¨çš„å›åº”ï¼Œä¹Ÿéƒ½ä¼šæœ‰ä¸€ä¸ªAccess-Control-Allow-Originå¤´ä¿¡æ¯å­—æ®µã€‚ ä¸‹é¢æ˜¯\"é¢„æ£€\"è¯·æ±‚ä¹‹åï¼Œæµè§ˆå™¨çš„æ­£å¸¸CORSè¯·æ±‚ã€‚ PUT /cors HTTP/1.1 Origin: http://api.bob.com Host: api.alice.com X-Custom-Header: value Accept-Language: en-US Connection: keep-alive User-Agent: Mozilla/5.0... ä¸Šé¢å¤´ä¿¡æ¯çš„Originå­—æ®µæ˜¯æµè§ˆå™¨è‡ªåŠ¨æ·»åŠ çš„ã€‚ ä¸‹é¢æ˜¯æœåŠ¡å™¨æ­£å¸¸çš„å›åº”ã€‚ Access-Control-Allow-Origin: http://api.bob.com Content-Type: text/html; charset=utf-8 ä¸Šé¢å¤´ä¿¡æ¯ä¸­ï¼ŒAccess-Control-Allow-Originå­—æ®µæ˜¯æ¯æ¬¡å›åº”éƒ½å¿…å®šåŒ…å«çš„ã€‚ ","date":"2017-01-30","objectID":"/posts/cors/:4:3","tags":["go","cors"],"title":"è·¨åŸŸèµ„æºå…±äº« CORS è¯¦è§£","uri":"/posts/cors/"},{"categories":["æŠ€æœ¯"],"content":"äº”ã€ä¸JSONPçš„æ¯”è¾ƒ CORSä¸JSONPçš„ä½¿ç”¨ç›®çš„ç›¸åŒï¼Œä½†æ˜¯æ¯”JSONPæ›´å¼ºå¤§ã€‚ JSONPåªæ”¯æŒGETè¯·æ±‚ï¼ŒCORSæ”¯æŒæ‰€æœ‰ç±»å‹çš„HTTPè¯·æ±‚ã€‚JSONPçš„ä¼˜åŠ¿åœ¨äºæ”¯æŒè€å¼æµè§ˆå™¨ï¼Œä»¥åŠå¯ä»¥å‘ä¸æ”¯æŒCORSçš„ç½‘ç«™è¯·æ±‚æ•°æ®ã€‚ ï¼ˆå®Œï¼‰ ","date":"2017-01-30","objectID":"/posts/cors/:5:0","tags":["go","cors"],"title":"è·¨åŸŸèµ„æºå…±äº« CORS è¯¦è§£","uri":"/posts/cors/"},{"categories":["åŸºç¡€çŸ¥è¯†"],"content":"welcome to learn terminal command!!! linuxå‘½ä»¤ ","date":"2016-12-28","objectID":"/posts/linux-cmd/:0:0","tags":["linux"],"title":"linuxå‘½ä»¤","uri":"/posts/linux-cmd/"},{"categories":["åŸºç¡€çŸ¥è¯†"],"content":"æ°¸ï¼è¿œï¼ä¸ï¼è¦ï¼æ‰§ï¼è¡Œï¼ä½ ï¼ä¸ï¼æ¸…ï¼æ¥šï¼åœ¨ï¼å¹²ï¼å•¥ï¼çš„ï¼å‘½ï¼ä»¤ï¼ ","date":"2016-12-28","objectID":"/posts/linux-cmd/:0:1","tags":["linux"],"title":"linuxå‘½ä»¤","uri":"/posts/linux-cmd/"},{"categories":["åŸºç¡€çŸ¥è¯†"],"content":"å®ç”¨æ€§ $ ls -l | sed '1d' | sort -n -k5 | awk '{printf \"%15s %10s\\n\", $9,$5}' æŒ‰æ–‡ä»¶å¤§å°å¢åºæ‰“å°å‡ºå½“å‰ç›®å½•ä¸‹çš„æ–‡ä»¶ååŠå…¶æ–‡ä»¶å¤§å°(å•ä½å­—èŠ‚ï¼‰ $ history | awk '{print $2}' | sort | uniq -c | sort -rn | head -10 è¾“å‡ºä½ æœ€å¸¸ç”¨çš„åæ¡å‘½ä»¤ $ http POST http://localhost:4000/ \u003c /\u003cjsonæ–‡ä»¶è·¯å¾„\u003e åšæµ‹è¯•çš„æ—¶å€™å¾ˆæœ‰ç”¨çš„ä¸€ä¸ªå‘½ä»¤ï¼Œéœ€è¦ä¸‹è½½http $ brew install http $ lsof -n -P -i TCP -s TCP:LISTEN COMMAND PID USER FD TYPE DEVICE SIZE/OFF NODE NAME QQ 290 smartestee 33u IPv4 0x2f3beaa58a62d73b 0t0 TCP 127.0.0.1:4300 (LISTEN) QQ 290 smartestee 34u IPv4 0x2f3beaa58c69673b 0t0 TCP 127.0.0.1:4301 (LISTEN) idea 3257 smartestee 164u IPv4 0x2f3beaa588d11e43 0t0 TCP 127.0.0.1:6942 (LISTEN) idea 3257 smartestee 385u IPv4 0x2f3beaa58c69316b 0t0 TCP 127.0.0.1:63342 (LISTEN) æŸ¥çœ‹ç«¯å£çš„ä½¿ç”¨æƒ…å†µ $ ps -ef æŸ¥çœ‹è¿›ç¨‹ $ kill xxxx ç«¯å£å†²çªæ—¶ï¼Œç”¨æ­¤å‘½ä»¤ï¼Œå…³é—­æŸä¸ªç«¯å£ã€‚ç”¨PIDæ›¿æ¢xxxx $ history æŸ¥çœ‹å†å²å‘½ä»¤è®°å½• $ pwd å½“å‰ä½ç½® $ which xx pathä½ç½®ï¼Œæ­å»ºç¯å¢ƒçš„æ—¶å€™è‚¯å®šä¼šç”¨å¾—åˆ° ","date":"2016-12-28","objectID":"/posts/linux-cmd/:1:0","tags":["linux"],"title":"linuxå‘½ä»¤","uri":"/posts/linux-cmd/"},{"categories":["åŸºç¡€çŸ¥è¯†"],"content":"Linux æ–‡ä»¶ç³»ç»Ÿå‘½ä»¤ ä¿®æ”¹é—®ä»·æ‹¥æœ‰è€… $ chgrp -R ç»„å æ–‡ä»¶ / ç›®å½• $ chown -R è´¦æˆ·å æ–‡ä»¶ / ç›®å½• ä¿®æ”¹æ–‡ä»¶æƒé™ $ chmod ä½¿ç”¨æ•°å­— rï¼š4, wï¼š2, xï¼š1 æ¯ç§èº«ä»½çš„æƒé™çš„ç´¯åŠ çš„ã€‚ $ chmod 777 test ä½¿ç”¨ç¬¦å·ä¿®æ”¹ u: user, g: group, o: others, a: all æ·»åŠ æƒé™ç”¨+ï¼Œ é™¤å»ç”¨-ï¼Œ è®¾ç½®ç”¨= $ chmod u=rwx, g=rw, o=r test $ chmod a-x test $ chmod go+r test â€‹ $ sudo !! ä»¥rootæƒé™æ‰§è¡Œä¸Šä¸€æ¡å‘½ä»¤ï¼ˆæ³¨æ„ä¸Šä¸€æ¡å‘½ä»¤çš„å†…å®¹ï¼Œä»¥å…å‘ç”Ÿæ„å¤–ï¼‰ ä¾‹å¦‚ï¼šåœ¨Ubuntu å®‰è£…è½¯ä»¶æˆ–æ’ä»¶çš„æ—¶å€™éœ€è¦ç”¨åˆ°è¿™ä¸ªå‘½ä»¤ $ sudo apt-get install nginx æŸ¥çœ‹å’Œä¿®æ”¹ï¼š $ cat $ more $ less $ head $ tail $ vi $ vim $ mkdir $ touch ","date":"2016-12-28","objectID":"/posts/linux-cmd/:1:1","tags":["linux"],"title":"linuxå‘½ä»¤","uri":"/posts/linux-cmd/"},{"categories":["åŸºç¡€çŸ¥è¯†"],"content":"git $ git å…ˆç»™å‡ºæ¯”è¾ƒå¸¸ç”¨çš„ $ git add \u003cä¸€ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶å(æ–‡ä»¶åä¹‹é—´æ˜¯ç”¨ç©ºæ ¼ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªç‚¹ï¼Œè¡¨ç¤ºæ·»åŠ å…¨éƒ¨)\u003e $ git commit -m \"æ³¨é‡Š\" æœ¬åœ°æäº¤ $ git checkout \u003cåˆ†æ”¯åæˆ–master\u003e åˆ‡æ¢åˆ†æ”¯ä¸master $ git branch \u003cåˆ†æ”¯å\u003e æ–°å¼€ä¸€ä¸ªåˆ†æ”¯ $ git merge \u003cåˆ†æ”¯å\u003e ä¸»åˆ†æ”¯ä¸åˆ†æ”¯çš„åˆå¹¶ $ git push origin master æäº¤åˆ°githubä¸Š $ fuck çº æ­£å‘½ä»¤è¡Œè¾“å…¥çš„é”™è¯¯ï¼Œæ¯”æ‰‹åŠ¨æ”¹å¿«ï¼Œå®ç”¨ã€‚ å®‰è£…ï¼š $ brew install thefuck ","date":"2016-12-28","objectID":"/posts/linux-cmd/:1:2","tags":["linux"],"title":"linuxå‘½ä»¤","uri":"/posts/linux-cmd/"},{"categories":["åŸºç¡€çŸ¥è¯†"],"content":"å¨±ä¹ $ cmatrix $ telnet towel.blinkenlights.nl telnetæ˜¯åŸºäºTelnetåè®®çš„è¿œç¨‹ç™»å½•å®¢æˆ·ç«¯ç¨‹åº,ç»å¸¸ç”¨æ¥è¿œç¨‹ç™»å½•æœåŠ¡å™¨.é™¤æ­¤è¿˜å¯ä»¥ç”¨å®ƒæ¥è§‚çœ‹æ˜Ÿçƒå¤§æˆ˜ $ fortune éšæœºè¾“å‡ºåè¨€æˆ–è€…ç¬‘è¯ï¼Œ è¿˜æœ‰å¾ˆå¤šï¼Œæœ‰å…´è¶£çš„å¯ä»¥é€šè¿‡è¿™ä¸ªé“¾æ¥å»çœ‹ï¼šçŸ¥ä¹ ä¸ªäººåšå®¢ yusank æ¯”è¾ƒç‰›é€¼çš„ä¸€ä¸ªæŸ¥æ‰¾å‘½ä»¤çš„ç½‘ç«™ï¼šhttp://www.commandlinefu.com/commands/browse/sort-by-votes æ¯å¤©éƒ½æœ‰æ›´æ–°å„ç§å‘½ä»¤ç»„åˆ ","date":"2016-12-28","objectID":"/posts/linux-cmd/:2:0","tags":["linux"],"title":"linuxå‘½ä»¤","uri":"/posts/linux-cmd/"}]